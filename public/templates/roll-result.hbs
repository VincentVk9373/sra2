<div class="sra2-roll-result">
    <div class="roll-header">
        <img class="roller-portrait" src="{{attacker.img}}" alt="{{attacker.name}}" title="{{attacker.name}}" />
        <div class="roller-info">
            <div class="roller-name">{{attacker.name}}</div>
            {{#if isDefend}}
            <div class="roll-type roll-type-defense">
                <i class="fas fa-shield-alt"></i> Se défendre - {{skillName}}
            </div>
            {{else if isCounterAttack}}
            <div class="roll-type roll-type-counterattack">
                <i class="fas fa-fist-raised"></i> Contre attaqué - {{skillName}}
            </div>
            {{else if isAttack}}
            <div class="roll-type roll-type-attack">
                <i class="fas fa-sword"></i> {{#if itemName}}{{itemName}}{{else}}{{skillName}}{{/if}}{{#if damageValue}} <span class="defense-value">(VD: {{damageValue}})</span>{{/if}}
            </div>
            {{else}}
            <div class="roll-type">
                <i class="fas fa-book"></i> {{skillName}}
            </div>
            {{/if}}
        </div>
    </div>

    <div class="roll-results">
        <div class="total-successes {{#if (eq rollResult.totalSuccesses 0)}}failed-attack{{/if}}">
            <span class="successes-label">{{localize "SRA2.ROLL_DIALOG.SUCCESSES"}}:</span>
            <span class="successes-value">{{rollResult.totalSuccesses}}</span>
            {{#if (and isAttack (eq rollResult.totalSuccesses 0))}}
            <div class="attack-failed-message">
                <i class="fas fa-times-circle"></i> {{localize "SRA2.COMBAT.ATTACK_FAILED"}}
            </div>
            {{/if}}
            {{#if (and isAttack (eq rollData.itemType "ice-attack"))}}
            <div class="ice-threshold-info">
                <i class="fas fa-info-circle"></i> Seuil fixe (GLACE) : {{rollData.threshold}} succès
            </div>
            {{/if}}
        </div>

        <!-- Normal Dice Results -->
        {{#if (and rollResult.normalDice.length (ne rollData.itemType "ice-attack"))}}
        <div class="dice-results normal-dice">
            <div class="dice-results-header">
                <span class="dice-type-label">{{localize "SRA2.ROLL_DIALOG.NORMAL_DICE"}}</span>
                <span class="dice-successes">{{rollResult.normalSuccesses}} {{localize
                    "SRA2.SKILLS.SUCCESSES_SHORT"}}</span>
            </div>
            <div class="dice-list">
                {{#each rollResult.normalDice}}
                <div class="dice-result {{#if (isSuccess this ../rollData.rollMode)}}success{{else}}failure{{/if}}"
                    data-dice-value="{{this}}">
                    {{this}}
                </div>
                {{/each}}
            </div>
        </div>
        {{/if}}

        <!-- Risk Dice Results -->
        {{#if (and rollResult.riskDice.length (ne rollData.itemType "ice-attack"))}}
        <div class="dice-results risk-dice">
            <div class="dice-results-header">
                <span class="dice-type-label risk-label">{{localize "SRA2.ROLL_DIALOG.RISK_DICE"}}</span>
                <span class="dice-successes">{{rollResult.riskSuccesses}} × 2 = {{multiply rollResult.riskSuccesses 2}}
                    {{localize "SRA2.SKILLS.SUCCESSES_SHORT"}}</span>
            </div>
            <div class="dice-list">
                {{#each rollResult.riskDice}}
                <div
                    class="dice-result risk {{#if (eq this 1)}}critical-failure{{else if (isSuccess this ../rollData.rollMode)}}success{{else}}failure{{/if}}">
                    {{this}}
                </div>
                {{/each}}
            </div>
            {{#if rollResult.criticalFailures}}
            <div class="critical-failures">
                {{localize "SRA2.SKILLS.CRITICAL_FAILURES"}}: {{rollResult.criticalFailures}}
                {{#if rollResult.finalRR}}
                - {{localize "SRA2.ROLL_DIALOG.RR"}} {{rollResult.finalRR}} = {{rollResult.remainingFailures}}
                {{/if}}
            </div>
            {{/if}}
        </div>
        {{/if}}

        <!-- Complications -->
        {{#if (ne rollResult.complication "none")}}
        <div class="complication {{rollResult.complication}}">
            {{#if (eq rollResult.complication "minor")}}
            <i class="fas fa-exclamation-triangle"></i> {{localize "SRA2.SKILLS.MINOR_COMPLICATION"}}
            {{else if (eq rollResult.complication "critical")}}
            <i class="fas fa-exclamation-circle"></i> {{localize "SRA2.SKILLS.CRITICAL_COMPLICATION"}}
            {{else if (eq rollResult.complication "disaster")}}
            <i class="fas fa-skull"></i> {{localize "SRA2.SKILLS.DISASTER"}}
            {{/if}}
        </div>
        {{/if}}
    </div>

    <!-- Defense Result -->
    {{#if isDefend}}
    {{#if defenseResult}}
    <div class="defense-result">
        <div class="defense-comparison">
            <div class="comparison-header">
                <i class="fas fa-balance-scale"></i> Résultat
            </div>
            <div class="comparison-details">
                <div class="comparison-item">
                    <span class="comparison-label">Succès d'attaque:</span>
                    <span class="comparison-value attack">{{defenseResult.attackSuccesses}}</span>
                </div>
                <div class="comparison-item">
                    <span class="comparison-label">Succès de défense:</span>
                    <span class="comparison-value defense">{{defenseResult.defenseSuccesses}}</span>
                </div>
            </div>
            {{#if defenseResult.attackFailed}}
            <div class="defense-outcome failed">
                <i class="fas fa-times-circle"></i> L'attaque a échoué
            </div>
            {{else}}
            <div class="defense-outcome success">
                <i class="fas fa-check-circle"></i> L'attaque a réussi
            </div>
            {{#if defenseResult.isIceAttack}}
            <!-- ICE Attack Effects -->
            <div class="ice-effects">
                {{#if (eq defenseResult.iceType "blaster")}}
                <div class="ice-effect">
                    <i class="fas fa-lock"></i> <strong>Verrouillage de connexion</strong> : La cible ne peut pas se déconnecter pendant un tour
                </div>
                {{#if (gt defenseResult.calculatedDamage 0)}}
                <div class="calculated-damage">
                    <span class="damage-label">Dégâts matriciels:</span>
                    <span class="damage-value">{{defenseResult.calculatedDamage}}</span>
                </div>
                <button type="button" class="apply-damage-button" 
                        data-damage="{{defenseResult.calculatedDamage}}"
                        data-target-name="{{defenseResult.defenderName}}"
                        data-target-uuid="{{defenseResult.defenderUuid}}"
                        data-attacker-uuid="{{defenseResult.originalAttackerUuid}}"
                        data-damage-type="physical">
                    <i class="fas fa-heart-broken"></i> Appliquer les dégâts matriciels à {{defenseResult.defenderName}}
                </button>
                {{/if}}
                {{else if (eq defenseResult.iceType "black")}}
                <div class="calculated-damage">
                    <span class="damage-label">Dégâts de biofeedback:</span>
                    <span class="damage-value">{{defenseResult.calculatedDamage}}</span>
                </div>
                <button type="button" class="apply-damage-button" 
                        data-damage="{{defenseResult.calculatedDamage}}"
                        data-target-name="{{defenseResult.defenderName}}"
                        data-target-uuid="{{defenseResult.defenderUuid}}"
                        data-attacker-uuid="{{defenseResult.originalAttackerUuid}}"
                        data-damage-type="physical">
                    <i class="fas fa-heart-broken"></i> Appliquer les dégâts de biofeedback à {{defenseResult.defenderName}}
                </button>
                {{else if (eq defenseResult.iceType "killer")}}
                <div class="calculated-damage">
                    <span class="damage-label">Dégâts matriciels:</span>
                    <span class="damage-value">{{defenseResult.calculatedDamage}}</span>
                </div>
                <button type="button" class="apply-damage-button" 
                        data-damage="{{defenseResult.calculatedDamage}}"
                        data-target-name="{{defenseResult.defenderName}}"
                        data-target-uuid="{{defenseResult.defenderUuid}}"
                        data-attacker-uuid="{{defenseResult.originalAttackerUuid}}"
                        data-damage-type="physical">
                    <i class="fas fa-heart-broken"></i> Appliquer les dégâts matriciels à {{defenseResult.defenderName}}
                </button>
                {{else if (eq defenseResult.iceType "acid")}}
                <div class="ice-effect">
                    <i class="fas fa-shield-alt"></i> <strong>Réduction de Firewall</strong> : Le Firewall de la cible est réduit de 1 pour la durée de la Scène
                </div>
                {{else if (eq defenseResult.iceType "blocker")}}
                <div class="ice-effect">
                    <i class="fas fa-sword"></i> <strong>Réduction d'Attaque</strong> : L'Attaque de la cible est réduite de 1 pour la durée de la Scène
                </div>
                {{else if (eq defenseResult.iceType "glue")}}
                <div class="ice-effect">
                    <i class="fas fa-lock"></i> <strong>Verrouillage de connexion</strong> : La cible ne peut pas se déconnecter pendant un tour
                </div>
                {{else if (eq defenseResult.iceType "tracker")}}
                <div class="ice-effect">
                    <i class="fas fa-map-marker-alt"></i> <strong>Localisation découverte</strong> : La localisation physique de la cible a été découverte
                </div>
                {{/if}}
            </div>
            {{else}}
            <!-- Normal Attack Damage -->
            <div class="calculated-damage">
                <span class="damage-label">Dégâts:</span>
                <span class="damage-value">{{defenseResult.calculatedDamage}}</span>
            </div>
            <button type="button" class="apply-damage-button" 
                    data-damage="{{defenseResult.calculatedDamage}}"
                    data-target-name="{{defenseResult.defenderName}}"
                    data-target-uuid="{{defenseResult.defenderUuid}}"
                    data-attacker-uuid="{{defenseResult.originalAttackerUuid}}"
                    data-damage-type="{{#if (and rollData.attackRollData (eq rollData.attackRollData.spellType "direct"))}}mental{{else}}physical{{/if}}">
                <i class="fas fa-heart-broken"></i> Appliquer les dégâts à {{defenseResult.defenderName}}
            </button>
            {{/if}}
            {{/if}}
        </div>
    </div>
    {{/if}}
    {{/if}}

    <!-- Counter-Attack Result -->
    {{#if isCounterAttack}}
    {{#if defenseResult}}
    <div class="defense-result counterattack-result">
        <div class="defense-comparison">
            <div class="comparison-header">
                <i class="fas fa-balance-scale"></i> Résultat
            </div>
            <div class="comparison-details">
                <div class="comparison-item">
                    <span class="comparison-label">Succès d'attaque:</span>
                    <span class="comparison-value attack">{{defenseResult.attackSuccesses}}</span>
                </div>
                <div class="comparison-item">
                    <span class="comparison-label">Succès de contre-attaque:</span>
                    <span class="comparison-value defense">{{defenseResult.counterAttackSuccesses}}</span>
                </div>
            </div>
            {{#if defenseResult.isTie}}
            <div class="defense-outcome tie">
                <i class="fas fa-equals"></i> Aucun dégât n'est infligé
            </div>
            {{else if (eq defenseResult.winner "attacker")}}
            <div class="defense-outcome success">
                <i class="fas fa-check-circle"></i> {{defenseResult.originalAttackerName}} inflige {{defenseResult.attackerDamage}} dégâts
            </div>
            <div class="calculated-damage">
                <span class="damage-label">Dégâts infligés:</span>
                <span class="damage-value">{{defenseResult.attackerDamage}}</span>
            </div>
            <button type="button" class="apply-damage-button" 
                    data-damage="{{defenseResult.attackerDamage}}"
                    data-target-name="{{defenseResult.damageReceiverName}}"
                    data-target-uuid="{{defenseResult.damageReceiverUuid}}"
                    data-attacker-uuid="{{defenseResult.damageInflicterUuid}}"
                    data-damage-type="{{#if (and rollData.attackRollData (eq rollData.attackRollData.spellType "direct"))}}mental{{else}}physical{{/if}}">
                <i class="fas fa-heart-broken"></i> Appliquer les dégâts à {{defenseResult.damageReceiverName}}
            </button>
            {{else if (eq defenseResult.winner "defender")}}
            <div class="defense-outcome counterattack-win">
                <i class="fas fa-check-circle"></i> {{defenseResult.originalDefenderName}} inflige {{defenseResult.defenderDamage}} dégâts
            </div>
            <div class="calculated-damage counterattack-damage">
                <span class="damage-label">Dégâts infligés:</span>
                <span class="damage-value">{{defenseResult.defenderDamage}}</span>
            </div>
            <button type="button" class="apply-damage-button" 
                    data-damage="{{defenseResult.defenderDamage}}"
                    data-target-name="{{defenseResult.damageReceiverName}}"
                    data-target-uuid="{{defenseResult.damageReceiverUuid}}"
                    data-attacker-uuid="{{defenseResult.damageInflicterUuid}}"
                    data-damage-type="physical">
                <i class="fas fa-heart-broken"></i> Appliquer les dégâts à {{defenseResult.damageReceiverName}}
            </button>
            {{/if}}
        </div>
    </div>
    {{/if}}
    {{/if}}

    <!-- Direct Spell Damage (no defense) -->
    {{#if (and isAttack isSpellDirect (gt rollResult.totalSuccesses 0))}}
    {{#if defender}}
    <div class="spell-direct-damage">
        <div class="defender-info">
            {{#if defender.img}}
            <img class="defender-portrait" src="{{defender.img}}" alt="{{defender.name}}" title="{{defender.name}}" />
            {{else}}
            <div class="defender-portrait-placeholder">
                <i class="fas fa-user"></i>
            </div>
            {{/if}}
            <span class="defender-name">{{defender.name}}</span>
        </div>
        <div class="calculated-damage">
            <span class="damage-label">Dégâts (mental):</span>
            <span class="damage-value">{{rollResult.totalSuccesses}}</span>
        </div>
        <button type="button" class="apply-damage-button" 
                data-damage="{{rollResult.totalSuccesses}}"
                data-target-name="{{defender.name}}"
                data-target-uuid="{{defender.uuid}}"
                data-attacker-uuid="{{attacker.uuid}}"
                data-damage-type="mental">
            <i class="fas fa-heart-broken"></i> Appliquer les dégâts mentaux à {{defender.name}}
        </button>
    </div>
    {{/if}}
    {{/if}}

    <!-- Attack Actions (for defender) -->
    {{#if isAttack}}
    {{#unless isDefend}}
    {{#unless isCounterAttack}}
    {{#unless isSpellDirect}}
    {{#if defender}}
    <div class="attack-actions" data-attacker-id="{{attacker.id}}" data-attacker-uuid="{{attacker.uuid}}"
        data-defender-id="{{defender.id}}" data-defender-uuid="{{defender.uuid}}" data-roll-result="{{json rollResult}}"
        data-roll-data="{{json rollData}}">
        <div class="defender-info">
            {{#if defender.img}}
            <img class="defender-portrait" src="{{defender.img}}" alt="{{defender.name}}" title="{{defender.name}}" />
            {{else}}
            <div class="defender-portrait-placeholder">
                <i class="fas fa-user"></i>
            </div>
            {{/if}}
            <span class="defender-name">{{defender.name}}</span>
        </div>
        <div class="attack-actions-buttons">
            {{#if (gt rollResult.totalSuccesses 0)}}
            <button type="button" class="defend-button">
                <i class="fas fa-shield-alt"></i> {{localize "SRA2.COMBAT.DEFEND"}}
            </button>
            {{/if}}
            {{#if (eq rollData.skillName "Combat rapproché")}}
            <button type="button" class="counter-attack-button">
                <i class="fas fa-sword"></i> {{localize "SRA2.COMBAT.ATTACK"}}
            </button>
            {{/if}}
        </div>
    </div>
    {{/if}}
    {{/unless}}
    {{/unless}}
    {{/unless}}
    {{/if}}
</div>