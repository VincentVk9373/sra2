<div class="roll-dialog-content">
    <header class="roll-dialog-header">
        <div class="attacker-info">
            {{#if actor}}
            <img class="attacker-portrait" src="{{actor.img}}" alt="{{actor.name}}" title="{{actor.name}}" />
            <div class="attacker-name">{{actor.name}}</div>
            {{else}}
            <div class="attacker-portrait-placeholder">
                <i class="fas fa-user"></i>
            </div>
            <div class="attacker-name">{{rollData.actorName}}</div>
            {{/if}}
        </div>
        <!-- Additional Info -->
        {{#if rollData.itemName}}
        {{#unless rollData.isCounterAttack}}
        <section class="roll-section item-section">
            <h3 class="section-title">
                <i class="fas fa-sword"></i> Action
            </h3>
            <div class="item-display">
                <div class="item-name">{{rollData.itemName}}</div>
                {{#if rollData.damageValue}}
                <div class="item-damage">Dégâts: {{rollData.damageValue}}</div>
                {{/if}}
            </div>
        </section>
        {{/unless}}
        {{/if}}
        {{#if rollData.isCounterAttack}}
        <section class="roll-section counterattack-section">
            <h3 class="section-title">
                <i class="fas fa-fist-raised"></i> Contre attaque
            </h3>
            {{#if rollData.availableWeapons}}
            <div class="counterattack-weapon-selection">
                <label class="weapon-select-label">Sélectionnez une arme:</label>
                <select class="weapon-select" name="selectedWeapon">
                    <option value="">-- Choisissez une arme --</option>
                    {{#each rollData.availableWeapons}}
                    <option value="{{this.id}}" {{#if (eq this.id ../rollData.selectedWeaponId)}}selected{{/if}} data-linked-skill="{{this.linkedAttackSkill}}" data-damage-value="{{this.damageValue}}" data-damage-bonus="{{this.damageValueBonus}}">
                        {{this.name}} ({{this.linkedAttackSkill}} - VD: {{this.damageValue}})
                    </option>
                    {{/each}}
                </select>
            </div>
            {{else}}
            <div class="counterattack-display">
                <div class="counterattack-skill">
                    {{#if rollData.specName}}
                    {{rollData.specName}} (Spécialisation)
                    {{else if rollData.skillName}}
                    {{rollData.skillName}} (Compétence)
                    {{else}}
                    Compétence de contre-attaque
                    {{/if}}
                </div>
            </div>
            {{/if}}
        </section>
        {{else if rollData.isDefend}}
        <section class="roll-section defense-section">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i> Se défendre
            </h3>
            <div class="defense-display">
                <div class="defense-skill">
                    {{#if rollData.specName}}
                    {{rollData.specName}} (Spécialisation)
                    {{else if rollData.skillName}}
                    {{rollData.skillName}} (Compétence)
                    {{else}}
                    Compétence de défense
                    {{/if}}
                </div>
            </div>
        </section>
        {{else}}
        {{#unless rollData.itemName}}
        {{#if rollData.skillName}}
        <section class="roll-section skill-roll-section">
            <h3 class="section-title">
                <i class="fas fa-dice"></i> Faire un jet de
            </h3>
            <div class="skill-roll-display">
                <div class="skill-roll-name">
                    {{#if rollData.specName}}
                    {{rollData.specName}} (Spécialisation)
                    {{else}}
                    {{rollData.skillName}} (Compétence)
                    {{/if}}
                </div>
            </div>
        </section>
        {{/if}}
        {{/unless}}
        {{/if}}
        <!-- Target Information -->
        <section class="roll-section target-section">
            <h3 class="section-title">
                <i class="fas fa-bullseye"></i> {{#if rollData.isDefend}}Attaquant{{else}}Cible{{/if}}
                {{#if distanceText}}
                <div class="target-distance"> |
                    <i class="fas fa-ruler"></i> {{distanceText}}
                </div>
                {{/if}}
            </h3>
            <div class="target-display">
                {{#if targetToken}}
                <div class="target-info">
                    <img class="target-portrait" src="{{targetToken.actor.img}}" alt="{{targetToken.actor.name}}"
                        title="{{targetToken.actor.name}}" />
                    <div class="target-name">{{targetToken.actor.name}}</div>
                </div>
                {{else}}
                <div class="target-info no-target">
                    <div class="target-placeholder">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="target-name">Aucune cible</div>
                </div>
                {{/if}}
            </div>
        </section>

        <!-- Roll Dice Button -->
        <div class="roll-dice-section">
            <button type="button" class="roll-dice-button">
                {{#if hasThreshold}}
                <i class="fas fa-bullseye"></i> Appliquer le seuil
                {{else}}
                <i class="fas fa-dice"></i> Lancer les Dés
                {{/if}}
            </button>
        </div>

    </header>

    <div class="roll-dialog-body">

        <!-- Dice Pool or Threshold -->
        <section class="roll-section dice-section">
            <h3 class="section-title">
                {{#if hasThreshold}}
                <i class="fas fa-bullseye"></i> Seuil
                {{else}}
                <i class="fas fa-dice"></i> Pool de Dés | {{dicePool}} dés{{#if riskDiceCount}} <span
                    class="risk-dice-count">| {{riskDiceCount}} dés de risque</span>{{/if}}
                {{/if}}
            </h3>
            <div class="dice-pool-display">
                {{#if hasThreshold}}
                <div class="threshold-count">
                    <span class="threshold-number">{{threshold}}</span>
                    <span class="threshold-label">seuil</span>
                </div>
                {{else}}
                <div class="dice-list-container">
                    <div class="dice-list">
                        {{#each diceList}}
                        <div class="dice-icon {{#if this.isRiskDice}}risk-dice{{/if}} dice-{{this.riskColor}}"
                            data-dice-index="{{this.index}}" style="cursor: pointer;"
                            title="{{#if this.isRiskDice}}Dé de risque{{else}}Dé normal{{/if}}"
                            data-risk-color="{{this.riskColor}}">
                            <i class="fas fa-dice"></i>
                        </div>
                        {{/each}}
                    </div>
                </div>
                {{/if}}
            </div>
        </section>
        <!-- Skill Selection -->
        <section class="roll-section skill-section">
            <h3 class="section-title">
                <i class="fas fa-book"></i> Compétence
            </h3>
            <div class="skill-display">
                {{#if dropdownOptions}}
                <select class="skill-dropdown" name="skill-select" {{#if hasThreshold}}disabled{{/if}}>
                    <option value="">-- Sélectionner --</option>
                    {{#each dropdownOptions}}
                    <option value="{{value}}" {{#if (eq value ../selectedValue)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
                {{else}}
                <div class="selected-skill">
                    <span class="skill-name">{{skillDisplayName}}</span>
                    {{#if rollData.specName}}
                    <span class="skill-type">(Spécialisation)</span>
                    {{else if rollData.skillName}}
                    <span class="skill-type">(Compétence)</span>
                    {{/if}}
                </div>
                {{/if}}
            </div>
        </section>

        <!-- Roll Mode Selection -->
        {{#if (or isWeaponRoll rollData.isDefend)}}
        <div style="display: grid; grid-template-columns: 1fr 1fr;">

            <section class="roll-section roll-mode-section">
                <h3 class="section-title">
                    <i class="fas fa-adjust"></i> Mode de Jet
                </h3>
                <div class="roll-mode-display">
                    <div class="roll-mode-options">
                        <label class="roll-mode-option">
                            <input type="radio" name="roll-mode" value="normal" {{#if (eq rollMode "normal"
                                )}}checked{{/if}} />
                            <span>Normal</span>
                        </label>
                        <label class="roll-mode-option disadvantage">
                            <input type="radio" name="roll-mode" value="disadvantage" {{#if (eq rollMode "disadvantage"
                                )}}checked{{/if}} />
                            <span>Désavantage</span>
                        </label>
                        <label class="roll-mode-option advantage">
                            <input type="radio" name="roll-mode" value="advantage" {{#if (eq rollMode "advantage"
                                )}}checked{{/if}} />
                            <span>Avantage</span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Range Selection (for weapons, not for defense) -->
            {{#unless rollData.isDefend}}
            <section class="roll-section range-section no-border-left">
                <h3 class="section-title">
                    <i class="fas fa-crosshairs"></i> Portée
                </h3>
                <div class="range-display">
                    <select class="range-dropdown {{#if (eq selectedRangeValue "none")}}invalid-range{{/if}}" name="range-select">
                        <option value="">-- Sélectionner --</option>
                        <option value="melee" {{#if (eq selectedRange "melee" )}}selected{{/if}}>
                            {{rangeOptions.melee.label}} ({{#if (eq rangeOptions.melee.value "ok")}}OK{{else if (eq
                            rangeOptions.melee.value "disadvantage")}}Désavantage{{else}}Aucun{{/if}})
                        </option>
                        <option value="short" {{#if (eq selectedRange "short" )}}selected{{/if}}>
                            {{rangeOptions.short.label}} ({{#if (eq rangeOptions.short.value "ok")}}OK{{else if (eq
                            rangeOptions.short.value "disadvantage")}}Désavantage{{else}}Aucun{{/if}})
                        </option>
                        <option value="medium" {{#if (eq selectedRange "medium" )}}selected{{/if}}>
                            {{rangeOptions.medium.label}} ({{#if (eq rangeOptions.medium.value "ok")}}OK{{else if (eq
                            rangeOptions.medium.value "disadvantage")}}Désavantage{{else}}Aucun{{/if}})
                        </option>
                        <option value="long" {{#if (eq selectedRange "long" )}}selected{{/if}}>
                            {{rangeOptions.long.label}} ({{#if (eq rangeOptions.long.value "ok")}}OK{{else if (eq
                            rangeOptions.long.value "disadvantage")}}Désavantage{{else}}Aucun{{/if}})
                        </option>
                    </select>
                </div>
            </section>
            {{/unless}}
        </div>
        {{/if}}

        <!-- VD and RR Summary -->
        <section class="roll-section summary-section">
            <h3 class="section-title">
                <i class="fas fa-info-circle"></i> Réduction de risque | {{totalRR}} RR
            </h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">RR</div>
                    <div class="summary-value">{{totalRR}}</div>
                </div>
                {{#if rrSources.length}}
                <div class="rr-sources">
                    <ul class="rr-sources-list">
                        {{#each rrSources}}
                        <li class="rr-source-item">
                            <label class="rr-checkbox-label">
                                <input type="checkbox" class="rr-checkbox" data-rr-id="{{this.id}}" {{#if
                                    this.enabled}}checked{{/if}} />
                                <span class="rr-source-name">{{this.featName}}</span>
                                <span class="rr-source-value">+{{this.rrValue}}</span>
                            </label>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                {{/if}}
            </div>
        </section>


    </div>
</div>