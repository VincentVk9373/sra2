<div class="roll-dialog-content">
    <header class="roll-dialog-header">
        <div class="attacker-info">
            {{#if actor}}
            <img class="attacker-portrait" src="{{actor.img}}" alt="{{actor.name}}" title="{{actor.name}}" />
            <div class="attacker-name">{{actor.name}}</div>
            {{else}}
            <div class="attacker-portrait-placeholder">
                <i class="fas fa-user"></i>
            </div>
            <div class="attacker-name">{{rollData.actorName}}</div>
            {{/if}}
        </div>
        <!-- Additional Info -->
        {{#if rollData.itemName}}
        {{#unless rollData.isCounterAttack}}
        <section class="roll-section item-section">
            <h3 class="section-title">
                <i class="fas fa-sword"></i> Action
            </h3>
            <div class="item-display">
                <div class="item-name">{{rollData.itemName}}</div>
                {{#if rollData.damageValue}}
                <div class="item-damage">{{localize "SRA2.ROLL_DIALOG.DAMAGE_LABEL"}}: {{rollData.damageValue}}</div>
                {{/if}}
            </div>
        </section>
        {{/unless}}
        {{/if}}
        {{#if rollData.isCounterAttack}}
        <section class="roll-section counterattack-section">
            <h3 class="section-title">
                <i class="fas fa-fist-raised"></i> {{localize "SRA2.ROLL_DIALOG.COUNTERATTACK"}}
            </h3>
            {{#if rollData.availableWeapons}}
            <div class="counterattack-weapon-selection">
                <label class="weapon-select-label">{{localize "SRA2.ROLL_DIALOG.SELECT_WEAPON"}}</label>
                <select class="weapon-select" name="selectedWeapon">
                    <option value="">-- Choisissez une arme --</option>
                    {{#each rollData.availableWeapons}}
                    <option value="{{this.id}}" {{#if (eq this.id ../rollData.selectedWeaponId)}}selected{{/if}}
                        data-linked-skill="{{this.linkedAttackSkill}}" data-damage-value="{{this.damageValue}}"
                        data-damage-bonus="{{this.damageValueBonus}}">
                        {{this.name}} ({{this.linkedAttackSkill}} - VD: {{this.damageValue}})
                    </option>
                    {{/each}}
                </select>
            </div>
            {{else}}
            <div class="counterattack-display">
                <div class="counterattack-skill">
                    {{#if rollData.specName}}
                    {{rollData.specName}} ({{localize "SRA2.ROLL_DIALOG.SPECIALIZATION"}})
                    {{else if rollData.skillName}}
                    {{rollData.skillName}} ({{localize "SRA2.ROLL_DIALOG.SKILL"}})
                    {{else}}
                    {{localize "SRA2.ROLL_DIALOG.COUNTERATTACK_SKILL"}}
                    {{/if}}
                </div>
            </div>
            {{/if}}
        </section>
        {{else if rollData.isDefend}}
        <section class="roll-section defense-section">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i> {{localize "SRA2.ROLL_DIALOG.DEFEND_TITLE"}}
            </h3>
            <div class="defense-display">
                <div class="defense-skill">
                    {{#if rollData.specName}}
                    {{rollData.specName}} ({{localize "SRA2.ROLL_DIALOG.SPECIALIZATION"}})
                    {{else if rollData.skillName}}
                    {{rollData.skillName}} ({{localize "SRA2.ROLL_DIALOG.SKILL"}})
                    {{else}}
                    {{localize "SRA2.ROLL_DIALOG.DEFENSE_SKILL"}}
                    {{/if}}
                </div>
            </div>
        </section>
        {{else}}
        {{#unless rollData.itemName}}
        {{#if rollData.skillName}}
        <section class="roll-section skill-roll-section">
            <h3 class="section-title">
                <i class="fas fa-dice"></i> {{localize "SRA2.ROLL_DIALOG.ROLL_FOR"}}
            </h3>
            <div class="skill-roll-display">
                <div class="skill-roll-name">
                    {{#if rollData.specName}}
                    {{rollData.specName}} ({{localize "SRA2.ROLL_DIALOG.SPECIALIZATION"}})
                    {{else}}
                    {{rollData.skillName}} ({{localize "SRA2.ROLL_DIALOG.SKILL"}})
                    {{/if}}
                </div>
            </div>
        </section>
        {{/if}}
        {{/unless}}
        {{/if}}
        <!-- Target Information -->
        <section class="roll-section target-section">
            <h3 class="section-title">
                <i class="fas fa-bullseye"></i> {{#if rollData.isDefend}}{{localize "SRA2.ROLL_DIALOG.ATTACKER"}}{{else}}{{localize "SRA2.ROLL_DIALOG.TARGET"}}{{/if}}
                {{#if distanceText}}
                <div class="target-distance"> |
                    <i class="fas fa-ruler"></i> {{distanceText}}
                </div>
                {{/if}}
            </h3>
            <div class="target-display">
                {{#if targetToken}}
                <div class="target-info">
                    <img class="target-portrait" src="{{targetToken.actor.img}}" alt="{{targetToken.actor.name}}"
                        title="{{targetToken.actor.name}}" />
                    <div class="target-name">{{targetToken.actor.name}}</div>
                </div>
                {{else}}
                <div class="target-info no-target">
                    <div class="target-placeholder">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <div class="target-name">{{localize "SRA2.ROLL_DIALOG.NO_TARGET"}}</div>
                </div>
                {{/if}}
            </div>
        </section>

        <!-- Roll Dice Button -->
        <div class="roll-dice-section">
            <button type="button" class="roll-dice-button">
                {{#if hasThreshold}}
                <i class="fas fa-bullseye"></i> {{localize "SRA2.ROLL_DIALOG.APPLY_THRESHOLD"}}
                {{else}}
                <i class="fas fa-dice"></i> {{localize "SRA2.ROLL_DIALOG.ROLL_DICE"}}
                {{/if}}
            </button>
        </div>

    </header>

    <div class="roll-dialog-body">

        <!-- Dice Pool or Threshold -->
        <section class="roll-section dice-section">
            <h3 class="section-title">
                {{#if hasThreshold}}
                <i class="fas fa-bullseye"></i> {{localize "SRA2.ROLL_DIALOG.THRESHOLD"}}
                {{else}}
                <i class="fas fa-dice"></i> {{localize "SRA2.ROLL_DIALOG.DICE_POOL"}} | {{dicePool}} {{localize "SRA2.ROLL_DIALOG.DICE"}}
                {{/if}}
            </h3>
            <div class="dice-pool-display">
                {{#if hasThreshold}}
                <div class="threshold-count">
                    <span class="threshold-number">{{threshold}}</span>
                    <span class="threshold-label">{{localize "SRA2.ROLL_DIALOG.THRESHOLD_LABEL"}}</span>
                </div>
                {{else}}
                <div class="dice-list-container">
                    <div class="dice-list">
                        {{#each diceList}}
                        <div class="dice-icon {{#if this.isRiskDice}}risk-dice{{/if}} dice-{{this.riskColor}}"
                            data-dice-index="{{this.index}}" style="cursor: pointer;"
                            title="{{#if this.isRiskDice}}{{localize "SRA2.ROLL_DIALOG.RISK_DIE"}}{{else}}{{localize "SRA2.ROLL_DIALOG.NORMAL_DIE"}}{{/if}}"
                            data-risk-color="{{this.riskColor}}">
                            <i class="fas fa-dice"></i>
                        </div>
                        {{/each}}
                    </div>
                    <div>

                    {{#if riskDiceCount}}
                    <div class="risk-dice-count-text">
                        {{riskDiceCount}} {{localize "SRA2.ROLL_DIALOG.RISK_DICE"}}
                    </div>
                    {{/if}}
                    {{#if riskLevelText}}
                    <div class="risk-level-text risk-level-{{riskColorClass}}">
                        {{riskLevelText}}
                    </div>
                    {{/if}}
                    </div>
                </div>
                {{/if}}
            </div>
        </section>
        <!-- Skill Selection -->
        <div style="display: grid; grid-template-columns: 1fr 1fr;">
            <section class="roll-section skill-section">
                <h3 class="section-title">
                    <i class="fas fa-book"></i> {{localize "SRA2.ROLL_DIALOG.SKILL"}}
                </h3>
                <div class="skill-display">
                    {{#if dropdownOptions}}
                    <select class="skill-dropdown" name="skill-select" {{#if hasThreshold}}disabled{{/if}}>
                        <option value="">{{localize "SRA2.ROLL_DIALOG.SELECT"}}</option>
                        {{#each dropdownOptions}}
                        <option value="{{value}}" {{#if disabled}}disabled{{/if}} {{#if (eq value ../selectedValue)}}selected{{/if}}>{{label}}</option>
                        {{/each}}
                    </select>
                    {{else}}
                    <div class="selected-skill">
                        <span class="skill-name">{{skillDisplayName}}</span>
                        {{#if rollData.specName}}
                        <span class="skill-type">({{localize "SRA2.ROLL_DIALOG.SPECIALIZATION"}})</span>
                        {{else if rollData.skillName}}
                        <span class="skill-type">({{localize "SRA2.ROLL_DIALOG.SKILL"}})</span>
                        {{/if}}
                    </div>
                    {{/if}}
                </div>
            </section>
            <!-- Attribute Selection (for skill/spec/attribute rolls) -->
            <section class="roll-section range-section no-border-left">
                <h3 class="section-title">
                    <i class="fas fa-dumbbell"></i> {{localize "SRA2.ROLL_DIALOG.ATTRIBUTE"}}
                </h3>
                <div class="range-display">
                    <select class="attribute-dropdown" name="attribute-select">
                        {{#each attributeOptions}}
                        <option value="{{this.value}}" {{#if (eq this.value ../selectedAttribute)}}selected{{/if}}>
                            {{this.label}} ({{this.diceValue}} {{localize "SRA2.ROLL_DIALOG.DICE"}})
                        </option>
                        {{/each}}
                    </select>
                </div>
            </section>
        </div>

        <!-- Roll Mode Selection -->
        {{#if (or isWeaponRoll rollData.isDefend isSkillSpecAttributeRoll)}}
        <div
            style="display: grid; grid-template-columns: {{#if (and isWeaponRoll (not rollData.isDefend))}}1fr 1fr{{else}}1fr{{/if}};">

            <section class="roll-section roll-mode-section">
                <h3 class="section-title">
                    <i class="fas fa-adjust"></i> {{localize "SRA2.ROLL_DIALOG.ROLL_MODE"}}
                    {{#if hasSevereWound}}
                    <span class="severe-wound-warning" title="{{localize 'SRA2.ROLL_DIALOG.SEVERE_WOUND_WARNING'}}">
                        <i class="fas fa-exclamation-triangle"></i> {{localize "SRA2.ROLL_DIALOG.FORCED_DISADVANTAGE"}}
                    </span>
                    {{/if}}
                </h3>
                <div class="roll-mode-display">
                    <div class="roll-mode-options">
                        <label class="roll-mode-option {{#if hasSevereWound}}disabled{{/if}}">
                            <input type="radio" name="roll-mode" value="normal" {{#if (eq rollMode "normal"
                                )}}checked{{/if}} {{#if hasSevereWound}}disabled{{/if}} />
                            <span>{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_NORMAL"}}</span>
                        </label>
                        <label class="roll-mode-option disadvantage {{#if hasSevereWound}}forced{{/if}}">
                            <input type="radio" name="roll-mode" value="disadvantage" {{#if (eq rollMode "disadvantage"
                                )}}checked{{/if}} {{#if hasSevereWound}}disabled{{/if}} />
                            <span>{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_DISADVANTAGE"}}{{#if hasSevereWound}} ({{localize "SRA2.ROLL_DIALOG.DISADVANTAGE_FORCED"}}){{/if}}</span>
                        </label>
                        <label class="roll-mode-option advantage {{#if hasSevereWound}}disabled{{/if}}">
                            <input type="radio" name="roll-mode" value="advantage" {{#if (eq rollMode "advantage"
                                )}}checked{{/if}} {{#if hasSevereWound}}disabled{{/if}} />
                            <span>{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_ADVANTAGE"}}</span>
                        </label>
                    </div>
                </div>
            </section>

            <!-- Range Selection (for weapons only, not for defense or skill/spec/attribute rolls) -->
            {{#if (and isWeaponRoll (not rollData.isDefend))}}
            <section class="roll-section range-section no-border-left">
                <h3 class="section-title">
                    <i class="fas fa-crosshairs"></i> {{localize "SRA2.ROLL_DIALOG.RANGE"}}
                </h3>
                <div class="range-display">
                    <select class="range-dropdown {{#if (eq selectedRangeValue " none")}}invalid-range{{/if}}"
                        name="range-select">
                        <option value="">{{localize "SRA2.ROLL_DIALOG.SELECT"}}</option>
                        <option value="melee" {{#if (eq selectedRange "melee" )}}selected{{/if}}>
                            {{rangeOptions.melee.label}} ({{#if (eq rangeOptions.melee.value "ok")}}{{localize "SRA2.ROLL_DIALOG.RANGE_OK"}}{{else if (eq
                            rangeOptions.melee.value "disadvantage")}}{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_DISADVANTAGE"}}{{else}}{{localize "SRA2.ROLL_DIALOG.RANGE_NONE"}}{{/if}})
                        </option>
                        <option value="short" {{#if (eq selectedRange "short" )}}selected{{/if}}>
                            {{rangeOptions.short.label}} ({{#if (eq rangeOptions.short.value "ok")}}{{localize "SRA2.ROLL_DIALOG.RANGE_OK"}}{{else if (eq
                            rangeOptions.short.value "disadvantage")}}{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_DISADVANTAGE"}}{{else}}{{localize "SRA2.ROLL_DIALOG.RANGE_NONE"}}{{/if}})
                        </option>
                        <option value="medium" {{#if (eq selectedRange "medium" )}}selected{{/if}}>
                            {{rangeOptions.medium.label}} ({{#if (eq rangeOptions.medium.value "ok")}}{{localize "SRA2.ROLL_DIALOG.RANGE_OK"}}{{else if (eq
                            rangeOptions.medium.value "disadvantage")}}{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_DISADVANTAGE"}}{{else}}{{localize "SRA2.ROLL_DIALOG.RANGE_NONE"}}{{/if}})
                        </option>
                        <option value="long" {{#if (eq selectedRange "long" )}}selected{{/if}}>
                            {{rangeOptions.long.label}} ({{#if (eq rangeOptions.long.value "ok")}}{{localize "SRA2.ROLL_DIALOG.RANGE_OK"}}{{else if (eq
                            rangeOptions.long.value "disadvantage")}}{{localize "SRA2.ROLL_DIALOG.ROLL_MODE_DISADVANTAGE"}}{{else}}{{localize "SRA2.ROLL_DIALOG.RANGE_NONE"}}{{/if}})
                        </option>
                    </select>
                </div>
            </section>
            {{/if}}
        </div>
        {{/if}}

        <!-- VD and RR Summary -->
        <section class="roll-section summary-section">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <h3 class="section-title">
                        <i class="fas fa-info-circle"></i> {{localize "SRA2.ROLL_DIALOG.RISK_REDUCTION"}} | {{totalRR}} {{localize "SRA2.ROLL_DIALOG.RR"}}
                    </h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-label">RR</div>
                            <div class="summary-value">{{totalRR}}</div>
                        </div>
                        <div class="rr-sources">
                            <ul class="rr-sources-list">
                                {{#each rrSources}}
                                <li class="rr-source-item">
                                    <label class="rr-checkbox-label">
                                        <input type="checkbox" class="rr-checkbox" data-rr-id="{{this.id}}" {{#if
                                            this.enabled}}checked{{/if}} />
                                        <span class="rr-source-name">{{this.featName}}</span>
                                        <span class="rr-source-value">+{{this.rrValue}}</span>
                                    </label>
                                </li>
                                {{/each}}
                                <li class="rr-source-item">
                                    <label class="rr-checkbox-label">
                                        <input type="text" class="manual-rr-bonus-input" min="" max="" value="{{manualRRBonus}}" 
                                        placeholder="0" title="{{localize "SRA2.ROLL_DIALOG.MANUAL_RR_BONUS_TOOLTIP"}}" />
                                        <span class="rr-source-name">{{localize "SRA2.ROLL_DIALOG.MANUAL_RR_BONUS"}}</span>
                                    </label>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                {{#if riskProbabilities}}
                <div class="risk-probabilities">
                    <h3 class="section-title">
                        <i class="fas fa-chart-pie"></i> {{localize "SRA2.ROLL_DIALOG.RISK_PROBABILITIES"}}
                    </h3>
                    <div class="probabilities-list">
                        <div class="probability-item">
                            <span class="probability-label">{{localize "SRA2.ROLL_DIALOG.PROBABILITIES.NO_COMPLICATION"}} :</span>
                            <span class="probability-value {{riskProbabilities.allGoodColorClass}}">{{riskProbabilities.allGood}} %</span>
                        </div>
                        <div class="probability-item">
                            <span class="probability-label">{{localize "SRA2.ROLL_DIALOG.PROBABILITIES.MINOR_COMPLICATION"}} :</span>
                            <span class="probability-value {{riskProbabilities.glitchColorClass}}">{{riskProbabilities.glitch}} %</span>
                        </div>
                        <div class="probability-item">
                            <span class="probability-label">{{localize "SRA2.ROLL_DIALOG.PROBABILITIES.CRITICAL_COMPLICATION"}} :</span>
                            <span class="probability-value {{riskProbabilities.criticalGlitchColorClass}}">{{riskProbabilities.criticalGlitch}} %</span>
                        </div>
                        <div class="probability-item">
                            <span class="probability-label">{{localize "SRA2.ROLL_DIALOG.PROBABILITIES.DISASTER"}} :</span>
                            <span class="probability-value {{riskProbabilities.disasterColorClass}}">{{riskProbabilities.disaster}} %</span>
                        </div>
                    </div>
                </div>
                {{/if}}
            </div>
        </section>


    </div>
</div>