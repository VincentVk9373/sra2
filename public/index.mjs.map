{"version":3,"file":"index.mjs","sources":["../src/module/config/system.ts","../src/module/models/actor-character.ts","../src/module/models/item-feat.ts","../src/module/models/actor-vehicle.ts","../src/module/models/actor-ice.ts","../src/module/models/item-skill.ts","../src/module/models/item-specialization.ts","../src/module/models/item-metatype.ts","../src/module/documents/actor.ts","../item-search.ts","../src/module/helpers/dice-roller.ts","../src/module/helpers/sheet-helpers.ts","../src/module/helpers/combat-helpers.ts","../src/module/applications/character-sheet.ts","../src/module/applications/character-sheet-v2.ts","../src/module/applications/vehicle-sheet.ts","../src/module/applications/ice-sheet.ts","../src/module/applications/feat-sheet.ts","../src/module/applications/skill-sheet.ts","../src/module/applications/specialization-sheet.ts","../src/module/applications/metatype-sheet.ts","../src/module/applications/roll-dialog.ts","../src/module/hooks.mjs","../src/module/migration/migration.mjs","../src/module/migration/migration-13.0.3.mjs","../src/module/migration/migration-13.0.4.mjs","../src/module/migration/migration-13.0.5.mjs","../src/module/migration/migration-13.0.6.mjs","../src/module/migration/migration-13.0.7.mjs","../src/module/migration/migration-13.0.8.mjs","../src/module/migration/migration-13.0.9.mjs","../src/module/migration/migration-13.0.10.mjs","../src/module/migration/migration-13.0.11.mjs","../src/module/migration/migration-13.0.12.mjs","../src/module/sra2-system.ts","../src/module/config/ui-config.ts","../src/start.ts"],"sourcesContent":["const SYSTEM_ID = 'sra2';\r\n\r\nexport interface SystemConfig {\r\n  id: string;\r\n  LOG: {\r\n    HEAD: string;\r\n  };\r\n  SOCKET: string;\r\n  PATH: {\r\n    ROOT: string;\r\n    STYLE: string;\r\n    TEMPLATES: string;\r\n    ASSETS: string;\r\n  };\r\n}\r\n\r\nexport const SYSTEM: SystemConfig = {\r\n  id: SYSTEM_ID,\r\n  LOG: {\r\n    HEAD: `${SYSTEM_ID} | `\r\n  },\r\n  SOCKET: `system.${SYSTEM_ID}`,\r\n  PATH: {\r\n    ROOT: `systems/${SYSTEM_ID}`,\r\n    STYLE: `systems/${SYSTEM_ID}/style`,\r\n    TEMPLATES: `systems/${SYSTEM_ID}/templates`,\r\n    ASSETS: `systems/${SYSTEM_ID}/assets`,\r\n  }\r\n};\r\n\r\n","/**\r\n * Data model for Character actors\r\n */\r\nexport class CharacterDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      attributes: new fields.SchemaField({\r\n        strength: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        agility: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        willpower: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        logic: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        charisma: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        })\r\n      }),\r\n      resources: new fields.SchemaField({\r\n        yens: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: 0,\r\n          integer: true\r\n        }),\r\n        anarchy: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: 0,\r\n          integer: true\r\n        })\r\n      }),\r\n      maxEssence: new fields.NumberField({\r\n        required: true,\r\n        initial: 6,\r\n        min: 0\r\n      }),\r\n      armorLevel: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 5,\r\n        integer: true\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }),\r\n      anarchySpent: new fields.ArrayField(new fields.BooleanField({\r\n        required: true,\r\n        initial: false\r\n      }), {\r\n        required: true,\r\n        initial: [false, false, false]\r\n      }),\r\n      bio: new fields.SchemaField({\r\n        background: new fields.HTMLField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        notes: new fields.HTMLField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      keywords: new fields.SchemaField({\r\n        keyword1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword5: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      behaviors: new fields.SchemaField({\r\n        behavior1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      catchphrases: new fields.SchemaField({\r\n        catchphrase1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      // Linked vehicle actors (UUIDs)\r\n      linkedVehicles: new fields.ArrayField(new fields.StringField({\r\n        required: true,\r\n        initial: \"\"\r\n      }), {\r\n        required: true,\r\n        initial: [],\r\n        label: \"SRA2.CHARACTER.LINKED_VEHICLES\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculate the cost of an attribute based on its level\r\n   * Each level costs 10000, except the last level (maximum) which costs 20000\r\n   */\r\n  private calculateAttributeCost(level: number, maxLevel: number): number {\r\n    let cost = 0;\r\n    for (let i = 1; i <= level; i++) {\r\n      if (i === maxLevel) {\r\n        cost += 20000;\r\n      } else {\r\n        cost += 10000;\r\n      }\r\n    }\r\n    return cost;\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Get metatype to determine attribute maximums and anarchy bonus\r\n    const parent = (this as any).parent;\r\n    let attributeMaxes = {\r\n      strength: 99,\r\n      agility: 99,\r\n      willpower: 99,\r\n      logic: 99,\r\n      charisma: 99\r\n    };\r\n    let anarchyBonus = 0;\r\n    \r\n    if (parent && parent.items) {\r\n      const metatype = parent.items.find((item: any) => item.type === 'metatype');\r\n      if (metatype && metatype.system) {\r\n        attributeMaxes = {\r\n          strength: metatype.system.maxStrength || 99,\r\n          agility: metatype.system.maxAgility || 99,\r\n          willpower: metatype.system.maxWillpower || 99,\r\n          logic: metatype.system.maxLogic || 99,\r\n          charisma: metatype.system.maxCharisma || 99\r\n        };\r\n        anarchyBonus = metatype.system.anarchyBonus || 0;\r\n      }\r\n    }\r\n    \r\n    (this as any).attributeMaxes = attributeMaxes;\r\n    \r\n    // Calculate damage boxes, thresholds bonuses, essence cost, anarchy bonus, and narrations from active feats\r\n    let bonusLightDamage = 0;\r\n    let bonusSevereDamage = 0;\r\n    let bonusPhysicalThreshold = 0;\r\n    let bonusMentalThreshold = 0;\r\n    let bonusAnarchy = 0;\r\n    let totalEssenceCost = 0;\r\n    let totalNarrations = 0;\r\n    const narrationsDetails: Array<{ name: string; actions: number }> = [];\r\n    \r\n    if (parent && parent.items) {\r\n      const activeFeats = parent.items.filter((item: any) => \r\n        item.type === 'feat' && item.system.active === true\r\n      );\r\n      \r\n      activeFeats.forEach((feat: any) => {\r\n        bonusLightDamage += feat.system.bonusLightDamage || 0;\r\n        bonusSevereDamage += feat.system.bonusSevereDamage || 0;\r\n        bonusPhysicalThreshold += feat.system.bonusPhysicalThreshold || 0;\r\n        bonusMentalThreshold += feat.system.bonusMentalThreshold || 0;\r\n        bonusAnarchy += feat.system.bonusAnarchy || 0;\r\n        totalEssenceCost += feat.system.essenceCost || 0;\r\n        \r\n        // Count narrations\r\n        if (feat.system.grantsNarration) {\r\n          totalNarrations++;\r\n          narrationsDetails.push({\r\n            name: feat.name,\r\n            actions: feat.system.narrationActions || 1\r\n          });\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Calculate total anarchy (base 3 + metatype bonus + feats bonus)\r\n    (this as any).totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\r\n    (this as any).anarchyBonus = anarchyBonus;\r\n    (this as any).featsAnarchyBonus = bonusAnarchy;\r\n    \r\n    // Store narrations information (base 1 + feats bonus)\r\n    (this as any).totalNarrations = 1 + totalNarrations;\r\n    (this as any).bonusNarrations = totalNarrations;\r\n    (this as any).narrationsDetails = narrationsDetails;\r\n    \r\n    // Base: 2 light, 1 severe, 1 incapacitating\r\n    const totalLightBoxes = 2 + bonusLightDamage;\r\n    const totalSevereBoxes = 1 + bonusSevereDamage;\r\n    \r\n    // Ensure damage arrays match the required size (preserve existing values)\r\n    // CRITICAL: Read from source data first to preserve persisted values\r\n    // In Foundry v13, when prepareDerivedData() is called, (this as any).damage\r\n    // should already contain the persisted values from _source, but we need to\r\n    // ensure we're working with a copy to avoid mutating the source\r\n    const sourceDamage = parent?._source?.system?.damage || (this as any).damage || {};\r\n    \r\n    // Create a copy from source to preserve persisted values\r\n    const damage: any = {\r\n      light: Array.isArray(sourceDamage.light) ? [...sourceDamage.light] : [false, false],\r\n      severe: Array.isArray(sourceDamage.severe) ? [...sourceDamage.severe] : [false],\r\n      incapacitating: typeof sourceDamage.incapacitating === 'boolean' ? sourceDamage.incapacitating : false\r\n    };\r\n    \r\n    // Adjust light damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.light.length < totalLightBoxes) {\r\n      damage.light.push(false);\r\n    }\r\n    while (damage.light.length > totalLightBoxes) {\r\n      damage.light.pop();\r\n    }\r\n    \r\n    // Adjust severe damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.severe.length < totalSevereBoxes) {\r\n      damage.severe.push(false);\r\n    }\r\n    while (damage.severe.length > totalSevereBoxes) {\r\n      damage.severe.pop();\r\n    }\r\n    \r\n    // Assign the damage object (this updates derived data, source data remains unchanged)\r\n    (this as any).damage = damage;\r\n    \r\n    (this as any).totalLightBoxes = totalLightBoxes;\r\n    (this as any).totalSevereBoxes = totalSevereBoxes;\r\n    \r\n    // Adjust anarchy spent array to match total anarchy\r\n    const totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\r\n    const anarchySpent = (this as any).anarchySpent || [];\r\n    \r\n    if (!Array.isArray(anarchySpent)) {\r\n      (this as any).anarchySpent = [];\r\n    }\r\n    while ((this as any).anarchySpent.length < totalAnarchy) {\r\n      (this as any).anarchySpent.push(false);\r\n    }\r\n    while ((this as any).anarchySpent.length > totalAnarchy) {\r\n      (this as any).anarchySpent.pop();\r\n    }\r\n    \r\n    // Calculate armor level from active armor feats\r\n    // Armor feats stack (addition)\r\n    let totalArmorLevel = 0;\r\n    if (parent && parent.items) {\r\n      const activeArmorFeats = parent.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.featType === 'armor' && \r\n        item.system.active === true &&\r\n        (item.system.armorValue || 0) > 0\r\n      );\r\n      \r\n      // Sum all active armor values\r\n      totalArmorLevel = activeArmorFeats.reduce((sum: number, item: any) => {\r\n        return sum + (item.system.armorValue || 0);\r\n      }, 0);\r\n      \r\n      // Cap at maximum of 5\r\n      totalArmorLevel = Math.min(totalArmorLevel, 5);\r\n    }\r\n    \r\n    // Store calculated armor level (read-only, calculated from feats)\r\n    (this as any).armorLevel = totalArmorLevel;\r\n    \r\n    // Calculate armor cost (2500 per level)\r\n    (this as any).armorCost = totalArmorLevel * 2500;\r\n    \r\n    // Calculate damage thresholds (with bonuses from feats)\r\n    const strength = (this as any).attributes?.strength || 1;\r\n    const willpower = (this as any).attributes?.willpower || 1;\r\n    \r\n    // Find active cyberdeck to get firewall for matrix thresholds\r\n    let firewall = 0;\r\n    if (parent && parent.items) {\r\n      const activeCyberdeck = parent.items.find((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.featType === 'cyberdeck' && \r\n        item.system.active === true\r\n      );\r\n      if (activeCyberdeck && activeCyberdeck.system) {\r\n        firewall = activeCyberdeck.system.firewall || 1;\r\n      }\r\n    }\r\n    \r\n    (this as any).damageThresholds = {\r\n      withoutArmor: {\r\n        light: strength + bonusPhysicalThreshold,\r\n        severe: strength + bonusPhysicalThreshold + 3,\r\n        incapacitating: strength + bonusPhysicalThreshold + 6\r\n      },\r\n      withArmor: {\r\n        light: strength + totalArmorLevel + bonusPhysicalThreshold,\r\n        severe: strength + totalArmorLevel + bonusPhysicalThreshold + 3,\r\n        incapacitating: strength + totalArmorLevel + bonusPhysicalThreshold + 6\r\n      },\r\n      mental: {\r\n        light: willpower + bonusMentalThreshold,\r\n        severe: willpower + bonusMentalThreshold + 3,\r\n        incapacitating: willpower + bonusMentalThreshold + 6\r\n      },\r\n      matrix: {\r\n        light: firewall,\r\n        severe: firewall * 2,\r\n        incapacitating: firewall * 3\r\n      }\r\n    };\r\n    \r\n    // Calculate current essence\r\n    const maxEssence = (this as any).maxEssence || 6;\r\n    (this as any).currentEssence = Math.max(0, maxEssence - totalEssenceCost);\r\n    \r\n    // Calculate costs for each attribute\r\n    const attributes = (this as any).attributes;\r\n    if (attributes) {\r\n      // Clamp attributes to their maximums\r\n      attributes.strength = Math.min(attributes.strength || 1, attributeMaxes.strength);\r\n      attributes.agility = Math.min(attributes.agility || 1, attributeMaxes.agility);\r\n      attributes.willpower = Math.min(attributes.willpower || 1, attributeMaxes.willpower);\r\n      attributes.logic = Math.min(attributes.logic || 1, attributeMaxes.logic);\r\n      attributes.charisma = Math.min(attributes.charisma || 1, attributeMaxes.charisma);\r\n      \r\n      (this as any).attributeCosts = {\r\n        strength: this.calculateAttributeCost(attributes.strength || 1, attributeMaxes.strength),\r\n        agility: this.calculateAttributeCost(attributes.agility || 1, attributeMaxes.agility),\r\n        willpower: this.calculateAttributeCost(attributes.willpower || 1, attributeMaxes.willpower),\r\n        logic: this.calculateAttributeCost(attributes.logic || 1, attributeMaxes.logic),\r\n        charisma: this.calculateAttributeCost(attributes.charisma || 1, attributeMaxes.charisma)\r\n      };\r\n      \r\n      // Calculate total cost of attributes\r\n      const attributeCosts = (this as any).attributeCosts;\r\n      let totalCost = Object.values(attributeCosts).reduce((sum: number, cost: any) => sum + cost, 0);\r\n      \r\n      // Add armor cost\r\n      totalCost += (this as any).armorCost || 0;\r\n      \r\n      // Add items cost (skills and feats)\r\n      // Only count active feats in the total cost\r\n      if (parent && parent.items) {\r\n        parent.items.forEach((item: any) => {\r\n          if (item.system && item.system.calculatedCost !== undefined) {\r\n            // Skip inactive feats when calculating total cost\r\n            if (item.type === 'feat' && item.system.active === false) {\r\n              return;\r\n            }\r\n            totalCost += item.system.calculatedCost;\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Add linked vehicles cost\r\n      const linkedVehicles = (this as any).linkedVehicles || [];\r\n      if (linkedVehicles.length > 0) {\r\n        console.log(linkedVehicles)\r\n        for (const vehicleUuid of linkedVehicles) {\r\n          try {\r\n            // Try to load vehicle actor synchronously (for actors in world) or from game.actors\r\n            let vehicleActor: any = null;\r\n            \r\n            // First try fromUuidSync if available (Foundry VTT v13+)\r\n            if ((foundry.utils as any)?.fromUuidSync) {\r\n              try {\r\n                vehicleActor = (foundry.utils as any).fromUuidSync(vehicleUuid);\r\n              } catch (e) {\r\n                // fromUuidSync might fail for compendium items, try game.actors\r\n              }\r\n            }\r\n            \r\n            // Fallback: try to find in game.actors by UUID or ID\r\n            if (!vehicleActor && game.actors) {\r\n              // First try to find by full UUID match\r\n              vehicleActor = (game.actors as any).find((actor: any) => actor.uuid === vehicleUuid);\r\n              \r\n              // If not found, try by ID (last part of UUID)\r\n              if (!vehicleActor) {\r\n                const uuidParts = vehicleUuid.split('.');\r\n                if (uuidParts.length >= 3) {\r\n                  const actorId = uuidParts[uuidParts.length - 1];\r\n                  vehicleActor = (game.actors as any).get(actorId);\r\n                }\r\n              }\r\n            }\r\n            \r\n            if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n              const vehicleCost = vehicleActor.system?.calculatedCost || 0;\r\n              totalCost += vehicleCost;\r\n            }\r\n          } catch (error) {\r\n            console.warn(`Failed to load linked vehicle ${vehicleUuid} for cost calculation:`, error);\r\n          }\r\n        }\r\n      }\r\n      \r\n      (this as any).totalCost = totalCost;\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * Weapon types configuration with their stats\r\n * Includes recommended skill and specialization for attack AND defense\r\n * Specializations are prefixed with \"Spé : \" to easily find them in game.items\r\n */\r\nexport const WEAPON_TYPES = {\r\n  \"custom-weapon\": { \r\n    vd: \"0\", melee: \"none\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Combat rapproché - Mains nues\r\n  \"bare-hands\": { \r\n    vd: \"FOR\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Mains nues\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Combat rapproché - Lames\r\n  \"short-weapons\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  \"long-weapons\": { \r\n    vd: \"FOR+2\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Combat rapproché - Armes contondantes\r\n  \"advanced-melee\": { \r\n    vd: 5, melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  \"tasers\": { \r\n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Armes à distance - Armes de jet\r\n  \"throwing\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"grenades\": { \r\n    vd: 7, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"gas-grenades\": { \r\n    vd: \"toxin\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Armes de trait\r\n  \"bows\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"crossbows\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Pistolets\r\n  \"pocket-pistols\": { \r\n    vd: 3, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"light-pistols\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"automatic-pistols\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"heavy-pistols\": { \r\n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Mitraillettes\r\n  \"smgs\": { \r\n    vd: 5, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Mitraillettes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Fusils\r\n  \"assault-rifles\": { \r\n    vd: 7, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"disadvantage\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"shotguns\": { \r\n    vd: 8, melee: \"disadvantage\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"sniper-rifles\": { \r\n    vd: 10, melee: \"none\", short: \"disadvantage\", medium: \"disadvantage\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Lance-grenades\r\n  \"grenade-launchers\": { \r\n    vd: 7, melee: \"none\", short: \"disadvantage\", medium: \"ok\", long: \"disadvantage\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Lance-grenades\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Armes lourdes\r\n  \"machine-guns\": { \r\n    vd: 9, melee: \"none\", short: \"ok\", medium: \"ok\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"rocket-launchers\": { \r\n    vd: 12, melee: \"none\", short: \"none\", medium: \"disadvantage\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  }\r\n} as const;\r\n\r\n/**\r\n * Vehicle/Drone types configuration with their stats\r\n * Imported from JSON file\r\n */\r\nimport vehicleTypesData from '../config/vehicle-types.json';\r\n\r\nexport type VehicleType = keyof typeof vehicleTypesData;\r\nexport type VehicleStats = {\r\n  autopilot: number;\r\n  structure: number;\r\n  handling: number;\r\n  speed: number;\r\n  flyingSpeed: number;\r\n  armor: number;\r\n  weaponMount: string;\r\n};\r\n\r\nexport const VEHICLE_TYPES: Record<VehicleType, VehicleStats> = vehicleTypesData as Record<VehicleType, VehicleStats>;\r\n\r\n/**\r\n * Data model for Feat items\r\n */\r\nexport class FeatDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\r\n      }),\r\n      rating: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.RATING\"\r\n      }),\r\n      cost: new fields.StringField({\r\n        required: true,\r\n        initial: \"free-equipment\",\r\n        choices: {\r\n          \"free-equipment\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\",\r\n          \"equipment\": \"SRA2.FEATS.COST.EQUIPMENT\",\r\n          \"advanced-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\r\n          // Legacy values kept for migration compatibility (not shown in UI)\r\n          \"specialized-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\r\n          \"feat\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\"\r\n        },\r\n        label: \"SRA2.FEATS.COST.LABEL\"\r\n      }),\r\n      active: new fields.BooleanField({\r\n        required: true,\r\n        initial: true,\r\n        label: \"SRA2.FEATS.ACTIVE\"\r\n      }),\r\n      rrList: new fields.ArrayField(new fields.SchemaField({\r\n        rrType: new fields.StringField({\r\n          required: true,\r\n          initial: \"skill\",\r\n          choices: {\r\n            \"attribute\": \"SRA2.FEATS.RR_TYPE.ATTRIBUTE\",\r\n            \"skill\": \"SRA2.FEATS.RR_TYPE.SKILL\",\r\n            \"specialization\": \"SRA2.FEATS.RR_TYPE.SPECIALIZATION\"\r\n          },\r\n          label: \"SRA2.FEATS.RR_TYPE.LABEL\"\r\n        }),\r\n        rrValue: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 0,\r\n          max: 3,\r\n          integer: true,\r\n          label: \"SRA2.FEATS.RR_VALUE\"\r\n        }),\r\n        rrTarget: new fields.StringField({\r\n          required: false,\r\n          initial: \"\",\r\n          nullable: false,\r\n          label: \"SRA2.FEATS.RR_TARGET\"\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.FEATS.RR_LIST\"\r\n      }),\r\n      bonusLightDamage: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_LIGHT_DAMAGE\"\r\n      }),\r\n      bonusSevereDamage: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_SEVERE_DAMAGE\"\r\n      }),\r\n      bonusPhysicalThreshold: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_PHYSICAL_THRESHOLD\"\r\n      }),\r\n      bonusMentalThreshold: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_MENTAL_THRESHOLD\"\r\n      }),\r\n      characterArmorLevel: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 5,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.CHARACTER_ARMOR_LEVEL\"\r\n      }),\r\n      armorValue: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 5,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.ARMOR_VALUE\"\r\n      }),\r\n      bonusAnarchy: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_ANARCHY\"\r\n      }),\r\n      essenceCost: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        label: \"SRA2.FEATS.ESSENCE_COST\"\r\n      }),\r\n      isBioware: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_BIOWARE\"\r\n      }),\r\n      featType: new fields.StringField({\r\n        required: true,\r\n        initial: \"equipment\",\r\n        choices: {\r\n          \"trait\": \"SRA2.FEATS.FEAT_TYPE.TRAIT\",\r\n          \"contact\": \"SRA2.FEATS.FEAT_TYPE.CONTACT\",\r\n          \"awakened\": \"SRA2.FEATS.FEAT_TYPE.AWAKENED\",\r\n          \"adept-power\": \"SRA2.FEATS.FEAT_TYPE.ADEPT_POWER\",\r\n          \"equipment\": \"SRA2.FEATS.FEAT_TYPE.EQUIPMENT\",\r\n          \"armor\": \"SRA2.FEATS.FEAT_TYPE.ARMOR\",\r\n          \"cyberware\": \"SRA2.FEATS.FEAT_TYPE.CYBERWARE\",\r\n          \"cyberdeck\": \"SRA2.FEATS.FEAT_TYPE.CYBERDECK\",\r\n          \"vehicle\": \"SRA2.FEATS.FEAT_TYPE.VEHICLE\",\r\n          \"weapons-spells\": \"SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS\",\r\n          \"weapon\": \"SRA2.FEATS.FEAT_TYPE.WEAPON\",\r\n          \"spell\": \"SRA2.FEATS.FEAT_TYPE.SPELL\",\r\n          \"connaissance\": \"SRA2.FEATS.FEAT_TYPE.CONNAISSANCE\",\r\n          \"power\": \"SRA2.FEATS.FEAT_TYPE.POWER\"\r\n        },\r\n        label: \"SRA2.FEATS.FEAT_TYPE.LABEL\"\r\n      }),\r\n      weaponType: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.WEAPON_TYPE\"\r\n      }),\r\n      vehicleType: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.VEHICLE_TYPE\"\r\n      }),\r\n      // Weapon/Spell specific fields\r\n      damageValue: new fields.StringField({\r\n        required: true,\r\n        initial: \"0\",\r\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE\"\r\n      }),\r\n      damageValueBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE_BONUS\"\r\n      }),\r\n      meleeRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.MELEE_RANGE\"\r\n      }),\r\n      shortRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.SHORT_RANGE\"\r\n      }),\r\n      mediumRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.MEDIUM_RANGE\"\r\n      }),\r\n      longRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.LONG_RANGE\"\r\n      }),\r\n      rangeImprovements: new fields.SchemaField({\r\n        melee: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        short: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        medium: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        long: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }, {\r\n        required: true,\r\n        label: \"SRA2.FEATS.WEAPON.RANGE_IMPROVEMENTS\"\r\n      }),\r\n      // Vehicle/Drone specific fields\r\n      autopilot: new fields.NumberField({\r\n        required: true,\r\n        initial: 6,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT\"\r\n      }),\r\n      structure: new fields.NumberField({\r\n        required: true,\r\n        initial: 2,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.STRUCTURE\"\r\n      }),\r\n      handling: new fields.NumberField({\r\n        required: true,\r\n        initial: 5,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING\"\r\n      }),\r\n      speed: new fields.NumberField({\r\n        required: true,\r\n        initial: 3,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED\"\r\n      }),\r\n      flyingSpeed: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.FLYING_SPEED\"\r\n      }),\r\n      armor: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR\"\r\n      }),\r\n      weaponMount: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\r\n      }),\r\n      weaponInfo: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\r\n      }),\r\n      // Vehicle bonuses\r\n      autopilotBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 6,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\r\n      }),\r\n      speedBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\r\n      }),\r\n      handlingBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\r\n      }),\r\n      armorBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\r\n      }),\r\n      isFixed: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\r\n      }),\r\n      isFlying: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\r\n      }),\r\n      weaponMountImprovement: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\r\n      }),\r\n      autopilotUnlocked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\r\n      }),\r\n      additionalDroneCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\r\n      }),\r\n      // Reference to vehicle actor when feat is created from dragging a vehicle actor\r\n      vehicleActorUuid: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        nullable: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ACTOR_UUID\"\r\n      }),\r\n      // Cyberdeck specific fields\r\n      firewall: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.FIREWALL\"\r\n      }),\r\n      attack: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.ATTACK\"\r\n      }),\r\n      cyberdeckDamage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }, {\r\n        required: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.DAMAGE\"\r\n      }),\r\n      // Cyberdeck bonus light damage (+1 light damage box for cyberdeck, +1 to recommended level)\r\n      cyberdeckBonusLightDamage: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.CYBERDECK.BONUS_LIGHT_DAMAGE\"\r\n      }),\r\n      // Contact specific fields\r\n      contactName: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.CONTACT.NAME\"\r\n      }),\r\n      // Awakened specific fields\r\n      astralPerception: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PERCEPTION\"\r\n      }),\r\n      astralProjection: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PROJECTION\"\r\n      }),\r\n      sorcery: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.SORCERY\"\r\n      }),\r\n      conjuration: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.CONJURATION\"\r\n      }),\r\n      adept: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ADEPT\"\r\n      }),\r\n      // Additional fields for recommended level calculation\r\n      riggerConsoleCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.RIGGER_CONSOLE_COUNT\"\r\n      }),\r\n      hasVehicleControlWiring: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.HAS_VEHICLE_CONTROL_WIRING\"\r\n      }),\r\n      isWeaponFocus: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_WEAPON_FOCUS\"\r\n      }),\r\n      isAdeptPowerWeapon: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_ADEPT_POWER_WEAPON\"\r\n      }),\r\n      // Narrative effects\r\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\r\n        text: new fields.StringField({\r\n          required: false,\r\n          initial: \"\"\r\n        }),\r\n        isNegative: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        value: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: -5,\r\n          max: 5\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.FEATS.NARRATIVE_EFFECTS\"\r\n      }),\r\n      // Grants narration\r\n      grantsNarration: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.GRANTS_NARRATION\"\r\n      }),\r\n      narrationActions: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 1,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.NARRATION_ACTIONS\"\r\n      }),\r\n      // Additional sustained spells and summoned spirits\r\n      sustainedSpellCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.SUSTAINED_SPELL_COUNT\"\r\n      }),\r\n      summonedSpiritCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 1,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.SUMMONED_SPIRIT_COUNT\"\r\n      }),\r\n      // First feat flag\r\n      isFirstFeat: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_FIRST_FEAT\"\r\n      }),\r\n      // Shamanic mask (for awakened feats)\r\n      shamanicMask: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.SHAMANIC_MASK\"\r\n      }),\r\n      // Spell type (direct or indirect)\r\n      spellType: new fields.StringField({\r\n        required: true,\r\n        initial: \"direct\",\r\n        choices: {\r\n          \"direct\": \"SRA2.FEATS.SPELL.TYPE_DIRECT\",\r\n          \"indirect\": \"SRA2.FEATS.SPELL.TYPE_INDIRECT\"\r\n        },\r\n        label: \"SRA2.FEATS.SPELL.TYPE\"\r\n      }),\r\n      // Weapon damage bonus by weapon type\r\n      weaponDamageBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.WEAPON_DAMAGE_BONUS\"\r\n      }),\r\n      weaponTypeBonus: new fields.StringField({\r\n        required: true,\r\n        initial: \"custom-weapon\",\r\n        choices: (() => {\r\n          const choices: Record<string, string> = {};\r\n          Object.keys(WEAPON_TYPES).forEach((key) => {\r\n            choices[key] = key;\r\n          });\r\n          return choices;\r\n        })(),\r\n        label: \"SRA2.FEATS.WEAPON_TYPE_BONUS\"\r\n      }),\r\n      // Spell specialization type (determines which specialization to use)\r\n      spellSpecializationType: new fields.StringField({\r\n        required: true,\r\n        initial: \"combat\",\r\n        choices: {\r\n          \"combat\": \"SRA2.FEATS.SPELL.SPECIALIZATION.COMBAT\",\r\n          \"detection\": \"SRA2.FEATS.SPELL.SPECIALIZATION.DETECTION\",\r\n          \"health\": \"SRA2.FEATS.SPELL.SPECIALIZATION.HEALTH\",\r\n          \"illusion\": \"SRA2.FEATS.SPELL.SPECIALIZATION.ILLUSION\",\r\n          \"manipulation\": \"SRA2.FEATS.SPELL.SPECIALIZATION.MANIPULATION\",\r\n          \"counterspell\": \"SRA2.FEATS.SPELL.SPECIALIZATION.COUNTERSPELL\"\r\n        },\r\n        label: \"SRA2.FEATS.SPELL.SPECIALIZATION.TYPE\"\r\n      }),\r\n      // Linked skills and specializations for weapons (for custom weapons)\r\n      linkedAttackSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SKILL\"\r\n      }),\r\n      linkedAttackSpecialization: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SPECIALIZATION\"\r\n      }),\r\n      linkedDefenseSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SKILL\"\r\n      }),\r\n      linkedDefenseSpecialization: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SPECIALIZATION\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Get common properties\r\n    const costType = (this as any).cost || 'free-equipment';\r\n    const featType = (this as any).featType || 'equipment';\r\n    const rating = (this as any).rating || 0;\r\n    \r\n    // If astral projection is enabled, automatically enable astral perception\r\n    if ((this as any).astralProjection) {\r\n      (this as any).astralPerception = true;\r\n    }\r\n    \r\n    // For spells, automatically set linkedAttackSkill and linkedAttackSpecialization\r\n    if (featType === 'spell') {\r\n      // Always set attack skill to Sorcellerie\r\n      (this as any).linkedAttackSkill = 'Sorcellerie';\r\n      \r\n      // Map spell specialization type to specialization name\r\n      const spellSpecType = (this as any).spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      (this as any).linkedAttackSpecialization = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n    }\r\n    \r\n    // Calculate cost based on cost type (for equipment and weapons)\r\n    let calculatedCost = 0;\r\n    \r\n    // Connaissance: base cost of 2500\r\n    if (featType === 'connaissance') {\r\n      calculatedCost = 2500;\r\n    }\r\n    \r\n    // Apply cost calculations for equipment, weapon, and weapons-spells types\r\n    if (featType === 'equipment' || featType === 'weapon' || featType === 'weapons-spells') {\r\n      switch (costType) {\r\n        case 'free-equipment':\r\n          calculatedCost = 0;\r\n          break;\r\n        case 'equipment':\r\n          calculatedCost = 2500;\r\n          break;\r\n        case 'advanced-equipment':\r\n          calculatedCost = 5000;\r\n          break;\r\n        // Legacy values (kept for migration compatibility)\r\n        case 'specialized-equipment':\r\n          calculatedCost = 5000;\r\n          break;\r\n        case 'feat':\r\n          calculatedCost = 0;\r\n          break;\r\n        default:\r\n          calculatedCost = 0;\r\n      }\r\n    }\r\n\r\n    calculatedCost += rating * 5000;\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n\r\n    // Calculate recommended attribute level\r\n    let recommendedLevel = 0;\r\n    const recommendedLevelBreakdown: Array<{ labelKey: string; labelParams?: string; value: number }> = [];\r\n    \r\n    const bonusLightDamage = (this as any).bonusLightDamage || 0;\r\n    const bonusSevereDamage = (this as any).bonusSevereDamage || 0;\r\n    const bonusPhysicalThreshold = (this as any).bonusPhysicalThreshold || 0;\r\n    const bonusMentalThreshold = (this as any).bonusMentalThreshold || 0;\r\n    const firewall = (this as any).firewall || 0;\r\n    const attack = (this as any).attack || 0;\r\n    const riggerConsoleCount = (this as any).riggerConsoleCount || 0;\r\n    const hasVehicleControlWiring = (this as any).hasVehicleControlWiring || false;\r\n    const isWeaponFocus = (this as any).isWeaponFocus || false;\r\n    const isAdeptPowerWeapon = (this as any).isAdeptPowerWeapon || false;\r\n    const isBioware = (this as any).isBioware || false;\r\n    const bonusAnarchy = (this as any).bonusAnarchy || 0;\r\n    const grantsNarration = (this as any).grantsNarration || false;\r\n    const narrativeEffects = (this as any).narrativeEffects || [];\r\n    const rrList = (this as any).rrList || [];\r\n    const isFirstFeat = (this as any).isFirstFeat || false;\r\n    \r\n    // Base cost for trait (not first feat): +3 levels\r\n    if (featType === 'trait' && !isFirstFeat) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BASE_FEAT_COST', value: 3 });\r\n    }\r\n    \r\n    // Cyberware/bioware: 1 level (base), +1 additional if bioware\r\n    if (featType === 'cyberware') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERWARE', value: 1 });\r\n      \r\n      // Bioware: +1 additional level\r\n      if (isBioware) {\r\n        recommendedLevel += 1;\r\n        recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BIOWARE', value: 1 });\r\n      }\r\n    }\r\n    \r\n    // Adept power: 1 level\r\n    if (featType === 'adept-power') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER', value: 1 });\r\n    }\r\n    \r\n    // Spell: 1 level\r\n    if (featType === 'spell') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPELL', value: 1 });\r\n    }\r\n    \r\n    // Vehicle/Drone: 1 level\r\n    if (featType === 'vehicle') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE', value: 1 });\r\n    }\r\n    \r\n    // Light wounds: +3 per wound\r\n    if (bonusLightDamage > 0) {\r\n      const value = bonusLightDamage * 3;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.LIGHT_WOUNDS', labelParams: `(${bonusLightDamage})`, value });\r\n    }\r\n    \r\n    // Heavy wounds: +6 per wound\r\n    if (bonusSevereDamage > 0) {\r\n      const value = bonusSevereDamage * 6;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SEVERE_WOUNDS', labelParams: `(${bonusSevereDamage})`, value });\r\n    }\r\n    \r\n    // Physical threshold bonus: +1 per point (positive or negative)\r\n    if (bonusPhysicalThreshold !== 0) {\r\n      const value = Math.abs(bonusPhysicalThreshold);\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.PHYSICAL_THRESHOLD', labelParams: `(${bonusPhysicalThreshold > 0 ? '+' : ''}${bonusPhysicalThreshold})`, value });\r\n    }\r\n    \r\n    // Mental threshold bonus: +1 per point (positive or negative)\r\n    if (bonusMentalThreshold !== 0) {\r\n      const value = Math.abs(bonusMentalThreshold);\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.MENTAL_THRESHOLD', labelParams: `(${bonusMentalThreshold > 0 ? '+' : ''}${bonusMentalThreshold})`, value });\r\n    }\r\n    \r\n    // Cyberdeck firewall: starts at 1, each level is +1\r\n    if (featType === 'cyberdeck' && firewall > 0) {\r\n      recommendedLevel += firewall;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.FIREWALL', labelParams: `(${firewall})`, value: firewall });\r\n    }\r\n    \r\n    // Cyberdeck bonus light damage: +3 to recommended level\r\n    const cyberdeckBonusLightDamage = (this as any).cyberdeckBonusLightDamage || false;\r\n    if (featType === 'cyberdeck' && cyberdeckBonusLightDamage) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERDECK_BONUS_LIGHT_DAMAGE', value: 3 });\r\n    }\r\n    \r\n    // Attack: starts at 0, each level is +1\r\n    if (attack > 0) {\r\n      recommendedLevel += attack;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ATTACK', labelParams: `(${attack})`, value: attack });\r\n    }\r\n    \r\n    // Rigger console: +1 per drone controller\r\n    if (riggerConsoleCount > 0) {\r\n      recommendedLevel += riggerConsoleCount;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RIGGER_CONSOLE', labelParams: `(${riggerConsoleCount})`, value: riggerConsoleCount });\r\n    }\r\n    \r\n    // Vehicle control wiring: +2\r\n    if (hasVehicleControlWiring) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE_WIRING', value: 2 });\r\n    }\r\n    \r\n    // Weapon focus: +1\r\n    if (isWeaponFocus) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_FOCUS', value: 1 });\r\n    }\r\n    \r\n    // Adept power weapon: +1\r\n    if (isAdeptPowerWeapon) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER_WEAPON', value: 1 });\r\n    }\r\n    \r\n    // Damage value bonus: +1 per bonus\r\n    const damageValueBonus = (this as any).damageValueBonus || 0;\r\n    if (damageValueBonus > 0) {\r\n      recommendedLevel += damageValueBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.DAMAGE_VALUE_BONUS', labelParams: `(+${damageValueBonus})`, value: damageValueBonus });\r\n    }\r\n    \r\n    // Weapon damage bonus by weapon type: +1 per bonus\r\n    const weaponDamageBonus = (this as any).weaponDamageBonus || 0;\r\n    if (weaponDamageBonus > 0) {\r\n      recommendedLevel += weaponDamageBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_DAMAGE_BONUS', labelParams: `(+${weaponDamageBonus})`, value: weaponDamageBonus });\r\n    }\r\n    \r\n    // Range improvements: +2 per improved range\r\n    const rangeImprovements = (this as any).rangeImprovements || {};\r\n    let rangeImprovementCount = 0;\r\n    if (rangeImprovements.melee) rangeImprovementCount++;\r\n    if (rangeImprovements.short) rangeImprovementCount++;\r\n    if (rangeImprovements.medium) rangeImprovementCount++;\r\n    if (rangeImprovements.long) rangeImprovementCount++;\r\n    if (rangeImprovementCount > 0) {\r\n      const value = rangeImprovementCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RANGE_IMPROVEMENTS', labelParams: `(${rangeImprovementCount})`, value });\r\n    }\r\n    \r\n    // Resource Reduction (RR) entries\r\n    for (const rr of rrList) {\r\n      const rrType = rr.rrType;\r\n      const rrValue = rr.rrValue || 0;\r\n      \r\n      if (rrValue > 0) {\r\n        if (rrType === 'specialization') {\r\n          // RR specialization: +2 levels per value\r\n          const value = rrValue * 2;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SPECIALIZATION', labelParams: `(${rrValue})`, value });\r\n        } else if (rrType === 'skill') {\r\n          // RR skill: +5 levels per value\r\n          const value = rrValue * 5;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SKILL', labelParams: `(${rrValue})`, value });\r\n        } else if (rrType === 'attribute') {\r\n          // RR attribute: +10 levels per value\r\n          const value = rrValue * 10;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_ATTRIBUTE', labelParams: `(${rrValue})`, value });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Anarchy bonus: +2 per anarchy point\r\n    if (bonusAnarchy > 0) {\r\n      const value = bonusAnarchy * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ANARCHY_BONUS', labelParams: `(${bonusAnarchy})`, value });\r\n    }\r\n    \r\n    // Grants narration: +3 levels\r\n    if (grantsNarration) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.GRANTS_NARRATION', value: 3 });\r\n    }\r\n    \r\n    // Narrative effects: value per positive effect, value per negative effect (exclude effects with value 0)\r\n    const positiveEffects = narrativeEffects.filter((effect: any) => {\r\n      return effect?.text && effect.text.trim() !== '' && !effect.isNegative && effect.value !== 0 && effect.value !== null && effect.value !== undefined;\r\n    });\r\n    const negativeEffects = narrativeEffects.filter((effect: any) => {\r\n      return effect?.text && effect.text.trim() !== '' && effect.isNegative && effect.value !== 0 && effect.value !== null && effect.value !== undefined;\r\n    });\r\n    \r\n    if (positiveEffects.length > 0) {\r\n      const positiveEffectValue = positiveEffects.reduce((sum: number, effect: any) => sum + (effect.value || 1), 0);\r\n      recommendedLevel += positiveEffectValue;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_POSITIVE', labelParams: `(${positiveEffects.length})`, value: positiveEffectValue });\r\n    }\r\n    \r\n    if (negativeEffects.length > 0) {\r\n      const negativeEffectValue = negativeEffects.reduce((sum: number, effect: any) => sum + (effect.value || -1), 0);\r\n      recommendedLevel += negativeEffectValue; // Adding because value is already negative\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_NEGATIVE', labelParams: `(${negativeEffects.length})`, value: negativeEffectValue });\r\n    }\r\n    \r\n    // Additional sustained spells: +2 per spell (max 2)\r\n    const sustainedSpellCount = (this as any).sustainedSpellCount || 0;\r\n    if (sustainedSpellCount > 0) {\r\n      const value = sustainedSpellCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUSTAINED_SPELLS', labelParams: `(${sustainedSpellCount})`, value });\r\n    }\r\n    \r\n    // Additional summoned spirit: +3 (max 1)\r\n    const summonedSpiritCount = (this as any).summonedSpiritCount || 0;\r\n    if (summonedSpiritCount > 0) {\r\n      const value = summonedSpiritCount * 3;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUMMONED_SPIRITS', labelParams: `(${summonedSpiritCount})`, value });\r\n    }\r\n    \r\n    // Awakened abilities\r\n    const astralPerception = (this as any).astralPerception || false;\r\n    const astralProjection = (this as any).astralProjection || false;\r\n    const sorcery = (this as any).sorcery || false;\r\n    const conjuration = (this as any).conjuration || false;\r\n    const adept = (this as any).adept || false;\r\n\r\n    // Astral perception\r\n    if (astralPerception && !astralProjection) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION', value: 1 });\r\n    }\r\n    \r\n    // Astral perception AND projection: +2\r\n    if (astralPerception && astralProjection) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION_PROJECTION', value: 2 });\r\n    }\r\n    \r\n    // Sorcery: +1\r\n    if (sorcery) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SORCERY', value: 1 });\r\n    }\r\n    \r\n    // Conjuration: +2\r\n    if (conjuration) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CONJURATION', value: 2 });\r\n    }\r\n    \r\n    // Adept: +1\r\n    if (adept) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT', value: 1 });\r\n    }\r\n    \r\n    // Vehicle/Drone bonuses\r\n    const autopilotBonus = (this as any).autopilotBonus || 0;\r\n    const speedBonus = (this as any).speedBonus || 0;\r\n    const handlingBonus = (this as any).handlingBonus || 0;\r\n    const armorBonus = (this as any).armorBonus || 0;\r\n    const isFixed = (this as any).isFixed || false;\r\n    const isFlying = (this as any).isFlying || false;\r\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\r\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\r\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\r\n    \r\n    // Autopilot bonus: +1 per level\r\n    if (autopilotBonus > 0) {\r\n      recommendedLevel += autopilotBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_BONUS', labelParams: `(+${autopilotBonus})`, value: autopilotBonus });\r\n    }\r\n    \r\n    // Speed bonus: +1 per level\r\n    if (speedBonus > 0) {\r\n      recommendedLevel += speedBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPEED_BONUS', labelParams: `(+${speedBonus})`, value: speedBonus });\r\n    }\r\n    \r\n    // Handling bonus: +1 per level\r\n    if (handlingBonus > 0) {\r\n      recommendedLevel += handlingBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.HANDLING_BONUS', labelParams: `(+${handlingBonus})`, value: handlingBonus });\r\n    }\r\n    \r\n    // Armor bonus: +1 per level\r\n    if (armorBonus > 0) {\r\n      recommendedLevel += armorBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ARMOR_BONUS', labelParams: `(+${armorBonus})`, value: armorBonus });\r\n    }\r\n    \r\n    // Fixed (unable to move): -1\r\n    if (isFixed) {\r\n      recommendedLevel -= 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FIXED', value: -1 });\r\n    }\r\n    \r\n    // Flying: +1\r\n    if (isFlying) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FLYING', value: 1 });\r\n    }\r\n    \r\n    // Weapon mount improvement: +1\r\n    if (weaponMountImprovement) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_MOUNT_IMPROVEMENT', value: 1 });\r\n    }\r\n    \r\n    // Autopilot unlocked: +3\r\n    if (autopilotUnlocked) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_UNLOCKED', value: 3 });\r\n    }\r\n    \r\n    // Additional drones: +2 per drone\r\n    if (additionalDroneCount > 0) {\r\n      const value = additionalDroneCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADDITIONAL_DRONES', labelParams: `(${additionalDroneCount})`, value });\r\n    }\r\n    \r\n    // Shamanic mask: -1 level (for awakened feats only)\r\n    const shamanicMask = (this as any).shamanicMask || false;\r\n    if (shamanicMask && featType === 'awakened') {\r\n      recommendedLevel -= 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SHAMANIC_MASK', value: -1 });\r\n    }\r\n    \r\n    (this as any).recommendedLevel = recommendedLevel;\r\n    (this as any).recommendedLevelBreakdown = recommendedLevelBreakdown;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Vehicle/Drone actors\r\n */\r\nimport { VEHICLE_TYPES, VehicleType } from './item-feat.js';\r\n\r\nexport class VehicleDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    // Build vehicle type choices from VEHICLE_TYPES\r\n    const vehicleTypeChoices: Record<string, string> = {};\r\n    Object.keys(VEHICLE_TYPES).forEach((key) => {\r\n      vehicleTypeChoices[key] = key;\r\n    });\r\n    \r\n    return {\r\n      vehicleType: new fields.StringField({\r\n        required: false,\r\n        nullable: true,\r\n        choices: vehicleTypeChoices,\r\n        label: \"SRA2.VEHICLE.VEHICLE_TYPE\"\r\n      }),\r\n      // Vehicle bonuses\r\n      autopilotBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 6,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\r\n      }),\r\n      speedBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\r\n      }),\r\n      handlingBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\r\n      }),\r\n      armorBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\r\n      }),\r\n      isFixed: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\r\n      }),\r\n      isFlying: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\r\n      }),\r\n      weaponMountImprovement: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\r\n      }),\r\n      autopilotUnlocked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\r\n      }),\r\n      additionalDroneCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\r\n      }),\r\n      weaponMount: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\r\n      }),\r\n      weaponInfo: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\r\n      }),\r\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\r\n        text: new fields.StringField({\r\n        required: false,\r\n        initial: \"\"\r\n        }),\r\n        isNegative: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        value: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: -5,\r\n          max: 5\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.VEHICLE.NARRATIVE_EFFECTS\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    const vehicleType = (this as any).vehicleType || \"\";\r\n    const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as VehicleType] \r\n      ? VEHICLE_TYPES[vehicleType as VehicleType] \r\n      : null;\r\n    \r\n    // Get base stats from vehicle type or defaults\r\n    const baseAutopilot = vehicleStats?.autopilot || 0;\r\n    const baseStructure = vehicleStats?.structure || 0;\r\n    const baseHandling = vehicleStats?.handling || 0;\r\n    const baseSpeed = vehicleStats?.speed || 0;\r\n    const baseFlyingSpeed = vehicleStats?.flyingSpeed || 0;\r\n    const baseArmor = vehicleStats?.armor || 0;\r\n    const baseWeaponMount = vehicleStats?.weaponMount || \"none\";\r\n    \r\n    // Get bonuses\r\n    const autopilotBonus = (this as any).autopilotBonus || 0;\r\n    const speedBonus = (this as any).speedBonus || 0;\r\n    const handlingBonus = (this as any).handlingBonus || 0;\r\n    const armorBonus = (this as any).armorBonus || 0;\r\n    const isFlying = (this as any).isFlying || false;\r\n    const isFixed = (this as any).isFixed || false;\r\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\r\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\r\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\r\n    \r\n    // Calculate final values (same logic as feat-sheet.ts)\r\n    const finalAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\r\n    const finalHandling = baseHandling + handlingBonus;\r\n    const finalSpeed = isFixed ? 0 : (baseSpeed + speedBonus);\r\n    const finalFlyingSpeed = isFlying ? (baseFlyingSpeed > 0 ? baseFlyingSpeed : 1) : 0;\r\n    const finalArmor = Math.min(baseStructure, baseArmor + armorBonus);\r\n    \r\n    // Calculate weapon mount (improved if option is checked)\r\n    let finalWeaponMount = baseWeaponMount;\r\n    if (weaponMountImprovement) {\r\n      if (baseWeaponMount === \"none\") {\r\n        finalWeaponMount = \"smg\";\r\n      } else if (baseWeaponMount === \"smg\") {\r\n        finalWeaponMount = \"rifle\";\r\n      }\r\n    }\r\n    \r\n    // Store calculated attributes (read-only in UI)\r\n    (this as any).attributes = {\r\n      autopilot: finalAutopilot,\r\n      structure: baseStructure,\r\n      handling: finalHandling,\r\n      speed: finalSpeed,\r\n      flyingSpeed: finalFlyingSpeed,\r\n      armor: finalArmor\r\n    };\r\n    \r\n    // Store base stats for reference\r\n    (this as any).baseAttributes = {\r\n      autopilot: baseAutopilot,\r\n      structure: baseStructure,\r\n      handling: baseHandling,\r\n      speed: baseSpeed,\r\n      flyingSpeed: baseFlyingSpeed,\r\n      armor: baseArmor\r\n    };\r\n    \r\n    // Store weapon mount info\r\n    (this as any).weaponMount = finalWeaponMount;\r\n    \r\n    // Calculate damage thresholds for vehicles\r\n    // Based on the formulas:\r\n    // - If VD > (3 × Structure) + Armor, incapacitating damage\r\n    // - If VD > (2 × Structure) + Armor, severe damage\r\n    // - If VD > Structure + Armor, light damage\r\n    // - If VD ≤ Structure + Armor, no damage\r\n    \r\n    (this as any).damageThresholds = {\r\n      light: baseStructure + finalArmor,\r\n      severe: (2 * baseStructure) + finalArmor,\r\n      incapacitating: (3 * baseStructure) + finalArmor\r\n    };\r\n    \r\n    // Ensure damage arrays are properly sized (preserve existing values)\r\n    // CRITICAL: Read from source data first to preserve persisted values\r\n    // In Foundry v13, when prepareDerivedData() is called, (this as any).damage\r\n    // should already contain the persisted values from _source, but we need to\r\n    // ensure we're working with a copy to avoid mutating the source\r\n    const parent = (this as any).parent;\r\n    const sourceDamage = parent?._source?.system?.damage || (this as any).damage || {};\r\n    \r\n    // Base: 2 light, 1 severe, 1 incapacitating\r\n    const totalLightBoxes = 2;\r\n    const totalSevereBoxes = 1;\r\n    \r\n    // Create a copy from source to preserve persisted values\r\n    const damage: any = {\r\n      light: Array.isArray(sourceDamage.light) ? [...sourceDamage.light] : [false, false],\r\n      severe: Array.isArray(sourceDamage.severe) ? [...sourceDamage.severe] : [false],\r\n      incapacitating: typeof sourceDamage.incapacitating === 'boolean' ? sourceDamage.incapacitating : false\r\n    };\r\n    \r\n    // Adjust light damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.light.length < totalLightBoxes) {\r\n      damage.light.push(false);\r\n    }\r\n    while (damage.light.length > totalLightBoxes) {\r\n      damage.light.pop();\r\n    }\r\n    \r\n    // Adjust severe damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.severe.length < totalSevereBoxes) {\r\n      damage.severe.push(false);\r\n    }\r\n    while (damage.severe.length > totalSevereBoxes) {\r\n      damage.severe.pop();\r\n    }\r\n    \r\n    // Assign the damage object (this updates derived data, source data remains unchanged)\r\n    (this as any).damage = damage;\r\n    \r\n    (this as any).totalLightBoxes = totalLightBoxes;\r\n    (this as any).totalSevereBoxes = totalSevereBoxes;\r\n    \r\n    // Calculate cost (same rules as vehicle feats: base 5000 + bonuses * 5000)\r\n    let calculatedCost = 5000; // Base cost for vehicle/drone\r\n    \r\n    // Add cost for bonuses (each bonus point costs 5000)\r\n    calculatedCost += autopilotBonus * 5000;\r\n    calculatedCost += speedBonus * 5000;\r\n    calculatedCost += handlingBonus * 5000;\r\n    calculatedCost += armorBonus * 5000;\r\n    \r\n    // Add cost for options\r\n    if (isFlying) {\r\n      calculatedCost += 5000; // +1 level = +5000\r\n    }\r\n    if (weaponMountImprovement) {\r\n      calculatedCost += 5000; // +1 level = +5000\r\n    }\r\n    if (autopilotUnlocked) {\r\n      calculatedCost += 15000; // +3 levels = +15000\r\n    }\r\n    if (additionalDroneCount > 0) {\r\n      calculatedCost += additionalDroneCount * 10000; // +2 levels per drone = +10000 per drone\r\n    }\r\n    if (isFixed) {\r\n      calculatedCost -= 5000; // -1 level = -5000\r\n    }\r\n    \r\n    // Add cost for narrative effects based on their values (5000 per point of value)\r\n    // Positive values add to cost, negative values reduce cost\r\n    const narrativeEffects = (this as any).narrativeEffects || [];\r\n    let narrativeEffectsCost = 0;\r\n    \r\n    narrativeEffects.forEach((effect: any) => {\r\n      // Handle both old format (strings) and new format (objects)\r\n      if (typeof effect === 'string') {\r\n        // Old format: each string effect counts as +1 (5000 yens)\r\n        if (effect && effect.trim() !== '') {\r\n          narrativeEffectsCost += 5000;\r\n        }\r\n      } else if (effect && typeof effect === 'object') {\r\n        // New format: use the value of the effect\r\n        // Each point of absolute value = 5000 yens (positive adds, negative subtracts)\r\n        const value = effect.value !== undefined && effect.value !== null ? effect.value : 0;\r\n        \r\n        if (value !== 0) {\r\n          // Each point of value = 5000 yens per palier (positive adds, negative subtracts)\r\n          narrativeEffectsCost += value * 5000;\r\n        }\r\n      }\r\n    });\r\n    \r\n    calculatedCost += narrativeEffectsCost;\r\n    \r\n    // Add cost for weapons (get from actor items)\r\n    const actor = (this as any).parent;\r\n    if (actor && actor.items) {\r\n      const weapons = actor.items.filter((item: any) => {\r\n        const featType = item.system?.featType;\r\n        return featType === 'weapon' || featType === 'weapons-spells';\r\n      });\r\n      \r\n      weapons.forEach((weapon: any) => {\r\n        const weaponCost = weapon.system?.calculatedCost || 0;\r\n        calculatedCost += weaponCost;\r\n      });\r\n    }\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n  }\r\n}\r\n\r\n\r\n","/**\r\n * Data model for ICE actors\r\n */\r\nexport const ICE_TYPES = {\r\n  patrol: 'Patrouilleuse',\r\n  acid: 'Acide',\r\n  blaster: 'Blaster',\r\n  blocker: 'Bloqueuse',\r\n  black: 'Noire',\r\n  glue: 'Pot de colle',\r\n  tracker: 'Traqueuse',\r\n  killer: 'Tueuse'\r\n} as const;\r\n\r\nexport type IceType = keyof typeof ICE_TYPES;\r\n\r\nexport class IceDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    // Build ICE type choices from ICE_TYPES\r\n    const iceTypeChoices: Record<string, string> = {};\r\n    Object.entries(ICE_TYPES).forEach(([key, value]) => {\r\n      iceTypeChoices[key] = value;\r\n    });\r\n    \r\n    return {\r\n      iceType: new fields.StringField({\r\n        required: false,\r\n        nullable: true,\r\n        choices: iceTypeChoices,\r\n        label: \"SRA2.ICE.ICE_TYPE\"\r\n      }),\r\n      serverIndex: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 1,\r\n        max: 12,\r\n        integer: true,\r\n        label: \"SRA2.ICE.SERVER_INDEX\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    const serverIndex = (this as any).serverIndex || 1;\r\n    \r\n    // Firewall is always 1 for ICEs\r\n    const firewall = 1;\r\n    (this as any).attributes = {\r\n      firewall: firewall\r\n    };\r\n    \r\n    // Threshold equals server index (number of successes)\r\n    (this as any).threshold = serverIndex;\r\n    \r\n    // Calculate damage thresholds based on FW = 1\r\n    // Light: 1, Severe: 2, Incapacitating: 3\r\n    (this as any).damageThresholds = {\r\n      light: 1,\r\n      severe: 2,\r\n      incapacitating: 3\r\n    };\r\n    \r\n    // Calculate damage value based on ICE type and server index\r\n    const iceType = (this as any).iceType || '';\r\n    let damageValue = 0;\r\n    \r\n    if (iceType === 'blaster' || iceType === 'black') {\r\n      // VD = Indice du serveur/2 (arrondi au supérieur)\r\n      damageValue = Math.ceil(serverIndex / 2);\r\n    } else if (iceType === 'killer') {\r\n      // VD = Indice du serveur\r\n      damageValue = serverIndex;\r\n    }\r\n    // Other ICE types don't deal damage\r\n    \r\n    (this as any).damageValue = damageValue;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Skill items\r\n */\r\nexport class SkillDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      rating: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 0,\r\n        max: 8,\r\n        integer: true,\r\n        label: \"SRA2.SKILLS.RATING\"\r\n      }),\r\n      linkedAttribute: new fields.StringField({\r\n        required: true,\r\n        initial: \"strength\",\r\n        choices: {\r\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\r\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\r\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\r\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\r\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\r\n        },\r\n        label: \"SRA2.SKILLS.LINKED_ATTRIBUTE\"\r\n      }),\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.SKILLS.BOOKMARKED\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Calculate cost based on rating\r\n    // 2500 per rating up to 5, then 5000 per rating above 5\r\n    const rating = (this as any).rating || 0;\r\n    \r\n    let calculatedCost = 0;\r\n    if (rating <= 5) {\r\n      calculatedCost = rating * 2500;\r\n    } else {\r\n      // First 5 levels at 2500 each, remaining levels at 5000 each\r\n      calculatedCost = 5 * 2500 + (rating - 5) * 5000;\r\n    }\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Specialization items\r\n * A specialization is linked to a skill and costs 2500 yens\r\n */\r\nexport class SpecializationDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      linkedSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.SPECIALIZATIONS.LINKED_SKILL\"\r\n      }),\r\n      linkedAttribute: new fields.StringField({\r\n        required: true,\r\n        initial: \"strength\",\r\n        choices: {\r\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\r\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\r\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\r\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\r\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\r\n        },\r\n        label: \"SRA2.SPECIALIZATIONS.LINKED_ATTRIBUTE\"\r\n      }),\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Specializations have a fixed cost of 2500 yens\r\n    (this as any).calculatedCost = 2500;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Metatype items\r\n * Metatypes define maximum values for character attributes\r\n */\r\nexport class MetatypeDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      maxStrength: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_STRENGTH\"\r\n      }),\r\n      maxAgility: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_AGILITY\"\r\n      }),\r\n      maxWillpower: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_WILLPOWER\"\r\n      }),\r\n      maxLogic: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_LOGIC\"\r\n      }),\r\n      maxCharisma: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_CHARISMA\"\r\n      }),\r\n      anarchyBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.ANARCHY_BONUS\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Metatypes don't have a cost, they're character features\r\n    // No derived data needed for now\r\n  }\r\n}\r\n\r\n","/**\r\n * Custom Actor document for SRA2\r\n */\r\nexport class SRA2Actor<SubType extends Actor.SubType = Actor.SubType> extends Actor<SubType> {\r\n  get feats(): Item[] {\r\n    return this.items.filter((item: Item) => item.type === 'feat');\r\n  }\r\n}","/**\r\n * Shared Item Search Utilities for SRA2\r\n * This module contains common item search functions used across character sheets, NPC sheets, and item sheets.\r\n */\r\n\r\n/**\r\n * Normalize text for search: lowercase and remove accents/special characters\r\n */\r\nexport function normalizeSearchText(text: string): string {\r\n  if (!text) return '';\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    // remove (.*) in normalization\r\n    .replace(/ ?\\(.*\\)/g, '')\r\n    .replace(/[\\u0300-\\u036f]/g, ''); // Remove diacritics\r\n}\r\n\r\n/**\r\n * Check if an item matches the search term by searching in multiple fields\r\n */\r\nfunction itemMatchesSearch(item: any, itemType: string, searchTerm: string, includePackName: boolean = false, packTitle?: string): boolean {\r\n  // First check if item type matches\r\n  if (item.type !== itemType) return false;\r\n  \r\n  const normalizedSearch = normalizeSearchText(searchTerm);\r\n  \r\n  // Search in name\r\n  if (normalizeSearchText(item.name).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in weapon type (for weapons)\r\n  console.log(item.system?.weaponType);\r\n  const weaponType = item.system?.weaponType || item.system?.featType === 'weapon' ? item.system?.weaponType : null;\r\n  if (weaponType && normalizeSearchText(weaponType).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in description\r\n  const description = item.system?.description || '';\r\n  if (description && normalizeSearchText(description).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in linked attack skill\r\n  const linkedAttackSkill = item.system?.linkedAttackSkill || '';\r\n  if (linkedAttackSkill && normalizeSearchText(linkedAttackSkill).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in linked attack specialization\r\n  const linkedAttackSpecialization = item.system?.linkedAttackSpecialization || '';\r\n  if (linkedAttackSpecialization && normalizeSearchText(linkedAttackSpecialization).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in pack/repertoire name (only if requested)\r\n  if (includePackName && packTitle && normalizeSearchText(packTitle).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Search result interface\r\n */\r\nexport interface SearchResult {\r\n  name: string;\r\n  uuid: string;\r\n  source: string;\r\n  type: string;\r\n  id?: string;\r\n  alreadyExists?: boolean;\r\n}\r\n\r\n/**\r\n * Search for items in world items\r\n */\r\nexport function searchItemsInWorld(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): SearchResult[] {\r\n  const results: SearchResult[] = [];\r\n  \r\n  if (!game.items) return results;\r\n  \r\n  for (const item of game.items as any) {\r\n    if (itemMatchesSearch(item, itemType, searchTerm)) {\r\n      const alreadyExists = existingItemsCheck ? existingItemsCheck(item.name) : false;\r\n      \r\n      results.push({\r\n        name: item.name,\r\n        uuid: item.uuid,\r\n        id: item.id,\r\n        source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n        type: itemType,\r\n        alreadyExists\r\n      });\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Search for items in actor's items\r\n */\r\nexport function searchItemsOnActor(\r\n  actor: any,\r\n  itemType: string,\r\n  searchTerm: string\r\n): SearchResult[] {\r\n  const results: SearchResult[] = [];\r\n  \r\n  if (!actor) return results;\r\n  \r\n  for (const item of actor.items as any) {\r\n    if (itemMatchesSearch(item, itemType, searchTerm)) {\r\n      results.push({\r\n        name: item.name,\r\n        uuid: item.uuid,\r\n        id: item.id,\r\n        source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n        type: itemType\r\n      });\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Search for items in all compendiums\r\n */\r\nexport async function searchItemsInCompendiums(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): Promise<SearchResult[]> {\r\n  const results: SearchResult[] = [];\r\n  const seenNames = new Set<string>();\r\n  \r\n  // Search in all compendiums\r\n  for (const pack of game.packs as any) {\r\n    // Only search in Item compendiums\r\n    if (pack.documentName !== 'Item') continue;\r\n    \r\n    // Get all documents from the pack\r\n    const documents = await pack.getDocuments();\r\n    \r\n    // Filter for items that match the search term and type\r\n    for (const doc of documents) {\r\n      if (itemMatchesSearch(doc, itemType, searchTerm, true, pack.title)) {\r\n        // Check if not already in results (by name)\r\n        if (seenNames.has(doc.name)) continue;\r\n        seenNames.add(doc.name);\r\n        \r\n        const alreadyExists = existingItemsCheck ? existingItemsCheck(doc.name) : false;\r\n        \r\n        results.push({\r\n          name: doc.name,\r\n          uuid: doc.uuid,\r\n          source: pack.title,\r\n          type: itemType,\r\n          alreadyExists\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Perform a complete search across actor, world, and compendiums\r\n */\r\nexport async function searchItemsEverywhere(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  actor?: any,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): Promise<SearchResult[]> {\r\n  const results: SearchResult[] = [];\r\n  const seenNames = new Set<string>();\r\n  \r\n  // 1. Search in actor items if provided\r\n  if (actor) {\r\n    const actorResults = searchItemsOnActor(actor, itemType, searchTerm);\r\n    actorResults.forEach(result => {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    });\r\n  }\r\n  \r\n  // 2. Search in world items\r\n  const worldResults = searchItemsInWorld(itemType, searchTerm, existingItemsCheck);\r\n  worldResults.forEach(result => {\r\n    if (!seenNames.has(result.name)) {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    }\r\n  });\r\n  \r\n  // 3. Search in compendiums\r\n  const compendiumResults = await searchItemsInCompendiums(itemType, searchTerm, existingItemsCheck);\r\n  compendiumResults.forEach(result => {\r\n    if (!seenNames.has(result.name)) {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    }\r\n  });\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Build HTML for search results display\r\n */\r\nexport interface DisplaySearchResultsOptions {\r\n  results: SearchResult[];\r\n  lastSearchTerm: string;\r\n  noResultsMessage: string;\r\n  typeLabel: string;\r\n  onAddCallback?: (result: SearchResult) => void;\r\n}\r\n\r\nexport function buildSearchResultsHtml(options: DisplaySearchResultsOptions): string {\r\n  const { results, lastSearchTerm, noResultsMessage, typeLabel } = options;\r\n  \r\n  // Check if there's a perfect match (case-insensitive and accent-insensitive)\r\n  const normalizedLastSearch = normalizeSearchText(lastSearchTerm);\r\n  const exactMatch = results.find(r => normalizeSearchText(r.name) === normalizedLastSearch);\r\n  \r\n  let html = '';\r\n  \r\n  if (results.length === 0) {\r\n    html = `\r\n      <div class=\"search-result-item no-results\">\r\n        <div class=\"no-results-text\">\r\n          ${noResultsMessage}\r\n        </div>\r\n      </div>\r\n    `;\r\n  } else {\r\n    // If we have an exact match, highlight it at the top\r\n    if (exactMatch) {\r\n      html += buildSingleResultHtml(exactMatch, typeLabel, true);\r\n    }\r\n    \r\n    // Display other search results\r\n    const otherResults = exactMatch \r\n      ? results.filter(r => r.name !== exactMatch.name)\r\n      : results;\r\n    \r\n    for (const result of otherResults) {\r\n      html += buildSingleResultHtml(result, typeLabel, false);\r\n    }\r\n  }\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Build HTML for a single search result\r\n */\r\nfunction buildSingleResultHtml(result: SearchResult, typeLabel: string, isExactMatch: boolean): string {\r\n  const alreadyExistsClass = result.alreadyExists ? 'already-exists' : '';\r\n  const exactMatchClass = isExactMatch ? 'exact-match' : '';\r\n  \r\n  let html = `\r\n    <div class=\"search-result-item ${alreadyExistsClass} ${exactMatchClass}\" \r\n         data-result-name=\"${result.name}\" \r\n         data-result-uuid=\"${result.uuid}\">\r\n      <div class=\"result-info\">\r\n        <span class=\"result-name\">${result.name}</span>\r\n        <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\r\n      </div>\r\n  `;\r\n  \r\n  if (result.alreadyExists) {\r\n    html += `\r\n      <span class=\"already-exists-label\">\r\n        ${game.i18n!.localize('SRA2.SKILLS.ALREADY_EXISTS')}\r\n      </span>\r\n    `;\r\n  } else {\r\n    html += `\r\n      <button class=\"add-item-btn\" \r\n              data-item-name=\"${result.name}\" \r\n              data-item-uuid=\"${result.uuid}\">\r\n        ${game.i18n!.localize('SRA2.SKILLS.ADD')}\r\n      </button>\r\n    `;\r\n  }\r\n  \r\n  html += `</div>`;\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Create a debounced search function\r\n */\r\nexport function createDebouncedSearch(\r\n  searchFunction: (searchTerm: string) => Promise<void>,\r\n  delay: number = 300\r\n): (searchTerm: string) => void {\r\n  let timeoutId: any = null;\r\n  \r\n  return (searchTerm: string) => {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    \r\n    timeoutId = setTimeout(async () => {\r\n      await searchFunction(searchTerm);\r\n    }, delay);\r\n  };\r\n}\r\n\r\n/**\r\n * Show or hide search results container\r\n */\r\nexport function toggleSearchResults(resultsDiv: HTMLElement, show: boolean): void {\r\n  if (show) {\r\n    resultsDiv.style.display = 'block';\r\n  } else {\r\n    resultsDiv.style.display = 'none';\r\n  }\r\n}\r\n\r\n/**\r\n * Check if an item already exists on an actor\r\n */\r\nexport function itemExistsOnActor(actor: any, itemType: string, itemName: string): boolean {\r\n  if (!actor) return false;\r\n  \r\n  return actor.items.some((item: any) => \r\n    item.type === itemType && item.name === itemName\r\n  );\r\n}\r\n\r\n/**\r\n * Add an item to an actor from UUID\r\n */\r\nexport async function addItemToActorFromUuid(actor: any, itemUuid: string): Promise<boolean> {\r\n  try {\r\n    const item = await fromUuid(itemUuid as any);\r\n    if (!item) {\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ITEM_NOT_FOUND'));\r\n      return false;\r\n    }\r\n    \r\n    // Check if item already exists\r\n    if (itemExistsOnActor(actor, (item as any).type, (item as any).name)) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.ALREADY_EXISTS', { name: (item as any).name }));\r\n      return false;\r\n    }\r\n    \r\n    // Add the item to the actor\r\n    await actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n    ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.ADDED', { name: (item as any).name }));\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    console.error('SRA2 | Error adding item to actor:', error);\r\n    ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ERROR_ADDING'));\r\n    return false;\r\n  }\r\n}\r\n\r\n","/**\r\n * Shared Dice Rolling Utilities for SRA2\r\n * This module contains common dice rolling functions used across character sheets, NPC sheets, and item sheets.\r\n */\r\n\r\n// Roll is available globally in FoundryVTT\r\ndeclare const Roll: any;\r\ndeclare const renderTemplate: any;\r\ndeclare const ChatMessage: any;\r\n\r\n// Import ItemSearch for text normalization\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * RR source information\r\n */\r\nexport interface RRSource {\r\n  featName: string;\r\n  rrValue: number;\r\n}\r\n\r\n/**\r\n * Risk reduction constants\r\n */\r\nexport const RISK_DICE_BY_RR = [2, 5, 8, 12];\r\n\r\nexport const RISK_THRESHOLDS = {\r\n  0: { normal: 2, fort: 4, extreme: 6 },\r\n  1: { normal: 5, fort: 7, extreme: 9 },\r\n  2: { normal: 8, fort: 11, extreme: 13 },\r\n  3: { normal: 12, fort: 15, extreme: 999 }\r\n};\r\n\r\n/**\r\n * Get risk dice count based on RR level\r\n */\r\nexport function getRiskDiceByRR(rr: number): number {\r\n  return RISK_DICE_BY_RR[Math.min(3, Math.max(0, rr))] || 2;\r\n}\r\n\r\n/**\r\n * Get RR sources from an actor for a specific item type and name\r\n * This is the main function used by most sheets for their own actor\r\n */\r\nexport function getRRSources(\r\n  actor: any,\r\n  itemType: 'skill' | 'specialization' | 'attribute',\r\n  itemName: string\r\n): RRSource[] {\r\n  const sources: RRSource[] = [];\r\n  \r\n  // Get all active feats from the actor\r\n  const feats = actor.items.filter((item: any) => \r\n    item.type === 'feat' && \r\n    item.system.active === true\r\n  );\r\n  \r\n  // Calculate RR from feats that target this item\r\n  for (const feat of feats) {\r\n    const featSystem = feat.system as any;\r\n    const rrList = featSystem.rrList || [];\r\n    \r\n    // Loop through all RR entries in this feat\r\n    for (const rrEntry of rrList) {\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      // Check if this RR entry provides RR for the given item\r\n      if (rrType === itemType && rrTarget === itemName && rrValue > 0) {\r\n        sources.push({\r\n          featName: feat.name,\r\n          rrValue: rrValue\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return sources;\r\n}\r\n\r\n/**\r\n * Get RR sources from any actor for a specific item type and name\r\n * This is useful for defense rolls where we need to check another actor's RR\r\n * (identical to getRRSources but kept separate for clarity in combat scenarios)\r\n */\r\nexport function getRRSourcesForActor(\r\n  actor: any,\r\n  itemType: 'skill' | 'specialization' | 'attribute',\r\n  itemName: string\r\n): RRSource[] {\r\n  return getRRSources(actor, itemType, itemName);\r\n}\r\n\r\n/**\r\n * Get success threshold based on roll mode\r\n */\r\nexport function getSuccessThreshold(mode: string): number {\r\n  switch (mode) {\r\n    case 'advantage': return 4;  // 4, 5, 6 = success\r\n    case 'disadvantage': return 6; // only 6 = success\r\n    default: return 5;  // 5, 6 = success\r\n  }\r\n}\r\n\r\n/**\r\n * Build RR sources HTML for dialog\r\n */\r\nexport function buildRRSourcesHtml(rrSources: RRSource[]): string {\r\n  if (rrSources.length === 0) return '';\r\n  \r\n  let html = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\r\n  rrSources.forEach((source) => {\r\n    html += `\r\n      <label class=\"rr-source-item\">\r\n        <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\r\n        <span>${source.featName} (+${source.rrValue})</span>\r\n      </label>`;\r\n  });\r\n  html += '</div>';\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Roll Request Data Interface\r\n * Contains all information needed for a roll request\r\n */\r\nexport interface RollRequestData {\r\n  // Item information\r\n  itemType?: string;\r\n  weaponType?: string;\r\n  itemName?: string;\r\n  itemId?: string;\r\n  itemRating?: number;\r\n  itemActive?: boolean;\r\n  \r\n  // Linked skills (merged from weapon types and custom fields)\r\n  linkedAttackSkill?: string;\r\n  linkedAttackSpecialization?: string;\r\n  linkedDefenseSkill?: string;\r\n  linkedDefenseSpecialization?: string;\r\n  linkedAttribute?: string;\r\n  \r\n  // Weapon properties\r\n  isWeaponFocus?: boolean;\r\n  damageValue?: string;  // FINAL damage value (base + bonus)\r\n  damageValueBonus?: number;  // Bonus from feat\r\n  meleeRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\r\n  shortRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\r\n  mediumRange?: string; // \"none\" | \"ok\" | \"disadvantage\"\r\n  longRange?: string;   // \"none\" | \"ok\" | \"disadvantage\"\r\n  \r\n  // Skill/Spec information (undefined if not found)\r\n  skillName?: string;\r\n  specName?: string;\r\n  skillLevel?: number;\r\n  specLevel?: number;\r\n  \r\n  // Defense Skill/Spec information (for defense rolls)\r\n  defenseSkillName?: string;\r\n  defenseSpecName?: string;\r\n  defenseSkillLevel?: number;\r\n  defenseSpecLevel?: number;\r\n  defenseLinkedAttribute?: string;\r\n  \r\n  // NPC threshold (when not rolling dice)\r\n  threshold?: number;\r\n  \r\n  // Actor information\r\n  actorId?: string;\r\n  actorUuid?: string;\r\n  actorName?: string;\r\n  \r\n  // Token information\r\n  attackerTokenUuid?: string;\r\n  defenderTokenUuid?: string;\r\n  \r\n  // RR List\r\n  rrList?: any[];\r\n  \r\n  // Risk dice count (number of risk dice selected)\r\n  riskDiceCount?: number;\r\n  \r\n  // Final calculated values\r\n  finalRR?: number;\r\n  dicePool?: number;\r\n  \r\n  // Roll mode\r\n  rollMode?: 'normal' | 'disadvantage' | 'advantage';\r\n  \r\n  // Defense/Counter-attack flags\r\n  isDefend?: boolean;\r\n  isCounterAttack?: boolean;\r\n  \r\n  // Spell-specific properties\r\n  spellType?: 'direct' | 'indirect';  // For spells: 'direct' or 'indirect'\r\n  isSpellDirect?: boolean;  // Flag for direct spells (no defense allowed)\r\n  \r\n  // Attack roll data (for defense/counter-attack rolls)\r\n  attackRollResult?: RollResult;\r\n  attackRollData?: RollRequestData;\r\n  availableWeapons?: Array<{\r\n    id: string;\r\n    name: string;\r\n    linkedAttackSkill: string;\r\n    damageValue: string;\r\n    damageValueBonus: number;\r\n    weaponType?: string;\r\n    meleeRange?: string;\r\n  }>;\r\n  selectedWeaponId?: string; // ID of selected weapon for counter-attack\r\n}\r\n\r\n/**\r\n * Handle roll request - central function for all roll clicks\r\n * Displays a roll dialog with roll information\r\n */\r\nexport function handleRollRequest(data: RollRequestData): void {\r\n  console.log('=== ROLL REQUEST ===', {\r\n    itemType: data.itemType,\r\n    weaponType: data.weaponType,\r\n    linkedAttackSkill: data.linkedAttackSkill,\r\n    linkedAttackSpecialization: data.linkedAttackSpecialization,\r\n    linkedDefenseSkill: data.linkedDefenseSkill,\r\n    linkedDefenseSpecialization: data.linkedDefenseSpecialization,\r\n    linkedAttribute: data.linkedAttribute,\r\n    isWeaponFocus: data.isWeaponFocus,\r\n    damageValue: data.damageValue,\r\n    damageValueBonus: data.damageValueBonus,\r\n    meleeRange: data.meleeRange,\r\n    shortRange: data.shortRange,\r\n    mediumRange: data.mediumRange,\r\n    longRange: data.longRange,\r\n    skillName: data.skillName,\r\n    specName: data.specName,\r\n    itemName: data.itemName,\r\n    itemId: data.itemId,\r\n    threshold: data.threshold,\r\n    actorId: data.actorId,\r\n    actorUuid: data.actorUuid,\r\n    actorName: data.actorName,\r\n    specLevel: data.specLevel,\r\n    skillLevel: data.skillLevel,\r\n    itemRating: data.itemRating,\r\n    itemActive: data.itemActive,\r\n    rrList: data.rrList\r\n  });\r\n\r\n  // Import RollDialog dynamically to avoid circular dependencies\r\n  import('../applications/roll-dialog.js').then((module) => {\r\n    const dialog = new module.RollDialog(data);\r\n    dialog.render(true);\r\n  });\r\n}\r\n\r\n/**\r\n * Roll result interface\r\n */\r\nexport interface RollResult {\r\n  normalDice: number[];\r\n  riskDice: number[];\r\n  normalSuccesses: number;\r\n  riskSuccesses: number;\r\n  totalSuccesses: number;\r\n  criticalFailures: number;\r\n  finalRR: number;\r\n  remainingFailures: number;\r\n  complication: 'none' | 'minor' | 'critical' | 'disaster';\r\n}\r\n\r\n/**\r\n * Execute a dice roll with DiceSoNice support\r\n * Steps 2-5: Roll dice, calculate results, complications, and create chat message\r\n */\r\nexport async function executeRoll(\r\n  attacker: any,\r\n  defender: any,\r\n  attackerToken: any,\r\n  defenderToken: any,\r\n  rollData: RollRequestData\r\n): Promise<void> {\r\n  if (!attacker) {\r\n    console.error('No attacker provided for roll');\r\n    return;\r\n  }\r\n\r\n  // Log token information\r\n  console.log('=== EXECUTE ROLL ===');\r\n  console.log('Attacker:', attacker?.name || 'Unknown');\r\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\r\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n  console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || rollData.attackerTokenUuid || 'Unknown');\r\n  if (attackerToken?.actor) {\r\n    console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n  }\r\n  console.log('Defender:', defender?.name || 'None');\r\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\r\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n  console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || rollData.defenderTokenUuid || 'Unknown');\r\n  if (defenderToken?.actor) {\r\n    console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n  }\r\n  console.log('===================');\r\n\r\n  const dicePool = rollData.dicePool || 0;\r\n  const riskDiceCount = rollData.riskDiceCount || 0;\r\n  const normalDiceCount = Math.max(0, dicePool - riskDiceCount);\r\n  const rollMode = rollData.rollMode || 'normal';\r\n  const finalRR = Math.min(3, rollData.finalRR || 0);\r\n  const threshold = rollData.threshold;\r\n\r\n  // If threshold is defined, use it instead of rolling dice\r\n  let rollResult: RollResult;\r\n  if (threshold !== undefined) {\r\n    // Apply threshold: number of successes equals threshold\r\n    rollResult = {\r\n      normalDice: [],\r\n      riskDice: [],\r\n      normalSuccesses: threshold,\r\n      riskSuccesses: 0,\r\n      totalSuccesses: threshold,\r\n      criticalFailures: 0,\r\n      finalRR: finalRR,\r\n      remainingFailures: 0,\r\n      complication: 'none'\r\n    };\r\n  } else {\r\n  // Step 2: Create and roll dice\r\n  let normalRoll: any = null;\r\n  let riskRoll: any = null;\r\n\r\n  // Roll normal dice\r\n  if (normalDiceCount > 0) {\r\n    normalRoll = new Roll(`${normalDiceCount}d6`);\r\n    await normalRoll.evaluate();\r\n    \r\n    // Show DiceSoNice animation for normal dice\r\n    if ((game as any).dice3d && normalRoll) {\r\n      (game as any).dice3d.showForRoll(normalRoll, game.user, true, null, false);\r\n    }\r\n  }\r\n\r\n  // Roll risk dice with purple color\r\n  if (riskDiceCount > 0) {\r\n    riskRoll = new Roll(`${riskDiceCount}d6`);\r\n    await riskRoll.evaluate();\r\n    \r\n    // Show DiceSoNice animation for risk dice with purple color\r\n    if ((game as any).dice3d && riskRoll) {\r\n      const dice3dConfig = {\r\n        colorset: 'purple',\r\n        theme: 'default'\r\n      };\r\n      (game as any).dice3d.showForRoll(riskRoll, game.user, true, dice3dConfig, false);\r\n    }\r\n  }\r\n\r\n  // Step 3: Calculate results\r\n  const normalResults: number[] = normalRoll ? (normalRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n  const riskResults: number[] = riskRoll ? (riskRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n  \r\n  // Calculate successes for normal dice\r\n  let normalSuccesses = 0;\r\n  for (const result of normalResults) {\r\n    if (rollMode === 'advantage' && result >= 4) {\r\n      normalSuccesses++;\r\n    } else if (rollMode === 'disadvantage' && result === 6) {\r\n      normalSuccesses++;\r\n    } else if (rollMode === 'normal' && result >= 5) {\r\n      normalSuccesses++;\r\n    }\r\n  }\r\n\r\n  // Calculate successes and critical failures for risk dice\r\n  let riskSuccesses = 0;\r\n  let criticalFailures = 0;\r\n  for (const result of riskResults) {\r\n    if (result === 1) {\r\n      criticalFailures++;\r\n    } else if (rollMode === 'advantage' && result >= 4) {\r\n      riskSuccesses++;\r\n    } else if (rollMode === 'disadvantage' && result === 6) {\r\n      riskSuccesses++;\r\n    } else if (rollMode === 'normal' && result >= 5) {\r\n      riskSuccesses++;\r\n    }\r\n  }\r\n\r\n  // Risk dice successes count double\r\n  const totalRiskSuccesses = riskSuccesses * 2;\r\n  const totalSuccesses = normalSuccesses + totalRiskSuccesses;\r\n\r\n  // Step 4: Calculate complications\r\n  const remainingFailures = Math.max(0, criticalFailures - finalRR);\r\n  \r\n  let complication: 'none' | 'minor' | 'critical' | 'disaster' = 'none';\r\n  if (remainingFailures === 1) {\r\n    complication = 'minor';\r\n  } else if (remainingFailures === 2) {\r\n    complication = 'critical';\r\n  } else if (remainingFailures >= 3) {\r\n    complication = 'disaster';\r\n  }\r\n\r\n    rollResult = {\r\n    normalDice: normalResults,\r\n    riskDice: riskResults,\r\n    normalSuccesses: normalSuccesses,\r\n    riskSuccesses: riskSuccesses,\r\n    totalSuccesses: totalSuccesses,\r\n    criticalFailures: criticalFailures,\r\n    finalRR: finalRR,\r\n    remainingFailures: remainingFailures,\r\n    complication: complication\r\n  };\r\n  }\r\n\r\n  // Step 5: Create chat message\r\n  await createRollChatMessage(attacker, defender, attackerToken, defenderToken, rollData, rollResult);\r\n}\r\n\r\n/**\r\n * Create chat message for roll result\r\n * Step 5: Display roll results in chat\r\n */\r\nasync function createRollChatMessage(\r\n  attacker: any,\r\n  defender: any,\r\n  attackerToken: any,\r\n  defenderToken: any,\r\n  rollData: RollRequestData,\r\n  rollResult: RollResult\r\n): Promise<void> {\r\n  // Determine if this is an attack\r\n  const isAttack = rollData.itemType === 'weapon' || \r\n                   rollData.weaponType !== undefined ||\r\n                   (rollData.meleeRange || rollData.shortRange || rollData.mediumRange || rollData.longRange);\r\n\r\n  // Log token information\r\n  console.log('=== CREATE ROLL CHAT MESSAGE ===');\r\n  console.log('Attacker:', attacker?.name || 'Unknown');\r\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\r\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n  \r\n  // Get attacker token UUID (priority: token > rollData)\r\n  let attackerTokenUuid: string | undefined = undefined;\r\n  if (attackerToken) {\r\n    attackerTokenUuid = attackerToken.uuid || attackerToken.document?.uuid || undefined;\r\n    console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\r\n    // If token exists, use token's actor UUID (for NPCs)\r\n    if (attackerToken.actor) {\r\n      console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n    }\r\n  } else if (rollData.attackerTokenUuid) {\r\n    attackerTokenUuid = rollData.attackerTokenUuid;\r\n    console.log('Attacker Token UUID (from rollData):', attackerTokenUuid);\r\n  }\r\n  \r\n  // Determine final attacker UUID: if token exists, use token's actor UUID, otherwise use actor UUID\r\n  const finalAttackerUuid = attackerToken?.actor?.uuid || attacker?.uuid;\r\n  console.log('Final Attacker UUID (token actor or actor):', finalAttackerUuid || 'Unknown');\r\n  \r\n  console.log('Defender:', defender?.name || 'None');\r\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\r\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n  \r\n  // Get defender token UUID (priority: token > rollData)\r\n  let defenderTokenUuid: string | undefined = undefined;\r\n  if (defenderToken) {\r\n    defenderTokenUuid = defenderToken.uuid || defenderToken.document?.uuid || undefined;\r\n    console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\r\n    // If token exists, use token's actor UUID (for NPCs)\r\n    if (defenderToken.actor) {\r\n      console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n    }\r\n  } else if (rollData.defenderTokenUuid) {\r\n    defenderTokenUuid = rollData.defenderTokenUuid;\r\n    console.log('Defender Token UUID (from rollData):', defenderTokenUuid);\r\n  }\r\n  \r\n  // Determine final defender UUID: if token exists, use token's actor UUID, otherwise use actor UUID\r\n  const finalDefenderUuid = defenderToken?.actor?.uuid || defender?.uuid;\r\n  console.log('Final Defender UUID (token actor or actor):', finalDefenderUuid || 'Unknown');\r\n  console.log('--- UUIDs to be stored in flags ---');\r\n  console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\r\n  console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\r\n  console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\r\n  console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\r\n  console.log('================================');\r\n\r\n  // Prepare defender data with token image if available\r\n  let defenderData: any = null;\r\n  if (defender) {\r\n    // Get token image - try different ways to access it depending on Foundry version\r\n    let tokenImg = defender.img; // fallback to actor image\r\n    if (defenderToken) {\r\n      // FoundryVTT v13: token.document.texture.src or token.document.img\r\n      tokenImg = (defenderToken as any).document?.texture?.src || \r\n                 (defenderToken as any).document?.img || \r\n                 (defenderToken as any).data?.img || \r\n                 (defenderToken as any).texture?.src ||\r\n                 defender.img;\r\n    }\r\n    \r\n    defenderData = {\r\n      ...defender,\r\n      img: tokenImg\r\n    };\r\n  }\r\n\r\n  // Handle defense/counter-attack rolls\r\n  let defenseResult: any = null;\r\n  let calculatedDamage: number | null = null;\r\n  let attackFailed: boolean = false;\r\n  \r\n  if (rollData.isDefend && rollData.attackRollResult && rollData.attackRollData) {\r\n    // Defense roll: compare with attack\r\n    // For defense: attacker = defender (one defending), defender = original attacker\r\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\r\n    const defenseSuccesses = rollResult.totalSuccesses;\r\n    \r\n    // Check if this is an ICE attack\r\n    const isIceAttack = rollData.attackRollData.itemType === 'ice-attack' || rollData.attackRollData.iceType;\r\n    const iceType = rollData.attackRollData.iceType;\r\n    \r\n    // Get actor names (use token name if available, otherwise actor name)\r\n    const originalAttackerName = defenderToken?.name || defender?.name || 'Inconnu';\r\n    const defenderName = attackerToken?.name || attacker?.name || 'Inconnu';\r\n    \r\n    if (attackSuccesses >= defenseSuccesses) {\r\n      // Attack succeeds\r\n      if (isIceAttack) {\r\n        // For ICE attacks, calculate damage based on type\r\n        let damageValue = 0;\r\n        const iceDamageValue = rollData.attackRollData.iceDamageValue || 0;\r\n        \r\n        // ICE damage calculation: VD + (succès ICE - succès défense)\r\n        // But for some ICE types, there's no damage, only effects\r\n        if (iceType === 'blaster' || iceType === 'black' || iceType === 'killer') {\r\n          damageValue = iceDamageValue + attackSuccesses - defenseSuccesses;\r\n        }\r\n        // Other ICE types (acid, blocker, glue, tracker) don't deal damage\r\n        \r\n        calculatedDamage = damageValue;\r\n        attackFailed = false;\r\n      } else {\r\n        // Normal attack damage calculation\r\n        let damageValue = 0;\r\n        const damageValueStr = rollData.attackRollData.damageValue || '0';\r\n        \r\n        // Handle \"FOR\" or \"FOR+X\" damage values\r\n        if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\r\n          // Get original attacker's strength (defender in defense context is the original attacker)\r\n          const attackerStrength = (defender?.system as any)?.attributes?.strength || 1;\r\n          if (damageValueStr === 'FOR') {\r\n            damageValue = attackerStrength;\r\n          } else if (damageValueStr.startsWith('FOR+')) {\r\n            const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n            damageValue = attackerStrength + bonus;\r\n          }\r\n        } else {\r\n          damageValue = parseInt(damageValueStr, 10) || 0;\r\n        }\r\n        \r\n        calculatedDamage = damageValue + attackSuccesses - defenseSuccesses;\r\n        attackFailed = false;\r\n      }\r\n    } else {\r\n      // Attack fails\r\n      attackFailed = true;\r\n      calculatedDamage = 0;\r\n    }\r\n    \r\n    // For defense: attacker = defender (one defending), defender = original attacker\r\n    // If attack succeeds, original attacker (defender in context) inflicts damage to defender (attacker in context)\r\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in defense context\r\n    const defenderUuid = finalAttackerUuid; // Defender is attacker in defense context\r\n    \r\n    console.log('Defense: Attack succeeds - original attacker inflicts damage to defender');\r\n    console.log('  Original attacker (inflicter):', originalAttackerName, '(', originalAttackerUuid, ')');\r\n    console.log('  Defender (receiver):', defenderName, '(', defenderUuid, ')');\r\n    \r\n    defenseResult = {\r\n      attackSuccesses: attackSuccesses,\r\n      defenseSuccesses: defenseSuccesses,\r\n      calculatedDamage: calculatedDamage,\r\n      attackFailed: attackFailed,\r\n      originalAttackerName: originalAttackerName,\r\n      defenderName: defenderName,\r\n      // UUIDs for applying damage\r\n      originalAttackerUuid: originalAttackerUuid, // Who inflicts damage if attack succeeds\r\n      defenderUuid: defenderUuid, // Who receives damage if attack succeeds\r\n      // ICE-specific fields\r\n      isIceAttack: isIceAttack,\r\n      iceType: iceType\r\n    };\r\n  } else if (rollData.isCounterAttack && rollData.attackRollResult && rollData.attackRollData) {\r\n    // Counter-attack: compare with original attack\r\n    // In counter-attack context:\r\n    // - attacker = original defender (the one doing counter-attack)\r\n    // - defender = original attacker (the one being counter-attacked)\r\n    \r\n    // Get actor names (use token name if available, otherwise actor name)\r\n    // For original attacker (defender in counter-attack context)\r\n    // Try: token.document.name, token.name, token.actor.name, actor.name\r\n    const originalAttackerName = defenderToken?.document?.name || \r\n                                  (defenderToken as any)?.name || \r\n                                  defenderToken?.actor?.name || \r\n                                  defender?.name || \r\n                                  'Inconnu';\r\n    // For original defender/counter-attacker (attacker in counter-attack context)\r\n    const originalDefenderName = attackerToken?.document?.name || \r\n                                  (attackerToken as any)?.name || \r\n                                  attackerToken?.actor?.name || \r\n                                  attacker?.name || \r\n                                  'Inconnu';\r\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\r\n    const counterAttackSuccesses = rollResult.totalSuccesses;\r\n    \r\n    // Get damage values for the original attacker\r\n    // damageValue already includes bonus (finalDamageValue)\r\n    let attackDamageValue = 0;\r\n    const attackDamageValueStr = rollData.attackRollData.damageValue || '0';\r\n    \r\n    // Handle \"FOR\" or \"FOR+X\" damage values for the attacker (defender in counter-attack context)\r\n    if (attackDamageValueStr === 'FOR' || attackDamageValueStr.startsWith('FOR+')) {\r\n      const attackerStrength = (defender?.system as any)?.attributes?.strength || 1; // defender = original attacker\r\n      if (attackDamageValueStr === 'FOR') {\r\n        attackDamageValue = attackerStrength;\r\n      } else if (attackDamageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(attackDamageValueStr.substring(4)) || 0;\r\n        attackDamageValue = attackerStrength + bonus;\r\n      }\r\n    } else {\r\n      attackDamageValue = parseInt(attackDamageValueStr, 10) || 0;\r\n    }\r\n    \r\n    // Get counter-attack damage value from rollData\r\n    // rollData.damageValue should already be set from the selected weapon (includes bonus)\r\n    let counterAttackDamageValue = 0;\r\n    const damageValueStr = rollData.damageValue || '0';\r\n    \r\n    // Handle \"FOR\" or \"FOR+X\" damage values\r\n    if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\r\n      const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\r\n      if (damageValueStr === 'FOR') {\r\n        counterAttackDamageValue = actorStrength;\r\n      } else if (damageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n        counterAttackDamageValue = actorStrength + bonus;\r\n      }\r\n    } else {\r\n      counterAttackDamageValue = parseInt(damageValueStr, 10) || 0;\r\n    }\r\n    \r\n    // If still no damage value, try to find weapon (fallback)\r\n    if (!counterAttackDamageValue && attacker) {\r\n      // Find weapon matching the counter-attack skill/item\r\n      const selectedWeaponId = (rollData as any).selectedWeaponId;\r\n      if (selectedWeaponId) {\r\n          const weapon = attacker.items.find((item: any) => item.id === selectedWeaponId);\r\n          if (weapon) {\r\n            const weaponSystem = weapon.system as any;\r\n            // Calculate finalDamageValue from weapon (same logic as character-sheet.ts)\r\n            const baseDamageValue = weaponSystem.damageValue || '0';\r\n            const damageValueBonus = weaponSystem.damageValueBonus || 0;\r\n            let weaponDamageValueStr = baseDamageValue;\r\n            \r\n            if (damageValueBonus > 0 && baseDamageValue !== '0') {\r\n              if (baseDamageValue === 'FOR') {\r\n                weaponDamageValueStr = `FOR+${damageValueBonus}`;\r\n              } else if (baseDamageValue.startsWith('FOR+')) {\r\n                const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\r\n                weaponDamageValueStr = `FOR+${baseModifier + damageValueBonus}`;\r\n              } else if (baseDamageValue !== 'toxin') {\r\n                const baseValue = parseInt(baseDamageValue) || 0;\r\n                weaponDamageValueStr = (baseValue + damageValueBonus).toString();\r\n              }\r\n            }\r\n            \r\n            if (weaponDamageValueStr === 'FOR' || weaponDamageValueStr.startsWith('FOR+')) {\r\n              const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\r\n              if (weaponDamageValueStr === 'FOR') {\r\n                counterAttackDamageValue = actorStrength;\r\n              } else if (weaponDamageValueStr.startsWith('FOR+')) {\r\n                const bonus = parseInt(weaponDamageValueStr.substring(4)) || 0;\r\n                counterAttackDamageValue = actorStrength + bonus;\r\n              }\r\n            } else {\r\n              counterAttackDamageValue = parseInt(weaponDamageValueStr, 10) || 0;\r\n            }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Determine winner and calculate damage\r\n    let attackerDamage = 0;\r\n    let defenderDamage = 0;\r\n    let isTie = false;\r\n    let winner: 'attacker' | 'defender' | 'tie' = 'tie';\r\n    \r\n    if (attackSuccesses > counterAttackSuccesses) {\r\n      // Attacker wins\r\n      winner = 'attacker';\r\n      attackerDamage = attackDamageValue + attackSuccesses - counterAttackSuccesses;\r\n    } else if (counterAttackSuccesses > attackSuccesses) {\r\n      // Defender (counter-attacker) wins\r\n      winner = 'defender';\r\n      defenderDamage = counterAttackDamageValue + counterAttackSuccesses - attackSuccesses;\r\n    } else {\r\n      // Tie\r\n      isTie = true;\r\n      winner = 'tie';\r\n    }\r\n    \r\n    console.log('=== COUNTER-ATTACK RESULTS ===');\r\n    console.log('Attack Successes:', attackSuccesses);\r\n    console.log('Counter-Attack Successes:', counterAttackSuccesses);\r\n    console.log('Attack Damage Value:', attackDamageValue);\r\n    console.log('Counter-Attack Damage Value:', counterAttackDamageValue);\r\n    console.log('Winner:', winner);\r\n    console.log('Attacker Damage:', attackerDamage);\r\n    console.log('Defender Damage:', defenderDamage);\r\n    console.log('Original Attacker Name:', originalAttackerName);\r\n    console.log('Original Defender Name:', originalDefenderName);\r\n    console.log('--- Context ---');\r\n    console.log('Attacker param:', attacker?.name);\r\n    console.log('Defender param:', defender?.name);\r\n    console.log('AttackerToken object:', attackerToken ? 'Found' : 'Not found');\r\n    console.log('AttackerToken.name:', (attackerToken as any)?.name);\r\n    console.log('AttackerToken.document?.name:', attackerToken?.document?.name);\r\n    console.log('AttackerToken.actor?.name:', attackerToken?.actor?.name);\r\n    console.log('DefenderToken object:', defenderToken ? 'Found' : 'Not found');\r\n    console.log('DefenderToken.name:', (defenderToken as any)?.name);\r\n    console.log('DefenderToken.document?.name:', defenderToken?.document?.name);\r\n    console.log('DefenderToken.actor?.name:', defenderToken?.actor?.name);\r\n    console.log('--- UUIDs to be stored in flags ---');\r\n    console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\r\n    console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\r\n    console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\r\n    console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\r\n    console.log('==============================');\r\n    \r\n    // For counter-attack: attacker = counter-attacker (original defender), defender = original attacker\r\n    // Winner is determined by who has more successes\r\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in counter-attack context\r\n    const originalDefenderUuid = finalAttackerUuid; // Original defender/counter-attacker is attacker in counter-attack context\r\n    \r\n    // Determine who inflicts damage based on winner\r\n    let damageInflicterUuid: string | undefined = undefined;\r\n    let damageReceiverUuid: string | undefined = undefined;\r\n    let damageInflicterName: string = '';\r\n    let damageReceiverName: string = '';\r\n    \r\n    if (winner === 'attacker') {\r\n      // Original attacker wins (attackSuccesses > counterAttackSuccesses)\r\n      // Original attacker inflicts damage to counter-attacker\r\n      damageInflicterUuid = originalAttackerUuid;\r\n      damageReceiverUuid = originalDefenderUuid;\r\n      damageInflicterName = originalAttackerName;\r\n      damageReceiverName = originalDefenderName;\r\n      console.log('Counter-attack: Original attacker wins - inflicts damage to counter-attacker');\r\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\r\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\r\n    } else if (winner === 'defender') {\r\n      // Counter-attacker wins (counterAttackSuccesses > attackSuccesses)\r\n      // Counter-attacker inflicts damage to original attacker\r\n      damageInflicterUuid = originalDefenderUuid;\r\n      damageReceiverUuid = originalAttackerUuid;\r\n      damageInflicterName = originalDefenderName;\r\n      damageReceiverName = originalAttackerName;\r\n      console.log('Counter-attack: Counter-attacker wins - inflicts damage to original attacker');\r\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\r\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\r\n    }\r\n    \r\n    defenseResult = {\r\n      attackSuccesses: attackSuccesses,\r\n      counterAttackSuccesses: counterAttackSuccesses,\r\n      winner: winner,\r\n      attackerDamage: attackerDamage,\r\n      defenderDamage: defenderDamage,\r\n      isTie: isTie,\r\n      originalAttackerName: originalAttackerName,\r\n      originalDefenderName: originalDefenderName,\r\n      // UUIDs for applying damage\r\n      originalAttackerUuid: originalAttackerUuid,\r\n      originalDefenderUuid: originalDefenderUuid,\r\n      damageInflicterUuid: damageInflicterUuid,\r\n      damageReceiverUuid: damageReceiverUuid,\r\n      damageInflicterName: damageInflicterName,\r\n      damageReceiverName: damageReceiverName\r\n    };\r\n  }\r\n\r\n  // Prepare template data\r\n  // Create attacker and defender objects with correct UUIDs (token actor UUID for NPCs)\r\n  const attackerWithUuid = attacker ? {\r\n    ...attacker,\r\n    uuid: finalAttackerUuid || attacker.uuid // Use calculated UUID (token actor UUID for NPCs)\r\n  } : null;\r\n  \r\n  const defenderWithUuid = defenderData ? {\r\n    ...defenderData,\r\n    uuid: finalDefenderUuid || defenderData.uuid // Use calculated UUID (token actor UUID for NPCs)\r\n  } : null;\r\n  \r\n  const templateData: any = {\r\n    attacker: attackerWithUuid,\r\n    defender: defenderWithUuid,\r\n    rollData: rollData,\r\n    rollResult: rollResult,\r\n    isAttack: isAttack,\r\n    isDefend: rollData.isDefend || false,\r\n    isCounterAttack: rollData.isCounterAttack || false,\r\n    skillName: rollData.specName || rollData.skillName || rollData.linkedAttackSkill || 'Unknown',\r\n    itemName: rollData.itemName,\r\n    damageValue: rollData.damageValue,\r\n    defenseResult: defenseResult,\r\n    // Also pass UUIDs directly for template convenience\r\n    attackerUuid: finalAttackerUuid,\r\n    defenderUuid: finalDefenderUuid,\r\n    attackerTokenUuid: attackerTokenUuid,\r\n    defenderTokenUuid: defenderTokenUuid,\r\n    // Spell-specific flags\r\n    isSpellDirect: rollData.isSpellDirect || false\r\n  };\r\n\r\n  // Render template\r\n  const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n\r\n  // Create chat message\r\n  const messageData: any = {\r\n    user: game.user?.id,\r\n    speaker: {\r\n      actor: attacker?.id,\r\n      alias: attacker?.name\r\n    },\r\n    content: html,\r\n    type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n    flags: {\r\n      sra2: {\r\n        rollType: isAttack ? 'attack' : 'skill',\r\n        attackerId: attacker?.id,\r\n        attackerUuid: finalAttackerUuid, // Use token's actor UUID if token exists, otherwise actor UUID\r\n        attackerTokenUuid: attackerTokenUuid, // Store token UUID\r\n        defenderId: defender?.id,\r\n        defenderUuid: finalDefenderUuid, // Use token's actor UUID if token exists, otherwise actor UUID\r\n        defenderTokenUuid: defenderTokenUuid, // Store token UUID\r\n        rollResult: rollResult,\r\n        rollData: rollData\r\n      }\r\n    }\r\n  };\r\n\r\n  await ChatMessage.create(messageData);\r\n  \r\n  // Handle drain for Sorcery and Conjuration tests\r\n  await handleDrain(attacker, rollData, rollResult);\r\n}\r\n\r\n/**\r\n * Handle drain effects for Sorcery and Conjuration tests\r\n * Applies drain effects based on complications\r\n */\r\nasync function handleDrain(\r\n  actor: any,\r\n  rollData: RollRequestData,\r\n  rollResult: RollResult\r\n): Promise<void> {\r\n  if (!actor || !rollData || !rollResult) {\r\n    return;\r\n  }\r\n\r\n  // Check if this is a spell (spells always use Sorcery, even with specializations like \"Spé: Sorts de combat\")\r\n  const isSpell = rollData.itemType === 'spell' || rollData.itemType === 'weapon-spell';\r\n  \r\n  // Check if this is a Sorcery or Conjuration test\r\n  // Priority: linkedAttackSkill (for spells/weapons) > skillName (for specializations) > specName (fallback)\r\n  let skillName = rollData.linkedAttackSkill || rollData.skillName || rollData.specName || '';\r\n  let normalizedSkillName = ItemSearch.normalizeSearchText(skillName);\r\n  \r\n  // If it's a spell, it's always Sorcery (regardless of specialization like \"Spé: Sorts de combat\")\r\n  // Also check linkedAttackSkill in case it's explicitly set to Sorcery\r\n  if (isSpell || ItemSearch.normalizeSearchText(rollData.linkedAttackSkill || '') === 'sorcellerie') {\r\n    normalizedSkillName = 'sorcellerie';\r\n  } else if (rollData.itemType === 'specialization') {\r\n    // For specialization rolls, check skillName first (should be set from linkedSkill)\r\n    // If not found, try to find the linked skill from the specialization item\r\n    if (!normalizedSkillName || (normalizedSkillName !== 'sorcellerie' && normalizedSkillName !== 'conjuration')) {\r\n      if (rollData.itemId && actor) {\r\n        const specItem = actor.items.find((item: any) => item.id === rollData.itemId);\r\n        if (specItem && specItem.type === 'specialization') {\r\n          const specSystem = specItem.system as any;\r\n          const linkedSkill = specSystem.linkedSkill || '';\r\n          if (linkedSkill) {\r\n            skillName = linkedSkill;\r\n            normalizedSkillName = ItemSearch.normalizeSearchText(linkedSkill);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  const isSorcery = normalizedSkillName === 'sorcellerie';\r\n  const isConjuration = normalizedSkillName === 'conjuration';\r\n  \r\n  if (!isSorcery && !isConjuration) {\r\n    return; // Not a magic test, no drain\r\n  }\r\n\r\n  // Only apply drain if there's a complication\r\n  if (rollResult.complication === 'none') {\r\n    return;\r\n  }\r\n\r\n  const actorSystem = actor.system as any;\r\n  if (!actorSystem || actor.type !== 'character') {\r\n    return; // Only apply to character actors\r\n  }\r\n\r\n  // Handle different complication levels\r\n  if (rollResult.complication === 'minor') {\r\n    // Minor complication: display message in chat about disadvantage until next narration\r\n    const message = game.i18n.localize('SRA2.SKILLS.DRAIN_MINOR_COMPLICATION');\r\n    await ChatMessage.create({\r\n      user: game.user?.id,\r\n      speaker: {\r\n        actor: actor.id,\r\n        alias: actor.name\r\n      },\r\n      content: `<div class=\"drain-message minor-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 4px;\">\r\n        <i class=\"fas fa-exclamation-triangle\" style=\"color: #ffc107;\"></i> \r\n        <strong style=\"color: #ffc107;\">Drain - ${game.i18n.localize('SRA2.SKILLS.MINOR_COMPLICATION')}</strong>\r\n        <br/>\r\n        <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n      </div>`,\r\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n    });\r\n  } else if (rollResult.complication === 'critical') {\r\n    // Critical complication: apply light wound\r\n    const damage = actorSystem.damage || {};\r\n    const lightWounds = Array.isArray(damage.light) ? damage.light : [false, false];\r\n    \r\n    // Find first available light wound slot\r\n    let woundApplied = false;\r\n    for (let i = 0; i < lightWounds.length; i++) {\r\n      if (!lightWounds[i]) {\r\n        lightWounds[i] = true;\r\n        woundApplied = true;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (woundApplied) {\r\n      await actor.update({\r\n        'system.damage.light': lightWounds\r\n      });\r\n      \r\n      const message = game.i18n.localize('SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION');\r\n      await ChatMessage.create({\r\n        user: game.user?.id,\r\n        speaker: {\r\n          actor: actor.id,\r\n          alias: actor.name\r\n        },\r\n        content: `<div class=\"drain-message critical-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n          <i class=\"fas fa-exclamation-circle\" style=\"color: #dc3545;\"></i> \r\n          <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.CRITICAL_COMPLICATION')}</strong>\r\n          <br/>\r\n          <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n        </div>`,\r\n        type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n      });\r\n    } else {\r\n      // All light wound slots are full, upgrade to severe or incapacitating\r\n      const severeWounds = Array.isArray(damage.severe) ? damage.severe : [false];\r\n      let severeApplied = false;\r\n      \r\n      for (let i = 0; i < severeWounds.length; i++) {\r\n        if (!severeWounds[i]) {\r\n          severeWounds[i] = true;\r\n          severeApplied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      if (severeApplied) {\r\n        await actor.update({\r\n          'system.damage.severe': severeWounds\r\n        });\r\n      } else {\r\n        // All severe slots full, apply incapacitating\r\n        await actor.update({\r\n          'system.damage.incapacitating': true\r\n        });\r\n      }\r\n      \r\n      const message = game.i18n.localize('SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION');\r\n      await ChatMessage.create({\r\n        user: game.user?.id,\r\n        speaker: {\r\n          actor: actor.id,\r\n          alias: actor.name\r\n        },\r\n        content: `<div class=\"drain-message critical-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n          <i class=\"fas fa-exclamation-circle\" style=\"color: #dc3545;\"></i> \r\n          <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.CRITICAL_COMPLICATION')}</strong>\r\n          <br/>\r\n          <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n        </div>`,\r\n        type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n      });\r\n    }\r\n  } else if (rollResult.complication === 'disaster') {\r\n    // Disaster: apply incapacitating wound\r\n    await actor.update({\r\n      'system.damage.incapacitating': true\r\n    });\r\n    \r\n    const message = game.i18n.localize('SRA2.SKILLS.DRAIN_DISASTER');\r\n    await ChatMessage.create({\r\n      user: game.user?.id,\r\n      speaker: {\r\n        actor: actor.id,\r\n        alias: actor.name\r\n      },\r\n      content: `<div class=\"drain-message disaster\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n        <i class=\"fas fa-skull\" style=\"color: #dc3545;\"></i> \r\n        <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.DISASTER')}</strong>\r\n        <br/>\r\n        <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n      </div>`,\r\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n    });\r\n  }\r\n}\r\n\r\n","/**\r\n * Shared Sheet Helpers for SRA2\r\n * Common functions used by CharacterSheet\r\n */\r\n\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Handle form submission with proper damage checkbox handling\r\n */\r\nexport function handleSheetUpdate(actor: any, formData: any): any {\r\n  // DEBUG: Log which actor is being updated\r\n  console.log('handleSheetUpdate - DEBUG:', {\r\n    'actor.id': actor?.id,\r\n    'actor.name': actor?.name,\r\n    'actor.type': actor?.type,\r\n    'actor.uuid': actor?.uuid\r\n  });\r\n  \r\n  // Expand the form data first to handle nested properties properly\r\n  const expandedData = foundry.utils.expandObject(formData) as any;\r\n  \r\n  // Only process damage if it's present in the formData (indicates damage fields were changed)\r\n  if (expandedData.system && expandedData.system.damage !== undefined) {\r\n    const currentDamage = (actor.system as any).damage || {};\r\n    \r\n    // Initialize damage object if not present\r\n    if (!expandedData.system.damage || typeof expandedData.system.damage !== 'object') {\r\n      expandedData.system.damage = {};\r\n    }\r\n    \r\n    // Helper function to convert object with numeric keys to array\r\n    const convertToArray = (obj: any, expectedLength: number): boolean[] => {\r\n      if (Array.isArray(obj)) {\r\n        // Already an array, ensure all indices are filled and convert to boolean\r\n        const arr: boolean[] = [];\r\n        for (let i = 0; i < expectedLength; i++) {\r\n          if (obj[i] !== undefined) {\r\n            arr[i] = obj[i] === true || obj[i] === 'true' || obj[i] === 'on';\r\n          } else {\r\n            arr[i] = false;\r\n          }\r\n        }\r\n        return arr;\r\n      }\r\n      if (obj && typeof obj === 'object') {\r\n        // Object with numeric keys (e.g., {\"0\": true, \"1\": false}), convert to array\r\n        const arr: boolean[] = [];\r\n        for (let i = 0; i < expectedLength; i++) {\r\n          const key = i.toString();\r\n          arr[i] = obj[key] === true || obj[key] === 'true' || obj[key] === 'on';\r\n        }\r\n        return arr;\r\n      }\r\n      // Not present or invalid, return array of false\r\n      return Array(expectedLength).fill(false);\r\n    };\r\n    \r\n    // Get expected lengths from current damage or defaults\r\n    const currentLightLength = Array.isArray(currentDamage.light) ? currentDamage.light.length : 2;\r\n    const currentSevereLength = Array.isArray(currentDamage.severe) ? currentDamage.severe.length : 1;\r\n    \r\n    // Handle light damage checkboxes - process if present in formData\r\n    if (expandedData.system.damage.light !== undefined) {\r\n      expandedData.system.damage.light = convertToArray(expandedData.system.damage.light, currentLightLength);\r\n    }\r\n    \r\n    // Handle severe damage checkboxes - process if present in formData\r\n    if (expandedData.system.damage.severe !== undefined) {\r\n      expandedData.system.damage.severe = convertToArray(expandedData.system.damage.severe, currentSevereLength);\r\n    }\r\n    \r\n    // Handle incapacitating - convert to boolean if present\r\n    if (expandedData.system.damage.incapacitating !== undefined) {\r\n      expandedData.system.damage.incapacitating = expandedData.system.damage.incapacitating === true || \r\n                                                  expandedData.system.damage.incapacitating === 'true' || \r\n                                                  expandedData.system.damage.incapacitating === 'on';\r\n    }\r\n  }\r\n  \r\n  return expandedData;\r\n}\r\n\r\n/**\r\n * Calculate final damage value for weapon/spell display\r\n */\r\nexport function calculateFinalDamageValue(damageValue: string, damageValueBonus: number, strength: number): string {\r\n  if (damageValue === \"FOR\") {\r\n    const total = strength + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (FOR+${damageValueBonus})` : `${total} (FOR)`;\r\n  } else if (damageValue.startsWith(\"FOR+\")) {\r\n    const modifier = parseInt(damageValue.substring(4)) || 0;\r\n    const total = strength + modifier + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (FOR+${modifier}+${damageValueBonus})` : `${total} (FOR+${modifier})`;\r\n  } else if (damageValue === \"toxin\") {\r\n    return \"selon toxine\";\r\n  } else {\r\n    const base = parseInt(damageValue) || 0;\r\n    const total = base + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (${base}+${damageValueBonus})` : total.toString();\r\n  }\r\n}\r\n\r\n/**\r\n * Organize specializations by linked skill\r\n */\r\nexport function organizeSpecializationsBySkill(\r\n  allSpecializations: any[],\r\n  actorItems: any[]\r\n): { bySkill: Map<string, any[]>; unlinked: any[] } {\r\n  const specializationsBySkill = new Map<string, any[]>();\r\n  const unlinkedSpecializations: any[] = [];\r\n  \r\n  allSpecializations.forEach((spec: any) => {\r\n    const linkedSkillName = spec.system.linkedSkill;\r\n    if (linkedSkillName) {\r\n      // linkedSkill is stored as a name, find the skill by name\r\n      const linkedSkill = actorItems.find((i: any) => \r\n        i.type === 'skill' && i.name === linkedSkillName\r\n      );\r\n      \r\n      if (linkedSkill && linkedSkill.id) {\r\n        // Valid linked skill found\r\n        const skillId = linkedSkill.id;\r\n        if (!specializationsBySkill.has(skillId)) {\r\n          specializationsBySkill.set(skillId, []);\r\n        }\r\n        specializationsBySkill.get(skillId)!.push(spec);\r\n      } else {\r\n        // Linked skill doesn't exist, mark as unlinked\r\n        unlinkedSpecializations.push(spec);\r\n      }\r\n    } else {\r\n      // No linked skill specified\r\n      unlinkedSpecializations.push(spec);\r\n    }\r\n  });\r\n  \r\n  return { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations };\r\n}\r\n\r\n/**\r\n * Handle item drop on actor sheet (feats, skills, specializations, metatypes)\r\n */\r\nexport async function handleItemDrop(\r\n  event: DragEvent,\r\n  actor: any,\r\n  allowedTypes: string[] = ['feat', 'skill', 'specialization', 'metatype']\r\n): Promise<boolean> {\r\n  const data = TextEditor.getDragEventData(event) as any;\r\n  \r\n  // Handle Item drops\r\n  if (data && data.type === 'Item') {\r\n    const item = await Item.implementation.fromDropData(data) as any;\r\n    \r\n    if (!item) return false;\r\n    \r\n    // Check if the item is from a compendium or another actor (not already on this actor)\r\n    if (item.actor && item.actor.id === actor.id) {\r\n      // Item already belongs to this actor, ignore\r\n      return false;\r\n    }\r\n    \r\n    // Check if type is allowed\r\n    if (!allowedTypes.includes(item.type)) {\r\n      return false;\r\n    }\r\n    \r\n    // Handle metatype\r\n    if (item.type === 'metatype') {\r\n      const existingMetatype = actor.items.find((i: any) => i.type === 'metatype');\r\n      if (existingMetatype) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.METATYPES.ONLY_ONE_METATYPE'));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle feat\r\n    if (item.type === 'feat') {\r\n      const existingFeat = actor.items.find((i: any) => \r\n        i.type === 'feat' && i.name === item.name\r\n      );\r\n      if (existingFeat) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle skill\r\n    if (item.type === 'skill') {\r\n      const existingSkill = actor.items.find((i: any) => \r\n        i.type === 'skill' && i.name === item.name\r\n      );\r\n      if (existingSkill) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle specialization\r\n    if (item.type === 'specialization') {\r\n      const existingSpec = actor.items.find((i: any) => \r\n        i.type === 'specialization' && i.name === item.name\r\n      );\r\n      if (existingSpec) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.SPECIALIZATIONS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Handle vehicle actor drop on character sheet\r\n * Adds the vehicle actor UUID to the character's linkedVehicles array\r\n */\r\nexport async function handleVehicleActorDrop(\r\n  event: DragEvent,\r\n  actor: any\r\n): Promise<boolean> {\r\n  const data = TextEditor.getDragEventData(event) as any;\r\n  \r\n  // Handle Actor drops (specifically vehicle actors)\r\n  if (data && data.type === 'Actor') {\r\n    try {\r\n      const vehicleActor = await fromUuid(data.uuid) as any;\r\n      \r\n      if (!vehicleActor) return false;\r\n      \r\n      // Check if it's a vehicle actor\r\n      if (vehicleActor.type !== 'vehicle') return false;\r\n      \r\n      // Get current linked vehicles\r\n      const linkedVehicles = (actor.system as any).linkedVehicles || [];\r\n      \r\n      // Check if this vehicle is already linked\r\n      if (linkedVehicles.includes(vehicleActor.uuid)) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.VEHICLE_ALREADY_EXISTS', { name: vehicleActor.name }));\r\n        return false;\r\n      }\r\n      \r\n      // Add the vehicle UUID to the linked vehicles array\r\n      const updatedLinkedVehicles = [...linkedVehicles, vehicleActor.uuid];\r\n      await actor.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n      \r\n      // Configure the vehicle's token prototype to be linked to the character actor\r\n      const prototypeToken = vehicleActor.prototypeToken || {};\r\n      const updateData: any = {\r\n        'prototypeToken.actorLink': true\r\n      };\r\n      \r\n      // If the vehicle doesn't have a prototype token yet, initialize it\r\n      if (!vehicleActor.prototypeToken) {\r\n        updateData['prototypeToken'] = foundry.utils.mergeObject(\r\n          foundry.data.PrototypeToken.defaults,\r\n          { actorLink: true }\r\n        );\r\n      }\r\n      \r\n      await vehicleActor.update(updateData);\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.VEHICLE_ADDED', { name: vehicleActor.name }));\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error handling vehicle actor drop:', error);\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Get RR for a specific item type and name (wrapper for DiceRoller)\r\n */\r\nexport function getRRSources(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\r\n  const sources: Array<{featName: string, rrValue: number}> = [];\r\n  \r\n  const feats = actor.items.filter((item: any) => \r\n    item.type === 'feat' && \r\n    item.system.active === true\r\n  );\r\n  \r\n  // Normalize the search name for comparison (case-insensitive, accent-insensitive)\r\n  const normalizedItemName = ItemSearch.normalizeSearchText(itemName);\r\n  \r\n  for (const feat of feats) {\r\n    const featSystem = feat.system as any;\r\n    const rrList = featSystem.rrList || [];\r\n    \r\n    for (const rrEntry of rrList) {\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      // Normalize the RR target for comparison\r\n      const normalizedRRTarget = ItemSearch.normalizeSearchText(rrTarget);\r\n      \r\n      // Compare normalized names for better matching (handles custom skills/specs with variations)\r\n      if (rrType === itemType && normalizedRRTarget === normalizedItemName && rrValue > 0) {\r\n        sources.push({\r\n          featName: feat.name,\r\n          rrValue: rrValue\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return sources;\r\n}\r\n\r\n/**\r\n * Calculate Risk Reduction for a given skill, specialization, or attribute\r\n */\r\nexport function calculateRR(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\r\n  const sources = getRRSources(actor, itemType, itemName);\r\n  return sources.reduce((total, source) => total + source.rrValue, 0);\r\n}\r\n\r\n/**\r\n * Generic handler to edit an item from an actor\r\n */\r\nexport async function handleEditItem(event: Event, actor: any): Promise<void> {\r\n  event.preventDefault();\r\n  const element = event.currentTarget as HTMLElement;\r\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\r\n  \r\n  if (!itemId) return;\r\n\r\n  const item = actor.items.get(itemId);\r\n  if (item) {\r\n    item.sheet?.render(true);\r\n  }\r\n}\r\n\r\n/**\r\n * Generic handler to delete an item from an actor\r\n */\r\nexport async function handleDeleteItem(event: Event, actor: any, sheetRender?: (refresh: boolean) => void): Promise<void> {\r\n  event.preventDefault();\r\n  const element = event.currentTarget as HTMLElement;\r\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\r\n  \r\n  if (!itemId) return;\r\n\r\n  const item = actor.items.get(itemId);\r\n  if (item) {\r\n    await item.delete();\r\n    if (sheetRender) {\r\n      sheetRender(false);\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// DAMAGE VALUE PARSING\r\n// ============================================================================\r\n\r\n/**\r\n * Result of parsing a damage value\r\n */\r\nexport interface DamageValueResult {\r\n  /** Numeric damage value (resolved) */\r\n  numericValue: number;\r\n  /** Display string for UI (e.g., \"5 (FOR+2)\") */\r\n  displayValue: string;\r\n  /** Raw damage string to send in roll data (e.g., \"FOR+2\") */\r\n  rawDamageString: string;\r\n  /** Whether the damage is strength-based */\r\n  isStrengthBased: boolean;\r\n  /** Whether the damage is toxin-based */\r\n  isToxin: boolean;\r\n}\r\n\r\n/**\r\n * Parse a damage value string and calculate the final numeric value\r\n * Handles: FOR, FOR+X, numeric values, and toxin\r\n * \r\n * @param damageValueStr - The damage value string (e.g., \"FOR\", \"FOR+2\", \"5\", \"toxin\")\r\n * @param actorStrength - The actor's strength attribute value\r\n * @param damageValueBonus - Additional bonus from feats/items (default: 0)\r\n * @returns Parsed damage value result\r\n */\r\nexport function parseDamageValue(\r\n  damageValueStr: string,\r\n  actorStrength: number,\r\n  damageValueBonus: number = 0\r\n): DamageValueResult {\r\n  const result: DamageValueResult = {\r\n    numericValue: 0,\r\n    displayValue: damageValueStr,\r\n    rawDamageString: damageValueStr,\r\n    isStrengthBased: false,\r\n    isToxin: false\r\n  };\r\n  \r\n  // Handle toxin damage\r\n  if (damageValueStr === 'toxin') {\r\n    result.isToxin = true;\r\n    result.displayValue = 'selon toxine';\r\n    return result;\r\n  }\r\n  \r\n  // Handle FOR (strength-based)\r\n  if (damageValueStr === 'FOR') {\r\n    result.isStrengthBased = true;\r\n    result.numericValue = actorStrength + damageValueBonus;\r\n    if (damageValueBonus > 0) {\r\n      result.displayValue = `${result.numericValue} (FOR+${damageValueBonus})`;\r\n      result.rawDamageString = `FOR+${damageValueBonus}`;\r\n    } else {\r\n      result.displayValue = `${result.numericValue} (FOR)`;\r\n      result.rawDamageString = 'FOR';\r\n    }\r\n    return result;\r\n  }\r\n  \r\n  // Handle FOR+X (strength-based with modifier)\r\n  if (damageValueStr.startsWith('FOR+')) {\r\n    result.isStrengthBased = true;\r\n    const modifier = parseInt(damageValueStr.substring(4)) || 0;\r\n    result.numericValue = actorStrength + modifier + damageValueBonus;\r\n    const totalModifier = modifier + damageValueBonus;\r\n    if (damageValueBonus > 0) {\r\n      result.displayValue = `${result.numericValue} (FOR+${modifier}+${damageValueBonus})`;\r\n      result.rawDamageString = `FOR+${totalModifier}`;\r\n    } else {\r\n      result.displayValue = `${result.numericValue} (FOR+${modifier})`;\r\n      result.rawDamageString = damageValueStr;\r\n    }\r\n    return result;\r\n  }\r\n  \r\n  // Handle numeric damage\r\n  const base = parseInt(damageValueStr) || 0;\r\n  result.numericValue = base + damageValueBonus;\r\n  if (damageValueBonus > 0) {\r\n    result.displayValue = `${result.numericValue} (${base}+${damageValueBonus})`;\r\n    result.rawDamageString = result.numericValue.toString();\r\n  } else {\r\n    result.displayValue = result.numericValue.toString();\r\n    result.rawDamageString = damageValueStr;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate raw damage string with bonus applied (for roll data)\r\n * This returns the string to be used in roll requests (e.g., \"FOR+3\" or \"7\")\r\n */\r\nexport function calculateRawDamageString(\r\n  baseDamageValue: string,\r\n  damageValueBonus: number\r\n): string {\r\n  if (damageValueBonus <= 0 || baseDamageValue === '0' || baseDamageValue === 'toxin') {\r\n    return baseDamageValue;\r\n  }\r\n  \r\n  if (baseDamageValue === 'FOR') {\r\n    return `FOR+${damageValueBonus}`;\r\n  }\r\n  \r\n  if (baseDamageValue.startsWith('FOR+')) {\r\n    const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\r\n    return `FOR+${baseModifier + damageValueBonus}`;\r\n  }\r\n  \r\n  // Numeric value\r\n  const baseValue = parseInt(baseDamageValue) || 0;\r\n  return (baseValue + damageValueBonus).toString();\r\n}\r\n\r\n// ============================================================================\r\n// DAMAGE CHECKBOX HANDLING\r\n// ============================================================================\r\n\r\n/**\r\n * Result of parsing damage checkbox changes\r\n */\r\nexport interface DamageUpdateResult {\r\n  light: boolean[];\r\n  severe: boolean[];\r\n  incapacitating: boolean;\r\n}\r\n\r\n/**\r\n * Parse a damage checkbox change and return the updated damage object\r\n * Works for both character damage and cyberdeck damage\r\n * \r\n * @param inputName - The input name (e.g., \"system.damage.light.0\")\r\n * @param checked - Whether the checkbox is checked\r\n * @param currentDamage - Current damage object from actor/item\r\n * @returns Updated damage object, or null if the input name doesn't match\r\n */\r\nexport function parseDamageCheckboxChange(\r\n  inputName: string,\r\n  checked: boolean,\r\n  currentDamage: any\r\n): DamageUpdateResult | null {\r\n  // Match patterns like:\r\n  // - system.damage.light.0\r\n  // - system.damage.severe.0\r\n  // - system.damage.incapacitating\r\n  // - items.{itemId}.system.cyberdeckDamage.light.0\r\n  const match = inputName.match(/(?:damage|cyberdeckDamage)\\.(light|severe|incapacitating)(?:\\.(\\d+))?$/);\r\n  if (!match) return null;\r\n  \r\n  const damageType = match[1] as 'light' | 'severe' | 'incapacitating';\r\n  const index = match[2] ? parseInt(match[2], 10) : null;\r\n  \r\n  // Create a copy of the damage object\r\n  const updatedDamage: DamageUpdateResult = {\r\n    light: Array.isArray(currentDamage?.light) ? [...currentDamage.light] : [false, false],\r\n    severe: Array.isArray(currentDamage?.severe) ? [...currentDamage.severe] : [false],\r\n    incapacitating: typeof currentDamage?.incapacitating === 'boolean' ? currentDamage.incapacitating : false\r\n  };\r\n  \r\n  // Update the appropriate field\r\n  if (damageType === 'incapacitating') {\r\n    updatedDamage.incapacitating = checked;\r\n  } else if (damageType === 'light' || damageType === 'severe') {\r\n    if (index !== null) {\r\n      // Ensure array is long enough\r\n      while (updatedDamage[damageType].length <= index) {\r\n        updatedDamage[damageType].push(false);\r\n      }\r\n      updatedDamage[damageType][index] = checked;\r\n    }\r\n  }\r\n  \r\n  return updatedDamage;\r\n}\r\n\r\n/**\r\n * Get the damage path prefix from an input name\r\n * Returns 'system.damage' for character damage, or 'system.cyberdeckDamage' for cyberdeck\r\n */\r\nexport function getDamagePathFromInputName(inputName: string): string {\r\n  if (inputName.includes('cyberdeckDamage')) {\r\n    // Extract the items.{itemId}.system.cyberdeckDamage part\r\n    const match = inputName.match(/(items\\.[^.]+\\.system\\.cyberdeckDamage)/);\r\n    return match && match[1] ? match[1] : 'system.cyberdeckDamage';\r\n  }\r\n  return 'system.damage';\r\n}\r\n\r\n// ============================================================================\r\n// SECTION NAVIGATION\r\n// ============================================================================\r\n\r\n/**\r\n * Handle section navigation click event\r\n * Updates the active section in both the nav and content areas\r\n * \r\n * @param event - The click event\r\n * @param formElement - The form element (or its jQuery wrapper)\r\n * @returns The section name that was activated, or null if invalid\r\n */\r\nexport function handleSectionNavigation(\r\n  event: Event,\r\n  formElement: HTMLElement | JQuery\r\n): string | null {\r\n  event.preventDefault();\r\n  const button = event.currentTarget as HTMLElement;\r\n  const section = button.dataset.section;\r\n  \r\n  if (!section) return null;\r\n  \r\n  const form = formElement instanceof HTMLElement \r\n    ? formElement \r\n    : (formElement as JQuery).get(0);\r\n  \r\n  if (!form) return null;\r\n  \r\n  // Update nav items\r\n  form.querySelectorAll('.section-nav .nav-item').forEach((item) => {\r\n    item.classList.remove('active');\r\n  });\r\n  button.classList.add('active');\r\n  \r\n  // Update content sections\r\n  form.querySelectorAll('.content-section').forEach((contentSection) => {\r\n    contentSection.classList.remove('active');\r\n  });\r\n  const targetSection = form.querySelector(`[data-section-content=\"${section}\"]`);\r\n  if (targetSection) {\r\n    targetSection.classList.add('active');\r\n  }\r\n  \r\n  return section;\r\n}\r\n\r\n/**\r\n * Restore the active section after a re-render\r\n * Call this in activateListeners or after any operation that triggers a re-render\r\n * \r\n * @param formElement - The form element\r\n * @param activeSection - The section name to activate\r\n * @param delay - Optional delay in ms before restoring (default: 10)\r\n */\r\nexport function restoreActiveSection(\r\n  formElement: HTMLElement,\r\n  activeSection: string | null,\r\n  delay: number = 10\r\n): void {\r\n  if (!activeSection) return;\r\n  \r\n  setTimeout(() => {\r\n    const navButton = formElement.querySelector(`[data-section=\"${activeSection}\"]`);\r\n    if (navButton) {\r\n      // Update nav items\r\n      formElement.querySelectorAll('.section-nav .nav-item').forEach((item) => {\r\n        item.classList.remove('active');\r\n      });\r\n      navButton.classList.add('active');\r\n      \r\n      // Update content sections\r\n      formElement.querySelectorAll('.content-section').forEach((section) => {\r\n        section.classList.remove('active');\r\n      });\r\n      const targetSection = formElement.querySelector(`[data-section-content=\"${activeSection}\"]`);\r\n      if (targetSection) {\r\n        targetSection.classList.add('active');\r\n      }\r\n    }\r\n  }, delay);\r\n}\r\n\r\n/**\r\n * Save the current active section from the sheet's HTML\r\n * Useful before operations that will cause a re-render\r\n * \r\n * @param html - jQuery object of the sheet\r\n * @returns The current active section name, or null\r\n */\r\nexport function getCurrentActiveSection(html: JQuery): string | null {\r\n  const activeNavItem = html.find('.section-nav .nav-item.active');\r\n  return activeNavItem.length > 0 ? (activeNavItem.data('section') as string) : null;\r\n}\r\n\r\n// ============================================================================\r\n// FEAT ENRICHMENT\r\n// ============================================================================\r\n\r\n/**\r\n * Enrich feats with RR entries and final damage values\r\n */\r\nexport function enrichFeats(feats: any[], actorStrength: number, calculateFinalDamageValueFn: (dv: string, bonus: number, str: number) => string, actor?: any): any[] {\r\n  return feats.map((feat: any) => {\r\n    // Add translated labels for attribute targets in RR entries\r\n    feat.rrEntries = [];\r\n    const itemRRList = feat.system.rrList || [];\r\n    \r\n    // For weapons and spells, also include RR from linked skills/specs/attributes\r\n    let allRRList = [...itemRRList];\r\n    \r\n    if (actor && (feat.system.featType === 'weapon' || feat.system.featType === 'spell' || feat.system.featType === 'weapons-spells')) {\r\n      const { normalizeSearchText } = ItemSearch;\r\n      \r\n      // Get linked skill and specialization from weapon\r\n      const linkedAttackSkill = feat.system.linkedAttackSkill || '';\r\n      const linkedAttackSpec = feat.system.linkedAttackSpecialization || '';\r\n      \r\n      let attackSpecName: string | undefined = undefined;\r\n      let attackSkillName: string | undefined = undefined;\r\n      let attackLinkedAttribute: string | undefined = undefined;\r\n      \r\n      // Try to find the linked attack specialization first\r\n      if (linkedAttackSpec) {\r\n        const foundSpec = actor.items.find((i: any) => \r\n          i.type === 'specialization' && \r\n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSpec)\r\n        );\r\n        \r\n        if (foundSpec) {\r\n          const specSystem = foundSpec.system as any;\r\n          attackSpecName = foundSpec.name;\r\n          attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\r\n          \r\n          // Get parent skill for specialization\r\n          const linkedSkillName = specSystem.linkedSkill;\r\n          if (linkedSkillName) {\r\n            const parentSkill = actor.items.find((i: any) => \r\n              i.type === 'skill' && i.name === linkedSkillName\r\n            );\r\n            if (parentSkill) {\r\n              attackSkillName = parentSkill.name;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      // If no specialization found, try to find the linked attack skill\r\n      if (!attackSpecName && linkedAttackSkill) {\r\n        const foundSkill = actor.items.find((i: any) => \r\n          i.type === 'skill' && \r\n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSkill)\r\n        );\r\n        \r\n        if (foundSkill) {\r\n          attackSkillName = foundSkill.name;\r\n          attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\r\n        }\r\n      }\r\n      \r\n      // Get RR sources from skill/specialization/attribute\r\n      if (attackSpecName) {\r\n        const specRRSources = getRRSources(actor, 'specialization', attackSpecName);\r\n        allRRList = [...allRRList, ...specRRSources.map(rr => ({\r\n          rrType: 'specialization',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackSpecName\r\n        }))];\r\n      }\r\n      if (attackSkillName) {\r\n        const skillRRSources = getRRSources(actor, 'skill', attackSkillName);\r\n        allRRList = [...allRRList, ...skillRRSources.map(rr => ({\r\n          rrType: 'skill',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackSkillName\r\n        }))];\r\n      }\r\n      if (attackLinkedAttribute) {\r\n        const attributeRRSources = getRRSources(actor, 'attribute', attackLinkedAttribute);\r\n        allRRList = [...allRRList, ...attributeRRSources.map(rr => ({\r\n          rrType: 'attribute',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackLinkedAttribute\r\n        }))];\r\n      }\r\n    }\r\n    \r\n    // Process all RR entries (item RR + skill/spec/attribute RR)\r\n    for (let i = 0; i < allRRList.length; i++) {\r\n      const rrEntry = allRRList[i];\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      if (rrValue > 0) {\r\n      const entry: any = { rrType, rrValue, rrTarget };\r\n      \r\n      if (rrType === 'attribute' && rrTarget) {\r\n        entry.rrTargetLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${rrTarget.toUpperCase()}`);\r\n      }\r\n      \r\n      feat.rrEntries.push(entry);\r\n      }\r\n    }\r\n    \r\n    // Calculate final damage value for weapons, spells, and adept power weapons\r\n    const isWeapon = feat.system.featType === 'weapon';\r\n    const isSpell = feat.system.featType === 'spell';\r\n    const isAdeptPowerWeapon = feat.system.isAdeptPowerWeapon || false;\r\n    \r\n    if (isWeapon || isSpell || isAdeptPowerWeapon) {\r\n      const damageValue = feat.system.damageValue || '0';\r\n      let damageValueBonus = feat.system.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      // This applies to all weapons, including adept power weapons\r\n      if (actor) {\r\n        const weaponType = feat.system.weaponType || '';\r\n        const activeFeats = actor.items.filter((item: any) => \r\n          item.type === 'feat' && \r\n          item.system.active === true &&\r\n          item.system.weaponDamageBonus > 0 &&\r\n          item.system.weaponTypeBonus === weaponType\r\n        );\r\n        \r\n        activeFeats.forEach((activeFeat: any) => {\r\n          damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n        });\r\n      }\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      feat.finalDamageValue = calculateFinalDamageValueFn(damageValue, damageValueBonus, actorStrength);\r\n    }\r\n    \r\n    return feat;\r\n  });\r\n}\r\n\r\n/**\r\n * Result from finding attack skill and specialization\r\n */\r\nexport interface AttackSkillSpecResult {\r\n  skillName: string | undefined;\r\n  skillLevel: number | undefined;\r\n  specName: string | undefined;\r\n  specLevel: number | undefined;\r\n  linkedAttribute: string | undefined;\r\n}\r\n\r\n/**\r\n * Options for finding attack skill and specialization\r\n */\r\nexport interface FindAttackSkillSpecOptions {\r\n  isSpell?: boolean;\r\n  spellSpecType?: string;\r\n  defaultAttribute?: string;\r\n}\r\n\r\n/**\r\n * Normalize text for comparison (remove spaces, accents, punctuation)\r\n */\r\nexport function normalizeForComparison(text: string): string {\r\n  return ItemSearch.normalizeSearchText(text).replace(/\\s+/g, '').replace(/:/g, '').replace(/'/g, '');\r\n}\r\n\r\n/**\r\n * Find attack skill and specialization in an actor's items\r\n * Unifies the logic used in getData() for enriching weapons and in _rollWeaponOrSpell()\r\n * \r\n * @param actor - The actor to search in\r\n * @param targetSpec - The specialization name to search for\r\n * @param targetSkill - The skill name to search for (fallback if spec not found)\r\n * @param options - Additional options (isSpell, spellSpecType, defaultAttribute)\r\n * @returns AttackSkillSpecResult with found skill/spec info\r\n */\r\nexport function findAttackSkillAndSpec(\r\n  actor: any,\r\n  targetSpec: string,\r\n  targetSkill: string,\r\n  options: FindAttackSkillSpecOptions = {}\r\n): AttackSkillSpecResult {\r\n  const result: AttackSkillSpecResult = {\r\n    skillName: undefined,\r\n    skillLevel: undefined,\r\n    specName: undefined,\r\n    specLevel: undefined,\r\n    linkedAttribute: undefined\r\n  };\r\n\r\n  const { isSpell = false, spellSpecType = 'combat', defaultAttribute = 'strength' } = options;\r\n\r\n  // Try to find the linked attack specialization first\r\n  if (targetSpec) {\r\n    const normalizedTargetSpec = normalizeForComparison(targetSpec);\r\n    \r\n    const foundSpec = actor.items.find((i: any) => {\r\n      if (i.type !== 'specialization') return false;\r\n      const normalizedItemName = normalizeForComparison(i.name);\r\n      return normalizedItemName === normalizedTargetSpec;\r\n    });\r\n    \r\n    if (foundSpec) {\r\n      _extractSpecAndSkillInfo(actor, foundSpec, result, defaultAttribute);\r\n    } else if (isSpell) {\r\n      // If exact match not found for spells, try keyword search\r\n      _trySpellSpecKeywordSearch(actor, spellSpecType, result);\r\n      \r\n      // If still not found, search in game.items\r\n      if (!result.specName && !result.skillLevel && game.items) {\r\n        _searchGameItemsForSpellSpec(actor, targetSpec, spellSpecType, result);\r\n      }\r\n    }\r\n  }\r\n  \r\n  // If no specialization found, try to find the linked attack skill\r\n  if (!result.specName && !result.skillLevel && targetSkill) {\r\n    const foundSkill = actor.items.find((i: any) => \r\n      i.type === 'skill' && \r\n      ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(targetSkill)\r\n    );\r\n    \r\n    if (foundSkill) {\r\n      const foundLinkedAttribute = (foundSkill.system as any).linkedAttribute || defaultAttribute;\r\n      result.skillName = foundSkill.name;\r\n      result.linkedAttribute = result.linkedAttribute || foundLinkedAttribute;\r\n      const skillRating = (foundSkill.system as any).rating || 0;\r\n      const attributeValue = (actor.system as any).attributes?.[foundLinkedAttribute] || 0;\r\n      result.skillLevel = skillRating + attributeValue;\r\n    } else if (isSpell && game.items) {\r\n      // For spells, try to find Sorcellerie in game.items\r\n      _searchGameItemsForSorcellerie(actor, result);\r\n    } else if (!isSpell) {\r\n      // Skill not found: use default attribute with skill rating of 0\r\n      result.skillName = targetSkill;\r\n      result.linkedAttribute = result.linkedAttribute || defaultAttribute;\r\n      const attributeValue = (actor.system as any).attributes?.[defaultAttribute] || 0;\r\n      result.skillLevel = 0 + attributeValue; // Skill rating is 0 when skill doesn't exist\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Extract skill and spec info from a found specialization\r\n */\r\nfunction _extractSpecAndSkillInfo(\r\n  actor: any,\r\n  foundSpec: any,\r\n  result: AttackSkillSpecResult,\r\n  defaultAttribute: string\r\n): void {\r\n  const specSystem = foundSpec.system as any;\r\n  result.specName = foundSpec.name;\r\n  result.linkedAttribute = specSystem.linkedAttribute || defaultAttribute;\r\n  \r\n  // Get parent skill for specialization\r\n  const linkedSkillName = specSystem.linkedSkill;\r\n  if (linkedSkillName) {\r\n    const parentSkill = actor.items.find((i: any) => \r\n      i.type === 'skill' && i.name === linkedSkillName\r\n    );\r\n    if (parentSkill && result.linkedAttribute) {\r\n      result.skillName = parentSkill.name;\r\n      const skillRating = (parentSkill.system as any).rating || 0;\r\n      const attributeValue = (actor.system as any).attributes?.[result.linkedAttribute] || 0;\r\n      const skillLevel = skillRating + attributeValue;\r\n      result.skillLevel = skillLevel;\r\n      result.specLevel = skillLevel + 2; // Specialization adds +2\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Try to find spell specialization by keyword search in actor items\r\n */\r\nfunction _trySpellSpecKeywordSearch(\r\n  actor: any,\r\n  spellSpecType: string,\r\n  result: AttackSkillSpecResult\r\n): void {\r\n  const specKeywords: Record<string, string[]> = {\r\n    'combat': ['combat'],\r\n    'detection': ['détection', 'detection'],\r\n    'health': ['santé', 'sante', 'health'],\r\n    'illusion': ['illusion'],\r\n    'manipulation': ['manipulation'],\r\n    'counterspell': ['contresort', 'contre-sort']\r\n  };\r\n  \r\n  const keywords = specKeywords[spellSpecType] || ['combat'];\r\n  const normalizedKeywords = keywords.map(kw => ItemSearch.normalizeSearchText(kw));\r\n  \r\n  const foundSpecByKeyword = actor.items.find((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const normalizedName = ItemSearch.normalizeSearchText(i.name);\r\n    const linkedSkill = (i.system as any)?.linkedSkill;\r\n    if (linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === 'sorcellerie') {\r\n      return normalizedKeywords.some(normalizedKeyword => normalizedName.includes(normalizedKeyword));\r\n    }\r\n    return false;\r\n  });\r\n  \r\n  if (foundSpecByKeyword) {\r\n    _extractSpecAndSkillInfo(actor, foundSpecByKeyword, result, 'willpower');\r\n  }\r\n}\r\n\r\n/**\r\n * Search in game.items for spell specialization\r\n */\r\nfunction _searchGameItemsForSpellSpec(\r\n  actor: any,\r\n  targetSpec: string,\r\n  spellSpecType: string,\r\n  result: AttackSkillSpecResult\r\n): void {\r\n  const normalizedTargetSpec = normalizeForComparison(targetSpec);\r\n  \r\n  // Search in game.items for the specialization\r\n  const specInGameItems = (game.items as any).find((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const normalizedItemName = normalizeForComparison(i.name);\r\n    return normalizedItemName === normalizedTargetSpec;\r\n  });\r\n  \r\n  const specKeywords: Record<string, string[]> = {\r\n    'combat': ['combat'],\r\n    'detection': ['détection', 'detection'],\r\n    'health': ['santé', 'sante', 'health'],\r\n    'illusion': ['illusion'],\r\n    'manipulation': ['manipulation'],\r\n    'counterspell': ['contresort', 'contre-sort']\r\n  };\r\n  \r\n  let specToUse = specInGameItems;\r\n  \r\n  // If still not found by exact match, try keyword search in game.items\r\n  if (!specToUse) {\r\n    const keywords = specKeywords[spellSpecType] || ['combat'];\r\n    const normalizedKeywords = keywords.map(kw => ItemSearch.normalizeSearchText(kw));\r\n    \r\n    specToUse = (game.items as any).find((i: any) => {\r\n      if (i.type !== 'specialization') return false;\r\n      const normalizedName = ItemSearch.normalizeSearchText(i.name);\r\n      const linkedSkill = (i.system as any)?.linkedSkill;\r\n      if (linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === 'sorcellerie') {\r\n        return normalizedKeywords.some(normalizedKeyword => normalizedName.includes(normalizedKeyword));\r\n      }\r\n      return false;\r\n    });\r\n  }\r\n  \r\n  if (specToUse) {\r\n    const specSystem = specToUse.system as any;\r\n    const linkedSkillName = specSystem.linkedSkill;\r\n    \r\n    if (linkedSkillName) {\r\n      const parentSkill = actor.items.find((i: any) => \r\n        i.type === 'skill' && i.name === linkedSkillName\r\n      );\r\n      if (parentSkill) {\r\n        const skillSystem = parentSkill.system as any;\r\n        const linkedAttribute = skillSystem.linkedAttribute || 'willpower';\r\n        result.skillName = parentSkill.name;\r\n        result.linkedAttribute = linkedAttribute;\r\n        const skillLevel = (skillSystem.rating || 0) + ((actor.system as any).attributes?.[linkedAttribute] || 0);\r\n        result.skillLevel = skillLevel;\r\n        // Note: specName stays undefined since spec is not in actor\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Search in game.items for Sorcellerie skill\r\n */\r\nfunction _searchGameItemsForSorcellerie(actor: any, result: AttackSkillSpecResult): void {\r\n  const sorcerySkillInGame = (game.items as any).find((i: any) => \r\n    i.type === 'skill' && \r\n    ItemSearch.normalizeSearchText(i.name) === 'sorcellerie'\r\n  );\r\n  \r\n  if (sorcerySkillInGame) {\r\n    // Use default willpower attribute for Sorcellerie if skill not in actor\r\n    result.skillName = 'Sorcellerie';\r\n    result.linkedAttribute = 'willpower';\r\n    const willpower = (actor.system as any).attributes?.willpower || 1;\r\n    result.skillLevel = willpower; // Skill rating would be 0 if not in actor\r\n  }\r\n}\r\n\r\n/**\r\n * RR Source entry structure\r\n */\r\nexport interface RRSourceEntry {\r\n  featName: string;\r\n  rrValue: number;\r\n  rrType?: string;\r\n  rrTarget?: string;\r\n}\r\n\r\n/**\r\n * Result from calculating attack pool with RR\r\n */\r\nexport interface AttackPoolResult {\r\n  totalDicePool: number;\r\n  totalRR: number;\r\n  allRRSources: RRSourceEntry[];\r\n}\r\n\r\n/**\r\n * Calculate attack pool (dice pool and RR) from skill/spec result and item RR\r\n * Unifies the RR calculation logic used in getData() and _rollWeaponOrSpell()\r\n * \r\n * @param actor - The actor\r\n * @param skillSpecResult - Result from findAttackSkillAndSpec()\r\n * @param itemRRList - The item's rrList (from weapon/spell)\r\n * @param itemName - The item name (for RR source attribution)\r\n * @returns AttackPoolResult with dice pool and RR\r\n */\r\nexport function calculateAttackPool(\r\n  actor: any,\r\n  skillSpecResult: AttackSkillSpecResult,\r\n  itemRRList: any[] = [],\r\n  itemName: string = ''\r\n): AttackPoolResult {\r\n  // Calculate dice pool: use spec level if available, otherwise skill level, otherwise 0\r\n  const totalDicePool = skillSpecResult.specLevel || skillSpecResult.skillLevel || 0;\r\n  \r\n  // Get RR sources from skill/specialization/attribute\r\n  let skillRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  let specRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  \r\n  if (skillSpecResult.specName) {\r\n    specRRSources = getRRSources(actor, 'specialization', skillSpecResult.specName);\r\n  }\r\n  if (skillSpecResult.skillName) {\r\n    skillRRSources = getRRSources(actor, 'skill', skillSpecResult.skillName);\r\n  }\r\n  if (skillSpecResult.linkedAttribute) {\r\n    attributeRRSources = getRRSources(actor, 'attribute', skillSpecResult.linkedAttribute);\r\n  }\r\n  \r\n  // Convert item RR list to same format as getRRSources (objects with rrValue)\r\n  const itemRRSources = itemRRList.map((rrEntry: any) => ({\r\n    featName: itemName,\r\n    rrValue: rrEntry.rrValue || 0\r\n  }));\r\n  \r\n  // Merge all RR sources (item RR + skill/spec/attribute RR)\r\n  const allRRSources = [...itemRRSources, ...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n  \r\n  // Calculate total RR (sum of all RR values, max 3)\r\n  const totalRR = Math.min(3, allRRSources.reduce((sum: number, source: any) => {\r\n    return sum + (source.rrValue || 0);\r\n  }, 0));\r\n  \r\n  return {\r\n    totalDicePool,\r\n    totalRR,\r\n    allRRSources\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// ITEM SEARCH HELPERS\r\n// =============================================================================\r\n\r\n/**\r\n * Find a skill by name in an actor's items (normalized comparison)\r\n * \r\n * @param actor - The actor to search in\r\n * @param skillName - The skill name to find\r\n * @returns The found skill item or undefined\r\n */\r\nexport function findSkillByName(actor: any, skillName: string): any | undefined {\r\n  if (!actor || !skillName) return undefined;\r\n  \r\n  const normalizedName = ItemSearch.normalizeSearchText(skillName);\r\n  return actor.items.find((i: any) => \r\n    i.type === 'skill' && \r\n    ItemSearch.normalizeSearchText(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Find a specialization by name in an actor's items (normalized comparison)\r\n * \r\n * @param actor - The actor to search in\r\n * @param specName - The specialization name to find\r\n * @returns The found specialization item or undefined\r\n */\r\nexport function findSpecByName(actor: any, specName: string): any | undefined {\r\n  if (!actor || !specName) return undefined;\r\n  \r\n  const normalizedName = normalizeForComparison(specName);\r\n  return actor.items.find((i: any) => \r\n    i.type === 'specialization' && \r\n    normalizeForComparison(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Find an item by type and name in game.items (normalized comparison)\r\n * \r\n * @param itemType - The item type to find ('skill', 'specialization', etc.)\r\n * @param itemName - The item name to find\r\n * @returns The found item or undefined\r\n */\r\nexport function findItemInGame(itemType: string, itemName: string): any | undefined {\r\n  if (!game.items || !itemName) return undefined;\r\n  \r\n  const normalizedName = normalizeForComparison(itemName);\r\n  return (game.items as any).find((i: any) => \r\n    i.type === itemType && \r\n    normalizeForComparison(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Calculate skill dice pool (attribute + rating)\r\n * \r\n * @param actor - The actor\r\n * @param skill - The skill item\r\n * @returns The total dice pool\r\n */\r\nexport function calculateSkillDicePool(actor: any, skill: any): number {\r\n  if (!actor || !skill) return 0;\r\n  \r\n  const skillSystem = skill.system as any;\r\n  const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n  const attributeValue = (actor.system as any).attributes?.[linkedAttribute] || 0;\r\n  const skillRating = skillSystem.rating || 0;\r\n  \r\n  return attributeValue + skillRating;\r\n}\r\n\r\n/**\r\n * Calculate specialization dice pool (attribute + skill rating + 2)\r\n * \r\n * @param actor - The actor\r\n * @param spec - The specialization item\r\n * @param parentSkill - Optional parent skill (if not provided, will be found)\r\n * @returns The total dice pool\r\n */\r\nexport function calculateSpecDicePool(actor: any, spec: any, parentSkill?: any): number {\r\n  if (!actor || !spec) return 0;\r\n  \r\n  const specSystem = spec.system as any;\r\n  const linkedSkillName = specSystem.linkedSkill;\r\n  \r\n  // Find parent skill if not provided\r\n  const skill = parentSkill || findSkillByName(actor, linkedSkillName);\r\n  if (!skill) return 0;\r\n  \r\n  const skillDicePool = calculateSkillDicePool(actor, skill);\r\n  return skillDicePool + 2; // Specialization adds +2\r\n}\r\n\r\n/**\r\n * Get the linked attribute for a skill or specialization\r\n * \r\n * @param item - The skill or specialization item\r\n * @param actor - Optional actor to search for parent skill (for specs)\r\n * @returns The linked attribute name\r\n */\r\nexport function getLinkedAttribute(item: any, actor?: any): string {\r\n  if (!item) return 'strength';\r\n  \r\n  const itemSystem = item.system as any;\r\n  \r\n  // If skill, return its linked attribute\r\n  if (item.type === 'skill') {\r\n    return itemSystem.linkedAttribute || 'strength';\r\n  }\r\n  \r\n  // If specialization, find the parent skill's linked attribute\r\n  if (item.type === 'specialization' && actor) {\r\n    const linkedSkillName = itemSystem.linkedSkill;\r\n    const parentSkill = findSkillByName(actor, linkedSkillName);\r\n    if (parentSkill) {\r\n      return (parentSkill.system as any).linkedAttribute || 'strength';\r\n    }\r\n  }\r\n  \r\n  // Fallback\r\n  return itemSystem.linkedAttribute || 'strength';\r\n}\r\n\r\n/**\r\n * Find default defense selection for an actor\r\n * Unified logic for finding the appropriate defense skill/spec\r\n * \r\n * @param actor - The defending actor\r\n * @param linkedDefenseSpec - The target defense specialization name\r\n * @param linkedDefenseSkill - The target defense skill name (fallback)\r\n * @returns Object with defaultSelection string and found items\r\n */\r\nexport interface DefenseSearchResult {\r\n  defaultSelection: string;\r\n  linkedSpec: any | undefined;\r\n  linkedSkill: any | undefined;\r\n}\r\n\r\nexport function findDefenseSelection(\r\n  actor: any,\r\n  linkedDefenseSpec: string,\r\n  linkedDefenseSkill?: string\r\n): DefenseSearchResult {\r\n  const result: DefenseSearchResult = {\r\n    defaultSelection: '',\r\n    linkedSpec: undefined,\r\n    linkedSkill: undefined\r\n  };\r\n  \r\n  const skills = actor.items.filter((i: any) => i.type === 'skill');\r\n  \r\n  // 1. Try to find the linked defense specialization\r\n  if (linkedDefenseSpec) {\r\n    result.linkedSpec = findSpecByName(actor, linkedDefenseSpec);\r\n    \r\n    if (result.linkedSpec) {\r\n      result.defaultSelection = `spec-${result.linkedSpec.id}`;\r\n      // Find the parent skill\r\n      const linkedSkillName = result.linkedSpec.system.linkedSkill;\r\n      result.linkedSkill = findSkillByName(actor, linkedSkillName);\r\n      return result;\r\n    }\r\n  }\r\n  \r\n  // 2. Try to find the defense skill\r\n  if (linkedDefenseSkill) {\r\n    result.linkedSkill = findSkillByName(actor, linkedDefenseSkill);\r\n    \r\n    if (result.linkedSkill) {\r\n      result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n      return result;\r\n    }\r\n  }\r\n  \r\n  // 3. Fallback: Search in game.items for the spec template\r\n  if (linkedDefenseSpec && game.items) {\r\n    const specTemplate = findItemInGame('specialization', linkedDefenseSpec);\r\n    \r\n    if (specTemplate) {\r\n      const linkedSkillName = specTemplate.system.linkedSkill;\r\n      if (linkedSkillName) {\r\n        result.linkedSkill = findSkillByName(actor, linkedSkillName);\r\n        if (result.linkedSkill) {\r\n          result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 4. Default to first skill\r\n  if (skills.length > 0) {\r\n    result.linkedSkill = skills[0];\r\n    result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Get all specializations for a skill (by name, normalized comparison)\r\n * \r\n * @param actor - The actor\r\n * @param skillName - The skill name to find specs for\r\n * @returns Array of specializations linked to this skill\r\n */\r\nexport function getSpecializationsForSkill(actor: any, skillName: string): any[] {\r\n  if (!actor || !skillName) return [];\r\n  \r\n  const normalizedSkillName = ItemSearch.normalizeSearchText(skillName);\r\n  \r\n  return actor.items.filter((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const linkedSkill = (i.system as any)?.linkedSkill;\r\n    return linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === normalizedSkillName;\r\n  });\r\n}\r\n\r\n","/**\r\n * Combat Helpers for SRA2\r\n * Shared functions for combat, defense, and attack calculations\r\n */\r\n\r\nimport * as SheetHelpers from './sheet-helpers.js';\r\nimport { VEHICLE_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Calculate damage thresholds for a character actor\r\n * @param actorSystem - The actor's system data\r\n * @param includeArmor - Whether to include armor in the calculation (default: true)\r\n * @returns Damage thresholds object with light, severe, and incapacitating values\r\n */\r\nexport function calculateDamageThresholds(\r\n  actorSystem: any,\r\n  includeArmor: boolean = true\r\n): { light: number; severe: number; incapacitating: number } {\r\n  const strength = actorSystem.attributes?.strength || 1;\r\n  const willpower = actorSystem.attributes?.willpower || 1;\r\n  \r\n  // Get armor level (calculated from feats)\r\n  const armorLevel = actorSystem.armorLevel || 0;\r\n  \r\n  // Get physical threshold bonuses from feats\r\n  let bonusPhysicalThreshold = 0;\r\n  let bonusMentalThreshold = 0;\r\n  \r\n  // Calculate bonuses from active feats\r\n  const parent = (actorSystem as any).parent;\r\n  if (parent && parent.items) {\r\n    const activeFeats = parent.items.filter((item: any) => \r\n      item.type === 'feat' && item.system.active === true\r\n    );\r\n    \r\n    activeFeats.forEach((feat: any) => {\r\n      bonusPhysicalThreshold += feat.system.bonusPhysicalThreshold || 0;\r\n      bonusMentalThreshold += feat.system.bonusMentalThreshold || 0;\r\n    });\r\n  }\r\n  \r\n  // Calculate base thresholds\r\n  const basePhysical = strength + bonusPhysicalThreshold;\r\n  const baseMental = willpower + bonusMentalThreshold;\r\n  \r\n  // Apply armor if requested\r\n  const physicalArmor = includeArmor ? armorLevel : 0;\r\n  \r\n  return {\r\n    light: basePhysical + physicalArmor,\r\n    severe: basePhysical + physicalArmor + 3,\r\n    incapacitating: basePhysical + physicalArmor + 6\r\n  };\r\n}\r\n\r\n/**\r\n * Get damage thresholds for a defender based on damage type\r\n * @param defenderActor - The defender actor\r\n * @param damageType - Type of damage: 'physical', 'mental', or 'matrix'\r\n * @returns Damage thresholds object\r\n */\r\nexport function getDamageThresholds(\r\n  defenderActor: any,\r\n  damageType: 'physical' | 'mental' | 'matrix' = 'physical'\r\n): { light: number; severe?: number; incapacitating: number } {\r\n  const defenderSystem = defenderActor.system as any;\r\n  const isVehicle = defenderActor.type === 'vehicle';\r\n  const isIce = defenderActor.type === 'ice';\r\n  \r\n  if (isIce) {\r\n    // For ICE, thresholds are based on FW = 1: light = 1, severe = 2, incapacitating = 3\r\n    return defenderSystem.damageThresholds || {\r\n      light: 1,\r\n      severe: 2,\r\n      incapacitating: 3\r\n    };\r\n  }\r\n  \r\n  if (isVehicle) {\r\n    // For vehicles/drones, thresholds are directly in damageThresholds\r\n    return defenderSystem.damageThresholds || {\r\n      light: 1,\r\n      severe: 4,\r\n      incapacitating: 7\r\n    };\r\n  }\r\n  \r\n  // For characters\r\n  if (damageType === 'mental') {\r\n    return defenderSystem.damageThresholds?.mental || {\r\n      light: 1,\r\n      severe: 4,\r\n      incapacitating: 7\r\n    };\r\n  }\r\n  \r\n  if (damageType === 'matrix') {\r\n    return defenderSystem.damageThresholds?.matrix || {\r\n      light: 0,\r\n      severe: 0,\r\n      incapacitating: 0\r\n    };\r\n  }\r\n  \r\n  // Physical damage: use withArmor thresholds (armor is always included for physical damage)\r\n  return defenderSystem.damageThresholds?.withArmor || {\r\n    light: 1,\r\n    severe: 4,\r\n    incapacitating: 7\r\n  };\r\n}\r\n\r\n/**\r\n * Calculate NPC threshold for a skill or specialization\r\n */\r\nexport function calculateNPCThreshold(\r\n  actor: any,\r\n  item: any,\r\n  dicePool: number,\r\n  itemType: 'skill' | 'specialization',\r\n  parentSkill?: any\r\n): { threshold: number; totalRR: number } {\r\n  let totalRR = 0;\r\n  \r\n  // Get all active feats\r\n  const activeFeats = actor.items.filter((i: any) => \r\n    i.type === 'feat' && i.system.active === true\r\n  );\r\n  \r\n  // Get linked attribute for this item\r\n  const linkedAttribute = item.system.linkedAttribute;\r\n  \r\n  // Check each feat for RR that applies\r\n  activeFeats.forEach((feat: any) => {\r\n    const rrList = feat.system.rrList || [];\r\n    rrList.forEach((rrEntry: any) => {\r\n      // Check if RR applies to this item\r\n      if (itemType === 'skill' && rrEntry.rrType === 'skill' && rrEntry.rrTarget === item.name) {\r\n        totalRR += rrEntry.rrValue || 0;\r\n      } else if (itemType === 'specialization') {\r\n        // For specializations, check spec RR and also inherit skill RR\r\n        if (rrEntry.rrType === 'specialization' && rrEntry.rrTarget === item.name) {\r\n          totalRR += rrEntry.rrValue || 0;\r\n        } else if (parentSkill && rrEntry.rrType === 'skill' && rrEntry.rrTarget === parentSkill.name) {\r\n          totalRR += rrEntry.rrValue || 0;\r\n        }\r\n      }\r\n      \r\n      // Also check for attribute RR\r\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\r\n        totalRR += rrEntry.rrValue || 0;\r\n      }\r\n    });\r\n  });\r\n  \r\n  // Calculate NPC threshold: round(dice pool / 3) + RR + 1\r\n  const threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n  \r\n  return { threshold, totalRR };\r\n}\r\n\r\n/**\r\n * Build skill and specialization options HTML for defense dialog\r\n */\r\nexport interface BuildSkillOptionsParams {\r\n  defenderActor: any;\r\n  skills: any[];\r\n  allSpecializations: any[];\r\n  defaultSelection: string;\r\n  includeThreshold?: boolean; // Whether to show NPC threshold\r\n}\r\n\r\nexport function buildSkillOptionsHtml(params: BuildSkillOptionsParams): string {\r\n  const { defenderActor, skills, allSpecializations: _allSpecializations, defaultSelection, includeThreshold = false } = params;\r\n  \r\n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.COMBAT.SELECT_DEFENSE_SKILL') + ' --</option>';\r\n  \r\n  // Sort skills alphabetically by name\r\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n  \r\n  sortedSkills.forEach((skill: any) => {\r\n    const skillSystem = skill.system as any;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (defenderActor.system as any).attributes?.[linkedAttribute] || 0;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const totalDicePool = attributeValue + skillRating;\r\n    \r\n    let optionText = `${skill.name} (${totalDicePool} dés)`;\r\n    let dataAttrs = `data-dice-pool=\"${totalDicePool}\"`;\r\n    \r\n    // Calculate threshold if requested\r\n    if (includeThreshold) {\r\n      const { threshold } = calculateNPCThreshold(defenderActor, skill, totalDicePool, 'skill');\r\n      optionText = `${skill.name} (Seuil: ${threshold} / ${totalDicePool} dés)`;\r\n      dataAttrs += ` data-threshold=\"${threshold}\"`;\r\n    }\r\n    \r\n    // Check if this skill should be selected by default\r\n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\r\n    \r\n    html += `<option value=\"skill-${skill.id}\" ${dataAttrs}${selected}>${optionText}</option>`;\r\n    \r\n    // Add specializations for this skill using helper\r\n    const specs = SheetHelpers.getSpecializationsForSkill(defenderActor, skill.name);\r\n    \r\n    specs.forEach((spec: any) => {\r\n      const specTotalDicePool = SheetHelpers.calculateSpecDicePool(defenderActor, spec, skill);\r\n      const effectiveRating = skillRating + 2;\r\n      \r\n      let specOptionText = `  → ${spec.name} (${specTotalDicePool} dés)`;\r\n      let specDataAttrs = `data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"`;\r\n      \r\n      // Calculate threshold if requested\r\n      if (includeThreshold) {\r\n        const { threshold: specThreshold } = calculateNPCThreshold(defenderActor, spec, specTotalDicePool, 'specialization', skill);\r\n        specOptionText = `  → ${spec.name} (Seuil: ${specThreshold} / ${specTotalDicePool} dés)`;\r\n        specDataAttrs += ` data-threshold=\"${specThreshold}\"`;\r\n      }\r\n      \r\n      // Check if this specialization should be selected by default\r\n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\r\n      \r\n      html += `<option value=\"spec-${spec.id}\" ${specDataAttrs}${specSelected}>${specOptionText}</option>`;\r\n    });\r\n  });\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * REMOVED: Defense dice roll function\r\n */\r\n\r\n/**\r\n * REMOVED: Dice results HTML building\r\n */\r\n\r\n/**\r\n * Parse weapon damage value and calculate base VD\r\n * Includes damageValueBonus from weapon feat\r\n * \r\n * @deprecated Use SheetHelpers.parseDamageValue() for more complete information\r\n */\r\nexport function parseWeaponDamageValue(\r\n  weaponDamageValue: string | number,\r\n  actorStrength: number,\r\n  damageValueBonus: number = 0\r\n): { baseVD: number; vdDisplay: string } {\r\n  // Delegate to the shared helper\r\n  const result = SheetHelpers.parseDamageValue(String(weaponDamageValue), actorStrength, damageValueBonus);\r\n  \r\n  return {\r\n    baseVD: result.isToxin ? -1 : result.numericValue,\r\n    vdDisplay: result.displayValue\r\n  };\r\n}\r\n\r\n/**\r\n * REMOVED: NPC attack HTML building\r\n */\r\n\r\n/**\r\n * REMOVED: Threshold defense result creation\r\n */\r\n\r\n/**\r\n * Build skill selection options for weapon/spell attack\r\n * Similar to buildSkillOptionsHtml but without threshold calculation\r\n */\r\nexport function buildAttackSkillOptionsHtml(\r\n  actor: any,\r\n  skills: any[],\r\n  _allSpecializations: any[],\r\n  defaultSelection: string\r\n): string {\r\n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.FEATS.WEAPON.SELECT_SKILL') + ' --</option>';\r\n  \r\n  // Sort skills alphabetically by name\r\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n  \r\n  sortedSkills.forEach((skill: any) => {\r\n    const skillSystem = skill.system as any;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (actor.system as any).attributes?.[linkedAttribute] || 0;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const totalDicePool = attributeValue + skillRating;\r\n    \r\n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\r\n    html += `<option value=\"skill-${skill.id}\" data-dice-pool=\"${totalDicePool}\"${selected}>${skill.name} (${totalDicePool} dés)</option>`;\r\n    \r\n    // Add specializations for this skill using helper\r\n    const specs = SheetHelpers.getSpecializationsForSkill(actor, skill.name);\r\n    \r\n    specs.forEach((spec: any) => {\r\n      const specTotalDicePool = SheetHelpers.calculateSpecDicePool(actor, spec, skill);\r\n      const effectiveRating = skillRating + 2;\r\n      \r\n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\r\n      html += `<option value=\"spec-${spec.id}\" data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"${specSelected}>  → ${spec.name} (${specTotalDicePool} dés)</option>`;\r\n    });\r\n  });\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * REMOVED: Weapon/spell dialog content creation\r\n */\r\n\r\n/**\r\n * REMOVED: Attack result display and chat message creation\r\n */\r\n\r\n/**\r\n * Prepare vehicle/drone weapon attack data for dice rolling\r\n * Vehicles use autopilot as dice pool instead of skills\r\n */\r\nexport function prepareVehicleWeaponAttack(\r\n  vehicleActor: any,\r\n  weapon: any\r\n): {\r\n  dicePool: number;\r\n  rrList: Array<{ featName: string; rrValue: number }>;\r\n  damageValue: string;\r\n} {\r\n  const vehicleSystem = vehicleActor.system as any;\r\n  const weaponSystem = weapon.system as any;\r\n  \r\n  // Get autopilot as base dice pool (with bonus included)\r\n  // attributes.autopilot should already contain finalAutopilot = baseAutopilot + autopilotBonus (max 12)\r\n  // But to ensure bonus is always included, we recalculate it if needed\r\n  let autopilot = vehicleSystem.attributes?.autopilot;\r\n  \r\n  // Always recalculate to ensure autopilotBonus is included (in case prepareDerivedData wasn't called)\r\n  const vehicleType = vehicleSystem.vehicleType || \"\";\r\n  const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \r\n    ? VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \r\n    : null;\r\n  const baseAutopilot = vehicleStats?.autopilot || 6;\r\n  const autopilotBonus = vehicleSystem.autopilotBonus || 0;\r\n  const calculatedAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\r\n  \r\n  // Use calculated value to ensure bonus is always included\r\n  autopilot = calculatedAutopilot;\r\n  const dicePool = autopilot;\r\n  \r\n  // Get all active feats for RR calculation\r\n  const activeFeats = vehicleActor.items.filter((item: any) => \r\n    item.type === 'feat' && item.system.active === true\r\n  );\r\n  \r\n  // Calculate RR from active feats (only autopilot attribute RR applies)\r\n  const rrList: Array<{ featName: string; rrValue: number }> = [];\r\n  activeFeats.forEach((feat: any) => {\r\n    const featRRList = feat.system.rrList || [];\r\n    featRRList.forEach((rrEntry: any) => {\r\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n        rrList.push({\r\n          featName: feat.name,\r\n          rrValue: rrEntry.rrValue || 0\r\n        });\r\n      }\r\n    });\r\n  });\r\n  \r\n  // Also check weapon's own RR list and enrich with featName\r\n  const weaponRRList = weaponSystem.rrList || [];\r\n  weaponRRList.forEach((rrEntry: any) => {\r\n    if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n      rrList.push({\r\n        featName: weapon.name,\r\n        rrValue: rrEntry.rrValue || 0\r\n      });\r\n    }\r\n  });\r\n  \r\n  // Calculate final damage value (base + bonus) - same logic as character-sheet.ts\r\n  const baseDamageValue = parseInt(weaponSystem.damageValue || '0') || 0;\r\n  let damageValueBonus = parseInt(weaponSystem.damageValueBonus || '0') || 0;\r\n  \r\n  // Add bonus from active feats that match the weapon's type\r\n  const weaponType = weaponSystem.weaponType || '';\r\n  activeFeats.forEach((activeFeat: any) => {\r\n    if (activeFeat.system.weaponDamageBonus > 0 &&\r\n        activeFeat.system.weaponTypeBonus === weaponType) {\r\n      damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n    }\r\n  });\r\n  \r\n  // Limit total bonus to 2 maximum\r\n  damageValueBonus = Math.min(damageValueBonus, 2);\r\n  \r\n  let finalDamageValue = baseDamageValue + damageValueBonus;\r\n  \r\n  return {\r\n    dicePool,\r\n    rrList,\r\n    damageValue: finalDamageValue.toString()\r\n  };\r\n}\r\n\r\n/**\r\n * Prepare complete vehicle/drone weapon roll request data for DiceRoller\r\n * Uses prepareVehicleWeaponAttack and adds weapon type links\r\n */\r\nexport function prepareVehicleWeaponRollRequest(\r\n  vehicleActor: any,\r\n  weapon: any,\r\n  WEAPON_TYPES: any\r\n): any {\r\n  const weaponSystem = weapon.system as any;\r\n  const weaponType = weaponSystem.weaponType || 'custom-weapon';\r\n  \r\n  // Get weapon attack data using existing helper\r\n  const attackData = prepareVehicleWeaponAttack(vehicleActor, weapon);\r\n  \r\n  // Get weapon type links for defense skills\r\n  let weaponLinkedDefenseSkill = '';\r\n  let weaponLinkedDefenseSpecialization = '';\r\n  \r\n  if (weaponType && weaponType !== 'custom-weapon') {\r\n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n    if (weaponStats) {\r\n      weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\r\n      weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\r\n    }\r\n  }\r\n  \r\n  // Merge with custom fields (weapon type has priority)\r\n  const finalDefenseSkill = weaponLinkedDefenseSkill || weaponSystem.linkedDefenseSkill || '';\r\n  const finalDefenseSpec = weaponLinkedDefenseSpecialization || weaponSystem.linkedDefenseSpecialization || '';\r\n  \r\n  // Return complete roll request data\r\n  return {\r\n    itemType: 'weapon',\r\n    weaponType: weaponType,\r\n    itemName: weapon.name,\r\n    itemId: weapon.id,\r\n    itemRating: weaponSystem.rating || 0,\r\n    itemActive: weaponSystem.active,\r\n    \r\n    // No linked attack skill/spec for vehicles (uses autopilot directly)\r\n    linkedAttackSkill: '',\r\n    linkedAttackSpecialization: '',\r\n    linkedDefenseSkill: finalDefenseSkill,\r\n    linkedDefenseSpecialization: finalDefenseSpec,\r\n    linkedAttribute: 'autopilot', // Vehicles use autopilot attribute\r\n    \r\n    // Weapon properties\r\n    isWeaponFocus: weaponSystem.isWeaponFocus || false,\r\n    damageValue: attackData.damageValue, // Already includes bonus\r\n    meleeRange: weaponSystem.meleeRange,\r\n    shortRange: weaponSystem.shortRange,\r\n    mediumRange: weaponSystem.mediumRange,\r\n    longRange: weaponSystem.longRange,\r\n    \r\n    // Attack skill/spec (empty for vehicles, dice pool comes from autopilot)\r\n    skillName: undefined,\r\n    skillLevel: attackData.dicePool, // Use autopilot as skill level for dice pool\r\n    specName: undefined,\r\n    specLevel: undefined,\r\n    \r\n    // Actor information\r\n    actorId: vehicleActor.id,\r\n    actorUuid: vehicleActor.uuid,\r\n    actorName: vehicleActor.name || '',\r\n    \r\n    // RR List\r\n    rrList: attackData.rrList\r\n  };\r\n}\r\n\r\n/**\r\n * Apply damage to a defender (character, NPC, or vehicle/drone)\r\n * Handles different damage thresholds for vehicles vs characters\r\n * @param defenderUuid - UUID of the defender\r\n * @param damageValue - Damage value to apply\r\n * @param defenderName - Name of the defender (for notifications)\r\n * @param damageType - Type of damage: 'physical' (default) or 'mental' (for direct spells)\r\n */\r\n/**\r\n * Create an ICE attack message in chat\r\n * ICEs have a fixed threshold (server index) instead of rolling dice\r\n */\r\nexport async function createIceAttackMessage(\r\n  iceActor: any,\r\n  iceToken: any,\r\n  defender: any,\r\n  defenderToken: any\r\n): Promise<void> {\r\n  const iceSystem = iceActor.system as any;\r\n  const iceType = iceSystem.iceType;\r\n  const serverIndex = iceSystem.serverIndex || 1;\r\n  const threshold = iceSystem.threshold || serverIndex;\r\n  const damageValue = iceSystem.damageValue || 0;\r\n  \r\n  // Only ICEs that can attack (not Patrol, Acid, Blocker, Glue, Tracker)\r\n  const attackingIceTypes = ['blaster', 'black', 'killer'];\r\n  if (!attackingIceTypes.includes(iceType)) {\r\n    ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.CANNOT_ATTACK'));\r\n    return;\r\n  }\r\n  \r\n  // Get token UUIDs\r\n  const iceTokenUuid = iceToken?.uuid || iceToken?.document?.uuid;\r\n  const defenderTokenUuid = defenderToken?.uuid || defenderToken?.document?.uuid;\r\n  \r\n  // Determine final UUIDs (token actor UUID for NPCs)\r\n  const finalIceUuid = iceToken?.actor?.uuid || iceActor.uuid;\r\n  const finalDefenderUuid = defenderToken?.actor?.uuid || defender.uuid;\r\n  \r\n  // Create a fake roll result with fixed threshold\r\n  const rollResult = {\r\n    normalDice: [],\r\n    riskDice: [],\r\n    normalSuccesses: 0,\r\n    riskSuccesses: 0,\r\n    totalSuccesses: threshold, // ICE uses fixed threshold\r\n    criticalFailures: 0,\r\n    finalRR: 0,\r\n    remainingFailures: 0,\r\n    complication: 'none'\r\n  };\r\n  \r\n  // Prepare roll data for ICE attack\r\n  const rollData = {\r\n    itemType: 'ice-attack',\r\n    iceType: iceType,\r\n    serverIndex: serverIndex,\r\n    threshold: threshold,\r\n    damageValue: damageValue.toString(),\r\n    iceDamageValue: damageValue, // Store separately for defense calculation\r\n    skillName: 'Cybercombat (GLACE)',\r\n    itemName: iceActor.name,\r\n    isAttack: true,\r\n    isDefend: false,\r\n    isCounterAttack: false,\r\n    isSpellDirect: false\r\n  };\r\n  \r\n  // Prepare defender data with token image\r\n  let defenderData: any = null;\r\n  if (defender) {\r\n    let tokenImg = defender.img;\r\n    if (defenderToken) {\r\n      tokenImg = (defenderToken as any).document?.texture?.src || \r\n                 (defenderToken as any).document?.img || \r\n                 (defenderToken as any).data?.img || \r\n                 (defenderToken as any).texture?.src ||\r\n                 defender.img;\r\n    }\r\n    \r\n    defenderData = {\r\n      ...defender,\r\n      img: tokenImg\r\n    };\r\n  }\r\n  \r\n  // Prepare template data\r\n  const templateData: any = {\r\n    attacker: {\r\n      ...iceActor,\r\n      uuid: finalIceUuid\r\n    },\r\n    defender: defenderData,\r\n    rollData: rollData,\r\n    rollResult: rollResult,\r\n    isAttack: true,\r\n    isDefend: false,\r\n    isCounterAttack: false,\r\n    skillName: 'Cybercombat (GLACE)',\r\n    itemName: iceActor.name,\r\n    damageValue: damageValue.toString(),\r\n    attackerUuid: finalIceUuid,\r\n    defenderUuid: finalDefenderUuid,\r\n    attackerTokenUuid: iceTokenUuid,\r\n    defenderTokenUuid: defenderTokenUuid\r\n  };\r\n  \r\n  // Render template\r\n  const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n  \r\n  // Create chat message\r\n  const messageData: any = {\r\n    user: game.user?.id,\r\n    speaker: {\r\n      actor: iceActor.id,\r\n      alias: iceActor.name\r\n    },\r\n    content: html,\r\n    type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n    flags: {\r\n      sra2: {\r\n        rollType: 'ice-attack',\r\n        attackerId: iceActor.id,\r\n        attackerUuid: finalIceUuid,\r\n        attackerTokenUuid: iceTokenUuid,\r\n        defenderId: defender?.id,\r\n        defenderUuid: finalDefenderUuid,\r\n        defenderTokenUuid: defenderTokenUuid,\r\n        rollResult: rollResult,\r\n        rollData: rollData,\r\n        iceType: iceType,\r\n        iceThreshold: threshold,\r\n        iceDamageValue: damageValue\r\n      }\r\n    }\r\n  };\r\n  \r\n  await ChatMessage.create(messageData);\r\n}\r\n\r\nexport async function applyDamage(defenderUuid: string, damageValue: number, defenderName: string, damageType: 'physical' | 'mental' = 'physical'): Promise<void> {\r\n  // Use fromUuid to get the token's actor if it's a token UUID, or the actor if it's an actor UUID\r\n  const defender = await fromUuid(defenderUuid as any) as any;\r\n  \r\n  if (!defender) {\r\n    ui.notifications?.error(`Cannot find defender: ${defenderName}`);\r\n    return;\r\n  }\r\n  \r\n  // If this is a token, get its actor\r\n  const defenderActor = defender.actor || defender;\r\n  \r\n  const defenderSystem = defenderActor.system as any;\r\n  const isVehicle = defenderActor.type === 'vehicle';\r\n  const isIce = defenderActor.type === 'ice';\r\n  \r\n  // Get damage thresholds using the helper function\r\n  const damageThresholds = getDamageThresholds(defenderActor, damageType);\r\n  \r\n  // Deep copy of damage object with arrays\r\n  let damage = {\r\n    light: [...(defenderSystem.damage?.light || [])],\r\n    severe: [...(defenderSystem.damage?.severe || [])],\r\n    incapacitating: defenderSystem.damage?.incapacitating || false\r\n  };\r\n  let woundType = '';\r\n  let overflow = false;\r\n  \r\n  // Determine damage type based on thresholds\r\n  // For ICE: light = 1, severe = 2, incapacitating = 3 (based on FW = 1)\r\n  // For vehicles: light = Structure + Armor, severe = (2 × Structure) + Armor, incapacitating = (3 × Structure) + Armor\r\n  // For characters: light, severe, incapacitating from withArmor thresholds\r\n  \r\n  if (isIce) {\r\n    // ICE damage thresholds\r\n    if (damageThresholds.incapacitating && damageValue > damageThresholds.incapacitating) {\r\n      // Incapacitating wound: VD > 3\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageValue > (damageThresholds?.severe || 0)) {\r\n      // Severe wound: VD > 2\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound: VD > 1\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound: VD ≤ 1\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  } else if (isVehicle) {\r\n    // Vehicle/drone damage thresholds\r\n    if (damageThresholds.incapacitating && damageValue > damageThresholds.incapacitating) {\r\n      // Incapacitating wound: VD > (3 × Structure) + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageValue > (damageThresholds.severe || 0)) {\r\n      // Severe wound: VD > (2 × Structure) + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound: VD > Structure + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound: VD ≤ Structure + Blindage\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  } else {\r\n    // Character damage thresholds\r\n    if (damageValue > (damageThresholds?.incapacitating || 0)) {\r\n      // Incapacitating wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageThresholds.severe && damageValue > (damageThresholds.severe || 0)) {\r\n      // Severe wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  }\r\n  \r\n  // Update the actor's damage (use defenderActor to update the token's actor data)\r\n  // The prepareDerivedData() method now preserves existing damage values, so normal update should work\r\n  await defenderActor.update({ 'system.damage': damage });\r\n  \r\n  // Check if now incapacitated\r\n  if (damage.incapacitating === true) {\r\n    ui.notifications?.error(game.i18n!.format('SRA2.COMBAT.NOW_INCAPACITATED', { target: defenderName }));\r\n  } else {\r\n    ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n      damage: overflow ? `${woundType} (débordement)` : woundType,\r\n      target: defenderName \r\n    }));\r\n  }\r\n}\r\n\r\n","import * as DiceRoller from '../helpers/dice-roller.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport { WEAPON_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Character Sheet Application\r\n */\r\nexport class CharacterSheet extends ActorSheet {\r\n  /** Active section for tabbed navigation */\r\n  private _activeSection: string = 'identity';\r\n\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'character'],\r\n      template: 'systems/sra2/templates/actor-character-sheet.hbs',\r\n      width: 900,\r\n      height: 700,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dragSelector: '.metatype-item', dropSelector: null },\r\n        { dragSelector: '.feat-item', dropSelector: null },\r\n        { dragSelector: '.skill-item', dropSelector: null },\r\n        { dragSelector: '.specialization-item', dropSelector: null }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override async getData(): Promise<any> {\r\n    const context = super.getData() as any;\r\n\r\n    // DEBUG: Log when character sheet getData is called\r\n    console.log('CharacterSheet.getData - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'stack': new Error().stack?.split('\\n').slice(1, 5).join('\\n')\r\n    });\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n    \r\n    // Ensure damage arrays are properly initialized\r\n    const systemData = context.system as any;\r\n    if (!systemData.damage) {\r\n      systemData.damage = {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n    } else {\r\n      // Ensure arrays exist and have at least the minimum length\r\n      if (!Array.isArray(systemData.damage.light)) {\r\n        systemData.damage.light = [false, false];\r\n      } else if (systemData.damage.light.length < 2) {\r\n        while (systemData.damage.light.length < 2) {\r\n          systemData.damage.light.push(false);\r\n        }\r\n      }\r\n      \r\n      if (!Array.isArray(systemData.damage.severe)) {\r\n        systemData.damage.severe = [false];\r\n      }\r\n      \r\n      if (typeof systemData.damage.incapacitating !== 'boolean') {\r\n        systemData.damage.incapacitating = false;\r\n      }\r\n    }\r\n    \r\n    // Ensure anarchySpent array is properly initialized\r\n    if (!Array.isArray(systemData.anarchySpent)) {\r\n      systemData.anarchySpent = [false, false, false];\r\n    } else if (systemData.anarchySpent.length < 3) {\r\n      while (systemData.anarchySpent.length < 3) {\r\n        systemData.anarchySpent.push(false);\r\n      }\r\n    }\r\n\r\n    // Get metatype (there should be only one)\r\n    const metatypes = this.actor.items.filter((item: any) => item.type === 'metatype');\r\n    context.metatype = metatypes.length > 0 ? metatypes[0] : null;\r\n    \r\n    // Calculate base anarchy (3 + metatype bonus) and bonus anarchy (from feats) for display purposes\r\n    const metatypeAnarchyBonus = context.metatype ? (context.metatype.system as any).anarchyBonus || 0 : 0;\r\n    context.baseAnarchy = 3 + metatypeAnarchyBonus;\r\n    \r\n    // Calculate bonus anarchy from active feats\r\n    const activeFeats = this.actor.items.filter((item: any) => \r\n      item.type === 'feat' && item.system.active === true\r\n    );\r\n    let bonusAnarchy = 0;\r\n    activeFeats.forEach((feat: any) => {\r\n      bonusAnarchy += feat.system.bonusAnarchy || 0;\r\n    });\r\n    context.bonusAnarchy = bonusAnarchy;\r\n    \r\n    // Create separate arrays for base and bonus anarchy trackers with correct indices\r\n    const anarchySpent = systemData.anarchySpent || [];\r\n    context.baseAnarchySpent = anarchySpent.slice(0, context.baseAnarchy).map((value: boolean, index: number) => ({\r\n      value: value,\r\n      index: index\r\n    }));\r\n    context.bonusAnarchySpent = anarchySpent.slice(context.baseAnarchy).map((value: boolean, index: number) => ({\r\n      value: value,\r\n      index: context.baseAnarchy + index\r\n    }));\r\n\r\n    // Get actor's strength for damage value calculations\r\n    const actorStrength = (this.actor.system as any).attributes?.strength || 0;\r\n    \r\n    // Get feats and enrich with RR target labels and calculated damage values\r\n    const rawFeats = this.actor.items.filter((item: any) => item.type === 'feat');\r\n    const allFeats = SheetHelpers.enrichFeats(rawFeats, actorStrength, SheetHelpers.calculateFinalDamageValue, this.actor);\r\n    \r\n    // Get linked vehicle actors\r\n    const linkedVehicleUuids = (this.actor.system as any).linkedVehicles || [];\r\n    const linkedVehicles: any[] = [];\r\n    for (const uuid of linkedVehicleUuids) {\r\n      try {\r\n        const vehicleActor = await fromUuid(uuid) as any;\r\n        if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n          // Get weapons from vehicle\r\n          const vehicleWeapons: any[] = [];\r\n          const vehicleItems = vehicleActor.items || [];\r\n          for (const item of vehicleItems) {\r\n            const itemSystem = item.system as any;\r\n            if (item.type === 'feat' && (itemSystem.featType === 'weapon' || itemSystem.featType === 'weapons-spells')) {\r\n              // Enrich weapon with character's stats for display\r\n              const enrichedWeapon = SheetHelpers.enrichFeats([item], actorStrength, SheetHelpers.calculateFinalDamageValue, this.actor)[0];\r\n              vehicleWeapons.push({\r\n                _id: item.id,\r\n                uuid: item.uuid,\r\n                name: item.name,\r\n                img: item.img,\r\n                type: 'vehicle-weapon',\r\n                vehicleUuid: uuid,\r\n                vehicleName: vehicleActor.name,\r\n                weaponId: item.id,\r\n                system: {\r\n                  ...itemSystem,\r\n                  finalDamageValue: enrichedWeapon.finalDamageValue,\r\n                  rrEntries: enrichedWeapon.rrEntries || [],\r\n                  crr: itemSystem.crr || 0 // Include CRR for display\r\n                }\r\n              });\r\n            }\r\n          }\r\n          \r\n          // Calculate vehicle level (base 1 + bonuses + options, excluding weapons)\r\n          const vehicleSystem = vehicleActor.system as any;\r\n          let vehicleLevel = 1; // Base level\r\n          vehicleLevel += vehicleSystem.autopilotBonus || 0;\r\n          vehicleLevel += vehicleSystem.speedBonus || 0;\r\n          vehicleLevel += vehicleSystem.handlingBonus || 0;\r\n          vehicleLevel += vehicleSystem.armorBonus || 0;\r\n          if (vehicleSystem.isFlying) vehicleLevel += 1;\r\n          if (vehicleSystem.weaponMountImprovement) vehicleLevel += 1;\r\n          if (vehicleSystem.autopilotUnlocked) vehicleLevel += 3;\r\n          if (vehicleSystem.additionalDroneCount) vehicleLevel += vehicleSystem.additionalDroneCount * 2;\r\n          if (vehicleSystem.isFixed) vehicleLevel -= 1;\r\n          const narrativeEffects = vehicleSystem.narrativeEffects || [];\r\n          // Handle both old format (strings) and new format (objects with text, isNegative, value)\r\n          const narrativeEffectsCount = narrativeEffects.filter((effect: any) => {\r\n            if (typeof effect === 'string') {\r\n              return effect && effect.trim() !== '';\r\n            } else if (effect && typeof effect === 'object') {\r\n              const hasText = effect.text && effect.text.trim() !== '';\r\n              const hasValue = effect.value !== undefined && effect.value !== null && effect.value !== 0;\r\n              return hasText && hasValue;\r\n            }\r\n            return false;\r\n          }).length;\r\n          vehicleLevel += narrativeEffectsCount;\r\n          \r\n          // Check vehicle damage status\r\n          const vehicleDamage = vehicleActor.system?.damage || {};\r\n          const vehicleSevereDamage = Array.isArray(vehicleDamage.severe) ? vehicleDamage.severe : [false];\r\n          const hasSevereDamage = vehicleSevereDamage.some((box: boolean) => box === true);\r\n          const isIncapacitating = vehicleDamage.incapacitating === true;\r\n\r\n          // Format vehicle actor data to match feat structure for template compatibility\r\n          linkedVehicles.push({\r\n            _id: vehicleActor.id,\r\n            uuid: vehicleActor.uuid,\r\n            name: vehicleActor.name,\r\n            img: vehicleActor.img,\r\n            type: 'vehicle-actor',\r\n            system: {\r\n              featType: 'vehicle',\r\n              autopilot: vehicleActor.system?.attributes?.autopilot || 0,\r\n              structure: vehicleActor.system?.attributes?.structure || 0,\r\n              handling: vehicleActor.system?.attributes?.handling || 0,\r\n              speed: vehicleActor.system?.attributes?.speed || 0,\r\n              armor: vehicleActor.system?.attributes?.armor || 0,\r\n              weaponInfo: vehicleActor.system?.weaponInfo || '',\r\n              calculatedCost: vehicleActor.system?.calculatedCost || 0,\r\n              description: vehicleActor.system?.description || '',\r\n              level: vehicleLevel\r\n            },\r\n            weapons: vehicleWeapons, // Add weapons array to vehicle\r\n            hasSevereDamage: hasSevereDamage, // Add damage status for V2 template\r\n            isIncapacitating: isIncapacitating // Add incapacitating status for V2 template\r\n          });\r\n        }\r\n      } catch (error) {\r\n        console.warn(`Failed to load vehicle actor ${uuid}:`, error);\r\n      }\r\n    }\r\n    \r\n    // Group feats by type (vehicle feats + linked vehicle actors)\r\n    const vehicleFeats = allFeats.filter((feat: any) => feat.system.featType === 'vehicle');\r\n    \r\n    // Enrich cyberdecks with damage thresholds\r\n    const cyberdeckFeats = allFeats.filter((feat: any) => feat.system.featType === 'cyberdeck');\r\n    cyberdeckFeats.forEach((cyberdeck: any) => {\r\n      const firewall = cyberdeck.system.firewall || 1;\r\n      cyberdeck.cyberdeckDamageThresholds = {\r\n        light: firewall,\r\n        severe: firewall * 2,\r\n        incapacitating: firewall * 3\r\n      };\r\n      // Calculate base light damage boxes (2, or 3 if cyberdeckBonusLightDamage is checked)\r\n      const baseLightBoxes = (cyberdeck.system.cyberdeckBonusLightDamage === true) ? 3 : 2;\r\n      \r\n      // Ensure cyberdeckDamage exists\r\n      if (!cyberdeck.system.cyberdeckDamage) {\r\n        cyberdeck.system.cyberdeckDamage = {\r\n          light: Array(baseLightBoxes).fill(false),\r\n          severe: [false],\r\n          incapacitating: false\r\n        };\r\n      } else {\r\n        // Ensure arrays exist and have correct length\r\n        if (!Array.isArray(cyberdeck.system.cyberdeckDamage.light)) {\r\n          cyberdeck.system.cyberdeckDamage.light = Array(baseLightBoxes).fill(false);\r\n        } else {\r\n          // Adjust array size based on bonus\r\n          const currentLength = cyberdeck.system.cyberdeckDamage.light.length;\r\n          if (currentLength < baseLightBoxes) {\r\n            // Add missing boxes (preserve existing values)\r\n            while (cyberdeck.system.cyberdeckDamage.light.length < baseLightBoxes) {\r\n              cyberdeck.system.cyberdeckDamage.light.push(false);\r\n            }\r\n          } else if (currentLength > baseLightBoxes) {\r\n            // Remove excess boxes (from the end, preserve existing values)\r\n            while (cyberdeck.system.cyberdeckDamage.light.length > baseLightBoxes) {\r\n              cyberdeck.system.cyberdeckDamage.light.pop();\r\n            }\r\n          }\r\n        }\r\n        if (!Array.isArray(cyberdeck.system.cyberdeckDamage.severe)) {\r\n          cyberdeck.system.cyberdeckDamage.severe = [false];\r\n        }\r\n        if (typeof cyberdeck.system.cyberdeckDamage.incapacitating !== 'boolean') {\r\n          cyberdeck.system.cyberdeckDamage.incapacitating = false;\r\n        }\r\n      }\r\n    });\r\n    \r\n    context.featsByType = {\r\n      trait: allFeats.filter((feat: any) => feat.system.featType === 'trait'),\r\n      contact: allFeats.filter((feat: any) => feat.system.featType === 'contact'),\r\n      awakened: allFeats.filter((feat: any) => feat.system.featType === 'awakened'),\r\n      adeptPower: allFeats.filter((feat: any) => \r\n        feat.system.featType === 'adept-power' || \r\n        ((feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells') && feat.system.isAdeptPowerWeapon === true)\r\n      ),\r\n      equipment: allFeats.filter((feat: any) => feat.system.featType === 'equipment'),\r\n      armor: allFeats.filter((feat: any) => feat.system.featType === 'armor'),\r\n      cyberware: allFeats.filter((feat: any) => feat.system.featType === 'cyberware'),\r\n      cyberdeck: cyberdeckFeats,\r\n      vehicle: [...vehicleFeats, ...linkedVehicles], // Combine vehicle feats and linked vehicle actors\r\n      weaponsSpells: allFeats.filter((feat: any) => feat.system.featType === 'weapons-spells'),\r\n      weapon: allFeats.filter((feat: any) => feat.system.featType === 'weapon'),\r\n      spell: allFeats.filter((feat: any) => feat.system.featType === 'spell'),\r\n      connaissance: allFeats.filter((feat: any) => feat.system.featType === 'connaissance'),\r\n      power: allFeats.filter((feat: any) => feat.system.featType === 'power')\r\n    };\r\n    \r\n    // Enrich weapons with dice pool and RR calculations (for V2 template)\r\n    context.featsByType.weapon = context.featsByType.weapon.map((weapon: any) => {\r\n      const weaponSystem = weapon.system as any;\r\n      const weaponType = weaponSystem.weaponType;\r\n      \r\n      // Get weapon type and linked skills\r\n      let weaponLinkedSkill = '';\r\n      let weaponLinkedSpecialization = '';\r\n      \r\n      if (weaponType && weaponType !== 'custom-weapon') {\r\n        const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n        if (weaponStats) {\r\n          weaponLinkedSkill = weaponStats.linkedSkill || '';\r\n          weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\r\n        }\r\n      }\r\n      \r\n      // Get final linked skills (from weapon type or custom)\r\n      const finalAttackSkill = weaponLinkedSkill || weaponSystem.linkedAttackSkill || '';\r\n      const finalAttackSpec = weaponLinkedSpecialization || weaponSystem.linkedAttackSpecialization || '';\r\n      \r\n      // Determine default attribute: if skill not found, use agility (except for \"Combat rapproché\" which uses strength)\r\n      let defaultAttribute: string;\r\n      const skillExists = this.actor.items.some((i: any) => \r\n        i.type === 'skill' && \r\n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\r\n      );\r\n      \r\n      if (!skillExists && finalAttackSkill) {\r\n        // Skill not found: use agility, except for \"Combat rapproché\" which uses strength\r\n        const normalizedSkillName = ItemSearch.normalizeSearchText(finalAttackSkill);\r\n        if (normalizedSkillName === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          defaultAttribute = 'strength';\r\n        } else {\r\n          defaultAttribute = 'agility';\r\n        }\r\n      } else {\r\n        // Skill exists or no skill name: use strength (will be overridden by skill's linkedAttribute if skill found)\r\n        defaultAttribute = 'strength';\r\n      }\r\n      \r\n      // Find skill/spec using unified helper\r\n      const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        finalAttackSkill,\r\n        { defaultAttribute }\r\n      );\r\n      \r\n      // Calculate dice pool and RR using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        skillSpecResult,\r\n        weaponSystem.rrList || [],\r\n        weapon.name\r\n      );\r\n      \r\n      // Add dice pool and RR to weapon\r\n      weapon.totalDicePool = poolResult.totalDicePool;\r\n      weapon.rr = poolResult.totalRR;\r\n      \r\n      // Also store spec info for potential specialization display later\r\n      if (skillSpecResult.specName) {\r\n        weapon.attackSpecName = skillSpecResult.specName;\r\n        weapon.attackSpecLevel = skillSpecResult.specLevel;\r\n      }\r\n      \r\n      return weapon;\r\n    });\r\n    \r\n    // Enrich vehicle weapons with dice pool and RR calculations (for V2 template)\r\n    for (const vehicle of context.featsByType.vehicle) {\r\n      if (vehicle.type === 'vehicle-actor' && vehicle.weapons) {\r\n        vehicle.weapons = vehicle.weapons.map((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          \r\n          // For vehicle/drone weapons controlled by owner, use Ingénierie (Spé : Armes contrôlées à distance)\r\n          const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n            this.actor,\r\n            'Spé : Armes contrôlées à distance',\r\n            'Ingénierie',\r\n            { defaultAttribute: 'logic' }\r\n          );\r\n          \r\n          // Calculate dice pool and RR using unified helper\r\n          const poolResult = SheetHelpers.calculateAttackPool(\r\n            this.actor,\r\n            skillSpecResult,\r\n            weaponSystem.rrList || [],\r\n            weapon.name\r\n          );\r\n          \r\n          // Add dice pool and RR to weapon\r\n          weapon.totalDicePool = poolResult.totalDicePool;\r\n          weapon.rr = poolResult.totalRR;\r\n          \r\n          // Store skill/spec info for roll dialog preselect\r\n          weapon.linkedAttackSkill = 'Ingénierie';\r\n          weapon.linkedAttackSpecialization = 'Spé : Armes contrôlées à distance';\r\n          weapon.linkedDefenseSkill = 'Athlétisme';\r\n          weapon.linkedDefenseSpecialization = 'Spé : Défense à distance';\r\n          \r\n          return weapon;\r\n        });\r\n      }\r\n    }\r\n    \r\n    // Enrich spells with dice pool and RR calculations (for V2 template)\r\n    context.featsByType.spell = context.featsByType.spell.map((spell: any) => {\r\n      const spellSystem = spell.system as any;\r\n      \r\n      // Get spell specialization type and map it to the specialization name\r\n      const spellSpecType = spellSystem.spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      const finalAttackSpec = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n      \r\n      // Find skill/spec using unified helper\r\n      const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        'Sorcellerie',\r\n        { isSpell: true, spellSpecType, defaultAttribute: 'willpower' }\r\n      );\r\n      \r\n      // Calculate dice pool and RR using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        skillSpecResult,\r\n        spellSystem.rrList || [],\r\n        spell.name\r\n      );\r\n      \r\n      // Add dice pool and RR to spell\r\n      spell.totalDicePool = poolResult.totalDicePool;\r\n      spell.rr = poolResult.totalRR;\r\n      \r\n      // Also store spec info for potential specialization display later\r\n      if (skillSpecResult.specName) {\r\n        spell.attackSpecName = skillSpecResult.specName;\r\n        spell.attackSpecLevel = skillSpecResult.specLevel;\r\n      }\r\n      \r\n      return spell;\r\n    });\r\n    \r\n    // Enrich powers with dice pool and RR calculations (for V2 template)\r\n    context.featsByType.power = context.featsByType.power.map((power: any) => {\r\n      const powerSystem = power.system as any;\r\n      \r\n      // Get linked attack skill and specialization (used for the dice roll)\r\n      const linkedAttackSkill = powerSystem.linkedAttackSkill || '';\r\n      const linkedAttackSpec = powerSystem.linkedAttackSpecialization || '';\r\n      \r\n      // Determine default attribute: use strength as default\r\n      const defaultAttribute = 'strength';\r\n      \r\n      // Find skill/spec using unified helper\r\n      const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        linkedAttackSpec,\r\n        linkedAttackSkill,\r\n        { defaultAttribute }\r\n      );\r\n      \r\n      // Get all RR sources for the power\r\n      const rawPowerRRList = powerSystem.rrList || [];\r\n      const powerRRList = rawPowerRRList.map((rrEntry: any) => ({\r\n        ...rrEntry,\r\n        featName: power.name\r\n      }));\r\n      \r\n      // Calculate dice pool with all RR sources using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        skillSpecResult,\r\n        powerRRList,\r\n        power.name\r\n      );\r\n      \r\n      power.totalDicePool = poolResult.totalDicePool;\r\n      power.rr = poolResult.totalRR;\r\n      power.skillName = skillSpecResult.skillName;\r\n      power.specName = skillSpecResult.specName;\r\n      \r\n      return power;\r\n    });\r\n    \r\n    // Keep the feats array for backwards compatibility\r\n    context.feats = allFeats;\r\n    \r\n    // Get bookmarked items (skills, specializations, weapons, spells)\r\n    const bookmarkedItems = this.actor.items.filter((item: any) => \r\n      (item.type === 'skill' || item.type === 'specialization' || item.type === 'feat') && \r\n      item.system.bookmarked === true\r\n    );\r\n    context.bookmarkedItems = bookmarkedItems;\r\n    \r\n    // Get skills (sorted alphabetically)\r\n    const skills = this.actor.items\r\n      .filter((item: any) => item.type === 'skill')\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n    \r\n    // Get all specializations (sorted alphabetically)\r\n    const allSpecializations = this.actor.items\r\n      .filter((item: any) => item.type === 'specialization')\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n    \r\n    // Organize specializations by linked skill using helper\r\n    const { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations } = \r\n      SheetHelpers.organizeSpecializationsBySkill(allSpecializations, this.actor.items.contents);\r\n    \r\n    // Calculate RR for attributes first (needed for skills and specializations)\r\n    const attributesRR = {\r\n      strength: Math.min(3, this.calculateRR('attribute', 'strength')),\r\n      agility: Math.min(3, this.calculateRR('attribute', 'agility')),\r\n      willpower: Math.min(3, this.calculateRR('attribute', 'willpower')),\r\n      logic: Math.min(3, this.calculateRR('attribute', 'logic')),\r\n      charisma: Math.min(3, this.calculateRR('attribute', 'charisma'))\r\n    };\r\n    \r\n    // Add specializations to each skill and calculate RR\r\n    context.skills = skills.map((skill: any) => {\r\n      // Get linked attribute label for the skill\r\n      const linkedAttribute = skill.system?.linkedAttribute || 'strength';\r\n      skill.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\r\n      \r\n      // Calculate RR for this skill (skill RR + attribute RR, max 3)\r\n      const skillRR = this.calculateRR('skill', skill.name);\r\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\r\n      skill.rr = Math.min(3, skillRR + attributeRR);\r\n      \r\n      // Calculate total dice pool (attribute + skill rating)\r\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\r\n      const skillRating = skill.system?.rating || 0;\r\n      skill.totalDicePool = attributeValue + skillRating;\r\n      \r\n      // Get specializations for this skill and add calculated ratings (sorted alphabetically)\r\n      const specs = (specializationsBySkill.get(skill.id) || []).sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n      skill.specializations = specs.map((spec: any) => {\r\n        const parentRating = skill.system?.rating || 0;\r\n        // Add properties directly to the spec object instead of creating a new one\r\n        spec.parentRating = parentRating;\r\n        spec.effectiveRating = parentRating + 2;  // Specialization adds +2 to skill rating\r\n        spec.parentSkillName = skill.name;\r\n        \r\n        // Get linked attribute label for the specialization\r\n        const specLinkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n        spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${specLinkedAttribute.toUpperCase()}`);\r\n        \r\n        // Calculate RR for this specialization (attribute RR + skill RR + spec RR, max 3)\r\n        const specRR = this.calculateRR('specialization', spec.name);\r\n        const specAttributeRR = (attributesRR as any)[specLinkedAttribute] || 0;\r\n        const parentSkillRR = skillRR; // RR of the parent skill\r\n        spec.rr = Math.min(3, specAttributeRR + parentSkillRR + specRR);\r\n        \r\n        // Calculate total dice pool (attribute + effective rating)\r\n        const specAttributeValue = (this.actor.system as any).attributes[specLinkedAttribute] || 0;\r\n        spec.totalDicePool = specAttributeValue + spec.effectiveRating;\r\n        \r\n        return spec;\r\n      });\r\n      return skill;\r\n    });\r\n    \r\n    // Add unlinked specializations with attribute labels and RR (sorted alphabetically)\r\n    context.unlinkedSpecializations = unlinkedSpecializations\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name))\r\n      .map((spec: any) => {\r\n      const linkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n      spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\r\n      \r\n      // Calculate RR for this specialization (spec RR + attribute RR, max 3)\r\n      // Note: unlinked specializations don't have a parent skill, so only attribute + spec RR\r\n      const specRR = this.calculateRR('specialization', spec.name);\r\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\r\n      spec.rr = Math.min(3, specRR + attributeRR);\r\n      \r\n      // Calculate total dice pool (attribute only, since no skill linked)\r\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\r\n      spec.totalDicePool = attributeValue;\r\n      \r\n      return spec;\r\n    });\r\n    \r\n    // Store attributesRR in context\r\n    context.attributesRR = attributesRR;\r\n\r\n    // Add active section for navigation\r\n    context.activeSection = this._activeSection;\r\n\r\n    // Check if actor has severe damage (at least one severe damage box checked)\r\n    const damage = systemData.damage || {};\r\n    const severeDamage = Array.isArray(damage.severe) ? damage.severe : [false];\r\n    context.hasSevereDamage = severeDamage.some((box: boolean) => box === true);\r\n\r\n    return context;\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.skill-search');\r\n    $(document).off('click.feat-search');\r\n    return super.close(options);\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Switch sheet button\r\n    html.find('[data-action=\"switch-sheet\"]').on('click', this._onSwitchSheet.bind(this));\r\n\r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n\r\n    // Edit metatype\r\n    html.find('[data-action=\"edit-metatype\"]').on('click', this._onEditMetatype.bind(this));\r\n    \r\n    // Delete metatype\r\n    html.find('[data-action=\"delete-metatype\"]').on('click', this._onDeleteMetatype.bind(this));\r\n\r\n    // Edit feat\r\n    html.find('[data-action=\"edit-feat\"]').on('click', this._onEditFeat.bind(this));\r\n\r\n    // Delete feat\r\n    html.find('[data-action=\"delete-feat\"]').on('click', this._onDeleteFeat.bind(this));\r\n\r\n    // Open vehicle sheet\r\n    html.find('[data-action=\"open-vehicle\"]').on('click', this._onOpenVehicle.bind(this));\r\n\r\n    // Unlink vehicle\r\n    html.find('[data-action=\"unlink-vehicle\"]').on('click', this._onUnlinkVehicle.bind(this));\r\n\r\n    // Edit skill\r\n    html.find('[data-action=\"edit-skill\"]').on('click', this._onEditSkill.bind(this));\r\n\r\n    // Delete skill\r\n    html.find('[data-action=\"delete-skill\"]').on('click', this._onDeleteSkill.bind(this));\r\n\r\n    // Edit specialization\r\n    html.find('[data-action=\"edit-specialization\"]').on('click', this._onEditSpecialization.bind(this));\r\n\r\n    // Delete specialization\r\n    html.find('[data-action=\"delete-specialization\"]').on('click', this._onDeleteSpecialization.bind(this));\r\n\r\n    // Roll attribute\r\n    html.find('[data-action=\"roll-attribute\"]').on('click', this._onRollAttribute.bind(this));\r\n\r\n    // Roll skill\r\n    html.find('[data-action=\"roll-skill\"]').on('click', this._onRollSkill.bind(this));\r\n\r\n    // Quick roll skill (from dice badge)\r\n    html.find('[data-action=\"quick-roll-skill\"]').on('click', this._onQuickRollSkill.bind(this));\r\n\r\n    // Roll specialization\r\n    html.find('[data-action=\"roll-specialization\"]').on('click', this._onRollSpecialization.bind(this));\r\n\r\n    // Quick roll specialization (from dice badge)\r\n    html.find('[data-action=\"quick-roll-specialization\"]').on('click', this._onQuickRollSpecialization.bind(this));\r\n\r\n    // Send catchphrase to chat\r\n    html.find('[data-action=\"send-catchphrase\"]').on('click', this._onSendCatchphrase.bind(this));\r\n    \r\n    // Toggle bookmark - use event delegation to work with dynamically rendered items\r\n    html.on('click', '[data-action=\"toggle-bookmark\"]', this._onToggleBookmark.bind(this));\r\n    \r\n    // Click on bookmarked item in header\r\n    html.find('.bookmark-item').on('click', this._onBookmarkItemClick.bind(this));\r\n    \r\n    // Handle damage tracker checkboxes - explicit handler to ensure data is saved\r\n    html.find('input[name^=\"system.damage\"]').on('change', this._onDamageChange.bind(this));\r\n    html.find('input[name^=\"system.anarchySpent\"]').on('change', this._onAnarchyChange.bind(this));\r\n    \r\n    // Handle cyberdeck damage tracker checkboxes\r\n    html.find('input[name*=\".cyberdeckDamage.\"]').on('change', this._onCyberdeckDamageChange.bind(this));\r\n\r\n    // Roll weapon\r\n    html.find('[data-action=\"roll-weapon\"]').on('click', this._onRollWeapon.bind(this));\r\n\r\n    // Roll spell\r\n    html.find('[data-action=\"roll-spell\"]').on('click', this._onRollSpell.bind(this));\r\n\r\n    // Roll power\r\n    html.find('[data-action=\"roll-power\"]').on('click', this._onRollPower.bind(this));\r\n\r\n    // Roll weapon/spell (old type)\r\n    html.find('[data-action=\"roll-weapon-spell\"]').on('click', this._onRollWeaponSpell.bind(this));\r\n\r\n    // Roll vehicle weapon (mounted weapon using character skills)\r\n    html.find('[data-action=\"roll-vehicle-weapon\"]').on('click', this._onRollVehicleWeaponFromSheet.bind(this));\r\n    \r\n    // Roll vehicle weapon with autopilot\r\n    html.find('[data-action=\"roll-vehicle-weapon-autopilot\"]').on('click', this._onRollVehicleWeaponAutopilot.bind(this));\r\n    \r\n    // Roll vehicle autopilot\r\n    html.find('[data-action=\"roll-vehicle-autopilot\"]').on('click', this._onRollVehicleAutopilot.bind(this));\r\n\r\n    // Handle rating changes\r\n    html.find('.rating-input').on('change', this._onRatingChange.bind(this));\r\n\r\n    // Skill search\r\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\r\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\r\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\r\n    \r\n    // Close skill search results when clicking outside\r\n    $(document).on('click.skill-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\r\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\r\n        html.find('.skill-search-results').hide();\r\n      }\r\n    });\r\n\r\n    // Feat search\r\n    html.find('.feat-search-input').on('input', this._onFeatSearch.bind(this));\r\n    html.find('.feat-search-input').on('focus', this._onFeatSearchFocus.bind(this));\r\n    html.find('.feat-search-input').on('blur', this._onFeatSearchBlur.bind(this));\r\n    \r\n    // Close feat search results when clicking outside\r\n    $(document).on('click.feat-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const featSearchContainer = html.find('.feat-search-container')[0] as HTMLElement;\r\n      if (featSearchContainer && !featSearchContainer.contains(target)) {\r\n        html.find('.feat-search-results').hide();\r\n      }\r\n    });\r\n\r\n    // Make feat items draggable\r\n    html.find('.feat-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make skill items draggable\r\n    html.find('.skill-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make specialization items draggable\r\n    html.find('.specialization-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make vehicle actor items draggable\r\n    html.find('.vehicle-actor-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    // Expand form data (handles nested properties like \"system.attribute.strength\")\r\n    const expandedData = foundry.utils.expandObject(formData) as any;\r\n    // Don't process damage here - _onDamageChange handles it directly\r\n    // Remove damage from expandedData if present to avoid conflicts\r\n    if (expandedData.system?.damage !== undefined) {\r\n      delete expandedData.system.damage;\r\n    }\r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    const section = SheetHelpers.handleSectionNavigation(event, this.form as HTMLElement);\r\n    if (section) {\r\n      this._activeSection = section;\r\n    }\r\n  }\r\n\r\n  // Generic item handlers using SheetHelpers\r\n  private async _onEditMetatype(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteMetatype(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor, this.render.bind(this)); }\r\n  private async _onEditFeat(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteFeat(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n  private async _onEditSkill(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteSkill(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n  private async _onEditSpecialization(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteSpecialization(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n\r\n  /**\r\n   * Handle opening a linked vehicle actor sheet\r\n   */\r\n  private async _onOpenVehicle(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) return;\r\n    \r\n    try {\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (vehicleActor && vehicleActor.sheet) {\r\n        vehicleActor.sheet.render(true);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error opening vehicle sheet:', error);\r\n      ui.notifications?.error('Erreur lors de l\\'ouverture de la fiche du véhicule');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle unlinking a vehicle actor from the character\r\n   */\r\n  private async _onUnlinkVehicle(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) return;\r\n    \r\n    const linkedVehicles = (this.actor.system as any).linkedVehicles || [];\r\n    const updatedLinkedVehicles = linkedVehicles.filter((uuid: string) => uuid !== vehicleUuid);\r\n    \r\n    await this.actor.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n    \r\n    // Optionally unlink the vehicle's token prototype (set actorLink to false)\r\n    try {\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (vehicleActor) {\r\n        await vehicleActor.update({ 'prototypeToken.actorLink': false });\r\n      }\r\n    } catch (error) {\r\n      console.warn('Could not update vehicle token prototype:', error);\r\n      // Continue anyway - unlinking from character is more important\r\n    }\r\n    \r\n    ui.notifications?.info(game.i18n!.localize('SRA2.FEATS.VEHICLE_UNLINKED'));\r\n  }\r\n\r\n  /**\r\n   * Get detailed RR sources for a given skill, specialization, or attribute\r\n   */\r\n  private getRRSources(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\r\n    return SheetHelpers.getRRSources(this.actor, itemType, itemName);\r\n  }\r\n\r\n  /**\r\n   * Calculate Risk Reduction (RR) from active feats for a given skill, specialization, or attribute\r\n   */\r\n  private calculateRR(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\r\n    return SheetHelpers.calculateRR(this.actor, itemType, itemName);\r\n  }\r\n\r\n  /**\r\n   * Handle rating changes for items\r\n   */\r\n  private async _onRatingChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLInputElement;\r\n    const itemId = element.dataset.itemId;\r\n    const newRating = parseInt(element.value);\r\n    \r\n    if (!itemId || isNaN(newRating)) return;\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (item) {\r\n      await item.update({ system: { rating: newRating } } as any);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a specialization\r\n   */\r\n  private async _onRollSpecialization(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    const effectiveRating = parseInt(element.dataset.effectiveRating || '0');\r\n    \r\n    if (!itemId) return;\r\n\r\n    const specialization = this.actor.items.get(itemId);\r\n    if (!specialization || specialization.type !== 'specialization') return;\r\n\r\n    const specSystem = specialization.system as any;\r\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\r\n    const linkedSkillName = specSystem.linkedSkill;\r\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\r\n    \r\n    // Get the linked skill to get its rating\r\n    const linkedSkill = linkedSkillName ? this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName) : null;\r\n    const skillRating = linkedSkill ? (linkedSkill.system as any).rating || 0 : 0;\r\n    \r\n    // Get RR sources\r\n    const specRRSources = this.getRRSources('specialization', specialization.name);\r\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\r\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\r\n    const allRRSources = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'specialization',\r\n      itemName: specialization.name,\r\n      itemId: specialization.id,\r\n      specName: specialization.name,\r\n      specLevel: attributeValue + effectiveRating,  // Total dice pool (attribute + effectiveRating)\r\n      skillName: linkedSkillName,\r\n      skillLevel: skillRating,  // Just the skill rating (without attribute)\r\n      linkedAttribute: linkedAttribute,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: allRRSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle quick rolling a skill (from dice badge click) - opens dialog\r\n   */\r\n  private async _onQuickRollSkill(event: Event): Promise<void> {\r\n    // Simply call the regular roll skill function which opens the dialog\r\n    return this._onRollSkill(event);\r\n  }\r\n\r\n  /**\r\n   * Handle quick rolling a specialization (from dice badge click) - opens dialog\r\n   */\r\n  private async _onQuickRollSpecialization(event: Event): Promise<void> {\r\n    // Simply call the regular roll specialization function which opens the dialog\r\n    return this._onRollSpecialization(event);\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle rolling an attribute\r\n   */\r\n  private async _onRollAttribute(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const attributeName = element.dataset.attribute;\r\n    \r\n    if (!attributeName) return;\r\n\r\n    const attributeValue = (this.actor.system as any).attributes?.[attributeName] || 0;\r\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${attributeName.toUpperCase()}`);\r\n\r\n    // Get RR sources for this attribute\r\n    const rrSources = this.getRRSources('attribute', attributeName);\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'attribute',\r\n      itemName: attributeLabel,\r\n      skillName: attributeLabel,\r\n      skillLevel: attributeValue,\r\n      linkedAttribute: attributeName,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: rrSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a skill\r\n   */\r\n  private async _onRollSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) return;\r\n\r\n    const skill = this.actor.items.get(itemId);\r\n    if (!skill || skill.type !== 'skill') return;\r\n\r\n    const skillSystem = skill.system as any;\r\n    const rating = skillSystem.rating || 0;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\r\n\r\n    // Get RR sources for skill and attribute\r\n    const skillRRSources = this.getRRSources('skill', skill.name);\r\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\r\n    const allRRSources = [...skillRRSources, ...attributeRRSources];\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'skill',\r\n      itemName: skill.name,\r\n      itemId: skill.id,\r\n      itemRating: rating,\r\n      skillName: skill.name,\r\n      skillLevel: attributeValue + rating,  // Total dice pool (attribute + rating)\r\n      linkedAttribute: linkedAttribute,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: allRRSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Apply damage to a defender\r\n   * Delegates to CombatHelpers.applyDamage\r\n   */\r\n  static async applyDamage(defenderUuid: string, damageValue: number, defenderName: string, damageType: 'physical' | 'mental' = 'physical'): Promise<void> {\r\n    return CombatHelpers.applyDamage(defenderUuid, damageValue, defenderName, damageType);\r\n  }\r\n\r\n  /**\r\n   * Handle drag start for feat items and vehicle actors\r\n   * For vehicle actors, allow dragging them to the map\r\n   */\r\n  protected override _onDragStart(event: DragEvent): void {\r\n    const itemId = (event.currentTarget as HTMLElement).dataset.itemId;\r\n    const vehicleUuid = (event.currentTarget as HTMLElement).dataset.vehicleUuid;\r\n    \r\n    // Check if this is a linked vehicle actor\r\n    if (vehicleUuid) {\r\n      const dragData = {\r\n        type: 'Actor',\r\n        uuid: vehicleUuid,\r\n      };\r\n      event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n      return;\r\n    }\r\n    \r\n    if (!itemId) return;\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n\r\n    // Check if this is a vehicle feat that references a vehicle actor\r\n    if (item.type === 'feat' && (item.system as any).featType === 'vehicle') {\r\n      const vehicleActorUuid = (item.system as any).vehicleActorUuid;\r\n      if (vehicleActorUuid) {\r\n        // Allow dragging the vehicle actor to the map\r\n        const dragData = {\r\n          type: 'Actor',\r\n          uuid: vehicleActorUuid,\r\n        };\r\n        event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Default: drag the item itself\r\n    const dragData = {\r\n      type: 'Item',\r\n      uuid: item.uuid,\r\n    };\r\n\r\n    event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n  }\r\n\r\n  /**\r\n   * Override to handle dropping feats, skills, and vehicle actors anywhere on the sheet\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    // First try to handle item drops (feats, skills, etc.)\r\n    const handled = await SheetHelpers.handleItemDrop(event, this.actor);\r\n    if (handled) return undefined;\r\n    \r\n    // Then try to handle vehicle actor drops\r\n    const vehicleHandled = await SheetHelpers.handleVehicleActorDrop(event, this.actor);\r\n    if (vehicleHandled) return undefined;\r\n    \r\n    return super._onDrop(event);\r\n  }\r\n\r\n  /**\r\n   * Handle skill search input\r\n   */\r\n  private searchTimeout: any = null;\r\n  \r\n  private async _onSkillSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.searchTimeout) {\r\n      clearTimeout(this.searchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.searchTimeout = setTimeout(async () => {\r\n      await this._performSkillSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual skill search in compendiums and world items\r\n   */\r\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    // Store search term for potential creation\r\n    this.lastSearchTerm = searchTerm;\r\n    \r\n    // Use the helper function to search everywhere\r\n    const existingItemsCheck = (itemName: string) => \r\n      ItemSearch.itemExistsOnActor(this.actor, 'skill', itemName);\r\n    \r\n    const results = await ItemSearch.searchItemsEverywhere(\r\n      'skill',\r\n      searchTerm,\r\n      undefined,\r\n      existingItemsCheck\r\n    );\r\n    \r\n    // Display results\r\n    this._displaySkillSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display skill search results\r\n   */\r\n  private lastSearchTerm: string = '';\r\n  \r\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): void {\r\n    // Check if exact match exists on the actor\r\n    const formattedSearchTerm = this.lastSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatchOnActor = this.actor.items.find((i: any) => \r\n      i.type === 'skill' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SKILLS.CREATE_SKILL')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const disabledClass = result.alreadyExists ? 'disabled' : '';\r\n        const buttonText = result.alreadyExists ? '✓' : game.i18n!.localize('SRA2.SKILLS.ADD_SKILL');\r\n        \r\n        html += `\r\n          <div class=\"search-result-item ${disabledClass}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source}</span>\r\n            </div>\r\n            <button class=\"add-skill-btn\" data-uuid=\"${result.uuid}\" ${result.alreadyExists ? 'disabled' : ''}>\r\n              ${buttonText}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist on actor\r\n      if (!exactMatchOnActor) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SKILLS.CREATE_NEW')}</span>\r\n            </div>\r\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.SKILLS.CREATE')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers to buttons\r\n    $(resultsDiv).find('.add-skill-btn').on('click', this._onAddSkillFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\r\n    \r\n    // Make entire result items clickable (except disabled ones and create button)\r\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-skill-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-skill-btn')[0] as HTMLButtonElement;\r\n      if (button && !button.disabled) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle adding a skill from search results\r\n   */\r\n  private async _onAddSkillFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const uuid = button.dataset.uuid;\r\n    \r\n    if (!uuid) return;\r\n    \r\n    // Get the skill from the compendium\r\n    const skill = await fromUuid(uuid as any) as any;\r\n    \r\n    if (!skill) {\r\n      ui.notifications?.error('Skill not found');\r\n      return;\r\n    }\r\n    \r\n    // Check if skill already exists\r\n    const existingSkill = this.actor.items.find((i: any) => \r\n      i.type === 'skill' && i.name === skill.name\r\n    );\r\n    \r\n    if (existingSkill) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: skill.name }));\r\n      return;\r\n    }\r\n    \r\n    // Add the skill to the actor\r\n    await this.actor.createEmbeddedDocuments('Item', [skill.toObject()]);\r\n    \r\n    // Mark button as added\r\n    button.textContent = '✓';\r\n    button.disabled = true;\r\n    button.closest('.search-result-item')?.classList.add('disabled');\r\n    \r\n    ui.notifications?.info(`${skill.name} ${game.i18n!.localize('SRA2.SKILLS.ADD_SKILL')}`);\r\n  }\r\n\r\n  /**\r\n   * Handle skill search focus\r\n   */\r\n  private _onSkillSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle skill search blur\r\n   */\r\n  private _onSkillSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle creating a new skill from search\r\n   */\r\n  private async _onCreateNewSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = skillName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new skill with default values\r\n    const skillData = {\r\n      name: formattedName,\r\n      type: 'skill',\r\n      system: {\r\n        rating: 1,\r\n        linkedAttribute: 'strength',\r\n        description: ''\r\n      }\r\n    } as any;\r\n    \r\n    // Add the skill to the actor\r\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [skillData]) as any;\r\n    \r\n    if (createdItems && createdItems.length > 0) {\r\n      const newSkill = createdItems[0] as any;\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      // Open the skill sheet for editing\r\n      if (newSkill && newSkill.sheet) {\r\n        setTimeout(() => {\r\n          newSkill.sheet.render(true);\r\n        }, 100);\r\n      }\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.SKILL_CREATED', { name: formattedName }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * FEAT SEARCH FUNCTIONS\r\n   */\r\n  \r\n  private featSearchTimeout: any = null;\r\n  private lastFeatSearchTerm: string = '';\r\n  \r\n  /**\r\n   * Handle feat search input\r\n   */\r\n  private async _onFeatSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.featSearchTimeout) {\r\n      clearTimeout(this.featSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.featSearchTimeout = setTimeout(async () => {\r\n      await this._performFeatSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual feat search in compendiums and world items\r\n   */\r\n  private async _performFeatSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    // Store search term for potential creation\r\n    this.lastFeatSearchTerm = searchTerm;\r\n    \r\n    // Use searchItemsEverywhere to search across actor, world, and compendiums\r\n    const searchResults = await ItemSearch.searchItemsEverywhere(\r\n      'feat',\r\n      searchTerm,\r\n      this.actor,\r\n      (itemName: string) => {\r\n        // Check if feat already exists on actor\r\n        return this.actor.items.some((i: any) => \r\n          i.type === 'feat' && i.name === itemName\r\n        );\r\n      }\r\n    );\r\n    \r\n    // Convert SearchResult[] to the format expected by _displayFeatSearchResults\r\n    const results: any[] = [];\r\n    for (const result of searchResults) {\r\n      // Get the item to access featType\r\n      let featType = '';\r\n      try {\r\n        const item = await fromUuid(result.uuid as any);\r\n        if (item && (item as any).system) {\r\n          featType = (item as any).system.featType || '';\r\n        }\r\n      } catch (error) {\r\n        console.warn('Could not load item for featType:', error);\r\n      }\r\n      \r\n      results.push({\r\n        name: result.name,\r\n        uuid: result.uuid,\r\n        pack: result.source,\r\n        featType: featType,\r\n        exists: result.alreadyExists || false\r\n      });\r\n    }\r\n    \r\n    // Display results\r\n    this._displayFeatSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display feat search results\r\n   */\r\n  private _displayFeatSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\r\n    // Check if exact match exists on the actor\r\n    const formattedSearchTerm = this.lastFeatSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatchOnActor = this.actor.items.find((i: any) => \r\n      i.type === 'feat' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastFeatSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message and type selector\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.FEATS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <select class=\"feat-type-selector\">\r\n            <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\r\n            <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\r\n            <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\r\n            <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\r\n            <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\r\n            <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\r\n            <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\r\n            <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\r\n            <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\r\n            <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\r\n            <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\r\n            <option value=\"connaissance\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONNAISSANCE')}</option>\r\n          </select>\r\n          <button class=\"create-feat-btn\" data-feat-name=\"${this.lastFeatSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.FEATS.CREATE')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const disabledClass = result.exists ? 'disabled' : '';\r\n        const buttonText = result.exists ? '✓' : game.i18n!.localize('SRA2.FEATS.ADD_FEAT');\r\n        const featTypeLabel = game.i18n!.localize(`SRA2.FEATS.FEAT_TYPE.${result.featType.toUpperCase().replace('-', '_')}`);\r\n        \r\n        html += `\r\n          <div class=\"search-result-item ${disabledClass}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.pack} - ${featTypeLabel}</span>\r\n            </div>\r\n            <button class=\"add-feat-btn\" data-uuid=\"${result.uuid}\" ${result.exists ? 'disabled' : ''}>\r\n              ${buttonText}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist on actor\r\n      if (!exactMatchOnActor) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.FEATS.CREATE_NEW')}</span>\r\n            </div>\r\n            <select class=\"feat-type-selector-inline\">\r\n              <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\r\n              <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\r\n              <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\r\n              <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\r\n              <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\r\n              <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\r\n              <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\r\n              <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\r\n              <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\r\n              <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\r\n              <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\r\n            </select>\r\n            <button class=\"create-feat-btn-inline\" data-feat-name=\"${this.lastFeatSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.CREATE')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers\r\n    $(resultsDiv).find('.add-feat-btn').on('click', this._onAddFeatFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-feat-btn, .create-feat-btn-inline').on('click', this._onCreateNewFeat.bind(this));\r\n    \r\n    // Make entire result items clickable (except disabled ones and create button)\r\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-feat-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-feat-btn')[0] as HTMLButtonElement;\r\n      if (button && !button.disabled) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button or select\r\n      if ($(event.target).closest('.create-feat-btn-inline, .feat-type-selector-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-feat-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle adding a feat from search results\r\n   */\r\n  private async _onAddFeatFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const uuid = button.dataset.uuid;\r\n    \r\n    if (!uuid) return;\r\n    \r\n    // Get the feat from the compendium\r\n    const feat = await fromUuid(uuid as any) as any;\r\n    \r\n    if (!feat) {\r\n      ui.notifications?.error('Feat not found');\r\n      return;\r\n    }\r\n    \r\n    // Check if feat already exists\r\n    const existingFeat = this.actor.items.find((i: any) => \r\n      i.type === 'feat' && i.name === feat.name\r\n    );\r\n    \r\n    if (existingFeat) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: feat.name }));\r\n      return;\r\n    }\r\n    \r\n    // Add the feat to the actor\r\n    await this.actor.createEmbeddedDocuments('Item', [feat.toObject()]);\r\n    \r\n    // Mark button as added\r\n    button.textContent = '✓';\r\n    button.disabled = true;\r\n    button.closest('.search-result-item')?.classList.add('disabled');\r\n    \r\n    ui.notifications?.info(`${feat.name} ${game.i18n!.localize('SRA2.FEATS.ADD_FEAT')}`);\r\n  }\r\n\r\n  /**\r\n   * Handle feat search focus\r\n   */\r\n  private _onFeatSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle feat search blur\r\n   */\r\n  private _onFeatSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any select element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if a select or other element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle sending a catchphrase to chat\r\n   */\r\n  private async _onSendCatchphrase(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const catchphrase = element.dataset.catchphrase;\r\n    \r\n    if (!catchphrase) return;\r\n\r\n    // Create the chat message\r\n    const messageData = {\r\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\r\n      content: `<div class=\"sra2-catchphrase\">${catchphrase}</div>`\r\n    };\r\n    \r\n    await ChatMessage.create(messageData as any);\r\n  }\r\n  \r\n  /**\r\n   * Handle damage tracker checkbox changes\r\n   */\r\n  private async _onDamageChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Get current damage from actor data (read from _source for persisted values)\r\n    const actorSource = (this.actor as any)._source;\r\n    const currentDamage = actorSource?.system?.damage || (this.actor.system as any).damage || {\r\n      light: [false, false],\r\n      severe: [false],\r\n      incapacitating: false\r\n    };\r\n    \r\n    // Use helper to parse and update damage\r\n    const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n    if (!updatedDamage) return;\r\n    \r\n    // Update the actor with the complete damage object\r\n    await this.actor.update({\r\n      'system.damage': updatedDamage\r\n    } as any, { render: false });\r\n    \r\n    // Force re-render to update CSS classes in template\r\n    this.render(false);\r\n  }\r\n  \r\n  /**\r\n   * Handle cyberdeck damage tracker checkbox changes\r\n   */\r\n  private async _onCyberdeckDamageChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Extract item ID from name (format: items.{itemId}.system.cyberdeckDamage.xxx)\r\n    const itemIdMatch = name.match(/^items\\.([^.]+)\\./);\r\n    if (!itemIdMatch || !itemIdMatch[1]) return;\r\n    \r\n    const itemId = itemIdMatch[1];\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    // Get current cyberdeckDamage from item data (read from _source for persisted values)\r\n    const itemSource = (item as any)._source;\r\n    const currentDamage = itemSource?.system?.cyberdeckDamage || (item.system as any).cyberdeckDamage || {\r\n      light: [false, false],\r\n      severe: [false],\r\n      incapacitating: false\r\n    };\r\n    \r\n    // Use helper to parse and update damage\r\n    const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n    if (!updatedDamage) return;\r\n    \r\n    // Update the item with the complete cyberdeckDamage object\r\n    await item.update({\r\n      'system.cyberdeckDamage': updatedDamage\r\n    } as any, { render: false });\r\n    \r\n    // Force re-render to update CSS classes in template\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle anarchy tracker checkbox changes\r\n   */\r\n  private async _onAnarchyChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Parse the name to extract the index\r\n    // Expected format: system.anarchySpent.0, system.anarchySpent.1, etc.\r\n    const match = name.match(/^system\\.anarchySpent\\.(\\d+)$/);\r\n    if (!match || !match[1]) return;\r\n    \r\n    const index = parseInt(match[1], 10);\r\n    \r\n    // Ensure anarchySpent array exists\r\n    const currentAnarchySpent = (this.actor.system as any).anarchySpent || [false, false, false];\r\n    const anarchySpent = [...currentAnarchySpent];\r\n    \r\n    // Ensure array has minimum length\r\n    while (anarchySpent.length < 3) {\r\n      anarchySpent.push(false);\r\n    }\r\n    \r\n    // Update the appropriate index\r\n    if (index >= 0 && index < anarchySpent.length) {\r\n      anarchySpent[index] = checked;\r\n      \r\n      // Update the actor\r\n      await (this.actor as any).update({ 'system.anarchySpent': anarchySpent }, { render: false });\r\n      \r\n      // Force re-render to update CSS classes in template (e.g., {{#if this}}checked{{/if}})\r\n      this.render(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Handle toggling bookmark on an item\r\n   */\r\n  private async _onToggleBookmark(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    event.stopImmediatePropagation();\r\n    \r\n    // With event delegation, find the closest element with data-action=\"toggle-bookmark\"\r\n    const target = event.target as HTMLElement;\r\n    let element = target.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\r\n    \r\n    // If target is the icon itself, get the parent link\r\n    if (!element && target.tagName === 'I' && target.parentElement) {\r\n      element = target.parentElement as HTMLElement;\r\n      if (!element.hasAttribute('data-action')) {\r\n        element = element.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\r\n      }\r\n    }\r\n    \r\n    if (!element) return;\r\n    \r\n    const itemId = element.dataset.itemId;\r\n    if (!itemId) return;\r\n    \r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    const currentBookmarkState = (item.system as any).bookmarked || false;\r\n    \r\n    try {\r\n      await (item as any).update({ 'system.bookmarked': !currentBookmarkState });\r\n      // Re-render to update UI\r\n      this.render(false);\r\n    } catch (error) {\r\n      console.error('Error toggling bookmark:', error);\r\n      ui.notifications?.error(game.i18n?.localize('SRA2.BOOKMARKS.ERROR') || 'Erreur lors de la mise à jour du bookmark');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Handle clicking on a bookmarked item in the header\r\n   */\r\n  private async _onBookmarkItemClick(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    const itemType = element.dataset.itemType;\r\n    \r\n    if (!itemId) return;\r\n    \r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    // Roll the item based on its type\r\n    if (itemType === 'skill') {\r\n      // Call _onRollSkill with a fake event containing the item ID\r\n      const fakeEvent = { \r\n        preventDefault: () => {}, \r\n        currentTarget: { dataset: { itemId: itemId } } \r\n      } as any;\r\n      await this._onRollSkill(fakeEvent);\r\n    } else if (itemType === 'specialization') {\r\n      // Find the effective rating for this specialization\r\n      const specSystem = item.system as any;\r\n      const linkedSkillName = specSystem.linkedSkill;\r\n      const parentSkill = this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName);\r\n      const effectiveRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n      \r\n      const fakeEvent = { \r\n        preventDefault: () => {}, \r\n        currentTarget: { \r\n          dataset: { \r\n            itemId: itemId,\r\n            effectiveRating: effectiveRating.toString()\r\n          } \r\n        } \r\n      } as any;\r\n      await this._onRollSpecialization(fakeEvent);\r\n    } else if (itemType === 'feat') {\r\n      const featType = (item.system as any).featType;\r\n      if (featType === 'weapon') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollWeapon(fakeEvent);\r\n      } else if (featType === 'spell') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollSpell(fakeEvent);\r\n      } else if (featType === 'weapons-spells') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollWeaponSpell(fakeEvent);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon from the character sheet\r\n   */\r\n  private async _onRollVehicleWeaponFromSheet(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    const weaponId = element.dataset.weaponId;\r\n    \r\n    if (!vehicleUuid || !weaponId) {\r\n      console.error(\"SRA2 | Missing vehicle UUID or weapon ID\");\r\n      return;\r\n    }\r\n    \r\n    await this._onRollVehicleWeapon(vehicleUuid, weaponId);\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon using autopilot\r\n   */\r\n  private async _onRollVehicleWeaponAutopilot(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    const weaponId = element.dataset.weaponId;\r\n    \r\n    if (!vehicleUuid || !weaponId) {\r\n      console.error(\"SRA2 | Missing vehicle UUID or weapon ID\");\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      // Get weapon from vehicle\r\n      const weapon = vehicleActor.items.get(weaponId);\r\n      if (!weapon || (weapon.system as any).featType !== 'weapon') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_WEAPON'));\r\n        return;\r\n      }\r\n      \r\n      const autopilot = (vehicleActor.system as any)?.attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      // Prepare complete weapon roll request data using combat-helpers\r\n      const rollRequestData = CombatHelpers.prepareVehicleWeaponRollRequest(\r\n        vehicleActor,\r\n        weapon,\r\n        WEAPON_TYPES\r\n      );\r\n      \r\n      // Call dice roller with prepared data\r\n      DiceRoller.handleRollRequest(rollRequestData);\r\n    } catch (error) {\r\n      console.error(\"SRA2 | Error rolling vehicle weapon with autopilot:\", error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling vehicle autopilot\r\n   */\r\n  private async _onRollVehicleAutopilot(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) {\r\n      console.error(\"SRA2 | Missing vehicle UUID\");\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      const autopilot = (vehicleActor.system as any)?.attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      const vehicleName = vehicleActor.name || 'Véhicule';\r\n      const autopilotLabel = game.i18n!.localize('SRA2.FEATS.VEHICLE.AUTOPILOT_SHORT');\r\n      \r\n      // Get RR sources for autopilot (from vehicle's RR sources if any)\r\n      const rrSources: Array<{featName: string, rrValue: number, rrType?: string, rrTarget?: string}> = [];\r\n      \r\n      DiceRoller.handleRollRequest({\r\n        itemType: 'attribute',\r\n        itemName: `${autopilotLabel} (${vehicleName})`,\r\n        skillName: autopilotLabel,\r\n        skillLevel: autopilot,\r\n        linkedAttribute: 'autopilot',\r\n        actorId: vehicleActor.id,\r\n        actorUuid: vehicleActor.uuid,\r\n        actorName: vehicleName,\r\n        rrList: rrSources\r\n      });\r\n    } catch (error) {\r\n      console.error(\"SRA2 | Error rolling vehicle autopilot:\", error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon (mounted weapon) using character stats\r\n   */\r\n  private async _onRollVehicleWeapon(vehicleUuid: string, weaponId: string): Promise<void> {\r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      // Get weapon from vehicle\r\n      const weapon = vehicleActor.items.get(weaponId);\r\n      if (!weapon || (weapon.system as any).featType !== 'weapon') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_WEAPON'));\r\n        return;\r\n      }\r\n      \r\n      // Use _rollWeaponOrSpell logic but with character stats and CRR\r\n      const itemSystem = weapon.system as any;\r\n      const weaponType = itemSystem.weaponType;\r\n      \r\n      // Get CRR (Contrôle Récupération Réduction) for mounted weapons\r\n      const crr = itemSystem.crr || 0;\r\n      \r\n      // Get item RR list\r\n      const rawItemRRList = itemSystem.rrList || [];\r\n      const itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n        ...rrEntry,\r\n        featName: weapon.name\r\n      }));\r\n      \r\n      // For vehicle/drone weapons controlled by owner, use Ingénierie (Spé : Armes contrôlées à distance)\r\n      const finalAttackSkill = 'Ingénierie';\r\n      const finalAttackSpec = 'Spé : Armes contrôlées à distance';\r\n      \r\n      // Defense is always Athlétisme (Spé : Défense à distance) for drone weapons\r\n      const finalDefenseSkill = 'Athlétisme';\r\n      const finalDefenseSpec = 'Spé : Défense à distance';\r\n      \r\n      // Find character's attack skill and specialization using unified helper\r\n      const attackSkillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        finalAttackSkill,\r\n        { defaultAttribute: 'logic' }\r\n      );\r\n      \r\n      const attackSkillName = attackSkillSpecResult.skillName;\r\n      const attackSkillLevel = attackSkillSpecResult.skillLevel;\r\n      const attackSpecName = attackSkillSpecResult.specName;\r\n      const attackSpecLevel = attackSkillSpecResult.specLevel;\r\n      const attackLinkedAttribute = attackSkillSpecResult.linkedAttribute;\r\n      \r\n      // Find character's defense skill and specialization using unified helper\r\n      const defenseSkillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalDefenseSpec,\r\n        finalDefenseSkill,\r\n        { defaultAttribute: 'agility' }\r\n      );\r\n      \r\n      const defenseSkillName = defenseSkillSpecResult.skillName;\r\n      const defenseSkillLevel = defenseSkillSpecResult.skillLevel;\r\n      const defenseSpecName = defenseSkillSpecResult.specName;\r\n      const defenseSpecLevel = defenseSkillSpecResult.specLevel;\r\n      const defenseLinkedAttribute = defenseSkillSpecResult.linkedAttribute;\r\n      \r\n      // Calculate final damage value using helper\r\n      const baseDamageValue = itemSystem.damageValue || '0';\r\n      let damageValueBonus = itemSystem.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      const activeFeats = this.actor.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.active === true &&\r\n        item.system.weaponDamageBonus > 0 &&\r\n        item.system.weaponTypeBonus === weaponType\r\n      );\r\n      \r\n      activeFeats.forEach((activeFeat: any) => {\r\n        damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n      });\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      const finalDamageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n      \r\n      // Calculate attack pool with all RR sources using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        attackSkillSpecResult,\r\n        itemRRList,\r\n        weapon.name\r\n      );\r\n      const allRRSources = poolResult.allRRSources;\r\n      \r\n      // Add CRR as a special RR entry if > 0\r\n      if (crr > 0) {\r\n        allRRSources.push({\r\n          rrType: 'attribute',\r\n          rrValue: crr,\r\n          rrTarget: 'CRR',\r\n          featName: weapon.name\r\n        });\r\n      }\r\n      \r\n      DiceRoller.handleRollRequest({\r\n        itemType: 'weapon',\r\n        weaponType: weaponType,\r\n        itemName: `${weapon.name} (${vehicleActor.name})`,\r\n        itemId: weapon.id,\r\n        itemRating: itemSystem.rating || 0,\r\n        itemActive: itemSystem.active,\r\n        \r\n        // Merged linked skills (for fallback selection in dialog)\r\n        linkedAttackSkill: finalAttackSkill, // 'Ingénierie'\r\n        linkedAttackSpecialization: finalAttackSpec, // 'Spé : Armes contrôlées à distance'\r\n        linkedDefenseSkill: finalDefenseSkill, // 'Athlétisme'\r\n        linkedDefenseSpecialization: finalDefenseSpec, // 'Spé : Défense à distance'\r\n        linkedAttribute: attackLinkedAttribute,\r\n        \r\n        // Weapon properties\r\n        isWeaponFocus: itemSystem.isWeaponFocus || false,\r\n        damageValue: finalDamageValue,\r\n        meleeRange: itemSystem.meleeRange,\r\n        shortRange: itemSystem.shortRange,\r\n        mediumRange: itemSystem.mediumRange,\r\n        longRange: itemSystem.longRange,\r\n        \r\n        // Attack skill/spec from character (based on weapon links) - these are used for selection\r\n        skillName: attackSkillName,\r\n        skillLevel: attackSkillLevel,\r\n        specName: attackSpecName,\r\n        specLevel: attackSpecLevel,\r\n        \r\n        // Defense skill/spec from character (based on weapon links) - these are used for defense selection\r\n        defenseSkillName: defenseSkillName,\r\n        defenseSkillLevel: defenseSkillLevel,\r\n        defenseSpecName: defenseSpecName,\r\n        defenseSpecLevel: defenseSpecLevel,\r\n        defenseLinkedAttribute: defenseLinkedAttribute,\r\n        \r\n        // Actor information (character, not vehicle)\r\n        actorId: this.actor.id,\r\n        actorUuid: this.actor.uuid,\r\n        actorName: this.actor.name || '',\r\n        \r\n        // RR List (merged: item RR + skill/spec/attribute RR + CRR)\r\n        rrList: allRRSources,\r\n        \r\n        // Mark as vehicle weapon\r\n        isVehicleWeapon: true,\r\n        vehicleUuid: vehicleUuid,\r\n        vehicleName: vehicleActor.name\r\n      });\r\n    } catch (error) {\r\n      console.error('Error rolling vehicle weapon:', error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a weapon\r\n   */\r\n  private async _onRollWeapon(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No weapon ID found\");\r\n      return;\r\n    }\r\n\r\n    const weapon = this.actor.items.get(itemId);\r\n    if (!weapon || weapon.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(weapon, 'weapon');\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a spell\r\n   */\r\n  private async _onRollSpell(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No spell ID found\");\r\n      return;\r\n    }\r\n\r\n    const spell = this.actor.items.get(itemId);\r\n    if (!spell || spell.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(spell, 'spell');\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a power\r\n   */\r\n  private async _onRollPower(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No power ID found\");\r\n      return;\r\n    }\r\n\r\n    const power = this.actor.items.get(itemId);\r\n    if (!power || power.type !== 'feat') return;\r\n\r\n    await this._rollPower(power);\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a weapon/spell (old type)\r\n   */\r\n  private async _onRollWeaponSpell(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No weapon/spell ID found\");\r\n      return;\r\n    }\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item || item.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(item, 'weapon-spell');\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle rolling a weapon or spell\r\n   */\r\n  private async _rollWeaponOrSpell(item: any, type: 'weapon' | 'spell' | 'weapon-spell'): Promise<void> {\r\n    const itemSystem = item.system as any;\r\n    \r\n    // Check if this is a spell and get spell type\r\n    const isSpell = type === 'spell';\r\n    const spellType = isSpell ? (itemSystem.spellType || 'indirect') : null;\r\n    \r\n    // Get weapon type and linked skills\r\n    const weaponType = itemSystem.weaponType;\r\n    let weaponLinkedSkill = '';\r\n    let weaponLinkedSpecialization = '';\r\n    let weaponLinkedDefenseSkill = '';\r\n    let weaponLinkedDefenseSpecialization = '';\r\n    \r\n    if (weaponType && weaponType !== 'custom-weapon') {\r\n      // Pre-defined weapon: get from WEAPON_TYPES\r\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n      if (weaponStats) {\r\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\r\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\r\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\r\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\r\n      }\r\n    }\r\n\r\n    // Get all RR sources for the item and enrich with featName\r\n    const rawItemRRList = itemSystem.rrList || [];\r\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n      ...rrEntry,\r\n      featName: item.name  // Add featName (the item name itself)\r\n    }));\r\n\r\n    // For spells, force specific skills\r\n    let finalAttackSkill = weaponLinkedSkill || itemSystem.linkedAttackSkill || '';\r\n    let finalAttackSpec = weaponLinkedSpecialization || itemSystem.linkedAttackSpecialization || '';\r\n    let finalDefenseSkill = weaponLinkedDefenseSkill || itemSystem.linkedDefenseSkill || '';\r\n    let finalDefenseSpec = weaponLinkedDefenseSpecialization || itemSystem.linkedDefenseSpecialization || '';\r\n    \r\n    if (isSpell) {\r\n      // Force attack skill to Sorcellerie\r\n      finalAttackSkill = 'Sorcellerie';\r\n      \r\n      // Get spell specialization type and map it to the specialization name\r\n      const spellSpecType = itemSystem.spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      finalAttackSpec = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n      \r\n      if (spellType === 'direct') {\r\n        // Direct spell: no defense\r\n        finalDefenseSkill = '';\r\n        finalDefenseSpec = '';\r\n      } else {\r\n        // Indirect spell: force defense to Athlétisme / Spé : Défense à distance\r\n        finalDefenseSkill = 'Athlétisme';\r\n        finalDefenseSpec = 'Spé : Défense à distance';\r\n      }\r\n    }\r\n\r\n    // Find actor's skill and specialization using unified helper\r\n    const spellSpecType = isSpell ? (itemSystem.spellSpecializationType || 'combat') : undefined;\r\n    \r\n    // Determine default attribute: if skill not found, use agility (except for \"Combat rapproché\" which uses strength)\r\n    let defaultAttribute: string;\r\n    if (isSpell) {\r\n      defaultAttribute = 'willpower';\r\n    } else {\r\n      // Check if the skill exists in the actor's items\r\n      const skillExists = this.actor.items.some((i: any) => \r\n        i.type === 'skill' && \r\n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\r\n      );\r\n      \r\n      if (!skillExists && finalAttackSkill) {\r\n        // Skill not found: use agility, except for \"Combat rapproché\" which uses strength\r\n        const normalizedSkillName = ItemSearch.normalizeSearchText(finalAttackSkill);\r\n        if (normalizedSkillName === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          defaultAttribute = 'strength';\r\n        } else {\r\n          defaultAttribute = 'agility';\r\n        }\r\n      } else {\r\n        // Skill exists or no skill name: use strength (will be overridden by skill's linkedAttribute if skill found)\r\n        defaultAttribute = 'strength';\r\n      }\r\n    }\r\n    \r\n    const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n      this.actor,\r\n      finalAttackSpec,\r\n      finalAttackSkill,\r\n      { \r\n        isSpell, \r\n        spellSpecType,\r\n        defaultAttribute\r\n      }\r\n    );\r\n    \r\n    const attackSkillName = skillSpecResult.skillName;\r\n    const attackSkillLevel = skillSpecResult.skillLevel;\r\n    const attackSpecName = skillSpecResult.specName;\r\n    const attackSpecLevel = skillSpecResult.specLevel;\r\n    const attackLinkedAttribute = skillSpecResult.linkedAttribute;\r\n\r\n    // Calculate final damage value (base + bonus)\r\n    // For spells, damage value is calculated differently\r\n    let finalDamageValue: string;\r\n    \r\n    if (isSpell) {\r\n      if (spellType === 'direct') {\r\n        finalDamageValue = '0';\r\n      } else {\r\n        const willpower = (this.actor.system as any).attributes?.willpower || 1;\r\n        finalDamageValue = willpower.toString();\r\n      }\r\n    } else {\r\n      const baseDamageValue = itemSystem.damageValue || '0';\r\n      let damageValueBonus = itemSystem.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      // This applies to all weapons, including adept power weapons\r\n      const weaponType = itemSystem.weaponType || '';\r\n      const activeFeats = this.actor.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.active === true &&\r\n        item.system.weaponDamageBonus > 0 &&\r\n        item.system.weaponTypeBonus === weaponType\r\n      );\r\n      \r\n      activeFeats.forEach((activeFeat: any) => {\r\n        damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n      });\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      finalDamageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n    }\r\n\r\n    // Calculate attack pool with all RR sources using unified helper\r\n    const poolResult = SheetHelpers.calculateAttackPool(\r\n      this.actor,\r\n      skillSpecResult,\r\n      itemRRList,\r\n      item.name\r\n    );\r\n    const allRRSources = poolResult.allRRSources;\r\n\r\n    // Debug: Log the values being passed to roll dialog\r\n    console.log('SRA2 | _rollWeaponOrSpell - Values passed to roll dialog:', {\r\n      itemName: item.name,\r\n      itemRating: itemSystem.rating || 0,\r\n      skillName: attackSkillName,\r\n      skillLevel: attackSkillLevel,\r\n      specName: attackSpecName,\r\n      specLevel: attackSpecLevel,\r\n      linkedAttackSkill: finalAttackSkill,\r\n      linkedAttackSpecialization: finalAttackSpec\r\n    });\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: type,\r\n      weaponType: weaponType,\r\n      itemName: item.name,\r\n      itemId: item.id,\r\n      itemRating: itemSystem.rating || 0,\r\n      itemActive: itemSystem.active,\r\n      \r\n      // Merged linked skills\r\n      linkedAttackSkill: finalAttackSkill,\r\n      linkedAttackSpecialization: finalAttackSpec,\r\n      linkedDefenseSkill: finalDefenseSkill,\r\n      linkedDefenseSpecialization: finalDefenseSpec,\r\n      linkedAttribute: attackLinkedAttribute,\r\n      \r\n      // Weapon properties\r\n      isWeaponFocus: itemSystem.isWeaponFocus || false,\r\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus, or VOL for indirect spells, or 0 for direct spells)\r\n      // For spells, all ranges are \"ok\"\r\n      meleeRange: isSpell ? 'ok' : (itemSystem.meleeRange || 'none'),\r\n      shortRange: isSpell ? 'ok' : (itemSystem.shortRange || 'none'),\r\n      mediumRange: isSpell ? 'ok' : (itemSystem.mediumRange || 'none'),\r\n      longRange: isSpell ? 'ok' : (itemSystem.longRange || 'none'),\r\n      \r\n      // Attack skill/spec from actor (based on weapon links)\r\n      skillName: attackSkillName,\r\n      skillLevel: attackSkillLevel,\r\n      specName: attackSpecName,\r\n      specLevel: attackSpecLevel,\r\n      \r\n      // Actor information\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name || '',\r\n      \r\n      // RR List (merged: item RR + skill/spec/attribute RR)\r\n      rrList: allRRSources,\r\n      \r\n      // Spell-specific properties\r\n      spellType: isSpell ? spellType : undefined,  // 'direct' or 'indirect' for spells\r\n      isSpellDirect: isSpell && spellType === 'direct'  // Flag for direct spells (no defense)\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a power\r\n   */\r\n  private async _rollPower(power: any): Promise<void> {\r\n    const powerSystem = power.system as any;\r\n    \r\n    // Get linked attack and defense skills\r\n    const linkedAttackSkill = powerSystem.linkedAttackSkill || '';\r\n    const linkedAttackSpec = powerSystem.linkedAttackSpecialization || '';\r\n    const linkedDefenseSkill = powerSystem.linkedDefenseSkill || '';\r\n    const linkedDefenseSpec = powerSystem.linkedDefenseSpecialization || '';\r\n    \r\n    // Get all RR sources for the power\r\n    const rawPowerRRList = powerSystem.rrList || [];\r\n    const powerRRList = rawPowerRRList.map((rrEntry: any) => ({\r\n      ...rrEntry,\r\n      featName: power.name\r\n    }));\r\n    \r\n    // Determine default attribute: use strength as default\r\n    const defaultAttribute = 'strength';\r\n    \r\n    // Find attack skill/spec using unified helper (used for the dice roll)\r\n    const attackSkillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n      this.actor,\r\n      linkedAttackSpec,\r\n      linkedAttackSkill,\r\n      { defaultAttribute }\r\n    );\r\n    \r\n    // Calculate dice pool with all RR sources using unified helper\r\n    const poolResult = SheetHelpers.calculateAttackPool(\r\n      this.actor,\r\n      attackSkillSpecResult,\r\n      powerRRList,\r\n      power.name\r\n    );\r\n    const allRRSources = poolResult.allRRSources;\r\n    \r\n    // Calculate damage value (base + bonus)\r\n    const baseDamageValue = powerSystem.damageValue || '0';\r\n    let damageValueBonus = powerSystem.damageValueBonus || 0;\r\n    \r\n    // Limit total bonus to 2 maximum\r\n    damageValueBonus = Math.min(damageValueBonus, 2);\r\n    \r\n    const finalDamageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n    \r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'power',\r\n      itemName: power.name,\r\n      itemId: power.id,\r\n      itemRating: powerSystem.rating || 0,\r\n      itemActive: powerSystem.active,\r\n      \r\n      // Attack skill/spec (used for the dice roll)\r\n      skillName: attackSkillSpecResult.skillName,\r\n      skillLevel: attackSkillSpecResult.skillLevel,\r\n      specName: attackSkillSpecResult.specName,\r\n      specLevel: attackSkillSpecResult.specLevel,\r\n      linkedAttribute: attackSkillSpecResult.linkedAttribute,\r\n      \r\n      // Merged linked skills (for attack/defense)\r\n      linkedAttackSkill: linkedAttackSkill,\r\n      linkedAttackSpecialization: linkedAttackSpec,\r\n      linkedDefenseSkill: linkedDefenseSkill,\r\n      linkedDefenseSpecialization: linkedDefenseSpec,\r\n      \r\n      // Weapon properties\r\n      damageValue: finalDamageValue,\r\n      meleeRange: powerSystem.meleeRange || 'none',\r\n      shortRange: powerSystem.shortRange || 'none',\r\n      mediumRange: powerSystem.mediumRange || 'none',\r\n      longRange: powerSystem.longRange || 'none',\r\n      \r\n      // Actor information\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name || '',\r\n      \r\n      // RR List\r\n      rrList: allRRSources,\r\n      \r\n      // Mark as power\r\n      isPower: true\r\n    });\r\n  }\r\n\r\n  /**\r\n   * REMOVED: Skill with weapon roll - dialog creation disabled\r\n   */\r\n  private async _rollSkillWithWeapon(skill: any, weaponName: string, _skillType: 'skill', weaponDamageValue?: string, weapon?: any): Promise<void> {\r\n    console.log('Skill with weapon roll disabled', { skill: skill.name, weaponName });\r\n  }\r\n\r\n  /**\r\n   * REMOVED: Specialization with weapon roll - dialog creation disabled\r\n   */\r\n  private async _rollSpecializationWithWeapon(specialization: any, weaponName: string, effectiveRating: number, weaponDamageValue?: string, weapon?: any): Promise<void> {\r\n    console.log('Specialization with weapon roll disabled', { specialization: specialization.name, weaponName });\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle creating a new feat from search\r\n   */\r\n  private async _onCreateNewFeat(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const featName = button.dataset.featName;\r\n    \r\n    if (!featName) return;\r\n    \r\n    // Get the feat type from the selector\r\n    const selector = $(button).siblings('.feat-type-selector, .feat-type-selector-inline')[0] as HTMLSelectElement;\r\n    const featType = selector ? selector.value : 'equipment';\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = featName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new feat with default values\r\n    const featData = {\r\n      name: formattedName,\r\n      type: 'feat',\r\n      system: {\r\n        description: '',\r\n        rating: 0,\r\n        cost: 'free-equipment',\r\n        active: true,\r\n        featType: featType,\r\n        rrType: [],\r\n        rrValue: [],\r\n        rrTarget: [],\r\n        bonusLightDamage: 0,\r\n        bonusSevereDamage: 0,\r\n        bonusPhysicalThreshold: 0,\r\n        bonusMentalThreshold: 0,\r\n        bonusAnarchy: 0,\r\n        essenceCost: 0\r\n      }\r\n    } as any;\r\n    \r\n    // Add the feat to the actor\r\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [featData]) as any;\r\n    \r\n    if (createdItems && createdItems.length > 0) {\r\n      const newFeat = createdItems[0] as any;\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.feat-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      // Open the feat sheet for editing\r\n      if (newFeat && newFeat.sheet) {\r\n        setTimeout(() => {\r\n          newFeat.sheet.render(true);\r\n        }, 100);\r\n      }\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.FEAT_CREATED', { name: formattedName }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle switching between sheet types (V1 <-> V2)\r\n   */\r\n  private async _onSwitchSheet(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    // Import CharacterSheetV2 dynamically to avoid circular dependencies\r\n    const { CharacterSheetV2 } = await import('./character-sheet-v2.js');\r\n    \r\n    // Determine target sheet class based on current sheet type\r\n    const isV2 = this instanceof CharacterSheetV2;\r\n    \r\n    // Store actor reference and close current sheet\r\n    const actor = this.actor;\r\n    await this.close();\r\n    \r\n    // Create a new sheet instance with the target class\r\n    // Use CharacterSheet if currently V2, otherwise use CharacterSheetV2\r\n    const targetSheetClass = isV2 ? CharacterSheet : CharacterSheetV2;\r\n    const newSheet = new targetSheetClass(actor);\r\n    \r\n    // Reopen the sheet with the new class\r\n    setTimeout(() => {\r\n      newSheet.render(true);\r\n    }, 100);\r\n  }\r\n}\r\n\r\n","import { CharacterSheet } from './character-sheet.js';\r\n\r\n/**\r\n * Character Sheet Application V2\r\n * Nouvelle version de la fiche de personnage avec un template et des styles différents\r\n * Réutilise toute la logique TypeScript de CharacterSheet\r\n */\r\nexport class CharacterSheetV2 extends CharacterSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'character', 'character-v2'],\r\n      template: 'systems/sra2/templates/actor-character-sheet-v2.hbs',\r\n      // Vous pouvez aussi changer width/height si nécessaire\r\n      // width: 1000,\r\n      // height: 800,\r\n    });\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Context menu handler\r\n    html.find('[data-action=\"show-context-menu\"]').on('click', this._onShowContextMenu.bind(this));\r\n\r\n    // Close context menu when clicking outside\r\n    const namespace = `context-menu-v2-${this.id}`;\r\n    $(document).on(`click.${namespace}`, (event: JQuery.ClickEvent) => {\r\n      const target = event.target as HTMLElement;\r\n      if (!$(target).closest('.context-menu, [data-action=\"show-context-menu\"]').length) {\r\n        this.element.find('.context-menu.active').removeClass('active');\r\n      }\r\n    });\r\n\r\n    // Handle context menu item clicks - close menu after action\r\n    html.find('.context-menu-item').on('click', (event: JQuery.ClickEvent) => {\r\n      event.stopPropagation();\r\n      const menu = $(event.currentTarget).closest('.context-menu');\r\n      menu.removeClass('active');\r\n    });\r\n\r\n    // Handle toggle active for feats\r\n    html.find('[data-action=\"toggle-active\"]').on('click', this._onToggleActive.bind(this));\r\n  }\r\n\r\n  override close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document event listener\r\n    $(document).off(`click.context-menu-v2-${this.id}`);\r\n    return super.close(options);\r\n  }\r\n\r\n  private _onShowContextMenu(event: JQuery.ClickEvent): void {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n\r\n    // Close all other context menus\r\n    this.element.find('.context-menu.active').removeClass('active');\r\n\r\n    // Find and show the context menu closest to the clicked element\r\n    // This prevents opening multiple menus when the same item appears in multiple sections\r\n    let menu: JQuery;\r\n    if (itemId) {\r\n      // Find the menu closest to the clicked element (in the same row)\r\n      const $clickedElement = $(element);\r\n      const $row = $clickedElement.closest('.row');\r\n      menu = $row.find(`.context-menu[data-item-id=\"${itemId}\"]`);\r\n      \r\n      // Fallback: if not found in the same row, find the first one\r\n      if (menu.length === 0) {\r\n        menu = this.element.find(`.context-menu[data-item-id=\"${itemId}\"]`).first();\r\n      }\r\n    } else if (vehicleUuid) {\r\n      // For vehicles, find the menu closest to the clicked element\r\n      const $clickedElement = $(element);\r\n      const $row = $clickedElement.closest('.row');\r\n      menu = $row.find(`.context-menu[data-vehicle-uuid=\"${vehicleUuid}\"]`);\r\n      \r\n      // Fallback: if not found in the same row, find the first one\r\n      if (menu.length === 0) {\r\n        menu = this.element.find(`.context-menu[data-vehicle-uuid=\"${vehicleUuid}\"]`).first();\r\n      }\r\n    } else {\r\n      return;\r\n    }\r\n\r\n    if (menu.length) {\r\n      menu.addClass('active');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Toggle active state of a feat\r\n   */\r\n  private async _onToggleActive(event: JQuery.ClickEvent): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n\r\n    if (!itemId) return;\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item || item.type !== 'feat') return;\r\n\r\n    const currentActive = (item.system as any).active ?? true;\r\n    await item.update({ 'system.active': !currentActive } as any);\r\n    \r\n    // Re-render the sheet to update the visual state\r\n    this.render(false);\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","import * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport * as DiceRoller from '../helpers/dice-roller.js';\r\nimport { VEHICLE_TYPES, WEAPON_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Vehicle/Drone Sheet Application\r\n */\r\nexport class VehicleSheet extends ActorSheet {\r\n  private _activeSection: string | null = null;\r\n\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'vehicle'],\r\n      template: 'systems/sra2/templates/actor-vehicle-sheet.hbs',\r\n      width: 800,\r\n      height: 700,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dragSelector: '.item', dropSelector: '.sheet-body' }\r\n      ],\r\n      submitOnChange: false,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    // DEBUG: Log what we're about to update\r\n    console.log('VehicleSheet._updateObject - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'this.actor.uuid': this.actor.uuid,\r\n      'formData keys': Object.keys(formData),\r\n      'formData sample': Object.fromEntries(Object.entries(formData).slice(0, 5))\r\n    });\r\n    \r\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\r\n    \r\n    // CRITICAL FIX: Exclude damage from form submission (same as character sheet)\r\n    // Damage is handled exclusively by _onDamageChange handler to prevent form close reset\r\n    // Don't process damage here - _onDamageChange handles it directly\r\n    // Remove damage from expandedData if present to avoid conflicts and form close reset\r\n    if (expandedData.system?.damage !== undefined) {\r\n      delete expandedData.system.damage;\r\n    }\r\n    \r\n    // DEBUG: Log what we're sending to update\r\n    console.log('VehicleSheet._updateObject - About to update:', {\r\n      'actor.id': this.actor.id,\r\n      'expandedData keys': Object.keys(expandedData),\r\n      'expandedData.system keys': expandedData.system ? Object.keys(expandedData.system) : 'no system',\r\n      'damage excluded': !expandedData.system?.damage\r\n    });\r\n    \r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n\r\n    // DEBUG: Verify which actor we're working with\r\n    console.log('VehicleSheet.getData - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'context.actor.id': context.actor?.id,\r\n      'context.actor.name': context.actor?.name\r\n    });\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n\r\n    // DEBUG: Log damage data at vehicle sheet opening\r\n    const actorSource = (this.actor as any)._source;\r\n    const sourceDamage = actorSource?.system?.damage;\r\n    const currentDamage = (this.actor.system as any).damage;\r\n    console.log('VehicleSheet.getData - Damage data at opening:', {\r\n      'actor.id': this.actor.id,\r\n      'actor.name': this.actor.name,\r\n      '_source.system.damage': sourceDamage,\r\n      'this.actor.system.damage': currentDamage,\r\n      'sourceDamage type': typeof sourceDamage,\r\n      'currentDamage type': typeof currentDamage,\r\n      'sourceDamage.light': sourceDamage?.light,\r\n      'currentDamage.light': currentDamage?.light,\r\n      'sourceDamage.light type': Array.isArray(sourceDamage?.light) ? 'array' : typeof sourceDamage?.light,\r\n      'currentDamage.light type': Array.isArray(currentDamage?.light) ? 'array' : typeof currentDamage?.light\r\n    });\r\n\r\n    // Ensure damage arrays are properly initialized\r\n    const systemData = context.system as any;\r\n    if (!systemData.damage) {\r\n      systemData.damage = {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n    } else {\r\n      // Ensure arrays are properly sized\r\n      if (!Array.isArray(systemData.damage.light)) {\r\n        systemData.damage.light = [false, false];\r\n      }\r\n      while (systemData.damage.light.length < 2) {\r\n        systemData.damage.light.push(false);\r\n      }\r\n      while (systemData.damage.light.length > 2) {\r\n        systemData.damage.light.pop();\r\n      }\r\n      \r\n      if (!Array.isArray(systemData.damage.severe)) {\r\n        systemData.damage.severe = [false];\r\n      }\r\n      while (systemData.damage.severe.length < 1) {\r\n        systemData.damage.severe.push(false);\r\n      }\r\n      while (systemData.damage.severe.length > 1) {\r\n        systemData.damage.severe.pop();\r\n      }\r\n      \r\n      if (typeof systemData.damage.incapacitating !== 'boolean') {\r\n        systemData.damage.incapacitating = false;\r\n      }\r\n    }\r\n\r\n    // Add vehicle types for selection\r\n    context.vehicleTypes = VEHICLE_TYPES;\r\n\r\n    // Get feats (weapons only for vehicles)\r\n    const allFeats = this.actor.items.filter((item: any) => item.type === 'feat');\r\n    \r\n    // Get all active feats for RR calculation\r\n    const activeFeats = allFeats.filter((feat: any) => feat.system.active === true);\r\n    \r\n    // Get vehicle's structure for damage value calculations (similar to strength for characters)\r\n    const vehicleStructure = (this.actor.system as any).attributes?.structure || 0;\r\n    \r\n    // Helper function to calculate weapon stats\r\n    const calculateWeaponStats = (item: any) => {\r\n      const itemData = {\r\n        ...item,\r\n        _id: item.id || item._id,\r\n        id: item.id || item._id\r\n      };\r\n      \r\n      // For vehicles, weapons use Autopilot attribute when autonomous\r\n      // Otherwise, they would use the pilot's skills (handled externally)\r\n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\r\n      let totalDicePool = autopilot; // Base dice pool from autopilot\r\n      let totalRR = 0;\r\n      \r\n      // Calculate RR from active feats\r\n      activeFeats.forEach((feat: any) => {\r\n        const rrList = feat.system.rrList || [];\r\n        rrList.forEach((rrEntry: any) => {\r\n          if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n            totalRR += rrEntry.rrValue || 0;\r\n          }\r\n        });\r\n      });\r\n      \r\n      itemData.totalDicePool = totalDicePool;\r\n      itemData.totalRR = totalRR;\r\n      \r\n      // Calculate final damage value with bonus\r\n      const damageValue = item.system.damageValue || '0';\r\n      const damageValueBonus = item.system.damageValueBonus || 0;\r\n      itemData.finalDamageValue = SheetHelpers.calculateFinalDamageValue(damageValue, damageValueBonus, vehicleStructure);\r\n      \r\n      return itemData;\r\n    };\r\n    \r\n    // Filter and process weapons (only weapons allowed for vehicles)\r\n    const rawWeapons = allFeats.filter((feat: any) => \r\n      feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells'\r\n    );\r\n    const weapons = rawWeapons.map((weapon: any) => calculateWeaponStats(weapon));\r\n    \r\n    context.weapons = weapons;\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Restore active section if it was saved\r\n    if (this._activeSection) {\r\n      setTimeout(() => {\r\n        const form = html.closest('form')[0];\r\n        if (form) {\r\n          const navButton = form.querySelector(`[data-section=\"${this._activeSection}\"]`);\r\n          if (navButton) {\r\n            form.querySelectorAll('.section-nav .nav-item').forEach((item) => item.classList.remove('active'));\r\n            navButton.classList.add('active');\r\n            \r\n            form.querySelectorAll('.content-section').forEach((section) => section.classList.remove('active'));\r\n            const targetSection = form.querySelector(`[data-section-content=\"${this._activeSection}\"]`);\r\n            if (targetSection) {\r\n              targetSection.classList.add('active');\r\n            }\r\n          }\r\n        }\r\n      }, 10);\r\n    }\r\n\r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n\r\n    // Edit feat/weapon\r\n    html.find('.feat-edit, .weapon-edit').on('click', (event) => {\r\n      event.preventDefault();\r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (item) {\r\n        item.sheet?.render(true);\r\n      }\r\n    });\r\n\r\n    // Delete feat/weapon\r\n    html.find('.feat-delete, .weapon-delete').on('click', async (event) => {\r\n      event.preventDefault();\r\n      // Save current active section before deletion\r\n      const activeNavItem = html.find('.section-nav .nav-item.active');\r\n      this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : null;\r\n      \r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (item) {\r\n        const confirmed = await Dialog.confirm({\r\n          title: game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name }),\r\n          content: '',\r\n          yes: () => true,\r\n          no: () => false,\r\n          defaultYes: false\r\n        });\r\n        if (confirmed) {\r\n          await item.delete();\r\n          // The sheet will auto-render, and activateListeners will restore the section\r\n        }\r\n      }\r\n    });\r\n\r\n    // Add world weapon (only weapons allowed)\r\n    html.find('.add-world-weapon-button').on('click', async (event) => {\r\n      event.preventDefault();\r\n      // Save current active section before opening browser\r\n      const activeNavItem = html.find('.section-nav .nav-item.active');\r\n      this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : null;\r\n      this._showItemBrowser('feat', true); // true = weapons only\r\n    });\r\n\r\n    // Roll weapon dice (using autopilot)\r\n    html.find('.weapon-dice-pool').on('click', async (event) => {\r\n      event.preventDefault();\r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (!item) return;\r\n      \r\n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      // Prepare complete weapon roll request data using combat-helpers\r\n      const rollRequestData = CombatHelpers.prepareVehicleWeaponRollRequest(\r\n        this.actor,\r\n        item,\r\n        WEAPON_TYPES\r\n      );\r\n      \r\n      // Call dice roller with prepared data\r\n      DiceRoller.handleRollRequest(rollRequestData);\r\n    });\r\n\r\n    // Handle vehicle type change\r\n    html.find('.vehicle-type-select').on('change', this._onVehicleTypeChange.bind(this));\r\n\r\n    // Handle bonus changes - update attributes in real-time\r\n    html.find('input[name=\"system.autopilotBonus\"], input[name=\"system.speedBonus\"], input[name=\"system.handlingBonus\"], input[name=\"system.armorBonus\"]').on('change', this._onBonusChange.bind(this));\r\n    \r\n    // Handle option changes - update attributes in real-time\r\n    html.find('input[name=\"system.isFixed\"], input[name=\"system.isFlying\"], input[name=\"system.weaponMountImprovement\"], input[name=\"system.autopilotUnlocked\"], input[name=\"system.additionalDroneCount\"]').on('change', this._onOptionChange.bind(this));\r\n\r\n    // Add narrative effect\r\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', async (event) => {\r\n      event.preventDefault();\r\n      \r\n      // Read current narrative effects from form inputs to preserve unsaved changes\r\n      const currentNarrativeEffects: any[] = [];\r\n      \r\n      // Extract all narrative effect values from form (preserve order and unsaved changes)\r\n      const narrativeEffectTextareas = html.find('textarea[name^=\"system.narrativeEffects.\"]');\r\n      narrativeEffectTextareas.each((_index, textarea) => {\r\n        const textareaElement = textarea as HTMLTextAreaElement;\r\n        const nameMatch = textareaElement.name.match(/system\\.narrativeEffects\\.(\\d+)\\.text/);\r\n        if (nameMatch) {\r\n          const index = parseInt(nameMatch[1]);\r\n          const text = textareaElement.value || '';\r\n          const valueInput = html.find(`select[name=\"system.narrativeEffects.${index}.value\"]`);\r\n          const value = valueInput.length > 0 ? parseInt(valueInput.val() as string) || 0 : 0;\r\n          \r\n          // Determine isNegative based on value (for backward compatibility)\r\n          const isNegative = value < 0;\r\n          \r\n          currentNarrativeEffects[index] = {\r\n            text: text,\r\n            isNegative: isNegative,\r\n            value: value\r\n          };\r\n        }\r\n      });\r\n      \r\n      // Fill gaps in array\r\n      for (let i = 0; i < currentNarrativeEffects.length; i++) {\r\n        if (!currentNarrativeEffects[i]) {\r\n          currentNarrativeEffects[i] = { text: '', isNegative: false, value: 0 };\r\n        }\r\n      }\r\n      \r\n      // Add new empty effect\r\n      currentNarrativeEffects.push({ text: '', isNegative: false, value: 0 });\r\n      \r\n      await this.actor.update({\r\n        'system.narrativeEffects': currentNarrativeEffects\r\n      } as any);\r\n    });\r\n\r\n    // Remove narrative effect\r\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', async (event) => {\r\n      event.preventDefault();\r\n      const index = parseInt($(event.currentTarget).data('index') || '0');\r\n      \r\n      // Read current narrative effects from form inputs to preserve unsaved changes\r\n      const currentNarrativeEffects: any[] = [];\r\n      \r\n      // Extract all narrative effect values from form (preserve order and unsaved changes)\r\n      const narrativeEffectTextareas = html.find('textarea[name^=\"system.narrativeEffects.\"]');\r\n      narrativeEffectTextareas.each((_inputIndex, textarea) => {\r\n        const textareaElement = textarea as HTMLTextAreaElement;\r\n        const nameMatch = textareaElement.name.match(/system\\.narrativeEffects\\.(\\d+)\\.text/);\r\n        if (nameMatch) {\r\n          const effectIndex = parseInt(nameMatch[1]);\r\n          const text = textareaElement.value || '';\r\n          const valueInput = html.find(`select[name=\"system.narrativeEffects.${effectIndex}.value\"]`);\r\n          const value = valueInput.length > 0 ? parseInt(valueInput.val() as string) || 0 : 0;\r\n          \r\n          // Determine isNegative based on value (for backward compatibility)\r\n          const isNegative = value < 0;\r\n          \r\n          currentNarrativeEffects[effectIndex] = {\r\n            text: text,\r\n            isNegative: isNegative,\r\n            value: value\r\n          };\r\n        }\r\n      });\r\n      \r\n      // Fill gaps in array\r\n      for (let i = 0; i < currentNarrativeEffects.length; i++) {\r\n        if (!currentNarrativeEffects[i]) {\r\n          currentNarrativeEffects[i] = { text: '', isNegative: false, value: 0 };\r\n        }\r\n      }\r\n      \r\n      // Remove the effect at the specified index\r\n      currentNarrativeEffects.splice(index, 1);\r\n      \r\n      await this.actor.update({\r\n        'system.narrativeEffects': currentNarrativeEffects\r\n      } as any);\r\n    });\r\n\r\n    // Handle narrative effect changes (text or value) - auto-save to trigger character sheet re-render\r\n    // Use debounce for textarea input to avoid too many saves while typing\r\n    let narrativeEffectSaveTimeout: NodeJS.Timeout | null = null;\r\n    \r\n    const saveNarrativeEffects = async () => {\r\n      // Read current narrative effects from form inputs to preserve unsaved changes\r\n      const currentNarrativeEffects: any[] = [];\r\n      \r\n      // Extract all narrative effect values from form (preserve order and unsaved changes)\r\n      const narrativeEffectTextareas = html.find('textarea[name^=\"system.narrativeEffects.\"]');\r\n      narrativeEffectTextareas.each((_inputIndex, textarea) => {\r\n        const textareaElement = textarea as HTMLTextAreaElement;\r\n        const nameMatch = textareaElement.name.match(/system\\.narrativeEffects\\.(\\d+)\\.text/);\r\n        if (nameMatch) {\r\n          const effectIndex = parseInt(nameMatch[1]);\r\n          const text = textareaElement.value || '';\r\n          const valueInput = html.find(`select[name=\"system.narrativeEffects.${effectIndex}.value\"]`);\r\n          const value = valueInput.length > 0 ? parseInt(valueInput.val() as string) || 0 : 0;\r\n          \r\n          // Determine isNegative based on value (for backward compatibility)\r\n          const isNegative = value < 0;\r\n          \r\n          currentNarrativeEffects[effectIndex] = {\r\n            text: text,\r\n            isNegative: isNegative,\r\n            value: value\r\n          };\r\n        }\r\n      });\r\n      \r\n      // Fill gaps in array\r\n      for (let i = 0; i < currentNarrativeEffects.length; i++) {\r\n        if (!currentNarrativeEffects[i]) {\r\n          currentNarrativeEffects[i] = { text: '', isNegative: false, value: 0 };\r\n        }\r\n      }\r\n      \r\n      // Update the actor - this will trigger the updateActor hook which re-renders character sheets\r\n      await this.actor.update({\r\n        'system.narrativeEffects': currentNarrativeEffects\r\n      } as any);\r\n    };\r\n    \r\n    // Handle select changes (immediate save)\r\n    html.find('select[name^=\"system.narrativeEffects.\"]').on('change', async (event) => {\r\n      event.preventDefault();\r\n      if (narrativeEffectSaveTimeout) {\r\n        clearTimeout(narrativeEffectSaveTimeout);\r\n        narrativeEffectSaveTimeout = null;\r\n      }\r\n      await saveNarrativeEffects();\r\n    });\r\n    \r\n    // Handle textarea changes (debounced save for input, immediate for change/blur)\r\n    html.find('textarea[name^=\"system.narrativeEffects.\"]').on('input', (event) => {\r\n      if (narrativeEffectSaveTimeout) {\r\n        clearTimeout(narrativeEffectSaveTimeout);\r\n      }\r\n      // Debounce: save after 500ms of no typing\r\n      narrativeEffectSaveTimeout = setTimeout(async () => {\r\n        await saveNarrativeEffects();\r\n        narrativeEffectSaveTimeout = null;\r\n      }, 500);\r\n    });\r\n    \r\n    html.find('textarea[name^=\"system.narrativeEffects.\"]').on('change blur', async (event) => {\r\n      if (narrativeEffectSaveTimeout) {\r\n        clearTimeout(narrativeEffectSaveTimeout);\r\n        narrativeEffectSaveTimeout = null;\r\n      }\r\n      await saveNarrativeEffects();\r\n    });\r\n\r\n    // Handle damage checkbox changes (both in header and combat section)\r\n    html.find('input[name^=\"system.damage.\"]').on('change', async (event) => {\r\n      const input = event.currentTarget as HTMLInputElement;\r\n      const name = input.name;\r\n      const checked = input.checked;\r\n      \r\n      // DEBUG: Log which actor we're updating damage for\r\n      console.log('VehicleSheet damage change - DEBUG:', {\r\n        'this.actor.id': this.actor.id,\r\n        'this.actor.name': this.actor.name,\r\n        'this.actor.type': this.actor.type,\r\n        'input.name': name,\r\n        'checked': checked\r\n      });\r\n      \r\n      // Save current active section before update\r\n      const activeSection = SheetHelpers.getCurrentActiveSection(html);\r\n      \r\n      // Get current damage from actor data (read from _source for persisted values)\r\n      const actorSource = (this.actor as any)._source;\r\n      const currentDamage = actorSource?.system?.damage || (this.actor.system as any).damage || {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n      \r\n      // Use helper to parse and update damage\r\n      const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n      if (!updatedDamage) return;\r\n      \r\n      // Update the actor with the complete damage object\r\n      await this.actor.update({\r\n        'system.damage': updatedDamage\r\n      } as any, { render: false });\r\n      \r\n      // Synchronize all checkboxes with the same name and update visual state\r\n      html.find(`input[name=\"${name}\"]`).each((_, checkbox) => {\r\n        const $checkbox = $(checkbox);\r\n        $checkbox.prop('checked', checked);\r\n        $checkbox.closest('label.track-box').toggleClass('checked', checked);\r\n      });\r\n      \r\n      // Restore active section after update\r\n      const form = $(this.element).closest('form')[0] as HTMLElement;\r\n      if (form && activeSection) {\r\n        SheetHelpers.restoreActiveSection(form, activeSection);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    const button = event.currentTarget as HTMLElement;\r\n    const form = button.closest('form') as HTMLElement;\r\n    if (!form) return;\r\n    \r\n    const section = SheetHelpers.handleSectionNavigation(event, form);\r\n    if (section) {\r\n      this._activeSection = section;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle vehicle type selection change\r\n   */\r\n  private async _onVehicleTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const vehicleType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    if (!vehicleType || !VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES]) {\r\n      return;\r\n    }\r\n    \r\n    // Update vehicle type - the prepareDerivedData will calculate the attributes\r\n    await this.actor.update({\r\n      'system.vehicleType': vehicleType\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle bonus changes - update actor and re-render to show updated attributes\r\n   */\r\n  private async _onBonusChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const value = parseInt(input.value) || 0;\r\n    \r\n    // Save current active section before update\r\n    const activeSection = SheetHelpers.getCurrentActiveSection($(this.element)) || 'attributes';\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate attributes\r\n    await this.actor.update({\r\n      [name]: value\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n    \r\n    // Restore active section after render\r\n    const form = $(this.element).closest('form')[0] as HTMLElement;\r\n    if (form) {\r\n      SheetHelpers.restoreActiveSection(form, activeSection);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle option changes (isFixed, isFlying, weaponMountImprovement, etc.) - update actor and re-render\r\n   */\r\n  private async _onOptionChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    \r\n    // Save current active section before update\r\n    const activeSection = SheetHelpers.getCurrentActiveSection($(this.element)) || 'attributes';\r\n    \r\n    // Determine value based on input type\r\n    let value: any;\r\n    if (input.type === 'checkbox') {\r\n      value = input.checked;\r\n    } else if (input.type === 'number') {\r\n      value = parseInt(input.value) || 0;\r\n    } else {\r\n      value = input.value;\r\n    }\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate attributes\r\n    await this.actor.update({\r\n      [name]: value\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n    \r\n    // Restore active section after render\r\n    const form = $(this.element).closest('form')[0] as HTMLElement;\r\n    if (form) {\r\n      SheetHelpers.restoreActiveSection(form, activeSection);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show item browser dialog\r\n   */\r\n  private async _showItemBrowser(itemType: string, weaponsOnly: boolean = false): Promise<void> {\r\n    let items = game.items!.filter((item: any) => item.type === itemType);\r\n    \r\n    // Filter to only weapons if requested\r\n    if (weaponsOnly) {\r\n      items = items.filter((item: any) => {\r\n        const featType = item.system?.featType;\r\n        return featType === 'weapon' || featType === 'weapons-spells';\r\n      });\r\n    }\r\n    \r\n    const itemOptions = items.map((item: any) => {\r\n      return `<option value=\"${item.id}\">${item.name}</option>`;\r\n    }).join('');\r\n\r\n    const content = `\r\n      <div class=\"form-group\">\r\n        <label>${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.WORLD_ITEMS`)}</label>\r\n        <select id=\"item-select\" style=\"width: 100%;\">\r\n          <option value=\"\">${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.SEARCH_PLACEHOLDER`)}</option>\r\n          ${itemOptions}\r\n        </select>\r\n      </div>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\r\n      content,\r\n      buttons: {\r\n        add: {\r\n          icon: '<i class=\"fas fa-plus\"></i>',\r\n          label: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\r\n          callback: async (html: JQuery) => {\r\n            const itemId = html.find('#item-select').val() as string;\r\n            if (itemId) {\r\n              const item = game.items!.get(itemId);\r\n              if (item) {\r\n                // The sheet will auto-render, and activateListeners will restore the section\r\n                await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n              }\r\n            }\r\n          }\r\n        },\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: game.i18n!.localize('Cancel')\r\n        }\r\n      },\r\n      default: 'add'\r\n    }).render(true);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping items onto the sheet\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<boolean | void> {\r\n    // Save current active section before drop\r\n    const activeNavItem = $(this.element).find('.section-nav .nav-item.active');\r\n    this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : 'attributes';\r\n    \r\n    // Get the dropped data\r\n    let data;\r\n    try {\r\n      data = JSON.parse(event.dataTransfer?.getData('text/plain') || '{}');\r\n    } catch (err) {\r\n      return super._onDrop(event);\r\n    }\r\n    \r\n    // Only allow weapons (feats of type weapon or weapons-spells)\r\n    if (data.type === 'Item') {\r\n      const item = await Item.fromDropData(data);\r\n      if (item && item.type === 'feat') {\r\n        const featType = (item.system as any).featType;\r\n        if (featType === 'weapon' || featType === 'weapons-spells') {\r\n          // Create the item on the actor\r\n          // The sheet will auto-render, and activateListeners will restore the section\r\n          await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n          \r\n          return false; // Prevent default behavior\r\n        } else {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.VEHICLE.ONLY_WEAPONS_ALLOWED'));\r\n          return false; // Prevent default behavior\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Fall back to default behavior for other item types\r\n    return super._onDrop(event);\r\n  }\r\n}\r\n\r\n","import * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport { ICE_TYPES } from '../models/actor-ice.js';\r\n\r\n/**\r\n * ICE Sheet Application\r\n */\r\nexport class IceSheet extends ActorSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'ice'],\r\n      template: 'systems/sra2/templates/actor-ice-sheet.hbs',\r\n      width: 600,\r\n      height: 500,\r\n      tabs: [],\r\n      dragDrop: [],\r\n      submitOnChange: false,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n\r\n    // Add ICE types for selection\r\n    context.iceTypes = ICE_TYPES;\r\n\r\n    // Get ICE type description\r\n    const iceType = (this.actor.system as any).iceType || '';\r\n    context.iceTypeDescription = this._getIceTypeDescription(iceType);\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Handle ICE type change\r\n    html.find('.ice-type-select').on('change', this._onIceTypeChange.bind(this));\r\n\r\n    // Handle server index change\r\n    html.find('input[name=\"system.serverIndex\"]').on('change', this._onServerIndexChange.bind(this));\r\n\r\n    // Handle ICE attack button\r\n    html.find('.ice-attack-button').on('click', this._onIceAttack.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Handle ICE type selection change\r\n   */\r\n  private async _onIceTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const iceType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    // Update ICE type - the prepareDerivedData will calculate the attributes\r\n    await this.actor.update({\r\n      'system.iceType': iceType || null\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle server index change - update actor and re-render\r\n   */\r\n  private async _onServerIndexChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(input.value) || 1;\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate threshold and damage\r\n    await this.actor.update({\r\n      'system.serverIndex': Math.max(1, Math.min(12, value))\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Get description for ICE type\r\n   */\r\n  private _getIceTypeDescription(iceType: string): string {\r\n    const descriptions: Record<string, string> = {\r\n      patrol: 'SRA2.ICE.DESCRIPTION.PATROL',\r\n      acid: 'SRA2.ICE.DESCRIPTION.ACID',\r\n      blaster: 'SRA2.ICE.DESCRIPTION.BLASTER',\r\n      blocker: 'SRA2.ICE.DESCRIPTION.BLOCKER',\r\n      black: 'SRA2.ICE.DESCRIPTION.BLACK',\r\n      glue: 'SRA2.ICE.DESCRIPTION.GLUE',\r\n      tracker: 'SRA2.ICE.DESCRIPTION.TRACKER',\r\n      killer: 'SRA2.ICE.DESCRIPTION.KILLER'\r\n    };\r\n    \r\n    return descriptions[iceType] || '';\r\n  }\r\n\r\n  /**\r\n   * Handle ICE attack button click\r\n   */\r\n  private async _onIceAttack(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    // Get selected token (defender)\r\n    const controlledTokens = canvas?.tokens?.controlled || [];\r\n    if (controlledTokens.length === 0) {\r\n      ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.ATTACK.NO_TARGET'));\r\n      return;\r\n    }\r\n    \r\n    const defenderToken = controlledTokens[0];\r\n    const defender = defenderToken.actor;\r\n    \r\n    if (!defender) {\r\n      ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.ATTACK.NO_TARGET'));\r\n      return;\r\n    }\r\n    \r\n    // Get ICE token (if on canvas) or use actor\r\n    let iceToken = null;\r\n    if (this.actor.isToken) {\r\n      iceToken = this.actor.token;\r\n    } else {\r\n      // Try to find token on canvas\r\n      const tokens = canvas?.tokens?.placeables || [];\r\n      iceToken = tokens.find((token: any) => token.actor?.id === this.actor.id) || null;\r\n    }\r\n    \r\n    // Create attack message\r\n    await CombatHelpers.createIceAttackMessage(this.actor, iceToken, defender, defenderToken);\r\n  }\r\n}\r\n\r\n","import { WEAPON_TYPES } from '../models/item-feat.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Feat Sheet Application\r\n */\r\nexport class FeatSheet extends ItemSheet {\r\n  /** Track the currently active section */\r\n  private _activeSection: string = 'general';\r\n  /** Timeout for power search debouncing */\r\n  private powerSearchTimeout: any = null;\r\n  \r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'feat'],\r\n      template: 'systems/sra2/templates/item-feat-sheet.hbs',\r\n      width: 720,\r\n      height: 680,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dropSelector: '.rr-target-drop-zone' }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    \r\n    // Ensure prepareDerivedData is called to calculate recommendedLevel\r\n    this.item.prepareData();\r\n    \r\n    context.system = this.item.system;\r\n    \r\n    // Pass the active section to the template\r\n    context.activeSection = this._activeSection;\r\n    \r\n    // Calculate final damage value\r\n    context.finalDamageValue = this._calculateFinalDamageValue();\r\n    \r\n    // Calculate cyberdeck damage thresholds\r\n    context.cyberdeckDamageThresholds = this._calculateCyberdeckDamageThresholds();\r\n    \r\n    // Build RR entries array from rrList\r\n    context.rrEntries = [];\r\n    const rrList = context.system.rrList || [];\r\n    \r\n    for (let i = 0; i < rrList.length; i++) {\r\n      const rrEntry = rrList[i];\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      const entry: any = {\r\n        index: i,\r\n        rrType,\r\n        rrValue,\r\n        rrTarget,\r\n        rrTargetName: rrTarget\r\n      };\r\n      \r\n      if (rrType === 'skill' || rrType === 'specialization') {\r\n        entry.rrTargetType = rrType === 'skill' \r\n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\r\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\r\n        \r\n        // If the feat is on an actor, check if the target exists\r\n        if (this.item.actor && rrTarget) {\r\n          const targetItem = this.item.actor.items.find((i: any) => \r\n            i.type === rrType && i.name === rrTarget\r\n          );\r\n          \r\n          if (!targetItem) {\r\n            entry.rrTargetNotFound = true;\r\n          }\r\n        }\r\n      }\r\n      \r\n      context.rrEntries.push(entry);\r\n    }\r\n    \r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Add RR entry button\r\n    html.find('[data-action=\"add-rr-entry\"]').on('click', this._onAddRREntry.bind(this));\r\n    \r\n    // Remove RR entry button\r\n    html.find('[data-action=\"remove-rr-entry\"]').on('click', this._onRemoveRREntry.bind(this));\r\n    \r\n    // Clear RR target button\r\n    html.find('[data-action=\"clear-rr-target\"]').on('click', this._onClearRRTarget.bind(this));\r\n    \r\n    // Add narrative effect button\r\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', this._onAddNarrativeEffect.bind(this));\r\n    \r\n    // Remove narrative effect button\r\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', this._onRemoveNarrativeEffect.bind(this));\r\n    \r\n    // Narrative effect negative checkbox change\r\n    html.find('input[name^=\"system.narrativeEffects\"][name$=\".isNegative\"]').on('change', this._onNarrativeEffectNegativeChange.bind(this));\r\n    \r\n    // Weapon type selection\r\n    html.find('[data-action=\"select-weapon-type\"]').on('change', this._onWeaponTypeChange.bind(this));\r\n    \r\n    // Damage value bonus checkboxes\r\n    html.find('.damage-bonus-checkbox').on('change', this._onDamageValueBonusChange.bind(this));\r\n    \r\n    // Sustained spell checkboxes\r\n    html.find('.sustained-spell-checkbox').on('change', this._onSustainedSpellChange.bind(this));\r\n    \r\n    // Summoned spirit checkbox\r\n    html.find('.summoned-spirit-checkbox').on('change', this._onSummonedSpiritChange.bind(this));\r\n    \r\n    // Range improvement checkboxes\r\n    html.find('.range-improvement-checkbox input[type=\"checkbox\"]').on('change', this._onRangeImprovementChange.bind(this));\r\n    \r\n    // Astral projection checkbox change - automatically enable astral perception\r\n    html.find('input[name=\"system.astralProjection\"]').on('change', this._onAstralProjectionChange.bind(this));\r\n    \r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n    \r\n    // RR target search\r\n    html.find('.rr-target-search-input').on('input', this._onRRTargetSearch.bind(this));\r\n    html.find('.rr-target-search-input').on('focus', this._onRRTargetSearchFocus.bind(this));\r\n    html.find('.rr-target-search-input').on('blur', this._onRRTargetSearchBlur.bind(this));\r\n    \r\n    // Close RR target search results when clicking outside\r\n    $(document).on('click.rr-target-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const searchContainers = html.find('.rr-target-search-container');\r\n      searchContainers.each((_, container) => {\r\n        if (!container.contains(target)) {\r\n          $(container).find('.rr-target-search-results').hide();\r\n        }\r\n      });\r\n    });\r\n    \r\n    // Power skill/spec search\r\n    html.find('.power-skill-search-input').on('input', this._onPowerSkillSearch.bind(this));\r\n    html.find('.power-skill-search-input').on('focus', this._onPowerSkillSearchFocus.bind(this));\r\n    html.find('.power-skill-search-input').on('blur', this._onPowerSkillSearchBlur.bind(this));\r\n    \r\n    html.find('.power-spec-search-input').on('input', this._onPowerSpecSearch.bind(this));\r\n    html.find('.power-spec-search-input').on('focus', this._onPowerSpecSearchFocus.bind(this));\r\n    html.find('.power-spec-search-input').on('blur', this._onPowerSpecSearchBlur.bind(this));\r\n    \r\n    // Close power search results when clicking outside\r\n    $(document).on('click.power-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      \r\n      // Don't close if clicking on a button inside results\r\n      if ($(target).closest('.select-power-skill-btn, .select-power-spec-btn').length > 0) {\r\n        return;\r\n      }\r\n      \r\n      // Don't close if clicking on a result item\r\n      if ($(target).closest('.search-result-item').length > 0) {\r\n        return;\r\n      }\r\n      \r\n      const searchContainers = html.find('.power-skill-search-container, .power-spec-search-container');\r\n      searchContainers.each((_, container) => {\r\n        if (!container.contains(target)) {\r\n          $(container).find('.power-skill-search-results, .power-spec-search-results').hide();\r\n        }\r\n      });\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const button = event.currentTarget as HTMLElement;\r\n    const section = button.dataset.section;\r\n    \r\n    if (!section) return;\r\n    \r\n    // Save the active section\r\n    this._activeSection = section;\r\n    \r\n    // Find the form element\r\n    if (!this.form) return;\r\n    const form = $(this.form);\r\n    \r\n    // Update navigation buttons\r\n    form.find('.section-nav .nav-item').removeClass('active');\r\n    button.classList.add('active');\r\n    \r\n    // Update content sections\r\n    form.find('.content-section').removeClass('active');\r\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\r\n  }\r\n\r\n  /**\r\n   * Handle adding a new RR entry\r\n   */\r\n  private async _onAddRREntry(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    rrList.push({\r\n      rrType: 'skill',\r\n      rrValue: 0,\r\n      rrTarget: ''\r\n    });\r\n    \r\n    await this.item.update({\r\n      'system.rrList': rrList\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle removing an RR entry\r\n   */\r\n  private async _onRemoveRREntry(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    rrList.splice(index, 1);\r\n    \r\n    await this.item.update({\r\n      'system.rrList': rrList\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle clearing the RR target for a specific entry\r\n   */\r\n  private async _onClearRRTarget(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    if (rrList[index]) {\r\n      rrList[index] = { ...rrList[index], rrTarget: '' };\r\n    }\r\n    \r\n    await this.item.update({ 'system.rrList': rrList } as any);\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping a skill or specialization onto the RR target field\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    const data = TextEditor.getDragEventData(event) as any;\r\n    \r\n    // Handle Item drops\r\n    if (data && data.type === 'Item') {\r\n      const item = await Item.implementation.fromDropData(data) as any;\r\n      \r\n      if (!item) return super._onDrop(event);\r\n      \r\n      // Find the drop zone and get the index\r\n      const dropZone = (event.target as HTMLElement).closest('[data-rr-index]');\r\n      if (!dropZone) return super._onDrop(event);\r\n      \r\n      const index = parseInt((dropZone as HTMLElement).dataset.rrIndex || '0');\r\n      const rrList = [...((this.item.system as any).rrList || [])];\r\n      const rrType = rrList[index]?.rrType;\r\n      \r\n      // Check if it's a skill or specialization matching the RR type\r\n      if (item.type === 'skill' && rrType === 'skill') {\r\n        // Store the skill name (not ID) so the feat can be prepared in advance\r\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\r\n        await this.item.update({ 'system.rrList': rrList } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\r\n        return;\r\n      } else if (item.type === 'specialization' && rrType === 'specialization') {\r\n        // Store the specialization name (not ID) so the feat can be prepared in advance\r\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\r\n        await this.item.update({ 'system.rrList': rrList } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\r\n        return;\r\n      } else if (rrType === 'skill' || rrType === 'specialization') {\r\n        // Wrong type of item\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.WRONG_TARGET_TYPE'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    return super._onDrop(event);\r\n  }\r\n\r\n  /**\r\n   * Handle adding a new narrative effect\r\n   */\r\n  private async _onAddNarrativeEffect(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    narrativeEffects.push({\r\n      text: \"\",\r\n      isNegative: false,\r\n      value: 1\r\n    });\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle removing a narrative effect\r\n   */\r\n  private async _onRemoveNarrativeEffect(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    narrativeEffects.splice(index, 1);\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle narrative effect negative checkbox change\r\n   * Reset value to appropriate default when switching between positive and negative\r\n   */\r\n  private async _onNarrativeEffectNegativeChange(event: Event): Promise<void> {\r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const name = checkbox.name;\r\n    \r\n    // Extract index from name like \"system.narrativeEffects.0.isNegative\"\r\n    const match = name.match(/system\\.narrativeEffects\\.(\\d+)\\.isNegative/);\r\n    if (!match || !match[1]) return;\r\n    \r\n    const index = parseInt(match[1]);\r\n    const isNegative = checkbox.checked;\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    if (narrativeEffects[index]) {\r\n      // Reset value to appropriate default: 1 for positive, -1 for negative\r\n      narrativeEffects[index] = {\r\n        ...narrativeEffects[index],\r\n        isNegative: isNegative,\r\n        value: isNegative ? -1 : 1\r\n      };\r\n    }\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Calculate the final damage value taking into account STRENGTH attribute\r\n   */\r\n  private _calculateFinalDamageValue(): string {\r\n    const damageValue = (this.item.system as any).damageValue || \"0\";\r\n    const damageValueBonus = (this.item.system as any).damageValueBonus || 0;\r\n    \r\n    // Get the actor's strength if available\r\n    const strength = this.item.actor ? ((this.item.actor.system as any)?.attributes?.strength || 0) : 0;\r\n    \r\n    // Parse the damage value\r\n    if (damageValue === \"FOR\") {\r\n      // Pure STRENGTH\r\n      const total = strength + damageValueBonus;\r\n      if (!this.item.actor) {\r\n        return damageValueBonus > 0 ? `FOR+${damageValueBonus}` : \"FOR\";\r\n      }\r\n      return `${total} (FOR${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\r\n    } else if (damageValue.startsWith(\"FOR+\")) {\r\n      // STRENGTH + modifier\r\n      const modifier = parseInt(damageValue.substring(4)) || 0;\r\n      const total = strength + modifier + damageValueBonus;\r\n      if (!this.item.actor) {\r\n        return damageValueBonus > 0 ? `FOR+${modifier}+${damageValueBonus}` : `FOR+${modifier}`;\r\n      }\r\n      return `${total} (FOR+${modifier}${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\r\n    } else if (damageValue === \"toxin\") {\r\n      // Special case for gas grenades\r\n      return \"selon toxine\";\r\n    } else {\r\n      // Numeric value\r\n      const base = parseInt(damageValue) || 0;\r\n      const total = base + damageValueBonus;\r\n      if (damageValueBonus > 0) {\r\n        return `${total} (${base}+${damageValueBonus})`;\r\n      }\r\n      return total.toString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle weapon type selection change\r\n   */\r\n  private async _onWeaponTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const weaponType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    if (!weaponType || !WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES]) {\r\n      return;\r\n    }\r\n    \r\n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n    \r\n    // Convert damage value to string\r\n    const damageValue = typeof weaponStats.vd === 'number' ? weaponStats.vd.toString() : weaponStats.vd;\r\n    \r\n    const updateData: any = {\r\n      'system.weaponType': weaponType,\r\n      'system.damageValue': damageValue,\r\n      'system.meleeRange': weaponStats.melee,\r\n      'system.shortRange': weaponStats.short,\r\n      'system.mediumRange': weaponStats.medium,\r\n      'system.longRange': weaponStats.long\r\n    };\r\n    \r\n    // For custom weapons, initialize linked skills/specializations with default values if not already set\r\n    if (weaponType === 'custom-weapon') {\r\n      const currentSystem = (this.item.system as any);\r\n      if (!currentSystem.linkedAttackSkill) {\r\n        updateData['system.linkedAttackSkill'] = weaponStats.linkedSkill;\r\n      }\r\n      if (!currentSystem.linkedAttackSpecialization) {\r\n        updateData['system.linkedAttackSpecialization'] = weaponStats.linkedSpecialization;\r\n      }\r\n      if (!currentSystem.linkedDefenseSkill) {\r\n        updateData['system.linkedDefenseSkill'] = weaponStats.linkedDefenseSkill;\r\n      }\r\n      if (!currentSystem.linkedDefenseSpecialization) {\r\n        updateData['system.linkedDefenseSpecialization'] = weaponStats.linkedDefenseSpecialization;\r\n      }\r\n    }\r\n    \r\n    await this.item.update(updateData);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Calculate cyberdeck damage thresholds based on firewall\r\n   */\r\n  private _calculateCyberdeckDamageThresholds(): any {\r\n    const firewall = (this.item.system as any).firewall || 1;\r\n    \r\n    return {\r\n      light: firewall,\r\n      severe: firewall * 2,\r\n      incapacitating: firewall * 3\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle damage value bonus checkbox changes\r\n   */\r\n  private _onDamageValueBonusChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(checkbox.dataset.bonusValue || '0');\r\n    const currentBonus = (this.item.system as any).damageValueBonus || 0;\r\n    \r\n    let newBonus: number;\r\n    \r\n    if (checkbox.checked) {\r\n      // If checking, set to the checkbox value\r\n      newBonus = value;\r\n    } else {\r\n      // If unchecking, decrease appropriately\r\n      if (value === 2 && currentBonus === 2) {\r\n        newBonus = 1;\r\n      } else if (value === 1 && currentBonus >= 1) {\r\n        newBonus = 0;\r\n      } else {\r\n        newBonus = currentBonus;\r\n      }\r\n    }\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.damageValueBonus\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newBonus.toString();\r\n    }\r\n    \r\n    // Update the checkboxes state\r\n    const checkboxes = this.element.find('.damage-bonus-checkbox');\r\n    checkboxes.each((_, cb) => {\r\n      const cbElement = cb as HTMLInputElement;\r\n      const cbValue = parseInt(cbElement.dataset.bonusValue || '0');\r\n      if (cbValue === 1) {\r\n        cbElement.checked = newBonus >= 1;\r\n      } else if (cbValue === 2) {\r\n        cbElement.checked = newBonus === 2;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle sustained spell checkbox changes\r\n   */\r\n  private _onSustainedSpellChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(checkbox.dataset.spellValue || '0');\r\n    const currentCount = (this.item.system as any).sustainedSpellCount || 0;\r\n    \r\n    let newCount: number;\r\n    \r\n    if (checkbox.checked) {\r\n      // If checking, set to the checkbox value\r\n      newCount = value;\r\n    } else {\r\n      // If unchecking, decrease appropriately\r\n      if (value === 2 && currentCount === 2) {\r\n        newCount = 1;\r\n      } else if (value === 1 && currentCount >= 1) {\r\n        newCount = 0;\r\n      } else {\r\n        newCount = currentCount;\r\n      }\r\n    }\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.sustainedSpellCount\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newCount.toString();\r\n    }\r\n    \r\n    // Update the checkboxes state\r\n    const checkboxes = this.element.find('.sustained-spell-checkbox');\r\n    checkboxes.each((_, cb) => {\r\n      const cbElement = cb as HTMLInputElement;\r\n      const cbValue = parseInt(cbElement.dataset.spellValue || '0');\r\n      if (cbValue === 1) {\r\n        cbElement.checked = newCount >= 1;\r\n      } else if (cbValue === 2) {\r\n        cbElement.checked = newCount === 2;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle summoned spirit checkbox change\r\n   */\r\n  private _onSummonedSpiritChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const newCount = checkbox.checked ? 1 : 0;\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.summonedSpiritCount\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newCount.toString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle range improvement checkbox change\r\n   * When checked, automatically improves the range: none -> disadvantage, disadvantage -> ok\r\n   * When unchecked, automatically downgrades the range: ok -> disadvantage, disadvantage -> none\r\n   */\r\n  private _onRangeImprovementChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const isChecked = checkbox.checked;\r\n    \r\n    // Find which range this checkbox is for\r\n    const rangeRow = checkbox.closest('.range-row');\r\n    if (!rangeRow) return;\r\n    \r\n    const select = rangeRow.querySelector('select') as HTMLSelectElement;\r\n    if (!select) return;\r\n    \r\n    // Determine which range field we're dealing with\r\n    const rangeLabel = rangeRow.querySelector('.range-label')?.textContent || '';\r\n    let fieldName = '';\r\n    if (rangeLabel.includes('Contact') || rangeLabel.includes('Melee') || rangeLabel.includes('Mêlée')) {\r\n      fieldName = 'system.meleeRange';\r\n    } else if (rangeLabel.includes('Courte') || rangeLabel.includes('Short')) {\r\n      fieldName = 'system.shortRange';\r\n    } else if (rangeLabel.includes('Moyenne') || rangeLabel.includes('Medium')) {\r\n      fieldName = 'system.mediumRange';\r\n    } else if (rangeLabel.includes('Longue') || rangeLabel.includes('Long')) {\r\n      fieldName = 'system.longRange';\r\n    }\r\n    \r\n    const currentValue = select.value;\r\n    let newValue = currentValue;\r\n    \r\n    if (isChecked) {\r\n      // Improve the range: none -> disadvantage, disadvantage -> ok\r\n      if (currentValue === 'none') {\r\n        newValue = 'disadvantage';\r\n      } else if (currentValue === 'disadvantage') {\r\n        newValue = 'ok';\r\n      }\r\n      // If already 'ok', keep it at 'ok'\r\n    } else {\r\n      // Downgrade the range: ok -> disadvantage, disadvantage -> none\r\n      if (currentValue === 'ok') {\r\n        newValue = 'disadvantage';\r\n      } else if (currentValue === 'disadvantage') {\r\n        newValue = 'none';\r\n      }\r\n      // If already 'none', keep it at 'none'\r\n    }\r\n    \r\n    // Update the disabled select for visual display\r\n    select.value = newValue;\r\n    \r\n    // Update the hidden input that holds the actual value\r\n    const hiddenInput = this.element.find(`input[name=\"${fieldName}\"]`)[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newValue;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle astral projection checkbox change\r\n   * Automatically enable astral perception when projection is enabled\r\n   */\r\n  private async _onAstralProjectionChange(event: Event): Promise<void> {\r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const isProjectionEnabled = checkbox.checked;\r\n    \r\n    if (isProjectionEnabled) {\r\n      // Automatically enable astral perception\r\n      const astralPerceptionInput = this.element.find('input[name=\"system.astralPerception\"]')[0] as HTMLInputElement;\r\n      if (astralPerceptionInput) {\r\n        astralPerceptionInput.checked = true;\r\n      }\r\n      \r\n      // Update the item to set astralPerception to true\r\n      await this.item.update({\r\n        'system.astralPerception': true\r\n      } as any);\r\n      \r\n      // Re-render to update the disabled state\r\n      this.render(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search input\r\n   */\r\n  private rrTargetSearchTimeout: any = null;\r\n  \r\n  private async _onRRTargetSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const rrIndex = parseInt(input.dataset.rrIndex || '0');\r\n    const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.rrTargetSearchTimeout) {\r\n      clearTimeout(this.rrTargetSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.rrTargetSearchTimeout = setTimeout(async () => {\r\n      await this._performRRTargetSearch(searchTerm, rrIndex, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual RR target search in actor items and compendiums\r\n   */\r\n  private async _performRRTargetSearch(searchTerm: string, rrIndex: number, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    const rrList = (this.item.system as any).rrList || [];\r\n    const rrType = rrList[rrIndex]?.rrType;\r\n    \r\n    if (!rrType || rrType === 'attribute') {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Search in actor items if this feat is on an actor\r\n    if (this.item.actor) {\r\n      for (const item of this.item.actor.items as any) {\r\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n            type: rrType\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in world items\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === item.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: item.name,\r\n              uuid: item.uuid,\r\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n              type: rrType\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for items that match the search term and type\r\n      for (const doc of documents) {\r\n        if (doc.type === rrType && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === doc.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: doc.name,\r\n              uuid: doc.uuid,\r\n              source: pack.title,\r\n              type: rrType\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displayRRTargetSearchResults(results, rrIndex, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display RR target search results\r\n   */\r\n  private _displayRRTargetSearchResults(results: any[], rrIndex: number, resultsDiv: HTMLElement): void {\r\n    let html = '';\r\n    \r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const typeLabel = result.type === 'skill' \r\n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\r\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\r\n        \r\n        html += `\r\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\r\n            </div>\r\n            <button class=\"add-rr-target-btn\" data-target-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers to buttons\r\n    $(resultsDiv).find('.add-rr-target-btn').on('click', this._onSelectRRTarget.bind(this));\r\n    \r\n    // Make entire result items clickable\r\n    $(resultsDiv).find('.search-result-item:not(.no-results)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-rr-target-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-rr-target-btn')[0] as HTMLButtonElement;\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle selecting an RR target from search results\r\n   */\r\n  private async _onSelectRRTarget(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const targetName = button.dataset.targetName;\r\n    const rrIndex = parseInt(button.dataset.rrIndex || '0');\r\n    \r\n    if (!targetName) return;\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    if (rrList[rrIndex]) {\r\n      rrList[rrIndex] = { ...rrList[rrIndex], rrTarget: targetName };\r\n    }\r\n    \r\n    await this.item.update({ 'system.rrList': rrList } as any);\r\n    this.render(false);\r\n    \r\n    ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: targetName }));\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search focus\r\n   */\r\n  private _onRRTargetSearchFocus(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search blur\r\n   */\r\n  private _onRRTargetSearchBlur(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n  }\r\n\r\n  /**\r\n   * Handle power skill search input\r\n   */\r\n  private async _onPowerSkillSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const fieldName = input.dataset.field || '';\r\n    const resultsDiv = $(input).siblings('.power-skill-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.powerSearchTimeout) {\r\n      clearTimeout(this.powerSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.powerSearchTimeout = setTimeout(async () => {\r\n      await this._performPowerSkillSearch(searchTerm, fieldName, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual power skill search\r\n   */\r\n  private async _performPowerSkillSearch(searchTerm: string, fieldName: string, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    \r\n    // Search in actor items if this feat is on an actor\r\n    if (this.item.actor) {\r\n      for (const item of this.item.actor.items as any) {\r\n        if (item.type === 'skill' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n            type: 'skill'\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in world items\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === 'skill' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === item.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: item.name,\r\n              uuid: item.uuid,\r\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n              type: 'skill'\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for skills that match the search term\r\n      for (const doc of documents) {\r\n        if (doc.type === 'skill' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === doc.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: doc.name,\r\n              uuid: doc.uuid,\r\n              source: pack.title,\r\n              type: 'skill'\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displayPowerSkillSearchResults(results, fieldName, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display power skill search results\r\n   */\r\n  private _displayPowerSkillSearchResults(results: any[], fieldName: string, resultsDiv: HTMLElement): void {\r\n    let html = '';\r\n    \r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        html += `\r\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-field=\"${fieldName}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source}</span>\r\n            </div>\r\n            <button class=\"select-power-skill-btn\" data-target-name=\"${result.name}\" data-field=\"${fieldName}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Use mousedown instead of click to capture before blur event\r\n    // This ensures handlers work even when results are replaced\r\n    $(resultsDiv).off('mousedown', '.select-power-skill-btn');\r\n    $(resultsDiv).off('mousedown', '.search-result-item');\r\n    \r\n    $(resultsDiv).on('mousedown', '.select-power-skill-btn', this._onSelectPowerSkill.bind(this));\r\n    \r\n    // Make entire result items clickable (except no-results)\r\n    $(resultsDiv).on('mousedown', '.search-result-item:not(.no-results)', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.select-power-skill-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its mousedown\r\n      const button = $(event.currentTarget).find('.select-power-skill-btn')[0] as HTMLButtonElement;\r\n      if (button) {\r\n        $(button).trigger('mousedown');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle selecting a power skill from search results\r\n   */\r\n  private async _onSelectPowerSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    event.stopImmediatePropagation(); // Prevent document click handler from firing\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const targetName = button.dataset.targetName;\r\n    const fieldName = button.dataset.field;\r\n    \r\n    if (!targetName || !fieldName) return;\r\n    \r\n    // Find the container and input field\r\n    const container = $(button).closest('.power-skill-search-container');\r\n    const input = container.find(`input[name=\"system.${fieldName}\"]`)[0] as HTMLInputElement;\r\n    \r\n    if (input) {\r\n      input.value = targetName;\r\n      // Trigger change event to save\r\n      $(input).trigger('change');\r\n    }\r\n    \r\n    // Hide results immediately\r\n    const resultsDiv = container.find('.power-skill-search-results')[0] as HTMLElement;\r\n    if (resultsDiv) {\r\n      resultsDiv.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle power skill search focus\r\n   */\r\n  private _onPowerSkillSearchFocus(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.power-skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle power skill search blur\r\n   */\r\n  private _onPowerSkillSearchBlur(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.power-skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused or being clicked\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        // Check if mouse is over the results div (user might be clicking)\r\n        const mouseEvent = (event as any).originalEvent;\r\n        if (mouseEvent && mouseEvent.relatedTarget && resultsDiv.contains(mouseEvent.relatedTarget as HTMLElement)) {\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 300); // Increased delay to allow button clicks to register\r\n  }\r\n\r\n  /**\r\n   * Handle power spec search input\r\n   */\r\n  private async _onPowerSpecSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const fieldName = input.dataset.field || '';\r\n    const resultsDiv = $(input).siblings('.power-spec-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.powerSearchTimeout) {\r\n      clearTimeout(this.powerSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.powerSearchTimeout = setTimeout(async () => {\r\n      await this._performPowerSpecSearch(searchTerm, fieldName, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual power spec search\r\n   */\r\n  private async _performPowerSpecSearch(searchTerm: string, fieldName: string, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    \r\n    // Search in actor items if this feat is on an actor\r\n    if (this.item.actor) {\r\n      for (const item of this.item.actor.items as any) {\r\n        if (item.type === 'specialization' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n            type: 'specialization'\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in world items\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === 'specialization' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === item.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: item.name,\r\n              uuid: item.uuid,\r\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n              type: 'specialization'\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for specializations that match the search term\r\n      for (const doc of documents) {\r\n        if (doc.type === 'specialization' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === doc.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: doc.name,\r\n              uuid: doc.uuid,\r\n              source: pack.title,\r\n              type: 'specialization'\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displayPowerSpecSearchResults(results, fieldName, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display power spec search results\r\n   */\r\n  private _displayPowerSpecSearchResults(results: any[], fieldName: string, resultsDiv: HTMLElement): void {\r\n    let html = '';\r\n    \r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        html += `\r\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-field=\"${fieldName}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source}</span>\r\n            </div>\r\n            <button class=\"select-power-spec-btn\" data-target-name=\"${result.name}\" data-field=\"${fieldName}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Use mousedown instead of click to capture before blur event\r\n    // This ensures handlers work even when results are replaced\r\n    $(resultsDiv).off('mousedown', '.select-power-spec-btn');\r\n    $(resultsDiv).off('mousedown', '.search-result-item');\r\n    \r\n    $(resultsDiv).on('mousedown', '.select-power-spec-btn', this._onSelectPowerSpec.bind(this));\r\n    \r\n    // Make entire result items clickable (except no-results)\r\n    $(resultsDiv).on('mousedown', '.search-result-item:not(.no-results)', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.select-power-spec-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its mousedown\r\n      const button = $(event.currentTarget).find('.select-power-spec-btn')[0] as HTMLButtonElement;\r\n      if (button) {\r\n        $(button).trigger('mousedown');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle selecting a power spec from search results\r\n   */\r\n  private async _onSelectPowerSpec(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    event.stopImmediatePropagation(); // Prevent document click handler from firing\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const targetName = button.dataset.targetName;\r\n    const fieldName = button.dataset.field;\r\n    \r\n    if (!targetName || !fieldName) return;\r\n    \r\n    // Find the container and input field\r\n    const container = $(button).closest('.power-spec-search-container');\r\n    const input = container.find(`input[name=\"system.${fieldName}\"]`)[0] as HTMLInputElement;\r\n    \r\n    if (input) {\r\n      input.value = targetName;\r\n      // Trigger change event to save\r\n      $(input).trigger('change');\r\n    }\r\n    \r\n    // Hide results immediately\r\n    const resultsDiv = container.find('.power-spec-search-results')[0] as HTMLElement;\r\n    if (resultsDiv) {\r\n      resultsDiv.style.display = 'none';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle power spec search focus\r\n   */\r\n  private _onPowerSpecSearchFocus(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.power-spec-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle power spec search blur\r\n   */\r\n  private _onPowerSpecSearchBlur(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.power-spec-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused or being clicked\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        // Check if mouse is over the results div (user might be clicking)\r\n        const mouseEvent = (event as any).originalEvent;\r\n        if (mouseEvent && mouseEvent.relatedTarget && resultsDiv.contains(mouseEvent.relatedTarget as HTMLElement)) {\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 300); // Increased delay to allow button clicks to register\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.rr-target-search');\r\n    $(document).off('click.power-search');\r\n    return super.close(options);\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData) as any;\r\n    \r\n    // If astral projection is enabled, automatically enable astral perception\r\n    if (expandedData.system?.astralProjection === true) {\r\n      expandedData.system.astralPerception = true;\r\n    }\r\n    \r\n    // Check if isFirstFeat is being set to true for a trait\r\n    if (expandedData.system?.isFirstFeat === true && \r\n        expandedData.system?.featType === 'trait' && \r\n        this.item.actor) {\r\n      \r\n      // Find all other traits on the same actor that have isFirstFeat = true\r\n      const otherFirstFeats = this.item.actor.items.filter((item: any) => \r\n        item.type === 'feat' &&\r\n        item.id !== this.item.id &&\r\n        item.system?.featType === 'trait' &&\r\n        item.system?.isFirstFeat === true\r\n      );\r\n      \r\n      // If there are other traits with isFirstFeat, uncheck them\r\n      if (otherFirstFeats.length > 0) {\r\n        for (const otherFeat of otherFirstFeats) {\r\n          await otherFeat.update({\r\n            'system.isFirstFeat': false\r\n          } as any);\r\n        }\r\n        \r\n        ui.notifications?.info(\r\n          game.i18n!.localize('SRA2.FEATS.FIRST_FEAT_TRANSFERRED') || \r\n          'The \"first trait\" flag has been moved from the other trait(s) to this one.'\r\n        );\r\n      }\r\n    }\r\n    \r\n    // Update the item first to recalculate recommendedLevel\r\n    await this.item.update(expandedData);\r\n    \r\n    // Recalculate derived data to get the new recommendedLevel\r\n    this.item.prepareData();\r\n    \r\n    // Sync rating with recommendedLevel\r\n    const recommendedLevel = (this.item.system as any).recommendedLevel || 0;\r\n    const currentRating = (this.item.system as any).rating || 0;\r\n    \r\n    // Only update rating if it's different from recommendedLevel\r\n    if (currentRating !== recommendedLevel) {\r\n      await this.item.update({\r\n        'system.rating': recommendedLevel\r\n      } as any);\r\n    }\r\n    \r\n    return this.item;\r\n  }\r\n}\r\n\r\n","/**\r\n * Skill Sheet Application\r\n */\r\nexport class SkillSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'skill'],\r\n      template: 'systems/sra2/templates/item-skill-sheet.hbs',\r\n      width: 520,\r\n      height: 480,\r\n      tabs: [],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    return context;\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n}\r\n\r\n","import * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Specialization Sheet Application\r\n */\r\nexport class SpecializationSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'specialization'],\r\n      template: 'systems/sra2/templates/item-specialization-sheet.hbs',\r\n      width: 520,\r\n      height: 480,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dropSelector: '.linked-skill-drop-zone' }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    \r\n    // Get linked skill info if exists\r\n    if (context.system.linkedSkill) {\r\n      // linkedSkill is stored as a name, so we display it directly\r\n      context.linkedSkillName = context.system.linkedSkill;\r\n      \r\n      // If the specialization is on an actor, check if the skill exists\r\n      if (this.item.actor) {\r\n        const linkedSkill = this.item.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === context.system.linkedSkill\r\n        );\r\n        \r\n        if (!linkedSkill) {\r\n          // Mark as warning if skill doesn't exist on this actor\r\n          context.linkedSkillNotFound = true;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Get list of skills from the actor if this item is owned (for dropdown)\r\n    if (this.item.actor) {\r\n      const skills = this.item.actor.items.filter((i: any) => i.type === 'skill');\r\n      context.skills = skills.map((s: any) => ({\r\n        name: s.name\r\n      }));\r\n    } else {\r\n      context.skills = [];\r\n    }\r\n    \r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Clear linked skill button\r\n    html.find('[data-action=\"clear-linked-skill\"]').on('click', this._onClearLinkedSkill.bind(this));\r\n    \r\n    // Skill search\r\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\r\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\r\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\r\n    \r\n    // Close skill search results when clicking outside\r\n    $(document).on('click.skill-search-spec', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\r\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\r\n        html.find('.skill-search-results').hide();\r\n      }\r\n    });\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.skill-search-spec');\r\n    return super.close(options);\r\n  }\r\n\r\n  /**\r\n   * Handle clearing the linked skill\r\n   */\r\n  private async _onClearLinkedSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    await this.item.update({ 'system.linkedSkill': '' } as any);\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping a skill onto the linked skill field\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    const data = TextEditor.getDragEventData(event) as any;\r\n    \r\n    // Handle Item drops\r\n    if (data && data.type === 'Item') {\r\n      const item = await Item.implementation.fromDropData(data) as any;\r\n      \r\n      if (!item) return super._onDrop(event);\r\n      \r\n      // Check if it's a skill\r\n      if (item.type === 'skill') {\r\n        // Store the skill name (not ID) so the specialization can be prepared in advance\r\n        await this.item.update({ 'system.linkedSkill': item.name } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.LINKED_TO_SKILL', { name: item.name }));\r\n        return;\r\n      } else {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.ONLY_SKILLS_CAN_BE_LINKED'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    return super._onDrop(event);\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n\r\n  /**\r\n   * SKILL SEARCH FUNCTIONS\r\n   */\r\n  \r\n  private skillSearchTimeout: any = null;\r\n  private lastSkillSearchTerm: string = '';\r\n  \r\n  /**\r\n   * Handle skill search input\r\n   */\r\n  private async _onSkillSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.skillSearchTimeout) {\r\n      clearTimeout(this.skillSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.skillSearchTimeout = setTimeout(async () => {\r\n      await this._performSkillSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual skill search in compendiums and world items\r\n   */\r\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    \r\n    // Store search term for potential creation\r\n    this.lastSkillSearchTerm = searchTerm;\r\n    \r\n    // Search in world items first\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === 'skill' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            pack: game.i18n!.localize('SRA2.SPECIALIZATIONS.WORLD_ITEMS'),\r\n            linkedAttribute: item.system.linkedAttribute,\r\n            isWorldItem: true\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for skills that match the search term\r\n      for (const doc of documents) {\r\n        if (doc.type === 'skill' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: doc.name,\r\n            uuid: doc.uuid,\r\n            pack: pack.title,\r\n            linkedAttribute: doc.system.linkedAttribute,\r\n            isWorldItem: false\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displaySkillSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display skill search results\r\n   */\r\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\r\n    // Check if exact match exists\r\n    const formattedSearchTerm = this.lastSkillSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatch = results.find((r: any) => \r\n      ItemSearch.normalizeSearchText(r.name) === ItemSearch.normalizeSearchText(this.lastSkillSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SPECIALIZATIONS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSkillSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${result.linkedAttribute.toUpperCase()}`);\r\n        \r\n        html += `\r\n          <div class=\"search-result-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.pack} - ${attributeLabel}</span>\r\n            </div>\r\n            <button class=\"link-skill-btn\" data-skill-name=\"${result.name}\">\r\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.LINK_SKILL')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist\r\n      if (!exactMatch) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_NEW_SKILL')}</span>\r\n            </div>\r\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSkillSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers\r\n    $(resultsDiv).find('.link-skill-btn').on('click', this._onLinkSkillFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\r\n    \r\n    // Make entire result items clickable (except create button)\r\n    $(resultsDiv).find('.search-result-item:not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.link-skill-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.link-skill-btn')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle linking a skill from search results\r\n   */\r\n  private async _onLinkSkillFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Link the skill to the specialization\r\n    await this.item.update({ 'system.linkedSkill': skillName } as any);\r\n    \r\n    // Clear the search input and hide results\r\n    const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n    if (searchInput) {\r\n      searchInput.value = '';\r\n    }\r\n    \r\n    const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n    if (resultsDiv) {\r\n      resultsDiv.style.display = 'none';\r\n    }\r\n    \r\n    this.render(false);\r\n    ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_LINKED', { name: skillName }));\r\n  }\r\n\r\n  /**\r\n   * Handle skill search focus\r\n   */\r\n  private _onSkillSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle skill search blur\r\n   */\r\n  private _onSkillSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle creating a new skill from search and linking it\r\n   */\r\n  private async _onCreateNewSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = skillName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new skill as a world item with default values\r\n    const skillData = {\r\n      name: formattedName,\r\n      type: 'skill',\r\n      system: {\r\n        rating: 1,\r\n        linkedAttribute: 'strength',\r\n        description: ''\r\n      }\r\n    } as any;\r\n    \r\n    // Create as a world item\r\n    const createdItems = await Item.create(skillData) as any;\r\n    \r\n    if (createdItems) {\r\n      // Link the skill to the specialization\r\n      await this.item.update({ 'system.linkedSkill': formattedName } as any);\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      this.render(false);\r\n      \r\n      // Open the skill sheet for editing\r\n      setTimeout(() => {\r\n        if (createdItems.sheet) {\r\n          createdItems.sheet.render(true);\r\n        }\r\n      }, 100);\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_CREATED_AND_LINKED', { name: formattedName }));\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * Metatype Sheet Application\r\n */\r\nexport class MetatypeSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'metatype'],\r\n      template: 'systems/sra2/templates/item-metatype-sheet.hbs',\r\n      width: 520,\r\n      height: 580,\r\n      tabs: [],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    return context;\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n}\r\n\r\n","import { RollRequestData } from '../helpers/dice-roller.js';\r\nimport * as DiceRoller from '../helpers/dice-roller.js';\r\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\nimport { WEAPON_TYPES } from '../models/item-feat.js';\r\nimport shadowAmpProbabilities from '../config/shadow-amp-probabilities.json';\r\n\r\n/**\r\n * Roll Dialog Application\r\n * Displays roll information in a popup dialog\r\n */\r\nexport class RollDialog extends Application {\r\n  private rollData: RollRequestData;\r\n  private actor: any = null;\r\n  private attackerToken: any = null;\r\n  private targetToken: any = null;\r\n  private rrEnabled: Map<string, boolean> = new Map(); // Track which RR sources are enabled\r\n  private riskDiceCount: number = 0; // Number of risk dice selected (will be auto-set based on RR)\r\n  private riskDiceManuallySet: boolean = false; // Track if user has manually changed risk dice selection\r\n  private lastAutoRR: number = -1; // Track last RR value used for auto-selection\r\n  private selectedRange: string | null = null; // Selected range: 'melee', 'short', 'medium', 'long'\r\n  private rollMode: 'normal' | 'disadvantage' | 'advantage' = 'normal'; // Roll mode\r\n  private manualRRBonus: string = ''; // Manual RR bonus entered by user\r\n\r\n  constructor(rollData: RollRequestData) {\r\n    super();\r\n    this.rollData = rollData;\r\n    \r\n    // Get actor from roll data\r\n    if (rollData.actorUuid) {\r\n      this.actor = (fromUuidSync as any)(rollData.actorUuid);\r\n    } else if (rollData.actorId) {\r\n      this.actor = game.actors?.get(rollData.actorId) || null;\r\n    }\r\n    \r\n    // Get attacker token (priority: rollData.attackerTokenUuid > canvas search)\r\n    if (rollData.attackerTokenUuid) {\r\n      try {\r\n        this.attackerToken = (foundry.utils as any)?.fromUuidSync?.(rollData.attackerTokenUuid) || null;\r\n        console.log('RollDialog: Attacker token loaded from UUID:', rollData.attackerTokenUuid);\r\n      } catch (e) {\r\n        console.warn('RollDialog: Failed to load attacker token from UUID:', e);\r\n      }\r\n    }\r\n    \r\n    // If no attacker token from UUID, try to find it on canvas\r\n    if (!this.attackerToken && this.actor) {\r\n      this.attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\r\n      }) || null;\r\n      if (this.attackerToken) {\r\n        console.log('RollDialog: Attacker token found on canvas');\r\n      }\r\n    }\r\n    \r\n    // Get target token (first targeted token)\r\n    const targets = Array.from(game.user?.targets || []);\r\n    if (targets.length > 0) {\r\n      this.targetToken = targets[0] || null;\r\n    }\r\n    \r\n    // For vehicle weapons, we should prioritize selected targets over vehicle UUID\r\n    // The defender should be the target, not the vehicle/drone itself\r\n    const isVehicleWeapon = rollData.isVehicleWeapon;\r\n    \r\n    // Also try to get defender token from rollData.defenderTokenUuid if available\r\n    // Priority: selected targets > rollData.defenderTokenUuid (unless no targets selected)\r\n    // For vehicle weapons, always prioritize selected targets to avoid using the drone as defender\r\n    if (!this.targetToken && rollData.defenderTokenUuid) {\r\n      try {\r\n        const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(rollData.defenderTokenUuid) || null;\r\n        if (defenderTokenFromUuid) {\r\n          // For vehicle weapons, skip if this is the vehicle itself (we want the target, not the drone)\r\n          if (isVehicleWeapon && rollData.vehicleUuid) {\r\n            const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || defenderTokenFromUuid?.document?.actorLink ? defenderTokenFromUuid?.actor?.uuid : undefined;\r\n            if (tokenActorUuid === rollData.vehicleUuid) {\r\n              console.log('RollDialog: Skipping vehicle token as defender for vehicle weapon - need target instead');\r\n            } else {\r\n              this.targetToken = defenderTokenFromUuid;\r\n              console.log('RollDialog: Defender token loaded from UUID:', rollData.defenderTokenUuid);\r\n            }\r\n          } else {\r\n            this.targetToken = defenderTokenFromUuid;\r\n            console.log('RollDialog: Defender token loaded from UUID:', rollData.defenderTokenUuid);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.warn('RollDialog: Failed to load defender token from UUID:', e);\r\n      }\r\n    }\r\n    \r\n    // If still no target token, try to find it on canvas based on defender info\r\n    if (!this.targetToken && rollData.defenderTokenUuid) {\r\n      // Try to find on canvas as fallback\r\n      const foundToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.uuid === rollData.defenderTokenUuid || \r\n               token.document?.uuid === rollData.defenderTokenUuid;\r\n      }) || null;\r\n      \r\n      // For vehicle weapons, skip if this is the vehicle itself\r\n      if (foundToken && isVehicleWeapon && rollData.vehicleUuid) {\r\n        const tokenActorUuid = foundToken?.actor?.uuid || undefined;\r\n        if (tokenActorUuid !== rollData.vehicleUuid) {\r\n          this.targetToken = foundToken;\r\n        }\r\n      } else if (foundToken) {\r\n        this.targetToken = foundToken;\r\n      }\r\n    }\r\n    \r\n    // Auto-select best weapon for counter-attack\r\n    if (rollData.isCounterAttack && rollData.availableWeapons && rollData.availableWeapons.length > 0 && this.actor) {\r\n      this.autoSelectWeaponForCounterAttack();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Auto-select the best weapon for counter-attack\r\n   * Priority: 1) Weapon with highest damage value, 2) Combat rapproché skill\r\n   */\r\n  private autoSelectWeaponForCounterAttack(): void {\r\n    if (!this.rollData.availableWeapons || !this.actor) return;\r\n    \r\n    // Find weapon with highest damage value\r\n    let bestWeapon: any = null;\r\n    let highestDamage = -1;\r\n    \r\n    for (const weapon of this.rollData.availableWeapons) {\r\n      const damageValueStr = weapon.damageValue || '0';\r\n      let damageValue = 0;\r\n      \r\n      // Parse damage value (handle FOR, FOR+X, or numeric)\r\n      if (damageValueStr === 'FOR') {\r\n        damageValue = (this.actor.system as any)?.attributes?.strength || 1;\r\n      } else if (damageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n        damageValue = ((this.actor.system as any)?.attributes?.strength || 1) + bonus;\r\n      } else {\r\n        damageValue = parseInt(damageValueStr, 10) || 0;\r\n      }\r\n      \r\n      // Add bonus\r\n      damageValue += weapon.damageValueBonus || 0;\r\n      \r\n      if (damageValue > highestDamage) {\r\n        highestDamage = damageValue;\r\n        bestWeapon = weapon;\r\n      }\r\n    }\r\n    \r\n    // If we found a weapon with damage, select it\r\n    if (bestWeapon && highestDamage > 0) {\r\n      this.selectWeaponForCounterAttack(bestWeapon.id);\r\n    } else {\r\n      // Otherwise, select \"Combat rapproché\" skill\r\n      this.selectCombatRapprocheSkill();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Select a specific weapon for counter-attack\r\n   */\r\n  private selectWeaponForCounterAttack(weaponId: string): void {\r\n    if (!this.rollData.availableWeapons || !this.actor) return;\r\n    \r\n    const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\r\n    if (!selectedWeapon) return;\r\n    \r\n    // Get the actual weapon item\r\n    const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\r\n    const weaponSystem = actualWeapon?.system as any;\r\n    \r\n    // Get weapon type data from WEAPON_TYPES if available\r\n    const wepTypeName = weaponSystem?.weaponType;\r\n    const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\r\n    \r\n    // Get linkedAttackSkill and linkedAttackSpecialization\r\n    let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\r\n    const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\r\n    \r\n    // Calculate damage value with bonus from active feats (including adept powers)\r\n    const baseDamageValue = selectedWeapon.damageValue || weaponSystem?.damageValue || '0';\r\n    let damageValueBonus = selectedWeapon.damageValueBonus || weaponSystem?.damageValueBonus || 0;\r\n    \r\n    // Add bonus from active feats that match the weapon's type (including adept powers)\r\n    const weaponType = wepTypeName || '';\r\n    if (weaponType && this.actor) {\r\n      const activeFeats = this.actor.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.active === true &&\r\n        item.system.weaponDamageBonus > 0 &&\r\n        item.system.weaponTypeBonus === weaponType\r\n      );\r\n      \r\n      activeFeats.forEach((activeFeat: any) => {\r\n        damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n      });\r\n    }\r\n    \r\n    // Limit total bonus to 2 maximum\r\n    damageValueBonus = Math.min(damageValueBonus, 2);\r\n    \r\n    // Calculate final damage value string\r\n    const damageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n    \r\n    // Default to \"Combat rapproché\" if no skill found\r\n    if (!baseSkillName) {\r\n      baseSkillName = 'Combat rapproché';\r\n    }\r\n    \r\n    // Find the linked skill in actor's items\r\n    const linkedSkillItem = this.actor.items.find((item: any) => \r\n      item.type === 'skill' && item.name === baseSkillName\r\n    );\r\n    \r\n    // Find specializations for the linked skill\r\n    const linkedSpecs = this.actor.items.filter((item: any) => \r\n      item.type === 'specialization' && \r\n      item.system.linkedSkill === baseSkillName\r\n    );\r\n    \r\n    // Check if weapon has a specialization and if actor has that specialization\r\n    let preferredSpecName: string | undefined = undefined;\r\n    if (weaponLinkedSpecialization) {\r\n      const specExists = linkedSpecs.find((spec: any) => \r\n        spec.name === weaponLinkedSpecialization\r\n      );\r\n      if (specExists) {\r\n        preferredSpecName = weaponLinkedSpecialization;\r\n      }\r\n    }\r\n    \r\n    // Calculate skill level and linked attribute\r\n    let skillLevel: number | undefined = undefined;\r\n    let specLevel: number | undefined = undefined;\r\n    let linkedAttribute: string | undefined = undefined;\r\n    let skillName: string | undefined = baseSkillName;\r\n    let specName: string | undefined = undefined;\r\n    \r\n    if (linkedSkillItem) {\r\n      const skillSystem = linkedSkillItem.system as any;\r\n      const skillRating = skillSystem.rating || 0;\r\n      linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n      \r\n      skillLevel = attributeValue + skillRating;\r\n    }\r\n    \r\n    // Get RR sources\r\n    let rrList: any[] = [];\r\n    \r\n    // Get RR from weapon itself\r\n    const weaponRRList = weaponSystem?.rrList || [];\r\n    const itemRRList = weaponRRList.map((rrEntry: any) => ({\r\n      ...rrEntry,\r\n      featName: selectedWeapon.name\r\n    }));\r\n    \r\n    let skillSpecRRList: any[] = [];\r\n    \r\n    if (preferredSpecName) {\r\n      // Use specialization\r\n      specName = preferredSpecName;\r\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n      const parentSkill = linkedSkillItem;\r\n      const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n      specLevel = attributeValue + skillRating + 2;\r\n      \r\n      const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\r\n      const skillRRSources = linkedSkillItem ? SheetHelpers.getRRSources(this.actor, 'skill', baseSkillName) : [];\r\n      const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n      \r\n      skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n    } else {\r\n      // Use skill\r\n      if (skillName) {\r\n        const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n        const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n        \r\n        skillSpecRRList = [...skillRRSources, ...attributeRRSources];\r\n      }\r\n    }\r\n    \r\n    // Merge weapon RR with skill/spec/attribute RR\r\n    rrList = [...itemRRList, ...skillSpecRRList];\r\n    \r\n    // Get weapon ranges\r\n    const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\r\n    const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\r\n    const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\r\n    const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\r\n    \r\n    // Update roll data\r\n    this.rollData.skillName = skillName;\r\n    this.rollData.specName = specName;\r\n    this.rollData.linkedAttackSkill = baseSkillName;\r\n    this.rollData.linkedAttribute = linkedAttribute;\r\n    this.rollData.skillLevel = skillLevel;\r\n    this.rollData.specLevel = specLevel;\r\n    this.rollData.itemName = selectedWeapon.name;\r\n    this.rollData.itemType = 'weapon';\r\n    this.rollData.damageValue = damageValue;\r\n    this.rollData.damageValueBonus = damageValueBonus;\r\n    this.rollData.rrList = rrList;\r\n    this.rollData.selectedWeaponId = weaponId;\r\n    this.rollData.meleeRange = meleeRange;\r\n    this.rollData.shortRange = shortRange;\r\n    this.rollData.mediumRange = mediumRange;\r\n    this.rollData.longRange = longRange;\r\n    this.rollData.weaponType = wepTypeName;\r\n  }\r\n  \r\n  /**\r\n   * Select Combat rapproché skill for counter-attack\r\n   */\r\n  private selectCombatRapprocheSkill(): void {\r\n    if (!this.actor) return;\r\n    \r\n    const combatRapprocheSkill = this.actor.items.find((item: any) => \r\n      item.type === 'skill' && item.name === 'Combat rapproché'\r\n    );\r\n    \r\n    if (!combatRapprocheSkill) return;\r\n    \r\n    const skillSystem = combatRapprocheSkill.system as any;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (this.actor.system as any)?.attributes?.[linkedAttribute] || 0;\r\n    const skillLevel = attributeValue + skillRating;\r\n    \r\n    // Get RR sources\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', 'Combat rapproché');\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    const rrList = [...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Update roll data\r\n    this.rollData.skillName = 'Combat rapproché';\r\n    this.rollData.specName = undefined;\r\n    this.rollData.linkedAttackSkill = 'Combat rapproché';\r\n    this.rollData.linkedAttribute = linkedAttribute;\r\n    this.rollData.skillLevel = skillLevel;\r\n    this.rollData.specLevel = undefined;\r\n    this.rollData.itemName = undefined;\r\n    this.rollData.itemType = undefined;\r\n    this.rollData.damageValue = 'FOR'; // Bare hands damage\r\n    this.rollData.damageValueBonus = 0;\r\n    this.rollData.rrList = rrList;\r\n    this.rollData.selectedWeaponId = undefined;\r\n  }\r\n\r\n  static override get defaultOptions(): any {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'roll-dialog'],\r\n      template: 'systems/sra2/templates/roll-dialog.hbs',\r\n      width: 760,\r\n      height: 630,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Jet de Dés'\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context: any = {\r\n      rollData: this.rollData,\r\n      actor: this.actor,\r\n      targetToken: this.targetToken\r\n    };\r\n\r\n    // Calculate distance between protagonist and target\r\n    let distance: number | null = null;\r\n    let distanceText: string = '';\r\n    \r\n    if (this.actor && this.targetToken && canvas?.grid) {\r\n      // Get protagonist token\r\n      const protagonistToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\r\n      });\r\n      \r\n      if (protagonistToken && this.targetToken) {\r\n        try {\r\n          // Calculate distance using Foundry's grid measurement\r\n          const grid = canvas.grid as any;\r\n          const distancePixels = grid.measureDistance(\r\n            { x: protagonistToken.x, y: protagonistToken.y },\r\n            { x: this.targetToken.x, y: this.targetToken.y },\r\n            { gridSpaces: true }\r\n          );\r\n          \r\n          if (typeof distancePixels === 'number' && !isNaN(distancePixels)) {\r\n            distance = Math.round(distancePixels * 10) / 10; // Round to 1 decimal\r\n            \r\n            // Get grid units from scene\r\n            const scene = canvas?.scene;\r\n            const gridUnits = (scene?.grid as any)?.units || 'm';\r\n            distanceText = `${distance} ${gridUnits}`;\r\n          }\r\n        } catch (e) {\r\n          // Fallback: calculate euclidean distance\r\n          const dx = this.targetToken.x - protagonistToken.x;\r\n          const dy = this.targetToken.y - protagonistToken.y;\r\n          const pixelDistance = Math.sqrt(dx * dx + dy * dy);\r\n          const gridSize = (canvas.grid as any)?.size || 1;\r\n          const gridDistance = pixelDistance / gridSize;\r\n          distance = Math.round(gridDistance * 10) / 10;\r\n          \r\n          const scene = canvas?.scene;\r\n          const gridUnits = (scene?.grid as any)?.units || 'm';\r\n          distanceText = `${distance} ${gridUnits}`;\r\n        }\r\n      }\r\n    }\r\n    \r\n    context.distance = distance;\r\n    context.distanceText = distanceText;\r\n\r\n    // Calculate range based on distance for default selection (only if not already selected by user)\r\n    let calculatedRange: string | null = null;\r\n    \r\n    // Calculate what range should be based on distance (for display purposes)\r\n    if (distance !== null) {\r\n      if (distance < 3) {\r\n        calculatedRange = 'melee';\r\n      } else if (distance >= 3 && distance <= 15) {\r\n        calculatedRange = 'short';\r\n      } else if (distance > 15 && distance <= 60) {\r\n        calculatedRange = 'medium';\r\n      } else if (distance > 60) {\r\n        calculatedRange = 'long';\r\n      }\r\n    }\r\n\r\n    // Only set default range if user hasn't selected one yet\r\n    if (this.selectedRange === null) {\r\n      // For counter-attacks, always default to melee range\r\n      if (this.rollData.isCounterAttack) {\r\n        this.selectedRange = 'melee';\r\n      } else if (calculatedRange !== null) {\r\n        // For other cases, use calculated range based on distance\r\n      this.selectedRange = calculatedRange;\r\n    }\r\n    }\r\n    // If selectedRange is already set, don't change it (user selection is preserved)\r\n\r\n    // Get weapon range properties\r\n    const meleeRange = this.rollData.meleeRange || 'none';\r\n    const shortRange = this.rollData.shortRange || 'none';\r\n    const mediumRange = this.rollData.mediumRange || 'none';\r\n    const longRange = this.rollData.longRange || 'none';\r\n\r\n    // Check if this is a weapon roll (has range properties)\r\n    const isWeaponRoll = this.rollData.itemType === 'weapon' || \r\n                         this.rollData.weaponType !== undefined ||\r\n                         (meleeRange !== 'none' || shortRange !== 'none' || mediumRange !== 'none' || longRange !== 'none');\r\n\r\n    // Get range value for selected range\r\n    let selectedRangeValue: string | null = null;\r\n    if (this.selectedRange === 'melee') {\r\n      selectedRangeValue = meleeRange;\r\n    } else if (this.selectedRange === 'short') {\r\n      selectedRangeValue = shortRange;\r\n    } else if (this.selectedRange === 'medium') {\r\n      selectedRangeValue = mediumRange;\r\n    } else if (this.selectedRange === 'long') {\r\n      selectedRangeValue = longRange;\r\n    }\r\n\r\n    // Determine roll mode based on range value (but allow user to override)\r\n    if (selectedRangeValue === 'disadvantage') {\r\n      this.rollMode = 'disadvantage';\r\n    } else if (selectedRangeValue === 'ok') {\r\n      this.rollMode = 'normal';\r\n    }\r\n    // Allow selection even if range is 'none' - user can still roll\r\n\r\n    // Check if actor has severe wound - force disadvantage mode\r\n    let hasSevereWound = false;\r\n    if (this.actor) {\r\n      const actorSystem = this.actor.system as any;\r\n      if (actorSystem.damage && actorSystem.damage.severe) {\r\n        // Check if at least one severe wound is marked (true)\r\n        hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                         actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n      }\r\n    }\r\n    \r\n    // Force disadvantage mode if actor has severe wound\r\n    if (hasSevereWound) {\r\n      this.rollMode = 'disadvantage';\r\n    }\r\n\r\n    context.isWeaponRoll = isWeaponRoll;\r\n    // Check if this is a skill/spec/attribute roll (not a weapon roll and not a defense roll)\r\n    context.isSkillSpecAttributeRoll = !isWeaponRoll && !this.rollData.isDefend && \r\n                                       (this.rollData.skillName || this.rollData.specName || this.rollData.linkedAttribute);\r\n    context.calculatedRange = calculatedRange;\r\n    context.selectedRange = this.selectedRange;\r\n    context.selectedRangeValue = selectedRangeValue;\r\n    context.rollMode = this.rollMode;\r\n    context.hasSevereWound = hasSevereWound; // Pass to template to disable mode selection\r\n    context.rangeOptions = {\r\n      melee: { label: 'Mêlée (< 3m)', value: meleeRange },\r\n      short: { label: 'Portée courte (3-15m)', value: shortRange },\r\n      medium: { label: 'Portée moyenne (15-60m)', value: mediumRange },\r\n      long: { label: 'Portée longue (> 60m)', value: longRange }\r\n    };\r\n\r\n    // Calculate dice pool\r\n    let dicePool = 0;\r\n    if (this.rollData.specLevel !== undefined) {\r\n      dicePool = this.rollData.specLevel;\r\n    } else if (this.rollData.skillLevel !== undefined) {\r\n      dicePool = this.rollData.skillLevel;\r\n    } else if (this.rollData.linkedAttribute) {\r\n      const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n      dicePool = attributeValue;\r\n    }\r\n    \r\n    // Debug: Log dice pool calculation\r\n    console.log('SRA2 | RollDialog - Dice pool calculation:', {\r\n      specLevel: this.rollData.specLevel,\r\n      skillLevel: this.rollData.skillLevel,\r\n      linkedAttribute: this.rollData.linkedAttribute,\r\n      itemRating: this.rollData.itemRating,\r\n      calculatedDicePool: dicePool,\r\n      skillName: this.rollData.skillName,\r\n      specName: this.rollData.specName\r\n    });\r\n    \r\n    context.dicePool = dicePool;\r\n\r\n    let threshold = this.rollData.threshold;\r\n    context.threshold = threshold;\r\n    context.hasThreshold = threshold !== undefined;\r\n\r\n    // Get skill/spec name\r\n    context.skillDisplayName = this.rollData.specName || this.rollData.skillName || this.rollData.linkedAttackSkill || 'Aucune';\r\n\r\n    // Calculate total RR and get RR sources\r\n    // For defense rolls, always recalculate rrList from defender's skill/spec to ensure we use the correct actor\r\n    // For attack rolls, use rollData.rrList as passed from character-sheet (already merged: item RR + skill/spec/attribute RR)\r\n    // rrList already contains RRSource objects with featName and rrValue (enriched before passing to handleRollRequest)\r\n    \r\n    // For defense rolls, always recalculate rrList from this.actor (the defender) to ensure correctness\r\n    if (this.rollData.isDefend && this.actor) {\r\n      const { getRRSources } = SheetHelpers;\r\n      let defenseRRList: any[] = [];\r\n      \r\n      if (this.rollData.specName) {\r\n        const rrSources = getRRSources(this.actor, 'specialization', this.rollData.specName);\r\n        defenseRRList = rrSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n      } else if (this.rollData.skillName) {\r\n        const rrSources = getRRSources(this.actor, 'skill', this.rollData.skillName);\r\n        defenseRRList = rrSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n      }\r\n      \r\n      // Also add attribute RR if linkedAttribute is set\r\n      if (this.rollData.linkedAttribute) {\r\n        const attributeRRSources = getRRSources(this.actor, 'attribute', this.rollData.linkedAttribute);\r\n        const attributeRRList = attributeRRSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n        defenseRRList = [...defenseRRList, ...attributeRRList];\r\n      }\r\n      \r\n      // Always update rollData with correct rrList from defender\r\n      this.rollData.rrList = defenseRRList;\r\n    }\r\n    // For attack rolls (not defense), use rollData.rrList as is (already merged in character-sheet.ts)\r\n    // The rrList should already contain: item RR + skill/spec/attribute RR\r\n    // No need to recalculate here, it's already correct from the sheet\r\n    \r\n    let totalRR = 0;\r\n    const rrSources: any[] = [];\r\n    if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n      for (const rrSource of this.rollData.rrList) {\r\n        if (rrSource && typeof rrSource === 'object') {\r\n          const rrValue = rrSource.rrValue || 0;\r\n          if (rrValue > 0) {\r\n            // featName is now always present in rrList (enriched in character-sheet.ts)\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const rrId = `${featName}-${rrValue}`;\r\n            \r\n            // Initialize as enabled if not already set\r\n            if (!this.rrEnabled.has(rrId)) {\r\n              this.rrEnabled.set(rrId, true);\r\n            }\r\n            \r\n            const isEnabled = this.rrEnabled.get(rrId) || false;\r\n            \r\n            rrSources.push({\r\n              id: rrId,\r\n              featName: featName,\r\n              rrValue: rrValue,\r\n              enabled: isEnabled\r\n            });\r\n            \r\n            if (isEnabled) {\r\n              totalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // Add manual RR bonus\r\n    totalRR += this.manualRRBonus;\r\n    context.totalRR = Math.min(3, totalRR); // RR is capped at 3\r\n    context.rrSources = rrSources;\r\n    context.manualRRBonus = this.manualRRBonus; // Pass to template\r\n\r\n    // Auto-select risk dice count based on RR (mode normal: 2, 5, 8, 12 for RR 0, 1, 2, 3)\r\n    // Only auto-update if:\r\n    // 1. User hasn't manually set it, OR\r\n    // 2. RR has changed since last auto-selection (reset manual flag)\r\n    const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(context.totalRR);\r\n    const maxRiskDice = Math.min(autoRiskDiceCount, dicePool);\r\n    \r\n    // If RR changed, reset manual flag to allow auto-update\r\n    if (context.totalRR !== this.lastAutoRR) {\r\n      this.riskDiceManuallySet = false;\r\n      this.lastAutoRR = context.totalRR;\r\n    }\r\n    \r\n    // Auto-update only if not manually set\r\n    if (!this.riskDiceManuallySet) {\r\n      this.riskDiceCount = maxRiskDice;\r\n    }\r\n\r\n    // Get VD (Valeur de Défense) - this would be from the target or weapon\r\n    // For now, we'll show weapon VD if available\r\n    context.vd = this.rollData.damageValue || 0;\r\n\r\n    // Calculate risk probabilities based on risk dice count and RR\r\n    const getRiskProbabilities = (riskDice: number, rr: number): any => {\r\n      // If no risk dice, return 100% all good\r\n      if (riskDice <= 0) {\r\n        return {\r\n          allGood: 100.0,\r\n          glitch: 0.0,\r\n          criticalGlitch: 0.0,\r\n          disaster: 0.0\r\n        };\r\n      }\r\n      \r\n      // Clamp values to valid ranges\r\n      const clampedRiskDice = Math.max(1, Math.min(16, riskDice));\r\n      const clampedRR = Math.max(0, Math.min(3, rr));\r\n      \r\n      // Get the condition data for the current RR level\r\n      const probabilitiesData = (shadowAmpProbabilities as any)?.shadowAmpProbabilities || (shadowAmpProbabilities as any);\r\n      const condition = probabilitiesData?.conditions?.find(\r\n        (c: any) => c.id === clampedRR\r\n      );\r\n      \r\n      if (!condition) {\r\n        // Fallback to default values if condition not found\r\n        return {\r\n          allGood: 0,\r\n          glitch: 0,\r\n          criticalGlitch: 0,\r\n          disaster: 0\r\n        };\r\n      }\r\n      \r\n      // Find the data entry for the current dice count\r\n      const diceData = condition.data.find((d: any) => d.dice === clampedRiskDice);\r\n      \r\n      if (!diceData) {\r\n        // If exact match not found, use the closest (shouldn't happen with our data)\r\n        return {\r\n          allGood: 0,\r\n          glitch: 0,\r\n          criticalGlitch: 0,\r\n          disaster: 0\r\n        };\r\n      }\r\n      \r\n      return {\r\n        allGood: diceData.allGood,\r\n        glitch: diceData.glitch,\r\n        criticalGlitch: diceData.criticalGlitch,\r\n        disaster: diceData.disaster\r\n      };\r\n    };\r\n    \r\n    // Calculate probabilities (always calculate, even if no risk dice)\r\n    const riskProbabilities = getRiskProbabilities(this.riskDiceCount, context.totalRR);\r\n    \r\n    // Determine risk level based on Critical Glitch and Disaster probabilities\r\n    // Low to no risk: <2% Critical glitch & < 0.2% Disaster\r\n    // Normal risk: <7.5% Critical glitch & <1% Disaster\r\n    // High risk: <20% Critical glitch & <5% Disaster\r\n    // Extreme risk: >20% Critical glitch or >5% Disaster\r\n    const criticalGlitch = riskProbabilities.criticalGlitch;\r\n    const disaster = riskProbabilities.disaster;\r\n    \r\n    // Same color for all 4 percentages based on the risk level\r\n    let riskColorClass = 'probability-extreme'; // Default to extreme risk\r\n    let riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME';\r\n    if (criticalGlitch < 2 && disaster < 0.2) {\r\n      riskColorClass = 'probability-low';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.LOW_TO_NO';\r\n    } else if (criticalGlitch < 7.5 && disaster < 1) {\r\n      riskColorClass = 'probability-normal';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.NORMAL';\r\n    } else if (criticalGlitch < 20 && disaster < 5) {\r\n      riskColorClass = 'probability-high';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.HIGH';\r\n    } else {\r\n      riskColorClass = 'probability-extreme';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME';\r\n    }\r\n    const riskLevelText = game.i18n?.localize(riskLevelTextKey) || riskLevelTextKey;\r\n    \r\n    // Format probabilities with comma as decimal separator\r\n    context.riskProbabilities = {\r\n      allGood: riskProbabilities.allGood.toFixed(1).replace('.', ','),\r\n      allGoodColorClass: riskColorClass,\r\n      glitch: riskProbabilities.glitch.toFixed(1).replace('.', ','),\r\n      glitchColorClass: riskColorClass,\r\n      criticalGlitch: riskProbabilities.criticalGlitch.toFixed(1).replace('.', ','),\r\n      criticalGlitchColorClass: riskColorClass,\r\n      disaster: riskProbabilities.disaster.toFixed(1).replace('.', ','),\r\n      disasterColorClass: riskColorClass\r\n    };\r\n\r\n    // Generate dice list with risk color based on risk level\r\n    // Map risk color class to dice color name\r\n    const getDiceColorFromRiskClass = (riskClass: string): string => {\r\n      switch (riskClass) {\r\n        case 'probability-low':\r\n          return 'green';\r\n        case 'probability-normal':\r\n          return 'blue';\r\n        case 'probability-high':\r\n          return 'yellow';\r\n        case 'probability-extreme':\r\n          return 'red';\r\n        default:\r\n          return 'green';\r\n      }\r\n    };\r\n    \r\n    const diceColor = getDiceColorFromRiskClass(riskColorClass);\r\n    context.diceList = [];\r\n    context.riskDiceCount = this.riskDiceCount;\r\n    context.riskLevelText = riskLevelText;\r\n    context.riskColorClass = riskColorClass;\r\n    \r\n    for (let i = 0; i < dicePool; i++) {\r\n      context.diceList.push({ \r\n        index: i,\r\n        isRiskDice: i < this.riskDiceCount,  // First N dice are risk dice\r\n        riskColor: diceColor  // Color based on risk level\r\n      });\r\n    }\r\n\r\n    // Get all skills and specializations from actor, organized hierarchically\r\n    if (this.actor) {\r\n      const skills = this.actor.items\r\n        .filter((item: any) => item.type === 'skill')\r\n        .map((skill: any) => {\r\n          const linkedAttribute = skill.system?.linkedAttribute || 'strength';\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\r\n          const skillRating = skill.system?.rating || 0;\r\n          return {\r\n            id: skill.id,\r\n            name: skill.name,\r\n            rating: skillRating,\r\n            linkedAttribute: linkedAttribute,\r\n            dicePool: attributeValue + skillRating,\r\n            type: 'skill',\r\n            specializations: [] as any[]\r\n          };\r\n        })\r\n        .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n\r\n      // Get all specializations and group them under their parent skills\r\n      const allSpecializations = this.actor.items\r\n        .filter((item: any) => item.type === 'specialization')\r\n        .map((spec: any) => {\r\n          const linkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n          const linkedSkillName = spec.system?.linkedSkill;\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\r\n          \r\n          // Find parent skill\r\n          const parentSkill = this.actor!.items.find((i: any) => \r\n            i.type === 'skill' && i.name === linkedSkillName\r\n          );\r\n          const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n          const effectiveRating = skillRating + 2; // +2 from specialization\r\n          \r\n          return {\r\n            id: spec.id,\r\n            name: spec.name,\r\n            rating: effectiveRating,\r\n            linkedAttribute: linkedAttribute,\r\n            dicePool: attributeValue + effectiveRating,\r\n            type: 'specialization',\r\n            linkedSkillName: linkedSkillName\r\n          };\r\n        });\r\n\r\n      // Group specializations under their parent skills\r\n      for (const spec of allSpecializations) {\r\n        const parentSkill = skills.find((s: any) => s.name === spec.linkedSkillName);\r\n        if (parentSkill) {\r\n          parentSkill.specializations.push(spec);\r\n        }\r\n      }\r\n\r\n      // Sort specializations within each skill\r\n      for (const skill of skills) {\r\n        skill.specializations.sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n      }\r\n\r\n      // Create flat list for dropdown (skill first, then its specializations)\r\n      const dropdownOptions: any[] = [];\r\n      for (const skill of skills) {\r\n        // Add skill option\r\n        // Use normalized comparison for linkedAttackSkill to handle case/space differences\r\n        const skillSelected = skill.name === this.rollData.skillName || \r\n                             (this.rollData.linkedAttackSkill && \r\n                              ItemSearch.normalizeSearchText(skill.name) === ItemSearch.normalizeSearchText(this.rollData.linkedAttackSkill));\r\n        dropdownOptions.push({\r\n          value: `skill:${skill.id}`,\r\n          label: `${skill.name} (${skill.dicePool} dés)`,\r\n          type: 'skill',\r\n          id: skill.id,\r\n          name: skill.name,\r\n          dicePool: skill.dicePool,\r\n          linkedAttribute: skill.linkedAttribute,\r\n          rating: skill.rating,\r\n          isSelected: skillSelected && !this.rollData.specName\r\n        });\r\n\r\n        // Add specializations under this skill\r\n        for (const spec of skill.specializations) {\r\n          // Use normalized comparison for linkedAttackSpecialization to handle case/space differences\r\n          const specSelected = spec.name === this.rollData.specName ||\r\n                              (this.rollData.linkedAttackSpecialization && \r\n                               ItemSearch.normalizeSearchText(spec.name) === ItemSearch.normalizeSearchText(this.rollData.linkedAttackSpecialization));\r\n          dropdownOptions.push({\r\n            value: `spec:${spec.id}`,\r\n            label: `  └ ${spec.name} (${spec.dicePool} dés)`,\r\n            type: 'specialization',\r\n            id: spec.id,\r\n            name: spec.name,\r\n            dicePool: spec.dicePool,\r\n            linkedAttribute: spec.linkedAttribute,\r\n            linkedSkillName: spec.linkedSkillName,\r\n            rating: spec.rating,\r\n            isSelected: specSelected\r\n          });\r\n        }\r\n      }\r\n\r\n      context.skillsWithSpecs = skills;\r\n      context.dropdownOptions = dropdownOptions;\r\n      \r\n      // Determine selected value for dropdown\r\n      // Priority: specName > skillName > linkedAttackSpecialization > linkedAttackSkill\r\n      // This ensures that if skillName is set but spec is not found, we still select the skill\r\n      if (this.rollData.specName) {\r\n        const selectedSpec = dropdownOptions.find((opt: any) => opt.type === 'specialization' && opt.name === this.rollData.specName);\r\n        context.selectedValue = selectedSpec ? selectedSpec.value : '';\r\n      } else if (this.rollData.skillName) {\r\n        // If skillName is set but no specName, prioritize skill selection\r\n        const selectedSkill = dropdownOptions.find((opt: any) => opt.type === 'skill' && opt.name === this.rollData.skillName);\r\n        context.selectedValue = selectedSkill ? selectedSkill.value : '';\r\n      } else if (this.rollData.linkedAttackSpecialization) {\r\n        // Fallback: try to find by linkedAttackSpecialization using normalized comparison\r\n        const normalizedLinkedSpec = ItemSearch.normalizeSearchText(this.rollData.linkedAttackSpecialization);\r\n        const selectedSpec = dropdownOptions.find((opt: any) => \r\n          opt.type === 'specialization' && \r\n          ItemSearch.normalizeSearchText(opt.name) === normalizedLinkedSpec\r\n        );\r\n        context.selectedValue = selectedSpec ? selectedSpec.value : '';\r\n      } else if (this.rollData.linkedAttackSkill) {\r\n        // Fallback: try to find by linkedAttackSkill using normalized comparison\r\n        const normalizedLinkedSkill = ItemSearch.normalizeSearchText(this.rollData.linkedAttackSkill);\r\n        const selectedSkill = dropdownOptions.find((opt: any) => \r\n          opt.type === 'skill' && \r\n          ItemSearch.normalizeSearchText(opt.name) === normalizedLinkedSkill\r\n        );\r\n        context.selectedValue = selectedSkill ? selectedSkill.value : '';\r\n      } else {\r\n        context.selectedValue = '';\r\n      }\r\n    }\r\n\r\n    // Generate attribute options for attribute dropdown\r\n    const attributeOptions: any[] = [];\r\n    if (this.actor) {\r\n      const actorSystem = this.actor.system as any;\r\n      const attributes = actorSystem?.attributes || {};\r\n      \r\n      const attributeNames = ['strength', 'agility', 'willpower', 'logic', 'charisma'];\r\n      const attributeLabels: Record<string, string> = {\r\n        strength: game.i18n?.localize('SRA2.ATTRIBUTES.STRENGTH') || 'Force',\r\n        agility: game.i18n?.localize('SRA2.ATTRIBUTES.AGILITY') || 'Agilité',\r\n        willpower: game.i18n?.localize('SRA2.ATTRIBUTES.WILLPOWER') || 'Volonté',\r\n        logic: game.i18n?.localize('SRA2.ATTRIBUTES.LOGIC') || 'Logique',\r\n        charisma: game.i18n?.localize('SRA2.ATTRIBUTES.CHARISMA') || 'Charisme'\r\n      };\r\n      \r\n      for (const attrName of attributeNames) {\r\n        const attrValue = attributes[attrName] || 0;\r\n        attributeOptions.push({\r\n          value: attrName,\r\n          label: attributeLabels[attrName] || attrName,\r\n          diceValue: attrValue\r\n        });\r\n      }\r\n    }\r\n    \r\n    context.attributeOptions = attributeOptions;\r\n    \r\n    // Determine selected attribute: use linkedAttribute from rollData if set,\r\n    // otherwise try to get it from the selected skill/spec, otherwise default based on skill presence\r\n    let selectedAttribute = this.rollData.linkedAttribute;\r\n    let hasSkillRating = false;\r\n    \r\n    if (!selectedAttribute && this.actor) {\r\n      // Try to get from selected spec\r\n      if (this.rollData.specName) {\r\n        const specItem = this.actor.items.find((i: any) => \r\n          i.type === 'specialization' && i.name === this.rollData.specName\r\n        );\r\n        if (specItem) {\r\n          selectedAttribute = (specItem.system as any)?.linkedAttribute;\r\n          // Check if spec has a rating > 0 (parent skill rating)\r\n          const parentSkillName = (specItem.system as any)?.linkedSkill;\r\n          if (parentSkillName) {\r\n            const parentSkillItem = this.actor.items.find((i: any) => \r\n              i.type === 'skill' && i.name === parentSkillName\r\n            );\r\n            if (parentSkillItem) {\r\n              const skillRating = (parentSkillItem.system as any)?.rating || 0;\r\n              hasSkillRating = skillRating > 0;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Try to get from selected skill\r\n      if (!selectedAttribute && this.rollData.skillName) {\r\n        const skillItem = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === this.rollData.skillName\r\n        );\r\n        if (skillItem) {\r\n          selectedAttribute = (skillItem.system as any)?.linkedAttribute;\r\n          // Check if skill has a rating > 0\r\n          const skillRating = (skillItem.system as any)?.rating || 0;\r\n          hasSkillRating = skillRating > 0;\r\n        } else {\r\n          // Skill not found - person doesn't have the skill\r\n          hasSkillRating = false;\r\n        }\r\n      } else if (!this.rollData.skillName && !this.rollData.specName) {\r\n        // No skill or spec selected - person doesn't have the skill\r\n        hasSkillRating = false;\r\n      }\r\n      \r\n      // If still not set and person doesn't have the skill rating, use default attribute logic\r\n      if (!selectedAttribute && !hasSkillRating) {\r\n        // Person doesn't have the skill - use default attribute based on skill type\r\n        const linkedAttackSkill = this.rollData.linkedAttackSkill || this.rollData.skillName;\r\n        \r\n        // If skill is \"Combat rapproché\", default to Strength\r\n        // Otherwise default to Agility\r\n        if (linkedAttackSkill && ItemSearch.normalizeSearchText(linkedAttackSkill) === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          selectedAttribute = 'strength';\r\n        } else {\r\n          selectedAttribute = 'agility';\r\n        }\r\n      } else if (!selectedAttribute && attributeOptions.length > 0) {\r\n        // Has skill but no linked attribute found, default to first attribute\r\n        selectedAttribute = attributeOptions[0].value;\r\n      }\r\n    }\r\n    \r\n    context.selectedAttribute = selectedAttribute || '';\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Close button\r\n    html.find('.close-button').on('click', () => {\r\n      this.close();\r\n    });\r\n\r\n    // Weapon selection for counter-attack\r\n    html.find('.weapon-select').on('change', async (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const weaponId = select.value;\r\n      \r\n      if (!weaponId || !this.rollData.availableWeapons || !this.actor) return;\r\n      \r\n      const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\r\n      if (!selectedWeapon) return;\r\n\r\n      // Get the actual weapon item to check its linkedAttackSkill and linkedAttackSpecialization\r\n      const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\r\n      const weaponSystem = actualWeapon?.system as any;\r\n      \r\n      // Get weapon type data from WEAPON_TYPES if available\r\n      const wepTypeName = weaponSystem?.weaponType;\r\n      const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\r\n      \r\n      // Get linkedAttackSkill and linkedAttackSpecialization from weapon, fallback to weapon type\r\n      let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\r\n      const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\r\n      \r\n      // Calculate damage value with bonus from active feats (including adept powers)\r\n      const baseDamageValue = selectedWeapon.damageValue || weaponSystem?.damageValue || '0';\r\n      let damageValueBonus = selectedWeapon.damageValueBonus || weaponSystem?.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type (including adept powers)\r\n      const weaponType = wepTypeName || '';\r\n      if (weaponType && this.actor) {\r\n        const activeFeats = this.actor.items.filter((item: any) => \r\n          item.type === 'feat' && \r\n          item.system.active === true &&\r\n          item.system.weaponDamageBonus > 0 &&\r\n          item.system.weaponTypeBonus === weaponType\r\n        );\r\n        \r\n        activeFeats.forEach((activeFeat: any) => {\r\n          damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n        });\r\n      }\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      // Calculate final damage value string\r\n      const damageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n\r\n      // Default to \"Combat rapproché\" if no skill found\r\n      if (!baseSkillName) {\r\n        baseSkillName = 'Combat rapproché';\r\n      }\r\n\r\n      // Find the linked skill in actor's items\r\n      const linkedSkillItem = this.actor.items.find((item: any) => \r\n        item.type === 'skill' && item.name === baseSkillName\r\n      );\r\n\r\n      // Find specializations for the linked skill\r\n      const linkedSpecs = this.actor.items.filter((item: any) => \r\n        item.type === 'specialization' && \r\n        item.system.linkedSkill === baseSkillName\r\n      );\r\n      \r\n      // Check if weapon has a specialization and if actor has that specialization\r\n      let preferredSpecName: string | undefined = undefined;\r\n      if (weaponLinkedSpecialization) {\r\n        const specExists = linkedSpecs.find((spec: any) => \r\n          spec.name === weaponLinkedSpecialization\r\n        );\r\n        if (specExists) {\r\n          preferredSpecName = weaponLinkedSpecialization;\r\n        }\r\n      }\r\n\r\n      // Calculate skill level and linked attribute\r\n      let skillLevel: number | undefined = undefined;\r\n      let specLevel: number | undefined = undefined;\r\n      let linkedAttribute: string | undefined = undefined;\r\n      let skillName: string | undefined = baseSkillName;\r\n      let specName: string | undefined = undefined;\r\n\r\n      if (linkedSkillItem) {\r\n        const skillSystem = linkedSkillItem.system as any;\r\n        const skillRating = skillSystem.rating || 0;\r\n        linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n        \r\n        skillLevel = attributeValue + skillRating;\r\n      }\r\n\r\n      // Get RR sources (weapon RR + skill/spec/attribute RR)\r\n      const { getRRSources } = await import('../helpers/sheet-helpers.js');\r\n      \r\n      // Get RR from weapon itself\r\n      const weaponRRList = weaponSystem?.rrList || [];\r\n      const itemRRList = weaponRRList.map((rrEntry: any) => ({\r\n        ...rrEntry,\r\n        featName: selectedWeapon.name\r\n      }));\r\n      \r\n      let skillSpecRRList: any[] = [];\r\n      \r\n      // Simple logic: if weapon has a specialization and actor has it, use it\r\n      // Otherwise, use the skill\r\n      if (preferredSpecName) {\r\n        // Weapon has a specialization and actor has it - use the specialization\r\n        specName = preferredSpecName;\r\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n        const parentSkill = linkedSkillItem;\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        specLevel = attributeValue + skillRating + 2;\r\n        \r\n        const specRRSources = getRRSources(this.actor, 'specialization', specName);\r\n        const skillRRSources = linkedSkillItem ? getRRSources(this.actor, 'skill', baseSkillName) : [];\r\n        const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n        \r\n        skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n      } else {\r\n        // Use skill (no specialization or actor doesn't have the specialization)\r\n        if (skillName) {\r\n          const skillRRSources = getRRSources(this.actor, 'skill', skillName);\r\n          const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n          \r\n          skillSpecRRList = [...skillRRSources, ...attributeRRSources];\r\n        }\r\n      }\r\n      \r\n      // Merge weapon RR with skill/spec/attribute RR\r\n      const rrList = [...itemRRList, ...skillSpecRRList];\r\n\r\n      // Get weapon ranges from selected weapon or weapon type\r\n      // Use the same wepTypeName and wepTypeData from above\r\n      const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\r\n      const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\r\n      const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\r\n      const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\r\n      \r\n      // Update roll data with weapon information\r\n      this.rollData.skillName = skillName;\r\n      this.rollData.specName = specName;\r\n      this.rollData.linkedAttackSkill = baseSkillName;\r\n      this.rollData.linkedAttribute = linkedAttribute;\r\n      this.rollData.skillLevel = skillLevel;\r\n      this.rollData.specLevel = specLevel;\r\n      this.rollData.itemName = selectedWeapon.name;\r\n      this.rollData.itemType = 'weapon';\r\n      this.rollData.damageValue = damageValue;\r\n      this.rollData.damageValueBonus = damageValueBonus;\r\n      this.rollData.rrList = rrList;\r\n      this.rollData.selectedWeaponId = weaponId; // Store selected weapon ID for template\r\n      \r\n      // Update weapon ranges\r\n      this.rollData.meleeRange = meleeRange;\r\n      this.rollData.shortRange = shortRange;\r\n      this.rollData.mediumRange = mediumRange;\r\n      this.rollData.longRange = longRange;\r\n      this.rollData.weaponType = wepTypeName;\r\n\r\n      // Re-render to update the UI\r\n      this.render();\r\n    });\r\n\r\n    // Skill/Spec selection dropdown (only if no threshold)\r\n    html.find('.skill-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      \r\n      // Don't allow changes if threshold is set\r\n      if (this.rollData.threshold !== undefined) {\r\n        return;\r\n      }\r\n      \r\n      const value = select.value;\r\n      \r\n      if (!value || !this.actor) return;\r\n\r\n      const [type, id] = value.split(':');\r\n      if (!type || !id) return;\r\n\r\n      const item = this.actor.items.get(id);\r\n      if (!item) return;\r\n\r\n      if (type === 'skill') {\r\n        const skillSystem = item.system as any;\r\n        // Use selected attribute if available, otherwise use skill's linked attribute\r\n        const selectedAttribute = this.rollData.linkedAttribute || skillSystem.linkedAttribute || 'strength';\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const skillRating = skillSystem.rating || 0;\r\n        const dicePool = attributeValue + skillRating;\r\n        \r\n        // Update roll data\r\n        this.rollData.skillName = item.name;\r\n        this.rollData.specName = undefined;\r\n        this.rollData.skillLevel = dicePool;\r\n        this.rollData.specLevel = undefined;\r\n        this.rollData.linkedAttribute = selectedAttribute;\r\n        \r\n        // Recalculate RR and threshold (synchronously)\r\n        this.updateRRForSkill(item.name, selectedAttribute, dicePool);\r\n        \r\n        // Re-render after RR is updated\r\n        this.render();\r\n      } else if (type === 'spec') {\r\n        const specSystem = item.system as any;\r\n        // Use selected attribute if available, otherwise use spec's linked attribute\r\n        const selectedAttribute = this.rollData.linkedAttribute || specSystem.linkedAttribute || 'strength';\r\n        const linkedSkillName = specSystem.linkedSkill;\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        \r\n        // Find parent skill\r\n        const parentSkill = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === linkedSkillName\r\n        );\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        const effectiveRating = skillRating + 2;\r\n        const dicePool = attributeValue + effectiveRating;\r\n        \r\n        // Update roll data\r\n        this.rollData.specName = item.name;\r\n        this.rollData.skillName = linkedSkillName;\r\n        this.rollData.skillLevel = skillRating;\r\n        this.rollData.specLevel = dicePool;\r\n        this.rollData.linkedAttribute = selectedAttribute;\r\n        \r\n        // Recalculate RR and threshold (synchronously)\r\n        this.updateRRForSpec(item.name, linkedSkillName, selectedAttribute, dicePool);\r\n        \r\n        // Re-render after RR is updated\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Attribute selection dropdown\r\n    html.find('.attribute-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const selectedAttribute = select.value;\r\n      \r\n      if (!selectedAttribute || !this.actor) return;\r\n      \r\n      // Update linked attribute\r\n      this.rollData.linkedAttribute = selectedAttribute;\r\n      \r\n      // Recalculate dice pool based on current skill/spec and new attribute\r\n      if (this.rollData.specName && this.rollData.skillName) {\r\n        // Update spec level with new attribute\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const linkedSkillName = this.rollData.skillName;\r\n        const parentSkill = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === linkedSkillName\r\n        );\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        const effectiveRating = skillRating + 2;\r\n        const dicePool = attributeValue + effectiveRating;\r\n        \r\n        this.rollData.specLevel = dicePool;\r\n        this.rollData.skillLevel = skillRating;\r\n        \r\n        // Recalculate RR\r\n        this.updateRRForSpec(this.rollData.specName, linkedSkillName, selectedAttribute, dicePool);\r\n      } else if (this.rollData.skillName) {\r\n        // Update skill level with new attribute\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const skillItem = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === this.rollData.skillName\r\n        );\r\n        const skillRating = skillItem ? (skillItem.system as any).rating || 0 : 0;\r\n        const dicePool = attributeValue + skillRating;\r\n        \r\n        this.rollData.skillLevel = dicePool;\r\n        this.rollData.specLevel = undefined;\r\n        \r\n        // Recalculate RR\r\n        this.updateRRForSkill(this.rollData.skillName, selectedAttribute, dicePool);\r\n      } else {\r\n        // Pure attribute roll (no skill/spec)\r\n        this.rollData.skillLevel = undefined;\r\n        this.rollData.specLevel = undefined;\r\n        \r\n        // Recalculate RR for attribute only\r\n        const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', selectedAttribute);\r\n        this.rollData.rrList = attributeRRSources;\r\n        \r\n        // Reset RR enabled state\r\n        this.rrEnabled.clear();\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            if (rrValue > 0) {\r\n              const rrId = `${featName}-${rrValue}`;\r\n              this.rrEnabled.set(rrId, true);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Re-render to update UI\r\n      this.render();\r\n    });\r\n\r\n    // RR checkbox toggles\r\n    html.find('.rr-checkbox').on('change', (event) => {\r\n      const checkbox = event.currentTarget as HTMLInputElement;\r\n      const rrId = checkbox.dataset.rrId;\r\n      const enabled = checkbox.checked;\r\n      \r\n      if (rrId) {\r\n        this.rrEnabled.set(rrId, enabled);\r\n        \r\n        // Calculate new total RR\r\n        let newTotalRR = 0;\r\n        if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n          for (const rrSource of this.rollData.rrList) {\r\n            if (rrSource && typeof rrSource === 'object') {\r\n              const rrValue = rrSource.rrValue || 0;\r\n              const featName = rrSource.featName || 'Inconnu';\r\n              const sourceId = `${featName}-${rrValue}`;\r\n              \r\n              if (this.rrEnabled.get(sourceId)) {\r\n                newTotalRR += rrValue;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        // Add manual RR bonus\r\n        newTotalRR += this.manualRRBonus;\r\n        newTotalRR = Math.min(3, newTotalRR); // RR is capped at 3\r\n        \r\n        // Update risk dice count based on new RR (mode normal)\r\n        // Only auto-update if user hasn't manually changed it\r\n        if (!this.riskDiceManuallySet) {\r\n          const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(newTotalRR);\r\n          // Calculate dice pool\r\n          let dicePool = 0;\r\n          if (this.rollData.specLevel !== undefined) {\r\n            dicePool = this.rollData.specLevel;\r\n          } else if (this.rollData.skillLevel !== undefined) {\r\n            dicePool = this.rollData.skillLevel;\r\n          } else if (this.rollData.linkedAttribute) {\r\n            const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n            dicePool = attributeValue;\r\n          }\r\n          // Don't exceed dice pool\r\n          this.riskDiceCount = Math.min(autoRiskDiceCount, dicePool);\r\n          this.lastAutoRR = newTotalRR;\r\n        }\r\n        \r\n        // Re-render to update total RR and risk dice selection\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Range selection\r\n    html.find('.range-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const rangeValue = select.value;\r\n      \r\n      this.selectedRange = rangeValue || null;\r\n      \r\n      // Update roll mode based on range value\r\n      if (this.selectedRange) {\r\n        const meleeRange = this.rollData.meleeRange || 'none';\r\n        const shortRange = this.rollData.shortRange || 'none';\r\n        const mediumRange = this.rollData.mediumRange || 'none';\r\n        const longRange = this.rollData.longRange || 'none';\r\n        \r\n        let rangeValueForSelected: string = 'none';\r\n        if (this.selectedRange === 'melee') {\r\n          rangeValueForSelected = meleeRange;\r\n        } else if (this.selectedRange === 'short') {\r\n          rangeValueForSelected = shortRange;\r\n        } else if (this.selectedRange === 'medium') {\r\n          rangeValueForSelected = mediumRange;\r\n        } else if (this.selectedRange === 'long') {\r\n          rangeValueForSelected = longRange;\r\n        }\r\n        \r\n        // Check if actor has severe wound - if so, always force disadvantage\r\n        let hasSevereWound = false;\r\n        if (this.actor) {\r\n          const actorSystem = this.actor.system as any;\r\n          if (actorSystem.damage && actorSystem.damage.severe) {\r\n            hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                             actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n          }\r\n        }\r\n        \r\n        // Auto-set roll mode based on range value (can be overridden by user)\r\n        // But if actor has severe wound, always force disadvantage\r\n        if (hasSevereWound) {\r\n          this.rollMode = 'disadvantage';\r\n        } else {\r\n          if (rangeValueForSelected === 'disadvantage') {\r\n            this.rollMode = 'disadvantage';\r\n          } else if (rangeValueForSelected === 'ok') {\r\n            this.rollMode = 'normal';\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Re-render to update UI\r\n      this.render();\r\n    });\r\n\r\n    // Roll mode selection\r\n    html.find('input[name=\"roll-mode\"]').on('change', (event) => {\r\n      // Check if actor has severe wound - prevent changing mode\r\n      let hasSevereWound = false;\r\n      if (this.actor) {\r\n        const actorSystem = this.actor.system as any;\r\n        if (actorSystem.damage && actorSystem.damage.severe) {\r\n          hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                           actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n        }\r\n      }\r\n      \r\n      // If actor has severe wound, force disadvantage and prevent change\r\n      if (hasSevereWound) {\r\n        this.rollMode = 'disadvantage';\r\n        // Re-render to reset the selection\r\n        this.render();\r\n        return;\r\n      }\r\n      \r\n      const radio = event.currentTarget as HTMLInputElement;\r\n      const modeValue = radio.value;\r\n      \r\n      if (modeValue === 'normal' || modeValue === 'disadvantage' || modeValue === 'advantage') {\r\n        this.rollMode = modeValue as 'normal' | 'disadvantage' | 'advantage';\r\n      }\r\n    });\r\n\r\n    // Manual RR bonus input\r\n    html.find('.manual-rr-bonus-input').on('input', (event) => {\r\n      const input = event.currentTarget as HTMLInputElement;\r\n      const inputValue = input.value;\r\n      this.manualRRBonus = inputValue;\r\n      let manualRRBonus = 0;\r\n      if (inputValue !== '' && !isNaN(Number(inputValue))) {\r\n        manualRRBonus = parseInt(inputValue);\r\n      }\r\n      \r\n      // Calculate new total RR\r\n      let newTotalRR = 0;\r\n      if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const sourceId = `${featName}-${rrValue}`;\r\n            \r\n            if (this.rrEnabled.get(sourceId)) {\r\n              newTotalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add manual RR bonus\r\n      newTotalRR += manualRRBonus;\r\n      newTotalRR = Math.min(3, newTotalRR); // RR is capped at 3\r\n      \r\n      // Update risk dice count based on new RR (mode normal)\r\n      // Only auto-update if user hasn't manually changed it\r\n      if (!this.riskDiceManuallySet) {\r\n        const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(newTotalRR);\r\n        // Calculate dice pool\r\n        let dicePool = 0;\r\n        if (this.rollData.specLevel !== undefined) {\r\n          dicePool = this.rollData.specLevel;\r\n        } else if (this.rollData.skillLevel !== undefined) {\r\n          dicePool = this.rollData.skillLevel;\r\n        } else if (this.rollData.linkedAttribute) {\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n          dicePool = attributeValue;\r\n        }\r\n        // Don't exceed dice pool\r\n        this.riskDiceCount = Math.min(autoRiskDiceCount, dicePool);\r\n        this.lastAutoRR = newTotalRR;\r\n      }\r\n      \r\n      // Re-render to update total RR and risk dice selection\r\n      if (manualRRBonus !== 0) {\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Risk dice selection\r\n    html.find('.dice-icon').on('click', (event) => {\r\n      const diceIcon = $(event.currentTarget);\r\n      const diceIndex = parseInt(diceIcon.data('dice-index') || '0');\r\n      const isCurrentlySelected = diceIcon.hasClass('risk-dice');\r\n      \r\n      // Mark as manually set when user clicks\r\n      this.riskDiceManuallySet = true;\r\n      \r\n      // If clicking on the last selected dice, deselect all\r\n      if (isCurrentlySelected && diceIndex === this.riskDiceCount - 1) {\r\n        this.riskDiceCount = 0;\r\n      } else {\r\n        // Otherwise, select all dice up to and including the clicked one\r\n        this.riskDiceCount = diceIndex + 1;\r\n      }\r\n      \r\n      // Re-render to update dice selection\r\n      this.render();\r\n    });\r\n\r\n    // Roll Dice button\r\n    html.find('.roll-dice-button').on('click', async () => {\r\n      // Calculate final RR based on enabled checkboxes\r\n      let finalRR = 0;\r\n      if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const rrId = `${featName}-${rrValue}`;\r\n            \r\n            if (this.rrEnabled.get(rrId)) {\r\n              finalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add manual RR bonus\r\n      finalRR += this.manualRRBonus;\r\n      \r\n      // Update roll data with final RR\r\n      const finalRRList = this.rollData.rrList?.filter((rr: any) => {\r\n        const rrId = `${rr.featName || 'Inconnu'}-${rr.rrValue || 0}`;\r\n        return this.rrEnabled.get(rrId);\r\n      }) || [];\r\n      \r\n      // Calculate dice pool\r\n      let dicePool = 0;\r\n      if (this.rollData.specLevel !== undefined) {\r\n        dicePool = this.rollData.specLevel;\r\n      } else if (this.rollData.skillLevel !== undefined) {\r\n        dicePool = this.rollData.skillLevel;\r\n      } else if (this.rollData.linkedAttribute) {\r\n        const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n        dicePool = attributeValue;\r\n      }\r\n      \r\n      // Block defense roll if no skill/spec is selected (unless using threshold for NPCs)\r\n      if (this.rollData.isDefend && !this.rollData.threshold) {\r\n        if (!this.rollData.skillName && !this.rollData.specName && dicePool === 0) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.NO_SKILL_SELECTED') || 'Veuillez sélectionner une compétence pour la défense');\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // Block counter-attack roll if no weapon or skill is selected\r\n      if (this.rollData.isCounterAttack && !this.rollData.threshold) {\r\n        if (!this.rollData.selectedWeaponId && !this.rollData.skillName && !this.rollData.specName) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPON_SELECTED') || 'Veuillez sélectionner une arme pour la contre-attaque');\r\n          return;\r\n        }\r\n        if (dicePool === 0) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_DICE_POOL') || 'La réserve de dés pour la contre-attaque est de 0. Veuillez sélectionner une arme valide.');\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // Block roll if selected range is \"none\" (for weapon rolls, not defense)\r\n      if (this.rollData.itemType === 'weapon' || this.rollData.itemType === 'spell' || this.rollData.itemType === 'weapons-spells') {\r\n        if (!this.rollData.isDefend && this.selectedRange) {\r\n          // Get the current range value\r\n          let selectedRangeValue: string | null = null;\r\n          const meleeRange = this.rollData.meleeRange || 'none';\r\n          const shortRange = this.rollData.shortRange || 'none';\r\n          const mediumRange = this.rollData.mediumRange || 'none';\r\n          const longRange = this.rollData.longRange || 'none';\r\n          \r\n          if (this.selectedRange === 'melee') {\r\n            selectedRangeValue = meleeRange;\r\n          } else if (this.selectedRange === 'short') {\r\n            selectedRangeValue = shortRange;\r\n          } else if (this.selectedRange === 'medium') {\r\n            selectedRangeValue = mediumRange;\r\n          } else if (this.selectedRange === 'long') {\r\n            selectedRangeValue = longRange;\r\n          }\r\n          \r\n          // Block if range value is \"none\"\r\n          if (selectedRangeValue === 'none') {\r\n            ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.INVALID_RANGE') || 'La portée sélectionnée n\\'est pas disponible pour cette arme. Veuillez sélectionner une portée valide.');\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Get attacker and defender\r\n      const attacker = this.actor;\r\n      const attackerToken = this.attackerToken || null;\r\n      const defender = this.targetToken?.actor || null;\r\n      const defenderToken = this.targetToken || null;\r\n      \r\n      // Get token UUIDs\r\n      const attackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\r\n      const defenderTokenUuid = defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n      \r\n      // Log token information\r\n      console.log('=== ROLL DICE BUTTON ===');\r\n      console.log('Attacker:', attacker?.name || 'Unknown');\r\n      console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n      console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\r\n      if (attackerToken?.actor) {\r\n        console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n      }\r\n      console.log('Defender:', defender?.name || 'None');\r\n      console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n      console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\r\n      if (defenderToken?.actor) {\r\n        console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n      }\r\n      console.log('========================');\r\n      \r\n      // Prepare roll data\r\n      const updatedRollData = {\r\n        ...this.rollData,\r\n        rrList: finalRRList,\r\n        riskDiceCount: this.riskDiceCount,  // Add risk dice count to roll data\r\n        selectedRange: this.selectedRange,  // Add selected range\r\n        rollMode: this.rollMode,  // Add roll mode (normal/disadvantage/advantage)\r\n        finalRR: Math.min(3, finalRR),  // Final RR (capped at 3)\r\n        dicePool: dicePool,\r\n        attackerTokenUuid: attackerTokenUuid,  // Add attacker token UUID\r\n        defenderTokenUuid: defenderTokenUuid   // Add defender token UUID\r\n      };\r\n      \r\n      // Import and execute roll\r\n      const { executeRoll } = await import('../helpers/dice-roller.js');\r\n      await executeRoll(attacker, defender, attackerToken, defenderToken, updatedRollData);\r\n      \r\n      // Close the dialog\r\n      this.close();\r\n    });\r\n  }\r\n\r\n  private updateRRForSkill(skillName: string, linkedAttribute: string, dicePool: number): void {\r\n    // For defense, always use this.actor (the defender)\r\n    // For other rolls, also use this.actor (the one making the roll)\r\n    if (!this.actor) return;\r\n    \r\n    // Get RR sources synchronously (already imported at top)\r\n    // Always use this.actor which is correctly set to the defender for defense rolls\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    \r\n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with skill/attribute RR\r\n    // For non-weapon rolls, use only skill/attribute RR\r\n    let itemRRList: any[] = [];\r\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\r\n      // Get the weapon item to extract its rrList\r\n      const weapon = this.actor.items.get(this.rollData.itemId);\r\n      if (weapon) {\r\n        const weaponSystem = weapon.system as any;\r\n        const rawItemRRList = weaponSystem.rrList || [];\r\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n          ...rrEntry,\r\n          featName: weapon.name  // Add featName (the weapon name itself)\r\n        }));\r\n      }\r\n    }\r\n    \r\n    // Merge item RR (if weapon) + skill RR + attribute RR\r\n    this.rollData.rrList = [...itemRRList, ...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Reset RR enabled state for new sources\r\n    this.rrEnabled.clear();\r\n    for (const rrSource of this.rollData.rrList) {\r\n      if (rrSource && typeof rrSource === 'object') {\r\n        const rrValue = rrSource.rrValue || 0;\r\n        const featName = rrSource.featName || 'Inconnu';\r\n        if (rrValue > 0) {\r\n          const rrId = `${featName}-${rrValue}`;\r\n          this.rrEnabled.set(rrId, true);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Recalculate threshold if it was set\r\n    if (this.rollData.threshold !== undefined) {\r\n      const totalRR = Math.min(3, skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\r\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n    }\r\n  }\r\n\r\n  private updateRRForSpec(specName: string, skillName: string, linkedAttribute: string, dicePool: number): void {\r\n    // For defense, always use this.actor (the defender)\r\n    // For other rolls, also use this.actor (the one making the roll)\r\n    if (!this.actor) return;\r\n    \r\n    // Get RR sources synchronously (already imported at top)\r\n    // Always use this.actor which is correctly set to the defender for defense rolls\r\n    const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    \r\n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with spec/skill/attribute RR\r\n    // For non-weapon rolls, use only spec/skill/attribute RR\r\n    let itemRRList: any[] = [];\r\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\r\n      // Get the weapon item to extract its rrList\r\n      const weapon = this.actor.items.get(this.rollData.itemId);\r\n      if (weapon) {\r\n        const weaponSystem = weapon.system as any;\r\n        const rawItemRRList = weaponSystem.rrList || [];\r\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n          ...rrEntry,\r\n          featName: weapon.name  // Add featName (the weapon name itself)\r\n        }));\r\n      }\r\n    }\r\n    \r\n    // Merge item RR (if weapon) + spec RR + skill RR + attribute RR\r\n    this.rollData.rrList = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Reset RR enabled state for new sources\r\n    this.rrEnabled.clear();\r\n    for (const rrSource of this.rollData.rrList) {\r\n      if (rrSource && typeof rrSource === 'object') {\r\n        const rrValue = rrSource.rrValue || 0;\r\n        const featName = rrSource.featName || 'Inconnu';\r\n        if (rrValue > 0) {\r\n          const rrId = `${featName}-${rrValue}`;\r\n          this.rrEnabled.set(rrId, true);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Recalculate threshold if it was set\r\n    if (this.rollData.threshold !== undefined) {\r\n      const totalRR = Math.min(3, specRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\r\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n    }\r\n  }\r\n}\r\n\r\n","export const HOOKS = {\r\n  MIGRATIONS: 'sra2-declareMigration',\r\n}","import { HOOKS } from \"../hooks.mjs\"\r\n\r\nconst CURRENT_SYSTEM_VERSION = \"currentSystemVersion\";\r\n\r\nexport class Migration {\r\n  get code() { return \"sample\"; }\r\n\r\n  get version() { return \"0.0.0\"; }\r\n\r\n  async migrate() { return () => { } };\r\n\r\n  async applyItemsUpdates(computeUpdates = (items) => []) {\r\n    await game.actors.forEach(async (actor) => {\r\n      const actorItemUpdates = computeUpdates(actor.items);\r\n      if (actorItemUpdates.length > 0) {\r\n        const message = game.i18n.format('SRA2.MIGRATION.APPLYING_ACTOR_ITEMS', { name: actor.name });\r\n        console.log(SYSTEM.LOG.HEAD, this.code, message, actorItemUpdates);\r\n        await actor.updateEmbeddedDocuments('Item', actorItemUpdates);\r\n      }\r\n    })\r\n\r\n    const itemUpdates = computeUpdates(game.items);\r\n    if (itemUpdates.length > 0) {\r\n      const message = game.i18n.localize('SRA2.MIGRATION.APPLYING_ITEMS');\r\n      console.log(SYSTEM.LOG.HEAD, this.code, message, itemUpdates);\r\n      await Item.updateDocuments(itemUpdates);\r\n    }\r\n  }\r\n}\r\n\r\nexport class Migrations {\r\n  constructor() {\r\n    // Hooks.once(HOOKS.MIGRATIONS, declareMigrations => declareMigrations(\r\n    //   /* add system migrations here, can declared anywhere */\r\n    // ))\r\n\r\n    game.settings.register(SYSTEM.id, CURRENT_SYSTEM_VERSION, {\r\n      name: \"SRA2.MIGRATION.SETTING_NAME\",\r\n      scope: \"world\",\r\n      config: false,\r\n      type: String,\r\n      default: \"0.0.0\"\r\n    })\r\n  }\r\n\r\n  migrate() {\r\n    const currentVersion = game.settings.get(SYSTEM.id, CURRENT_SYSTEM_VERSION)\r\n    if (foundry.utils.isNewerVersion(game.system.version, currentVersion)) {\r\n      //if (true) {\r\n      let migrations = []\r\n      Hooks.callAll(HOOKS.MIGRATIONS, (...list) =>\r\n        migrations = migrations.concat(list.filter(m => foundry.utils.isNewerVersion(m.version, currentVersion)))\r\n      )\r\n      Hooks.off(HOOKS.MIGRATIONS, () => { })\r\n\r\n      if (migrations.length > 0) {\r\n        migrations.sort((a, b) => foundry.utils.isNewerVersion(a.version, b.version) ? 1 : foundry.utils.isNewerVersion(b.version, a.version) ? -1 : 0)\r\n        migrations.forEach(async m => {\r\n          const message = game.i18n.format('SRA2.MIGRATION.EXECUTING', { code: m.code, currentVersion: currentVersion, targetVersion: m.version });\r\n          this.$notify(message);\r\n          await m.migrate()\r\n        })\r\n        const message = game.i18n.format('SRA2.MIGRATION.DONE', { version: game.system.version });\r\n        this.$notify(message)\r\n      }\r\n      else {\r\n        const message = game.i18n.format('SRA2.MIGRATION.NOT_NEEDED', { version: game.system.version });\r\n        console.log(SYSTEM.LOG.HEAD + message)\r\n      }\r\n      game.settings.set(SYSTEM.id, CURRENT_SYSTEM_VERSION, game.system.version)\r\n    }\r\n    else {\r\n      const message = game.i18n.localize('SRA2.MIGRATION.VERSION_UNCHANGED');\r\n      console.log(SYSTEM.LOG.HEAD + message)\r\n    }\r\n  }\r\n\r\n\r\n  $notify(message) {\r\n    ui.notifications.info(message);\r\n    console.log(SYSTEM.LOG.HEAD + message);\r\n  }\r\n}\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.3: Convert rrType, rrValue, rrTarget arrays to rrList\r\n * This migration transforms the three separate arrays into a single array of objects\r\n * where each object contains {rrType, rrValue, rrTarget}\r\n */\r\nexport class Migration_13_0_3 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.3\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.3\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.3: Converting rrType/rrValue/rrTarget to rrList\");\r\n    \r\n    let totalMigrated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the raw source data which contains fields even if they're not in the schema\r\n        const sourceSystem = item._source?.system || item.system;\r\n        const system = item.system;\r\n        \r\n        // Check for old format in the source data (raw data from database)\r\n        const hasOldFormat = (\r\n          (sourceSystem.rrType !== undefined && Array.isArray(sourceSystem.rrType)) ||\r\n          (sourceSystem.rrValue !== undefined && Array.isArray(sourceSystem.rrValue)) ||\r\n          (sourceSystem.rrTarget !== undefined && Array.isArray(sourceSystem.rrTarget))\r\n        );\r\n        \r\n        // Check if rrList already exists with content in source\r\n        const hasNewFormatInSource = (\r\n          sourceSystem.rrList !== undefined && \r\n          Array.isArray(sourceSystem.rrList)\r\n        );\r\n        \r\n        // Skip if already migrated (has new format in source AND no old format)\r\n        if (hasNewFormatInSource && !hasOldFormat) {\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - already has rrList in source (${sourceSystem.rrList.length} entries), no old data`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Skip if no old format to migrate\r\n        if (!hasOldFormat) {\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - no old format fields found`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Get the arrays from source data\r\n        const rrType = Array.isArray(sourceSystem.rrType) ? sourceSystem.rrType : [];\r\n        const rrValue = Array.isArray(sourceSystem.rrValue) ? sourceSystem.rrValue : [];\r\n        const rrTarget = Array.isArray(sourceSystem.rrTarget) ? sourceSystem.rrTarget : [];\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Found \"${item.name}\" with old format:`, {\r\n          rrType: rrType,\r\n          rrValue: rrValue,\r\n          rrTarget: rrTarget\r\n        });\r\n        \r\n        // Convert the three arrays into a single rrList array\r\n        const rrList = [];\r\n        const maxLength = Math.max(rrType.length, rrValue.length, rrTarget.length);\r\n        \r\n        for (let i = 0; i < maxLength; i++) {\r\n          // Only add entries where rrType exists and is not \"none\"\r\n          const type = rrType[i];\r\n          if (type && type !== 'none') {\r\n            rrList.push({\r\n              rrType: type,\r\n              rrValue: rrValue[i] !== undefined ? rrValue[i] : 0,\r\n              rrTarget: rrTarget[i] !== undefined ? rrTarget[i] : ''\r\n            });\r\n          }\r\n        }\r\n        \r\n        // Create the update object\r\n        const update = {\r\n          _id: item.id,\r\n          'system.rrList': rrList,\r\n          // Store backup of old data before deletion\r\n          'system._rrTypeBackup': rrType,\r\n          'system._rrValueBackup': rrValue,\r\n          'system._rrTargetBackup': rrTarget,\r\n          // Remove old fields by setting them to null (Foundry will delete them)\r\n          'system.rrType': null,\r\n          'system.rrValue': null,\r\n          'system.rrTarget': null\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalMigrated++;\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Converting feat \"${item.name}\":`);\r\n        console.log(SYSTEM.LOG.HEAD + `  Old data (will be deleted, backed up as _rrTypeBackup/_rrValueBackup/_rrTargetBackup):`, { rrType, rrValue, rrTarget });\r\n        console.log(SYSTEM.LOG.HEAD + `  New rrList (${rrList.length} entries):`, rrList);\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.3 completed - Migrated: ${totalMigrated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalMigrated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_3_INFO') :\r\n        'Migration 13.0.3: Risk Reduction data converted. Check console for details.';\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.4: Clean up old RR fields and backups\r\n * This migration removes the old rrType/rrValue/rrTarget fields and their backups\r\n * after confirming that rrList is working properly\r\n */\r\nexport class Migration_13_0_4 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.4\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.4\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.4: Cleaning up old RR fields and backups\");\r\n    \r\n    let totalCleaned = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the raw source data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Check if there are any old fields or backups to clean\r\n        const hasOldFields = (\r\n          sourceSystem.rrType !== undefined ||\r\n          sourceSystem.rrValue !== undefined ||\r\n          sourceSystem.rrTarget !== undefined\r\n        );\r\n        \r\n        const hasBackups = (\r\n          sourceSystem._rrTypeBackup !== undefined ||\r\n          sourceSystem._rrValueBackup !== undefined ||\r\n          sourceSystem._rrTargetBackup !== undefined\r\n        );\r\n        \r\n        // Skip if nothing to clean\r\n        if (!hasOldFields && !hasBackups) {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check that rrList exists (safety check)\r\n        const hasRrList = sourceSystem.rrList !== undefined && Array.isArray(sourceSystem.rrList);\r\n        \r\n        if (!hasRrList) {\r\n          console.warn(SYSTEM.LOG.HEAD + `Migration 13.0.4: Skipping \"${item.name}\" - no rrList found! This item may need manual review.`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.4: Cleaning up feat \"${item.name}\":`);\r\n        if (hasOldFields) {\r\n          console.log(SYSTEM.LOG.HEAD + `  Removing old fields: rrType, rrValue, rrTarget`);\r\n        }\r\n        if (hasBackups) {\r\n          console.log(SYSTEM.LOG.HEAD + `  Removing backups: _rrTypeBackup, _rrValueBackup, _rrTargetBackup`);\r\n        }\r\n        console.log(SYSTEM.LOG.HEAD + `  Keeping rrList with ${sourceSystem.rrList.length} entries`);\r\n        \r\n        // Create the update object to remove all old fields\r\n        const update = {\r\n          _id: item.id,\r\n          // Remove old fields\r\n          'system.rrType': null,\r\n          'system.rrValue': null,\r\n          'system.rrTarget': null,\r\n          // Remove backup fields\r\n          'system._rrTypeBackup': null,\r\n          'system._rrValueBackup': null,\r\n          'system._rrTargetBackup': null\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalCleaned++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.4 completed - Cleaned: ${totalCleaned}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalCleaned > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_4_INFO') :\r\n        'Migration 13.0.4: Old RR fields cleaned up. Data migration complete.';\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.5: Separate weapons and spells feat types\r\n * This migration converts \"weapons-spells\" feat type to separate \"weapon\" and \"spell\" types\r\n * By default, all \"weapons-spells\" are converted to \"weapon\" type\r\n */\r\nexport class Migration_13_0_5 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.5\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.5\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.5: Separating weapons and spells feat types\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Check if this is a \"weapons-spells\" feat type\r\n        if (sourceSystem.featType !== 'weapons-spells') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.5: Converting feat \"${item.name}\" from \"weapons-spells\" to \"weapon\"`);\r\n        \r\n        // Convert to \"weapon\" type by default\r\n        // Users can manually change specific items to \"spell\" if needed\r\n        const update = {\r\n          _id: item.id,\r\n          'system.featType': 'weapon'\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalConverted++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.5 completed - Converted: ${totalConverted} weapons-spells to weapon, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_5_INFO') :\r\n        `Migration 13.0.5: Converted ${totalConverted} \"weapons-spells\" feats to \"weapon\" type. You can manually change specific items to \"spell\" type if needed.`;\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.6: Rollback migration 13.0.5\r\n * This migration does NOT convert anything - keeps weapons-spells as valid type\r\n * Only marks that this version has been applied\r\n */\r\nexport class Migration_13_0_6 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.6\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.6\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Migration 13.0.6: Rollback - keeping old weapons-spells type valid\");\r\n    console.log(SYSTEM.LOG.HEAD + \"No conversion needed. weapons-spells, weapon, and spell types are all valid.\");\r\n    \r\n    // This migration does nothing, just marks the version as applied\r\n    // Old items with \"weapons-spells\" will continue to work\r\n    // New items can use \"weapon\" or \"spell\" as separate types\r\n    \r\n    const message = \"Migration 13.0.6: All feat types (weapons-spells, weapon, spell) are now valid. No data conversion performed.\";\r\n    console.log(SYSTEM.LOG.HEAD + message);\r\n    \r\n    if (ui.notifications) {\r\n      ui.notifications.info(message, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.7: Convert weapons-spells to weapon (with backup)\r\n * This migration safely converts all \"weapons-spells\" feat types to \"weapon\"\r\n * Creates a backup of the old value before conversion\r\n */\r\nexport class Migration_13_0_7 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.7\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.7\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.7: Converting weapons-spells to weapon (with backup)\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    let conversionDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if not weapons-spells type\r\n        if (sourceSystem.featType !== 'weapons-spells') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Log what we're converting\r\n        const itemInfo = {\r\n          name: item.name,\r\n          id: item.id,\r\n          oldType: 'weapons-spells',\r\n          newType: 'weapon',\r\n          hasWeaponFocus: sourceSystem.isWeaponFocus || false,\r\n          hasDamageValue: (sourceSystem.damageValue || 0) > 0,\r\n          hasRanges: (\r\n            sourceSystem.meleeRange !== 'none' ||\r\n            sourceSystem.shortRange !== 'none' ||\r\n            sourceSystem.mediumRange !== 'none' ||\r\n            sourceSystem.longRange !== 'none'\r\n          )\r\n        };\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.7: Converting \"${item.name}\" (ID: ${item.id})`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Old type: weapons-spells`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - New type: weapon`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has weapon focus: ${itemInfo.hasWeaponFocus}`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has damage value: ${itemInfo.hasDamageValue}`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has ranges: ${itemInfo.hasRanges}`);\r\n        \r\n        conversionDetails.push(itemInfo);\r\n        \r\n        // Create the update object\r\n        const update = {\r\n          _id: item.id,\r\n          // Change the type\r\n          'system.featType': 'weapon',\r\n          // Create a backup of the old type for safety\r\n          'system._oldFeatTypeBackup': 'weapons-spells',\r\n          // Add a migration timestamp\r\n          'system._migratedAt': new Date().toISOString(),\r\n          'system._migrationVersion': '13.0.7'\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalConverted++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.7 completed - Converted: ${totalConverted}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (conversionDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\r\n      \r\n      const withWeaponFocus = conversionDetails.filter(d => d.hasWeaponFocus).length;\r\n      const withDamage = conversionDetails.filter(d => d.hasDamageValue).length;\r\n      const withRanges = conversionDetails.filter(d => d.hasRanges).length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with weapon focus: ${withWeaponFocus}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with damage value: ${withDamage}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with ranges: ${withRanges}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\r\n      \r\n      // List all converted items\r\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\r\n      conversionDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id})`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_7_INFO', { count: totalConverted }) :\r\n        `Migration 13.0.7: Converted ${totalConverted} \"weapons-spells\" items to \"weapon\" type. All data preserved with backup.`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete. All items have been backed up.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Old type saved in system._oldFeatTypeBackup\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to convert - all items already migrated or are other types\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.8: Convert narrativeEffects from string array to object array\r\n * This migration safely converts all narrativeEffects from simple strings\r\n * to objects with { text: string, isNegative: boolean } structure\r\n */\r\nexport class Migration_13_0_8 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.8\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.8\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.8: Converting narrativeEffects to new format and fixing damageValueBonus\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    let totalFixed = 0;\r\n    let conversionDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        // Check and fix narrativeEffects\r\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\r\n          // Check if it's already in the new format (first element is an object with 'text' property)\r\n          const firstEffect = sourceSystem.narrativeEffects[0];\r\n          if (!(typeof firstEffect === 'object' && firstEffect !== null && 'text' in firstEffect)) {\r\n            // Convert string array to object array\r\n            const convertedEffects = sourceSystem.narrativeEffects.map(effect => {\r\n              if (typeof effect === 'string') {\r\n                return {\r\n                  text: effect,\r\n                  isNegative: false\r\n                };\r\n              }\r\n              // If it's already an object but missing properties, normalize it\r\n              return {\r\n                text: effect?.text || effect?.toString() || \"\",\r\n                isNegative: effect?.isNegative || false\r\n              };\r\n            });\r\n            \r\n            update['system.narrativeEffects'] = convertedEffects;\r\n            update['system._migratedNarrativeEffectsAt'] = new Date().toISOString();\r\n            update['system._narrativeEffectsMigrationVersion'] = '13.0.8';\r\n            needsUpdate = true;\r\n            \r\n            // Log what we're converting\r\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Converting narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\r\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${sourceSystem.narrativeEffects.length}`);\r\n            \r\n            conversionDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: sourceSystem.narrativeEffects.length\r\n            });\r\n            totalConverted++;\r\n          }\r\n        }\r\n        \r\n        // Fix missing or invalid damageValueBonus values for ALL feat items\r\n        if (sourceSystem.damageValueBonus === null || \r\n            sourceSystem.damageValueBonus === undefined || \r\n            typeof sourceSystem.damageValueBonus !== 'number' ||\r\n            !Number.isInteger(sourceSystem.damageValueBonus)) {\r\n          update['system.damageValueBonus'] = 0;\r\n          needsUpdate = true;\r\n          totalFixed++;\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Fixing damageValueBonus for \"${item.name}\" (ID: ${item.id})`);\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          updates.push(update);\r\n        } else {\r\n          totalSkipped++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.8 completed - NarrativeEffects converted: ${totalConverted}, DamageValueBonus fixed: ${totalFixed}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (conversionDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\r\n      \r\n      const totalEffects = conversionDetails.reduce((sum, d) => sum + d.effectCount, 0);\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects migrated: ${totalEffects}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\r\n      \r\n      // List all converted items\r\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\r\n      conversionDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${detail.effectCount} effect(s)`);\r\n      });\r\n    }\r\n    \r\n    if (totalFixed > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + `Fixed damageValueBonus on ${totalFixed} item(s)`);\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0 || totalFixed > 0) {\r\n      let userMessage = \"\";\r\n      if (totalConverted > 0 && totalFixed > 0) {\r\n        userMessage = game.i18n ? \r\n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted, fixed: totalFixed }) :\r\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) and fixed damageValueBonus on ${totalFixed} feat(s).`;\r\n      } else if (totalConverted > 0) {\r\n        userMessage = game.i18n ? \r\n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted }) :\r\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) to new format.`;\r\n      } else if (totalFixed > 0) {\r\n        userMessage = `Migration 13.0.8: Fixed damageValueBonus on ${totalFixed} feat(s).`;\r\n      }\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      if (totalConverted > 0) {\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects converted to new format.\");\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All effects default to positive (isNegative: false)\");\r\n      }\r\n      if (totalFixed > 0) {\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All damageValueBonus fields set to valid integer values.\");\r\n      }\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.9: Add value field to narrativeEffects and isFirstFeat field\r\n * This migration adds a 'value' field to all narrative effects\r\n * with a default of -1 for consistency with the new schema,\r\n * and adds an 'isFirstFeat' boolean field with default false\r\n */\r\nexport class Migration_13_0_9 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.9\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.9\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.9: Adding value field to narrativeEffects and isFirstFeat field\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    let totalFirstFeatAdded = 0;\r\n    let updateDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        // Check if item has narrativeEffects that need updating\r\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\r\n          const updatedEffects = sourceSystem.narrativeEffects.map(effect => {\r\n            // Check if effect already has a value field\r\n            if (typeof effect === 'object' && effect !== null && !('value' in effect)) {\r\n              needsUpdate = true;\r\n              return {\r\n                ...effect,\r\n                value: -1  // Default value for all effects\r\n              };\r\n            }\r\n            return effect;\r\n          });\r\n          \r\n          if (needsUpdate) {\r\n            update['system.narrativeEffects'] = updatedEffects;\r\n            update['system._migratedNarrativeEffectsValueAt'] = new Date().toISOString();\r\n            \r\n            // Log what we're converting\r\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding value field to narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\r\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${updatedEffects.length}`);\r\n            \r\n            updateDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: updatedEffects.length,\r\n              hasFirstFeat: false\r\n            });\r\n          }\r\n        }\r\n        \r\n        // Check if item needs isFirstFeat field (add to all feats that don't have it)\r\n        if (sourceSystem.isFirstFeat === undefined || sourceSystem.isFirstFeat === null) {\r\n          update['system.isFirstFeat'] = false;\r\n          needsUpdate = true;\r\n          totalFirstFeatAdded++;\r\n          \r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding isFirstFeat field to \"${item.name}\" (ID: ${item.id})`);\r\n          \r\n          // Update details if not already added\r\n          const existingDetail = updateDetails.find(d => d.id === item.id);\r\n          if (existingDetail) {\r\n            existingDetail.hasFirstFeat = true;\r\n          } else {\r\n            updateDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: 0,\r\n              hasFirstFeat: true\r\n            });\r\n          }\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          update['system._narrativeEffectsValueMigrationVersion'] = '13.0.9';\r\n          updates.push(update);\r\n          totalUpdated++;\r\n        } else {\r\n          totalSkipped++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.9 completed - Items updated: ${totalUpdated}, isFirstFeat added: ${totalFirstFeatAdded}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (updateDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\r\n      \r\n      const totalEffects = updateDetails.reduce((sum, d) => sum + d.effectCount, 0);\r\n      const totalWithFirstFeat = updateDetails.filter(d => d.hasFirstFeat).length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects updated: ${totalEffects}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Total items with isFirstFeat added: ${totalWithFirstFeat}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\r\n      \r\n      // List all updated items\r\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\r\n      updateDetails.forEach((detail, index) => {\r\n        const updates = [];\r\n        if (detail.effectCount > 0) updates.push(`${detail.effectCount} effect(s)`);\r\n        if (detail.hasFirstFeat) updates.push('isFirstFeat added');\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${updates.join(', ')}`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_9_INFO', { count: totalUpdated, firstFeatCount: totalFirstFeatAdded }) :\r\n        `Migration 13.0.9: Updated ${totalUpdated} feat(s) - added value field to narrative effects and isFirstFeat field to ${totalFirstFeatAdded} feat(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects now have a value field (default: -1)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All feats now have isFirstFeat field (default: false)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.10: Update cost field values\r\n * This migration updates the cost field to use the new simplified system:\r\n * - 'specialized-equipment' -> 'advanced-equipment'\r\n * - 'feat' -> removed (defaults to 0 cost for non-equipment items)\r\n * - Cost field only applies to equipment and weapon types\r\n */\r\nexport class Migration_13_0_10 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.10\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.10\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.10: Updating cost field values\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    let updateDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      // Log all feat items for debugging\r\n      const featItems = items.filter(item => item.type === 'feat');\r\n      console.log(SYSTEM.LOG.HEAD + `Found ${featItems.length} feat items to check`);\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._costMigrationVersion === '13.0.10') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        const currentCost = sourceSystem.cost || 'free-equipment';\r\n        const featType = sourceSystem.featType || 'equipment';\r\n        let newCost = currentCost;\r\n        let reason = '';\r\n        \r\n        // Log current state for debugging\r\n        console.log(SYSTEM.LOG.HEAD + `Checking \"${item.name}\" - cost: \"${currentCost}\", type: \"${featType}\"`);\r\n        \r\n        // Convert specialized-equipment to advanced-equipment\r\n        if (currentCost === 'specialized-equipment') {\r\n          newCost = 'advanced-equipment';\r\n          needsUpdate = true;\r\n          reason = 'specialized-equipment → advanced-equipment';\r\n        }\r\n        // Convert old 'feat' cost type to appropriate value\r\n        else if (currentCost === 'feat') {\r\n          // For equipment and weapons, set to free-equipment (0 cost)\r\n          // For other types, the cost doesn't apply anyway but we set it to free-equipment for consistency\r\n          newCost = 'free-equipment';\r\n          needsUpdate = true;\r\n          reason = 'feat → free-equipment (cost = 0 for non-equipment types)';\r\n        }\r\n        // Ensure all items have a valid cost value\r\n        else if (!currentCost || !['free-equipment', 'equipment', 'advanced-equipment'].includes(currentCost)) {\r\n          newCost = 'free-equipment';\r\n          needsUpdate = true;\r\n          reason = `invalid or missing cost (${currentCost}) → free-equipment`;\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          update['system.cost'] = newCost;\r\n          update['system._costMigrationVersion'] = '13.0.10';\r\n          \r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.10: Updating cost for \"${item.name}\" (ID: ${item.id})`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Type: ${featType}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Old cost: ${currentCost}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - New cost: ${newCost}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Reason: ${reason}`);\r\n          \r\n          updateDetails.push({\r\n            name: item.name,\r\n            id: item.id,\r\n            featType: featType,\r\n            oldCost: currentCost,\r\n            newCost: newCost,\r\n            reason: reason\r\n          });\r\n          \r\n          updates.push(update);\r\n          totalUpdated++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.10 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (updateDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\r\n      \r\n      const specializedToAdvanced = updateDetails.filter(d => d.oldCost === 'specialized-equipment').length;\r\n      const featToFree = updateDetails.filter(d => d.oldCost === 'feat').length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - specialized-equipment → advanced-equipment: ${specializedToAdvanced}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - feat → free-equipment: ${featToFree}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\r\n      \r\n      // List all updated items\r\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\r\n      updateDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (${detail.featType}): ${detail.oldCost} → ${detail.newCost}`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_10_INFO', { \r\n          count: totalUpdated,\r\n          specializedCount: updateDetails.filter(d => d.oldCost === 'specialized-equipment').length,\r\n          featCount: updateDetails.filter(d => d.oldCost === 'feat').length\r\n        }) :\r\n        `Migration 13.0.10: Updated ${totalUpdated} feat(s) cost values.`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost system simplified: free (0¥), equipment (2500¥), advanced (5000¥)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost now only applies to equipment and weapon types\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.11: Add linked specializations fields to weapons\r\n * This migration adds the new linkedAttackSpecialization and linkedDefenseSpecialization fields\r\n * to all weapon and weapons-spells type feats\r\n */\r\nexport class Migration_13_0_11 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.11\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.11\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.11: Adding linked specializations fields to weapons\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items of type weapon or weapons-spells\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        const featType = sourceSystem.featType || 'equipment';\r\n        \r\n        // Only process weapon and weapons-spells types\r\n        if (featType !== 'weapon' && featType !== 'weapons-spells') {\r\n          continue;\r\n        }\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._specializationLinkMigrationVersion === '13.0.11') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check if the fields already exist\r\n        const hasAttackSpec = sourceSystem.hasOwnProperty('linkedAttackSpecialization');\r\n        const hasDefenseSpec = sourceSystem.hasOwnProperty('linkedDefenseSpecialization');\r\n        \r\n        if (hasAttackSpec && hasDefenseSpec) {\r\n          // Fields already exist, just mark as migrated\r\n          const update = {\r\n            _id: item.id,\r\n            'system._specializationLinkMigrationVersion': '13.0.11'\r\n          };\r\n          updates.push(update);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Add the new fields\r\n        const update = {\r\n          _id: item.id,\r\n          'system.linkedAttackSpecialization': sourceSystem.linkedAttackSpecialization || '',\r\n          'system.linkedDefenseSpecialization': sourceSystem.linkedDefenseSpecialization || '',\r\n          'system._specializationLinkMigrationVersion': '13.0.11'\r\n        };\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.11: Adding specialization link fields to weapon \"${item.name}\" (ID: ${item.id})`);\r\n        \r\n        updates.push(update);\r\n        totalUpdated++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.11 completed - Weapons updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_11_INFO', { count: totalUpdated }) :\r\n        `Migration 13.0.11: Added specialization link fields to ${totalUpdated} weapon(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Weapons can now be linked to attack and defense specializations\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.12: Convert \"dice\" to \"disadvantage\" in weapon ranges\r\n * This migration updates all weapon/spell range values from \"dice\" to \"disadvantage\"\r\n * for meleeRange, shortRange, mediumRange, and longRange fields\r\n */\r\nexport class Migration_13_0_12 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.12\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.12\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.12: Converting 'dice' to 'disadvantage' in weapon ranges\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._rangeDiceToDisadvantageMigrationVersion === '13.0.12') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check if any range has \"dice\" value\r\n        const hasDiceValue = \r\n          sourceSystem.meleeRange === 'dice' ||\r\n          sourceSystem.shortRange === 'dice' ||\r\n          sourceSystem.mediumRange === 'dice' ||\r\n          sourceSystem.longRange === 'dice';\r\n        \r\n        if (!hasDiceValue) {\r\n          // No \"dice\" values found, skip (don't mark as migrated to allow re-running)\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Build update object with converted values\r\n        const update = {\r\n          _id: item.id,\r\n          'system._rangeDiceToDisadvantageMigrationVersion': '13.0.12'\r\n        };\r\n        \r\n        if (sourceSystem.meleeRange === 'dice') {\r\n          update['system.meleeRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.shortRange === 'dice') {\r\n          update['system.shortRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.mediumRange === 'dice') {\r\n          update['system.mediumRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.longRange === 'dice') {\r\n          update['system.longRange'] = 'disadvantage';\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.12: Converting ranges for \"${item.name}\" (ID: ${item.id})`);\r\n        \r\n        updates.push(update);\r\n        totalUpdated++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.12 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_12_INFO', { count: totalUpdated }) :\r\n        `Migration 13.0.12: Converted weapon ranges from \"dice\" to \"disadvantage\" for ${totalUpdated} item(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All weapon ranges now use 'disadvantage' instead of 'dice'\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { SYSTEM } from \"./config/system.ts\";\r\nimport { setSidebarIcons, setControlIcons, setCompendiumBanners } from \"./config/ui-config.ts\";\r\n\r\n// Expose the SYSTEM object to the global scope\r\nglobalThis.SYSTEM = SYSTEM;\r\n\r\n// Declare global Foundry objects\r\ndeclare const Roll: any;\r\ndeclare const renderTemplate: any;\r\ndeclare const ChatMessage: any;\r\n\r\nimport * as models from \"./models/_module.ts\";\r\nimport * as documents from \"./documents/_module.ts\";\r\nimport * as applications from \"./applications/_module.ts\";\r\nimport * as CombatHelpers from \"./helpers/combat-helpers.ts\";\r\nimport * as SheetHelpers from \"./helpers/sheet-helpers.ts\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migrations } from \"./migration/migration.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_3 } from \"./migration/migration-13.0.3.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_4 } from \"./migration/migration-13.0.4.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_5 } from \"./migration/migration-13.0.5.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_6 } from \"./migration/migration-13.0.6.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_7 } from \"./migration/migration-13.0.7.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_8 } from \"./migration/migration-13.0.8.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_9 } from \"./migration/migration-13.0.9.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_10 } from \"./migration/migration-13.0.10.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_11 } from \"./migration/migration-13.0.11.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_12 } from \"./migration/migration-13.0.12.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { HOOKS } from \"./hooks.mjs\";\r\n\r\nexport class SRA2System {\r\n  static start(): void {\r\n    new SRA2System();\r\n  }\r\n\r\n  constructor() {\r\n    if (game.system) {\r\n      game.system.sra2 = this;\r\n    }\r\n    Hooks.once('init', () => this.onInit());\r\n  }\r\n  \r\n  onInit(): void {\r\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onInit');\r\n    if (game.system) {\r\n      game.system.api = {\r\n        applications,\r\n        models,\r\n        documents,\r\n      };\r\n    }\r\n    \r\n    // Register theme setting\r\n    this.registerThemeSetting();\r\n    \r\n    // Configure UI elements (icons, banners)\r\n    setSidebarIcons();\r\n    setControlIcons();\r\n    setCompendiumBanners();\r\n    \r\n    // Register migrations\r\n    new Migrations();\r\n    Hooks.on(HOOKS.MIGRATIONS, (declareMigration: any) => {\r\n      declareMigration(new Migration_13_0_3());\r\n      declareMigration(new Migration_13_0_4());\r\n      declareMigration(new Migration_13_0_5());\r\n      declareMigration(new Migration_13_0_6());\r\n      declareMigration(new Migration_13_0_7());\r\n      declareMigration(new Migration_13_0_8());\r\n      declareMigration(new Migration_13_0_9());\r\n      declareMigration(new Migration_13_0_10());\r\n      declareMigration(new Migration_13_0_11());\r\n      declareMigration(new Migration_13_0_12());\r\n    });\r\n    \r\n    // Register custom Actor document class\r\n    CONFIG.Actor.documentClass = documents.SRA2Actor;\r\n    \r\n    // Register Actor data models\r\n    CONFIG.Actor.dataModels = {\r\n      character: models.CharacterDataModel,\r\n      vehicle: models.VehicleDataModel,\r\n      ice: models.IceDataModel,\r\n    };\r\n    \r\n    // Register Item data models\r\n    CONFIG.Item.dataModels = {\r\n      skill: models.SkillDataModel,\r\n      feat: models.FeatDataModel,\r\n      specialization: models.SpecializationDataModel,\r\n      metatype: models.MetatypeDataModel,\r\n    };\r\n    \r\n    // Register character sheet (detailed view)\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheet, {\r\n      types: [\"character\"],\r\n      makeDefault: false,\r\n      label: \"SRA2.SHEET.CHARACTER\"\r\n    });\r\n    \r\n    // Register character sheet V2 (in-run view - default)\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheetV2, {\r\n      types: [\"character\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.CHARACTER_V2\"\r\n    });\r\n    \r\n    // Register vehicle sheet\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.VehicleSheet, {\r\n      types: [\"vehicle\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.VEHICLE\"\r\n    });\r\n    \r\n    // Register ICE sheet\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.IceSheet, {\r\n      types: [\"ice\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.ICE\"\r\n    });\r\n    \r\n    // Hook to ensure all vehicle actors are available in game.actors before cost calculations\r\n    // This runs after all actors are loaded to ensure vehicles are accessible synchronously\r\n    Hooks.on('ready', () => {\r\n      if (!game.actors) return;\r\n      \r\n      // Find all character actors and ensure their linked vehicles have calculatedCost\r\n      const characterActors = (game.actors as any).filter((actor: any) => actor.type === 'character');\r\n      \r\n      for (const charActor of characterActors) {\r\n        const linkedVehicles = (charActor.system as any)?.linkedVehicles || [];\r\n        \r\n        // Ensure all linked vehicles have their costs calculated\r\n        for (const vehicleUuid of linkedVehicles) {\r\n          try {\r\n            // Find vehicle in game.actors (should be available at 'ready' hook)\r\n            let vehicleActor = (game.actors as any).find((actor: any) => actor.uuid === vehicleUuid);\r\n            \r\n            // If not found by UUID, try by ID\r\n            if (!vehicleActor) {\r\n              const uuidParts = vehicleUuid.split('.');\r\n              if (uuidParts.length >= 3) {\r\n                const actorId = uuidParts[uuidParts.length - 1];\r\n                vehicleActor = (game.actors as any).get(actorId);\r\n              }\r\n            }\r\n            \r\n            // If vehicle found and it's a vehicle type, ensure its cost is calculated\r\n            if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n              // Trigger prepareDerivedData on vehicle if not already calculated\r\n              if (vehicleActor.system && (vehicleActor.system as any).prepareDerivedData) {\r\n                (vehicleActor.system as any).prepareDerivedData();\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.debug(`Vehicle ${vehicleUuid} not found in game.actors (may be in compendium)`);\r\n          }\r\n        }\r\n        \r\n        // Now trigger prepareDerivedData on character to recalculate cost with vehicles\r\n        try {\r\n          if (charActor.system && (charActor.system as any).prepareDerivedData) {\r\n            (charActor.system as any).prepareDerivedData();\r\n          }\r\n        } catch (error) {\r\n          console.debug(`Failed to recalculate cost for character ${charActor.name}:`, error);\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Hook to update character sheets when linked vehicles are updated\r\n    Hooks.on('updateActor', (actor: any, updateData: any, options: any, userId: string) => {\r\n      // DEBUG: Log all actor updates\r\n      console.log('Hook updateActor - DEBUG:', {\r\n        'actor.id': actor?.id,\r\n        'actor.name': actor?.name,\r\n        'actor.type': actor?.type,\r\n        'updateData keys': updateData ? Object.keys(updateData) : 'no updateData',\r\n        'updateData.system keys': updateData?.system ? Object.keys(updateData.system) : 'no system'\r\n      });\r\n      \r\n      // Only process vehicle actors\r\n      if (actor.type !== 'vehicle') return;\r\n      \r\n      // Force vehicle to recalculate its cost first\r\n      if (actor.system) {\r\n        (actor.system as any).prepareDerivedData();\r\n      }\r\n      \r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n        \r\n        // DEBUG: Log which character sheets will be re-rendered\r\n        if (characterActors.length > 0) {\r\n          console.log('Hook updateActor - Re-rendering character sheets:', {\r\n            'vehicle.id': actor.id,\r\n            'vehicle.name': actor.name,\r\n            'characterCount': characterActors.length,\r\n            'characters': characterActors.map((c: any) => ({ id: c.id, name: c.name }))\r\n          });\r\n        }\r\n        \r\n        // Re-render character sheets that have this vehicle linked\r\n        // Use a small delay to ensure derived data is recalculated\r\n        setTimeout(() => {\r\n          characterActors.forEach((char: any) => {\r\n            // Force recalculation of derived data (including cost) before re-rendering\r\n            if (char.system) {\r\n              (char.system as any).prepareDerivedData();\r\n            }\r\n            if (char.sheet && char.sheet.rendered) {\r\n              char.sheet.render(false);\r\n            }\r\n          });\r\n        }, 100);\r\n      }\r\n    });\r\n\r\n    // Hook to update character sheets when items are created/deleted on linked vehicles\r\n    // This ensures the cost is recalculated when weapons are added/removed\r\n    Hooks.on('createItem', (item: any, options: any, userId: string) => {\r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'vehicle') return;\r\n\r\n      // Check if this is a weapon item\r\n      const featType = item.system?.featType;\r\n      if (featType !== 'weapon' && featType !== 'weapons-spells') return;\r\n\r\n      // Force vehicle to recalculate its cost first\r\n      if (actor.system) {\r\n        (actor.system as any).prepareDerivedData();\r\n      }\r\n\r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n\r\n        // Force recalculation of derived data and re-render character sheets\r\n        characterActors.forEach((char: any) => {\r\n          // Force prepareDerivedData to recalculate\r\n          if (char.system) {\r\n            (char.system as any).prepareDerivedData();\r\n          }\r\n          if (char.sheet && char.sheet.rendered) {\r\n            setTimeout(() => {\r\n              char.sheet.render(false);\r\n            }, 100);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    Hooks.on('deleteItem', (item: any, options: any, userId: string) => {\r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'vehicle') return;\r\n\r\n      // Check if this was a weapon item\r\n      const featType = item.system?.featType;\r\n      if (featType !== 'weapon' && featType !== 'weapons-spells') return;\r\n\r\n      // Force vehicle to recalculate its cost first\r\n      if (actor.system) {\r\n        (actor.system as any).prepareDerivedData();\r\n      }\r\n\r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n\r\n        // Force recalculation of derived data and re-render character sheets\r\n        characterActors.forEach((char: any) => {\r\n          // Force prepareDerivedData to recalculate\r\n          if (char.system) {\r\n            (char.system as any).prepareDerivedData();\r\n          }\r\n          if (char.sheet && char.sheet.rendered) {\r\n            setTimeout(() => {\r\n              char.sheet.render(false);\r\n            }, 100);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    // Hook to automatically add linked skill when a specialization is created\r\n    Hooks.on('createItem', async (item: any, options: any, userId: string) => {\r\n      // Only process specializations on character actors\r\n      if (item.type !== 'specialization') return;\r\n      \r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'character') return;\r\n\r\n      // Get the linked skill name from the specialization\r\n      const linkedSkillName = item.system?.linkedSkill;\r\n      if (!linkedSkillName) return;\r\n\r\n      // Create a unique key for this actor + skill combination\r\n      const skillKey = `${actor.id}:${linkedSkillName}`;\r\n\r\n      // Check if this skill is already being created for this actor\r\n      if (SRA2System.skillsBeingCreated.has(skillKey)) {\r\n        // Skill creation already in progress, skip\r\n        return;\r\n      }\r\n\r\n      // Check if the skill already exists on the actor\r\n      const existingSkill = SheetHelpers.findSkillByName(actor, linkedSkillName);\r\n      if (existingSkill) {\r\n        // Skill already exists, nothing to do\r\n        return;\r\n      }\r\n\r\n      // Mark this skill as being created\r\n      SRA2System.skillsBeingCreated.add(skillKey);\r\n\r\n      try {\r\n        // Try to find the skill in game.items\r\n        const skillTemplate = SheetHelpers.findItemInGame('skill', linkedSkillName);\r\n        \r\n        if (skillTemplate) {\r\n          // Skill found in game.items, create it on the actor\r\n          try {\r\n            await actor.createEmbeddedDocuments('Item', [skillTemplate.toObject()]);\r\n            console.log(SYSTEM.LOG.HEAD + `Auto-added linked skill \"${linkedSkillName}\" for specialization \"${item.name}\"`);\r\n          } catch (error) {\r\n            console.error(SYSTEM.LOG.HEAD + `Error auto-adding skill \"${linkedSkillName}\":`, error);\r\n          }\r\n        } else {\r\n          // Skill not found in game.items, create a new one with default values\r\n          // Use the linkedAttribute from the specialization\r\n          const linkedAttribute = item.system?.linkedAttribute || 'strength';\r\n          const skillData = {\r\n            name: linkedSkillName,\r\n            type: 'skill',\r\n            system: {\r\n              rating: 0,\r\n              linkedAttribute: linkedAttribute,\r\n              description: '',\r\n              bookmarked: false\r\n            }\r\n          };\r\n          \r\n          try {\r\n            await actor.createEmbeddedDocuments('Item', [skillData]);\r\n            console.log(SYSTEM.LOG.HEAD + `Auto-created linked skill \"${linkedSkillName}\" for specialization \"${item.name}\"`);\r\n          } catch (error) {\r\n            console.error(SYSTEM.LOG.HEAD + `Error auto-creating skill \"${linkedSkillName}\":`, error);\r\n          }\r\n        }\r\n      } finally {\r\n        // Remove from the set after creation (or error)\r\n        SRA2System.skillsBeingCreated.delete(skillKey);\r\n      }\r\n    });\r\n    \r\n    // Also handle when vehicle is deleted\r\n    Hooks.on('deleteActor', (actor: any, options: any, userId: string) => {\r\n      // Only process vehicle actors\r\n      if (actor.type !== 'vehicle') return;\r\n      \r\n      // Find all character actors that have this vehicle linked and remove it\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n        \r\n        // Remove the vehicle from linked vehicles and re-render\r\n        characterActors.forEach(async (char: any) => {\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          const updatedLinkedVehicles = linkedVehicles.filter((uuid: string) => uuid !== vehicleUuid);\r\n          await char.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n          \r\n          if (char.sheet && char.sheet.rendered) {\r\n            char.sheet.render(false);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Register feat sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.FeatSheet, {\r\n      types: [\"feat\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.FEAT\"\r\n    });\r\n    \r\n    // Register skill sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SkillSheet, {\r\n      types: [\"skill\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.SKILL\"\r\n    });\r\n    \r\n    // Register specialization sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SpecializationSheet, {\r\n      types: [\"specialization\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.SPECIALIZATION\"\r\n    });\r\n    \r\n    // Register metatype sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.MetatypeSheet, {\r\n      types: [\"metatype\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.METATYPE\"\r\n    });\r\n    \r\n    // Register Handlebars helpers\r\n    Handlebars.registerHelper('add', function(a: number, b: number) {\r\n      return a + b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('eq', function(a: any, b: any) {\r\n      return a === b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('gt', function(a: any, b: any) {\r\n      return a > b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('gte', function(a: any, b: any) {\r\n      return a >= b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('concat', function(...args: any[]) {\r\n      // Remove the last argument which is the Handlebars options object\r\n      const values = args.slice(0, -1);\r\n      return values.join('');\r\n    });\r\n    \r\n    Handlebars.registerHelper('uppercase', function(str: string) {\r\n      return str ? str.toUpperCase() : '';\r\n    });\r\n    \r\n    // Helper to check if a dice result is a success based on roll mode\r\n    Handlebars.registerHelper('isSuccess', function(result: number, rollMode: string) {\r\n      if (rollMode === 'advantage') {\r\n        return result >= 4;\r\n      } else if (rollMode === 'disadvantage') {\r\n        return result === 6;\r\n      } else {\r\n        return result >= 5;\r\n      }\r\n    });\r\n    \r\n    // Helper to multiply two numbers\r\n    Handlebars.registerHelper('multiply', function(a: number, b: number) {\r\n      return a * b;\r\n    });\r\n    \r\n    // Helper to check if two values are not equal\r\n    Handlebars.registerHelper('ne', function(a: any, b: any) {\r\n      return a !== b;\r\n    });\r\n    \r\n    // Helper to stringify JSON\r\n    Handlebars.registerHelper('json', function(context: any) {\r\n      return JSON.stringify(context);\r\n    });\r\n    \r\n    // Register chat message hook for apply damage buttons\r\n    Hooks.on('renderChatMessage', (message: any, html: any) => {\r\n      // Remove existing handlers first to prevent duplicates\r\n      html.find('.apply-damage-button').off('click');\r\n      \r\n      html.find('.apply-damage-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        event.stopImmediatePropagation(); // Prevent other handlers from executing\r\n        \r\n        const button = $(event.currentTarget);\r\n        \r\n        // Check if button is already disabled to prevent double-clicks\r\n        if (button.prop('disabled')) {\r\n          return;\r\n        }\r\n        \r\n        // Template uses data-target-uuid, not data-defender-uuid\r\n        const targetUuid = button.data('target-uuid') || button.data('defender-uuid');\r\n        const damage = parseInt(button.data('damage')) || 0;\r\n        const targetName = button.data('target-name') || button.data('defender-name');\r\n        const damageType = (button.data('damage-type') || 'physical') as 'physical' | 'mental';\r\n        \r\n        if (!targetUuid) {\r\n          console.error('Apply damage button: No target UUID found in button data attributes');\r\n          ui.notifications?.error('Impossible de trouver la cible pour appliquer les dégâts');\r\n          return;\r\n        }\r\n        \r\n        if (damage <= 0) {\r\n          ui.notifications?.info('Aucun dégât à appliquer');\r\n          return;\r\n        }\r\n        \r\n        // Disable button to prevent double-click\r\n        button.prop('disabled', true);\r\n        \r\n        console.log('Apply damage button clicked:', { targetUuid, targetName, damage, damageType });\r\n        \r\n        try {\r\n          await CombatHelpers.applyDamage(targetUuid, damage, targetName, damageType);\r\n        } catch (error) {\r\n          console.error('Error applying damage:', error);\r\n          ui.notifications?.error('Erreur lors de l\\'application des dégâts');\r\n        } finally {\r\n          // Re-enable button after a short delay\r\n          setTimeout(() => button.prop('disabled', false), 1000);\r\n        }\r\n      });\r\n\r\n      // Defense button handler - remove existing handlers first to prevent duplicates\r\n      html.find('.defend-button').off('click');\r\n      \r\n      html.find('.defend-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        \r\n        // Get data from message flags (more reliable)\r\n        const messageFlags = message.flags?.sra2;\r\n        if (!messageFlags) {\r\n          console.error('Missing message flags');\r\n          return;\r\n        }\r\n\r\n        const rollResult = messageFlags.rollResult;\r\n        const rollData = messageFlags.rollData;\r\n        \r\n        if (!rollResult || !rollData) {\r\n          console.error('Missing roll data in message flags');\r\n          return;\r\n        }\r\n\r\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\r\n        let attackerToken: any = null;\r\n        let defenderToken: any = null;\r\n        let attacker: any = null;\r\n        let defender: any = null;\r\n        \r\n        // Log all flags for debugging\r\n        console.log('=== DEFENSE BUTTON - MESSAGE FLAGS ===');\r\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\r\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\r\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\r\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\r\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\r\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\r\n        console.log('======================================');\r\n        \r\n        // Use attacker UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\r\n        if (messageFlags.attackerUuid) {\r\n          try {\r\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\r\n            if (attacker) {\r\n              console.log('Defense button: Attacker loaded directly from attackerUuid flag:', messageFlags.attackerUuid);\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load attacker from attackerUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get attacker token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.attackerTokenUuid) {\r\n          try {\r\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\r\n            if (attackerToken?.actor && !attacker) {\r\n              // Use token's actor if attacker not loaded yet\r\n              attacker = attackerToken.actor;\r\n              console.log('Defense button: Attacker loaded from attackerTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load attacker token from attackerTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!attacker) {\r\n          if (messageFlags.attackerId) {\r\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\r\n          }\r\n          \r\n          if (attacker && !attackerToken) {\r\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n        \r\n        // Check if this is a vehicle weapon attack\r\n        const isVehicleWeapon = rollData.isVehicleWeapon;\r\n        const vehicleUuid = rollData.vehicleUuid;\r\n        \r\n        // For vehicle weapons, prioritize selected targets over flags to avoid using the drone as defender\r\n        // The defender should be the target, not the vehicle/drone itself\r\n        const selectedTargets = Array.from(game.user?.targets || []);\r\n        if (isVehicleWeapon && selectedTargets.length > 0) {\r\n          // Use the first selected target as defender (not the drone)\r\n          defenderToken = selectedTargets[0];\r\n          if (defenderToken?.actor) {\r\n            defender = defenderToken.actor;\r\n            console.log('Defense button: For vehicle weapon, using selected target as defender:', defender?.name);\r\n          }\r\n        }\r\n        \r\n        // Use defender UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\r\n        // Skip if we already have a defender from selected targets for vehicle weapons\r\n        if (!defender && messageFlags.defenderUuid) {\r\n          try {\r\n            const defenderFromUuid = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderFromUuid) {\r\n              if (isVehicleWeapon && vehicleUuid && defenderFromUuid.uuid === vehicleUuid) {\r\n                console.log('Defense button: Skipping vehicle as defender for vehicle weapon - need target instead');\r\n              } else {\r\n                defender = defenderFromUuid;\r\n                console.log('Defense button: Defender loaded directly from defenderUuid flag');\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load defender from defenderUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get defender token from UUID if available (priority: flag > canvas search)\r\n        // Skip if we already have a defender from selected targets for vehicle weapons\r\n        if (!defenderToken && messageFlags.defenderTokenUuid) {\r\n          try {\r\n            const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderTokenFromUuid) {\r\n              if (isVehicleWeapon && vehicleUuid) {\r\n                const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || undefined;\r\n                if (tokenActorUuid === vehicleUuid) {\r\n                  console.log('Defense button: Skipping vehicle token as defender for vehicle weapon - need target instead');\r\n                } else {\r\n                  defenderToken = defenderTokenFromUuid;\r\n                  if (defenderToken?.actor && !defender) {\r\n                    defender = defenderToken.actor;\r\n                    console.log('Defense button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n                  }\r\n                }\r\n              } else {\r\n                defenderToken = defenderTokenFromUuid;\r\n                if (defenderToken?.actor && !defender) {\r\n                  defender = defenderToken.actor;\r\n                  console.log('Defense button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n                }\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load defender token from defenderTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!defender) {\r\n          if (messageFlags.defenderId) {\r\n            const defenderFromId = game.actors?.get(messageFlags.defenderId) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderFromId) {\r\n              if (isVehicleWeapon && vehicleUuid && defenderFromId.uuid === vehicleUuid) {\r\n                console.log('Defense button: Skipping vehicle as defender for vehicle weapon - need target instead');\r\n              } else {\r\n                defender = defenderFromId;\r\n              }\r\n            }\r\n          }\r\n          \r\n          if (defender && !defenderToken) {\r\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n\r\n        // Extract information - use UUIDs directly from flags as they are already correctly calculated\r\n        const success = rollResult.totalSuccesses || 0;\r\n        const damage = rollData.damageValue || 0;\r\n        const attackerName = attacker?.name || 'Unknown';\r\n        const attackerId = attacker?.id || messageFlags.attackerId || 'Unknown';\r\n        const attackerUuid = messageFlags.attackerUuid || attacker?.uuid || 'Unknown'; // Use flag UUID first (already calculated correctly)\r\n        const defenderName = defender?.name || 'Unknown';\r\n        const defenderId = defender?.id || messageFlags.defenderId || 'Unknown';\r\n        // For vehicle weapons, use the actual defender (target), not the vehicle/drone\r\n        // If we have a defender from selected targets, use it; otherwise use flag UUID\r\n        let defenderUuid = defender?.uuid || 'Unknown';\r\n        if (!defender || (isVehicleWeapon && vehicleUuid && defender.uuid === vehicleUuid)) {\r\n          // Fallback to flag UUID only if we don't have a valid defender\r\n          defenderUuid = messageFlags.defenderUuid || defender?.uuid || 'Unknown';\r\n        }\r\n        \r\n        // Log the UUIDs that will be used\r\n        console.log('--- UUIDs being used from flags ---');\r\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\r\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\r\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\r\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\r\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\r\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\r\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\r\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\r\n        const defenseSkill = rollData.linkedDefenseSkill || null;\r\n        const defenseSpec = rollData.linkedDefenseSpecialization || null;\r\n        const attackSkill = rollData.linkedAttackSkill || rollData.skillName || null;\r\n        const attackSpec = rollData.linkedAttackSpecialization || rollData.specName || null;\r\n\r\n        // Console log all information\r\n        console.log('=== DEFENSE CLICK ===');\r\n        console.log('Success:', success);\r\n        console.log('Damage:', damage);\r\n        console.log('Attacker:', attackerName);\r\n        console.log('Attacker ID:', attackerId);\r\n        console.log('Attacker UUID:', attackerUuid);\r\n        console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || 'Unknown');\r\n        console.log('Defender:', defenderName);\r\n        console.log('Defender ID:', defenderId);\r\n        console.log('Defender UUID:', defenderUuid);\r\n        console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || 'Unknown');\r\n        console.log('Skill de defense:', defenseSkill);\r\n        console.log('Spe de defense:', defenseSpec);\r\n        console.log('Skill d\\'attaque:', attackSkill);\r\n        console.log('Spe d\\'attaque:', attackSpec);\r\n        console.log('===================');\r\n\r\n        // Check if defender is a vehicle (vehicles use autopilot instead of defense skill)\r\n        const isVehicleDefender = defender?.type === 'vehicle';\r\n        \r\n        // Open defense roll dialog\r\n        if (!defender) {\r\n          console.error('Missing defender');\r\n          return;\r\n        }\r\n\r\n        // Get defender token from UUID (for NPCs, we need the token instance)\r\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\r\n        let defenderTokenForRoll: any = null;\r\n        let defenderActorForRoll: any = defender; // Default to defender actor\r\n        \r\n        // For vehicle weapons, use the defender we already found (which should be the target, not the drone)\r\n        if (isVehicleWeapon && defenderToken) {\r\n          defenderTokenForRoll = defenderToken;\r\n          if (defenderToken?.actor) {\r\n            defenderActorForRoll = defenderToken.actor;\r\n          }\r\n        } else {\r\n          const defenderTokenUuidFromFlags = messageFlags.defenderTokenUuid;\r\n          if (defenderTokenUuidFromFlags) {\r\n            try {\r\n              const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidFromFlags) || null;\r\n              // For vehicle weapons, skip if this is the vehicle itself\r\n              if (defenderTokenFromUuid) {\r\n                if (isVehicleWeapon && vehicleUuid) {\r\n                  const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || undefined;\r\n                  if (tokenActorUuid === vehicleUuid) {\r\n                    console.log('Defense: Skipping vehicle token as defender for vehicle weapon - using target instead');\r\n                    defenderTokenForRoll = defenderToken;\r\n                    if (defenderToken?.actor) {\r\n                      defenderActorForRoll = defenderToken.actor;\r\n                    }\r\n                  } else {\r\n                    defenderTokenForRoll = defenderTokenFromUuid;\r\n                    if (defenderTokenForRoll?.actor) {\r\n                      defenderActorForRoll = defenderTokenForRoll.actor;\r\n                    }\r\n                  }\r\n                } else {\r\n                  defenderTokenForRoll = defenderTokenFromUuid;\r\n                  if (defenderTokenForRoll?.actor) {\r\n                    defenderActorForRoll = defenderTokenForRoll.actor;\r\n                  }\r\n                }\r\n              }\r\n            } catch (e) {\r\n              // Fallback to finding token on canvas\r\n              defenderTokenForRoll = defenderToken;\r\n              if (defenderToken?.actor) {\r\n                defenderActorForRoll = defenderToken.actor;\r\n              }\r\n            }\r\n          } else {\r\n            defenderTokenForRoll = defenderToken;\r\n            if (defenderToken?.actor) {\r\n              defenderActorForRoll = defenderToken.actor;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Check if this is an ICE attack\r\n        const isIceAttack = messageFlags.rollType === 'ice-attack' || rollData.itemType === 'ice-attack';\r\n        \r\n        // Determine which skill/spec to use for defense\r\n        // Priority: 1) attack spec from weapon (if using weapon for defense), 2) defenseSpec if found, 3) defenseSkill if found, 4) fallback based on attack type\r\n        let finalDefenseSkill: string | null = null;\r\n        let finalDefenseSpec: string | null = null;\r\n        \r\n        // For ICE attacks, always use Piratage (cybercombat)\r\n        if (isIceAttack) {\r\n          finalDefenseSkill = 'Piratage';\r\n          // Try to find cybercombat specialization\r\n          const cybercombatSpec = defenderActorForRoll.items.find((item: any) => {\r\n            if (item.type !== 'specialization') return false;\r\n            const specSystem = item.system as any;\r\n            return item.name === 'Cybercombat' && specSystem.linkedSkill === 'Piratage';\r\n          });\r\n          if (cybercombatSpec) {\r\n            finalDefenseSpec = 'Cybercombat';\r\n          }\r\n        }\r\n        \r\n        // First, try to use the attack specialization from the weapon (if defending with a weapon)\r\n        // This allows using \"Lames\" specialization when defending with a short weapon\r\n        // Priority: use attack spec over defense spec when defending with a weapon\r\n        if (!isIceAttack && attackSpec) {\r\n          // Check if this attack spec exists in the defender's items and is linked to \"Combat rapproché\"\r\n          const spec = defenderActorForRoll.items.find((item: any) => {\r\n            if (item.type !== 'specialization') return false;\r\n            const specSystem = item.system as any;\r\n            return item.name === attackSpec && specSystem.linkedSkill === 'Combat rapproché';\r\n          });\r\n          if (spec) {\r\n            finalDefenseSpec = spec.name;\r\n            const specSystem = spec.system as any;\r\n            finalDefenseSkill = specSystem.linkedSkill;\r\n          }\r\n        }\r\n        \r\n        // Try to find the defense spec (from weapon's linkedDefenseSpecialization)\r\n        if (!finalDefenseSpec && defenseSpec) {\r\n          const spec = defenderActorForRoll.items.find((item: any) => \r\n            item.type === 'specialization' && item.name === defenseSpec\r\n          );\r\n          if (spec) {\r\n            finalDefenseSpec = defenseSpec;\r\n            const specSystem = spec.system as any;\r\n            const linkedSkillName = specSystem.linkedSkill;\r\n            finalDefenseSkill = linkedSkillName;\r\n          }\r\n        }\r\n        \r\n        // If spec not found, try to find the defense skill\r\n        if (!finalDefenseSpec && defenseSkill) {\r\n          const skill = defenderActorForRoll.items.find((item: any) => \r\n            item.type === 'skill' && item.name === defenseSkill\r\n          );\r\n          if (skill) {\r\n            finalDefenseSkill = defenseSkill;\r\n          }\r\n        }\r\n        \r\n        // Calculate skill/spec levels for defender (use token's actor for NPCs)\r\n        let defenseSkillLevel: number | undefined = undefined;\r\n        let defenseSpecLevel: number | undefined = undefined;\r\n        let defenseLinkedAttribute: string | undefined = undefined;\r\n\r\n        // For vehicles, use autopilot instead of defense skill\r\n        if (isVehicleDefender) {\r\n          // Vehicles use autopilot for defense\r\n          const autopilot = (defenderActorForRoll.system as any)?.attributes?.autopilot || 0;\r\n          finalDefenseSkill = 'Autopilot'; // Special skill name for vehicles\r\n          defenseSkillLevel = autopilot;\r\n          defenseLinkedAttribute = undefined; // Vehicles don't use attributes\r\n        } else {\r\n          // Fallback: determine based on attack type (melee or ranged)\r\n          if (!finalDefenseSkill) {\r\n            // Check if it's a melee attack (check meleeRange in rollData)\r\n            const isMeleeAttack = rollData.meleeRange && rollData.meleeRange !== 'none';\r\n            if (isMeleeAttack) {\r\n              finalDefenseSkill = 'Combat rapproché';\r\n            } else {\r\n              finalDefenseSkill = 'Athlétisme';\r\n            }\r\n          }\r\n\r\n          // Calculate skill/spec levels for defender\r\n          if (finalDefenseSpec) {\r\n            const spec = defenderActorForRoll.items.find((item: any) => \r\n              item.type === 'specialization' && item.name === finalDefenseSpec\r\n            );\r\n            if (spec) {\r\n              const specSystem = spec.system as any;\r\n              const linkedSkillName = specSystem.linkedSkill;\r\n              const linkedSkill = defenderActorForRoll.items.find((item: any) => \r\n                item.type === 'skill' && item.name === linkedSkillName\r\n              );\r\n              if (linkedSkill) {\r\n                const skillRating = (linkedSkill.system as any).rating || 0;\r\n                const specRating = specSystem.rating || 0;\r\n                defenseLinkedAttribute = specSystem.linkedAttribute || (linkedSkill.system as any).linkedAttribute || 'strength';\r\n                const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\r\n                \r\n                defenseSkillLevel = attributeValue + skillRating;\r\n                defenseSpecLevel = defenseSkillLevel + specRating;\r\n              }\r\n            }\r\n          } else if (finalDefenseSkill) {\r\n            const skill = defenderActorForRoll.items.find((item: any) => \r\n              item.type === 'skill' && item.name === finalDefenseSkill\r\n            );\r\n            if (skill) {\r\n              const skillSystem = skill.system as any;\r\n              const skillRating = skillSystem.rating || 0;\r\n              defenseLinkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n              const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\r\n              \r\n              defenseSkillLevel = attributeValue + skillRating;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Final check: ensure we have a defense skill (or autopilot for vehicles)\r\n        if (!finalDefenseSkill && !isVehicleDefender) {\r\n          console.error('Could not determine defense skill for non-vehicle defender');\r\n          return;\r\n        }\r\n\r\n        // Get RR sources for defense skill/spec (use token's actor for NPCs)\r\n        // Note: Vehicles don't have RR sources for autopilot\r\n        const { getRRSources } = await import('./helpers/sheet-helpers.js');\r\n        let defenseRRList: any[] = [];\r\n        if (!isVehicleDefender) {\r\n          // Only get RR sources for non-vehicles\r\n          if (finalDefenseSpec) {\r\n            const rrSources = getRRSources(defenderActorForRoll, 'specialization', finalDefenseSpec);\r\n            defenseRRList = rrSources.map((rr: any) => ({\r\n              ...rr,\r\n              featName: rr.featName\r\n            }));\r\n          } else if (finalDefenseSkill) {\r\n            const rrSources = getRRSources(defenderActorForRoll, 'skill', finalDefenseSkill);\r\n            defenseRRList = rrSources.map((rr: any) => ({\r\n              ...rr,\r\n              featName: rr.featName\r\n            }));\r\n          }\r\n        }\r\n\r\n        // Get token UUIDs\r\n        // For defense: attacker = defender (one defending), defender = original attacker\r\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || messageFlags.attackerTokenUuid || undefined;\r\n        const defenderTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || messageFlags.defenderTokenUuid || undefined;\r\n        \r\n        // Prepare defense roll data\r\n        // In defense context:\r\n        // - attacker = defender (one defending) -> attackerTokenUuid should be defender's token\r\n        // - defender = original attacker -> defenderTokenUuid should be original attacker's token\r\n        const defenseRollData: any = {\r\n          // Use final defense skill/spec (with fallback)\r\n          skillName: finalDefenseSkill,\r\n          specName: finalDefenseSpec,\r\n          linkedAttribute: defenseLinkedAttribute,\r\n          skillLevel: defenseSkillLevel,\r\n          specLevel: defenseSpecLevel,\r\n          \r\n          // Actor is the defender - for vehicle weapons, use the actual defender (target) UUID, not the vehicle\r\n          actorId: defenderActorForRoll.id,\r\n          actorUuid: defenderActorForRoll.uuid, // Use the actual defender actor UUID (target, not drone)\r\n          \r\n          // Token UUIDs - for defense, attackerToken is the defender's token, defenderToken is the original attacker's token\r\n          attackerTokenUuid: defenderTokenUuid, // Defender's token (one defending) - this is what will be attacker in RollDialog\r\n          defenderTokenUuid: originalAttackerTokenUuid, // Original attacker's token (target) - this is what will be target/defender in RollDialog\r\n          \r\n          // RR List\r\n          rrList: defenseRRList,\r\n          \r\n          // Defense flags\r\n          isDefend: true,\r\n          isCounterAttack: false,\r\n          \r\n          // Store original attack roll data for comparison\r\n          attackRollResult: rollResult,\r\n          attackRollData: rollData\r\n        };\r\n\r\n        // Import and open RollDialog\r\n        const { RollDialog } = await import('./applications/roll-dialog.js');\r\n        const dialog = new RollDialog(defenseRollData);\r\n        \r\n        // Set target token to original attacker's token (in defense context, target = original attacker)\r\n        // For vehicle weapons, this should be the character's token (the one who attacked), not the drone\r\n        if (attackerToken) {\r\n          (dialog as any).targetToken = attackerToken;\r\n        }\r\n        \r\n        // For vehicle weapons, make sure we don't use the vehicle as target\r\n        // The target should be the character who attacked with the drone weapon\r\n        if (isVehicleWeapon && vehicleUuid) {\r\n          // Ensure targetToken is not the vehicle\r\n          if ((dialog as any).targetToken?.actor?.uuid === vehicleUuid) {\r\n            console.log('Defense: Target token is the vehicle, should be the character instead');\r\n            // Find the character's token (the original attacker)\r\n            const characterToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker?.id || token.actor?.uuid === attacker?.uuid;\r\n            }) || null;\r\n            if (characterToken) {\r\n              (dialog as any).targetToken = characterToken;\r\n            }\r\n          }\r\n        }\r\n        \r\n        dialog.render(true);\r\n      });\r\n\r\n      // Counter-attack button handler - remove existing handlers first to prevent duplicates\r\n      html.find('.counter-attack-button').off('click');\r\n      \r\n      html.find('.counter-attack-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        \r\n        // Get data from message flags (more reliable)\r\n        const messageFlags = message.flags?.sra2;\r\n        if (!messageFlags) {\r\n          console.error('Missing message flags');\r\n          return;\r\n        }\r\n\r\n        const rollResult = messageFlags.rollResult;\r\n        const rollData = messageFlags.rollData;\r\n        \r\n        if (!rollResult || !rollData) {\r\n          console.error('Missing roll data in message flags');\r\n          return;\r\n        }\r\n\r\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\r\n        let attackerToken: any = null;\r\n        let defenderToken: any = null;\r\n        let attacker: any = null;\r\n        let defender: any = null;\r\n        \r\n        // Log all flags for debugging\r\n        console.log('=== COUNTER-ATTACK BUTTON - MESSAGE FLAGS ===');\r\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\r\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\r\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\r\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\r\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\r\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\r\n        console.log('==============================================');\r\n        \r\n        // Use attacker UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\r\n        if (messageFlags.attackerUuid) {\r\n          try {\r\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\r\n            if (attacker) {\r\n              console.log('Counter-attack button: Attacker loaded directly from attackerUuid flag');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load attacker from attackerUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get attacker token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.attackerTokenUuid) {\r\n          try {\r\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\r\n            if (attackerToken?.actor && !attacker) {\r\n              // Use token's actor if attacker not loaded yet\r\n              attacker = attackerToken.actor;\r\n              console.log('Counter-attack button: Attacker loaded from attackerTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load attacker token from attackerTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!attacker) {\r\n          if (messageFlags.attackerId) {\r\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\r\n          }\r\n          \r\n          if (attacker && !attackerToken) {\r\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n        \r\n        // Use defender UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\r\n        if (messageFlags.defenderUuid) {\r\n          try {\r\n            defender = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\r\n            if (defender) {\r\n              console.log('Counter-attack button: Defender loaded directly from defenderUuid flag');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load defender from defenderUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get defender token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.defenderTokenUuid) {\r\n          try {\r\n            defenderToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\r\n            if (defenderToken?.actor && !defender) {\r\n              // Use token's actor if defender not loaded yet\r\n              defender = defenderToken.actor;\r\n              console.log('Counter-attack button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load defender token from defenderTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!defender) {\r\n          if (messageFlags.defenderId) {\r\n            defender = game.actors?.get(messageFlags.defenderId) || null;\r\n          }\r\n          \r\n          if (defender && !defenderToken) {\r\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n\r\n        // Log the UUIDs that will be used\r\n        console.log('--- UUIDs being used from flags (counter-attack) ---');\r\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\r\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\r\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\r\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\r\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\r\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\r\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\r\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\r\n        \r\n        // Open counter-attack roll dialog\r\n        if (!defender) {\r\n          console.error('Missing defender');\r\n          return;\r\n        }\r\n\r\n        // Get defender token from UUID (for NPCs, we need the token instance)\r\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\r\n        // Use defenderTokenUuid directly from flags (already correctly calculated)\r\n        let defenderTokenForRoll: any = null;\r\n        let defenderActorForRoll: any = defender; // Default to defender actor\r\n        \r\n        const defenderTokenUuidForCounter = messageFlags.defenderTokenUuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n        if (defenderTokenUuidForCounter) {\r\n          try {\r\n            defenderTokenForRoll = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidForCounter) || null;\r\n            // For NPCs, use the token's actor (which may be different from the base actor)\r\n            if (defenderTokenForRoll?.actor) {\r\n              defenderActorForRoll = defenderTokenForRoll.actor;\r\n            }\r\n          } catch (e) {\r\n            // Fallback to finding token on canvas\r\n            defenderTokenForRoll = defenderToken;\r\n            if (defenderToken?.actor) {\r\n              defenderActorForRoll = defenderToken.actor;\r\n            }\r\n          }\r\n        } else {\r\n          defenderTokenForRoll = defenderToken;\r\n          if (defenderToken?.actor) {\r\n            defenderActorForRoll = defenderToken.actor;\r\n          }\r\n        }\r\n\r\n        // Get all weapons from defender's items for counter-attack\r\n        // Get all items of type 'feat' with featType 'weapon' or 'weapons-spells'\r\n        const allWeapons = defenderActorForRoll.items.filter((item: any) => {\r\n          const isFeat = item.type === 'feat';\r\n          const isWeapon = item.system?.featType === 'weapon' || item.system?.featType === 'weapons-spells';\r\n          return isFeat && isWeapon;\r\n        });\r\n\r\n        // Import WEAPON_TYPES to check melee capability\r\n        const { WEAPON_TYPES } = await import('./models/item-feat.js');\r\n        \r\n        // Filter weapons that:\r\n        // 1. Have melee \"ok\" or \"disadvantage\"\r\n        // 2. Are linked to \"Combat rapproché\" skill or a specialization of \"Combat rapproché\"\r\n        const defenderWeapons = allWeapons.filter((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          const weaponType = weaponSystem.weaponType;\r\n          \r\n          // Check meleeRange in weapon system\r\n          const meleeRange = weaponSystem.meleeRange || 'none';\r\n          const hasMeleeInSystem = meleeRange === 'ok' || meleeRange === 'disadvantage';\r\n          \r\n          // Check melee in weapon type\r\n          let hasMeleeInType = false;\r\n          if (weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats && weaponStats.melee) {\r\n              hasMeleeInType = weaponStats.melee === 'ok' || weaponStats.melee === 'disadvantage';\r\n            }\r\n          }\r\n          \r\n          // Must have melee capability\r\n          if (!hasMeleeInSystem && !hasMeleeInType) {\r\n            return false;\r\n          }\r\n          \r\n          // Get linked attack skill\r\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\r\n\r\n          // If no linkedAttackSkill, try to get it from weapon type\r\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats) {\r\n              linkedAttackSkill = weaponStats.linkedSkill;\r\n            }\r\n          }\r\n          \r\n          // Must be linked to \"Combat rapproché\" skill\r\n          if (linkedAttackSkill === 'Combat rapproché') {\r\n            return true;\r\n          }\r\n          \r\n          // Check if weapon has a specialization linked to \"Combat rapproché\"\r\n          // Look for specializations linked to \"Combat rapproché\" in the actor's items\r\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \r\n            item.type === 'specialization' && \r\n            item.system.linkedSkill === 'Combat rapproché'\r\n          );\r\n          \r\n          // Check if weapon's linkedAttackSkill matches any specialization name\r\n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\r\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSkill\r\n            );\r\n            if (hasCombatRapprocheSpec) {\r\n              return true;\r\n            }\r\n          }\r\n          \r\n          // Also check weapon's linkedAttackSpecialization\r\n          const linkedAttackSpecialization = weaponSystem.linkedAttackSpecialization;\r\n          if (linkedAttackSpecialization) {\r\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSpecialization\r\n            );\r\n            if (hasCombatRapprocheSpec) {\r\n              return true;\r\n            }\r\n          }\r\n          \r\n          return false;\r\n        });\r\n\r\n        console.log('Counter-attack: Filtered weapons with melee capability:', defenderWeapons.length, defenderWeapons.map((w: any) => ({\r\n          name: w.name,\r\n          meleeRange: w.system?.meleeRange,\r\n          weaponType: w.system?.weaponType,\r\n          meleeInType: w.system?.weaponType ? WEAPON_TYPES[w.system.weaponType as keyof typeof WEAPON_TYPES]?.melee : null\r\n        })));\r\n\r\n        if (defenderWeapons.length === 0) {\r\n          console.error('Counter-attack: No weapons with melee capability. All items:', defenderActorForRoll.items.map((i: any) => ({\r\n            name: i.name,\r\n            type: i.type,\r\n            featType: i.system?.featType,\r\n            meleeRange: i.system?.meleeRange,\r\n            weaponType: i.system?.weaponType\r\n          })));\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPONS') || 'Aucune arme disponible pour la contre-attaque');\r\n          return;\r\n        }\r\n\r\n        // Prepare available weapons data for RollDialog\r\n        const availableWeapons = defenderWeapons.map((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          const weaponType = weaponSystem.weaponType;\r\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\r\n          \r\n          // If no linkedAttackSkill, try to get it from weapon type\r\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats) {\r\n              linkedAttackSkill = weaponStats.linkedSkill;\r\n            }\r\n        }\r\n\r\n          // Check if linkedAttackSkill is a specialization of \"Combat rapproché\"\r\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \r\n            item.type === 'specialization' && \r\n            item.system.linkedSkill === 'Combat rapproché'\r\n          );\r\n          \r\n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\r\n            const isCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSkill\r\n            );\r\n            if (isCombatRapprocheSpec) {\r\n              // Keep the specialization name, but the skill is \"Combat rapproché\"\r\n              // We'll use this in the weapon selection to show both\r\n            } else if (linkedAttackSkill !== 'Combat rapproché') {\r\n              // Not a specialization of Combat rapproché, use \"Combat rapproché\" as base skill\r\n              linkedAttackSkill = 'Combat rapproché';\r\n            }\r\n          } else {\r\n            // Default to \"Combat rapproché\" if still no skill\r\n            linkedAttackSkill = 'Combat rapproché';\r\n          }\r\n          \r\n          // Get weapon stats from WEAPON_TYPES if weapon type exists\r\n          const weaponStats = weaponType && weaponType !== 'custom-weapon' \r\n            ? WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES] \r\n            : undefined;\r\n          \r\n          return {\r\n            id: weapon.id,\r\n            name: weapon.name,\r\n            linkedAttackSkill: linkedAttackSkill,\r\n            damageValue: weaponSystem.damageValue || '0',\r\n            damageValueBonus: weaponSystem.damageValueBonus || 0,\r\n            weaponType: weaponType,\r\n            meleeRange: weaponSystem.meleeRange || weaponStats?.melee || 'none',\r\n            shortRange: weaponSystem.shortRange || weaponStats?.short || 'none',\r\n            mediumRange: weaponSystem.mediumRange || weaponStats?.medium || 'none',\r\n            longRange: weaponSystem.longRange || weaponStats?.long || 'none'\r\n          };\r\n        });\r\n\r\n        // Get token UUIDs\r\n        const counterAttackerTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\r\n        \r\n        // Prepare counter-attack roll data with available weapons\r\n        // Use UUIDs directly from flags (already correctly calculated)\r\n        const counterAttackRollData: any = {\r\n          // Actor is the defender - use UUID directly from flags (already correctly calculated)\r\n          actorId: defenderActorForRoll.id,\r\n          actorUuid: messageFlags.defenderUuid || defenderActorForRoll.uuid, // Use flag UUID first\r\n          \r\n          // Token UUIDs - for counter-attack, the defender becomes the attacker\r\n          // Use UUIDs directly from flags (already correctly calculated)\r\n          attackerTokenUuid: messageFlags.defenderTokenUuid || counterAttackerTokenUuid, // Token of the defender (who is counter-attacking)\r\n          defenderTokenUuid: messageFlags.attackerTokenUuid || originalAttackerTokenUuid, // Token of the original attacker\r\n          \r\n          // Available weapons for selection\r\n          availableWeapons: availableWeapons,\r\n          \r\n          // Counter-attack flags\r\n          isDefend: false,\r\n          isCounterAttack: true,\r\n          \r\n          // Store original attack roll data for comparison\r\n          attackRollResult: rollResult,\r\n          attackRollData: rollData\r\n        };\r\n\r\n        // Import and open RollDialog\r\n        const { RollDialog } = await import('./applications/roll-dialog.js');\r\n        const dialog = new RollDialog(counterAttackRollData);\r\n        \r\n        // Note: targetToken should already be loaded from defenderTokenUuid in RollDialog constructor\r\n        // Only set it manually if it wasn't loaded from UUID (fallback)\r\n        if (attackerToken && !(dialog as any).targetToken) {\r\n          (dialog as any).targetToken = attackerToken;\r\n        }\r\n        \r\n        dialog.render(true);\r\n      });\r\n    });\r\n    \r\n    // Register token context menu hook for bookmarks/favorites\r\n    (Hooks as any).on('getTokenHUDOptions', (_hud: any, buttons: any[], token: any) => {\r\n      const actor = token.actor;\r\n      if (!actor) return;\r\n      \r\n      // Get bookmarked items\r\n      const bookmarkedItems = actor.items.filter((i: any) => \r\n        (i.type === 'skill' || i.type === 'feat') && i.system.bookmarked\r\n      );\r\n      \r\n      if (bookmarkedItems.length > 0) {\r\n        buttons.unshift({\r\n          name: 'SRA2_BOOKMARKS',\r\n          title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE'),\r\n          icon: 'fa-solid fa-star',\r\n          button: true,\r\n          onclick: () => {\r\n            // Show bookmarks dialog\r\n            this.showBookmarksDialog(actor);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Function to add roll dice button to chat\r\n    const addRollDiceButton = () => {\r\n      // Find the chat message input form in the DOM\r\n      const chatForm = $('.chat-form');\r\n      if (chatForm.length === 0) {\r\n        return false;\r\n      }\r\n      \r\n      // Check if button already exists to avoid duplicates\r\n      if (chatForm.find('.sra2-roll-dice-container').length > 0) {\r\n        return true;\r\n      }\r\n      \r\n      // Create the roll dice container with inputs and radio\r\n      const rollDiceContainer = $(`\r\n        <div class=\"sra2-roll-dice-container\">\r\n          <div class=\"sra2-roll-dice-inputs\">\r\n            <input type=\"text\" value=\"3\" class=\"sra2-dice-count-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.DICE_COUNT')}\" title=\"${game.i18n!.localize('SRA2.CHAT.DICE_COUNT')}\">\r\n            <input type=\"text\" value=\"0\" class=\"sra2-risk-dice-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.RISK_DICE')}\" title=\"${game.i18n!.localize('SRA2.CHAT.RISK_DICE')}\">\r\n            <input type=\"text\" value=\"\" class=\"sra2-rr-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.RR')} 0\" title=\"${game.i18n!.localize('SRA2.CHAT.RR')}\">\r\n            <div class=\"sra2-roll-mode-radio\">\r\n              <label class=\"sra2-radio-advantage\" title=\"${game.i18n!.localize('SRA2.CHAT.ADVANTAGE')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"advantage\">\r\n                <span>A</span>\r\n              </label>\r\n              <label class=\"sra2-radio-normal\" title=\"${game.i18n!.localize('SRA2.CHAT.NORMAL')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"normal\" checked>\r\n                <span>N</span>\r\n              </label>\r\n              <label class=\"sra2-radio-disadvantage\" title=\"${game.i18n!.localize('SRA2.CHAT.DISADVANTAGE')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"disadvantage\">\r\n                <span>D</span>\r\n              </label>\r\n            </div>\r\n          </div>\r\n          <button type=\"button\" class=\"sra2-roll-dice-button\" title=\"${game.i18n!.localize('SRA2.CHAT.ROLL_DICE')}\">\r\n            <i class=\"fas fa-dice-d6\"></i> ${game.i18n!.localize('SRA2.CHAT.ROLL_DICE')}\r\n          </button>\r\n        </div>\r\n      `);\r\n      \r\n      // Insert container as first element in .chat-form\r\n      chatForm.prepend(rollDiceContainer);\r\n      \r\n      // Add click handler to button\r\n      const rollDiceButton = rollDiceContainer.find('.sra2-roll-dice-button');\r\n      rollDiceButton.on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        \r\n        // Get controlled actor (first controlled token's actor, or first owned actor)\r\n        let actor: any = null;\r\n        const controlledTokens = canvas?.tokens?.controlled || [];\r\n        \r\n        if (controlledTokens.length > 0) {\r\n          actor = controlledTokens[0].actor;\r\n        } else {\r\n          // Fallback: get first owned actor\r\n          const ownedActors = (game.actors as any).filter((a: any) => a.isOwner);\r\n          if (ownedActors.length > 0) {\r\n            actor = ownedActors[0];\r\n          }\r\n        }\r\n        \r\n        if (!actor) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.CHAT.NO_ACTOR') || 'Aucun personnage contrôlé');\r\n          return;\r\n        }\r\n        \r\n        // Get values from inputs and radio\r\n        const diceCount = parseInt(rollDiceContainer.find('.sra2-dice-count-input').val() as string) || 0;\r\n        const riskDiceCount = parseInt(rollDiceContainer.find('.sra2-risk-dice-input').val() as string) || 0;\r\n        const rr = parseInt(rollDiceContainer.find('.sra2-rr-input').val() as string) || 0;\r\n        const rollMode = rollDiceContainer.find('input[name=\"sra2-roll-mode\"]:checked').val() as string || 'normal';\r\n        \r\n        if (diceCount <= 0) {\r\n          ui.notifications?.warn('Veuillez entrer un nombre de dés valide');\r\n          return;\r\n        }\r\n        \r\n        // Import dice roller functions\r\n        const DiceRoller = await import('./helpers/dice-roller.js');\r\n        const { getSuccessThreshold } = DiceRoller;\r\n        \r\n        // Use manual risk dice count, ensure it doesn't exceed total dice count\r\n        const finalRiskDiceCount = Math.min(riskDiceCount, diceCount);\r\n        const normalDiceCount = Math.max(0, diceCount - finalRiskDiceCount);\r\n        const finalRR = Math.min(3, Math.max(0, rr));\r\n        \r\n        // Roll dice\r\n        let normalRoll: any = null;\r\n        let riskRoll: any = null;\r\n        \r\n        if (normalDiceCount > 0) {\r\n          normalRoll = new Roll(`${normalDiceCount}d6`);\r\n          await normalRoll.evaluate();\r\n          \r\n          if ((game as any).dice3d && normalRoll) {\r\n            (game as any).dice3d.showForRoll(normalRoll, game.user, true, null, false);\r\n          }\r\n        }\r\n        \r\n        if (finalRiskDiceCount > 0) {\r\n          riskRoll = new Roll(`${finalRiskDiceCount}d6`);\r\n          await riskRoll.evaluate();\r\n          \r\n          if ((game as any).dice3d && riskRoll) {\r\n            const dice3dConfig = {\r\n              colorset: 'purple',\r\n              theme: 'default'\r\n            };\r\n            (game as any).dice3d.showForRoll(riskRoll, game.user, true, dice3dConfig, false);\r\n          }\r\n        }\r\n        \r\n        // Calculate results\r\n        const normalResults: number[] = normalRoll ? (normalRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n        const riskResults: number[] = riskRoll ? (riskRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n        \r\n        const successThreshold = getSuccessThreshold(rollMode);\r\n        \r\n        // Calculate successes for normal dice\r\n        let normalSuccesses = 0;\r\n        for (const result of normalResults) {\r\n          if (result >= successThreshold) {\r\n            normalSuccesses++;\r\n          }\r\n        }\r\n        \r\n        // Calculate successes and critical failures for risk dice\r\n        let riskSuccesses = 0;\r\n        let criticalFailures = 0;\r\n        for (const result of riskResults) {\r\n          if (result === 1) {\r\n            criticalFailures++;\r\n          } else if (result >= successThreshold) {\r\n            riskSuccesses++;\r\n          }\r\n        }\r\n        \r\n        // Risk dice successes count double\r\n        const totalRiskSuccesses = riskSuccesses * 2;\r\n        const totalSuccesses = normalSuccesses + totalRiskSuccesses;\r\n        \r\n        // Calculate complications\r\n        const remainingFailures = Math.max(0, criticalFailures - finalRR);\r\n        \r\n        let complication: 'none' | 'minor' | 'critical' | 'disaster' = 'none';\r\n        if (remainingFailures === 1) {\r\n          complication = 'minor';\r\n        } else if (remainingFailures === 2) {\r\n          complication = 'critical';\r\n        } else if (remainingFailures >= 3) {\r\n          complication = 'disaster';\r\n        }\r\n        \r\n        const rollResult = {\r\n          normalDice: normalResults,\r\n          riskDice: riskResults,\r\n          normalSuccesses: normalSuccesses,\r\n          riskSuccesses: riskSuccesses,\r\n          totalSuccesses: totalSuccesses,\r\n          criticalFailures: criticalFailures,\r\n          finalRR: finalRR,\r\n          remainingFailures: remainingFailures,\r\n          complication: complication\r\n        };\r\n        \r\n        // Get actor token if available\r\n        const actorTokens = canvas?.tokens?.controlled || [];\r\n        const actorToken = actorTokens.length > 0 ? actorTokens[0] : null;\r\n        \r\n        // Create roll data for template\r\n        const rollData: any = {\r\n          dicePool: diceCount,\r\n          riskDiceCount: finalRiskDiceCount,\r\n          rollMode: rollMode,\r\n          finalRR: finalRR,\r\n          actorId: actor.id,\r\n          actorUuid: actor.uuid,\r\n          actorName: actor.name\r\n        };\r\n        \r\n        // Prepare template data\r\n        const templateData: any = {\r\n          attacker: actor,\r\n          defender: null,\r\n          rollData: rollData,\r\n          rollResult: rollResult,\r\n          isAttack: false,\r\n          isDefend: false,\r\n          isCounterAttack: false,\r\n          skillName: 'Jet de dés',\r\n          itemName: null,\r\n          damageValue: null,\r\n          defenseResult: null,\r\n          attackerUuid: actor.uuid,\r\n          defenderUuid: null,\r\n          attackerTokenUuid: (actorToken as any)?.uuid || (actorToken as any)?.document?.uuid,\r\n          defenderTokenUuid: null\r\n        };\r\n        \r\n        // Render template\r\n        const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n        \r\n        // Create chat message\r\n        const messageData: any = {\r\n          user: game.user?.id,\r\n          speaker: {\r\n            actor: actor.id,\r\n            alias: actor.name\r\n          },\r\n          content: html,\r\n          type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n          flags: {\r\n            sra2: {\r\n              rollType: 'skill',\r\n              attackerId: actor.id,\r\n              attackerUuid: actor.uuid,\r\n              attackerTokenUuid: (actorToken as any)?.uuid || (actorToken as any)?.document?.uuid,\r\n              rollResult: rollResult,\r\n              rollData: rollData\r\n            }\r\n          }\r\n        };\r\n        \r\n        await ChatMessage.create(messageData);\r\n      });\r\n      \r\n      return true;\r\n    };\r\n    \r\n    // Register chat log hook to add roll dice button\r\n    // Using a more generic approach that works with Foundry's hook system\r\n    Hooks.on('renderChatLog' as any, (app: any, html: any, data: any) => {\r\n      // Use setTimeout to ensure the chat form is fully rendered\r\n      setTimeout(() => {\r\n        if (!addRollDiceButton()) {\r\n          // If button wasn't added, try again after a longer delay\r\n          setTimeout(addRollDiceButton, 500);\r\n        }\r\n      }, 100);\r\n    });\r\n    \r\n    // Also register for chat popout\r\n    Hooks.on('renderChatPopout' as any, (app: any, html: any, data: any) => {\r\n      setTimeout(() => {\r\n        if (!addRollDiceButton()) {\r\n          setTimeout(addRollDiceButton, 500);\r\n        }\r\n      }, 100);\r\n    });\r\n    \r\n    // Use MutationObserver to watch for chat form appearance (more robust)\r\n    Hooks.once('ready', () => {\r\n      // Try immediately\r\n      addRollDiceButton();\r\n      \r\n      // Also set up a MutationObserver to watch for chat form\r\n      const observer = new MutationObserver(() => {\r\n        addRollDiceButton();\r\n      });\r\n      \r\n      // Observe the document body for changes\r\n      if (document.body) {\r\n        observer.observe(document.body, {\r\n          childList: true,\r\n          subtree: true\r\n        });\r\n      }\r\n    });\r\n    \r\n    Hooks.once(\"ready\", () => this.onReady());\r\n  }\r\n  \r\n  /**\r\n   * Show bookmarks/favorites dialog for quick actions\r\n   */\r\n  showBookmarksDialog(actor: any): void {\r\n    const bookmarkedSkills = actor.items.filter((i: any) => i.type === 'skill' && i.system.bookmarked);\r\n    const bookmarkedFeats = actor.items.filter((i: any) => i.type === 'feat' && i.system.bookmarked);\r\n    \r\n    let content = '<div class=\"sra2-bookmark-menu\">';\r\n    \r\n    if (bookmarkedSkills.length > 0) {\r\n      content += '<h3>' + game.i18n!.localize('SRA2.SKILLS.LABEL') + '</h3>';\r\n      content += '<div class=\"bookmark-list\">';\r\n      bookmarkedSkills.forEach((skill: any) => {\r\n        content += `<button class=\"bookmark-item\" data-item-id=\"${skill.id}\" data-item-type=\"skill\">\r\n          <i class=\"fas fa-dice-d6\"></i> ${skill.name}\r\n        </button>`;\r\n      });\r\n      content += '</div>';\r\n    }\r\n    \r\n    if (bookmarkedFeats.length > 0) {\r\n      content += '<h3>' + game.i18n!.localize('SRA2.FEATS.LABEL') + '</h3>';\r\n      content += '<div class=\"bookmark-list\">';\r\n      bookmarkedFeats.forEach((feat: any) => {\r\n        content += `<button class=\"bookmark-item\" data-item-id=\"${feat.id}\" data-item-type=\"feat\">\r\n          <i class=\"fas fa-scroll\"></i> ${feat.name}\r\n        </button>`;\r\n      });\r\n      content += '</div>';\r\n    }\r\n    \r\n    content += '</div>';\r\n    \r\n    new Dialog({\r\n      title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE') + ' - ' + actor.name,\r\n      content,\r\n      buttons: {\r\n        close: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: game.i18n!.localize('Close')\r\n        }\r\n      },\r\n      render: (html: any) => {\r\n        html.find('.bookmark-item').on('click', async (event: any) => {\r\n          const itemId = $(event.currentTarget).data('item-id');\r\n          const item = actor.items.get(itemId);\r\n          if (!item) return;\r\n          \r\n          // Open item sheet\r\n          item.sheet?.render(true);\r\n        });\r\n      }\r\n    }, { width: 350 }).render(true);\r\n  }\r\n\r\n  /**\r\n   * Register the UI theme setting\r\n   */\r\n  registerThemeSetting(): void {\r\n    game.settings.register(SYSTEM.id, 'uiTheme', {\r\n      name: 'SRA2.SETTINGS.THEME.TITLE',\r\n      hint: 'SRA2.SETTINGS.THEME.DESC',\r\n      scope: 'client',\r\n      config: true,\r\n      type: String,\r\n      choices: () => {\r\n        return {\r\n          'sra2': game.i18n.localize('SRA2.SETTINGS.THEME.SRA2'),\r\n        };\r\n      },\r\n      default: 'sra2',\r\n      onChange: (value: string) => {\r\n        this.applyTheme(value);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Apply the selected theme to the body element\r\n   */\r\n  applyTheme(theme?: string): void {\r\n    if (!document.body) {\r\n      console.warn(SYSTEM.LOG.HEAD + 'Cannot apply theme: document.body is not available');\r\n      return;\r\n    }\r\n\r\n    // Get theme from setting if not provided\r\n    if (!theme) {\r\n      theme = game.settings.get(SYSTEM.id, 'uiTheme') as string || 'sra2';\r\n    }\r\n\r\n    // List of all possible theme classes\r\n    const themeClasses = ['sr-theme-sra2', 'sr-theme-sr6', 'sr-theme-sr5'];\r\n\r\n    // Remove all theme classes\r\n    document.body.classList.remove(...themeClasses);\r\n\r\n    // Add the selected theme class\r\n    const themeClass = `sr-theme-${theme}`;\r\n    document.body.classList.add(themeClass);\r\n\r\n    console.log(SYSTEM.LOG.HEAD + `Applied theme: ${themeClass}`);\r\n  }\r\n\r\n  async onReady(): Promise<void> {\r\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onReady');\r\n    \r\n    // Apply theme from setting\r\n    this.applyTheme();\r\n    \r\n    // Run migrations\r\n    const migrations = new Migrations();\r\n    migrations.migrate();\r\n    \r\n    // Migrate old feat data to new array format (deprecated, keeping for older versions)\r\n    await this.migrateFeatsToArrayFormat();\r\n    \r\n    // Migrate anarchyNimbus to anarchySpent\r\n    await this.migrateAnarchyNimbusToSpent();\r\n  }\r\n  \r\n  /**\r\n   * Migrate old feat data (single rrType/rrValue/rrTarget) to new array format\r\n   */\r\n  async migrateFeatsToArrayFormat(): Promise<void> {\r\n    const featsToUpdate: any[] = [];\r\n    \r\n    // Check all feats in the world\r\n    for (const item of game.items! as any) {\r\n      if ((item as any).type === 'feat') {\r\n        const system = (item as any).system as any;\r\n        let needsUpdate = false;\r\n        const updates: any = { _id: (item as any).id };\r\n        \r\n        // Check if rrType is not an array (old format)\r\n        if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\r\n          needsUpdate = true;\r\n          // Convert single value to array (only if not \"none\")\r\n          if (system.rrType !== 'none') {\r\n            updates['system.rrType'] = [system.rrType];\r\n            updates['system.rrValue'] = [system.rrValue || 0];\r\n            updates['system.rrTarget'] = [system.rrTarget || ''];\r\n          } else {\r\n            updates['system.rrType'] = [];\r\n            updates['system.rrValue'] = [];\r\n            updates['system.rrTarget'] = [];\r\n          }\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          featsToUpdate.push(updates);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Check all feats on actors\r\n    for (const actor of game.actors! as any) {\r\n      const actorUpdates: any[] = [];\r\n      \r\n      for (const item of (actor as any).items) {\r\n        if ((item as any).type === 'feat') {\r\n          const system = (item as any).system as any;\r\n          let needsUpdate = false;\r\n          const updates: any = { _id: (item as any).id };\r\n          \r\n          // Check if rrType is not an array (old format)\r\n          if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\r\n            needsUpdate = true;\r\n            // Convert single value to array (only if not \"none\")\r\n            if (system.rrType !== 'none') {\r\n              updates['system.rrType'] = [system.rrType];\r\n              updates['system.rrValue'] = [system.rrValue || 0];\r\n              updates['system.rrTarget'] = [system.rrTarget || ''];\r\n            } else {\r\n              updates['system.rrType'] = [];\r\n              updates['system.rrValue'] = [];\r\n              updates['system.rrTarget'] = [];\r\n            }\r\n          }\r\n          \r\n          if (needsUpdate) {\r\n            actorUpdates.push(updates);\r\n          }\r\n        }\r\n      }\r\n      \r\n      if (actorUpdates.length > 0) {\r\n        console.log(`${SYSTEM.LOG.HEAD} Migrating ${actorUpdates.length} feats on actor ${(actor as any).name}`);\r\n        await (actor as any).updateEmbeddedDocuments('Item', actorUpdates);\r\n      }\r\n    }\r\n    \r\n    if (featsToUpdate.length > 0) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Migrating ${featsToUpdate.length} world feats`);\r\n      await Item.updateDocuments(featsToUpdate);\r\n    }\r\n    \r\n    if (featsToUpdate.length > 0 || (game.actors! as any).some((a: any) => a.items.some((i: any) => i.type === 'feat'))) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Feat migration to array format complete`);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Migrate anarchyNimbus to anarchySpent\r\n   */\r\n  async migrateAnarchyNimbusToSpent(): Promise<void> {\r\n    const actorsToUpdate: any[] = [];\r\n    \r\n    // Check all character actors in the world\r\n    for (const actor of game.actors! as any) {\r\n      if ((actor as any).type === 'character') {\r\n        const system = (actor as any).system as any;\r\n        \r\n        // Check if the old anarchyNimbus field exists\r\n        if (system.anarchyNimbus !== undefined && system.anarchySpent === undefined) {\r\n          actorsToUpdate.push({\r\n            _id: (actor as any).id,\r\n            'system.anarchySpent': system.anarchyNimbus\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (actorsToUpdate.length > 0) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Migrating anarchyNimbus to anarchySpent for ${actorsToUpdate.length} actors`);\r\n      await Actor.updateDocuments(actorsToUpdate);\r\n      console.log(`${SYSTEM.LOG.HEAD} anarchyNimbus to anarchySpent migration complete`);\r\n    }\r\n  }\r\n}\r\n\r\n","import { SYSTEM } from './system.ts';\r\n\r\n/**\r\n * Configure sidebar icons for Foundry VTT UI\r\n */\r\nexport function setSidebarIcons(): void {\r\n  CONFIG.Actor.sidebarIcon = 'fas fa-user';\r\n  CONFIG.Adventure.sidebarIcon = 'fas fa-tree';\r\n  CONFIG.Cards.sidebarIcon = 'fa-solid fa-cards';\r\n  CONFIG.ChatMessage.sidebarIcon = 'fas fa-comments';\r\n  CONFIG.Combat.sidebarIcon = 'fas fa-gun';\r\n  CONFIG.Folder.sidebarIcon = 'fas fa-folder';\r\n  CONFIG.Item.sidebarIcon = 'fas fa-suitcase';\r\n  CONFIG.JournalEntry.sidebarIcon = 'fas fa-book-open';\r\n  CONFIG.JournalEntryPage.sidebarIcon = 'fas fa-book-open';\r\n  CONFIG.Macro.sidebarIcon = 'fas fa-code';\r\n  CONFIG.Playlist.sidebarIcon = 'fas fa-music';\r\n  CONFIG.PlaylistSound.sidebarIcon = 'fas fa-music';\r\n  CONFIG.RollTable.sidebarIcon = 'fas fa-th-list';\r\n  CONFIG.Scene.sidebarIcon = 'fas fa-map';\r\n\r\n  console.log(SYSTEM.LOG.HEAD + 'Configured sidebar icons');\r\n}\r\n\r\n/**\r\n * Configure control icons for Foundry VTT tokens\r\n */\r\nexport function setControlIcons(): void {\r\n  CONFIG.controlIcons = {\r\n    combat: 'icons/svg/combat.svg',\r\n    visibility: 'icons/svg/cowled.svg',\r\n    effects: 'icons/svg/aura.svg',\r\n    lock: 'icons/svg/padlock.svg',\r\n    up: 'icons/svg/up.svg',\r\n    down: 'icons/svg/down.svg',\r\n    defeated: 'icons/svg/skull.svg',\r\n    light: 'icons/svg/light.svg',\r\n    lightOff: 'icons/svg/light-off.svg',\r\n    template: 'icons/svg/explosion.svg',\r\n    sound: 'icons/svg/sound-off.svg',\r\n    soundOff: 'icons/svg/combat.svg',\r\n    doorClosed: 'icons/svg/door-closed-outline.svg',\r\n    doorOpen: 'icons/svg/door-open-outline.svg',\r\n    doorSecret: 'icons/svg/door-secret-outline.svg',\r\n    doorLocked: 'icons/svg/door-locked-outline.svg'\r\n  };\r\n\r\n  console.log(SYSTEM.LOG.HEAD + 'Configured control icons');\r\n}\r\n\r\n/**\r\n * Configure compendium banners\r\n */\r\nexport function setCompendiumBanners(): void {\r\n  // Note: If you have a banner image, uncomment and adjust the path\r\n  // CONFIG.Actor.compendiumBanner = `${SYSTEM.PATH.ROOT}/img/interface/sra2/banner-actors.webp`;\r\n  \r\n  console.log(SYSTEM.LOG.HEAD + 'Configured compendium banners');\r\n}\r\n\r\n","import { SRA2System } from \"./module/sra2-system.ts\";\r\n\r\nSRA2System.start();\r\n\r\nimport \"./styles/global.scss\";\r\nimport \"./less/index.less\";\r\n\r\n"],"names":["SYSTEM_ID","SYSTEM","id","LOG","HEAD","SOCKET","PATH","ROOT","STYLE","TEMPLATES","ASSETS","CharacterDataModel","foundry","abstract","TypeDataModel","defineSchema","fields","data","attributes","SchemaField","strength","NumberField","required","initial","min","integer","agility","willpower","logic","charisma","resources","yens","anarchy","maxEssence","armorLevel","max","damage","light","ArrayField","BooleanField","severe","incapacitating","anarchySpent","bio","background","HTMLField","notes","keywords","keyword1","StringField","keyword2","keyword3","keyword4","keyword5","behaviors","behavior1","behavior2","behavior3","behavior4","catchphrases","catchphrase1","catchphrase2","catchphrase3","catchphrase4","linkedVehicles","label","reference","calculateAttributeCost","level","maxLevel","cost","i","prepareDerivedData","parent","this","attributeMaxes","anarchyBonus","items","metatype","find","item","type","system","maxStrength","maxAgility","maxWillpower","maxLogic","maxCharisma","bonusLightDamage","bonusSevereDamage","bonusPhysicalThreshold","bonusMentalThreshold","bonusAnarchy","totalEssenceCost","totalNarrations","narrationsDetails","filter","active","forEach","feat","essenceCost","grantsNarration","push","name","actions","narrationActions","totalAnarchy","featsAnarchyBonus","bonusNarrations","totalLightBoxes","totalSevereBoxes","sourceDamage","_source","Array","isArray","length","pop","totalArmorLevel","featType","armorValue","reduce","sum","Math","armorCost","firewall","activeCyberdeck","damageThresholds","withoutArmor","withArmor","mental","matrix","currentEssence","attributeCosts","totalCost","Object","values","calculatedCost","console","log","vehicleUuid","vehicleActor","utils","fromUuidSync","e","game","actors","actor","uuid","uuidParts","split","actorId","get","vehicleCost","error","warn","WEAPON_TYPES","vd","melee","short","medium","long","linkedSkill","linkedSpecialization","linkedDefenseSkill","linkedDefenseSpecialization","tasers","throwing","grenades","bows","crossbows","smgs","shotguns","VEHICLE_TYPES","FeatDataModel","description","bookmarked","rating","choices","equipment","rrList","rrType","attribute","skill","specialization","rrValue","rrTarget","nullable","characterArmorLevel","isBioware","trait","contact","awakened","armor","cyberware","cyberdeck","vehicle","weapon","spell","connaissance","power","weaponType","vehicleType","damageValue","damageValueBonus","meleeRange","none","ok","dice","disadvantage","shortRange","mediumRange","longRange","rangeImprovements","autopilot","structure","handling","speed","flyingSpeed","weaponMount","weaponInfo","autopilotBonus","speedBonus","handlingBonus","armorBonus","isFixed","isFlying","weaponMountImprovement","autopilotUnlocked","additionalDroneCount","vehicleActorUuid","attack","cyberdeckDamage","cyberdeckBonusLightDamage","contactName","astralPerception","astralProjection","sorcery","conjuration","adept","riggerConsoleCount","hasVehicleControlWiring","isWeaponFocus","isAdeptPowerWeapon","narrativeEffects","text","isNegative","value","sustainedSpellCount","summonedSpiritCount","isFirstFeat","shamanicMask","spellType","direct","indirect","weaponDamageBonus","weaponTypeBonus","keys","key","spellSpecializationType","combat","detection","health","illusion","manipulation","counterspell","linkedAttackSkill","linkedAttackSpecialization","costType","spellSpecType","spellSpecMap","recommendedLevel","recommendedLevelBreakdown","labelKey","labelParams","abs","rangeImprovementCount","rr","positiveEffects","effect","trim","negativeEffects","positiveEffectValue","negativeEffectValue","VehicleDataModel","vehicleTypeChoices","vehicleStats","baseAutopilot","baseStructure","baseHandling","baseSpeed","baseFlyingSpeed","baseArmor","baseWeaponMount","finalAutopilot","finalHandling","finalSpeed","finalFlyingSpeed","finalArmor","finalWeaponMount","baseAttributes","narrativeEffectsCost","weaponCost","ICE_TYPES","patrol","acid","blaster","blocker","black","glue","tracker","killer","IceDataModel","iceTypeChoices","entries","iceType","serverIndex","threshold","ceil","SkillDataModel","linkedAttribute","SpecializationDataModel","MetatypeDataModel","SRA2Actor","Actor","feats","normalizeSearchText","toLowerCase","normalize","replace","itemMatchesSearch","itemType","searchTerm","includePackName","packTitle","normalizedSearch","includes","searchItemsInWorld","existingItemsCheck","results","alreadyExists","source","i18n","localize","searchItemsOnActor","async","searchItemsInCompendiums","seenNames","Set","pack","packs","documentName","documents","getDocuments","doc","title","has","add","searchItemsEverywhere","result","buildSingleResultHtml","typeLabel","isExactMatch","html","itemExistsOnActor","itemName","some","itemUuid","fromUuid","ui","notifications","format","createEmbeddedDocuments","toObject","info","options","lastSearchTerm","noResultsMessage","normalizedLastSearch","exactMatch","r","otherResults","searchFunction","delay","timeoutId","clearTimeout","setTimeout","resultsDiv","show","style","display","RISK_DICE_BY_RR","getRiskDiceByRR","handleRollRequest","skillName","specName","itemId","actorUuid","actorName","specLevel","skillLevel","itemRating","itemActive","Promise","then","module","RollDialog","render","attacker","defender","attackerToken","defenderToken","rollData","document","attackerTokenUuid","defenderTokenUuid","dicePool","riskDiceCount","normalDiceCount","rollMode","finalRR","rollResult","normalDice","riskDice","normalSuccesses","riskSuccesses","totalSuccesses","criticalFailures","remainingFailures","complication","normalRoll","riskRoll","Roll","evaluate","dice3d","showForRoll","user","dice3dConfig","colorset","theme","normalResults","map","riskResults","isAttack","finalAttackerUuid","finalDefenderUuid","defenderData","tokenImg","img","texture","src","defenseResult","calculatedDamage","attackFailed","isDefend","attackRollResult","attackRollData","attackSuccesses","defenseSuccesses","isIceAttack","originalAttackerName","defenderName","iceDamageValue","damageValueStr","startsWith","attackerStrength","parseInt","substring","originalAttackerUuid","defenderUuid","isCounterAttack","originalDefenderName","counterAttackSuccesses","attackDamageValue","attackDamageValueStr","counterAttackDamageValue","actorStrength","selectedWeaponId","weaponSystem","baseDamageValue","weaponDamageValueStr","toString","attackerDamage","defenderDamage","isTie","winner","originalDefenderUuid","damageInflicterUuid","damageReceiverUuid","damageInflicterName","damageReceiverName","attackerWithUuid","defenderWithUuid","templateData","attackerUuid","isSpellDirect","renderTemplate","messageData","speaker","alias","content","CONST","CHAT_MESSAGE_TYPES","OTHER","flags","sra2","rollType","attackerId","defenderId","ChatMessage","create","isSpell","normalizedSkillName","ItemSearch.normalizeSearchText","specItem","isConjuration","actorSystem","message","lightWounds","woundApplied","update","severeWounds","severeApplied","handleDrain","createRollChatMessage","mode","handleSheetUpdate","formData","expandedData","expandObject","currentDamage","convertToArray","obj","expectedLength","arr","fill","currentLightLength","currentSevereLength","calculateFinalDamageValue","total","modifier","base","organizeSpecializationsBySkill","allSpecializations","actorItems","specializationsBySkill","Map","unlinkedSpecializations","spec","linkedSkillName","skillId","set","bySkill","unlinked","handleItemDrop","event","allowedTypes","TextEditor","getDragEventData","Item","implementation","fromDropData","handleVehicleActorDrop","updatedLinkedVehicles","prototypeToken","updateData","mergeObject","PrototypeToken","defaults","actorLink","getRRSources","sources","normalizedItemName","rrEntry","normalizedRRTarget","featName","calculateRR","handleEditItem","preventDefault","element","currentTarget","dataset","closest","getAttribute","sheet","handleDeleteItem","sheetRender","delete","calculateRawDamageString","parseDamageCheckboxChange","inputName","checked","match","damageType","index","updatedDamage","handleSectionNavigation","formElement","button","section","form","HTMLElement","querySelectorAll","classList","remove","contentSection","targetSection","querySelector","restoreActiveSection","activeSection","navButton","getCurrentActiveSection","activeNavItem","enrichFeats","calculateFinalDamageValueFn","rrEntries","allRRList","ItemSearch","linkedAttackSpec","attackSpecName","attackSkillName","attackLinkedAttribute","foundSpec","specSystem","parentSkill","foundSkill","specRRSources","skillRRSources","attributeRRSources","entry","rrTargetLabel","toUpperCase","isWeapon","activeFeat","finalDamageValue","normalizeForComparison","findAttackSkillAndSpec","targetSpec","targetSkill","defaultAttribute","normalizedTargetSpec","_extractSpecAndSkillInfo","normalizedKeywords","kw","foundSpecByKeyword","normalizedName","normalizedKeyword","_trySpellSpecKeywordSearch","specInGameItems","specKeywords","specToUse","skillSystem","_searchGameItemsForSpellSpec","foundLinkedAttribute","skillRating","attributeValue","_searchGameItemsForSorcellerie","calculateAttackPool","skillSpecResult","itemRRList","totalDicePool","allRRSources","totalRR","findSkillByName","findSpecByName","findItemInGame","calculateSkillDicePool","linkedDefenseSpec","defaultSelection","linkedSpec","skills","specTemplate","itemSystem","numericValue","displayValue","rawDamageString","isStrengthBased","isToxin","totalModifier","prepareVehicleWeaponRollRequest","attackData","vehicleSystem","activeFeats","prepareVehicleWeaponAttack","weaponLinkedDefenseSkill","weaponLinkedDefenseSpecialization","weaponStats","finalDefenseSkill","finalDefenseSpec","applyDamage","defenderActor","defenderSystem","isVehicle","isIce","getDamageThresholds","woundType","overflow","applied","target","CharacterSheet","ActorSheet","_activeSection","defaultOptions","super","classes","template","width","height","tabs","dragDrop","dragSelector","dropSelector","submitOnChange","getData","context","stack","Error","slice","join","systemData","metatypes","metatypeAnarchyBonus","baseAnarchy","baseAnarchySpent","bonusAnarchySpent","allFeats","SheetHelpers.enrichFeats","SheetHelpers.calculateFinalDamageValue","linkedVehicleUuids","vehicleWeapons","vehicleItems","enrichedWeapon","_id","vehicleName","weaponId","crr","vehicleLevel","hasText","hasValue","vehicleDamage","hasSevereDamage","box","isIncapacitating","weapons","vehicleFeats","cyberdeckFeats","cyberdeckDamageThresholds","baseLightBoxes","currentLength","featsByType","adeptPower","weaponsSpells","weaponLinkedSkill","weaponLinkedSpecialization","finalAttackSkill","finalAttackSpec","SheetHelpers.findAttackSkillAndSpec","poolResult","SheetHelpers.calculateAttackPool","attackSpecLevel","spellSystem","powerSystem","powerRRList","bookmarkedItems","sort","a","b","localeCompare","SheetHelpers.organizeSpecializationsBySkill","contents","attributesRR","linkedAttributeLabel","skillRR","attributeRR","specs","specializations","parentRating","effectiveRating","parentSkillName","specLinkedAttribute","specRR","specAttributeRR","parentSkillRR","specAttributeValue","severeDamage","close","$","off","activateListeners","on","_onSwitchSheet","bind","_onSectionNavigation","_onEditMetatype","_onDeleteMetatype","_onEditFeat","_onDeleteFeat","_onOpenVehicle","_onUnlinkVehicle","_onEditSkill","_onDeleteSkill","_onEditSpecialization","_onDeleteSpecialization","_onRollAttribute","_onRollSkill","_onQuickRollSkill","_onRollSpecialization","_onQuickRollSpecialization","_onSendCatchphrase","_onToggleBookmark","_onBookmarkItemClick","_onDamageChange","_onAnarchyChange","_onCyberdeckDamageChange","_onRollWeapon","_onRollSpell","_onRollPower","_onRollWeaponSpell","_onRollVehicleWeaponFromSheet","_onRollVehicleWeaponAutopilot","_onRollVehicleAutopilot","_onRatingChange","_onSkillSearch","_onSkillSearchFocus","_onSkillSearchBlur","skillSearchContainer","contains","hide","_onFeatSearch","_onFeatSearchFocus","_onFeatSearchBlur","featSearchContainer","each","_index","setAttribute","addEventListener","_onDragStart","_updateObject","_event","SheetHelpers.handleSectionNavigation","SheetHelpers.handleEditItem","SheetHelpers.handleDeleteItem","SheetHelpers.getRRSources","SheetHelpers.calculateRR","newRating","isNaN","DiceRoller.handleRollRequest","attributeName","attributeLabel","rrSources","CombatHelpers.applyDamage","dragData","dataTransfer","setData","JSON","stringify","_onDrop","SheetHelpers.handleItemDrop","SheetHelpers.handleVehicleActorDrop","searchTimeout","input","siblings","_performSkillSearch","ItemSearch.searchItemsEverywhere","ItemSearch.itemExistsOnActor","_displaySkillSearchResults","formattedSearchTerm","word","charAt","exactMatchOnActor","disabledClass","buttonText","innerHTML","_onAddSkillFromSearch","_onCreateNewSkill","disabled","trigger","stopPropagation","textContent","resolve","blurEvent","relatedTarget","activeElement","formattedName","skillData","createdItems","newSkill","searchInput","featSearchTimeout","lastFeatSearchTerm","_performFeatSearch","searchResults","exists","_displayFeatSearchResults","featTypeLabel","_onAddFeatFromSearch","_onCreateNewFeat","catchphrase","getSpeaker","actorSource","SheetHelpers.parseDamageCheckboxChange","itemIdMatch","itemSource","stopImmediatePropagation","tagName","parentElement","hasAttribute","currentBookmarkState","fakeEvent","_onRollVehicleWeapon","CombatHelpers.prepareVehicleWeaponRollRequest","autopilotLabel","attackSkillSpecResult","attackSkillLevel","defenseSkillSpecResult","defenseSkillName","defenseSkillLevel","defenseSpecName","defenseSpecLevel","defenseLinkedAttribute","SheetHelpers.calculateRawDamageString","isVehicleWeapon","_rollWeaponOrSpell","_rollPower","isPower","_rollSkillWithWeapon","weaponName","_skillType","weaponDamageValue","_rollSpecializationWithWeapon","selector","featData","newFeat","CharacterSheetV2","characterSheetV2","isV2","newSheet","_onShowContextMenu","namespace","removeClass","_onToggleActive","menu","first","addClass","currentActive","VehicleSheet","fromEntries","SheetHelpers.handleSheetUpdate","vehicleTypes","vehicleStructure","calculateWeaponStats","itemData","Dialog","confirm","yes","no","defaultYes","_showItemBrowser","_onVehicleTypeChange","_onBonusChange","_onOptionChange","currentNarrativeEffects","textarea","textareaElement","nameMatch","valueInput","val","_inputIndex","effectIndex","splice","narrativeEffectSaveTimeout","saveNarrativeEffects","SheetHelpers.getCurrentActiveSection","_","checkbox","$checkbox","prop","toggleClass","SheetHelpers.restoreActiveSection","weaponsOnly","itemOptions","buttons","icon","callback","cancel","default","parse","err","IceSheet","iceTypes","iceTypeDescription","_getIceTypeDescription","_onIceTypeChange","_onServerIndexChange","_onIceAttack","controlledTokens","canvas","tokens","controlled","iceToken","isToken","token","placeables","iceActor","iceSystem","iceTokenUuid","finalIceUuid","iceThreshold","CombatHelpers.createIceAttackMessage","FeatSheet","ItemSheet","powerSearchTimeout","prepareData","_calculateFinalDamageValue","_calculateCyberdeckDamageThresholds","rrTargetName","rrTargetType","rrTargetNotFound","_onAddRREntry","_onRemoveRREntry","_onClearRRTarget","_onAddNarrativeEffect","_onRemoveNarrativeEffect","_onNarrativeEffectNegativeChange","_onWeaponTypeChange","_onDamageValueBonusChange","_onSustainedSpellChange","_onSummonedSpiritChange","_onRangeImprovementChange","_onAstralProjectionChange","_onRRTargetSearch","_onRRTargetSearchFocus","_onRRTargetSearchBlur","container","_onPowerSkillSearch","_onPowerSkillSearchFocus","_onPowerSkillSearchBlur","_onPowerSpecSearch","_onPowerSpecSearchFocus","_onPowerSpecSearchBlur","dropZone","rrIndex","currentSystem","bonusValue","currentBonus","newBonus","hiddenInput","cb","cbElement","cbValue","spellValue","currentCount","newCount","isChecked","rangeRow","select","rangeLabel","fieldName","currentValue","newValue","astralPerceptionInput","rrTargetSearchTimeout","_performRRTargetSearch","_displayRRTargetSearchResults","_onSelectRRTarget","targetName","field","_performPowerSkillSearch","_displayPowerSkillSearchResults","_onSelectPowerSkill","mouseEvent","originalEvent","_performPowerSpecSearch","_displayPowerSpecSearchResults","_onSelectPowerSpec","otherFirstFeats","otherFeat","SkillSheet","SpecializationSheet","linkedSkillNotFound","s","_onClearLinkedSkill","skillSearchTimeout","lastSkillSearchTerm","isWorldItem","_onLinkSkillFromSearch","MetatypeSheet","Application","targetToken","rrEnabled","riskDiceManuallySet","lastAutoRR","selectedRange","manualRRBonus","constructor","targets","from","defenderTokenFromUuid","foundToken","availableWeapons","autoSelectWeaponForCounterAttack","bestWeapon","highestDamage","bonus","selectWeaponForCounterAttack","selectCombatRapprocheSkill","selectedWeapon","w","actualWeapon","wepTypeName","wepTypeData","baseSkillName","linkedSkillItem","linkedSpecs","preferredSpecName","skillSpecRRList","combatRapprocheSkill","resizable","minimizable","distance","distanceText","grid","protagonistToken","distancePixels","measureDistance","x","y","gridSpaces","round","scene","units","dx","dy","gridDistance","sqrt","size","calculatedRange","isWeaponRoll","selectedRangeValue","hasSevereWound","wound","isSkillSpecAttributeRoll","rangeOptions","calculatedDicePool","hasThreshold","skillDisplayName","SheetHelpers","defenseRRList","attributeRRList","rrSource","rrId","isEnabled","enabled","autoRiskDiceCount","DiceRoller.getRiskDiceByRR","maxRiskDice","riskProbabilities","allGood","glitch","criticalGlitch","disaster","clampedRiskDice","clampedRR","probabilitiesData","shadowAmpProbabilities","condition","conditions","c","diceData","d","getRiskProbabilities","riskColorClass","riskLevelTextKey","riskLevelText","toFixed","allGoodColorClass","glitchColorClass","criticalGlitchColorClass","disasterColorClass","diceColor","riskClass","getDiceColorFromRiskClass","diceList","isRiskDice","riskColor","dropdownOptions","skillSelected","isSelected","specSelected","skillsWithSpecs","selectedSpec","opt","selectedValue","selectedSkill","normalizedLinkedSpec","normalizedLinkedSkill","attributeOptions","attributeNames","attributeLabels","attrName","attrValue","diceValue","selectedAttribute","hasSkillRating","parentSkillItem","skillItem","updateRRForSkill","updateRRForSpec","clear","newTotalRR","sourceId","rangeValue","rangeValueForSelected","modeValue","inputValue","Number","diceIcon","diceIndex","isCurrentlySelected","hasClass","finalRRList","updatedRollData","executeRoll","diceRoller","HOOKS","CURRENT_SYSTEM_VERSION","Migration","code","version","migrate","applyItemsUpdates","computeUpdates","actorItemUpdates","updateEmbeddedDocuments","itemUpdates","updateDocuments","Migrations","settings","register","scope","config","String","currentVersion","isNewerVersion","migrations","Hooks","callAll","list","concat","m","targetVersion","$notify","Migration_13_0_3","totalMigrated","totalSkipped","updates","sourceSystem","hasOldFormat","maxLength","summaryMessage","userMessage","permanent","Migration_13_0_4","totalCleaned","hasOldFields","hasBackups","_rrTypeBackup","_rrValueBackup","_rrTargetBackup","Migration_13_0_5","totalConverted","Migration_13_0_6","Migration_13_0_7","conversionDetails","itemInfo","oldType","newType","hasWeaponFocus","hasDamageValue","hasRanges","Date","toISOString","withWeaponFocus","withDamage","withRanges","detail","count","Migration_13_0_8","totalFixed","needsUpdate","firstEffect","convertedEffects","effectCount","isInteger","totalEffects","fixed","Migration_13_0_9","totalUpdated","totalFirstFeatAdded","updateDetails","updatedEffects","hasFirstFeat","existingDetail","totalWithFirstFeat","firstFeatCount","Migration_13_0_10","featItems","_costMigrationVersion","currentCost","newCost","reason","oldCost","specializedToAdvanced","featToFree","specializedCount","featCount","Migration_13_0_11","_specializationLinkMigrationVersion","hasAttackSpec","hasOwnProperty","hasDefenseSpec","Migration_13_0_12","_rangeDiceToDisadvantageMigrationVersion","globalThis","SRA2System","start","once","onInit","api","applications","models","registerThemeSetting","CONFIG","sidebarIcon","Adventure","Cards","Combat","Folder","JournalEntry","JournalEntryPage","Macro","Playlist","PlaylistSound","RollTable","Scene","controlIcons","visibility","effects","lock","up","down","defeated","lightOff","sound","soundOff","doorClosed","doorOpen","doorSecret","doorLocked","declareMigration","documentClass","documents.SRA2Actor","dataModels","character","models.CharacterDataModel","models.VehicleDataModel","ice","models.IceDataModel","models.SkillDataModel","models.FeatDataModel","models.SpecializationDataModel","models.MetatypeDataModel","DocumentSheetConfig","registerSheet","applications.CharacterSheet","types","makeDefault","applications.CharacterSheetV2","applications.VehicleSheet","applications.IceSheet","characterActors","charActor","debug","userId","char","characterCount","characters","rendered","skillKey","skillsBeingCreated","SheetHelpers.findSkillByName","skillTemplate","SheetHelpers.findItemInGame","applications.FeatSheet","applications.SkillSheet","applications.SpecializationSheet","applications.MetatypeSheet","Handlebars","registerHelper","args","str","targetUuid","messageFlags","selectedTargets","defenderFromUuid","defenderFromId","success","attackerName","defenseSkill","defenseSpec","attackSkill","attackSpec","isVehicleDefender","defenderTokenForRoll","defenderActorForRoll","defenderTokenUuidFromFlags","isMeleeAttack","specRating","originalAttackerTokenUuid","defenseRollData","rollDialog","dialog","characterToken","defenderTokenUuidForCounter","allWeapons","isFeat","itemFeat","defenderWeapons","hasMeleeInSystem","hasMeleeInType","combatRapprocheSpecs","meleeInType","counterAttackerTokenUuid","counterAttackRollData","_hud","unshift","onclick","showBookmarksDialog","addRollDiceButton","chatForm","rollDiceContainer","prepend","ownedActors","isOwner","diceCount","DiceRoller","getSuccessThreshold","finalRiskDiceCount","successThreshold","actorTokens","actorToken","app","observer","MutationObserver","body","observe","childList","subtree","onReady","bookmarkedSkills","bookmarkedFeats","hint","onChange","applyTheme","themeClass","migrateFeatsToArrayFormat","migrateAnarchyNimbusToSpent","featsToUpdate","actorUpdates","actorsToUpdate","anarchyNimbus"],"mappings":"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"}