{"version":3,"file":"index.mjs","sources":["../src/module/config/system.ts","../src/module/models/actor-character.ts","../src/module/models/item-feat.ts","../src/module/models/actor-vehicle.ts","../src/module/models/actor-ice.ts","../src/module/models/item-skill.ts","../src/module/models/item-specialization.ts","../src/module/models/item-metatype.ts","../src/module/documents/actor.ts","../item-search.ts","../src/module/helpers/dice-roller.ts","../src/module/helpers/sheet-helpers.ts","../src/module/helpers/combat-helpers.ts","../src/module/applications/character-sheet.ts","../src/module/applications/character-sheet-v2.ts","../src/module/applications/vehicle-sheet.ts","../src/module/applications/ice-sheet.ts","../src/module/applications/feat-sheet.ts","../src/module/applications/skill-sheet.ts","../src/module/applications/specialization-sheet.ts","../src/module/applications/metatype-sheet.ts","../src/module/applications/roll-dialog.ts","../src/module/hooks.mjs","../src/module/migration/migration.mjs","../src/module/migration/migration-13.0.3.mjs","../src/module/migration/migration-13.0.4.mjs","../src/module/migration/migration-13.0.5.mjs","../src/module/migration/migration-13.0.6.mjs","../src/module/migration/migration-13.0.7.mjs","../src/module/migration/migration-13.0.8.mjs","../src/module/migration/migration-13.0.9.mjs","../src/module/migration/migration-13.0.10.mjs","../src/module/migration/migration-13.0.11.mjs","../src/module/migration/migration-13.0.12.mjs","../src/module/sra2-system.ts","../src/module/config/ui-config.ts","../src/start.ts"],"sourcesContent":["const SYSTEM_ID = 'sra2';\r\n\r\nexport interface SystemConfig {\r\n  id: string;\r\n  LOG: {\r\n    HEAD: string;\r\n  };\r\n  SOCKET: string;\r\n  PATH: {\r\n    ROOT: string;\r\n    STYLE: string;\r\n    TEMPLATES: string;\r\n    ASSETS: string;\r\n  };\r\n}\r\n\r\nexport const SYSTEM: SystemConfig = {\r\n  id: SYSTEM_ID,\r\n  LOG: {\r\n    HEAD: `${SYSTEM_ID} | `\r\n  },\r\n  SOCKET: `system.${SYSTEM_ID}`,\r\n  PATH: {\r\n    ROOT: `systems/${SYSTEM_ID}`,\r\n    STYLE: `systems/${SYSTEM_ID}/style`,\r\n    TEMPLATES: `systems/${SYSTEM_ID}/templates`,\r\n    ASSETS: `systems/${SYSTEM_ID}/assets`,\r\n  }\r\n};\r\n\r\n","/**\r\n * Data model for Character actors\r\n */\r\nexport class CharacterDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      attributes: new fields.SchemaField({\r\n        strength: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        agility: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        willpower: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        logic: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        }),\r\n        charisma: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 1,\r\n          integer: true\r\n        })\r\n      }),\r\n      resources: new fields.SchemaField({\r\n        yens: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: 0,\r\n          integer: true\r\n        }),\r\n        anarchy: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: 0,\r\n          integer: true\r\n        })\r\n      }),\r\n      maxEssence: new fields.NumberField({\r\n        required: true,\r\n        initial: 6,\r\n        min: 0\r\n      }),\r\n      armorLevel: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 5,\r\n        integer: true\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }),\r\n      anarchySpent: new fields.ArrayField(new fields.BooleanField({\r\n        required: true,\r\n        initial: false\r\n      }), {\r\n        required: true,\r\n        initial: [false, false, false]\r\n      }),\r\n      bio: new fields.SchemaField({\r\n        background: new fields.HTMLField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        notes: new fields.HTMLField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      keywords: new fields.SchemaField({\r\n        keyword1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        keyword5: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      behaviors: new fields.SchemaField({\r\n        behavior1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        behavior4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      catchphrases: new fields.SchemaField({\r\n        catchphrase1: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase2: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase3: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        }),\r\n        catchphrase4: new fields.StringField({\r\n          required: true,\r\n          initial: \"\"\r\n        })\r\n      }),\r\n      // Linked vehicle actors (UUIDs)\r\n      linkedVehicles: new fields.ArrayField(new fields.StringField({\r\n        required: true,\r\n        initial: \"\"\r\n      }), {\r\n        required: true,\r\n        initial: [],\r\n        label: \"SRA2.CHARACTER.LINKED_VEHICLES\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Calculate the cost of an attribute based on its level\r\n   * Each level costs 10000, except the last level (maximum) which costs 20000\r\n   */\r\n  private calculateAttributeCost(level: number, maxLevel: number): number {\r\n    let cost = 0;\r\n    for (let i = 1; i <= level; i++) {\r\n      if (i === maxLevel) {\r\n        cost += 20000;\r\n      } else {\r\n        cost += 10000;\r\n      }\r\n    }\r\n    return cost;\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Get metatype to determine attribute maximums and anarchy bonus\r\n    const parent = (this as any).parent;\r\n    let attributeMaxes = {\r\n      strength: 99,\r\n      agility: 99,\r\n      willpower: 99,\r\n      logic: 99,\r\n      charisma: 99\r\n    };\r\n    let anarchyBonus = 0;\r\n    \r\n    if (parent && parent.items) {\r\n      const metatype = parent.items.find((item: any) => item.type === 'metatype');\r\n      if (metatype && metatype.system) {\r\n        attributeMaxes = {\r\n          strength: metatype.system.maxStrength || 99,\r\n          agility: metatype.system.maxAgility || 99,\r\n          willpower: metatype.system.maxWillpower || 99,\r\n          logic: metatype.system.maxLogic || 99,\r\n          charisma: metatype.system.maxCharisma || 99\r\n        };\r\n        anarchyBonus = metatype.system.anarchyBonus || 0;\r\n      }\r\n    }\r\n    \r\n    (this as any).attributeMaxes = attributeMaxes;\r\n    \r\n    // Calculate damage boxes, thresholds bonuses, essence cost, anarchy bonus, and narrations from active feats\r\n    let bonusLightDamage = 0;\r\n    let bonusSevereDamage = 0;\r\n    let bonusPhysicalThreshold = 0;\r\n    let bonusMentalThreshold = 0;\r\n    let bonusAnarchy = 0;\r\n    let totalEssenceCost = 0;\r\n    let totalNarrations = 0;\r\n    const narrationsDetails: Array<{ name: string; actions: number }> = [];\r\n    \r\n    if (parent && parent.items) {\r\n      const activeFeats = parent.items.filter((item: any) => \r\n        item.type === 'feat' && item.system.active === true\r\n      );\r\n      \r\n      activeFeats.forEach((feat: any) => {\r\n        bonusLightDamage += feat.system.bonusLightDamage || 0;\r\n        bonusSevereDamage += feat.system.bonusSevereDamage || 0;\r\n        bonusPhysicalThreshold += feat.system.bonusPhysicalThreshold || 0;\r\n        bonusMentalThreshold += feat.system.bonusMentalThreshold || 0;\r\n        bonusAnarchy += feat.system.bonusAnarchy || 0;\r\n        totalEssenceCost += feat.system.essenceCost || 0;\r\n        \r\n        // Count narrations\r\n        if (feat.system.grantsNarration) {\r\n          totalNarrations++;\r\n          narrationsDetails.push({\r\n            name: feat.name,\r\n            actions: feat.system.narrationActions || 1\r\n          });\r\n        }\r\n      });\r\n    }\r\n    \r\n    // Calculate total anarchy (base 3 + metatype bonus + feats bonus)\r\n    (this as any).totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\r\n    (this as any).anarchyBonus = anarchyBonus;\r\n    (this as any).featsAnarchyBonus = bonusAnarchy;\r\n    \r\n    // Store narrations information (base 1 + feats bonus)\r\n    (this as any).totalNarrations = 1 + totalNarrations;\r\n    (this as any).bonusNarrations = totalNarrations;\r\n    (this as any).narrationsDetails = narrationsDetails;\r\n    \r\n    // Base: 2 light, 1 severe, 1 incapacitating\r\n    const totalLightBoxes = 2 + bonusLightDamage;\r\n    const totalSevereBoxes = 1 + bonusSevereDamage;\r\n    \r\n    // Ensure damage arrays match the required size (preserve existing values)\r\n    // CRITICAL: Read from source data first to preserve persisted values\r\n    // In Foundry v13, when prepareDerivedData() is called, (this as any).damage\r\n    // should already contain the persisted values from _source, but we need to\r\n    // ensure we're working with a copy to avoid mutating the source\r\n    const sourceDamage = parent?._source?.system?.damage || (this as any).damage || {};\r\n    \r\n    // Create a copy from source to preserve persisted values\r\n    const damage: any = {\r\n      light: Array.isArray(sourceDamage.light) ? [...sourceDamage.light] : [false, false],\r\n      severe: Array.isArray(sourceDamage.severe) ? [...sourceDamage.severe] : [false],\r\n      incapacitating: typeof sourceDamage.incapacitating === 'boolean' ? sourceDamage.incapacitating : false\r\n    };\r\n    \r\n    // Adjust light damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.light.length < totalLightBoxes) {\r\n      damage.light.push(false);\r\n    }\r\n    while (damage.light.length > totalLightBoxes) {\r\n      damage.light.pop();\r\n    }\r\n    \r\n    // Adjust severe damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.severe.length < totalSevereBoxes) {\r\n      damage.severe.push(false);\r\n    }\r\n    while (damage.severe.length > totalSevereBoxes) {\r\n      damage.severe.pop();\r\n    }\r\n    \r\n    // Assign the damage object (this updates derived data, source data remains unchanged)\r\n    (this as any).damage = damage;\r\n    \r\n    (this as any).totalLightBoxes = totalLightBoxes;\r\n    (this as any).totalSevereBoxes = totalSevereBoxes;\r\n    \r\n    // Adjust anarchy spent array to match total anarchy\r\n    const totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\r\n    const anarchySpent = (this as any).anarchySpent || [];\r\n    \r\n    if (!Array.isArray(anarchySpent)) {\r\n      (this as any).anarchySpent = [];\r\n    }\r\n    while ((this as any).anarchySpent.length < totalAnarchy) {\r\n      (this as any).anarchySpent.push(false);\r\n    }\r\n    while ((this as any).anarchySpent.length > totalAnarchy) {\r\n      (this as any).anarchySpent.pop();\r\n    }\r\n    \r\n    // Calculate armor cost (2500 per level)\r\n    const armorLevel = (this as any).armorLevel || 0;\r\n    (this as any).armorCost = armorLevel * 2500;\r\n    \r\n    // Calculate damage thresholds (with bonuses from feats)\r\n    const strength = (this as any).attributes?.strength || 1;\r\n    const willpower = (this as any).attributes?.willpower || 1;\r\n    \r\n    // Find active cyberdeck to get firewall for matrix thresholds\r\n    let firewall = 0;\r\n    if (parent && parent.items) {\r\n      const activeCyberdeck = parent.items.find((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.featType === 'cyberdeck' && \r\n        item.system.active === true\r\n      );\r\n      if (activeCyberdeck && activeCyberdeck.system) {\r\n        firewall = activeCyberdeck.system.firewall || 1;\r\n      }\r\n    }\r\n    \r\n    (this as any).damageThresholds = {\r\n      withoutArmor: {\r\n        light: strength + bonusPhysicalThreshold,\r\n        severe: strength + bonusPhysicalThreshold + 3,\r\n        incapacitating: strength + bonusPhysicalThreshold + 6\r\n      },\r\n      withArmor: {\r\n        light: strength + armorLevel + bonusPhysicalThreshold,\r\n        severe: strength + armorLevel + bonusPhysicalThreshold + 3,\r\n        incapacitating: strength + armorLevel + bonusPhysicalThreshold + 6\r\n      },\r\n      mental: {\r\n        light: willpower + bonusMentalThreshold,\r\n        severe: willpower + bonusMentalThreshold + 3,\r\n        incapacitating: willpower + bonusMentalThreshold + 6\r\n      },\r\n      matrix: {\r\n        light: firewall,\r\n        severe: firewall * 2,\r\n        incapacitating: firewall * 3\r\n      }\r\n    };\r\n    \r\n    // Calculate current essence\r\n    const maxEssence = (this as any).maxEssence || 6;\r\n    (this as any).currentEssence = Math.max(0, maxEssence - totalEssenceCost);\r\n    \r\n    // Calculate costs for each attribute\r\n    const attributes = (this as any).attributes;\r\n    if (attributes) {\r\n      // Clamp attributes to their maximums\r\n      attributes.strength = Math.min(attributes.strength || 1, attributeMaxes.strength);\r\n      attributes.agility = Math.min(attributes.agility || 1, attributeMaxes.agility);\r\n      attributes.willpower = Math.min(attributes.willpower || 1, attributeMaxes.willpower);\r\n      attributes.logic = Math.min(attributes.logic || 1, attributeMaxes.logic);\r\n      attributes.charisma = Math.min(attributes.charisma || 1, attributeMaxes.charisma);\r\n      \r\n      (this as any).attributeCosts = {\r\n        strength: this.calculateAttributeCost(attributes.strength || 1, attributeMaxes.strength),\r\n        agility: this.calculateAttributeCost(attributes.agility || 1, attributeMaxes.agility),\r\n        willpower: this.calculateAttributeCost(attributes.willpower || 1, attributeMaxes.willpower),\r\n        logic: this.calculateAttributeCost(attributes.logic || 1, attributeMaxes.logic),\r\n        charisma: this.calculateAttributeCost(attributes.charisma || 1, attributeMaxes.charisma)\r\n      };\r\n      \r\n      // Calculate total cost of attributes\r\n      const attributeCosts = (this as any).attributeCosts;\r\n      let totalCost = Object.values(attributeCosts).reduce((sum: number, cost: any) => sum + cost, 0);\r\n      \r\n      // Add armor cost\r\n      totalCost += (this as any).armorCost || 0;\r\n      \r\n      // Add items cost (skills and feats)\r\n      // Only count active feats in the total cost\r\n      if (parent && parent.items) {\r\n        parent.items.forEach((item: any) => {\r\n          if (item.system && item.system.calculatedCost !== undefined) {\r\n            // Skip inactive feats when calculating total cost\r\n            if (item.type === 'feat' && item.system.active === false) {\r\n              return;\r\n            }\r\n            totalCost += item.system.calculatedCost;\r\n          }\r\n        });\r\n      }\r\n      \r\n      // Add linked vehicles cost\r\n      const linkedVehicles = (this as any).linkedVehicles || [];\r\n      if (linkedVehicles.length > 0) {\r\n        console.log(linkedVehicles)\r\n        for (const vehicleUuid of linkedVehicles) {\r\n          try {\r\n            // Try to load vehicle actor synchronously (for actors in world) or from game.actors\r\n            let vehicleActor: any = null;\r\n            \r\n            // First try fromUuidSync if available (Foundry VTT v13+)\r\n            if ((foundry.utils as any)?.fromUuidSync) {\r\n              try {\r\n                vehicleActor = (foundry.utils as any).fromUuidSync(vehicleUuid);\r\n              } catch (e) {\r\n                // fromUuidSync might fail for compendium items, try game.actors\r\n              }\r\n            }\r\n            \r\n            // Fallback: try to find in game.actors by UUID or ID\r\n            if (!vehicleActor && game.actors) {\r\n              // First try to find by full UUID match\r\n              vehicleActor = (game.actors as any).find((actor: any) => actor.uuid === vehicleUuid);\r\n              \r\n              // If not found, try by ID (last part of UUID)\r\n              if (!vehicleActor) {\r\n                const uuidParts = vehicleUuid.split('.');\r\n                if (uuidParts.length >= 3) {\r\n                  const actorId = uuidParts[uuidParts.length - 1];\r\n                  vehicleActor = (game.actors as any).get(actorId);\r\n                }\r\n              }\r\n            }\r\n            \r\n            if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n              const vehicleCost = vehicleActor.system?.calculatedCost || 0;\r\n              totalCost += vehicleCost;\r\n            }\r\n          } catch (error) {\r\n            console.warn(`Failed to load linked vehicle ${vehicleUuid} for cost calculation:`, error);\r\n          }\r\n        }\r\n      }\r\n      \r\n      (this as any).totalCost = totalCost;\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * Weapon types configuration with their stats\r\n * Includes recommended skill and specialization for attack AND defense\r\n * Specializations are prefixed with \"Spé : \" to easily find them in game.items\r\n */\r\nexport const WEAPON_TYPES = {\r\n  \"custom-weapon\": { \r\n    vd: \"0\", melee: \"none\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Combat rapproché - Mains nues\r\n  \"bare-hands\": { \r\n    vd: \"FOR\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Mains nues\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Combat rapproché - Lames\r\n  \"short-weapons\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  \"long-weapons\": { \r\n    vd: \"FOR+2\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Combat rapproché - Armes contondantes\r\n  \"advanced-melee\": { \r\n    vd: 5, melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  \"tasers\": { \r\n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"none\", long: \"none\",\r\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\r\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\r\n  },\r\n  // Armes à distance - Armes de jet\r\n  \"throwing\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"grenades\": { \r\n    vd: 7, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"gas-grenades\": { \r\n    vd: \"toxin\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Armes de trait\r\n  \"bows\": { \r\n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"crossbows\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Pistolets\r\n  \"pocket-pistols\": { \r\n    vd: 3, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"light-pistols\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"automatic-pistols\": { \r\n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"heavy-pistols\": { \r\n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Mitraillettes\r\n  \"smgs\": { \r\n    vd: 5, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Mitraillettes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Fusils\r\n  \"assault-rifles\": { \r\n    vd: 7, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"disadvantage\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"shotguns\": { \r\n    vd: 8, melee: \"disadvantage\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"sniper-rifles\": { \r\n    vd: 10, melee: \"none\", short: \"disadvantage\", medium: \"disadvantage\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Lance-grenades\r\n  \"grenade-launchers\": { \r\n    vd: 7, melee: \"none\", short: \"disadvantage\", medium: \"ok\", long: \"disadvantage\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Lance-grenades\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  // Armes à distance - Armes lourdes\r\n  \"machine-guns\": { \r\n    vd: 9, melee: \"none\", short: \"ok\", medium: \"ok\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  },\r\n  \"rocket-launchers\": { \r\n    vd: 12, melee: \"none\", short: \"none\", medium: \"disadvantage\", long: \"ok\",\r\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\r\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\r\n  }\r\n} as const;\r\n\r\n/**\r\n * Vehicle/Drone types configuration with their stats\r\n * Imported from JSON file\r\n */\r\nimport vehicleTypesData from '../config/vehicle-types.json';\r\n\r\nexport type VehicleType = keyof typeof vehicleTypesData;\r\nexport type VehicleStats = {\r\n  autopilot: number;\r\n  structure: number;\r\n  handling: number;\r\n  speed: number;\r\n  flyingSpeed: number;\r\n  armor: number;\r\n  weaponMount: string;\r\n};\r\n\r\nexport const VEHICLE_TYPES: Record<VehicleType, VehicleStats> = vehicleTypesData as Record<VehicleType, VehicleStats>;\r\n\r\n/**\r\n * Data model for Feat items\r\n */\r\nexport class FeatDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\r\n      }),\r\n      rating: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.RATING\"\r\n      }),\r\n      cost: new fields.StringField({\r\n        required: true,\r\n        initial: \"free-equipment\",\r\n        choices: {\r\n          \"free-equipment\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\",\r\n          \"equipment\": \"SRA2.FEATS.COST.EQUIPMENT\",\r\n          \"advanced-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\r\n          // Legacy values kept for migration compatibility (not shown in UI)\r\n          \"specialized-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\r\n          \"feat\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\"\r\n        },\r\n        label: \"SRA2.FEATS.COST.LABEL\"\r\n      }),\r\n      active: new fields.BooleanField({\r\n        required: true,\r\n        initial: true,\r\n        label: \"SRA2.FEATS.ACTIVE\"\r\n      }),\r\n      rrList: new fields.ArrayField(new fields.SchemaField({\r\n        rrType: new fields.StringField({\r\n          required: true,\r\n          initial: \"skill\",\r\n          choices: {\r\n            \"attribute\": \"SRA2.FEATS.RR_TYPE.ATTRIBUTE\",\r\n            \"skill\": \"SRA2.FEATS.RR_TYPE.SKILL\",\r\n            \"specialization\": \"SRA2.FEATS.RR_TYPE.SPECIALIZATION\"\r\n          },\r\n          label: \"SRA2.FEATS.RR_TYPE.LABEL\"\r\n        }),\r\n        rrValue: new fields.NumberField({\r\n          required: true,\r\n          initial: 1,\r\n          min: 0,\r\n          max: 3,\r\n          integer: true,\r\n          label: \"SRA2.FEATS.RR_VALUE\"\r\n        }),\r\n        rrTarget: new fields.StringField({\r\n          required: false,\r\n          initial: \"\",\r\n          nullable: false,\r\n          label: \"SRA2.FEATS.RR_TARGET\"\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.FEATS.RR_LIST\"\r\n      }),\r\n      bonusLightDamage: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_LIGHT_DAMAGE\"\r\n      }),\r\n      bonusSevereDamage: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_SEVERE_DAMAGE\"\r\n      }),\r\n      bonusPhysicalThreshold: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_PHYSICAL_THRESHOLD\"\r\n      }),\r\n      bonusMentalThreshold: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_MENTAL_THRESHOLD\"\r\n      }),\r\n      bonusAnarchy: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.BONUS_ANARCHY\"\r\n      }),\r\n      essenceCost: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        label: \"SRA2.FEATS.ESSENCE_COST\"\r\n      }),\r\n      isBioware: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_BIOWARE\"\r\n      }),\r\n      featType: new fields.StringField({\r\n        required: true,\r\n        initial: \"equipment\",\r\n        choices: {\r\n          \"trait\": \"SRA2.FEATS.FEAT_TYPE.TRAIT\",\r\n          \"contact\": \"SRA2.FEATS.FEAT_TYPE.CONTACT\",\r\n          \"awakened\": \"SRA2.FEATS.FEAT_TYPE.AWAKENED\",\r\n          \"adept-power\": \"SRA2.FEATS.FEAT_TYPE.ADEPT_POWER\",\r\n          \"equipment\": \"SRA2.FEATS.FEAT_TYPE.EQUIPMENT\",\r\n          \"cyberware\": \"SRA2.FEATS.FEAT_TYPE.CYBERWARE\",\r\n          \"cyberdeck\": \"SRA2.FEATS.FEAT_TYPE.CYBERDECK\",\r\n          \"vehicle\": \"SRA2.FEATS.FEAT_TYPE.VEHICLE\",\r\n          \"weapons-spells\": \"SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS\",\r\n          \"weapon\": \"SRA2.FEATS.FEAT_TYPE.WEAPON\",\r\n          \"spell\": \"SRA2.FEATS.FEAT_TYPE.SPELL\",\r\n          \"connaissance\": \"SRA2.FEATS.FEAT_TYPE.CONNAISSANCE\"\r\n        },\r\n        label: \"SRA2.FEATS.FEAT_TYPE.LABEL\"\r\n      }),\r\n      weaponType: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.WEAPON_TYPE\"\r\n      }),\r\n      vehicleType: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.VEHICLE_TYPE\"\r\n      }),\r\n      // Weapon/Spell specific fields\r\n      damageValue: new fields.StringField({\r\n        required: true,\r\n        initial: \"0\",\r\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE\"\r\n      }),\r\n      damageValueBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE_BONUS\"\r\n      }),\r\n      meleeRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.MELEE_RANGE\"\r\n      }),\r\n      shortRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.SHORT_RANGE\"\r\n      }),\r\n      mediumRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.MEDIUM_RANGE\"\r\n      }),\r\n      longRange: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        choices: {\r\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\r\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\r\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\r\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\r\n        },\r\n        label: \"SRA2.FEATS.WEAPON.LONG_RANGE\"\r\n      }),\r\n      rangeImprovements: new fields.SchemaField({\r\n        melee: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        short: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        medium: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        long: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }, {\r\n        required: true,\r\n        label: \"SRA2.FEATS.WEAPON.RANGE_IMPROVEMENTS\"\r\n      }),\r\n      // Vehicle/Drone specific fields\r\n      autopilot: new fields.NumberField({\r\n        required: true,\r\n        initial: 6,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT\"\r\n      }),\r\n      structure: new fields.NumberField({\r\n        required: true,\r\n        initial: 2,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.STRUCTURE\"\r\n      }),\r\n      handling: new fields.NumberField({\r\n        required: true,\r\n        initial: 5,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING\"\r\n      }),\r\n      speed: new fields.NumberField({\r\n        required: true,\r\n        initial: 3,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED\"\r\n      }),\r\n      flyingSpeed: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.FLYING_SPEED\"\r\n      }),\r\n      armor: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR\"\r\n      }),\r\n      weaponMount: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\r\n      }),\r\n      weaponInfo: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\r\n      }),\r\n      // Vehicle bonuses\r\n      autopilotBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 6,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\r\n      }),\r\n      speedBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\r\n      }),\r\n      handlingBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\r\n      }),\r\n      armorBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\r\n      }),\r\n      isFixed: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\r\n      }),\r\n      isFlying: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\r\n      }),\r\n      weaponMountImprovement: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\r\n      }),\r\n      autopilotUnlocked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\r\n      }),\r\n      additionalDroneCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\r\n      }),\r\n      // Reference to vehicle actor when feat is created from dragging a vehicle actor\r\n      vehicleActorUuid: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        nullable: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ACTOR_UUID\"\r\n      }),\r\n      // Cyberdeck specific fields\r\n      firewall: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.FIREWALL\"\r\n      }),\r\n      attack: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.ATTACK\"\r\n      }),\r\n      cyberdeckDamage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      }, {\r\n        required: true,\r\n        label: \"SRA2.FEATS.CYBERDECK.DAMAGE\"\r\n      }),\r\n      // Cyberdeck bonus light damage (+1 light damage box for cyberdeck, +1 to recommended level)\r\n      cyberdeckBonusLightDamage: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.CYBERDECK.BONUS_LIGHT_DAMAGE\"\r\n      }),\r\n      // Contact specific fields\r\n      contactName: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.CONTACT.NAME\"\r\n      }),\r\n      // Awakened specific fields\r\n      astralPerception: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PERCEPTION\"\r\n      }),\r\n      astralProjection: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PROJECTION\"\r\n      }),\r\n      sorcery: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.SORCERY\"\r\n      }),\r\n      conjuration: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.CONJURATION\"\r\n      }),\r\n      adept: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.ADEPT\"\r\n      }),\r\n      // Additional fields for recommended level calculation\r\n      riggerConsoleCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.RIGGER_CONSOLE_COUNT\"\r\n      }),\r\n      hasVehicleControlWiring: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.HAS_VEHICLE_CONTROL_WIRING\"\r\n      }),\r\n      isWeaponFocus: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_WEAPON_FOCUS\"\r\n      }),\r\n      isAdeptPowerWeapon: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_ADEPT_POWER_WEAPON\"\r\n      }),\r\n      // Narrative effects\r\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\r\n        text: new fields.StringField({\r\n          required: false,\r\n          initial: \"\"\r\n        }),\r\n        isNegative: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        value: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: -5,\r\n          max: 5\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.FEATS.NARRATIVE_EFFECTS\"\r\n      }),\r\n      // Grants narration\r\n      grantsNarration: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.GRANTS_NARRATION\"\r\n      }),\r\n      narrationActions: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 1,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.NARRATION_ACTIONS\"\r\n      }),\r\n      // Additional sustained spells and summoned spirits\r\n      sustainedSpellCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 2,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.SUSTAINED_SPELL_COUNT\"\r\n      }),\r\n      summonedSpiritCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 1,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.SUMMONED_SPIRIT_COUNT\"\r\n      }),\r\n      // First feat flag\r\n      isFirstFeat: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.IS_FIRST_FEAT\"\r\n      }),\r\n      // Shamanic mask (for awakened feats)\r\n      shamanicMask: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.AWAKENED.SHAMANIC_MASK\"\r\n      }),\r\n      // Spell type (direct or indirect)\r\n      spellType: new fields.StringField({\r\n        required: true,\r\n        initial: \"direct\",\r\n        choices: {\r\n          \"direct\": \"SRA2.FEATS.SPELL.TYPE_DIRECT\",\r\n          \"indirect\": \"SRA2.FEATS.SPELL.TYPE_INDIRECT\"\r\n        },\r\n        label: \"SRA2.FEATS.SPELL.TYPE\"\r\n      }),\r\n      // Weapon damage bonus by weapon type\r\n      weaponDamageBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.WEAPON_DAMAGE_BONUS\"\r\n      }),\r\n      weaponTypeBonus: new fields.StringField({\r\n        required: true,\r\n        initial: \"custom-weapon\",\r\n        choices: (() => {\r\n          const choices: Record<string, string> = {};\r\n          Object.keys(WEAPON_TYPES).forEach((key) => {\r\n            choices[key] = key;\r\n          });\r\n          return choices;\r\n        })(),\r\n        label: \"SRA2.FEATS.WEAPON_TYPE_BONUS\"\r\n      }),\r\n      // Spell specialization type (determines which specialization to use)\r\n      spellSpecializationType: new fields.StringField({\r\n        required: true,\r\n        initial: \"combat\",\r\n        choices: {\r\n          \"combat\": \"SRA2.FEATS.SPELL.SPECIALIZATION.COMBAT\",\r\n          \"detection\": \"SRA2.FEATS.SPELL.SPECIALIZATION.DETECTION\",\r\n          \"health\": \"SRA2.FEATS.SPELL.SPECIALIZATION.HEALTH\",\r\n          \"illusion\": \"SRA2.FEATS.SPELL.SPECIALIZATION.ILLUSION\",\r\n          \"manipulation\": \"SRA2.FEATS.SPELL.SPECIALIZATION.MANIPULATION\",\r\n          \"counterspell\": \"SRA2.FEATS.SPELL.SPECIALIZATION.COUNTERSPELL\"\r\n        },\r\n        label: \"SRA2.FEATS.SPELL.SPECIALIZATION.TYPE\"\r\n      }),\r\n      // Linked skills and specializations for weapons (for custom weapons)\r\n      linkedAttackSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SKILL\"\r\n      }),\r\n      linkedAttackSpecialization: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SPECIALIZATION\"\r\n      }),\r\n      linkedDefenseSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SKILL\"\r\n      }),\r\n      linkedDefenseSpecialization: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SPECIALIZATION\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Get common properties\r\n    const costType = (this as any).cost || 'free-equipment';\r\n    const featType = (this as any).featType || 'equipment';\r\n    const rating = (this as any).rating || 0;\r\n    \r\n    // If astral projection is enabled, automatically enable astral perception\r\n    if ((this as any).astralProjection) {\r\n      (this as any).astralPerception = true;\r\n    }\r\n    \r\n    // For spells, automatically set linkedAttackSkill and linkedAttackSpecialization\r\n    if (featType === 'spell') {\r\n      // Always set attack skill to Sorcellerie\r\n      (this as any).linkedAttackSkill = 'Sorcellerie';\r\n      \r\n      // Map spell specialization type to specialization name\r\n      const spellSpecType = (this as any).spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      (this as any).linkedAttackSpecialization = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n    }\r\n    \r\n    // Calculate cost based on cost type (for equipment and weapons)\r\n    let calculatedCost = 0;\r\n    \r\n    // Connaissance: base cost of 2500\r\n    if (featType === 'connaissance') {\r\n      calculatedCost = 2500;\r\n    }\r\n    \r\n    // Apply cost calculations for equipment, weapon, and weapons-spells types\r\n    if (featType === 'equipment' || featType === 'weapon' || featType === 'weapons-spells') {\r\n      switch (costType) {\r\n        case 'free-equipment':\r\n          calculatedCost = 0;\r\n          break;\r\n        case 'equipment':\r\n          calculatedCost = 2500;\r\n          break;\r\n        case 'advanced-equipment':\r\n          calculatedCost = 5000;\r\n          break;\r\n        // Legacy values (kept for migration compatibility)\r\n        case 'specialized-equipment':\r\n          calculatedCost = 5000;\r\n          break;\r\n        case 'feat':\r\n          calculatedCost = 0;\r\n          break;\r\n        default:\r\n          calculatedCost = 0;\r\n      }\r\n    }\r\n\r\n    calculatedCost += rating * 5000;\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n\r\n    // Calculate recommended attribute level\r\n    let recommendedLevel = 0;\r\n    const recommendedLevelBreakdown: Array<{ labelKey: string; labelParams?: string; value: number }> = [];\r\n    \r\n    const bonusLightDamage = (this as any).bonusLightDamage || 0;\r\n    const bonusSevereDamage = (this as any).bonusSevereDamage || 0;\r\n    const bonusPhysicalThreshold = (this as any).bonusPhysicalThreshold || 0;\r\n    const bonusMentalThreshold = (this as any).bonusMentalThreshold || 0;\r\n    const firewall = (this as any).firewall || 0;\r\n    const attack = (this as any).attack || 0;\r\n    const riggerConsoleCount = (this as any).riggerConsoleCount || 0;\r\n    const hasVehicleControlWiring = (this as any).hasVehicleControlWiring || false;\r\n    const isWeaponFocus = (this as any).isWeaponFocus || false;\r\n    const isAdeptPowerWeapon = (this as any).isAdeptPowerWeapon || false;\r\n    const isBioware = (this as any).isBioware || false;\r\n    const bonusAnarchy = (this as any).bonusAnarchy || 0;\r\n    const grantsNarration = (this as any).grantsNarration || false;\r\n    const narrativeEffects = (this as any).narrativeEffects || [];\r\n    const rrList = (this as any).rrList || [];\r\n    const isFirstFeat = (this as any).isFirstFeat || false;\r\n    \r\n    // Base cost for trait (not first feat): +3 levels\r\n    if (featType === 'trait' && !isFirstFeat) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BASE_FEAT_COST', value: 3 });\r\n    }\r\n    \r\n    // Cyberware/bioware: 1 level (base), +1 additional if bioware\r\n    if (featType === 'cyberware') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERWARE', value: 1 });\r\n      \r\n      // Bioware: +1 additional level\r\n      if (isBioware) {\r\n        recommendedLevel += 1;\r\n        recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BIOWARE', value: 1 });\r\n      }\r\n    }\r\n    \r\n    // Adept power: 1 level\r\n    if (featType === 'adept-power') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER', value: 1 });\r\n    }\r\n    \r\n    // Spell: 1 level\r\n    if (featType === 'spell') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPELL', value: 1 });\r\n    }\r\n    \r\n    // Vehicle/Drone: 1 level\r\n    if (featType === 'vehicle') {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE', value: 1 });\r\n    }\r\n    \r\n    // Light wounds: +3 per wound\r\n    if (bonusLightDamage > 0) {\r\n      const value = bonusLightDamage * 3;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.LIGHT_WOUNDS', labelParams: `(${bonusLightDamage})`, value });\r\n    }\r\n    \r\n    // Heavy wounds: +6 per wound\r\n    if (bonusSevereDamage > 0) {\r\n      const value = bonusSevereDamage * 6;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SEVERE_WOUNDS', labelParams: `(${bonusSevereDamage})`, value });\r\n    }\r\n    \r\n    // Physical threshold bonus: +1 per point (positive or negative)\r\n    if (bonusPhysicalThreshold !== 0) {\r\n      const value = Math.abs(bonusPhysicalThreshold);\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.PHYSICAL_THRESHOLD', labelParams: `(${bonusPhysicalThreshold > 0 ? '+' : ''}${bonusPhysicalThreshold})`, value });\r\n    }\r\n    \r\n    // Mental threshold bonus: +1 per point (positive or negative)\r\n    if (bonusMentalThreshold !== 0) {\r\n      const value = Math.abs(bonusMentalThreshold);\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.MENTAL_THRESHOLD', labelParams: `(${bonusMentalThreshold > 0 ? '+' : ''}${bonusMentalThreshold})`, value });\r\n    }\r\n    \r\n    // Cyberdeck firewall: starts at 1, each level is +1\r\n    if (featType === 'cyberdeck' && firewall > 0) {\r\n      recommendedLevel += firewall;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.FIREWALL', labelParams: `(${firewall})`, value: firewall });\r\n    }\r\n    \r\n    // Cyberdeck bonus light damage: +3 to recommended level\r\n    const cyberdeckBonusLightDamage = (this as any).cyberdeckBonusLightDamage || false;\r\n    if (featType === 'cyberdeck' && cyberdeckBonusLightDamage) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERDECK_BONUS_LIGHT_DAMAGE', value: 3 });\r\n    }\r\n    \r\n    // Attack: starts at 0, each level is +1\r\n    if (attack > 0) {\r\n      recommendedLevel += attack;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ATTACK', labelParams: `(${attack})`, value: attack });\r\n    }\r\n    \r\n    // Rigger console: +1 per drone controller\r\n    if (riggerConsoleCount > 0) {\r\n      recommendedLevel += riggerConsoleCount;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RIGGER_CONSOLE', labelParams: `(${riggerConsoleCount})`, value: riggerConsoleCount });\r\n    }\r\n    \r\n    // Vehicle control wiring: +2\r\n    if (hasVehicleControlWiring) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE_WIRING', value: 2 });\r\n    }\r\n    \r\n    // Weapon focus: +1\r\n    if (isWeaponFocus) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_FOCUS', value: 1 });\r\n    }\r\n    \r\n    // Adept power weapon: +1\r\n    if (isAdeptPowerWeapon) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER_WEAPON', value: 1 });\r\n    }\r\n    \r\n    // Damage value bonus: +1 per bonus\r\n    const damageValueBonus = (this as any).damageValueBonus || 0;\r\n    if (damageValueBonus > 0) {\r\n      recommendedLevel += damageValueBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.DAMAGE_VALUE_BONUS', labelParams: `(+${damageValueBonus})`, value: damageValueBonus });\r\n    }\r\n    \r\n    // Weapon damage bonus by weapon type: +1 per bonus\r\n    const weaponDamageBonus = (this as any).weaponDamageBonus || 0;\r\n    if (weaponDamageBonus > 0) {\r\n      recommendedLevel += weaponDamageBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_DAMAGE_BONUS', labelParams: `(+${weaponDamageBonus})`, value: weaponDamageBonus });\r\n    }\r\n    \r\n    // Range improvements: +2 per improved range\r\n    const rangeImprovements = (this as any).rangeImprovements || {};\r\n    let rangeImprovementCount = 0;\r\n    if (rangeImprovements.melee) rangeImprovementCount++;\r\n    if (rangeImprovements.short) rangeImprovementCount++;\r\n    if (rangeImprovements.medium) rangeImprovementCount++;\r\n    if (rangeImprovements.long) rangeImprovementCount++;\r\n    if (rangeImprovementCount > 0) {\r\n      const value = rangeImprovementCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RANGE_IMPROVEMENTS', labelParams: `(${rangeImprovementCount})`, value });\r\n    }\r\n    \r\n    // Resource Reduction (RR) entries\r\n    for (const rr of rrList) {\r\n      const rrType = rr.rrType;\r\n      const rrValue = rr.rrValue || 0;\r\n      \r\n      if (rrValue > 0) {\r\n        if (rrType === 'specialization') {\r\n          // RR specialization: +2 levels per value\r\n          const value = rrValue * 2;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SPECIALIZATION', labelParams: `(${rrValue})`, value });\r\n        } else if (rrType === 'skill') {\r\n          // RR skill: +5 levels per value\r\n          const value = rrValue * 5;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SKILL', labelParams: `(${rrValue})`, value });\r\n        } else if (rrType === 'attribute') {\r\n          // RR attribute: +10 levels per value\r\n          const value = rrValue * 10;\r\n          recommendedLevel += value;\r\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_ATTRIBUTE', labelParams: `(${rrValue})`, value });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Anarchy bonus: +2 per anarchy point\r\n    if (bonusAnarchy > 0) {\r\n      const value = bonusAnarchy * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ANARCHY_BONUS', labelParams: `(${bonusAnarchy})`, value });\r\n    }\r\n    \r\n    // Grants narration: +3 levels\r\n    if (grantsNarration) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.GRANTS_NARRATION', value: 3 });\r\n    }\r\n    \r\n    // Narrative effects: value per positive effect, value per negative effect (exclude effects with value 0)\r\n    const positiveEffects = narrativeEffects.filter((effect: any) => {\r\n      return effect?.text && effect.text.trim() !== '' && !effect.isNegative && effect.value !== 0 && effect.value !== null && effect.value !== undefined;\r\n    });\r\n    const negativeEffects = narrativeEffects.filter((effect: any) => {\r\n      return effect?.text && effect.text.trim() !== '' && effect.isNegative && effect.value !== 0 && effect.value !== null && effect.value !== undefined;\r\n    });\r\n    \r\n    if (positiveEffects.length > 0) {\r\n      const positiveEffectValue = positiveEffects.reduce((sum: number, effect: any) => sum + (effect.value || 1), 0);\r\n      recommendedLevel += positiveEffectValue;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_POSITIVE', labelParams: `(${positiveEffects.length})`, value: positiveEffectValue });\r\n    }\r\n    \r\n    if (negativeEffects.length > 0) {\r\n      const negativeEffectValue = negativeEffects.reduce((sum: number, effect: any) => sum + (effect.value || -1), 0);\r\n      recommendedLevel += negativeEffectValue; // Adding because value is already negative\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_NEGATIVE', labelParams: `(${negativeEffects.length})`, value: negativeEffectValue });\r\n    }\r\n    \r\n    // Additional sustained spells: +2 per spell (max 2)\r\n    const sustainedSpellCount = (this as any).sustainedSpellCount || 0;\r\n    if (sustainedSpellCount > 0) {\r\n      const value = sustainedSpellCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUSTAINED_SPELLS', labelParams: `(${sustainedSpellCount})`, value });\r\n    }\r\n    \r\n    // Additional summoned spirit: +3 (max 1)\r\n    const summonedSpiritCount = (this as any).summonedSpiritCount || 0;\r\n    if (summonedSpiritCount > 0) {\r\n      const value = summonedSpiritCount * 3;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUMMONED_SPIRITS', labelParams: `(${summonedSpiritCount})`, value });\r\n    }\r\n    \r\n    // Awakened abilities\r\n    const astralPerception = (this as any).astralPerception || false;\r\n    const astralProjection = (this as any).astralProjection || false;\r\n    const sorcery = (this as any).sorcery || false;\r\n    const conjuration = (this as any).conjuration || false;\r\n    const adept = (this as any).adept || false;\r\n\r\n    // Astral perception\r\n    if (astralPerception && !astralProjection) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION', value: 1 });\r\n    }\r\n    \r\n    // Astral perception AND projection: +2\r\n    if (astralPerception && astralProjection) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION_PROJECTION', value: 2 });\r\n    }\r\n    \r\n    // Sorcery: +1\r\n    if (sorcery) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SORCERY', value: 1 });\r\n    }\r\n    \r\n    // Conjuration: +2\r\n    if (conjuration) {\r\n      recommendedLevel += 2;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CONJURATION', value: 2 });\r\n    }\r\n    \r\n    // Adept: +1\r\n    if (adept) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT', value: 1 });\r\n    }\r\n    \r\n    // Vehicle/Drone bonuses\r\n    const autopilotBonus = (this as any).autopilotBonus || 0;\r\n    const speedBonus = (this as any).speedBonus || 0;\r\n    const handlingBonus = (this as any).handlingBonus || 0;\r\n    const armorBonus = (this as any).armorBonus || 0;\r\n    const isFixed = (this as any).isFixed || false;\r\n    const isFlying = (this as any).isFlying || false;\r\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\r\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\r\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\r\n    \r\n    // Autopilot bonus: +1 per level\r\n    if (autopilotBonus > 0) {\r\n      recommendedLevel += autopilotBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_BONUS', labelParams: `(+${autopilotBonus})`, value: autopilotBonus });\r\n    }\r\n    \r\n    // Speed bonus: +1 per level\r\n    if (speedBonus > 0) {\r\n      recommendedLevel += speedBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPEED_BONUS', labelParams: `(+${speedBonus})`, value: speedBonus });\r\n    }\r\n    \r\n    // Handling bonus: +1 per level\r\n    if (handlingBonus > 0) {\r\n      recommendedLevel += handlingBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.HANDLING_BONUS', labelParams: `(+${handlingBonus})`, value: handlingBonus });\r\n    }\r\n    \r\n    // Armor bonus: +1 per level\r\n    if (armorBonus > 0) {\r\n      recommendedLevel += armorBonus;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ARMOR_BONUS', labelParams: `(+${armorBonus})`, value: armorBonus });\r\n    }\r\n    \r\n    // Fixed (unable to move): -1\r\n    if (isFixed) {\r\n      recommendedLevel -= 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FIXED', value: -1 });\r\n    }\r\n    \r\n    // Flying: +1\r\n    if (isFlying) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FLYING', value: 1 });\r\n    }\r\n    \r\n    // Weapon mount improvement: +1\r\n    if (weaponMountImprovement) {\r\n      recommendedLevel += 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_MOUNT_IMPROVEMENT', value: 1 });\r\n    }\r\n    \r\n    // Autopilot unlocked: +3\r\n    if (autopilotUnlocked) {\r\n      recommendedLevel += 3;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_UNLOCKED', value: 3 });\r\n    }\r\n    \r\n    // Additional drones: +2 per drone\r\n    if (additionalDroneCount > 0) {\r\n      const value = additionalDroneCount * 2;\r\n      recommendedLevel += value;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADDITIONAL_DRONES', labelParams: `(${additionalDroneCount})`, value });\r\n    }\r\n    \r\n    // Shamanic mask: -1 level (for awakened feats only)\r\n    const shamanicMask = (this as any).shamanicMask || false;\r\n    if (shamanicMask && featType === 'awakened') {\r\n      recommendedLevel -= 1;\r\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SHAMANIC_MASK', value: -1 });\r\n    }\r\n    \r\n    (this as any).recommendedLevel = recommendedLevel;\r\n    (this as any).recommendedLevelBreakdown = recommendedLevelBreakdown;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Vehicle/Drone actors\r\n */\r\nimport { VEHICLE_TYPES, VehicleType } from './item-feat.js';\r\n\r\nexport class VehicleDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    // Build vehicle type choices from VEHICLE_TYPES\r\n    const vehicleTypeChoices: Record<string, string> = {};\r\n    Object.keys(VEHICLE_TYPES).forEach((key) => {\r\n      vehicleTypeChoices[key] = key;\r\n    });\r\n    \r\n    return {\r\n      vehicleType: new fields.StringField({\r\n        required: false,\r\n        nullable: true,\r\n        choices: vehicleTypeChoices,\r\n        label: \"SRA2.VEHICLE.VEHICLE_TYPE\"\r\n      }),\r\n      // Vehicle bonuses\r\n      autopilotBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 6,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\r\n      }),\r\n      speedBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\r\n      }),\r\n      handlingBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\r\n      }),\r\n      armorBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\r\n      }),\r\n      isFixed: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\r\n      }),\r\n      isFlying: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\r\n      }),\r\n      weaponMountImprovement: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\r\n      }),\r\n      autopilotUnlocked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\r\n      }),\r\n      additionalDroneCount: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 3,\r\n        integer: true,\r\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\r\n      }),\r\n      weaponMount: new fields.StringField({\r\n        required: true,\r\n        initial: \"none\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\r\n      }),\r\n      weaponInfo: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\r\n      }),\r\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\r\n        text: new fields.StringField({\r\n        required: false,\r\n        initial: \"\"\r\n        }),\r\n        isNegative: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }),\r\n        value: new fields.NumberField({\r\n          required: true,\r\n          initial: 0,\r\n          min: -5,\r\n          max: 5\r\n        })\r\n      }), {\r\n        initial: [],\r\n        label: \"SRA2.VEHICLE.NARRATIVE_EFFECTS\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    const vehicleType = (this as any).vehicleType || \"\";\r\n    const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as VehicleType] \r\n      ? VEHICLE_TYPES[vehicleType as VehicleType] \r\n      : null;\r\n    \r\n    // Get base stats from vehicle type or defaults\r\n    const baseAutopilot = vehicleStats?.autopilot || 0;\r\n    const baseStructure = vehicleStats?.structure || 0;\r\n    const baseHandling = vehicleStats?.handling || 0;\r\n    const baseSpeed = vehicleStats?.speed || 0;\r\n    const baseFlyingSpeed = vehicleStats?.flyingSpeed || 0;\r\n    const baseArmor = vehicleStats?.armor || 0;\r\n    const baseWeaponMount = vehicleStats?.weaponMount || \"none\";\r\n    \r\n    // Get bonuses\r\n    const autopilotBonus = (this as any).autopilotBonus || 0;\r\n    const speedBonus = (this as any).speedBonus || 0;\r\n    const handlingBonus = (this as any).handlingBonus || 0;\r\n    const armorBonus = (this as any).armorBonus || 0;\r\n    const isFlying = (this as any).isFlying || false;\r\n    const isFixed = (this as any).isFixed || false;\r\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\r\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\r\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\r\n    \r\n    // Calculate final values (same logic as feat-sheet.ts)\r\n    const finalAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\r\n    const finalHandling = baseHandling + handlingBonus;\r\n    const finalSpeed = isFixed ? 0 : (baseSpeed + speedBonus);\r\n    const finalFlyingSpeed = isFlying ? (baseFlyingSpeed > 0 ? baseFlyingSpeed : 1) : 0;\r\n    const finalArmor = Math.min(baseStructure, baseArmor + armorBonus);\r\n    \r\n    // Calculate weapon mount (improved if option is checked)\r\n    let finalWeaponMount = baseWeaponMount;\r\n    if (weaponMountImprovement) {\r\n      if (baseWeaponMount === \"none\") {\r\n        finalWeaponMount = \"smg\";\r\n      } else if (baseWeaponMount === \"smg\") {\r\n        finalWeaponMount = \"rifle\";\r\n      }\r\n    }\r\n    \r\n    // Store calculated attributes (read-only in UI)\r\n    (this as any).attributes = {\r\n      autopilot: finalAutopilot,\r\n      structure: baseStructure,\r\n      handling: finalHandling,\r\n      speed: finalSpeed,\r\n      flyingSpeed: finalFlyingSpeed,\r\n      armor: finalArmor\r\n    };\r\n    \r\n    // Store base stats for reference\r\n    (this as any).baseAttributes = {\r\n      autopilot: baseAutopilot,\r\n      structure: baseStructure,\r\n      handling: baseHandling,\r\n      speed: baseSpeed,\r\n      flyingSpeed: baseFlyingSpeed,\r\n      armor: baseArmor\r\n    };\r\n    \r\n    // Store weapon mount info\r\n    (this as any).weaponMount = finalWeaponMount;\r\n    \r\n    // Calculate damage thresholds for vehicles\r\n    // Based on the formulas:\r\n    // - If VD > (3 × Structure) + Armor, incapacitating damage\r\n    // - If VD > (2 × Structure) + Armor, severe damage\r\n    // - If VD > Structure + Armor, light damage\r\n    // - If VD ≤ Structure + Armor, no damage\r\n    \r\n    (this as any).damageThresholds = {\r\n      light: baseStructure + finalArmor,\r\n      severe: (2 * baseStructure) + finalArmor,\r\n      incapacitating: (3 * baseStructure) + finalArmor\r\n    };\r\n    \r\n    // Ensure damage arrays are properly sized (preserve existing values)\r\n    // CRITICAL: Read from source data first to preserve persisted values\r\n    // In Foundry v13, when prepareDerivedData() is called, (this as any).damage\r\n    // should already contain the persisted values from _source, but we need to\r\n    // ensure we're working with a copy to avoid mutating the source\r\n    const parent = (this as any).parent;\r\n    const sourceDamage = parent?._source?.system?.damage || (this as any).damage || {};\r\n    \r\n    // Base: 2 light, 1 severe, 1 incapacitating\r\n    const totalLightBoxes = 2;\r\n    const totalSevereBoxes = 1;\r\n    \r\n    // Create a copy from source to preserve persisted values\r\n    const damage: any = {\r\n      light: Array.isArray(sourceDamage.light) ? [...sourceDamage.light] : [false, false],\r\n      severe: Array.isArray(sourceDamage.severe) ? [...sourceDamage.severe] : [false],\r\n      incapacitating: typeof sourceDamage.incapacitating === 'boolean' ? sourceDamage.incapacitating : false\r\n    };\r\n    \r\n    // Adjust light damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.light.length < totalLightBoxes) {\r\n      damage.light.push(false);\r\n    }\r\n    while (damage.light.length > totalLightBoxes) {\r\n      damage.light.pop();\r\n    }\r\n    \r\n    // Adjust severe damage array size (preserve existing values, only pad or trim from end)\r\n    while (damage.severe.length < totalSevereBoxes) {\r\n      damage.severe.push(false);\r\n    }\r\n    while (damage.severe.length > totalSevereBoxes) {\r\n      damage.severe.pop();\r\n    }\r\n    \r\n    // Assign the damage object (this updates derived data, source data remains unchanged)\r\n    (this as any).damage = damage;\r\n    \r\n    (this as any).totalLightBoxes = totalLightBoxes;\r\n    (this as any).totalSevereBoxes = totalSevereBoxes;\r\n    \r\n    // Calculate cost (same rules as vehicle feats: base 5000 + bonuses * 5000)\r\n    let calculatedCost = 5000; // Base cost for vehicle/drone\r\n    \r\n    // Add cost for bonuses (each bonus point costs 5000)\r\n    calculatedCost += autopilotBonus * 5000;\r\n    calculatedCost += speedBonus * 5000;\r\n    calculatedCost += handlingBonus * 5000;\r\n    calculatedCost += armorBonus * 5000;\r\n    \r\n    // Add cost for options\r\n    if (isFlying) {\r\n      calculatedCost += 5000; // +1 level = +5000\r\n    }\r\n    if (weaponMountImprovement) {\r\n      calculatedCost += 5000; // +1 level = +5000\r\n    }\r\n    if (autopilotUnlocked) {\r\n      calculatedCost += 15000; // +3 levels = +15000\r\n    }\r\n    if (additionalDroneCount > 0) {\r\n      calculatedCost += additionalDroneCount * 10000; // +2 levels per drone = +10000 per drone\r\n    }\r\n    if (isFixed) {\r\n      calculatedCost -= 5000; // -1 level = -5000\r\n    }\r\n    \r\n    // Add cost for narrative effects based on their values (5000 per point of value)\r\n    // Positive values add to cost, negative values reduce cost\r\n    const narrativeEffects = (this as any).narrativeEffects || [];\r\n    let narrativeEffectsCost = 0;\r\n    \r\n    narrativeEffects.forEach((effect: any) => {\r\n      // Handle both old format (strings) and new format (objects)\r\n      if (typeof effect === 'string') {\r\n        // Old format: each string effect counts as +1 (5000 yens)\r\n        if (effect && effect.trim() !== '') {\r\n          narrativeEffectsCost += 5000;\r\n        }\r\n      } else if (effect && typeof effect === 'object') {\r\n        // New format: use the value of the effect\r\n        const hasText = effect.text && effect.text.trim() !== '';\r\n        const value = effect.value !== undefined && effect.value !== null ? effect.value : 0;\r\n        \r\n        if (hasText && value !== 0) {\r\n          // Each point of value = 5000 yens (positive adds, negative subtracts)\r\n          narrativeEffectsCost += value * 5000;\r\n        }\r\n      }\r\n    });\r\n    \r\n    calculatedCost += narrativeEffectsCost;\r\n    \r\n    // Add cost for weapons (get from actor items)\r\n    const actor = (this as any).parent;\r\n    if (actor && actor.items) {\r\n      const weapons = actor.items.filter((item: any) => {\r\n        const featType = item.system?.featType;\r\n        return featType === 'weapon' || featType === 'weapons-spells';\r\n      });\r\n      \r\n      weapons.forEach((weapon: any) => {\r\n        const weaponCost = weapon.system?.calculatedCost || 0;\r\n        calculatedCost += weaponCost;\r\n      });\r\n    }\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n  }\r\n}\r\n\r\n\r\n","/**\r\n * Data model for ICE actors\r\n */\r\nexport const ICE_TYPES = {\r\n  patrol: 'Patrouilleuse',\r\n  acid: 'Acide',\r\n  blaster: 'Blaster',\r\n  blocker: 'Bloqueuse',\r\n  black: 'Noire',\r\n  glue: 'Pot de colle',\r\n  tracker: 'Traqueuse',\r\n  killer: 'Tueuse'\r\n} as const;\r\n\r\nexport type IceType = keyof typeof ICE_TYPES;\r\n\r\nexport class IceDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    // Build ICE type choices from ICE_TYPES\r\n    const iceTypeChoices: Record<string, string> = {};\r\n    Object.entries(ICE_TYPES).forEach(([key, value]) => {\r\n      iceTypeChoices[key] = value;\r\n    });\r\n    \r\n    return {\r\n      iceType: new fields.StringField({\r\n        required: false,\r\n        nullable: true,\r\n        choices: iceTypeChoices,\r\n        label: \"SRA2.ICE.ICE_TYPE\"\r\n      }),\r\n      serverIndex: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 1,\r\n        max: 12,\r\n        integer: true,\r\n        label: \"SRA2.ICE.SERVER_INDEX\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      }),\r\n      damage: new fields.SchemaField({\r\n        light: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false, false]\r\n        }),\r\n        severe: new fields.ArrayField(new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        }), {\r\n          required: true,\r\n          initial: [false]\r\n        }),\r\n        incapacitating: new fields.BooleanField({\r\n          required: true,\r\n          initial: false\r\n        })\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    const serverIndex = (this as any).serverIndex || 1;\r\n    \r\n    // Firewall is always 1 for ICEs\r\n    const firewall = 1;\r\n    (this as any).attributes = {\r\n      firewall: firewall\r\n    };\r\n    \r\n    // Threshold equals server index (number of successes)\r\n    (this as any).threshold = serverIndex;\r\n    \r\n    // Calculate damage thresholds based on FW = 1\r\n    // Light: 1, Severe: 2, Incapacitating: 3\r\n    (this as any).damageThresholds = {\r\n      light: 1,\r\n      severe: 2,\r\n      incapacitating: 3\r\n    };\r\n    \r\n    // Calculate damage value based on ICE type and server index\r\n    const iceType = (this as any).iceType || '';\r\n    let damageValue = 0;\r\n    \r\n    if (iceType === 'blaster' || iceType === 'black') {\r\n      // VD = Indice du serveur/2 (arrondi au supérieur)\r\n      damageValue = Math.ceil(serverIndex / 2);\r\n    } else if (iceType === 'killer') {\r\n      // VD = Indice du serveur\r\n      damageValue = serverIndex;\r\n    }\r\n    // Other ICE types don't deal damage\r\n    \r\n    (this as any).damageValue = damageValue;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Skill items\r\n */\r\nexport class SkillDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      rating: new fields.NumberField({\r\n        required: true,\r\n        initial: 1,\r\n        min: 0,\r\n        max: 8,\r\n        integer: true,\r\n        label: \"SRA2.SKILLS.RATING\"\r\n      }),\r\n      linkedAttribute: new fields.StringField({\r\n        required: true,\r\n        initial: \"strength\",\r\n        choices: {\r\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\r\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\r\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\r\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\r\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\r\n        },\r\n        label: \"SRA2.SKILLS.LINKED_ATTRIBUTE\"\r\n      }),\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.SKILLS.BOOKMARKED\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Calculate cost based on rating\r\n    // 2500 per rating up to 5, then 5000 per rating above 5\r\n    const rating = (this as any).rating || 0;\r\n    \r\n    let calculatedCost = 0;\r\n    if (rating <= 5) {\r\n      calculatedCost = rating * 2500;\r\n    } else {\r\n      // First 5 levels at 2500 each, remaining levels at 5000 each\r\n      calculatedCost = 5 * 2500 + (rating - 5) * 5000;\r\n    }\r\n    \r\n    (this as any).calculatedCost = calculatedCost;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Specialization items\r\n * A specialization is linked to a skill and costs 2500 yens\r\n */\r\nexport class SpecializationDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      linkedSkill: new fields.StringField({\r\n        required: true,\r\n        initial: \"\",\r\n        label: \"SRA2.SPECIALIZATIONS.LINKED_SKILL\"\r\n      }),\r\n      linkedAttribute: new fields.StringField({\r\n        required: true,\r\n        initial: \"strength\",\r\n        choices: {\r\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\r\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\r\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\r\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\r\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\r\n        },\r\n        label: \"SRA2.SPECIALIZATIONS.LINKED_ATTRIBUTE\"\r\n      }),\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      bookmarked: new fields.BooleanField({\r\n        required: true,\r\n        initial: false,\r\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Specializations have a fixed cost of 2500 yens\r\n    (this as any).calculatedCost = 2500;\r\n  }\r\n}\r\n\r\n","/**\r\n * Data model for Metatype items\r\n * Metatypes define maximum values for character attributes\r\n */\r\nexport class MetatypeDataModel extends foundry.abstract.TypeDataModel<any, Item> {\r\n  static override defineSchema(): any {\r\n    const fields = foundry.data.fields;\r\n    \r\n    return {\r\n      description: new fields.HTMLField({\r\n        required: true,\r\n        initial: \"\"\r\n      }),\r\n      maxStrength: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_STRENGTH\"\r\n      }),\r\n      maxAgility: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_AGILITY\"\r\n      }),\r\n      maxWillpower: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_WILLPOWER\"\r\n      }),\r\n      maxLogic: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_LOGIC\"\r\n      }),\r\n      maxCharisma: new fields.NumberField({\r\n        required: true,\r\n        initial: 4,\r\n        min: 1,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.MAX_CHARISMA\"\r\n      }),\r\n      anarchyBonus: new fields.NumberField({\r\n        required: true,\r\n        initial: 0,\r\n        min: 0,\r\n        max: 10,\r\n        integer: true,\r\n        label: \"SRA2.METATYPES.ANARCHY_BONUS\"\r\n      }),\r\n      reference: new fields.StringField({\r\n        required: false,\r\n        initial: \"\",\r\n        label: \"SRA2.REFERENCE\"\r\n      })\r\n    };\r\n  }\r\n\r\n  override prepareDerivedData(): void {\r\n    // Metatypes don't have a cost, they're character features\r\n    // No derived data needed for now\r\n  }\r\n}\r\n\r\n","/**\r\n * Custom Actor document for SRA2\r\n */\r\nexport class SRA2Actor<SubType extends Actor.SubType = Actor.SubType> extends Actor<SubType> {\r\n  get feats(): Item[] {\r\n    return this.items.filter((item: Item) => item.type === 'feat');\r\n  }\r\n}","/**\r\n * Shared Item Search Utilities for SRA2\r\n * This module contains common item search functions used across character sheets, NPC sheets, and item sheets.\r\n */\r\n\r\n/**\r\n * Normalize text for search: lowercase and remove accents/special characters\r\n */\r\nexport function normalizeSearchText(text: string): string {\r\n  if (!text) return '';\r\n  return text\r\n    .toLowerCase()\r\n    .normalize('NFD')\r\n    // remove (.*) in normalization\r\n    .replace(/ ?\\(.*\\)/g, '')\r\n    .replace(/[\\u0300-\\u036f]/g, ''); // Remove diacritics\r\n}\r\n\r\n/**\r\n * Check if an item matches the search term by searching in multiple fields\r\n */\r\nfunction itemMatchesSearch(item: any, itemType: string, searchTerm: string, includePackName: boolean = false, packTitle?: string): boolean {\r\n  // First check if item type matches\r\n  if (item.type !== itemType) return false;\r\n  \r\n  const normalizedSearch = normalizeSearchText(searchTerm);\r\n  \r\n  // Search in name\r\n  if (normalizeSearchText(item.name).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in weapon type (for weapons)\r\n  console.log(item.system?.weaponType);\r\n  const weaponType = item.system?.weaponType || item.system?.featType === 'weapon' ? item.system?.weaponType : null;\r\n  if (weaponType && normalizeSearchText(weaponType).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in description\r\n  const description = item.system?.description || '';\r\n  if (description && normalizeSearchText(description).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in linked attack skill\r\n  const linkedAttackSkill = item.system?.linkedAttackSkill || '';\r\n  if (linkedAttackSkill && normalizeSearchText(linkedAttackSkill).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in linked attack specialization\r\n  const linkedAttackSpecialization = item.system?.linkedAttackSpecialization || '';\r\n  if (linkedAttackSpecialization && normalizeSearchText(linkedAttackSpecialization).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  // Search in pack/repertoire name (only if requested)\r\n  if (includePackName && packTitle && normalizeSearchText(packTitle).includes(normalizedSearch)) {\r\n    return true;\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Search result interface\r\n */\r\nexport interface SearchResult {\r\n  name: string;\r\n  uuid: string;\r\n  source: string;\r\n  type: string;\r\n  id?: string;\r\n  alreadyExists?: boolean;\r\n}\r\n\r\n/**\r\n * Search for items in world items\r\n */\r\nexport function searchItemsInWorld(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): SearchResult[] {\r\n  const results: SearchResult[] = [];\r\n  \r\n  if (!game.items) return results;\r\n  \r\n  for (const item of game.items as any) {\r\n    if (itemMatchesSearch(item, itemType, searchTerm)) {\r\n      const alreadyExists = existingItemsCheck ? existingItemsCheck(item.name) : false;\r\n      \r\n      results.push({\r\n        name: item.name,\r\n        uuid: item.uuid,\r\n        id: item.id,\r\n        source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n        type: itemType,\r\n        alreadyExists\r\n      });\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Search for items in actor's items\r\n */\r\nexport function searchItemsOnActor(\r\n  actor: any,\r\n  itemType: string,\r\n  searchTerm: string\r\n): SearchResult[] {\r\n  const results: SearchResult[] = [];\r\n  \r\n  if (!actor) return results;\r\n  \r\n  for (const item of actor.items as any) {\r\n    if (itemMatchesSearch(item, itemType, searchTerm)) {\r\n      results.push({\r\n        name: item.name,\r\n        uuid: item.uuid,\r\n        id: item.id,\r\n        source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n        type: itemType\r\n      });\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Search for items in all compendiums\r\n */\r\nexport async function searchItemsInCompendiums(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): Promise<SearchResult[]> {\r\n  const results: SearchResult[] = [];\r\n  const seenNames = new Set<string>();\r\n  \r\n  // Search in all compendiums\r\n  for (const pack of game.packs as any) {\r\n    // Only search in Item compendiums\r\n    if (pack.documentName !== 'Item') continue;\r\n    \r\n    // Get all documents from the pack\r\n    const documents = await pack.getDocuments();\r\n    \r\n    // Filter for items that match the search term and type\r\n    for (const doc of documents) {\r\n      if (itemMatchesSearch(doc, itemType, searchTerm, true, pack.title)) {\r\n        // Check if not already in results (by name)\r\n        if (seenNames.has(doc.name)) continue;\r\n        seenNames.add(doc.name);\r\n        \r\n        const alreadyExists = existingItemsCheck ? existingItemsCheck(doc.name) : false;\r\n        \r\n        results.push({\r\n          name: doc.name,\r\n          uuid: doc.uuid,\r\n          source: pack.title,\r\n          type: itemType,\r\n          alreadyExists\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Perform a complete search across actor, world, and compendiums\r\n */\r\nexport async function searchItemsEverywhere(\r\n  itemType: string,\r\n  searchTerm: string,\r\n  actor?: any,\r\n  existingItemsCheck?: (itemName: string) => boolean\r\n): Promise<SearchResult[]> {\r\n  const results: SearchResult[] = [];\r\n  const seenNames = new Set<string>();\r\n  \r\n  // 1. Search in actor items if provided\r\n  if (actor) {\r\n    const actorResults = searchItemsOnActor(actor, itemType, searchTerm);\r\n    actorResults.forEach(result => {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    });\r\n  }\r\n  \r\n  // 2. Search in world items\r\n  const worldResults = searchItemsInWorld(itemType, searchTerm, existingItemsCheck);\r\n  worldResults.forEach(result => {\r\n    if (!seenNames.has(result.name)) {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    }\r\n  });\r\n  \r\n  // 3. Search in compendiums\r\n  const compendiumResults = await searchItemsInCompendiums(itemType, searchTerm, existingItemsCheck);\r\n  compendiumResults.forEach(result => {\r\n    if (!seenNames.has(result.name)) {\r\n      results.push(result);\r\n      seenNames.add(result.name);\r\n    }\r\n  });\r\n  \r\n  return results;\r\n}\r\n\r\n/**\r\n * Build HTML for search results display\r\n */\r\nexport interface DisplaySearchResultsOptions {\r\n  results: SearchResult[];\r\n  lastSearchTerm: string;\r\n  noResultsMessage: string;\r\n  typeLabel: string;\r\n  onAddCallback?: (result: SearchResult) => void;\r\n}\r\n\r\nexport function buildSearchResultsHtml(options: DisplaySearchResultsOptions): string {\r\n  const { results, lastSearchTerm, noResultsMessage, typeLabel } = options;\r\n  \r\n  // Check if there's a perfect match (case-insensitive and accent-insensitive)\r\n  const normalizedLastSearch = normalizeSearchText(lastSearchTerm);\r\n  const exactMatch = results.find(r => normalizeSearchText(r.name) === normalizedLastSearch);\r\n  \r\n  let html = '';\r\n  \r\n  if (results.length === 0) {\r\n    html = `\r\n      <div class=\"search-result-item no-results\">\r\n        <div class=\"no-results-text\">\r\n          ${noResultsMessage}\r\n        </div>\r\n      </div>\r\n    `;\r\n  } else {\r\n    // If we have an exact match, highlight it at the top\r\n    if (exactMatch) {\r\n      html += buildSingleResultHtml(exactMatch, typeLabel, true);\r\n    }\r\n    \r\n    // Display other search results\r\n    const otherResults = exactMatch \r\n      ? results.filter(r => r.name !== exactMatch.name)\r\n      : results;\r\n    \r\n    for (const result of otherResults) {\r\n      html += buildSingleResultHtml(result, typeLabel, false);\r\n    }\r\n  }\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Build HTML for a single search result\r\n */\r\nfunction buildSingleResultHtml(result: SearchResult, typeLabel: string, isExactMatch: boolean): string {\r\n  const alreadyExistsClass = result.alreadyExists ? 'already-exists' : '';\r\n  const exactMatchClass = isExactMatch ? 'exact-match' : '';\r\n  \r\n  let html = `\r\n    <div class=\"search-result-item ${alreadyExistsClass} ${exactMatchClass}\" \r\n         data-result-name=\"${result.name}\" \r\n         data-result-uuid=\"${result.uuid}\">\r\n      <div class=\"result-info\">\r\n        <span class=\"result-name\">${result.name}</span>\r\n        <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\r\n      </div>\r\n  `;\r\n  \r\n  if (result.alreadyExists) {\r\n    html += `\r\n      <span class=\"already-exists-label\">\r\n        ${game.i18n!.localize('SRA2.SKILLS.ALREADY_EXISTS')}\r\n      </span>\r\n    `;\r\n  } else {\r\n    html += `\r\n      <button class=\"add-item-btn\" \r\n              data-item-name=\"${result.name}\" \r\n              data-item-uuid=\"${result.uuid}\">\r\n        ${game.i18n!.localize('SRA2.SKILLS.ADD')}\r\n      </button>\r\n    `;\r\n  }\r\n  \r\n  html += `</div>`;\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Create a debounced search function\r\n */\r\nexport function createDebouncedSearch(\r\n  searchFunction: (searchTerm: string) => Promise<void>,\r\n  delay: number = 300\r\n): (searchTerm: string) => void {\r\n  let timeoutId: any = null;\r\n  \r\n  return (searchTerm: string) => {\r\n    if (timeoutId) {\r\n      clearTimeout(timeoutId);\r\n    }\r\n    \r\n    timeoutId = setTimeout(async () => {\r\n      await searchFunction(searchTerm);\r\n    }, delay);\r\n  };\r\n}\r\n\r\n/**\r\n * Show or hide search results container\r\n */\r\nexport function toggleSearchResults(resultsDiv: HTMLElement, show: boolean): void {\r\n  if (show) {\r\n    resultsDiv.style.display = 'block';\r\n  } else {\r\n    resultsDiv.style.display = 'none';\r\n  }\r\n}\r\n\r\n/**\r\n * Check if an item already exists on an actor\r\n */\r\nexport function itemExistsOnActor(actor: any, itemType: string, itemName: string): boolean {\r\n  if (!actor) return false;\r\n  \r\n  return actor.items.some((item: any) => \r\n    item.type === itemType && item.name === itemName\r\n  );\r\n}\r\n\r\n/**\r\n * Add an item to an actor from UUID\r\n */\r\nexport async function addItemToActorFromUuid(actor: any, itemUuid: string): Promise<boolean> {\r\n  try {\r\n    const item = await fromUuid(itemUuid as any);\r\n    if (!item) {\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ITEM_NOT_FOUND'));\r\n      return false;\r\n    }\r\n    \r\n    // Check if item already exists\r\n    if (itemExistsOnActor(actor, (item as any).type, (item as any).name)) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.ALREADY_EXISTS', { name: (item as any).name }));\r\n      return false;\r\n    }\r\n    \r\n    // Add the item to the actor\r\n    await actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n    ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.ADDED', { name: (item as any).name }));\r\n    \r\n    return true;\r\n  } catch (error) {\r\n    console.error('SRA2 | Error adding item to actor:', error);\r\n    ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ERROR_ADDING'));\r\n    return false;\r\n  }\r\n}\r\n\r\n","/**\r\n * Shared Dice Rolling Utilities for SRA2\r\n * This module contains common dice rolling functions used across character sheets, NPC sheets, and item sheets.\r\n */\r\n\r\n// Roll is available globally in FoundryVTT\r\ndeclare const Roll: any;\r\ndeclare const renderTemplate: any;\r\ndeclare const ChatMessage: any;\r\n\r\n// Import ItemSearch for text normalization\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * RR source information\r\n */\r\nexport interface RRSource {\r\n  featName: string;\r\n  rrValue: number;\r\n}\r\n\r\n/**\r\n * Risk reduction constants\r\n */\r\nexport const RISK_DICE_BY_RR = [2, 5, 8, 12];\r\n\r\nexport const RISK_THRESHOLDS = {\r\n  0: { normal: 2, fort: 4, extreme: 6 },\r\n  1: { normal: 5, fort: 7, extreme: 9 },\r\n  2: { normal: 8, fort: 11, extreme: 13 },\r\n  3: { normal: 12, fort: 15, extreme: 999 }\r\n};\r\n\r\n/**\r\n * Get risk dice count based on RR level\r\n */\r\nexport function getRiskDiceByRR(rr: number): number {\r\n  return RISK_DICE_BY_RR[Math.min(3, Math.max(0, rr))] || 2;\r\n}\r\n\r\n/**\r\n * Get RR sources from an actor for a specific item type and name\r\n * This is the main function used by most sheets for their own actor\r\n */\r\nexport function getRRSources(\r\n  actor: any,\r\n  itemType: 'skill' | 'specialization' | 'attribute',\r\n  itemName: string\r\n): RRSource[] {\r\n  const sources: RRSource[] = [];\r\n  \r\n  // Get all active feats from the actor\r\n  const feats = actor.items.filter((item: any) => \r\n    item.type === 'feat' && \r\n    item.system.active === true\r\n  );\r\n  \r\n  // Calculate RR from feats that target this item\r\n  for (const feat of feats) {\r\n    const featSystem = feat.system as any;\r\n    const rrList = featSystem.rrList || [];\r\n    \r\n    // Loop through all RR entries in this feat\r\n    for (const rrEntry of rrList) {\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      // Check if this RR entry provides RR for the given item\r\n      if (rrType === itemType && rrTarget === itemName && rrValue > 0) {\r\n        sources.push({\r\n          featName: feat.name,\r\n          rrValue: rrValue\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return sources;\r\n}\r\n\r\n/**\r\n * Get RR sources from any actor for a specific item type and name\r\n * This is useful for defense rolls where we need to check another actor's RR\r\n * (identical to getRRSources but kept separate for clarity in combat scenarios)\r\n */\r\nexport function getRRSourcesForActor(\r\n  actor: any,\r\n  itemType: 'skill' | 'specialization' | 'attribute',\r\n  itemName: string\r\n): RRSource[] {\r\n  return getRRSources(actor, itemType, itemName);\r\n}\r\n\r\n/**\r\n * Get success threshold based on roll mode\r\n */\r\nexport function getSuccessThreshold(mode: string): number {\r\n  switch (mode) {\r\n    case 'advantage': return 4;  // 4, 5, 6 = success\r\n    case 'disadvantage': return 6; // only 6 = success\r\n    default: return 5;  // 5, 6 = success\r\n  }\r\n}\r\n\r\n/**\r\n * Build RR sources HTML for dialog\r\n */\r\nexport function buildRRSourcesHtml(rrSources: RRSource[]): string {\r\n  if (rrSources.length === 0) return '';\r\n  \r\n  let html = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\r\n  rrSources.forEach((source) => {\r\n    html += `\r\n      <label class=\"rr-source-item\">\r\n        <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\r\n        <span>${source.featName} (+${source.rrValue})</span>\r\n      </label>`;\r\n  });\r\n  html += '</div>';\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * Roll Request Data Interface\r\n * Contains all information needed for a roll request\r\n */\r\nexport interface RollRequestData {\r\n  // Item information\r\n  itemType?: string;\r\n  weaponType?: string;\r\n  itemName?: string;\r\n  itemId?: string;\r\n  itemRating?: number;\r\n  itemActive?: boolean;\r\n  \r\n  // Linked skills (merged from weapon types and custom fields)\r\n  linkedAttackSkill?: string;\r\n  linkedAttackSpecialization?: string;\r\n  linkedDefenseSkill?: string;\r\n  linkedDefenseSpecialization?: string;\r\n  linkedAttribute?: string;\r\n  \r\n  // Weapon properties\r\n  isWeaponFocus?: boolean;\r\n  damageValue?: string;  // FINAL damage value (base + bonus)\r\n  damageValueBonus?: number;  // Bonus from feat\r\n  meleeRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\r\n  shortRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\r\n  mediumRange?: string; // \"none\" | \"ok\" | \"disadvantage\"\r\n  longRange?: string;   // \"none\" | \"ok\" | \"disadvantage\"\r\n  \r\n  // Skill/Spec information (undefined if not found)\r\n  skillName?: string;\r\n  specName?: string;\r\n  skillLevel?: number;\r\n  specLevel?: number;\r\n  \r\n  // Defense Skill/Spec information (for defense rolls)\r\n  defenseSkillName?: string;\r\n  defenseSpecName?: string;\r\n  defenseSkillLevel?: number;\r\n  defenseSpecLevel?: number;\r\n  defenseLinkedAttribute?: string;\r\n  \r\n  // NPC threshold (when not rolling dice)\r\n  threshold?: number;\r\n  \r\n  // Actor information\r\n  actorId?: string;\r\n  actorUuid?: string;\r\n  actorName?: string;\r\n  \r\n  // Token information\r\n  attackerTokenUuid?: string;\r\n  defenderTokenUuid?: string;\r\n  \r\n  // RR List\r\n  rrList?: any[];\r\n  \r\n  // Risk dice count (number of risk dice selected)\r\n  riskDiceCount?: number;\r\n  \r\n  // Final calculated values\r\n  finalRR?: number;\r\n  dicePool?: number;\r\n  \r\n  // Roll mode\r\n  rollMode?: 'normal' | 'disadvantage' | 'advantage';\r\n  \r\n  // Defense/Counter-attack flags\r\n  isDefend?: boolean;\r\n  isCounterAttack?: boolean;\r\n  \r\n  // Spell-specific properties\r\n  spellType?: 'direct' | 'indirect';  // For spells: 'direct' or 'indirect'\r\n  isSpellDirect?: boolean;  // Flag for direct spells (no defense allowed)\r\n  \r\n  // Attack roll data (for defense/counter-attack rolls)\r\n  attackRollResult?: RollResult;\r\n  attackRollData?: RollRequestData;\r\n  availableWeapons?: Array<{\r\n    id: string;\r\n    name: string;\r\n    linkedAttackSkill: string;\r\n    damageValue: string;\r\n    damageValueBonus: number;\r\n    weaponType?: string;\r\n    meleeRange?: string;\r\n  }>;\r\n  selectedWeaponId?: string; // ID of selected weapon for counter-attack\r\n}\r\n\r\n/**\r\n * Handle roll request - central function for all roll clicks\r\n * Displays a roll dialog with roll information\r\n */\r\nexport function handleRollRequest(data: RollRequestData): void {\r\n  console.log('=== ROLL REQUEST ===', {\r\n    itemType: data.itemType,\r\n    weaponType: data.weaponType,\r\n    linkedAttackSkill: data.linkedAttackSkill,\r\n    linkedAttackSpecialization: data.linkedAttackSpecialization,\r\n    linkedDefenseSkill: data.linkedDefenseSkill,\r\n    linkedDefenseSpecialization: data.linkedDefenseSpecialization,\r\n    linkedAttribute: data.linkedAttribute,\r\n    isWeaponFocus: data.isWeaponFocus,\r\n    damageValue: data.damageValue,\r\n    damageValueBonus: data.damageValueBonus,\r\n    meleeRange: data.meleeRange,\r\n    shortRange: data.shortRange,\r\n    mediumRange: data.mediumRange,\r\n    longRange: data.longRange,\r\n    skillName: data.skillName,\r\n    specName: data.specName,\r\n    itemName: data.itemName,\r\n    itemId: data.itemId,\r\n    threshold: data.threshold,\r\n    actorId: data.actorId,\r\n    actorUuid: data.actorUuid,\r\n    actorName: data.actorName,\r\n    specLevel: data.specLevel,\r\n    skillLevel: data.skillLevel,\r\n    itemRating: data.itemRating,\r\n    itemActive: data.itemActive,\r\n    rrList: data.rrList\r\n  });\r\n\r\n  // Import RollDialog dynamically to avoid circular dependencies\r\n  import('../applications/roll-dialog.js').then((module) => {\r\n    const dialog = new module.RollDialog(data);\r\n    dialog.render(true);\r\n  });\r\n}\r\n\r\n/**\r\n * Roll result interface\r\n */\r\nexport interface RollResult {\r\n  normalDice: number[];\r\n  riskDice: number[];\r\n  normalSuccesses: number;\r\n  riskSuccesses: number;\r\n  totalSuccesses: number;\r\n  criticalFailures: number;\r\n  finalRR: number;\r\n  remainingFailures: number;\r\n  complication: 'none' | 'minor' | 'critical' | 'disaster';\r\n}\r\n\r\n/**\r\n * Execute a dice roll with DiceSoNice support\r\n * Steps 2-5: Roll dice, calculate results, complications, and create chat message\r\n */\r\nexport async function executeRoll(\r\n  attacker: any,\r\n  defender: any,\r\n  attackerToken: any,\r\n  defenderToken: any,\r\n  rollData: RollRequestData\r\n): Promise<void> {\r\n  if (!attacker) {\r\n    console.error('No attacker provided for roll');\r\n    return;\r\n  }\r\n\r\n  // Log token information\r\n  console.log('=== EXECUTE ROLL ===');\r\n  console.log('Attacker:', attacker?.name || 'Unknown');\r\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\r\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n  console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || rollData.attackerTokenUuid || 'Unknown');\r\n  if (attackerToken?.actor) {\r\n    console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n  }\r\n  console.log('Defender:', defender?.name || 'None');\r\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\r\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n  console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || rollData.defenderTokenUuid || 'Unknown');\r\n  if (defenderToken?.actor) {\r\n    console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n  }\r\n  console.log('===================');\r\n\r\n  const dicePool = rollData.dicePool || 0;\r\n  const riskDiceCount = rollData.riskDiceCount || 0;\r\n  const normalDiceCount = Math.max(0, dicePool - riskDiceCount);\r\n  const rollMode = rollData.rollMode || 'normal';\r\n  const finalRR = Math.min(3, rollData.finalRR || 0);\r\n  const threshold = rollData.threshold;\r\n\r\n  // If threshold is defined, use it instead of rolling dice\r\n  let rollResult: RollResult;\r\n  if (threshold !== undefined) {\r\n    // Apply threshold: number of successes equals threshold\r\n    rollResult = {\r\n      normalDice: [],\r\n      riskDice: [],\r\n      normalSuccesses: threshold,\r\n      riskSuccesses: 0,\r\n      totalSuccesses: threshold,\r\n      criticalFailures: 0,\r\n      finalRR: finalRR,\r\n      remainingFailures: 0,\r\n      complication: 'none'\r\n    };\r\n  } else {\r\n  // Step 2: Create and roll dice\r\n  let normalRoll: any = null;\r\n  let riskRoll: any = null;\r\n\r\n  // Roll normal dice\r\n  if (normalDiceCount > 0) {\r\n    normalRoll = new Roll(`${normalDiceCount}d6`);\r\n    await normalRoll.evaluate();\r\n    \r\n    // Show DiceSoNice animation for normal dice\r\n    if ((game as any).dice3d && normalRoll) {\r\n      (game as any).dice3d.showForRoll(normalRoll, game.user, true, null, false);\r\n    }\r\n  }\r\n\r\n  // Roll risk dice with purple color\r\n  if (riskDiceCount > 0) {\r\n    riskRoll = new Roll(`${riskDiceCount}d6`);\r\n    await riskRoll.evaluate();\r\n    \r\n    // Show DiceSoNice animation for risk dice with purple color\r\n    if ((game as any).dice3d && riskRoll) {\r\n      const dice3dConfig = {\r\n        colorset: 'purple',\r\n        theme: 'default'\r\n      };\r\n      (game as any).dice3d.showForRoll(riskRoll, game.user, true, dice3dConfig, false);\r\n    }\r\n  }\r\n\r\n  // Step 3: Calculate results\r\n  const normalResults: number[] = normalRoll ? (normalRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n  const riskResults: number[] = riskRoll ? (riskRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n  \r\n  // Calculate successes for normal dice\r\n  let normalSuccesses = 0;\r\n  for (const result of normalResults) {\r\n    if (rollMode === 'advantage' && result >= 4) {\r\n      normalSuccesses++;\r\n    } else if (rollMode === 'disadvantage' && result === 6) {\r\n      normalSuccesses++;\r\n    } else if (rollMode === 'normal' && result >= 5) {\r\n      normalSuccesses++;\r\n    }\r\n  }\r\n\r\n  // Calculate successes and critical failures for risk dice\r\n  let riskSuccesses = 0;\r\n  let criticalFailures = 0;\r\n  for (const result of riskResults) {\r\n    if (result === 1) {\r\n      criticalFailures++;\r\n    } else if (rollMode === 'advantage' && result >= 4) {\r\n      riskSuccesses++;\r\n    } else if (rollMode === 'disadvantage' && result === 6) {\r\n      riskSuccesses++;\r\n    } else if (rollMode === 'normal' && result >= 5) {\r\n      riskSuccesses++;\r\n    }\r\n  }\r\n\r\n  // Risk dice successes count double\r\n  const totalRiskSuccesses = riskSuccesses * 2;\r\n  const totalSuccesses = normalSuccesses + totalRiskSuccesses;\r\n\r\n  // Step 4: Calculate complications\r\n  const remainingFailures = Math.max(0, criticalFailures - finalRR);\r\n  \r\n  let complication: 'none' | 'minor' | 'critical' | 'disaster' = 'none';\r\n  if (remainingFailures === 1) {\r\n    complication = 'minor';\r\n  } else if (remainingFailures === 2) {\r\n    complication = 'critical';\r\n  } else if (remainingFailures >= 3) {\r\n    complication = 'disaster';\r\n  }\r\n\r\n    rollResult = {\r\n    normalDice: normalResults,\r\n    riskDice: riskResults,\r\n    normalSuccesses: normalSuccesses,\r\n    riskSuccesses: riskSuccesses,\r\n    totalSuccesses: totalSuccesses,\r\n    criticalFailures: criticalFailures,\r\n    finalRR: finalRR,\r\n    remainingFailures: remainingFailures,\r\n    complication: complication\r\n  };\r\n  }\r\n\r\n  // Step 5: Create chat message\r\n  await createRollChatMessage(attacker, defender, attackerToken, defenderToken, rollData, rollResult);\r\n}\r\n\r\n/**\r\n * Create chat message for roll result\r\n * Step 5: Display roll results in chat\r\n */\r\nasync function createRollChatMessage(\r\n  attacker: any,\r\n  defender: any,\r\n  attackerToken: any,\r\n  defenderToken: any,\r\n  rollData: RollRequestData,\r\n  rollResult: RollResult\r\n): Promise<void> {\r\n  // Determine if this is an attack\r\n  const isAttack = rollData.itemType === 'weapon' || \r\n                   rollData.weaponType !== undefined ||\r\n                   (rollData.meleeRange || rollData.shortRange || rollData.mediumRange || rollData.longRange);\r\n\r\n  // Log token information\r\n  console.log('=== CREATE ROLL CHAT MESSAGE ===');\r\n  console.log('Attacker:', attacker?.name || 'Unknown');\r\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\r\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n  \r\n  // Get attacker token UUID (priority: token > rollData)\r\n  let attackerTokenUuid: string | undefined = undefined;\r\n  if (attackerToken) {\r\n    attackerTokenUuid = attackerToken.uuid || attackerToken.document?.uuid || undefined;\r\n    console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\r\n    // If token exists, use token's actor UUID (for NPCs)\r\n    if (attackerToken.actor) {\r\n      console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n    }\r\n  } else if (rollData.attackerTokenUuid) {\r\n    attackerTokenUuid = rollData.attackerTokenUuid;\r\n    console.log('Attacker Token UUID (from rollData):', attackerTokenUuid);\r\n  }\r\n  \r\n  // Determine final attacker UUID: if token exists, use token's actor UUID, otherwise use actor UUID\r\n  const finalAttackerUuid = attackerToken?.actor?.uuid || attacker?.uuid;\r\n  console.log('Final Attacker UUID (token actor or actor):', finalAttackerUuid || 'Unknown');\r\n  \r\n  console.log('Defender:', defender?.name || 'None');\r\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\r\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n  \r\n  // Get defender token UUID (priority: token > rollData)\r\n  let defenderTokenUuid: string | undefined = undefined;\r\n  if (defenderToken) {\r\n    defenderTokenUuid = defenderToken.uuid || defenderToken.document?.uuid || undefined;\r\n    console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\r\n    // If token exists, use token's actor UUID (for NPCs)\r\n    if (defenderToken.actor) {\r\n      console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n    }\r\n  } else if (rollData.defenderTokenUuid) {\r\n    defenderTokenUuid = rollData.defenderTokenUuid;\r\n    console.log('Defender Token UUID (from rollData):', defenderTokenUuid);\r\n  }\r\n  \r\n  // Determine final defender UUID: if token exists, use token's actor UUID, otherwise use actor UUID\r\n  const finalDefenderUuid = defenderToken?.actor?.uuid || defender?.uuid;\r\n  console.log('Final Defender UUID (token actor or actor):', finalDefenderUuid || 'Unknown');\r\n  console.log('--- UUIDs to be stored in flags ---');\r\n  console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\r\n  console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\r\n  console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\r\n  console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\r\n  console.log('================================');\r\n\r\n  // Prepare defender data with token image if available\r\n  let defenderData: any = null;\r\n  if (defender) {\r\n    // Get token image - try different ways to access it depending on Foundry version\r\n    let tokenImg = defender.img; // fallback to actor image\r\n    if (defenderToken) {\r\n      // FoundryVTT v13: token.document.texture.src or token.document.img\r\n      tokenImg = (defenderToken as any).document?.texture?.src || \r\n                 (defenderToken as any).document?.img || \r\n                 (defenderToken as any).data?.img || \r\n                 (defenderToken as any).texture?.src ||\r\n                 defender.img;\r\n    }\r\n    \r\n    defenderData = {\r\n      ...defender,\r\n      img: tokenImg\r\n    };\r\n  }\r\n\r\n  // Handle defense/counter-attack rolls\r\n  let defenseResult: any = null;\r\n  let calculatedDamage: number | null = null;\r\n  let attackFailed: boolean = false;\r\n  \r\n  if (rollData.isDefend && rollData.attackRollResult && rollData.attackRollData) {\r\n    // Defense roll: compare with attack\r\n    // For defense: attacker = defender (one defending), defender = original attacker\r\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\r\n    const defenseSuccesses = rollResult.totalSuccesses;\r\n    \r\n    // Check if this is an ICE attack\r\n    const isIceAttack = rollData.attackRollData.itemType === 'ice-attack' || rollData.attackRollData.iceType;\r\n    const iceType = rollData.attackRollData.iceType;\r\n    \r\n    // Get actor names (use token name if available, otherwise actor name)\r\n    const originalAttackerName = defenderToken?.name || defender?.name || 'Inconnu';\r\n    const defenderName = attackerToken?.name || attacker?.name || 'Inconnu';\r\n    \r\n    if (attackSuccesses >= defenseSuccesses) {\r\n      // Attack succeeds\r\n      if (isIceAttack) {\r\n        // For ICE attacks, calculate damage based on type\r\n        let damageValue = 0;\r\n        const iceDamageValue = rollData.attackRollData.iceDamageValue || 0;\r\n        \r\n        // ICE damage calculation: VD + (succès ICE - succès défense)\r\n        // But for some ICE types, there's no damage, only effects\r\n        if (iceType === 'blaster' || iceType === 'black' || iceType === 'killer') {\r\n          damageValue = iceDamageValue + attackSuccesses - defenseSuccesses;\r\n        }\r\n        // Other ICE types (acid, blocker, glue, tracker) don't deal damage\r\n        \r\n        calculatedDamage = damageValue;\r\n        attackFailed = false;\r\n      } else {\r\n        // Normal attack damage calculation\r\n        let damageValue = 0;\r\n        const damageValueStr = rollData.attackRollData.damageValue || '0';\r\n        \r\n        // Handle \"FOR\" or \"FOR+X\" damage values\r\n        if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\r\n          // Get original attacker's strength (defender in defense context is the original attacker)\r\n          const attackerStrength = (defender?.system as any)?.attributes?.strength || 1;\r\n          if (damageValueStr === 'FOR') {\r\n            damageValue = attackerStrength;\r\n          } else if (damageValueStr.startsWith('FOR+')) {\r\n            const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n            damageValue = attackerStrength + bonus;\r\n          }\r\n        } else {\r\n          damageValue = parseInt(damageValueStr, 10) || 0;\r\n        }\r\n        \r\n        calculatedDamage = damageValue + attackSuccesses - defenseSuccesses;\r\n        attackFailed = false;\r\n      }\r\n    } else {\r\n      // Attack fails\r\n      attackFailed = true;\r\n      calculatedDamage = 0;\r\n    }\r\n    \r\n    // For defense: attacker = defender (one defending), defender = original attacker\r\n    // If attack succeeds, original attacker (defender in context) inflicts damage to defender (attacker in context)\r\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in defense context\r\n    const defenderUuid = finalAttackerUuid; // Defender is attacker in defense context\r\n    \r\n    console.log('Defense: Attack succeeds - original attacker inflicts damage to defender');\r\n    console.log('  Original attacker (inflicter):', originalAttackerName, '(', originalAttackerUuid, ')');\r\n    console.log('  Defender (receiver):', defenderName, '(', defenderUuid, ')');\r\n    \r\n    defenseResult = {\r\n      attackSuccesses: attackSuccesses,\r\n      defenseSuccesses: defenseSuccesses,\r\n      calculatedDamage: calculatedDamage,\r\n      attackFailed: attackFailed,\r\n      originalAttackerName: originalAttackerName,\r\n      defenderName: defenderName,\r\n      // UUIDs for applying damage\r\n      originalAttackerUuid: originalAttackerUuid, // Who inflicts damage if attack succeeds\r\n      defenderUuid: defenderUuid, // Who receives damage if attack succeeds\r\n      // ICE-specific fields\r\n      isIceAttack: isIceAttack,\r\n      iceType: iceType\r\n    };\r\n  } else if (rollData.isCounterAttack && rollData.attackRollResult && rollData.attackRollData) {\r\n    // Counter-attack: compare with original attack\r\n    // In counter-attack context:\r\n    // - attacker = original defender (the one doing counter-attack)\r\n    // - defender = original attacker (the one being counter-attacked)\r\n    \r\n    // Get actor names (use token name if available, otherwise actor name)\r\n    // For original attacker (defender in counter-attack context)\r\n    // Try: token.document.name, token.name, token.actor.name, actor.name\r\n    const originalAttackerName = defenderToken?.document?.name || \r\n                                  (defenderToken as any)?.name || \r\n                                  defenderToken?.actor?.name || \r\n                                  defender?.name || \r\n                                  'Inconnu';\r\n    // For original defender/counter-attacker (attacker in counter-attack context)\r\n    const originalDefenderName = attackerToken?.document?.name || \r\n                                  (attackerToken as any)?.name || \r\n                                  attackerToken?.actor?.name || \r\n                                  attacker?.name || \r\n                                  'Inconnu';\r\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\r\n    const counterAttackSuccesses = rollResult.totalSuccesses;\r\n    \r\n    // Get damage values for the original attacker\r\n    // damageValue already includes bonus (finalDamageValue)\r\n    let attackDamageValue = 0;\r\n    const attackDamageValueStr = rollData.attackRollData.damageValue || '0';\r\n    \r\n    // Handle \"FOR\" or \"FOR+X\" damage values for the attacker (defender in counter-attack context)\r\n    if (attackDamageValueStr === 'FOR' || attackDamageValueStr.startsWith('FOR+')) {\r\n      const attackerStrength = (defender?.system as any)?.attributes?.strength || 1; // defender = original attacker\r\n      if (attackDamageValueStr === 'FOR') {\r\n        attackDamageValue = attackerStrength;\r\n      } else if (attackDamageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(attackDamageValueStr.substring(4)) || 0;\r\n        attackDamageValue = attackerStrength + bonus;\r\n      }\r\n    } else {\r\n      attackDamageValue = parseInt(attackDamageValueStr, 10) || 0;\r\n    }\r\n    \r\n    // Get counter-attack damage value from rollData\r\n    // rollData.damageValue should already be set from the selected weapon (includes bonus)\r\n    let counterAttackDamageValue = 0;\r\n    const damageValueStr = rollData.damageValue || '0';\r\n    \r\n    // Handle \"FOR\" or \"FOR+X\" damage values\r\n    if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\r\n      const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\r\n      if (damageValueStr === 'FOR') {\r\n        counterAttackDamageValue = actorStrength;\r\n      } else if (damageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n        counterAttackDamageValue = actorStrength + bonus;\r\n      }\r\n    } else {\r\n      counterAttackDamageValue = parseInt(damageValueStr, 10) || 0;\r\n    }\r\n    \r\n    // If still no damage value, try to find weapon (fallback)\r\n    if (!counterAttackDamageValue && attacker) {\r\n      // Find weapon matching the counter-attack skill/item\r\n      const selectedWeaponId = (rollData as any).selectedWeaponId;\r\n      if (selectedWeaponId) {\r\n          const weapon = attacker.items.find((item: any) => item.id === selectedWeaponId);\r\n          if (weapon) {\r\n            const weaponSystem = weapon.system as any;\r\n            // Calculate finalDamageValue from weapon (same logic as character-sheet.ts)\r\n            const baseDamageValue = weaponSystem.damageValue || '0';\r\n            const damageValueBonus = weaponSystem.damageValueBonus || 0;\r\n            let weaponDamageValueStr = baseDamageValue;\r\n            \r\n            if (damageValueBonus > 0 && baseDamageValue !== '0') {\r\n              if (baseDamageValue === 'FOR') {\r\n                weaponDamageValueStr = `FOR+${damageValueBonus}`;\r\n              } else if (baseDamageValue.startsWith('FOR+')) {\r\n                const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\r\n                weaponDamageValueStr = `FOR+${baseModifier + damageValueBonus}`;\r\n              } else if (baseDamageValue !== 'toxin') {\r\n                const baseValue = parseInt(baseDamageValue) || 0;\r\n                weaponDamageValueStr = (baseValue + damageValueBonus).toString();\r\n              }\r\n            }\r\n            \r\n            if (weaponDamageValueStr === 'FOR' || weaponDamageValueStr.startsWith('FOR+')) {\r\n              const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\r\n              if (weaponDamageValueStr === 'FOR') {\r\n                counterAttackDamageValue = actorStrength;\r\n              } else if (weaponDamageValueStr.startsWith('FOR+')) {\r\n                const bonus = parseInt(weaponDamageValueStr.substring(4)) || 0;\r\n                counterAttackDamageValue = actorStrength + bonus;\r\n              }\r\n            } else {\r\n              counterAttackDamageValue = parseInt(weaponDamageValueStr, 10) || 0;\r\n            }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Determine winner and calculate damage\r\n    let attackerDamage = 0;\r\n    let defenderDamage = 0;\r\n    let isTie = false;\r\n    let winner: 'attacker' | 'defender' | 'tie' = 'tie';\r\n    \r\n    if (attackSuccesses > counterAttackSuccesses) {\r\n      // Attacker wins\r\n      winner = 'attacker';\r\n      attackerDamage = attackDamageValue + attackSuccesses - counterAttackSuccesses;\r\n    } else if (counterAttackSuccesses > attackSuccesses) {\r\n      // Defender (counter-attacker) wins\r\n      winner = 'defender';\r\n      defenderDamage = counterAttackDamageValue + counterAttackSuccesses - attackSuccesses;\r\n    } else {\r\n      // Tie\r\n      isTie = true;\r\n      winner = 'tie';\r\n    }\r\n    \r\n    console.log('=== COUNTER-ATTACK RESULTS ===');\r\n    console.log('Attack Successes:', attackSuccesses);\r\n    console.log('Counter-Attack Successes:', counterAttackSuccesses);\r\n    console.log('Attack Damage Value:', attackDamageValue);\r\n    console.log('Counter-Attack Damage Value:', counterAttackDamageValue);\r\n    console.log('Winner:', winner);\r\n    console.log('Attacker Damage:', attackerDamage);\r\n    console.log('Defender Damage:', defenderDamage);\r\n    console.log('Original Attacker Name:', originalAttackerName);\r\n    console.log('Original Defender Name:', originalDefenderName);\r\n    console.log('--- Context ---');\r\n    console.log('Attacker param:', attacker?.name);\r\n    console.log('Defender param:', defender?.name);\r\n    console.log('AttackerToken object:', attackerToken ? 'Found' : 'Not found');\r\n    console.log('AttackerToken.name:', (attackerToken as any)?.name);\r\n    console.log('AttackerToken.document?.name:', attackerToken?.document?.name);\r\n    console.log('AttackerToken.actor?.name:', attackerToken?.actor?.name);\r\n    console.log('DefenderToken object:', defenderToken ? 'Found' : 'Not found');\r\n    console.log('DefenderToken.name:', (defenderToken as any)?.name);\r\n    console.log('DefenderToken.document?.name:', defenderToken?.document?.name);\r\n    console.log('DefenderToken.actor?.name:', defenderToken?.actor?.name);\r\n    console.log('--- UUIDs to be stored in flags ---');\r\n    console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\r\n    console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\r\n    console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\r\n    console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\r\n    console.log('==============================');\r\n    \r\n    // For counter-attack: attacker = counter-attacker (original defender), defender = original attacker\r\n    // Winner is determined by who has more successes\r\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in counter-attack context\r\n    const originalDefenderUuid = finalAttackerUuid; // Original defender/counter-attacker is attacker in counter-attack context\r\n    \r\n    // Determine who inflicts damage based on winner\r\n    let damageInflicterUuid: string | undefined = undefined;\r\n    let damageReceiverUuid: string | undefined = undefined;\r\n    let damageInflicterName: string = '';\r\n    let damageReceiverName: string = '';\r\n    \r\n    if (winner === 'attacker') {\r\n      // Original attacker wins (attackSuccesses > counterAttackSuccesses)\r\n      // Original attacker inflicts damage to counter-attacker\r\n      damageInflicterUuid = originalAttackerUuid;\r\n      damageReceiverUuid = originalDefenderUuid;\r\n      damageInflicterName = originalAttackerName;\r\n      damageReceiverName = originalDefenderName;\r\n      console.log('Counter-attack: Original attacker wins - inflicts damage to counter-attacker');\r\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\r\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\r\n    } else if (winner === 'defender') {\r\n      // Counter-attacker wins (counterAttackSuccesses > attackSuccesses)\r\n      // Counter-attacker inflicts damage to original attacker\r\n      damageInflicterUuid = originalDefenderUuid;\r\n      damageReceiverUuid = originalAttackerUuid;\r\n      damageInflicterName = originalDefenderName;\r\n      damageReceiverName = originalAttackerName;\r\n      console.log('Counter-attack: Counter-attacker wins - inflicts damage to original attacker');\r\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\r\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\r\n    }\r\n    \r\n    defenseResult = {\r\n      attackSuccesses: attackSuccesses,\r\n      counterAttackSuccesses: counterAttackSuccesses,\r\n      winner: winner,\r\n      attackerDamage: attackerDamage,\r\n      defenderDamage: defenderDamage,\r\n      isTie: isTie,\r\n      originalAttackerName: originalAttackerName,\r\n      originalDefenderName: originalDefenderName,\r\n      // UUIDs for applying damage\r\n      originalAttackerUuid: originalAttackerUuid,\r\n      originalDefenderUuid: originalDefenderUuid,\r\n      damageInflicterUuid: damageInflicterUuid,\r\n      damageReceiverUuid: damageReceiverUuid,\r\n      damageInflicterName: damageInflicterName,\r\n      damageReceiverName: damageReceiverName\r\n    };\r\n  }\r\n\r\n  // Prepare template data\r\n  // Create attacker and defender objects with correct UUIDs (token actor UUID for NPCs)\r\n  const attackerWithUuid = attacker ? {\r\n    ...attacker,\r\n    uuid: finalAttackerUuid || attacker.uuid // Use calculated UUID (token actor UUID for NPCs)\r\n  } : null;\r\n  \r\n  const defenderWithUuid = defenderData ? {\r\n    ...defenderData,\r\n    uuid: finalDefenderUuid || defenderData.uuid // Use calculated UUID (token actor UUID for NPCs)\r\n  } : null;\r\n  \r\n  const templateData: any = {\r\n    attacker: attackerWithUuid,\r\n    defender: defenderWithUuid,\r\n    rollData: rollData,\r\n    rollResult: rollResult,\r\n    isAttack: isAttack,\r\n    isDefend: rollData.isDefend || false,\r\n    isCounterAttack: rollData.isCounterAttack || false,\r\n    skillName: rollData.specName || rollData.skillName || rollData.linkedAttackSkill || 'Unknown',\r\n    itemName: rollData.itemName,\r\n    damageValue: rollData.damageValue,\r\n    defenseResult: defenseResult,\r\n    // Also pass UUIDs directly for template convenience\r\n    attackerUuid: finalAttackerUuid,\r\n    defenderUuid: finalDefenderUuid,\r\n    attackerTokenUuid: attackerTokenUuid,\r\n    defenderTokenUuid: defenderTokenUuid,\r\n    // Spell-specific flags\r\n    isSpellDirect: rollData.isSpellDirect || false\r\n  };\r\n\r\n  // Render template\r\n  const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n\r\n  // Create chat message\r\n  const messageData: any = {\r\n    user: game.user?.id,\r\n    speaker: {\r\n      actor: attacker?.id,\r\n      alias: attacker?.name\r\n    },\r\n    content: html,\r\n    type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n    flags: {\r\n      sra2: {\r\n        rollType: isAttack ? 'attack' : 'skill',\r\n        attackerId: attacker?.id,\r\n        attackerUuid: finalAttackerUuid, // Use token's actor UUID if token exists, otherwise actor UUID\r\n        attackerTokenUuid: attackerTokenUuid, // Store token UUID\r\n        defenderId: defender?.id,\r\n        defenderUuid: finalDefenderUuid, // Use token's actor UUID if token exists, otherwise actor UUID\r\n        defenderTokenUuid: defenderTokenUuid, // Store token UUID\r\n        rollResult: rollResult,\r\n        rollData: rollData\r\n      }\r\n    }\r\n  };\r\n\r\n  await ChatMessage.create(messageData);\r\n  \r\n  // Handle drain for Sorcery and Conjuration tests\r\n  await handleDrain(attacker, rollData, rollResult);\r\n}\r\n\r\n/**\r\n * Handle drain effects for Sorcery and Conjuration tests\r\n * Applies drain effects based on complications\r\n */\r\nasync function handleDrain(\r\n  actor: any,\r\n  rollData: RollRequestData,\r\n  rollResult: RollResult\r\n): Promise<void> {\r\n  if (!actor || !rollData || !rollResult) {\r\n    return;\r\n  }\r\n\r\n  // Check if this is a spell (spells always use Sorcery, even with specializations like \"Spé: Sorts de combat\")\r\n  const isSpell = rollData.itemType === 'spell' || rollData.itemType === 'weapon-spell';\r\n  \r\n  // Check if this is a Sorcery or Conjuration test\r\n  // Priority: linkedAttackSkill (for spells/weapons) > skillName (for specializations) > specName (fallback)\r\n  let skillName = rollData.linkedAttackSkill || rollData.skillName || rollData.specName || '';\r\n  let normalizedSkillName = ItemSearch.normalizeSearchText(skillName);\r\n  \r\n  // If it's a spell, it's always Sorcery (regardless of specialization like \"Spé: Sorts de combat\")\r\n  // Also check linkedAttackSkill in case it's explicitly set to Sorcery\r\n  if (isSpell || ItemSearch.normalizeSearchText(rollData.linkedAttackSkill || '') === 'sorcellerie') {\r\n    normalizedSkillName = 'sorcellerie';\r\n  } else if (rollData.itemType === 'specialization') {\r\n    // For specialization rolls, check skillName first (should be set from linkedSkill)\r\n    // If not found, try to find the linked skill from the specialization item\r\n    if (!normalizedSkillName || (normalizedSkillName !== 'sorcellerie' && normalizedSkillName !== 'conjuration')) {\r\n      if (rollData.itemId && actor) {\r\n        const specItem = actor.items.find((item: any) => item.id === rollData.itemId);\r\n        if (specItem && specItem.type === 'specialization') {\r\n          const specSystem = specItem.system as any;\r\n          const linkedSkill = specSystem.linkedSkill || '';\r\n          if (linkedSkill) {\r\n            skillName = linkedSkill;\r\n            normalizedSkillName = ItemSearch.normalizeSearchText(linkedSkill);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  const isSorcery = normalizedSkillName === 'sorcellerie';\r\n  const isConjuration = normalizedSkillName === 'conjuration';\r\n  \r\n  if (!isSorcery && !isConjuration) {\r\n    return; // Not a magic test, no drain\r\n  }\r\n\r\n  // Only apply drain if there's a complication\r\n  if (rollResult.complication === 'none') {\r\n    return;\r\n  }\r\n\r\n  const actorSystem = actor.system as any;\r\n  if (!actorSystem || actor.type !== 'character') {\r\n    return; // Only apply to character actors\r\n  }\r\n\r\n  // Handle different complication levels\r\n  if (rollResult.complication === 'minor') {\r\n    // Minor complication: display message in chat about disadvantage until next narration\r\n    const message = game.i18n.localize('SRA2.SKILLS.DRAIN_MINOR_COMPLICATION');\r\n    await ChatMessage.create({\r\n      user: game.user?.id,\r\n      speaker: {\r\n        actor: actor.id,\r\n        alias: actor.name\r\n      },\r\n      content: `<div class=\"drain-message minor-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 4px;\">\r\n        <i class=\"fas fa-exclamation-triangle\" style=\"color: #ffc107;\"></i> \r\n        <strong style=\"color: #ffc107;\">Drain - ${game.i18n.localize('SRA2.SKILLS.MINOR_COMPLICATION')}</strong>\r\n        <br/>\r\n        <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n      </div>`,\r\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n    });\r\n  } else if (rollResult.complication === 'critical') {\r\n    // Critical complication: apply light wound\r\n    const damage = actorSystem.damage || {};\r\n    const lightWounds = Array.isArray(damage.light) ? damage.light : [false, false];\r\n    \r\n    // Find first available light wound slot\r\n    let woundApplied = false;\r\n    for (let i = 0; i < lightWounds.length; i++) {\r\n      if (!lightWounds[i]) {\r\n        lightWounds[i] = true;\r\n        woundApplied = true;\r\n        break;\r\n      }\r\n    }\r\n    \r\n    if (woundApplied) {\r\n      await actor.update({\r\n        'system.damage.light': lightWounds\r\n      });\r\n      \r\n      const message = game.i18n.localize('SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION');\r\n      await ChatMessage.create({\r\n        user: game.user?.id,\r\n        speaker: {\r\n          actor: actor.id,\r\n          alias: actor.name\r\n        },\r\n        content: `<div class=\"drain-message critical-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n          <i class=\"fas fa-exclamation-circle\" style=\"color: #dc3545;\"></i> \r\n          <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.CRITICAL_COMPLICATION')}</strong>\r\n          <br/>\r\n          <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n        </div>`,\r\n        type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n      });\r\n    } else {\r\n      // All light wound slots are full, upgrade to severe or incapacitating\r\n      const severeWounds = Array.isArray(damage.severe) ? damage.severe : [false];\r\n      let severeApplied = false;\r\n      \r\n      for (let i = 0; i < severeWounds.length; i++) {\r\n        if (!severeWounds[i]) {\r\n          severeWounds[i] = true;\r\n          severeApplied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      if (severeApplied) {\r\n        await actor.update({\r\n          'system.damage.severe': severeWounds\r\n        });\r\n      } else {\r\n        // All severe slots full, apply incapacitating\r\n        await actor.update({\r\n          'system.damage.incapacitating': true\r\n        });\r\n      }\r\n      \r\n      const message = game.i18n.localize('SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION');\r\n      await ChatMessage.create({\r\n        user: game.user?.id,\r\n        speaker: {\r\n          actor: actor.id,\r\n          alias: actor.name\r\n        },\r\n        content: `<div class=\"drain-message critical-complication\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n          <i class=\"fas fa-exclamation-circle\" style=\"color: #dc3545;\"></i> \r\n          <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.CRITICAL_COMPLICATION')}</strong>\r\n          <br/>\r\n          <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n        </div>`,\r\n        type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n      });\r\n    }\r\n  } else if (rollResult.complication === 'disaster') {\r\n    // Disaster: apply incapacitating wound\r\n    await actor.update({\r\n      'system.damage.incapacitating': true\r\n    });\r\n    \r\n    const message = game.i18n.localize('SRA2.SKILLS.DRAIN_DISASTER');\r\n    await ChatMessage.create({\r\n      user: game.user?.id,\r\n      speaker: {\r\n        actor: actor.id,\r\n        alias: actor.name\r\n      },\r\n      content: `<div class=\"drain-message disaster\" style=\"padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;\">\r\n        <i class=\"fas fa-skull\" style=\"color: #dc3545;\"></i> \r\n        <strong style=\"color: #dc3545;\">Drain - ${game.i18n.localize('SRA2.SKILLS.DISASTER')}</strong>\r\n        <br/>\r\n        <span style=\"margin-left: 20px; display: block; margin-top: 4px;\">${message}</span>\r\n      </div>`,\r\n      type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n    });\r\n  }\r\n}\r\n\r\n","/**\r\n * Shared Sheet Helpers for SRA2\r\n * Common functions used by CharacterSheet\r\n */\r\n\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Handle form submission with proper damage checkbox handling\r\n */\r\nexport function handleSheetUpdate(actor: any, formData: any): any {\r\n  // DEBUG: Log which actor is being updated\r\n  console.log('handleSheetUpdate - DEBUG:', {\r\n    'actor.id': actor?.id,\r\n    'actor.name': actor?.name,\r\n    'actor.type': actor?.type,\r\n    'actor.uuid': actor?.uuid\r\n  });\r\n  \r\n  // Expand the form data first to handle nested properties properly\r\n  const expandedData = foundry.utils.expandObject(formData) as any;\r\n  \r\n  // Only process damage if it's present in the formData (indicates damage fields were changed)\r\n  if (expandedData.system && expandedData.system.damage !== undefined) {\r\n    const currentDamage = (actor.system as any).damage || {};\r\n    \r\n    // Initialize damage object if not present\r\n    if (!expandedData.system.damage || typeof expandedData.system.damage !== 'object') {\r\n      expandedData.system.damage = {};\r\n    }\r\n    \r\n    // Helper function to convert object with numeric keys to array\r\n    const convertToArray = (obj: any, expectedLength: number): boolean[] => {\r\n      if (Array.isArray(obj)) {\r\n        // Already an array, ensure all indices are filled and convert to boolean\r\n        const arr: boolean[] = [];\r\n        for (let i = 0; i < expectedLength; i++) {\r\n          if (obj[i] !== undefined) {\r\n            arr[i] = obj[i] === true || obj[i] === 'true' || obj[i] === 'on';\r\n          } else {\r\n            arr[i] = false;\r\n          }\r\n        }\r\n        return arr;\r\n      }\r\n      if (obj && typeof obj === 'object') {\r\n        // Object with numeric keys (e.g., {\"0\": true, \"1\": false}), convert to array\r\n        const arr: boolean[] = [];\r\n        for (let i = 0; i < expectedLength; i++) {\r\n          const key = i.toString();\r\n          arr[i] = obj[key] === true || obj[key] === 'true' || obj[key] === 'on';\r\n        }\r\n        return arr;\r\n      }\r\n      // Not present or invalid, return array of false\r\n      return Array(expectedLength).fill(false);\r\n    };\r\n    \r\n    // Get expected lengths from current damage or defaults\r\n    const currentLightLength = Array.isArray(currentDamage.light) ? currentDamage.light.length : 2;\r\n    const currentSevereLength = Array.isArray(currentDamage.severe) ? currentDamage.severe.length : 1;\r\n    \r\n    // Handle light damage checkboxes - process if present in formData\r\n    if (expandedData.system.damage.light !== undefined) {\r\n      expandedData.system.damage.light = convertToArray(expandedData.system.damage.light, currentLightLength);\r\n    }\r\n    \r\n    // Handle severe damage checkboxes - process if present in formData\r\n    if (expandedData.system.damage.severe !== undefined) {\r\n      expandedData.system.damage.severe = convertToArray(expandedData.system.damage.severe, currentSevereLength);\r\n    }\r\n    \r\n    // Handle incapacitating - convert to boolean if present\r\n    if (expandedData.system.damage.incapacitating !== undefined) {\r\n      expandedData.system.damage.incapacitating = expandedData.system.damage.incapacitating === true || \r\n                                                  expandedData.system.damage.incapacitating === 'true' || \r\n                                                  expandedData.system.damage.incapacitating === 'on';\r\n    }\r\n  }\r\n  \r\n  return expandedData;\r\n}\r\n\r\n/**\r\n * Calculate final damage value for weapon/spell display\r\n */\r\nexport function calculateFinalDamageValue(damageValue: string, damageValueBonus: number, strength: number): string {\r\n  if (damageValue === \"FOR\") {\r\n    const total = strength + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (FOR+${damageValueBonus})` : `${total} (FOR)`;\r\n  } else if (damageValue.startsWith(\"FOR+\")) {\r\n    const modifier = parseInt(damageValue.substring(4)) || 0;\r\n    const total = strength + modifier + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (FOR+${modifier}+${damageValueBonus})` : `${total} (FOR+${modifier})`;\r\n  } else if (damageValue === \"toxin\") {\r\n    return \"selon toxine\";\r\n  } else {\r\n    const base = parseInt(damageValue) || 0;\r\n    const total = base + damageValueBonus;\r\n    return damageValueBonus > 0 ? `${total} (${base}+${damageValueBonus})` : total.toString();\r\n  }\r\n}\r\n\r\n/**\r\n * Organize specializations by linked skill\r\n */\r\nexport function organizeSpecializationsBySkill(\r\n  allSpecializations: any[],\r\n  actorItems: any[]\r\n): { bySkill: Map<string, any[]>; unlinked: any[] } {\r\n  const specializationsBySkill = new Map<string, any[]>();\r\n  const unlinkedSpecializations: any[] = [];\r\n  \r\n  allSpecializations.forEach((spec: any) => {\r\n    const linkedSkillName = spec.system.linkedSkill;\r\n    if (linkedSkillName) {\r\n      // linkedSkill is stored as a name, find the skill by name\r\n      const linkedSkill = actorItems.find((i: any) => \r\n        i.type === 'skill' && i.name === linkedSkillName\r\n      );\r\n      \r\n      if (linkedSkill && linkedSkill.id) {\r\n        // Valid linked skill found\r\n        const skillId = linkedSkill.id;\r\n        if (!specializationsBySkill.has(skillId)) {\r\n          specializationsBySkill.set(skillId, []);\r\n        }\r\n        specializationsBySkill.get(skillId)!.push(spec);\r\n      } else {\r\n        // Linked skill doesn't exist, mark as unlinked\r\n        unlinkedSpecializations.push(spec);\r\n      }\r\n    } else {\r\n      // No linked skill specified\r\n      unlinkedSpecializations.push(spec);\r\n    }\r\n  });\r\n  \r\n  return { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations };\r\n}\r\n\r\n/**\r\n * Handle item drop on actor sheet (feats, skills, specializations, metatypes)\r\n */\r\nexport async function handleItemDrop(\r\n  event: DragEvent,\r\n  actor: any,\r\n  allowedTypes: string[] = ['feat', 'skill', 'specialization', 'metatype']\r\n): Promise<boolean> {\r\n  const data = TextEditor.getDragEventData(event) as any;\r\n  \r\n  // Handle Item drops\r\n  if (data && data.type === 'Item') {\r\n    const item = await Item.implementation.fromDropData(data) as any;\r\n    \r\n    if (!item) return false;\r\n    \r\n    // Check if the item is from a compendium or another actor (not already on this actor)\r\n    if (item.actor && item.actor.id === actor.id) {\r\n      // Item already belongs to this actor, ignore\r\n      return false;\r\n    }\r\n    \r\n    // Check if type is allowed\r\n    if (!allowedTypes.includes(item.type)) {\r\n      return false;\r\n    }\r\n    \r\n    // Handle metatype\r\n    if (item.type === 'metatype') {\r\n      const existingMetatype = actor.items.find((i: any) => i.type === 'metatype');\r\n      if (existingMetatype) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.METATYPES.ONLY_ONE_METATYPE'));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle feat\r\n    if (item.type === 'feat') {\r\n      const existingFeat = actor.items.find((i: any) => \r\n        i.type === 'feat' && i.name === item.name\r\n      );\r\n      if (existingFeat) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle skill\r\n    if (item.type === 'skill') {\r\n      const existingSkill = actor.items.find((i: any) => \r\n        i.type === 'skill' && i.name === item.name\r\n      );\r\n      if (existingSkill) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n    \r\n    // Handle specialization\r\n    if (item.type === 'specialization') {\r\n      const existingSpec = actor.items.find((i: any) => \r\n        i.type === 'specialization' && i.name === item.name\r\n      );\r\n      if (existingSpec) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.SPECIALIZATIONS.ALREADY_EXISTS', { name: item.name }));\r\n        return false;\r\n      }\r\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\r\n      return true;\r\n    }\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Handle vehicle actor drop on character sheet\r\n * Adds the vehicle actor UUID to the character's linkedVehicles array\r\n */\r\nexport async function handleVehicleActorDrop(\r\n  event: DragEvent,\r\n  actor: any\r\n): Promise<boolean> {\r\n  const data = TextEditor.getDragEventData(event) as any;\r\n  \r\n  // Handle Actor drops (specifically vehicle actors)\r\n  if (data && data.type === 'Actor') {\r\n    try {\r\n      const vehicleActor = await fromUuid(data.uuid) as any;\r\n      \r\n      if (!vehicleActor) return false;\r\n      \r\n      // Check if it's a vehicle actor\r\n      if (vehicleActor.type !== 'vehicle') return false;\r\n      \r\n      // Get current linked vehicles\r\n      const linkedVehicles = (actor.system as any).linkedVehicles || [];\r\n      \r\n      // Check if this vehicle is already linked\r\n      if (linkedVehicles.includes(vehicleActor.uuid)) {\r\n        ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.VEHICLE_ALREADY_EXISTS', { name: vehicleActor.name }));\r\n        return false;\r\n      }\r\n      \r\n      // Add the vehicle UUID to the linked vehicles array\r\n      const updatedLinkedVehicles = [...linkedVehicles, vehicleActor.uuid];\r\n      await actor.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n      \r\n      // Configure the vehicle's token prototype to be linked to the character actor\r\n      const prototypeToken = vehicleActor.prototypeToken || {};\r\n      const updateData: any = {\r\n        'prototypeToken.actorLink': true\r\n      };\r\n      \r\n      // If the vehicle doesn't have a prototype token yet, initialize it\r\n      if (!vehicleActor.prototypeToken) {\r\n        updateData['prototypeToken'] = foundry.utils.mergeObject(\r\n          foundry.data.PrototypeToken.defaults,\r\n          { actorLink: true }\r\n        );\r\n      }\r\n      \r\n      await vehicleActor.update(updateData);\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.VEHICLE_ADDED', { name: vehicleActor.name }));\r\n      return true;\r\n    } catch (error) {\r\n      console.error('Error handling vehicle actor drop:', error);\r\n      return false;\r\n    }\r\n  }\r\n  \r\n  return false;\r\n}\r\n\r\n/**\r\n * Get RR for a specific item type and name (wrapper for DiceRoller)\r\n */\r\nexport function getRRSources(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\r\n  const sources: Array<{featName: string, rrValue: number}> = [];\r\n  \r\n  const feats = actor.items.filter((item: any) => \r\n    item.type === 'feat' && \r\n    item.system.active === true\r\n  );\r\n  \r\n  // Normalize the search name for comparison (case-insensitive, accent-insensitive)\r\n  const normalizedItemName = ItemSearch.normalizeSearchText(itemName);\r\n  \r\n  for (const feat of feats) {\r\n    const featSystem = feat.system as any;\r\n    const rrList = featSystem.rrList || [];\r\n    \r\n    for (const rrEntry of rrList) {\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      // Normalize the RR target for comparison\r\n      const normalizedRRTarget = ItemSearch.normalizeSearchText(rrTarget);\r\n      \r\n      // Compare normalized names for better matching (handles custom skills/specs with variations)\r\n      if (rrType === itemType && normalizedRRTarget === normalizedItemName && rrValue > 0) {\r\n        sources.push({\r\n          featName: feat.name,\r\n          rrValue: rrValue\r\n        });\r\n      }\r\n    }\r\n  }\r\n  \r\n  return sources;\r\n}\r\n\r\n/**\r\n * Calculate Risk Reduction for a given skill, specialization, or attribute\r\n */\r\nexport function calculateRR(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\r\n  const sources = getRRSources(actor, itemType, itemName);\r\n  return sources.reduce((total, source) => total + source.rrValue, 0);\r\n}\r\n\r\n/**\r\n * Generic handler to edit an item from an actor\r\n */\r\nexport async function handleEditItem(event: Event, actor: any): Promise<void> {\r\n  event.preventDefault();\r\n  const element = event.currentTarget as HTMLElement;\r\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\r\n  \r\n  if (!itemId) return;\r\n\r\n  const item = actor.items.get(itemId);\r\n  if (item) {\r\n    item.sheet?.render(true);\r\n  }\r\n}\r\n\r\n/**\r\n * Generic handler to delete an item from an actor\r\n */\r\nexport async function handleDeleteItem(event: Event, actor: any, sheetRender?: (refresh: boolean) => void): Promise<void> {\r\n  event.preventDefault();\r\n  const element = event.currentTarget as HTMLElement;\r\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\r\n  \r\n  if (!itemId) return;\r\n\r\n  const item = actor.items.get(itemId);\r\n  if (item) {\r\n    await item.delete();\r\n    if (sheetRender) {\r\n      sheetRender(false);\r\n    }\r\n  }\r\n}\r\n\r\n// ============================================================================\r\n// DAMAGE VALUE PARSING\r\n// ============================================================================\r\n\r\n/**\r\n * Result of parsing a damage value\r\n */\r\nexport interface DamageValueResult {\r\n  /** Numeric damage value (resolved) */\r\n  numericValue: number;\r\n  /** Display string for UI (e.g., \"5 (FOR+2)\") */\r\n  displayValue: string;\r\n  /** Raw damage string to send in roll data (e.g., \"FOR+2\") */\r\n  rawDamageString: string;\r\n  /** Whether the damage is strength-based */\r\n  isStrengthBased: boolean;\r\n  /** Whether the damage is toxin-based */\r\n  isToxin: boolean;\r\n}\r\n\r\n/**\r\n * Parse a damage value string and calculate the final numeric value\r\n * Handles: FOR, FOR+X, numeric values, and toxin\r\n * \r\n * @param damageValueStr - The damage value string (e.g., \"FOR\", \"FOR+2\", \"5\", \"toxin\")\r\n * @param actorStrength - The actor's strength attribute value\r\n * @param damageValueBonus - Additional bonus from feats/items (default: 0)\r\n * @returns Parsed damage value result\r\n */\r\nexport function parseDamageValue(\r\n  damageValueStr: string,\r\n  actorStrength: number,\r\n  damageValueBonus: number = 0\r\n): DamageValueResult {\r\n  const result: DamageValueResult = {\r\n    numericValue: 0,\r\n    displayValue: damageValueStr,\r\n    rawDamageString: damageValueStr,\r\n    isStrengthBased: false,\r\n    isToxin: false\r\n  };\r\n  \r\n  // Handle toxin damage\r\n  if (damageValueStr === 'toxin') {\r\n    result.isToxin = true;\r\n    result.displayValue = 'selon toxine';\r\n    return result;\r\n  }\r\n  \r\n  // Handle FOR (strength-based)\r\n  if (damageValueStr === 'FOR') {\r\n    result.isStrengthBased = true;\r\n    result.numericValue = actorStrength + damageValueBonus;\r\n    if (damageValueBonus > 0) {\r\n      result.displayValue = `${result.numericValue} (FOR+${damageValueBonus})`;\r\n      result.rawDamageString = `FOR+${damageValueBonus}`;\r\n    } else {\r\n      result.displayValue = `${result.numericValue} (FOR)`;\r\n      result.rawDamageString = 'FOR';\r\n    }\r\n    return result;\r\n  }\r\n  \r\n  // Handle FOR+X (strength-based with modifier)\r\n  if (damageValueStr.startsWith('FOR+')) {\r\n    result.isStrengthBased = true;\r\n    const modifier = parseInt(damageValueStr.substring(4)) || 0;\r\n    result.numericValue = actorStrength + modifier + damageValueBonus;\r\n    const totalModifier = modifier + damageValueBonus;\r\n    if (damageValueBonus > 0) {\r\n      result.displayValue = `${result.numericValue} (FOR+${modifier}+${damageValueBonus})`;\r\n      result.rawDamageString = `FOR+${totalModifier}`;\r\n    } else {\r\n      result.displayValue = `${result.numericValue} (FOR+${modifier})`;\r\n      result.rawDamageString = damageValueStr;\r\n    }\r\n    return result;\r\n  }\r\n  \r\n  // Handle numeric damage\r\n  const base = parseInt(damageValueStr) || 0;\r\n  result.numericValue = base + damageValueBonus;\r\n  if (damageValueBonus > 0) {\r\n    result.displayValue = `${result.numericValue} (${base}+${damageValueBonus})`;\r\n    result.rawDamageString = result.numericValue.toString();\r\n  } else {\r\n    result.displayValue = result.numericValue.toString();\r\n    result.rawDamageString = damageValueStr;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Calculate raw damage string with bonus applied (for roll data)\r\n * This returns the string to be used in roll requests (e.g., \"FOR+3\" or \"7\")\r\n */\r\nexport function calculateRawDamageString(\r\n  baseDamageValue: string,\r\n  damageValueBonus: number\r\n): string {\r\n  if (damageValueBonus <= 0 || baseDamageValue === '0' || baseDamageValue === 'toxin') {\r\n    return baseDamageValue;\r\n  }\r\n  \r\n  if (baseDamageValue === 'FOR') {\r\n    return `FOR+${damageValueBonus}`;\r\n  }\r\n  \r\n  if (baseDamageValue.startsWith('FOR+')) {\r\n    const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\r\n    return `FOR+${baseModifier + damageValueBonus}`;\r\n  }\r\n  \r\n  // Numeric value\r\n  const baseValue = parseInt(baseDamageValue) || 0;\r\n  return (baseValue + damageValueBonus).toString();\r\n}\r\n\r\n// ============================================================================\r\n// DAMAGE CHECKBOX HANDLING\r\n// ============================================================================\r\n\r\n/**\r\n * Result of parsing damage checkbox changes\r\n */\r\nexport interface DamageUpdateResult {\r\n  light: boolean[];\r\n  severe: boolean[];\r\n  incapacitating: boolean;\r\n}\r\n\r\n/**\r\n * Parse a damage checkbox change and return the updated damage object\r\n * Works for both character damage and cyberdeck damage\r\n * \r\n * @param inputName - The input name (e.g., \"system.damage.light.0\")\r\n * @param checked - Whether the checkbox is checked\r\n * @param currentDamage - Current damage object from actor/item\r\n * @returns Updated damage object, or null if the input name doesn't match\r\n */\r\nexport function parseDamageCheckboxChange(\r\n  inputName: string,\r\n  checked: boolean,\r\n  currentDamage: any\r\n): DamageUpdateResult | null {\r\n  // Match patterns like:\r\n  // - system.damage.light.0\r\n  // - system.damage.severe.0\r\n  // - system.damage.incapacitating\r\n  // - items.{itemId}.system.cyberdeckDamage.light.0\r\n  const match = inputName.match(/(?:damage|cyberdeckDamage)\\.(light|severe|incapacitating)(?:\\.(\\d+))?$/);\r\n  if (!match) return null;\r\n  \r\n  const damageType = match[1] as 'light' | 'severe' | 'incapacitating';\r\n  const index = match[2] ? parseInt(match[2], 10) : null;\r\n  \r\n  // Create a copy of the damage object\r\n  const updatedDamage: DamageUpdateResult = {\r\n    light: Array.isArray(currentDamage?.light) ? [...currentDamage.light] : [false, false],\r\n    severe: Array.isArray(currentDamage?.severe) ? [...currentDamage.severe] : [false],\r\n    incapacitating: typeof currentDamage?.incapacitating === 'boolean' ? currentDamage.incapacitating : false\r\n  };\r\n  \r\n  // Update the appropriate field\r\n  if (damageType === 'incapacitating') {\r\n    updatedDamage.incapacitating = checked;\r\n  } else if (damageType === 'light' || damageType === 'severe') {\r\n    if (index !== null) {\r\n      // Ensure array is long enough\r\n      while (updatedDamage[damageType].length <= index) {\r\n        updatedDamage[damageType].push(false);\r\n      }\r\n      updatedDamage[damageType][index] = checked;\r\n    }\r\n  }\r\n  \r\n  return updatedDamage;\r\n}\r\n\r\n/**\r\n * Get the damage path prefix from an input name\r\n * Returns 'system.damage' for character damage, or 'system.cyberdeckDamage' for cyberdeck\r\n */\r\nexport function getDamagePathFromInputName(inputName: string): string {\r\n  if (inputName.includes('cyberdeckDamage')) {\r\n    // Extract the items.{itemId}.system.cyberdeckDamage part\r\n    const match = inputName.match(/(items\\.[^.]+\\.system\\.cyberdeckDamage)/);\r\n    return match && match[1] ? match[1] : 'system.cyberdeckDamage';\r\n  }\r\n  return 'system.damage';\r\n}\r\n\r\n// ============================================================================\r\n// SECTION NAVIGATION\r\n// ============================================================================\r\n\r\n/**\r\n * Handle section navigation click event\r\n * Updates the active section in both the nav and content areas\r\n * \r\n * @param event - The click event\r\n * @param formElement - The form element (or its jQuery wrapper)\r\n * @returns The section name that was activated, or null if invalid\r\n */\r\nexport function handleSectionNavigation(\r\n  event: Event,\r\n  formElement: HTMLElement | JQuery\r\n): string | null {\r\n  event.preventDefault();\r\n  const button = event.currentTarget as HTMLElement;\r\n  const section = button.dataset.section;\r\n  \r\n  if (!section) return null;\r\n  \r\n  const form = formElement instanceof HTMLElement \r\n    ? formElement \r\n    : (formElement as JQuery).get(0);\r\n  \r\n  if (!form) return null;\r\n  \r\n  // Update nav items\r\n  form.querySelectorAll('.section-nav .nav-item').forEach((item) => {\r\n    item.classList.remove('active');\r\n  });\r\n  button.classList.add('active');\r\n  \r\n  // Update content sections\r\n  form.querySelectorAll('.content-section').forEach((contentSection) => {\r\n    contentSection.classList.remove('active');\r\n  });\r\n  const targetSection = form.querySelector(`[data-section-content=\"${section}\"]`);\r\n  if (targetSection) {\r\n    targetSection.classList.add('active');\r\n  }\r\n  \r\n  return section;\r\n}\r\n\r\n/**\r\n * Restore the active section after a re-render\r\n * Call this in activateListeners or after any operation that triggers a re-render\r\n * \r\n * @param formElement - The form element\r\n * @param activeSection - The section name to activate\r\n * @param delay - Optional delay in ms before restoring (default: 10)\r\n */\r\nexport function restoreActiveSection(\r\n  formElement: HTMLElement,\r\n  activeSection: string | null,\r\n  delay: number = 10\r\n): void {\r\n  if (!activeSection) return;\r\n  \r\n  setTimeout(() => {\r\n    const navButton = formElement.querySelector(`[data-section=\"${activeSection}\"]`);\r\n    if (navButton) {\r\n      // Update nav items\r\n      formElement.querySelectorAll('.section-nav .nav-item').forEach((item) => {\r\n        item.classList.remove('active');\r\n      });\r\n      navButton.classList.add('active');\r\n      \r\n      // Update content sections\r\n      formElement.querySelectorAll('.content-section').forEach((section) => {\r\n        section.classList.remove('active');\r\n      });\r\n      const targetSection = formElement.querySelector(`[data-section-content=\"${activeSection}\"]`);\r\n      if (targetSection) {\r\n        targetSection.classList.add('active');\r\n      }\r\n    }\r\n  }, delay);\r\n}\r\n\r\n/**\r\n * Save the current active section from the sheet's HTML\r\n * Useful before operations that will cause a re-render\r\n * \r\n * @param html - jQuery object of the sheet\r\n * @returns The current active section name, or null\r\n */\r\nexport function getCurrentActiveSection(html: JQuery): string | null {\r\n  const activeNavItem = html.find('.section-nav .nav-item.active');\r\n  return activeNavItem.length > 0 ? (activeNavItem.data('section') as string) : null;\r\n}\r\n\r\n// ============================================================================\r\n// FEAT ENRICHMENT\r\n// ============================================================================\r\n\r\n/**\r\n * Enrich feats with RR entries and final damage values\r\n */\r\nexport function enrichFeats(feats: any[], actorStrength: number, calculateFinalDamageValueFn: (dv: string, bonus: number, str: number) => string, actor?: any): any[] {\r\n  return feats.map((feat: any) => {\r\n    // Add translated labels for attribute targets in RR entries\r\n    feat.rrEntries = [];\r\n    const itemRRList = feat.system.rrList || [];\r\n    \r\n    // For weapons and spells, also include RR from linked skills/specs/attributes\r\n    let allRRList = [...itemRRList];\r\n    \r\n    if (actor && (feat.system.featType === 'weapon' || feat.system.featType === 'spell' || feat.system.featType === 'weapons-spells')) {\r\n      const { normalizeSearchText } = ItemSearch;\r\n      \r\n      // Get linked skill and specialization from weapon\r\n      const linkedAttackSkill = feat.system.linkedAttackSkill || '';\r\n      const linkedAttackSpec = feat.system.linkedAttackSpecialization || '';\r\n      \r\n      let attackSpecName: string | undefined = undefined;\r\n      let attackSkillName: string | undefined = undefined;\r\n      let attackLinkedAttribute: string | undefined = undefined;\r\n      \r\n      // Try to find the linked attack specialization first\r\n      if (linkedAttackSpec) {\r\n        const foundSpec = actor.items.find((i: any) => \r\n          i.type === 'specialization' && \r\n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSpec)\r\n        );\r\n        \r\n        if (foundSpec) {\r\n          const specSystem = foundSpec.system as any;\r\n          attackSpecName = foundSpec.name;\r\n          attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\r\n          \r\n          // Get parent skill for specialization\r\n          const linkedSkillName = specSystem.linkedSkill;\r\n          if (linkedSkillName) {\r\n            const parentSkill = actor.items.find((i: any) => \r\n              i.type === 'skill' && i.name === linkedSkillName\r\n            );\r\n            if (parentSkill) {\r\n              attackSkillName = parentSkill.name;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      // If no specialization found, try to find the linked attack skill\r\n      if (!attackSpecName && linkedAttackSkill) {\r\n        const foundSkill = actor.items.find((i: any) => \r\n          i.type === 'skill' && \r\n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSkill)\r\n        );\r\n        \r\n        if (foundSkill) {\r\n          attackSkillName = foundSkill.name;\r\n          attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\r\n        }\r\n      }\r\n      \r\n      // Get RR sources from skill/specialization/attribute\r\n      if (attackSpecName) {\r\n        const specRRSources = getRRSources(actor, 'specialization', attackSpecName);\r\n        allRRList = [...allRRList, ...specRRSources.map(rr => ({\r\n          rrType: 'specialization',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackSpecName\r\n        }))];\r\n      }\r\n      if (attackSkillName) {\r\n        const skillRRSources = getRRSources(actor, 'skill', attackSkillName);\r\n        allRRList = [...allRRList, ...skillRRSources.map(rr => ({\r\n          rrType: 'skill',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackSkillName\r\n        }))];\r\n      }\r\n      if (attackLinkedAttribute) {\r\n        const attributeRRSources = getRRSources(actor, 'attribute', attackLinkedAttribute);\r\n        allRRList = [...allRRList, ...attributeRRSources.map(rr => ({\r\n          rrType: 'attribute',\r\n          rrValue: rr.rrValue,\r\n          rrTarget: attackLinkedAttribute\r\n        }))];\r\n      }\r\n    }\r\n    \r\n    // Process all RR entries (item RR + skill/spec/attribute RR)\r\n    for (let i = 0; i < allRRList.length; i++) {\r\n      const rrEntry = allRRList[i];\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      if (rrValue > 0) {\r\n      const entry: any = { rrType, rrValue, rrTarget };\r\n      \r\n      if (rrType === 'attribute' && rrTarget) {\r\n        entry.rrTargetLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${rrTarget.toUpperCase()}`);\r\n      }\r\n      \r\n      feat.rrEntries.push(entry);\r\n      }\r\n    }\r\n    \r\n    // Calculate final damage value for weapons and spells\r\n    if (feat.system.featType === 'weapon' || feat.system.featType === 'spell' || feat.system.featType === 'weapons-spells') {\r\n      const damageValue = feat.system.damageValue || '0';\r\n      let damageValueBonus = feat.system.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      if (actor) {\r\n        const weaponType = feat.system.weaponType || '';\r\n        const activeFeats = actor.items.filter((item: any) => \r\n          item.type === 'feat' && \r\n          item.system.active === true &&\r\n          item.system.weaponDamageBonus > 0 &&\r\n          item.system.weaponTypeBonus === weaponType\r\n        );\r\n        \r\n        activeFeats.forEach((activeFeat: any) => {\r\n          damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n        });\r\n      }\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      feat.finalDamageValue = calculateFinalDamageValueFn(damageValue, damageValueBonus, actorStrength);\r\n    }\r\n    \r\n    return feat;\r\n  });\r\n}\r\n\r\n/**\r\n * Result from finding attack skill and specialization\r\n */\r\nexport interface AttackSkillSpecResult {\r\n  skillName: string | undefined;\r\n  skillLevel: number | undefined;\r\n  specName: string | undefined;\r\n  specLevel: number | undefined;\r\n  linkedAttribute: string | undefined;\r\n}\r\n\r\n/**\r\n * Options for finding attack skill and specialization\r\n */\r\nexport interface FindAttackSkillSpecOptions {\r\n  isSpell?: boolean;\r\n  spellSpecType?: string;\r\n  defaultAttribute?: string;\r\n}\r\n\r\n/**\r\n * Normalize text for comparison (remove spaces, accents, punctuation)\r\n */\r\nexport function normalizeForComparison(text: string): string {\r\n  return ItemSearch.normalizeSearchText(text).replace(/\\s+/g, '').replace(/:/g, '').replace(/'/g, '');\r\n}\r\n\r\n/**\r\n * Find attack skill and specialization in an actor's items\r\n * Unifies the logic used in getData() for enriching weapons and in _rollWeaponOrSpell()\r\n * \r\n * @param actor - The actor to search in\r\n * @param targetSpec - The specialization name to search for\r\n * @param targetSkill - The skill name to search for (fallback if spec not found)\r\n * @param options - Additional options (isSpell, spellSpecType, defaultAttribute)\r\n * @returns AttackSkillSpecResult with found skill/spec info\r\n */\r\nexport function findAttackSkillAndSpec(\r\n  actor: any,\r\n  targetSpec: string,\r\n  targetSkill: string,\r\n  options: FindAttackSkillSpecOptions = {}\r\n): AttackSkillSpecResult {\r\n  const result: AttackSkillSpecResult = {\r\n    skillName: undefined,\r\n    skillLevel: undefined,\r\n    specName: undefined,\r\n    specLevel: undefined,\r\n    linkedAttribute: undefined\r\n  };\r\n\r\n  const { isSpell = false, spellSpecType = 'combat', defaultAttribute = 'strength' } = options;\r\n\r\n  // Try to find the linked attack specialization first\r\n  if (targetSpec) {\r\n    const normalizedTargetSpec = normalizeForComparison(targetSpec);\r\n    \r\n    const foundSpec = actor.items.find((i: any) => {\r\n      if (i.type !== 'specialization') return false;\r\n      const normalizedItemName = normalizeForComparison(i.name);\r\n      return normalizedItemName === normalizedTargetSpec;\r\n    });\r\n    \r\n    if (foundSpec) {\r\n      _extractSpecAndSkillInfo(actor, foundSpec, result, defaultAttribute);\r\n    } else if (isSpell) {\r\n      // If exact match not found for spells, try keyword search\r\n      _trySpellSpecKeywordSearch(actor, spellSpecType, result);\r\n      \r\n      // If still not found, search in game.items\r\n      if (!result.specName && !result.skillLevel && game.items) {\r\n        _searchGameItemsForSpellSpec(actor, targetSpec, spellSpecType, result);\r\n      }\r\n    }\r\n  }\r\n  \r\n  // If no specialization found, try to find the linked attack skill\r\n  if (!result.specName && !result.skillLevel && targetSkill) {\r\n    const foundSkill = actor.items.find((i: any) => \r\n      i.type === 'skill' && \r\n      ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(targetSkill)\r\n    );\r\n    \r\n    if (foundSkill) {\r\n      const foundLinkedAttribute = (foundSkill.system as any).linkedAttribute || defaultAttribute;\r\n      result.skillName = foundSkill.name;\r\n      result.linkedAttribute = result.linkedAttribute || foundLinkedAttribute;\r\n      const skillRating = (foundSkill.system as any).rating || 0;\r\n      const attributeValue = (actor.system as any).attributes?.[foundLinkedAttribute] || 0;\r\n      result.skillLevel = skillRating + attributeValue;\r\n    } else if (isSpell && game.items) {\r\n      // For spells, try to find Sorcellerie in game.items\r\n      _searchGameItemsForSorcellerie(actor, result);\r\n    } else if (!isSpell) {\r\n      // Skill not found: use default attribute with skill rating of 0\r\n      result.skillName = targetSkill;\r\n      result.linkedAttribute = result.linkedAttribute || defaultAttribute;\r\n      const attributeValue = (actor.system as any).attributes?.[defaultAttribute] || 0;\r\n      result.skillLevel = 0 + attributeValue; // Skill rating is 0 when skill doesn't exist\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\n/**\r\n * Extract skill and spec info from a found specialization\r\n */\r\nfunction _extractSpecAndSkillInfo(\r\n  actor: any,\r\n  foundSpec: any,\r\n  result: AttackSkillSpecResult,\r\n  defaultAttribute: string\r\n): void {\r\n  const specSystem = foundSpec.system as any;\r\n  result.specName = foundSpec.name;\r\n  result.linkedAttribute = specSystem.linkedAttribute || defaultAttribute;\r\n  \r\n  // Get parent skill for specialization\r\n  const linkedSkillName = specSystem.linkedSkill;\r\n  if (linkedSkillName) {\r\n    const parentSkill = actor.items.find((i: any) => \r\n      i.type === 'skill' && i.name === linkedSkillName\r\n    );\r\n    if (parentSkill && result.linkedAttribute) {\r\n      result.skillName = parentSkill.name;\r\n      const skillRating = (parentSkill.system as any).rating || 0;\r\n      const attributeValue = (actor.system as any).attributes?.[result.linkedAttribute] || 0;\r\n      const skillLevel = skillRating + attributeValue;\r\n      result.skillLevel = skillLevel;\r\n      result.specLevel = skillLevel + 2; // Specialization adds +2\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Try to find spell specialization by keyword search in actor items\r\n */\r\nfunction _trySpellSpecKeywordSearch(\r\n  actor: any,\r\n  spellSpecType: string,\r\n  result: AttackSkillSpecResult\r\n): void {\r\n  const specKeywords: Record<string, string[]> = {\r\n    'combat': ['combat'],\r\n    'detection': ['détection', 'detection'],\r\n    'health': ['santé', 'sante', 'health'],\r\n    'illusion': ['illusion'],\r\n    'manipulation': ['manipulation'],\r\n    'counterspell': ['contresort', 'contre-sort']\r\n  };\r\n  \r\n  const keywords = specKeywords[spellSpecType] || ['combat'];\r\n  const normalizedKeywords = keywords.map(kw => ItemSearch.normalizeSearchText(kw));\r\n  \r\n  const foundSpecByKeyword = actor.items.find((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const normalizedName = ItemSearch.normalizeSearchText(i.name);\r\n    const linkedSkill = (i.system as any)?.linkedSkill;\r\n    if (linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === 'sorcellerie') {\r\n      return normalizedKeywords.some(normalizedKeyword => normalizedName.includes(normalizedKeyword));\r\n    }\r\n    return false;\r\n  });\r\n  \r\n  if (foundSpecByKeyword) {\r\n    _extractSpecAndSkillInfo(actor, foundSpecByKeyword, result, 'willpower');\r\n  }\r\n}\r\n\r\n/**\r\n * Search in game.items for spell specialization\r\n */\r\nfunction _searchGameItemsForSpellSpec(\r\n  actor: any,\r\n  targetSpec: string,\r\n  spellSpecType: string,\r\n  result: AttackSkillSpecResult\r\n): void {\r\n  const normalizedTargetSpec = normalizeForComparison(targetSpec);\r\n  \r\n  // Search in game.items for the specialization\r\n  const specInGameItems = (game.items as any).find((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const normalizedItemName = normalizeForComparison(i.name);\r\n    return normalizedItemName === normalizedTargetSpec;\r\n  });\r\n  \r\n  const specKeywords: Record<string, string[]> = {\r\n    'combat': ['combat'],\r\n    'detection': ['détection', 'detection'],\r\n    'health': ['santé', 'sante', 'health'],\r\n    'illusion': ['illusion'],\r\n    'manipulation': ['manipulation'],\r\n    'counterspell': ['contresort', 'contre-sort']\r\n  };\r\n  \r\n  let specToUse = specInGameItems;\r\n  \r\n  // If still not found by exact match, try keyword search in game.items\r\n  if (!specToUse) {\r\n    const keywords = specKeywords[spellSpecType] || ['combat'];\r\n    const normalizedKeywords = keywords.map(kw => ItemSearch.normalizeSearchText(kw));\r\n    \r\n    specToUse = (game.items as any).find((i: any) => {\r\n      if (i.type !== 'specialization') return false;\r\n      const normalizedName = ItemSearch.normalizeSearchText(i.name);\r\n      const linkedSkill = (i.system as any)?.linkedSkill;\r\n      if (linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === 'sorcellerie') {\r\n        return normalizedKeywords.some(normalizedKeyword => normalizedName.includes(normalizedKeyword));\r\n      }\r\n      return false;\r\n    });\r\n  }\r\n  \r\n  if (specToUse) {\r\n    const specSystem = specToUse.system as any;\r\n    const linkedSkillName = specSystem.linkedSkill;\r\n    \r\n    if (linkedSkillName) {\r\n      const parentSkill = actor.items.find((i: any) => \r\n        i.type === 'skill' && i.name === linkedSkillName\r\n      );\r\n      if (parentSkill) {\r\n        const skillSystem = parentSkill.system as any;\r\n        const linkedAttribute = skillSystem.linkedAttribute || 'willpower';\r\n        result.skillName = parentSkill.name;\r\n        result.linkedAttribute = linkedAttribute;\r\n        const skillLevel = (skillSystem.rating || 0) + ((actor.system as any).attributes?.[linkedAttribute] || 0);\r\n        result.skillLevel = skillLevel;\r\n        // Note: specName stays undefined since spec is not in actor\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Search in game.items for Sorcellerie skill\r\n */\r\nfunction _searchGameItemsForSorcellerie(actor: any, result: AttackSkillSpecResult): void {\r\n  const sorcerySkillInGame = (game.items as any).find((i: any) => \r\n    i.type === 'skill' && \r\n    ItemSearch.normalizeSearchText(i.name) === 'sorcellerie'\r\n  );\r\n  \r\n  if (sorcerySkillInGame) {\r\n    // Use default willpower attribute for Sorcellerie if skill not in actor\r\n    result.skillName = 'Sorcellerie';\r\n    result.linkedAttribute = 'willpower';\r\n    const willpower = (actor.system as any).attributes?.willpower || 1;\r\n    result.skillLevel = willpower; // Skill rating would be 0 if not in actor\r\n  }\r\n}\r\n\r\n/**\r\n * RR Source entry structure\r\n */\r\nexport interface RRSourceEntry {\r\n  featName: string;\r\n  rrValue: number;\r\n  rrType?: string;\r\n  rrTarget?: string;\r\n}\r\n\r\n/**\r\n * Result from calculating attack pool with RR\r\n */\r\nexport interface AttackPoolResult {\r\n  totalDicePool: number;\r\n  totalRR: number;\r\n  allRRSources: RRSourceEntry[];\r\n}\r\n\r\n/**\r\n * Calculate attack pool (dice pool and RR) from skill/spec result and item RR\r\n * Unifies the RR calculation logic used in getData() and _rollWeaponOrSpell()\r\n * \r\n * @param actor - The actor\r\n * @param skillSpecResult - Result from findAttackSkillAndSpec()\r\n * @param itemRRList - The item's rrList (from weapon/spell)\r\n * @param itemName - The item name (for RR source attribution)\r\n * @returns AttackPoolResult with dice pool and RR\r\n */\r\nexport function calculateAttackPool(\r\n  actor: any,\r\n  skillSpecResult: AttackSkillSpecResult,\r\n  itemRRList: any[] = [],\r\n  itemName: string = ''\r\n): AttackPoolResult {\r\n  // Calculate dice pool: use spec level if available, otherwise skill level, otherwise 0\r\n  const totalDicePool = skillSpecResult.specLevel || skillSpecResult.skillLevel || 0;\r\n  \r\n  // Get RR sources from skill/specialization/attribute\r\n  let skillRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  let specRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\r\n  \r\n  if (skillSpecResult.specName) {\r\n    specRRSources = getRRSources(actor, 'specialization', skillSpecResult.specName);\r\n  }\r\n  if (skillSpecResult.skillName) {\r\n    skillRRSources = getRRSources(actor, 'skill', skillSpecResult.skillName);\r\n  }\r\n  if (skillSpecResult.linkedAttribute) {\r\n    attributeRRSources = getRRSources(actor, 'attribute', skillSpecResult.linkedAttribute);\r\n  }\r\n  \r\n  // Convert item RR list to same format as getRRSources (objects with rrValue)\r\n  const itemRRSources = itemRRList.map((rrEntry: any) => ({\r\n    featName: itemName,\r\n    rrValue: rrEntry.rrValue || 0\r\n  }));\r\n  \r\n  // Merge all RR sources (item RR + skill/spec/attribute RR)\r\n  const allRRSources = [...itemRRSources, ...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n  \r\n  // Calculate total RR (sum of all RR values, max 3)\r\n  const totalRR = Math.min(3, allRRSources.reduce((sum: number, source: any) => {\r\n    return sum + (source.rrValue || 0);\r\n  }, 0));\r\n  \r\n  return {\r\n    totalDicePool,\r\n    totalRR,\r\n    allRRSources\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// ITEM SEARCH HELPERS\r\n// =============================================================================\r\n\r\n/**\r\n * Find a skill by name in an actor's items (normalized comparison)\r\n * \r\n * @param actor - The actor to search in\r\n * @param skillName - The skill name to find\r\n * @returns The found skill item or undefined\r\n */\r\nexport function findSkillByName(actor: any, skillName: string): any | undefined {\r\n  if (!actor || !skillName) return undefined;\r\n  \r\n  const normalizedName = ItemSearch.normalizeSearchText(skillName);\r\n  return actor.items.find((i: any) => \r\n    i.type === 'skill' && \r\n    ItemSearch.normalizeSearchText(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Find a specialization by name in an actor's items (normalized comparison)\r\n * \r\n * @param actor - The actor to search in\r\n * @param specName - The specialization name to find\r\n * @returns The found specialization item or undefined\r\n */\r\nexport function findSpecByName(actor: any, specName: string): any | undefined {\r\n  if (!actor || !specName) return undefined;\r\n  \r\n  const normalizedName = normalizeForComparison(specName);\r\n  return actor.items.find((i: any) => \r\n    i.type === 'specialization' && \r\n    normalizeForComparison(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Find an item by type and name in game.items (normalized comparison)\r\n * \r\n * @param itemType - The item type to find ('skill', 'specialization', etc.)\r\n * @param itemName - The item name to find\r\n * @returns The found item or undefined\r\n */\r\nexport function findItemInGame(itemType: string, itemName: string): any | undefined {\r\n  if (!game.items || !itemName) return undefined;\r\n  \r\n  const normalizedName = normalizeForComparison(itemName);\r\n  return (game.items as any).find((i: any) => \r\n    i.type === itemType && \r\n    normalizeForComparison(i.name) === normalizedName\r\n  );\r\n}\r\n\r\n/**\r\n * Calculate skill dice pool (attribute + rating)\r\n * \r\n * @param actor - The actor\r\n * @param skill - The skill item\r\n * @returns The total dice pool\r\n */\r\nexport function calculateSkillDicePool(actor: any, skill: any): number {\r\n  if (!actor || !skill) return 0;\r\n  \r\n  const skillSystem = skill.system as any;\r\n  const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n  const attributeValue = (actor.system as any).attributes?.[linkedAttribute] || 0;\r\n  const skillRating = skillSystem.rating || 0;\r\n  \r\n  return attributeValue + skillRating;\r\n}\r\n\r\n/**\r\n * Calculate specialization dice pool (attribute + skill rating + 2)\r\n * \r\n * @param actor - The actor\r\n * @param spec - The specialization item\r\n * @param parentSkill - Optional parent skill (if not provided, will be found)\r\n * @returns The total dice pool\r\n */\r\nexport function calculateSpecDicePool(actor: any, spec: any, parentSkill?: any): number {\r\n  if (!actor || !spec) return 0;\r\n  \r\n  const specSystem = spec.system as any;\r\n  const linkedSkillName = specSystem.linkedSkill;\r\n  \r\n  // Find parent skill if not provided\r\n  const skill = parentSkill || findSkillByName(actor, linkedSkillName);\r\n  if (!skill) return 0;\r\n  \r\n  const skillDicePool = calculateSkillDicePool(actor, skill);\r\n  return skillDicePool + 2; // Specialization adds +2\r\n}\r\n\r\n/**\r\n * Get the linked attribute for a skill or specialization\r\n * \r\n * @param item - The skill or specialization item\r\n * @param actor - Optional actor to search for parent skill (for specs)\r\n * @returns The linked attribute name\r\n */\r\nexport function getLinkedAttribute(item: any, actor?: any): string {\r\n  if (!item) return 'strength';\r\n  \r\n  const itemSystem = item.system as any;\r\n  \r\n  // If skill, return its linked attribute\r\n  if (item.type === 'skill') {\r\n    return itemSystem.linkedAttribute || 'strength';\r\n  }\r\n  \r\n  // If specialization, find the parent skill's linked attribute\r\n  if (item.type === 'specialization' && actor) {\r\n    const linkedSkillName = itemSystem.linkedSkill;\r\n    const parentSkill = findSkillByName(actor, linkedSkillName);\r\n    if (parentSkill) {\r\n      return (parentSkill.system as any).linkedAttribute || 'strength';\r\n    }\r\n  }\r\n  \r\n  // Fallback\r\n  return itemSystem.linkedAttribute || 'strength';\r\n}\r\n\r\n/**\r\n * Find default defense selection for an actor\r\n * Unified logic for finding the appropriate defense skill/spec\r\n * \r\n * @param actor - The defending actor\r\n * @param linkedDefenseSpec - The target defense specialization name\r\n * @param linkedDefenseSkill - The target defense skill name (fallback)\r\n * @returns Object with defaultSelection string and found items\r\n */\r\nexport interface DefenseSearchResult {\r\n  defaultSelection: string;\r\n  linkedSpec: any | undefined;\r\n  linkedSkill: any | undefined;\r\n}\r\n\r\nexport function findDefenseSelection(\r\n  actor: any,\r\n  linkedDefenseSpec: string,\r\n  linkedDefenseSkill?: string\r\n): DefenseSearchResult {\r\n  const result: DefenseSearchResult = {\r\n    defaultSelection: '',\r\n    linkedSpec: undefined,\r\n    linkedSkill: undefined\r\n  };\r\n  \r\n  const skills = actor.items.filter((i: any) => i.type === 'skill');\r\n  \r\n  // 1. Try to find the linked defense specialization\r\n  if (linkedDefenseSpec) {\r\n    result.linkedSpec = findSpecByName(actor, linkedDefenseSpec);\r\n    \r\n    if (result.linkedSpec) {\r\n      result.defaultSelection = `spec-${result.linkedSpec.id}`;\r\n      // Find the parent skill\r\n      const linkedSkillName = result.linkedSpec.system.linkedSkill;\r\n      result.linkedSkill = findSkillByName(actor, linkedSkillName);\r\n      return result;\r\n    }\r\n  }\r\n  \r\n  // 2. Try to find the defense skill\r\n  if (linkedDefenseSkill) {\r\n    result.linkedSkill = findSkillByName(actor, linkedDefenseSkill);\r\n    \r\n    if (result.linkedSkill) {\r\n      result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n      return result;\r\n    }\r\n  }\r\n  \r\n  // 3. Fallback: Search in game.items for the spec template\r\n  if (linkedDefenseSpec && game.items) {\r\n    const specTemplate = findItemInGame('specialization', linkedDefenseSpec);\r\n    \r\n    if (specTemplate) {\r\n      const linkedSkillName = specTemplate.system.linkedSkill;\r\n      if (linkedSkillName) {\r\n        result.linkedSkill = findSkillByName(actor, linkedSkillName);\r\n        if (result.linkedSkill) {\r\n          result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n          return result;\r\n        }\r\n      }\r\n    }\r\n  }\r\n  \r\n  // 4. Default to first skill\r\n  if (skills.length > 0) {\r\n    result.linkedSkill = skills[0];\r\n    result.defaultSelection = `skill-${result.linkedSkill.id}`;\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n/**\r\n * Get all specializations for a skill (by name, normalized comparison)\r\n * \r\n * @param actor - The actor\r\n * @param skillName - The skill name to find specs for\r\n * @returns Array of specializations linked to this skill\r\n */\r\nexport function getSpecializationsForSkill(actor: any, skillName: string): any[] {\r\n  if (!actor || !skillName) return [];\r\n  \r\n  const normalizedSkillName = ItemSearch.normalizeSearchText(skillName);\r\n  \r\n  return actor.items.filter((i: any) => {\r\n    if (i.type !== 'specialization') return false;\r\n    const linkedSkill = (i.system as any)?.linkedSkill;\r\n    return linkedSkill && ItemSearch.normalizeSearchText(linkedSkill) === normalizedSkillName;\r\n  });\r\n}\r\n\r\n","/**\r\n * Combat Helpers for SRA2\r\n * Shared functions for combat, defense, and attack calculations\r\n */\r\n\r\nimport * as SheetHelpers from './sheet-helpers.js';\r\nimport { VEHICLE_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Calculate NPC threshold for a skill or specialization\r\n */\r\nexport function calculateNPCThreshold(\r\n  actor: any,\r\n  item: any,\r\n  dicePool: number,\r\n  itemType: 'skill' | 'specialization',\r\n  parentSkill?: any\r\n): { threshold: number; totalRR: number } {\r\n  let totalRR = 0;\r\n  \r\n  // Get all active feats\r\n  const activeFeats = actor.items.filter((i: any) => \r\n    i.type === 'feat' && i.system.active === true\r\n  );\r\n  \r\n  // Get linked attribute for this item\r\n  const linkedAttribute = item.system.linkedAttribute;\r\n  \r\n  // Check each feat for RR that applies\r\n  activeFeats.forEach((feat: any) => {\r\n    const rrList = feat.system.rrList || [];\r\n    rrList.forEach((rrEntry: any) => {\r\n      // Check if RR applies to this item\r\n      if (itemType === 'skill' && rrEntry.rrType === 'skill' && rrEntry.rrTarget === item.name) {\r\n        totalRR += rrEntry.rrValue || 0;\r\n      } else if (itemType === 'specialization') {\r\n        // For specializations, check spec RR and also inherit skill RR\r\n        if (rrEntry.rrType === 'specialization' && rrEntry.rrTarget === item.name) {\r\n          totalRR += rrEntry.rrValue || 0;\r\n        } else if (parentSkill && rrEntry.rrType === 'skill' && rrEntry.rrTarget === parentSkill.name) {\r\n          totalRR += rrEntry.rrValue || 0;\r\n        }\r\n      }\r\n      \r\n      // Also check for attribute RR\r\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\r\n        totalRR += rrEntry.rrValue || 0;\r\n      }\r\n    });\r\n  });\r\n  \r\n  // Calculate NPC threshold: round(dice pool / 3) + RR + 1\r\n  const threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n  \r\n  return { threshold, totalRR };\r\n}\r\n\r\n/**\r\n * Build skill and specialization options HTML for defense dialog\r\n */\r\nexport interface BuildSkillOptionsParams {\r\n  defenderActor: any;\r\n  skills: any[];\r\n  allSpecializations: any[];\r\n  defaultSelection: string;\r\n  includeThreshold?: boolean; // Whether to show NPC threshold\r\n}\r\n\r\nexport function buildSkillOptionsHtml(params: BuildSkillOptionsParams): string {\r\n  const { defenderActor, skills, allSpecializations: _allSpecializations, defaultSelection, includeThreshold = false } = params;\r\n  \r\n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.COMBAT.SELECT_DEFENSE_SKILL') + ' --</option>';\r\n  \r\n  // Sort skills alphabetically by name\r\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n  \r\n  sortedSkills.forEach((skill: any) => {\r\n    const skillSystem = skill.system as any;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (defenderActor.system as any).attributes?.[linkedAttribute] || 0;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const totalDicePool = attributeValue + skillRating;\r\n    \r\n    let optionText = `${skill.name} (${totalDicePool} dés)`;\r\n    let dataAttrs = `data-dice-pool=\"${totalDicePool}\"`;\r\n    \r\n    // Calculate threshold if requested\r\n    if (includeThreshold) {\r\n      const { threshold } = calculateNPCThreshold(defenderActor, skill, totalDicePool, 'skill');\r\n      optionText = `${skill.name} (Seuil: ${threshold} / ${totalDicePool} dés)`;\r\n      dataAttrs += ` data-threshold=\"${threshold}\"`;\r\n    }\r\n    \r\n    // Check if this skill should be selected by default\r\n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\r\n    \r\n    html += `<option value=\"skill-${skill.id}\" ${dataAttrs}${selected}>${optionText}</option>`;\r\n    \r\n    // Add specializations for this skill using helper\r\n    const specs = SheetHelpers.getSpecializationsForSkill(defenderActor, skill.name);\r\n    \r\n    specs.forEach((spec: any) => {\r\n      const specTotalDicePool = SheetHelpers.calculateSpecDicePool(defenderActor, spec, skill);\r\n      const effectiveRating = skillRating + 2;\r\n      \r\n      let specOptionText = `  → ${spec.name} (${specTotalDicePool} dés)`;\r\n      let specDataAttrs = `data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"`;\r\n      \r\n      // Calculate threshold if requested\r\n      if (includeThreshold) {\r\n        const { threshold: specThreshold } = calculateNPCThreshold(defenderActor, spec, specTotalDicePool, 'specialization', skill);\r\n        specOptionText = `  → ${spec.name} (Seuil: ${specThreshold} / ${specTotalDicePool} dés)`;\r\n        specDataAttrs += ` data-threshold=\"${specThreshold}\"`;\r\n      }\r\n      \r\n      // Check if this specialization should be selected by default\r\n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\r\n      \r\n      html += `<option value=\"spec-${spec.id}\" ${specDataAttrs}${specSelected}>${specOptionText}</option>`;\r\n    });\r\n  });\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * REMOVED: Defense dice roll function\r\n */\r\n\r\n/**\r\n * REMOVED: Dice results HTML building\r\n */\r\n\r\n/**\r\n * Parse weapon damage value and calculate base VD\r\n * Includes damageValueBonus from weapon feat\r\n * \r\n * @deprecated Use SheetHelpers.parseDamageValue() for more complete information\r\n */\r\nexport function parseWeaponDamageValue(\r\n  weaponDamageValue: string | number,\r\n  actorStrength: number,\r\n  damageValueBonus: number = 0\r\n): { baseVD: number; vdDisplay: string } {\r\n  // Delegate to the shared helper\r\n  const result = SheetHelpers.parseDamageValue(String(weaponDamageValue), actorStrength, damageValueBonus);\r\n  \r\n  return {\r\n    baseVD: result.isToxin ? -1 : result.numericValue,\r\n    vdDisplay: result.displayValue\r\n  };\r\n}\r\n\r\n/**\r\n * REMOVED: NPC attack HTML building\r\n */\r\n\r\n/**\r\n * REMOVED: Threshold defense result creation\r\n */\r\n\r\n/**\r\n * Build skill selection options for weapon/spell attack\r\n * Similar to buildSkillOptionsHtml but without threshold calculation\r\n */\r\nexport function buildAttackSkillOptionsHtml(\r\n  actor: any,\r\n  skills: any[],\r\n  _allSpecializations: any[],\r\n  defaultSelection: string\r\n): string {\r\n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.FEATS.WEAPON.SELECT_SKILL') + ' --</option>';\r\n  \r\n  // Sort skills alphabetically by name\r\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n  \r\n  sortedSkills.forEach((skill: any) => {\r\n    const skillSystem = skill.system as any;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (actor.system as any).attributes?.[linkedAttribute] || 0;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const totalDicePool = attributeValue + skillRating;\r\n    \r\n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\r\n    html += `<option value=\"skill-${skill.id}\" data-dice-pool=\"${totalDicePool}\"${selected}>${skill.name} (${totalDicePool} dés)</option>`;\r\n    \r\n    // Add specializations for this skill using helper\r\n    const specs = SheetHelpers.getSpecializationsForSkill(actor, skill.name);\r\n    \r\n    specs.forEach((spec: any) => {\r\n      const specTotalDicePool = SheetHelpers.calculateSpecDicePool(actor, spec, skill);\r\n      const effectiveRating = skillRating + 2;\r\n      \r\n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\r\n      html += `<option value=\"spec-${spec.id}\" data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"${specSelected}>  → ${spec.name} (${specTotalDicePool} dés)</option>`;\r\n    });\r\n  });\r\n  \r\n  return html;\r\n}\r\n\r\n/**\r\n * REMOVED: Weapon/spell dialog content creation\r\n */\r\n\r\n/**\r\n * REMOVED: Attack result display and chat message creation\r\n */\r\n\r\n/**\r\n * Prepare vehicle/drone weapon attack data for dice rolling\r\n * Vehicles use autopilot as dice pool instead of skills\r\n */\r\nexport function prepareVehicleWeaponAttack(\r\n  vehicleActor: any,\r\n  weapon: any\r\n): {\r\n  dicePool: number;\r\n  rrList: Array<{ featName: string; rrValue: number }>;\r\n  damageValue: string;\r\n} {\r\n  const vehicleSystem = vehicleActor.system as any;\r\n  const weaponSystem = weapon.system as any;\r\n  \r\n  // Get autopilot as base dice pool (with bonus included)\r\n  // attributes.autopilot should already contain finalAutopilot = baseAutopilot + autopilotBonus (max 12)\r\n  // But to ensure bonus is always included, we recalculate it if needed\r\n  let autopilot = vehicleSystem.attributes?.autopilot;\r\n  \r\n  // Always recalculate to ensure autopilotBonus is included (in case prepareDerivedData wasn't called)\r\n  const vehicleType = vehicleSystem.vehicleType || \"\";\r\n  const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \r\n    ? VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \r\n    : null;\r\n  const baseAutopilot = vehicleStats?.autopilot || 6;\r\n  const autopilotBonus = vehicleSystem.autopilotBonus || 0;\r\n  const calculatedAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\r\n  \r\n  // Use calculated value to ensure bonus is always included\r\n  autopilot = calculatedAutopilot;\r\n  const dicePool = autopilot;\r\n  \r\n  // Get all active feats for RR calculation\r\n  const activeFeats = vehicleActor.items.filter((item: any) => \r\n    item.type === 'feat' && item.system.active === true\r\n  );\r\n  \r\n  // Calculate RR from active feats (only autopilot attribute RR applies)\r\n  const rrList: Array<{ featName: string; rrValue: number }> = [];\r\n  activeFeats.forEach((feat: any) => {\r\n    const featRRList = feat.system.rrList || [];\r\n    featRRList.forEach((rrEntry: any) => {\r\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n        rrList.push({\r\n          featName: feat.name,\r\n          rrValue: rrEntry.rrValue || 0\r\n        });\r\n      }\r\n    });\r\n  });\r\n  \r\n  // Also check weapon's own RR list and enrich with featName\r\n  const weaponRRList = weaponSystem.rrList || [];\r\n  weaponRRList.forEach((rrEntry: any) => {\r\n    if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n      rrList.push({\r\n        featName: weapon.name,\r\n        rrValue: rrEntry.rrValue || 0\r\n      });\r\n    }\r\n  });\r\n  \r\n  // Calculate final damage value (base + bonus) - same logic as character-sheet.ts\r\n  const baseDamageValue = parseInt(weaponSystem.damageValue || '0') || 0;\r\n  let damageValueBonus = parseInt(weaponSystem.damageValueBonus || '0') || 0;\r\n  \r\n  // Add bonus from active feats that match the weapon's type\r\n  const weaponType = weaponSystem.weaponType || '';\r\n  activeFeats.forEach((activeFeat: any) => {\r\n    if (activeFeat.system.weaponDamageBonus > 0 &&\r\n        activeFeat.system.weaponTypeBonus === weaponType) {\r\n      damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n    }\r\n  });\r\n  \r\n  // Limit total bonus to 2 maximum\r\n  damageValueBonus = Math.min(damageValueBonus, 2);\r\n  \r\n  let finalDamageValue = baseDamageValue + damageValueBonus;\r\n  \r\n  return {\r\n    dicePool,\r\n    rrList,\r\n    damageValue: finalDamageValue.toString()\r\n  };\r\n}\r\n\r\n/**\r\n * Prepare complete vehicle/drone weapon roll request data for DiceRoller\r\n * Uses prepareVehicleWeaponAttack and adds weapon type links\r\n */\r\nexport function prepareVehicleWeaponRollRequest(\r\n  vehicleActor: any,\r\n  weapon: any,\r\n  WEAPON_TYPES: any\r\n): any {\r\n  const weaponSystem = weapon.system as any;\r\n  const weaponType = weaponSystem.weaponType || 'custom-weapon';\r\n  \r\n  // Get weapon attack data using existing helper\r\n  const attackData = prepareVehicleWeaponAttack(vehicleActor, weapon);\r\n  \r\n  // Get weapon type links for defense skills\r\n  let weaponLinkedDefenseSkill = '';\r\n  let weaponLinkedDefenseSpecialization = '';\r\n  \r\n  if (weaponType && weaponType !== 'custom-weapon') {\r\n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n    if (weaponStats) {\r\n      weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\r\n      weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\r\n    }\r\n  }\r\n  \r\n  // Merge with custom fields (weapon type has priority)\r\n  const finalDefenseSkill = weaponLinkedDefenseSkill || weaponSystem.linkedDefenseSkill || '';\r\n  const finalDefenseSpec = weaponLinkedDefenseSpecialization || weaponSystem.linkedDefenseSpecialization || '';\r\n  \r\n  // Return complete roll request data\r\n  return {\r\n    itemType: 'weapon',\r\n    weaponType: weaponType,\r\n    itemName: weapon.name,\r\n    itemId: weapon.id,\r\n    itemRating: weaponSystem.rating || 0,\r\n    itemActive: weaponSystem.active,\r\n    \r\n    // No linked attack skill/spec for vehicles (uses autopilot directly)\r\n    linkedAttackSkill: '',\r\n    linkedAttackSpecialization: '',\r\n    linkedDefenseSkill: finalDefenseSkill,\r\n    linkedDefenseSpecialization: finalDefenseSpec,\r\n    linkedAttribute: 'autopilot', // Vehicles use autopilot attribute\r\n    \r\n    // Weapon properties\r\n    isWeaponFocus: weaponSystem.isWeaponFocus || false,\r\n    damageValue: attackData.damageValue, // Already includes bonus\r\n    meleeRange: weaponSystem.meleeRange,\r\n    shortRange: weaponSystem.shortRange,\r\n    mediumRange: weaponSystem.mediumRange,\r\n    longRange: weaponSystem.longRange,\r\n    \r\n    // Attack skill/spec (empty for vehicles, dice pool comes from autopilot)\r\n    skillName: undefined,\r\n    skillLevel: attackData.dicePool, // Use autopilot as skill level for dice pool\r\n    specName: undefined,\r\n    specLevel: undefined,\r\n    \r\n    // Actor information\r\n    actorId: vehicleActor.id,\r\n    actorUuid: vehicleActor.uuid,\r\n    actorName: vehicleActor.name || '',\r\n    \r\n    // RR List\r\n    rrList: attackData.rrList\r\n  };\r\n}\r\n\r\n/**\r\n * Apply damage to a defender (character, NPC, or vehicle/drone)\r\n * Handles different damage thresholds for vehicles vs characters\r\n * @param defenderUuid - UUID of the defender\r\n * @param damageValue - Damage value to apply\r\n * @param defenderName - Name of the defender (for notifications)\r\n * @param damageType - Type of damage: 'physical' (default) or 'mental' (for direct spells)\r\n */\r\n/**\r\n * Create an ICE attack message in chat\r\n * ICEs have a fixed threshold (server index) instead of rolling dice\r\n */\r\nexport async function createIceAttackMessage(\r\n  iceActor: any,\r\n  iceToken: any,\r\n  defender: any,\r\n  defenderToken: any\r\n): Promise<void> {\r\n  const iceSystem = iceActor.system as any;\r\n  const iceType = iceSystem.iceType;\r\n  const serverIndex = iceSystem.serverIndex || 1;\r\n  const threshold = iceSystem.threshold || serverIndex;\r\n  const damageValue = iceSystem.damageValue || 0;\r\n  \r\n  // Only ICEs that can attack (not Patrol, Acid, Blocker, Glue, Tracker)\r\n  const attackingIceTypes = ['blaster', 'black', 'killer'];\r\n  if (!attackingIceTypes.includes(iceType)) {\r\n    ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.CANNOT_ATTACK'));\r\n    return;\r\n  }\r\n  \r\n  // Get token UUIDs\r\n  const iceTokenUuid = iceToken?.uuid || iceToken?.document?.uuid;\r\n  const defenderTokenUuid = defenderToken?.uuid || defenderToken?.document?.uuid;\r\n  \r\n  // Determine final UUIDs (token actor UUID for NPCs)\r\n  const finalIceUuid = iceToken?.actor?.uuid || iceActor.uuid;\r\n  const finalDefenderUuid = defenderToken?.actor?.uuid || defender.uuid;\r\n  \r\n  // Create a fake roll result with fixed threshold\r\n  const rollResult = {\r\n    normalDice: [],\r\n    riskDice: [],\r\n    normalSuccesses: 0,\r\n    riskSuccesses: 0,\r\n    totalSuccesses: threshold, // ICE uses fixed threshold\r\n    criticalFailures: 0,\r\n    finalRR: 0,\r\n    remainingFailures: 0,\r\n    complication: 'none'\r\n  };\r\n  \r\n  // Prepare roll data for ICE attack\r\n  const rollData = {\r\n    itemType: 'ice-attack',\r\n    iceType: iceType,\r\n    serverIndex: serverIndex,\r\n    threshold: threshold,\r\n    damageValue: damageValue.toString(),\r\n    iceDamageValue: damageValue, // Store separately for defense calculation\r\n    skillName: 'Cybercombat (GLACE)',\r\n    itemName: iceActor.name,\r\n    isAttack: true,\r\n    isDefend: false,\r\n    isCounterAttack: false,\r\n    isSpellDirect: false\r\n  };\r\n  \r\n  // Prepare defender data with token image\r\n  let defenderData: any = null;\r\n  if (defender) {\r\n    let tokenImg = defender.img;\r\n    if (defenderToken) {\r\n      tokenImg = (defenderToken as any).document?.texture?.src || \r\n                 (defenderToken as any).document?.img || \r\n                 (defenderToken as any).data?.img || \r\n                 (defenderToken as any).texture?.src ||\r\n                 defender.img;\r\n    }\r\n    \r\n    defenderData = {\r\n      ...defender,\r\n      img: tokenImg\r\n    };\r\n  }\r\n  \r\n  // Prepare template data\r\n  const templateData: any = {\r\n    attacker: {\r\n      ...iceActor,\r\n      uuid: finalIceUuid\r\n    },\r\n    defender: defenderData,\r\n    rollData: rollData,\r\n    rollResult: rollResult,\r\n    isAttack: true,\r\n    isDefend: false,\r\n    isCounterAttack: false,\r\n    skillName: 'Cybercombat (GLACE)',\r\n    itemName: iceActor.name,\r\n    damageValue: damageValue.toString(),\r\n    attackerUuid: finalIceUuid,\r\n    defenderUuid: finalDefenderUuid,\r\n    attackerTokenUuid: iceTokenUuid,\r\n    defenderTokenUuid: defenderTokenUuid\r\n  };\r\n  \r\n  // Render template\r\n  const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n  \r\n  // Create chat message\r\n  const messageData: any = {\r\n    user: game.user?.id,\r\n    speaker: {\r\n      actor: iceActor.id,\r\n      alias: iceActor.name\r\n    },\r\n    content: html,\r\n    type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n    flags: {\r\n      sra2: {\r\n        rollType: 'ice-attack',\r\n        attackerId: iceActor.id,\r\n        attackerUuid: finalIceUuid,\r\n        attackerTokenUuid: iceTokenUuid,\r\n        defenderId: defender?.id,\r\n        defenderUuid: finalDefenderUuid,\r\n        defenderTokenUuid: defenderTokenUuid,\r\n        rollResult: rollResult,\r\n        rollData: rollData,\r\n        iceType: iceType,\r\n        iceThreshold: threshold,\r\n        iceDamageValue: damageValue\r\n      }\r\n    }\r\n  };\r\n  \r\n  await ChatMessage.create(messageData);\r\n}\r\n\r\nexport async function applyDamage(defenderUuid: string, damageValue: number, defenderName: string, damageType: 'physical' | 'mental' = 'physical'): Promise<void> {\r\n  // Use fromUuid to get the token's actor if it's a token UUID, or the actor if it's an actor UUID\r\n  const defender = await fromUuid(defenderUuid as any) as any;\r\n  \r\n  if (!defender) {\r\n    ui.notifications?.error(`Cannot find defender: ${defenderName}`);\r\n    return;\r\n  }\r\n  \r\n  // If this is a token, get its actor\r\n  const defenderActor = defender.actor || defender;\r\n  \r\n  const defenderSystem = defenderActor.system as any;\r\n  const isVehicle = defenderActor.type === 'vehicle';\r\n  const isIce = defenderActor.type === 'ice';\r\n  \r\n  // Get damage thresholds based on actor type and damage type\r\n  let damageThresholds: { light: number; severe?: number; incapacitating: number };\r\n  if (isIce) {\r\n    // For ICE, thresholds are based on FW = 1: light = 1, severe = 2, incapacitating = 3\r\n    damageThresholds = defenderSystem.damageThresholds || {\r\n      light: 1,\r\n      severe: 2,\r\n      incapacitating: 3\r\n    };\r\n  } else if (isVehicle) {\r\n    // For vehicles/drones, thresholds are directly in damageThresholds\r\n    // Vehicles don't have mental damage thresholds, use physical\r\n    damageThresholds = defenderSystem.damageThresholds || {\r\n      light: 1,\r\n      severe: 4,\r\n      incapacitating: 7\r\n    };\r\n  } else {\r\n    // For characters, use mental thresholds for mental damage, physical for physical damage\r\n    if (damageType === 'mental') {\r\n      damageThresholds = defenderSystem.damageThresholds?.mental || {\r\n        light: 1,\r\n        severe: 4,\r\n        incapacitating: 7\r\n      };\r\n    } else {\r\n      // Physical damage: use withArmor thresholds\r\n      damageThresholds = defenderSystem.damageThresholds?.withArmor || {\r\n        light: 1,\r\n        severe: 4,\r\n        incapacitating: 7\r\n      };\r\n    }\r\n  }\r\n  \r\n  // Deep copy of damage object with arrays\r\n  let damage = {\r\n    light: [...(defenderSystem.damage?.light || [])],\r\n    severe: [...(defenderSystem.damage?.severe || [])],\r\n    incapacitating: defenderSystem.damage?.incapacitating || false\r\n  };\r\n  let woundType = '';\r\n  let overflow = false;\r\n  \r\n  // Determine damage type based on thresholds\r\n  // For ICE: light = 1, severe = 2, incapacitating = 3 (based on FW = 1)\r\n  // For vehicles: light = Structure + Armor, severe = (2 × Structure) + Armor, incapacitating = (3 × Structure) + Armor\r\n  // For characters: light, severe, incapacitating from withArmor thresholds\r\n  \r\n  if (isIce) {\r\n    // ICE damage thresholds\r\n    if (damageThresholds.incapacitating && damageValue > damageThresholds.incapacitating) {\r\n      // Incapacitating wound: VD > 3\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageValue > (damageThresholds?.severe || 0)) {\r\n      // Severe wound: VD > 2\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound: VD > 1\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound: VD ≤ 1\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  } else if (isVehicle) {\r\n    // Vehicle/drone damage thresholds\r\n    if (damageThresholds.incapacitating && damageValue > damageThresholds.incapacitating) {\r\n      // Incapacitating wound: VD > (3 × Structure) + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageValue > (damageThresholds.severe || 0)) {\r\n      // Severe wound: VD > (2 × Structure) + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound: VD > Structure + Blindage\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound: VD ≤ Structure + Blindage\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  } else {\r\n    // Character damage thresholds\r\n    if (damageValue > (damageThresholds?.incapacitating || 0)) {\r\n      // Incapacitating wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\r\n      damage.incapacitating = true;\r\n    } else if (damageThresholds.severe && damageValue > (damageThresholds.severe || 0)) {\r\n      // Severe wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\r\n      \r\n      // Find first empty severe box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.severe.length; i++) {\r\n        if (!damage.severe[i]) {\r\n          damage.severe[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in severe, overflow to incapacitating\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n        damage.incapacitating = true;\r\n        overflow = true;\r\n      }\r\n    } else if (damageValue > damageThresholds.light) {\r\n      // Light wound\r\n      woundType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\r\n      \r\n      // Find first empty light box\r\n      let applied = false;\r\n      for (let i = 0; i < damage.light.length; i++) {\r\n        if (!damage.light[i]) {\r\n          damage.light[i] = true;\r\n          applied = true;\r\n          break;\r\n        }\r\n      }\r\n      \r\n      // If no space in light, overflow to severe\r\n      if (!applied) {\r\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\r\n        \r\n        // Try to apply to severe\r\n        let severeApplied = false;\r\n        for (let i = 0; i < damage.severe.length; i++) {\r\n          if (!damage.severe[i]) {\r\n            damage.severe[i] = true;\r\n            severeApplied = true;\r\n            break;\r\n          }\r\n        }\r\n        \r\n        // If no space in severe either, overflow to incapacitating\r\n        if (!severeApplied) {\r\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\r\n          damage.incapacitating = true;\r\n        }\r\n        overflow = true;\r\n      }\r\n    } else {\r\n      // Damage below light threshold, no wound\r\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n        damage: `${damageValue} (en dessous du seuil)`,\r\n        target: defenderName \r\n      }));\r\n      return;\r\n    }\r\n  }\r\n  \r\n  // Update the actor's damage (use defenderActor to update the token's actor data)\r\n  // The prepareDerivedData() method now preserves existing damage values, so normal update should work\r\n  await defenderActor.update({ 'system.damage': damage });\r\n  \r\n  // Check if now incapacitated\r\n  if (damage.incapacitating === true) {\r\n    ui.notifications?.error(game.i18n!.format('SRA2.COMBAT.NOW_INCAPACITATED', { target: defenderName }));\r\n  } else {\r\n    ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \r\n      damage: overflow ? `${woundType} (débordement)` : woundType,\r\n      target: defenderName \r\n    }));\r\n  }\r\n}\r\n\r\n","import * as DiceRoller from '../helpers/dice-roller.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport { WEAPON_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Character Sheet Application\r\n */\r\nexport class CharacterSheet extends ActorSheet {\r\n  /** Active section for tabbed navigation */\r\n  private _activeSection: string = 'identity';\r\n\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'character'],\r\n      template: 'systems/sra2/templates/actor-character-sheet.hbs',\r\n      width: 900,\r\n      height: 700,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dragSelector: '.metatype-item', dropSelector: null },\r\n        { dragSelector: '.feat-item', dropSelector: null },\r\n        { dragSelector: '.skill-item', dropSelector: null },\r\n        { dragSelector: '.specialization-item', dropSelector: null }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override async getData(): Promise<any> {\r\n    const context = super.getData() as any;\r\n\r\n    // DEBUG: Log when character sheet getData is called\r\n    console.log('CharacterSheet.getData - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'stack': new Error().stack?.split('\\n').slice(1, 5).join('\\n')\r\n    });\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n    \r\n    // Ensure damage arrays are properly initialized\r\n    const systemData = context.system as any;\r\n    if (!systemData.damage) {\r\n      systemData.damage = {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n    } else {\r\n      // Ensure arrays exist and have at least the minimum length\r\n      if (!Array.isArray(systemData.damage.light)) {\r\n        systemData.damage.light = [false, false];\r\n      } else if (systemData.damage.light.length < 2) {\r\n        while (systemData.damage.light.length < 2) {\r\n          systemData.damage.light.push(false);\r\n        }\r\n      }\r\n      \r\n      if (!Array.isArray(systemData.damage.severe)) {\r\n        systemData.damage.severe = [false];\r\n      }\r\n      \r\n      if (typeof systemData.damage.incapacitating !== 'boolean') {\r\n        systemData.damage.incapacitating = false;\r\n      }\r\n    }\r\n    \r\n    // Ensure anarchySpent array is properly initialized\r\n    if (!Array.isArray(systemData.anarchySpent)) {\r\n      systemData.anarchySpent = [false, false, false];\r\n    } else if (systemData.anarchySpent.length < 3) {\r\n      while (systemData.anarchySpent.length < 3) {\r\n        systemData.anarchySpent.push(false);\r\n      }\r\n    }\r\n\r\n    // Get metatype (there should be only one)\r\n    const metatypes = this.actor.items.filter((item: any) => item.type === 'metatype');\r\n    context.metatype = metatypes.length > 0 ? metatypes[0] : null;\r\n    \r\n    // Calculate base anarchy (3 + metatype bonus) and bonus anarchy (from feats) for display purposes\r\n    const metatypeAnarchyBonus = context.metatype ? (context.metatype.system as any).anarchyBonus || 0 : 0;\r\n    context.baseAnarchy = 3 + metatypeAnarchyBonus;\r\n    \r\n    // Calculate bonus anarchy from active feats\r\n    const activeFeats = this.actor.items.filter((item: any) => \r\n      item.type === 'feat' && item.system.active === true\r\n    );\r\n    let bonusAnarchy = 0;\r\n    activeFeats.forEach((feat: any) => {\r\n      bonusAnarchy += feat.system.bonusAnarchy || 0;\r\n    });\r\n    context.bonusAnarchy = bonusAnarchy;\r\n    \r\n    // Create separate arrays for base and bonus anarchy trackers with correct indices\r\n    const anarchySpent = systemData.anarchySpent || [];\r\n    context.baseAnarchySpent = anarchySpent.slice(0, context.baseAnarchy).map((value: boolean, index: number) => ({\r\n      value: value,\r\n      index: index\r\n    }));\r\n    context.bonusAnarchySpent = anarchySpent.slice(context.baseAnarchy).map((value: boolean, index: number) => ({\r\n      value: value,\r\n      index: context.baseAnarchy + index\r\n    }));\r\n\r\n    // Get actor's strength for damage value calculations\r\n    const actorStrength = (this.actor.system as any).attributes?.strength || 0;\r\n    \r\n    // Get feats and enrich with RR target labels and calculated damage values\r\n    const rawFeats = this.actor.items.filter((item: any) => item.type === 'feat');\r\n    const allFeats = SheetHelpers.enrichFeats(rawFeats, actorStrength, SheetHelpers.calculateFinalDamageValue, this.actor);\r\n    \r\n    // Get linked vehicle actors\r\n    const linkedVehicleUuids = (this.actor.system as any).linkedVehicles || [];\r\n    const linkedVehicles: any[] = [];\r\n    for (const uuid of linkedVehicleUuids) {\r\n      try {\r\n        const vehicleActor = await fromUuid(uuid) as any;\r\n        if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n          // Get weapons from vehicle\r\n          const vehicleWeapons: any[] = [];\r\n          const vehicleItems = vehicleActor.items || [];\r\n          for (const item of vehicleItems) {\r\n            const itemSystem = item.system as any;\r\n            if (item.type === 'feat' && (itemSystem.featType === 'weapon' || itemSystem.featType === 'weapons-spells')) {\r\n              // Enrich weapon with character's stats for display\r\n              const enrichedWeapon = SheetHelpers.enrichFeats([item], actorStrength, SheetHelpers.calculateFinalDamageValue, this.actor)[0];\r\n              vehicleWeapons.push({\r\n                _id: item.id,\r\n                uuid: item.uuid,\r\n                name: item.name,\r\n                img: item.img,\r\n                type: 'vehicle-weapon',\r\n                vehicleUuid: uuid,\r\n                vehicleName: vehicleActor.name,\r\n                weaponId: item.id,\r\n                system: {\r\n                  ...itemSystem,\r\n                  finalDamageValue: enrichedWeapon.finalDamageValue,\r\n                  rrEntries: enrichedWeapon.rrEntries || [],\r\n                  crr: itemSystem.crr || 0 // Include CRR for display\r\n                }\r\n              });\r\n            }\r\n          }\r\n          \r\n          // Calculate vehicle level (base 1 + bonuses + options, excluding weapons)\r\n          const vehicleSystem = vehicleActor.system as any;\r\n          let vehicleLevel = 1; // Base level\r\n          vehicleLevel += vehicleSystem.autopilotBonus || 0;\r\n          vehicleLevel += vehicleSystem.speedBonus || 0;\r\n          vehicleLevel += vehicleSystem.handlingBonus || 0;\r\n          vehicleLevel += vehicleSystem.armorBonus || 0;\r\n          if (vehicleSystem.isFlying) vehicleLevel += 1;\r\n          if (vehicleSystem.weaponMountImprovement) vehicleLevel += 1;\r\n          if (vehicleSystem.autopilotUnlocked) vehicleLevel += 3;\r\n          if (vehicleSystem.additionalDroneCount) vehicleLevel += vehicleSystem.additionalDroneCount * 2;\r\n          if (vehicleSystem.isFixed) vehicleLevel -= 1;\r\n          const narrativeEffects = vehicleSystem.narrativeEffects || [];\r\n          // Handle both old format (strings) and new format (objects with text, isNegative, value)\r\n          const narrativeEffectsCount = narrativeEffects.filter((effect: any) => {\r\n            if (typeof effect === 'string') {\r\n              return effect && effect.trim() !== '';\r\n            } else if (effect && typeof effect === 'object') {\r\n              const hasText = effect.text && effect.text.trim() !== '';\r\n              const hasValue = effect.value !== undefined && effect.value !== null && effect.value !== 0;\r\n              return hasText && hasValue;\r\n            }\r\n            return false;\r\n          }).length;\r\n          vehicleLevel += narrativeEffectsCount;\r\n          \r\n          // Check vehicle damage status\r\n          const vehicleDamage = vehicleActor.system?.damage || {};\r\n          const vehicleSevereDamage = Array.isArray(vehicleDamage.severe) ? vehicleDamage.severe : [false];\r\n          const hasSevereDamage = vehicleSevereDamage.some((box: boolean) => box === true);\r\n          const isIncapacitating = vehicleDamage.incapacitating === true;\r\n\r\n          // Format vehicle actor data to match feat structure for template compatibility\r\n          linkedVehicles.push({\r\n            _id: vehicleActor.id,\r\n            uuid: vehicleActor.uuid,\r\n            name: vehicleActor.name,\r\n            img: vehicleActor.img,\r\n            type: 'vehicle-actor',\r\n            system: {\r\n              featType: 'vehicle',\r\n              autopilot: vehicleActor.system?.attributes?.autopilot || 0,\r\n              structure: vehicleActor.system?.attributes?.structure || 0,\r\n              handling: vehicleActor.system?.attributes?.handling || 0,\r\n              speed: vehicleActor.system?.attributes?.speed || 0,\r\n              armor: vehicleActor.system?.attributes?.armor || 0,\r\n              weaponInfo: vehicleActor.system?.weaponInfo || '',\r\n              calculatedCost: vehicleActor.system?.calculatedCost || 0,\r\n              description: vehicleActor.system?.description || '',\r\n              level: vehicleLevel\r\n            },\r\n            weapons: vehicleWeapons, // Add weapons array to vehicle\r\n            hasSevereDamage: hasSevereDamage, // Add damage status for V2 template\r\n            isIncapacitating: isIncapacitating // Add incapacitating status for V2 template\r\n          });\r\n        }\r\n      } catch (error) {\r\n        console.warn(`Failed to load vehicle actor ${uuid}:`, error);\r\n      }\r\n    }\r\n    \r\n    // Group feats by type (vehicle feats + linked vehicle actors)\r\n    const vehicleFeats = allFeats.filter((feat: any) => feat.system.featType === 'vehicle');\r\n    \r\n    // Enrich cyberdecks with damage thresholds\r\n    const cyberdeckFeats = allFeats.filter((feat: any) => feat.system.featType === 'cyberdeck');\r\n    cyberdeckFeats.forEach((cyberdeck: any) => {\r\n      const firewall = cyberdeck.system.firewall || 1;\r\n      cyberdeck.cyberdeckDamageThresholds = {\r\n        light: firewall,\r\n        severe: firewall * 2,\r\n        incapacitating: firewall * 3\r\n      };\r\n      // Calculate base light damage boxes (2, or 3 if cyberdeckBonusLightDamage is checked)\r\n      const baseLightBoxes = (cyberdeck.system.cyberdeckBonusLightDamage === true) ? 3 : 2;\r\n      \r\n      // Ensure cyberdeckDamage exists\r\n      if (!cyberdeck.system.cyberdeckDamage) {\r\n        cyberdeck.system.cyberdeckDamage = {\r\n          light: Array(baseLightBoxes).fill(false),\r\n          severe: [false],\r\n          incapacitating: false\r\n        };\r\n      } else {\r\n        // Ensure arrays exist and have correct length\r\n        if (!Array.isArray(cyberdeck.system.cyberdeckDamage.light)) {\r\n          cyberdeck.system.cyberdeckDamage.light = Array(baseLightBoxes).fill(false);\r\n        } else {\r\n          // Adjust array size based on bonus\r\n          const currentLength = cyberdeck.system.cyberdeckDamage.light.length;\r\n          if (currentLength < baseLightBoxes) {\r\n            // Add missing boxes (preserve existing values)\r\n            while (cyberdeck.system.cyberdeckDamage.light.length < baseLightBoxes) {\r\n              cyberdeck.system.cyberdeckDamage.light.push(false);\r\n            }\r\n          } else if (currentLength > baseLightBoxes) {\r\n            // Remove excess boxes (from the end, preserve existing values)\r\n            while (cyberdeck.system.cyberdeckDamage.light.length > baseLightBoxes) {\r\n              cyberdeck.system.cyberdeckDamage.light.pop();\r\n            }\r\n          }\r\n        }\r\n        if (!Array.isArray(cyberdeck.system.cyberdeckDamage.severe)) {\r\n          cyberdeck.system.cyberdeckDamage.severe = [false];\r\n        }\r\n        if (typeof cyberdeck.system.cyberdeckDamage.incapacitating !== 'boolean') {\r\n          cyberdeck.system.cyberdeckDamage.incapacitating = false;\r\n        }\r\n      }\r\n    });\r\n    \r\n    context.featsByType = {\r\n      trait: allFeats.filter((feat: any) => feat.system.featType === 'trait'),\r\n      contact: allFeats.filter((feat: any) => feat.system.featType === 'contact'),\r\n      awakened: allFeats.filter((feat: any) => feat.system.featType === 'awakened'),\r\n      adeptPower: allFeats.filter((feat: any) => \r\n        feat.system.featType === 'adept-power' || \r\n        ((feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells') && feat.system.isAdeptPowerWeapon === true)\r\n      ),\r\n      equipment: allFeats.filter((feat: any) => feat.system.featType === 'equipment'),\r\n      cyberware: allFeats.filter((feat: any) => feat.system.featType === 'cyberware'),\r\n      cyberdeck: cyberdeckFeats,\r\n      vehicle: [...vehicleFeats, ...linkedVehicles], // Combine vehicle feats and linked vehicle actors\r\n      weaponsSpells: allFeats.filter((feat: any) => feat.system.featType === 'weapons-spells'),\r\n      weapon: allFeats.filter((feat: any) => feat.system.featType === 'weapon'),\r\n      spell: allFeats.filter((feat: any) => feat.system.featType === 'spell'),\r\n      connaissance: allFeats.filter((feat: any) => feat.system.featType === 'connaissance')\r\n    };\r\n    \r\n    // Enrich weapons with dice pool and RR calculations (for V2 template)\r\n    context.featsByType.weapon = context.featsByType.weapon.map((weapon: any) => {\r\n      const weaponSystem = weapon.system as any;\r\n      const weaponType = weaponSystem.weaponType;\r\n      \r\n      // Get weapon type and linked skills\r\n      let weaponLinkedSkill = '';\r\n      let weaponLinkedSpecialization = '';\r\n      \r\n      if (weaponType && weaponType !== 'custom-weapon') {\r\n        const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n        if (weaponStats) {\r\n          weaponLinkedSkill = weaponStats.linkedSkill || '';\r\n          weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\r\n        }\r\n      }\r\n      \r\n      // Get final linked skills (from weapon type or custom)\r\n      const finalAttackSkill = weaponLinkedSkill || weaponSystem.linkedAttackSkill || '';\r\n      const finalAttackSpec = weaponLinkedSpecialization || weaponSystem.linkedAttackSpecialization || '';\r\n      \r\n      // Determine default attribute: if skill not found, use agility (except for \"Combat rapproché\" which uses strength)\r\n      let defaultAttribute: string;\r\n      const skillExists = this.actor.items.some((i: any) => \r\n        i.type === 'skill' && \r\n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\r\n      );\r\n      \r\n      if (!skillExists && finalAttackSkill) {\r\n        // Skill not found: use agility, except for \"Combat rapproché\" which uses strength\r\n        const normalizedSkillName = ItemSearch.normalizeSearchText(finalAttackSkill);\r\n        if (normalizedSkillName === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          defaultAttribute = 'strength';\r\n        } else {\r\n          defaultAttribute = 'agility';\r\n        }\r\n      } else {\r\n        // Skill exists or no skill name: use strength (will be overridden by skill's linkedAttribute if skill found)\r\n        defaultAttribute = 'strength';\r\n      }\r\n      \r\n      // Find skill/spec using unified helper\r\n      const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        finalAttackSkill,\r\n        { defaultAttribute }\r\n      );\r\n      \r\n      // Calculate dice pool and RR using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        skillSpecResult,\r\n        weaponSystem.rrList || [],\r\n        weapon.name\r\n      );\r\n      \r\n      // Add dice pool and RR to weapon\r\n      weapon.totalDicePool = poolResult.totalDicePool;\r\n      weapon.rr = poolResult.totalRR;\r\n      \r\n      // Also store spec info for potential specialization display later\r\n      if (skillSpecResult.specName) {\r\n        weapon.attackSpecName = skillSpecResult.specName;\r\n        weapon.attackSpecLevel = skillSpecResult.specLevel;\r\n      }\r\n      \r\n      return weapon;\r\n    });\r\n    \r\n    // Enrich vehicle weapons with dice pool and RR calculations (for V2 template)\r\n    for (const vehicle of context.featsByType.vehicle) {\r\n      if (vehicle.type === 'vehicle-actor' && vehicle.weapons) {\r\n        vehicle.weapons = vehicle.weapons.map((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          \r\n          // For vehicle/drone weapons controlled by owner, use Ingénierie (Spé : Armes contrôlées à distance)\r\n          const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n            this.actor,\r\n            'Spé : Armes contrôlées à distance',\r\n            'Ingénierie',\r\n            { defaultAttribute: 'logic' }\r\n          );\r\n          \r\n          // Calculate dice pool and RR using unified helper\r\n          const poolResult = SheetHelpers.calculateAttackPool(\r\n            this.actor,\r\n            skillSpecResult,\r\n            weaponSystem.rrList || [],\r\n            weapon.name\r\n          );\r\n          \r\n          // Add dice pool and RR to weapon\r\n          weapon.totalDicePool = poolResult.totalDicePool;\r\n          weapon.rr = poolResult.totalRR;\r\n          \r\n          // Store skill/spec info for roll dialog preselect\r\n          weapon.linkedAttackSkill = 'Ingénierie';\r\n          weapon.linkedAttackSpecialization = 'Spé : Armes contrôlées à distance';\r\n          weapon.linkedDefenseSkill = 'Athlétisme';\r\n          weapon.linkedDefenseSpecialization = 'Spé : Défense à distance';\r\n          \r\n          return weapon;\r\n        });\r\n      }\r\n    }\r\n    \r\n    // Enrich spells with dice pool and RR calculations (for V2 template)\r\n    context.featsByType.spell = context.featsByType.spell.map((spell: any) => {\r\n      const spellSystem = spell.system as any;\r\n      \r\n      // Get spell specialization type and map it to the specialization name\r\n      const spellSpecType = spellSystem.spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      const finalAttackSpec = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n      \r\n      // Find skill/spec using unified helper\r\n      const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        'Sorcellerie',\r\n        { isSpell: true, spellSpecType, defaultAttribute: 'willpower' }\r\n      );\r\n      \r\n      // Calculate dice pool and RR using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        skillSpecResult,\r\n        spellSystem.rrList || [],\r\n        spell.name\r\n      );\r\n      \r\n      // Add dice pool and RR to spell\r\n      spell.totalDicePool = poolResult.totalDicePool;\r\n      spell.rr = poolResult.totalRR;\r\n      \r\n      // Also store spec info for potential specialization display later\r\n      if (skillSpecResult.specName) {\r\n        spell.attackSpecName = skillSpecResult.specName;\r\n        spell.attackSpecLevel = skillSpecResult.specLevel;\r\n      }\r\n      \r\n      return spell;\r\n    });\r\n    \r\n    // Keep the feats array for backwards compatibility\r\n    context.feats = allFeats;\r\n    \r\n    // Get bookmarked items (skills, specializations, weapons, spells)\r\n    const bookmarkedItems = this.actor.items.filter((item: any) => \r\n      (item.type === 'skill' || item.type === 'specialization' || item.type === 'feat') && \r\n      item.system.bookmarked === true\r\n    );\r\n    context.bookmarkedItems = bookmarkedItems;\r\n    \r\n    // Get skills (sorted alphabetically)\r\n    const skills = this.actor.items\r\n      .filter((item: any) => item.type === 'skill')\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n    \r\n    // Get all specializations (sorted alphabetically)\r\n    const allSpecializations = this.actor.items\r\n      .filter((item: any) => item.type === 'specialization')\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n    \r\n    // Organize specializations by linked skill using helper\r\n    const { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations } = \r\n      SheetHelpers.organizeSpecializationsBySkill(allSpecializations, this.actor.items.contents);\r\n    \r\n    // Calculate RR for attributes first (needed for skills and specializations)\r\n    const attributesRR = {\r\n      strength: Math.min(3, this.calculateRR('attribute', 'strength')),\r\n      agility: Math.min(3, this.calculateRR('attribute', 'agility')),\r\n      willpower: Math.min(3, this.calculateRR('attribute', 'willpower')),\r\n      logic: Math.min(3, this.calculateRR('attribute', 'logic')),\r\n      charisma: Math.min(3, this.calculateRR('attribute', 'charisma'))\r\n    };\r\n    \r\n    // Add specializations to each skill and calculate RR\r\n    context.skills = skills.map((skill: any) => {\r\n      // Get linked attribute label for the skill\r\n      const linkedAttribute = skill.system?.linkedAttribute || 'strength';\r\n      skill.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\r\n      \r\n      // Calculate RR for this skill (skill RR + attribute RR, max 3)\r\n      const skillRR = this.calculateRR('skill', skill.name);\r\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\r\n      skill.rr = Math.min(3, skillRR + attributeRR);\r\n      \r\n      // Calculate total dice pool (attribute + skill rating)\r\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\r\n      const skillRating = skill.system?.rating || 0;\r\n      skill.totalDicePool = attributeValue + skillRating;\r\n      \r\n      // Get specializations for this skill and add calculated ratings (sorted alphabetically)\r\n      const specs = (specializationsBySkill.get(skill.id) || []).sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n      skill.specializations = specs.map((spec: any) => {\r\n        const parentRating = skill.system?.rating || 0;\r\n        // Add properties directly to the spec object instead of creating a new one\r\n        spec.parentRating = parentRating;\r\n        spec.effectiveRating = parentRating + 2;  // Specialization adds +2 to skill rating\r\n        spec.parentSkillName = skill.name;\r\n        \r\n        // Get linked attribute label for the specialization\r\n        const specLinkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n        spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${specLinkedAttribute.toUpperCase()}`);\r\n        \r\n        // Calculate RR for this specialization (attribute RR + skill RR + spec RR, max 3)\r\n        const specRR = this.calculateRR('specialization', spec.name);\r\n        const specAttributeRR = (attributesRR as any)[specLinkedAttribute] || 0;\r\n        const parentSkillRR = skillRR; // RR of the parent skill\r\n        spec.rr = Math.min(3, specAttributeRR + parentSkillRR + specRR);\r\n        \r\n        // Calculate total dice pool (attribute + effective rating)\r\n        const specAttributeValue = (this.actor.system as any).attributes[specLinkedAttribute] || 0;\r\n        spec.totalDicePool = specAttributeValue + spec.effectiveRating;\r\n        \r\n        return spec;\r\n      });\r\n      return skill;\r\n    });\r\n    \r\n    // Add unlinked specializations with attribute labels and RR (sorted alphabetically)\r\n    context.unlinkedSpecializations = unlinkedSpecializations\r\n      .sort((a: any, b: any) => a.name.localeCompare(b.name))\r\n      .map((spec: any) => {\r\n      const linkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n      spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\r\n      \r\n      // Calculate RR for this specialization (spec RR + attribute RR, max 3)\r\n      // Note: unlinked specializations don't have a parent skill, so only attribute + spec RR\r\n      const specRR = this.calculateRR('specialization', spec.name);\r\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\r\n      spec.rr = Math.min(3, specRR + attributeRR);\r\n      \r\n      // Calculate total dice pool (attribute only, since no skill linked)\r\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\r\n      spec.totalDicePool = attributeValue;\r\n      \r\n      return spec;\r\n    });\r\n    \r\n    // Store attributesRR in context\r\n    context.attributesRR = attributesRR;\r\n\r\n    // Add active section for navigation\r\n    context.activeSection = this._activeSection;\r\n\r\n    // Check if actor has severe damage (at least one severe damage box checked)\r\n    const damage = systemData.damage || {};\r\n    const severeDamage = Array.isArray(damage.severe) ? damage.severe : [false];\r\n    context.hasSevereDamage = severeDamage.some((box: boolean) => box === true);\r\n\r\n    return context;\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.skill-search');\r\n    $(document).off('click.feat-search');\r\n    return super.close(options);\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Switch sheet button\r\n    html.find('[data-action=\"switch-sheet\"]').on('click', this._onSwitchSheet.bind(this));\r\n\r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n\r\n    // Edit metatype\r\n    html.find('[data-action=\"edit-metatype\"]').on('click', this._onEditMetatype.bind(this));\r\n    \r\n    // Delete metatype\r\n    html.find('[data-action=\"delete-metatype\"]').on('click', this._onDeleteMetatype.bind(this));\r\n\r\n    // Edit feat\r\n    html.find('[data-action=\"edit-feat\"]').on('click', this._onEditFeat.bind(this));\r\n\r\n    // Delete feat\r\n    html.find('[data-action=\"delete-feat\"]').on('click', this._onDeleteFeat.bind(this));\r\n\r\n    // Open vehicle sheet\r\n    html.find('[data-action=\"open-vehicle\"]').on('click', this._onOpenVehicle.bind(this));\r\n\r\n    // Unlink vehicle\r\n    html.find('[data-action=\"unlink-vehicle\"]').on('click', this._onUnlinkVehicle.bind(this));\r\n\r\n    // Edit skill\r\n    html.find('[data-action=\"edit-skill\"]').on('click', this._onEditSkill.bind(this));\r\n\r\n    // Delete skill\r\n    html.find('[data-action=\"delete-skill\"]').on('click', this._onDeleteSkill.bind(this));\r\n\r\n    // Edit specialization\r\n    html.find('[data-action=\"edit-specialization\"]').on('click', this._onEditSpecialization.bind(this));\r\n\r\n    // Delete specialization\r\n    html.find('[data-action=\"delete-specialization\"]').on('click', this._onDeleteSpecialization.bind(this));\r\n\r\n    // Roll attribute\r\n    html.find('[data-action=\"roll-attribute\"]').on('click', this._onRollAttribute.bind(this));\r\n\r\n    // Roll skill\r\n    html.find('[data-action=\"roll-skill\"]').on('click', this._onRollSkill.bind(this));\r\n\r\n    // Quick roll skill (from dice badge)\r\n    html.find('[data-action=\"quick-roll-skill\"]').on('click', this._onQuickRollSkill.bind(this));\r\n\r\n    // Roll specialization\r\n    html.find('[data-action=\"roll-specialization\"]').on('click', this._onRollSpecialization.bind(this));\r\n\r\n    // Quick roll specialization (from dice badge)\r\n    html.find('[data-action=\"quick-roll-specialization\"]').on('click', this._onQuickRollSpecialization.bind(this));\r\n\r\n    // Send catchphrase to chat\r\n    html.find('[data-action=\"send-catchphrase\"]').on('click', this._onSendCatchphrase.bind(this));\r\n    \r\n    // Toggle bookmark - use event delegation to work with dynamically rendered items\r\n    html.on('click', '[data-action=\"toggle-bookmark\"]', this._onToggleBookmark.bind(this));\r\n    \r\n    // Click on bookmarked item in header\r\n    html.find('.bookmark-item').on('click', this._onBookmarkItemClick.bind(this));\r\n    \r\n    // Handle damage tracker checkboxes - explicit handler to ensure data is saved\r\n    html.find('input[name^=\"system.damage\"]').on('change', this._onDamageChange.bind(this));\r\n    html.find('input[name^=\"system.anarchySpent\"]').on('change', this._onAnarchyChange.bind(this));\r\n    \r\n    // Handle cyberdeck damage tracker checkboxes\r\n    html.find('input[name*=\".cyberdeckDamage.\"]').on('change', this._onCyberdeckDamageChange.bind(this));\r\n\r\n    // Roll weapon\r\n    html.find('[data-action=\"roll-weapon\"]').on('click', this._onRollWeapon.bind(this));\r\n\r\n    // Roll spell\r\n    html.find('[data-action=\"roll-spell\"]').on('click', this._onRollSpell.bind(this));\r\n\r\n    // Roll weapon/spell (old type)\r\n    html.find('[data-action=\"roll-weapon-spell\"]').on('click', this._onRollWeaponSpell.bind(this));\r\n\r\n    // Roll vehicle weapon (mounted weapon using character skills)\r\n    html.find('[data-action=\"roll-vehicle-weapon\"]').on('click', this._onRollVehicleWeaponFromSheet.bind(this));\r\n    \r\n    // Roll vehicle weapon with autopilot\r\n    html.find('[data-action=\"roll-vehicle-weapon-autopilot\"]').on('click', this._onRollVehicleWeaponAutopilot.bind(this));\r\n    \r\n    // Roll vehicle autopilot\r\n    html.find('[data-action=\"roll-vehicle-autopilot\"]').on('click', this._onRollVehicleAutopilot.bind(this));\r\n\r\n    // Handle rating changes\r\n    html.find('.rating-input').on('change', this._onRatingChange.bind(this));\r\n\r\n    // Skill search\r\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\r\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\r\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\r\n    \r\n    // Close skill search results when clicking outside\r\n    $(document).on('click.skill-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\r\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\r\n        html.find('.skill-search-results').hide();\r\n      }\r\n    });\r\n\r\n    // Feat search\r\n    html.find('.feat-search-input').on('input', this._onFeatSearch.bind(this));\r\n    html.find('.feat-search-input').on('focus', this._onFeatSearchFocus.bind(this));\r\n    html.find('.feat-search-input').on('blur', this._onFeatSearchBlur.bind(this));\r\n    \r\n    // Close feat search results when clicking outside\r\n    $(document).on('click.feat-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const featSearchContainer = html.find('.feat-search-container')[0] as HTMLElement;\r\n      if (featSearchContainer && !featSearchContainer.contains(target)) {\r\n        html.find('.feat-search-results').hide();\r\n      }\r\n    });\r\n\r\n    // Make feat items draggable\r\n    html.find('.feat-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make skill items draggable\r\n    html.find('.skill-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make specialization items draggable\r\n    html.find('.specialization-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n\r\n    // Make vehicle actor items draggable\r\n    html.find('.vehicle-actor-item').each((_index, item) => {\r\n      item.setAttribute('draggable', 'true');\r\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    // Expand form data (handles nested properties like \"system.attribute.strength\")\r\n    const expandedData = foundry.utils.expandObject(formData) as any;\r\n    // Don't process damage here - _onDamageChange handles it directly\r\n    // Remove damage from expandedData if present to avoid conflicts\r\n    if (expandedData.system?.damage !== undefined) {\r\n      delete expandedData.system.damage;\r\n    }\r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    const section = SheetHelpers.handleSectionNavigation(event, this.form as HTMLElement);\r\n    if (section) {\r\n      this._activeSection = section;\r\n    }\r\n  }\r\n\r\n  // Generic item handlers using SheetHelpers\r\n  private async _onEditMetatype(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteMetatype(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor, this.render.bind(this)); }\r\n  private async _onEditFeat(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteFeat(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n  private async _onEditSkill(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteSkill(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n  private async _onEditSpecialization(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\r\n  private async _onDeleteSpecialization(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\r\n\r\n  /**\r\n   * Handle opening a linked vehicle actor sheet\r\n   */\r\n  private async _onOpenVehicle(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) return;\r\n    \r\n    try {\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (vehicleActor && vehicleActor.sheet) {\r\n        vehicleActor.sheet.render(true);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error opening vehicle sheet:', error);\r\n      ui.notifications?.error('Erreur lors de l\\'ouverture de la fiche du véhicule');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle unlinking a vehicle actor from the character\r\n   */\r\n  private async _onUnlinkVehicle(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) return;\r\n    \r\n    const linkedVehicles = (this.actor.system as any).linkedVehicles || [];\r\n    const updatedLinkedVehicles = linkedVehicles.filter((uuid: string) => uuid !== vehicleUuid);\r\n    \r\n    await this.actor.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n    \r\n    // Optionally unlink the vehicle's token prototype (set actorLink to false)\r\n    try {\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (vehicleActor) {\r\n        await vehicleActor.update({ 'prototypeToken.actorLink': false });\r\n      }\r\n    } catch (error) {\r\n      console.warn('Could not update vehicle token prototype:', error);\r\n      // Continue anyway - unlinking from character is more important\r\n    }\r\n    \r\n    ui.notifications?.info(game.i18n!.localize('SRA2.FEATS.VEHICLE_UNLINKED'));\r\n  }\r\n\r\n  /**\r\n   * Get detailed RR sources for a given skill, specialization, or attribute\r\n   */\r\n  private getRRSources(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\r\n    return SheetHelpers.getRRSources(this.actor, itemType, itemName);\r\n  }\r\n\r\n  /**\r\n   * Calculate Risk Reduction (RR) from active feats for a given skill, specialization, or attribute\r\n   */\r\n  private calculateRR(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\r\n    return SheetHelpers.calculateRR(this.actor, itemType, itemName);\r\n  }\r\n\r\n  /**\r\n   * Handle rating changes for items\r\n   */\r\n  private async _onRatingChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLInputElement;\r\n    const itemId = element.dataset.itemId;\r\n    const newRating = parseInt(element.value);\r\n    \r\n    if (!itemId || isNaN(newRating)) return;\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (item) {\r\n      await item.update({ system: { rating: newRating } } as any);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a specialization\r\n   */\r\n  private async _onRollSpecialization(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    const effectiveRating = parseInt(element.dataset.effectiveRating || '0');\r\n    \r\n    if (!itemId) return;\r\n\r\n    const specialization = this.actor.items.get(itemId);\r\n    if (!specialization || specialization.type !== 'specialization') return;\r\n\r\n    const specSystem = specialization.system as any;\r\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\r\n    const linkedSkillName = specSystem.linkedSkill;\r\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\r\n    \r\n    // Get the linked skill to get its rating\r\n    const linkedSkill = linkedSkillName ? this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName) : null;\r\n    const skillRating = linkedSkill ? (linkedSkill.system as any).rating || 0 : 0;\r\n    \r\n    // Get RR sources\r\n    const specRRSources = this.getRRSources('specialization', specialization.name);\r\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\r\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\r\n    const allRRSources = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'specialization',\r\n      itemName: specialization.name,\r\n      itemId: specialization.id,\r\n      specName: specialization.name,\r\n      specLevel: attributeValue + effectiveRating,  // Total dice pool (attribute + effectiveRating)\r\n      skillName: linkedSkillName,\r\n      skillLevel: skillRating,  // Just the skill rating (without attribute)\r\n      linkedAttribute: linkedAttribute,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: allRRSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle quick rolling a skill (from dice badge click) - opens dialog\r\n   */\r\n  private async _onQuickRollSkill(event: Event): Promise<void> {\r\n    // Simply call the regular roll skill function which opens the dialog\r\n    return this._onRollSkill(event);\r\n  }\r\n\r\n  /**\r\n   * Handle quick rolling a specialization (from dice badge click) - opens dialog\r\n   */\r\n  private async _onQuickRollSpecialization(event: Event): Promise<void> {\r\n    // Simply call the regular roll specialization function which opens the dialog\r\n    return this._onRollSpecialization(event);\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle rolling an attribute\r\n   */\r\n  private async _onRollAttribute(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const attributeName = element.dataset.attribute;\r\n    \r\n    if (!attributeName) return;\r\n\r\n    const attributeValue = (this.actor.system as any).attributes?.[attributeName] || 0;\r\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${attributeName.toUpperCase()}`);\r\n\r\n    // Get RR sources for this attribute\r\n    const rrSources = this.getRRSources('attribute', attributeName);\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'attribute',\r\n      itemName: attributeLabel,\r\n      skillName: attributeLabel,\r\n      skillLevel: attributeValue,\r\n      linkedAttribute: attributeName,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: rrSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a skill\r\n   */\r\n  private async _onRollSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) return;\r\n\r\n    const skill = this.actor.items.get(itemId);\r\n    if (!skill || skill.type !== 'skill') return;\r\n\r\n    const skillSystem = skill.system as any;\r\n    const rating = skillSystem.rating || 0;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\r\n\r\n    // Get RR sources for skill and attribute\r\n    const skillRRSources = this.getRRSources('skill', skill.name);\r\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\r\n    const allRRSources = [...skillRRSources, ...attributeRRSources];\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: 'skill',\r\n      itemName: skill.name,\r\n      itemId: skill.id,\r\n      itemRating: rating,\r\n      skillName: skill.name,\r\n      skillLevel: attributeValue + rating,  // Total dice pool (attribute + rating)\r\n      linkedAttribute: linkedAttribute,\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name,\r\n      rrList: allRRSources\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Apply damage to a defender\r\n   * Delegates to CombatHelpers.applyDamage\r\n   */\r\n  static async applyDamage(defenderUuid: string, damageValue: number, defenderName: string, damageType: 'physical' | 'mental' = 'physical'): Promise<void> {\r\n    return CombatHelpers.applyDamage(defenderUuid, damageValue, defenderName, damageType);\r\n  }\r\n\r\n  /**\r\n   * Handle drag start for feat items and vehicle actors\r\n   * For vehicle actors, allow dragging them to the map\r\n   */\r\n  protected override _onDragStart(event: DragEvent): void {\r\n    const itemId = (event.currentTarget as HTMLElement).dataset.itemId;\r\n    const vehicleUuid = (event.currentTarget as HTMLElement).dataset.vehicleUuid;\r\n    \r\n    // Check if this is a linked vehicle actor\r\n    if (vehicleUuid) {\r\n      const dragData = {\r\n        type: 'Actor',\r\n        uuid: vehicleUuid,\r\n      };\r\n      event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n      return;\r\n    }\r\n    \r\n    if (!itemId) return;\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n\r\n    // Check if this is a vehicle feat that references a vehicle actor\r\n    if (item.type === 'feat' && (item.system as any).featType === 'vehicle') {\r\n      const vehicleActorUuid = (item.system as any).vehicleActorUuid;\r\n      if (vehicleActorUuid) {\r\n        // Allow dragging the vehicle actor to the map\r\n        const dragData = {\r\n          type: 'Actor',\r\n          uuid: vehicleActorUuid,\r\n        };\r\n        event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n        return;\r\n      }\r\n    }\r\n\r\n    // Default: drag the item itself\r\n    const dragData = {\r\n      type: 'Item',\r\n      uuid: item.uuid,\r\n    };\r\n\r\n    event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\r\n  }\r\n\r\n  /**\r\n   * Override to handle dropping feats, skills, and vehicle actors anywhere on the sheet\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    // First try to handle item drops (feats, skills, etc.)\r\n    const handled = await SheetHelpers.handleItemDrop(event, this.actor);\r\n    if (handled) return undefined;\r\n    \r\n    // Then try to handle vehicle actor drops\r\n    const vehicleHandled = await SheetHelpers.handleVehicleActorDrop(event, this.actor);\r\n    if (vehicleHandled) return undefined;\r\n    \r\n    return super._onDrop(event);\r\n  }\r\n\r\n  /**\r\n   * Handle skill search input\r\n   */\r\n  private searchTimeout: any = null;\r\n  \r\n  private async _onSkillSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.searchTimeout) {\r\n      clearTimeout(this.searchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.searchTimeout = setTimeout(async () => {\r\n      await this._performSkillSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual skill search in compendiums and world items\r\n   */\r\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    // Store search term for potential creation\r\n    this.lastSearchTerm = searchTerm;\r\n    \r\n    // Use the helper function to search everywhere\r\n    const existingItemsCheck = (itemName: string) => \r\n      ItemSearch.itemExistsOnActor(this.actor, 'skill', itemName);\r\n    \r\n    const results = await ItemSearch.searchItemsEverywhere(\r\n      'skill',\r\n      searchTerm,\r\n      undefined,\r\n      existingItemsCheck\r\n    );\r\n    \r\n    // Display results\r\n    this._displaySkillSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display skill search results\r\n   */\r\n  private lastSearchTerm: string = '';\r\n  \r\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): void {\r\n    // Check if exact match exists on the actor\r\n    const formattedSearchTerm = this.lastSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatchOnActor = this.actor.items.find((i: any) => \r\n      i.type === 'skill' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SKILLS.CREATE_SKILL')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const disabledClass = result.alreadyExists ? 'disabled' : '';\r\n        const buttonText = result.alreadyExists ? '✓' : game.i18n!.localize('SRA2.SKILLS.ADD_SKILL');\r\n        \r\n        html += `\r\n          <div class=\"search-result-item ${disabledClass}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source}</span>\r\n            </div>\r\n            <button class=\"add-skill-btn\" data-uuid=\"${result.uuid}\" ${result.alreadyExists ? 'disabled' : ''}>\r\n              ${buttonText}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist on actor\r\n      if (!exactMatchOnActor) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SKILLS.CREATE_NEW')}</span>\r\n            </div>\r\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.SKILLS.CREATE')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers to buttons\r\n    $(resultsDiv).find('.add-skill-btn').on('click', this._onAddSkillFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\r\n    \r\n    // Make entire result items clickable (except disabled ones and create button)\r\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-skill-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-skill-btn')[0] as HTMLButtonElement;\r\n      if (button && !button.disabled) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle adding a skill from search results\r\n   */\r\n  private async _onAddSkillFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const uuid = button.dataset.uuid;\r\n    \r\n    if (!uuid) return;\r\n    \r\n    // Get the skill from the compendium\r\n    const skill = await fromUuid(uuid as any) as any;\r\n    \r\n    if (!skill) {\r\n      ui.notifications?.error('Skill not found');\r\n      return;\r\n    }\r\n    \r\n    // Check if skill already exists\r\n    const existingSkill = this.actor.items.find((i: any) => \r\n      i.type === 'skill' && i.name === skill.name\r\n    );\r\n    \r\n    if (existingSkill) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: skill.name }));\r\n      return;\r\n    }\r\n    \r\n    // Add the skill to the actor\r\n    await this.actor.createEmbeddedDocuments('Item', [skill.toObject()]);\r\n    \r\n    // Mark button as added\r\n    button.textContent = '✓';\r\n    button.disabled = true;\r\n    button.closest('.search-result-item')?.classList.add('disabled');\r\n    \r\n    ui.notifications?.info(`${skill.name} ${game.i18n!.localize('SRA2.SKILLS.ADD_SKILL')}`);\r\n  }\r\n\r\n  /**\r\n   * Handle skill search focus\r\n   */\r\n  private _onSkillSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle skill search blur\r\n   */\r\n  private _onSkillSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle creating a new skill from search\r\n   */\r\n  private async _onCreateNewSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = skillName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new skill with default values\r\n    const skillData = {\r\n      name: formattedName,\r\n      type: 'skill',\r\n      system: {\r\n        rating: 1,\r\n        linkedAttribute: 'strength',\r\n        description: ''\r\n      }\r\n    } as any;\r\n    \r\n    // Add the skill to the actor\r\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [skillData]) as any;\r\n    \r\n    if (createdItems && createdItems.length > 0) {\r\n      const newSkill = createdItems[0] as any;\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      // Open the skill sheet for editing\r\n      if (newSkill && newSkill.sheet) {\r\n        setTimeout(() => {\r\n          newSkill.sheet.render(true);\r\n        }, 100);\r\n      }\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.SKILL_CREATED', { name: formattedName }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * FEAT SEARCH FUNCTIONS\r\n   */\r\n  \r\n  private featSearchTimeout: any = null;\r\n  private lastFeatSearchTerm: string = '';\r\n  \r\n  /**\r\n   * Handle feat search input\r\n   */\r\n  private async _onFeatSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.featSearchTimeout) {\r\n      clearTimeout(this.featSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.featSearchTimeout = setTimeout(async () => {\r\n      await this._performFeatSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual feat search in compendiums and world items\r\n   */\r\n  private async _performFeatSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    // Store search term for potential creation\r\n    this.lastFeatSearchTerm = searchTerm;\r\n    \r\n    // Use searchItemsEverywhere to search across actor, world, and compendiums\r\n    const searchResults = await ItemSearch.searchItemsEverywhere(\r\n      'feat',\r\n      searchTerm,\r\n      this.actor,\r\n      (itemName: string) => {\r\n        // Check if feat already exists on actor\r\n        return this.actor.items.some((i: any) => \r\n          i.type === 'feat' && i.name === itemName\r\n        );\r\n      }\r\n    );\r\n    \r\n    // Convert SearchResult[] to the format expected by _displayFeatSearchResults\r\n    const results: any[] = [];\r\n    for (const result of searchResults) {\r\n      // Get the item to access featType\r\n      let featType = '';\r\n      try {\r\n        const item = await fromUuid(result.uuid as any);\r\n        if (item && (item as any).system) {\r\n          featType = (item as any).system.featType || '';\r\n        }\r\n      } catch (error) {\r\n        console.warn('Could not load item for featType:', error);\r\n      }\r\n      \r\n      results.push({\r\n        name: result.name,\r\n        uuid: result.uuid,\r\n        pack: result.source,\r\n        featType: featType,\r\n        exists: result.alreadyExists || false\r\n      });\r\n    }\r\n    \r\n    // Display results\r\n    this._displayFeatSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display feat search results\r\n   */\r\n  private _displayFeatSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\r\n    // Check if exact match exists on the actor\r\n    const formattedSearchTerm = this.lastFeatSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatchOnActor = this.actor.items.find((i: any) => \r\n      i.type === 'feat' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastFeatSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message and type selector\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.FEATS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <select class=\"feat-type-selector\">\r\n            <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\r\n            <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\r\n            <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\r\n            <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\r\n            <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\r\n            <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\r\n            <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\r\n            <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\r\n            <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\r\n            <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\r\n            <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\r\n            <option value=\"connaissance\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONNAISSANCE')}</option>\r\n          </select>\r\n          <button class=\"create-feat-btn\" data-feat-name=\"${this.lastFeatSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.FEATS.CREATE')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const disabledClass = result.exists ? 'disabled' : '';\r\n        const buttonText = result.exists ? '✓' : game.i18n!.localize('SRA2.FEATS.ADD_FEAT');\r\n        const featTypeLabel = game.i18n!.localize(`SRA2.FEATS.FEAT_TYPE.${result.featType.toUpperCase().replace('-', '_')}`);\r\n        \r\n        html += `\r\n          <div class=\"search-result-item ${disabledClass}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.pack} - ${featTypeLabel}</span>\r\n            </div>\r\n            <button class=\"add-feat-btn\" data-uuid=\"${result.uuid}\" ${result.exists ? 'disabled' : ''}>\r\n              ${buttonText}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist on actor\r\n      if (!exactMatchOnActor) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.FEATS.CREATE_NEW')}</span>\r\n            </div>\r\n            <select class=\"feat-type-selector-inline\">\r\n              <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\r\n              <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\r\n              <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\r\n              <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\r\n              <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\r\n              <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\r\n              <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\r\n              <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\r\n              <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\r\n              <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\r\n              <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\r\n            </select>\r\n            <button class=\"create-feat-btn-inline\" data-feat-name=\"${this.lastFeatSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.CREATE')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers\r\n    $(resultsDiv).find('.add-feat-btn').on('click', this._onAddFeatFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-feat-btn, .create-feat-btn-inline').on('click', this._onCreateNewFeat.bind(this));\r\n    \r\n    // Make entire result items clickable (except disabled ones and create button)\r\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-feat-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-feat-btn')[0] as HTMLButtonElement;\r\n      if (button && !button.disabled) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button or select\r\n      if ($(event.target).closest('.create-feat-btn-inline, .feat-type-selector-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-feat-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle adding a feat from search results\r\n   */\r\n  private async _onAddFeatFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const uuid = button.dataset.uuid;\r\n    \r\n    if (!uuid) return;\r\n    \r\n    // Get the feat from the compendium\r\n    const feat = await fromUuid(uuid as any) as any;\r\n    \r\n    if (!feat) {\r\n      ui.notifications?.error('Feat not found');\r\n      return;\r\n    }\r\n    \r\n    // Check if feat already exists\r\n    const existingFeat = this.actor.items.find((i: any) => \r\n      i.type === 'feat' && i.name === feat.name\r\n    );\r\n    \r\n    if (existingFeat) {\r\n      ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: feat.name }));\r\n      return;\r\n    }\r\n    \r\n    // Add the feat to the actor\r\n    await this.actor.createEmbeddedDocuments('Item', [feat.toObject()]);\r\n    \r\n    // Mark button as added\r\n    button.textContent = '✓';\r\n    button.disabled = true;\r\n    button.closest('.search-result-item')?.classList.add('disabled');\r\n    \r\n    ui.notifications?.info(`${feat.name} ${game.i18n!.localize('SRA2.FEATS.ADD_FEAT')}`);\r\n  }\r\n\r\n  /**\r\n   * Handle feat search focus\r\n   */\r\n  private _onFeatSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle feat search blur\r\n   */\r\n  private _onFeatSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any select element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if a select or other element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle sending a catchphrase to chat\r\n   */\r\n  private async _onSendCatchphrase(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const catchphrase = element.dataset.catchphrase;\r\n    \r\n    if (!catchphrase) return;\r\n\r\n    // Create the chat message\r\n    const messageData = {\r\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\r\n      content: `<div class=\"sra2-catchphrase\">${catchphrase}</div>`\r\n    };\r\n    \r\n    await ChatMessage.create(messageData as any);\r\n  }\r\n  \r\n  /**\r\n   * Handle damage tracker checkbox changes\r\n   */\r\n  private async _onDamageChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Get current damage from actor data (read from _source for persisted values)\r\n    const actorSource = (this.actor as any)._source;\r\n    const currentDamage = actorSource?.system?.damage || (this.actor.system as any).damage || {\r\n      light: [false, false],\r\n      severe: [false],\r\n      incapacitating: false\r\n    };\r\n    \r\n    // Use helper to parse and update damage\r\n    const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n    if (!updatedDamage) return;\r\n    \r\n    // Update the actor with the complete damage object\r\n    await this.actor.update({\r\n      'system.damage': updatedDamage\r\n    } as any, { render: false });\r\n    \r\n    // Force re-render to update CSS classes in template\r\n    this.render(false);\r\n  }\r\n  \r\n  /**\r\n   * Handle cyberdeck damage tracker checkbox changes\r\n   */\r\n  private async _onCyberdeckDamageChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Extract item ID from name (format: items.{itemId}.system.cyberdeckDamage.xxx)\r\n    const itemIdMatch = name.match(/^items\\.([^.]+)\\./);\r\n    if (!itemIdMatch || !itemIdMatch[1]) return;\r\n    \r\n    const itemId = itemIdMatch[1];\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    // Get current cyberdeckDamage from item data (read from _source for persisted values)\r\n    const itemSource = (item as any)._source;\r\n    const currentDamage = itemSource?.system?.cyberdeckDamage || (item.system as any).cyberdeckDamage || {\r\n      light: [false, false],\r\n      severe: [false],\r\n      incapacitating: false\r\n    };\r\n    \r\n    // Use helper to parse and update damage\r\n    const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n    if (!updatedDamage) return;\r\n    \r\n    // Update the item with the complete cyberdeckDamage object\r\n    await item.update({\r\n      'system.cyberdeckDamage': updatedDamage\r\n    } as any, { render: false });\r\n    \r\n    // Force re-render to update CSS classes in template\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle anarchy tracker checkbox changes\r\n   */\r\n  private async _onAnarchyChange(event: Event): Promise<void> {\r\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\r\n    \r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const checked = input.checked;\r\n    \r\n    // Parse the name to extract the index\r\n    // Expected format: system.anarchySpent.0, system.anarchySpent.1, etc.\r\n    const match = name.match(/^system\\.anarchySpent\\.(\\d+)$/);\r\n    if (!match || !match[1]) return;\r\n    \r\n    const index = parseInt(match[1], 10);\r\n    \r\n    // Ensure anarchySpent array exists\r\n    const currentAnarchySpent = (this.actor.system as any).anarchySpent || [false, false, false];\r\n    const anarchySpent = [...currentAnarchySpent];\r\n    \r\n    // Ensure array has minimum length\r\n    while (anarchySpent.length < 3) {\r\n      anarchySpent.push(false);\r\n    }\r\n    \r\n    // Update the appropriate index\r\n    if (index >= 0 && index < anarchySpent.length) {\r\n      anarchySpent[index] = checked;\r\n      \r\n      // Update the actor\r\n      await (this.actor as any).update({ 'system.anarchySpent': anarchySpent }, { render: false });\r\n      \r\n      // Force re-render to update CSS classes in template (e.g., {{#if this}}checked{{/if}})\r\n      this.render(false);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Handle toggling bookmark on an item\r\n   */\r\n  private async _onToggleBookmark(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    event.stopImmediatePropagation();\r\n    \r\n    // With event delegation, find the closest element with data-action=\"toggle-bookmark\"\r\n    const target = event.target as HTMLElement;\r\n    let element = target.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\r\n    \r\n    // If target is the icon itself, get the parent link\r\n    if (!element && target.tagName === 'I' && target.parentElement) {\r\n      element = target.parentElement as HTMLElement;\r\n      if (!element.hasAttribute('data-action')) {\r\n        element = element.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\r\n      }\r\n    }\r\n    \r\n    if (!element) return;\r\n    \r\n    const itemId = element.dataset.itemId;\r\n    if (!itemId) return;\r\n    \r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    const currentBookmarkState = (item.system as any).bookmarked || false;\r\n    \r\n    try {\r\n      await (item as any).update({ 'system.bookmarked': !currentBookmarkState });\r\n      // Re-render to update UI\r\n      this.render(false);\r\n    } catch (error) {\r\n      console.error('Error toggling bookmark:', error);\r\n      ui.notifications?.error(game.i18n?.localize('SRA2.BOOKMARKS.ERROR') || 'Erreur lors de la mise à jour du bookmark');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Handle clicking on a bookmarked item in the header\r\n   */\r\n  private async _onBookmarkItemClick(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    const itemType = element.dataset.itemType;\r\n    \r\n    if (!itemId) return;\r\n    \r\n    const item = this.actor.items.get(itemId);\r\n    if (!item) return;\r\n    \r\n    // Roll the item based on its type\r\n    if (itemType === 'skill') {\r\n      // Call _onRollSkill with a fake event containing the item ID\r\n      const fakeEvent = { \r\n        preventDefault: () => {}, \r\n        currentTarget: { dataset: { itemId: itemId } } \r\n      } as any;\r\n      await this._onRollSkill(fakeEvent);\r\n    } else if (itemType === 'specialization') {\r\n      // Find the effective rating for this specialization\r\n      const specSystem = item.system as any;\r\n      const linkedSkillName = specSystem.linkedSkill;\r\n      const parentSkill = this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName);\r\n      const effectiveRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n      \r\n      const fakeEvent = { \r\n        preventDefault: () => {}, \r\n        currentTarget: { \r\n          dataset: { \r\n            itemId: itemId,\r\n            effectiveRating: effectiveRating.toString()\r\n          } \r\n        } \r\n      } as any;\r\n      await this._onRollSpecialization(fakeEvent);\r\n    } else if (itemType === 'feat') {\r\n      const featType = (item.system as any).featType;\r\n      if (featType === 'weapon') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollWeapon(fakeEvent);\r\n      } else if (featType === 'spell') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollSpell(fakeEvent);\r\n      } else if (featType === 'weapons-spells') {\r\n        const fakeEvent = { \r\n          preventDefault: () => {}, \r\n          currentTarget: { dataset: { itemId: itemId } } \r\n        } as any;\r\n        await this._onRollWeaponSpell(fakeEvent);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon from the character sheet\r\n   */\r\n  private async _onRollVehicleWeaponFromSheet(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    const weaponId = element.dataset.weaponId;\r\n    \r\n    if (!vehicleUuid || !weaponId) {\r\n      console.error(\"SRA2 | Missing vehicle UUID or weapon ID\");\r\n      return;\r\n    }\r\n    \r\n    await this._onRollVehicleWeapon(vehicleUuid, weaponId);\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon using autopilot\r\n   */\r\n  private async _onRollVehicleWeaponAutopilot(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    const weaponId = element.dataset.weaponId;\r\n    \r\n    if (!vehicleUuid || !weaponId) {\r\n      console.error(\"SRA2 | Missing vehicle UUID or weapon ID\");\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      // Get weapon from vehicle\r\n      const weapon = vehicleActor.items.get(weaponId);\r\n      if (!weapon || (weapon.system as any).featType !== 'weapon') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_WEAPON'));\r\n        return;\r\n      }\r\n      \r\n      const autopilot = (vehicleActor.system as any)?.attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      // Prepare complete weapon roll request data using combat-helpers\r\n      const rollRequestData = CombatHelpers.prepareVehicleWeaponRollRequest(\r\n        vehicleActor,\r\n        weapon,\r\n        WEAPON_TYPES\r\n      );\r\n      \r\n      // Call dice roller with prepared data\r\n      DiceRoller.handleRollRequest(rollRequestData);\r\n    } catch (error) {\r\n      console.error(\"SRA2 | Error rolling vehicle weapon with autopilot:\", error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling vehicle autopilot\r\n   */\r\n  private async _onRollVehicleAutopilot(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const vehicleUuid = element.dataset.vehicleUuid;\r\n    \r\n    if (!vehicleUuid) {\r\n      console.error(\"SRA2 | Missing vehicle UUID\");\r\n      return;\r\n    }\r\n    \r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      const autopilot = (vehicleActor.system as any)?.attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      const vehicleName = vehicleActor.name || 'Véhicule';\r\n      const autopilotLabel = game.i18n!.localize('SRA2.FEATS.VEHICLE.AUTOPILOT_SHORT');\r\n      \r\n      // Get RR sources for autopilot (from vehicle's RR sources if any)\r\n      const rrSources: Array<{featName: string, rrValue: number, rrType?: string, rrTarget?: string}> = [];\r\n      \r\n      DiceRoller.handleRollRequest({\r\n        itemType: 'attribute',\r\n        itemName: `${autopilotLabel} (${vehicleName})`,\r\n        skillName: autopilotLabel,\r\n        skillLevel: autopilot,\r\n        linkedAttribute: 'autopilot',\r\n        actorId: vehicleActor.id,\r\n        actorUuid: vehicleActor.uuid,\r\n        actorName: vehicleName,\r\n        rrList: rrSources\r\n      });\r\n    } catch (error) {\r\n      console.error(\"SRA2 | Error rolling vehicle autopilot:\", error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a vehicle weapon (mounted weapon) using character stats\r\n   */\r\n  private async _onRollVehicleWeapon(vehicleUuid: string, weaponId: string): Promise<void> {\r\n    try {\r\n      // Get vehicle actor\r\n      const vehicleActor = await fromUuid(vehicleUuid) as any;\r\n      if (!vehicleActor || vehicleActor.type !== 'vehicle') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_VEHICLE'));\r\n        return;\r\n      }\r\n      \r\n      // Get weapon from vehicle\r\n      const weapon = vehicleActor.items.get(weaponId);\r\n      if (!weapon || (weapon.system as any).featType !== 'weapon') {\r\n        ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.INVALID_WEAPON'));\r\n        return;\r\n      }\r\n      \r\n      // Use _rollWeaponOrSpell logic but with character stats and CRR\r\n      const itemSystem = weapon.system as any;\r\n      const weaponType = itemSystem.weaponType;\r\n      \r\n      // Get CRR (Contrôle Récupération Réduction) for mounted weapons\r\n      const crr = itemSystem.crr || 0;\r\n      \r\n      // Get item RR list\r\n      const rawItemRRList = itemSystem.rrList || [];\r\n      const itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n        ...rrEntry,\r\n        featName: weapon.name\r\n      }));\r\n      \r\n      // For vehicle/drone weapons controlled by owner, use Ingénierie (Spé : Armes contrôlées à distance)\r\n      const finalAttackSkill = 'Ingénierie';\r\n      const finalAttackSpec = 'Spé : Armes contrôlées à distance';\r\n      \r\n      // Defense is always Athlétisme (Spé : Défense à distance) for drone weapons\r\n      const finalDefenseSkill = 'Athlétisme';\r\n      const finalDefenseSpec = 'Spé : Défense à distance';\r\n      \r\n      // Find character's attack skill and specialization using unified helper\r\n      const attackSkillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalAttackSpec,\r\n        finalAttackSkill,\r\n        { defaultAttribute: 'logic' }\r\n      );\r\n      \r\n      const attackSkillName = attackSkillSpecResult.skillName;\r\n      const attackSkillLevel = attackSkillSpecResult.skillLevel;\r\n      const attackSpecName = attackSkillSpecResult.specName;\r\n      const attackSpecLevel = attackSkillSpecResult.specLevel;\r\n      const attackLinkedAttribute = attackSkillSpecResult.linkedAttribute;\r\n      \r\n      // Find character's defense skill and specialization using unified helper\r\n      const defenseSkillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n        this.actor,\r\n        finalDefenseSpec,\r\n        finalDefenseSkill,\r\n        { defaultAttribute: 'agility' }\r\n      );\r\n      \r\n      const defenseSkillName = defenseSkillSpecResult.skillName;\r\n      const defenseSkillLevel = defenseSkillSpecResult.skillLevel;\r\n      const defenseSpecName = defenseSkillSpecResult.specName;\r\n      const defenseSpecLevel = defenseSkillSpecResult.specLevel;\r\n      const defenseLinkedAttribute = defenseSkillSpecResult.linkedAttribute;\r\n      \r\n      // Calculate final damage value using helper\r\n      const baseDamageValue = itemSystem.damageValue || '0';\r\n      let damageValueBonus = itemSystem.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      const activeFeats = this.actor.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.active === true &&\r\n        item.system.weaponDamageBonus > 0 &&\r\n        item.system.weaponTypeBonus === weaponType\r\n      );\r\n      \r\n      activeFeats.forEach((activeFeat: any) => {\r\n        damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n      });\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      const finalDamageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n      \r\n      // Calculate attack pool with all RR sources using unified helper\r\n      const poolResult = SheetHelpers.calculateAttackPool(\r\n        this.actor,\r\n        attackSkillSpecResult,\r\n        itemRRList,\r\n        weapon.name\r\n      );\r\n      const allRRSources = poolResult.allRRSources;\r\n      \r\n      // Add CRR as a special RR entry if > 0\r\n      if (crr > 0) {\r\n        allRRSources.push({\r\n          rrType: 'attribute',\r\n          rrValue: crr,\r\n          rrTarget: 'CRR',\r\n          featName: weapon.name\r\n        });\r\n      }\r\n      \r\n      DiceRoller.handleRollRequest({\r\n        itemType: 'weapon',\r\n        weaponType: weaponType,\r\n        itemName: `${weapon.name} (${vehicleActor.name})`,\r\n        itemId: weapon.id,\r\n        itemRating: itemSystem.rating || 0,\r\n        itemActive: itemSystem.active,\r\n        \r\n        // Merged linked skills (for fallback selection in dialog)\r\n        linkedAttackSkill: finalAttackSkill, // 'Ingénierie'\r\n        linkedAttackSpecialization: finalAttackSpec, // 'Spé : Armes contrôlées à distance'\r\n        linkedDefenseSkill: finalDefenseSkill, // 'Athlétisme'\r\n        linkedDefenseSpecialization: finalDefenseSpec, // 'Spé : Défense à distance'\r\n        linkedAttribute: attackLinkedAttribute,\r\n        \r\n        // Weapon properties\r\n        isWeaponFocus: itemSystem.isWeaponFocus || false,\r\n        damageValue: finalDamageValue,\r\n        meleeRange: itemSystem.meleeRange,\r\n        shortRange: itemSystem.shortRange,\r\n        mediumRange: itemSystem.mediumRange,\r\n        longRange: itemSystem.longRange,\r\n        \r\n        // Attack skill/spec from character (based on weapon links) - these are used for selection\r\n        skillName: attackSkillName,\r\n        skillLevel: attackSkillLevel,\r\n        specName: attackSpecName,\r\n        specLevel: attackSpecLevel,\r\n        \r\n        // Defense skill/spec from character (based on weapon links) - these are used for defense selection\r\n        defenseSkillName: defenseSkillName,\r\n        defenseSkillLevel: defenseSkillLevel,\r\n        defenseSpecName: defenseSpecName,\r\n        defenseSpecLevel: defenseSpecLevel,\r\n        defenseLinkedAttribute: defenseLinkedAttribute,\r\n        \r\n        // Actor information (character, not vehicle)\r\n        actorId: this.actor.id,\r\n        actorUuid: this.actor.uuid,\r\n        actorName: this.actor.name || '',\r\n        \r\n        // RR List (merged: item RR + skill/spec/attribute RR + CRR)\r\n        rrList: allRRSources,\r\n        \r\n        // Mark as vehicle weapon\r\n        isVehicleWeapon: true,\r\n        vehicleUuid: vehicleUuid,\r\n        vehicleName: vehicleActor.name\r\n      });\r\n    } catch (error) {\r\n      console.error('Error rolling vehicle weapon:', error);\r\n      ui.notifications?.error(game.i18n!.localize('SRA2.VEHICLE.ROLL_ERROR'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a weapon\r\n   */\r\n  private async _onRollWeapon(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No weapon ID found\");\r\n      return;\r\n    }\r\n\r\n    const weapon = this.actor.items.get(itemId);\r\n    if (!weapon || weapon.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(weapon, 'weapon');\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a spell\r\n   */\r\n  private async _onRollSpell(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No spell ID found\");\r\n      return;\r\n    }\r\n\r\n    const spell = this.actor.items.get(itemId);\r\n    if (!spell || spell.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(spell, 'spell');\r\n  }\r\n\r\n  /**\r\n   * Handle rolling a weapon/spell (old type)\r\n   */\r\n  private async _onRollWeaponSpell(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    const element = event.currentTarget as HTMLElement;\r\n    const itemId = element.dataset.itemId;\r\n    \r\n    if (!itemId) {\r\n      console.error(\"SRA2 | No weapon/spell ID found\");\r\n      return;\r\n    }\r\n\r\n    const item = this.actor.items.get(itemId);\r\n    if (!item || item.type !== 'feat') return;\r\n\r\n    await this._rollWeaponOrSpell(item, 'weapon-spell');\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle rolling a weapon or spell\r\n   */\r\n  private async _rollWeaponOrSpell(item: any, type: 'weapon' | 'spell' | 'weapon-spell'): Promise<void> {\r\n    const itemSystem = item.system as any;\r\n    \r\n    // Check if this is a spell and get spell type\r\n    const isSpell = type === 'spell';\r\n    const spellType = isSpell ? (itemSystem.spellType || 'indirect') : null;\r\n    \r\n    // Get weapon type and linked skills\r\n    const weaponType = itemSystem.weaponType;\r\n    let weaponLinkedSkill = '';\r\n    let weaponLinkedSpecialization = '';\r\n    let weaponLinkedDefenseSkill = '';\r\n    let weaponLinkedDefenseSpecialization = '';\r\n    \r\n    if (weaponType && weaponType !== 'custom-weapon') {\r\n      // Pre-defined weapon: get from WEAPON_TYPES\r\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n      if (weaponStats) {\r\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\r\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\r\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\r\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\r\n      }\r\n    }\r\n\r\n    // Get all RR sources for the item and enrich with featName\r\n    const rawItemRRList = itemSystem.rrList || [];\r\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n      ...rrEntry,\r\n      featName: item.name  // Add featName (the item name itself)\r\n    }));\r\n\r\n    // For spells, force specific skills\r\n    let finalAttackSkill = weaponLinkedSkill || itemSystem.linkedAttackSkill || '';\r\n    let finalAttackSpec = weaponLinkedSpecialization || itemSystem.linkedAttackSpecialization || '';\r\n    let finalDefenseSkill = weaponLinkedDefenseSkill || itemSystem.linkedDefenseSkill || '';\r\n    let finalDefenseSpec = weaponLinkedDefenseSpecialization || itemSystem.linkedDefenseSpecialization || '';\r\n    \r\n    if (isSpell) {\r\n      // Force attack skill to Sorcellerie\r\n      finalAttackSkill = 'Sorcellerie';\r\n      \r\n      // Get spell specialization type and map it to the specialization name\r\n      const spellSpecType = itemSystem.spellSpecializationType || 'combat';\r\n      const spellSpecMap: Record<string, string> = {\r\n        'combat': 'Spé: Sorts de combat',\r\n        'detection': 'Spé: Sorts de détection',\r\n        'health': 'Spé: Sorts de santé',\r\n        'illusion': 'Spé: Sorts d\\'illusion',\r\n        'manipulation': 'Spé: Sorts de manipulation',\r\n        'counterspell': 'Spé: Contresort'\r\n      };\r\n      finalAttackSpec = spellSpecMap[spellSpecType] || 'Spé: Sorts de combat';\r\n      \r\n      if (spellType === 'direct') {\r\n        // Direct spell: no defense\r\n        finalDefenseSkill = '';\r\n        finalDefenseSpec = '';\r\n      } else {\r\n        // Indirect spell: force defense to Athlétisme / Spé : Défense à distance\r\n        finalDefenseSkill = 'Athlétisme';\r\n        finalDefenseSpec = 'Spé : Défense à distance';\r\n      }\r\n    }\r\n\r\n    // Find actor's skill and specialization using unified helper\r\n    const spellSpecType = isSpell ? (itemSystem.spellSpecializationType || 'combat') : undefined;\r\n    \r\n    // Determine default attribute: if skill not found, use agility (except for \"Combat rapproché\" which uses strength)\r\n    let defaultAttribute: string;\r\n    if (isSpell) {\r\n      defaultAttribute = 'willpower';\r\n    } else {\r\n      // Check if the skill exists in the actor's items\r\n      const skillExists = this.actor.items.some((i: any) => \r\n        i.type === 'skill' && \r\n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\r\n      );\r\n      \r\n      if (!skillExists && finalAttackSkill) {\r\n        // Skill not found: use agility, except for \"Combat rapproché\" which uses strength\r\n        const normalizedSkillName = ItemSearch.normalizeSearchText(finalAttackSkill);\r\n        if (normalizedSkillName === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          defaultAttribute = 'strength';\r\n        } else {\r\n          defaultAttribute = 'agility';\r\n        }\r\n      } else {\r\n        // Skill exists or no skill name: use strength (will be overridden by skill's linkedAttribute if skill found)\r\n        defaultAttribute = 'strength';\r\n      }\r\n    }\r\n    \r\n    const skillSpecResult = SheetHelpers.findAttackSkillAndSpec(\r\n      this.actor,\r\n      finalAttackSpec,\r\n      finalAttackSkill,\r\n      { \r\n        isSpell, \r\n        spellSpecType,\r\n        defaultAttribute\r\n      }\r\n    );\r\n    \r\n    const attackSkillName = skillSpecResult.skillName;\r\n    const attackSkillLevel = skillSpecResult.skillLevel;\r\n    const attackSpecName = skillSpecResult.specName;\r\n    const attackSpecLevel = skillSpecResult.specLevel;\r\n    const attackLinkedAttribute = skillSpecResult.linkedAttribute;\r\n\r\n    // Calculate final damage value (base + bonus)\r\n    // For spells, damage value is calculated differently\r\n    let finalDamageValue: string;\r\n    \r\n    if (isSpell) {\r\n      if (spellType === 'direct') {\r\n        finalDamageValue = '0';\r\n      } else {\r\n        const willpower = (this.actor.system as any).attributes?.willpower || 1;\r\n        finalDamageValue = willpower.toString();\r\n      }\r\n    } else {\r\n      const baseDamageValue = itemSystem.damageValue || '0';\r\n      let damageValueBonus = itemSystem.damageValueBonus || 0;\r\n      \r\n      // Add bonus from active feats that match the weapon's type\r\n      const weaponType = itemSystem.weaponType || '';\r\n      const activeFeats = this.actor.items.filter((item: any) => \r\n        item.type === 'feat' && \r\n        item.system.active === true &&\r\n        item.system.weaponDamageBonus > 0 &&\r\n        item.system.weaponTypeBonus === weaponType\r\n      );\r\n      \r\n      activeFeats.forEach((activeFeat: any) => {\r\n        damageValueBonus += activeFeat.system.weaponDamageBonus || 0;\r\n      });\r\n      \r\n      // Limit total bonus to 2 maximum\r\n      damageValueBonus = Math.min(damageValueBonus, 2);\r\n      \r\n      finalDamageValue = SheetHelpers.calculateRawDamageString(baseDamageValue, damageValueBonus);\r\n    }\r\n\r\n    // Calculate attack pool with all RR sources using unified helper\r\n    const poolResult = SheetHelpers.calculateAttackPool(\r\n      this.actor,\r\n      skillSpecResult,\r\n      itemRRList,\r\n      item.name\r\n    );\r\n    const allRRSources = poolResult.allRRSources;\r\n\r\n    // Debug: Log the values being passed to roll dialog\r\n    console.log('SRA2 | _rollWeaponOrSpell - Values passed to roll dialog:', {\r\n      itemName: item.name,\r\n      itemRating: itemSystem.rating || 0,\r\n      skillName: attackSkillName,\r\n      skillLevel: attackSkillLevel,\r\n      specName: attackSpecName,\r\n      specLevel: attackSpecLevel,\r\n      linkedAttackSkill: finalAttackSkill,\r\n      linkedAttackSpecialization: finalAttackSpec\r\n    });\r\n\r\n    DiceRoller.handleRollRequest({\r\n      itemType: type,\r\n      weaponType: weaponType,\r\n      itemName: item.name,\r\n      itemId: item.id,\r\n      itemRating: itemSystem.rating || 0,\r\n      itemActive: itemSystem.active,\r\n      \r\n      // Merged linked skills\r\n      linkedAttackSkill: finalAttackSkill,\r\n      linkedAttackSpecialization: finalAttackSpec,\r\n      linkedDefenseSkill: finalDefenseSkill,\r\n      linkedDefenseSpecialization: finalDefenseSpec,\r\n      linkedAttribute: attackLinkedAttribute,\r\n      \r\n      // Weapon properties\r\n      isWeaponFocus: itemSystem.isWeaponFocus || false,\r\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus, or VOL for indirect spells, or 0 for direct spells)\r\n      // For spells, all ranges are \"ok\"\r\n      meleeRange: isSpell ? 'ok' : (itemSystem.meleeRange || 'none'),\r\n      shortRange: isSpell ? 'ok' : (itemSystem.shortRange || 'none'),\r\n      mediumRange: isSpell ? 'ok' : (itemSystem.mediumRange || 'none'),\r\n      longRange: isSpell ? 'ok' : (itemSystem.longRange || 'none'),\r\n      \r\n      // Attack skill/spec from actor (based on weapon links)\r\n      skillName: attackSkillName,\r\n      skillLevel: attackSkillLevel,\r\n      specName: attackSpecName,\r\n      specLevel: attackSpecLevel,\r\n      \r\n      // Actor information\r\n      actorId: this.actor.id,\r\n      actorUuid: this.actor.uuid,\r\n      actorName: this.actor.name || '',\r\n      \r\n      // RR List (merged: item RR + skill/spec/attribute RR)\r\n      rrList: allRRSources,\r\n      \r\n      // Spell-specific properties\r\n      spellType: isSpell ? spellType : undefined,  // 'direct' or 'indirect' for spells\r\n      isSpellDirect: isSpell && spellType === 'direct'  // Flag for direct spells (no defense)\r\n    });\r\n  }\r\n\r\n  /**\r\n   * REMOVED: Skill with weapon roll - dialog creation disabled\r\n   */\r\n  private async _rollSkillWithWeapon(skill: any, weaponName: string, _skillType: 'skill', weaponDamageValue?: string, weapon?: any): Promise<void> {\r\n    console.log('Skill with weapon roll disabled', { skill: skill.name, weaponName });\r\n  }\r\n\r\n  /**\r\n   * REMOVED: Specialization with weapon roll - dialog creation disabled\r\n   */\r\n  private async _rollSpecializationWithWeapon(specialization: any, weaponName: string, effectiveRating: number, weaponDamageValue?: string, weapon?: any): Promise<void> {\r\n    console.log('Specialization with weapon roll disabled', { specialization: specialization.name, weaponName });\r\n  }\r\n\r\n\r\n  /**\r\n   * Handle creating a new feat from search\r\n   */\r\n  private async _onCreateNewFeat(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const featName = button.dataset.featName;\r\n    \r\n    if (!featName) return;\r\n    \r\n    // Get the feat type from the selector\r\n    const selector = $(button).siblings('.feat-type-selector, .feat-type-selector-inline')[0] as HTMLSelectElement;\r\n    const featType = selector ? selector.value : 'equipment';\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = featName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new feat with default values\r\n    const featData = {\r\n      name: formattedName,\r\n      type: 'feat',\r\n      system: {\r\n        description: '',\r\n        rating: 0,\r\n        cost: 'free-equipment',\r\n        active: true,\r\n        featType: featType,\r\n        rrType: [],\r\n        rrValue: [],\r\n        rrTarget: [],\r\n        bonusLightDamage: 0,\r\n        bonusSevereDamage: 0,\r\n        bonusPhysicalThreshold: 0,\r\n        bonusMentalThreshold: 0,\r\n        bonusAnarchy: 0,\r\n        essenceCost: 0\r\n      }\r\n    } as any;\r\n    \r\n    // Add the feat to the actor\r\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [featData]) as any;\r\n    \r\n    if (createdItems && createdItems.length > 0) {\r\n      const newFeat = createdItems[0] as any;\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.feat-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.feat-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      // Open the feat sheet for editing\r\n      if (newFeat && newFeat.sheet) {\r\n        setTimeout(() => {\r\n          newFeat.sheet.render(true);\r\n        }, 100);\r\n      }\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.FEAT_CREATED', { name: formattedName }));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle switching between sheet types (V1 <-> V2)\r\n   */\r\n  private async _onSwitchSheet(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    // Import CharacterSheetV2 dynamically to avoid circular dependencies\r\n    const { CharacterSheetV2 } = await import('./character-sheet-v2.js');\r\n    \r\n    // Determine target sheet class based on current sheet type\r\n    const isV2 = this instanceof CharacterSheetV2;\r\n    \r\n    // Store actor reference and close current sheet\r\n    const actor = this.actor;\r\n    await this.close();\r\n    \r\n    // Create a new sheet instance with the target class\r\n    // Use CharacterSheet if currently V2, otherwise use CharacterSheetV2\r\n    const targetSheetClass = isV2 ? CharacterSheet : CharacterSheetV2;\r\n    const newSheet = new targetSheetClass(actor);\r\n    \r\n    // Reopen the sheet with the new class\r\n    setTimeout(() => {\r\n      newSheet.render(true);\r\n    }, 100);\r\n  }\r\n}\r\n\r\n","import { CharacterSheet } from './character-sheet.js';\r\n\r\n/**\r\n * Character Sheet Application V2\r\n * Nouvelle version de la fiche de personnage avec un template et des styles différents\r\n * Réutilise toute la logique TypeScript de CharacterSheet\r\n */\r\nexport class CharacterSheetV2 extends CharacterSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'character', 'character-v2'],\r\n      template: 'systems/sra2/templates/actor-character-sheet-v2.hbs',\r\n      // Vous pouvez aussi changer width/height si nécessaire\r\n      // width: 1000,\r\n      // height: 800,\r\n    });\r\n  }\r\n\r\n  // Toute la logique TypeScript est héritée de CharacterSheet\r\n  // Vous pouvez surcharger des méthodes spécifiques si nécessaire, par exemple:\r\n  \r\n  // override async getData(): Promise<any> {\r\n  //   const context = await super.getData();\r\n  //   // Ajouter des données spécifiques à la version 2 si nécessaire\r\n  //   return context;\r\n  // }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","import * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport * as DiceRoller from '../helpers/dice-roller.js';\r\nimport { VEHICLE_TYPES, WEAPON_TYPES } from '../models/item-feat.js';\r\n\r\n/**\r\n * Vehicle/Drone Sheet Application\r\n */\r\nexport class VehicleSheet extends ActorSheet {\r\n  private _activeSection: string | null = null;\r\n\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'vehicle'],\r\n      template: 'systems/sra2/templates/actor-vehicle-sheet.hbs',\r\n      width: 800,\r\n      height: 700,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dragSelector: '.item', dropSelector: '.sheet-body' }\r\n      ],\r\n      submitOnChange: false,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    // DEBUG: Log what we're about to update\r\n    console.log('VehicleSheet._updateObject - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'this.actor.uuid': this.actor.uuid,\r\n      'formData keys': Object.keys(formData),\r\n      'formData sample': Object.fromEntries(Object.entries(formData).slice(0, 5))\r\n    });\r\n    \r\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\r\n    \r\n    // CRITICAL FIX: Exclude damage from form submission (same as character sheet)\r\n    // Damage is handled exclusively by _onDamageChange handler to prevent form close reset\r\n    // Don't process damage here - _onDamageChange handles it directly\r\n    // Remove damage from expandedData if present to avoid conflicts and form close reset\r\n    if (expandedData.system?.damage !== undefined) {\r\n      delete expandedData.system.damage;\r\n    }\r\n    \r\n    // DEBUG: Log what we're sending to update\r\n    console.log('VehicleSheet._updateObject - About to update:', {\r\n      'actor.id': this.actor.id,\r\n      'expandedData keys': Object.keys(expandedData),\r\n      'expandedData.system keys': expandedData.system ? Object.keys(expandedData.system) : 'no system',\r\n      'damage excluded': !expandedData.system?.damage\r\n    });\r\n    \r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n\r\n    // DEBUG: Verify which actor we're working with\r\n    console.log('VehicleSheet.getData - DEBUG:', {\r\n      'this.actor.id': this.actor.id,\r\n      'this.actor.name': this.actor.name,\r\n      'this.actor.type': this.actor.type,\r\n      'context.actor.id': context.actor?.id,\r\n      'context.actor.name': context.actor?.name\r\n    });\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n\r\n    // DEBUG: Log damage data at vehicle sheet opening\r\n    const actorSource = (this.actor as any)._source;\r\n    const sourceDamage = actorSource?.system?.damage;\r\n    const currentDamage = (this.actor.system as any).damage;\r\n    console.log('VehicleSheet.getData - Damage data at opening:', {\r\n      'actor.id': this.actor.id,\r\n      'actor.name': this.actor.name,\r\n      '_source.system.damage': sourceDamage,\r\n      'this.actor.system.damage': currentDamage,\r\n      'sourceDamage type': typeof sourceDamage,\r\n      'currentDamage type': typeof currentDamage,\r\n      'sourceDamage.light': sourceDamage?.light,\r\n      'currentDamage.light': currentDamage?.light,\r\n      'sourceDamage.light type': Array.isArray(sourceDamage?.light) ? 'array' : typeof sourceDamage?.light,\r\n      'currentDamage.light type': Array.isArray(currentDamage?.light) ? 'array' : typeof currentDamage?.light\r\n    });\r\n\r\n    // Ensure damage arrays are properly initialized\r\n    const systemData = context.system as any;\r\n    if (!systemData.damage) {\r\n      systemData.damage = {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n    } else {\r\n      // Ensure arrays are properly sized\r\n      if (!Array.isArray(systemData.damage.light)) {\r\n        systemData.damage.light = [false, false];\r\n      }\r\n      while (systemData.damage.light.length < 2) {\r\n        systemData.damage.light.push(false);\r\n      }\r\n      while (systemData.damage.light.length > 2) {\r\n        systemData.damage.light.pop();\r\n      }\r\n      \r\n      if (!Array.isArray(systemData.damage.severe)) {\r\n        systemData.damage.severe = [false];\r\n      }\r\n      while (systemData.damage.severe.length < 1) {\r\n        systemData.damage.severe.push(false);\r\n      }\r\n      while (systemData.damage.severe.length > 1) {\r\n        systemData.damage.severe.pop();\r\n      }\r\n      \r\n      if (typeof systemData.damage.incapacitating !== 'boolean') {\r\n        systemData.damage.incapacitating = false;\r\n      }\r\n    }\r\n\r\n    // Add vehicle types for selection\r\n    context.vehicleTypes = VEHICLE_TYPES;\r\n\r\n    // Get feats (weapons only for vehicles)\r\n    const allFeats = this.actor.items.filter((item: any) => item.type === 'feat');\r\n    \r\n    // Get all active feats for RR calculation\r\n    const activeFeats = allFeats.filter((feat: any) => feat.system.active === true);\r\n    \r\n    // Get vehicle's structure for damage value calculations (similar to strength for characters)\r\n    const vehicleStructure = (this.actor.system as any).attributes?.structure || 0;\r\n    \r\n    // Helper function to calculate weapon stats\r\n    const calculateWeaponStats = (item: any) => {\r\n      const itemData = {\r\n        ...item,\r\n        _id: item.id || item._id,\r\n        id: item.id || item._id\r\n      };\r\n      \r\n      // For vehicles, weapons use Autopilot attribute when autonomous\r\n      // Otherwise, they would use the pilot's skills (handled externally)\r\n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\r\n      let totalDicePool = autopilot; // Base dice pool from autopilot\r\n      let totalRR = 0;\r\n      \r\n      // Calculate RR from active feats\r\n      activeFeats.forEach((feat: any) => {\r\n        const rrList = feat.system.rrList || [];\r\n        rrList.forEach((rrEntry: any) => {\r\n          if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\r\n            totalRR += rrEntry.rrValue || 0;\r\n          }\r\n        });\r\n      });\r\n      \r\n      itemData.totalDicePool = totalDicePool;\r\n      itemData.totalRR = totalRR;\r\n      \r\n      // Calculate final damage value with bonus\r\n      const damageValue = item.system.damageValue || '0';\r\n      const damageValueBonus = item.system.damageValueBonus || 0;\r\n      itemData.finalDamageValue = SheetHelpers.calculateFinalDamageValue(damageValue, damageValueBonus, vehicleStructure);\r\n      \r\n      return itemData;\r\n    };\r\n    \r\n    // Filter and process weapons (only weapons allowed for vehicles)\r\n    const rawWeapons = allFeats.filter((feat: any) => \r\n      feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells'\r\n    );\r\n    const weapons = rawWeapons.map((weapon: any) => calculateWeaponStats(weapon));\r\n    \r\n    context.weapons = weapons;\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Restore active section if it was saved\r\n    if (this._activeSection) {\r\n      setTimeout(() => {\r\n        const form = html.closest('form')[0];\r\n        if (form) {\r\n          const navButton = form.querySelector(`[data-section=\"${this._activeSection}\"]`);\r\n          if (navButton) {\r\n            form.querySelectorAll('.section-nav .nav-item').forEach((item) => item.classList.remove('active'));\r\n            navButton.classList.add('active');\r\n            \r\n            form.querySelectorAll('.content-section').forEach((section) => section.classList.remove('active'));\r\n            const targetSection = form.querySelector(`[data-section-content=\"${this._activeSection}\"]`);\r\n            if (targetSection) {\r\n              targetSection.classList.add('active');\r\n            }\r\n          }\r\n        }\r\n      }, 10);\r\n    }\r\n\r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n\r\n    // Edit feat/weapon\r\n    html.find('.feat-edit, .weapon-edit').on('click', (event) => {\r\n      event.preventDefault();\r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (item) {\r\n        item.sheet?.render(true);\r\n      }\r\n    });\r\n\r\n    // Delete feat/weapon\r\n    html.find('.feat-delete, .weapon-delete').on('click', async (event) => {\r\n      event.preventDefault();\r\n      // Save current active section before deletion\r\n      const activeNavItem = html.find('.section-nav .nav-item.active');\r\n      this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : null;\r\n      \r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (item) {\r\n        const confirmed = await Dialog.confirm({\r\n          title: game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name }),\r\n          content: '',\r\n          yes: () => true,\r\n          no: () => false,\r\n          defaultYes: false\r\n        });\r\n        if (confirmed) {\r\n          await item.delete();\r\n          // The sheet will auto-render, and activateListeners will restore the section\r\n        }\r\n      }\r\n    });\r\n\r\n    // Add world weapon (only weapons allowed)\r\n    html.find('.add-world-weapon-button').on('click', async (event) => {\r\n      event.preventDefault();\r\n      // Save current active section before opening browser\r\n      const activeNavItem = html.find('.section-nav .nav-item.active');\r\n      this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : null;\r\n      this._showItemBrowser('feat', true); // true = weapons only\r\n    });\r\n\r\n    // Roll weapon dice (using autopilot)\r\n    html.find('.weapon-dice-pool').on('click', async (event) => {\r\n      event.preventDefault();\r\n      const itemId = $(event.currentTarget).data('item-id');\r\n      const item = this.actor.items.get(itemId);\r\n      if (!item) return;\r\n      \r\n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\r\n      if (autopilot <= 0) {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\r\n        return;\r\n      }\r\n      \r\n      // Prepare complete weapon roll request data using combat-helpers\r\n      const rollRequestData = CombatHelpers.prepareVehicleWeaponRollRequest(\r\n        this.actor,\r\n        item,\r\n        WEAPON_TYPES\r\n      );\r\n      \r\n      // Call dice roller with prepared data\r\n      DiceRoller.handleRollRequest(rollRequestData);\r\n    });\r\n\r\n    // Handle vehicle type change\r\n    html.find('.vehicle-type-select').on('change', this._onVehicleTypeChange.bind(this));\r\n\r\n    // Handle bonus changes - update attributes in real-time\r\n    html.find('input[name=\"system.autopilotBonus\"], input[name=\"system.speedBonus\"], input[name=\"system.handlingBonus\"], input[name=\"system.armorBonus\"]').on('change', this._onBonusChange.bind(this));\r\n    \r\n    // Handle option changes - update attributes in real-time\r\n    html.find('input[name=\"system.isFixed\"], input[name=\"system.isFlying\"], input[name=\"system.weaponMountImprovement\"], input[name=\"system.autopilotUnlocked\"], input[name=\"system.additionalDroneCount\"]').on('change', this._onOptionChange.bind(this));\r\n\r\n    // Add narrative effect\r\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', async (event) => {\r\n      event.preventDefault();\r\n      \r\n      // Read current narrative effects from form inputs to preserve unsaved changes\r\n      const currentNarrativeEffects: any[] = [];\r\n      \r\n      // Extract all narrative effect values from form (preserve order and unsaved changes)\r\n      const narrativeEffectTextareas = html.find('textarea[name^=\"system.narrativeEffects.\"]');\r\n      narrativeEffectTextareas.each((_index, textarea) => {\r\n        const textareaElement = textarea as HTMLTextAreaElement;\r\n        const nameMatch = textareaElement.name.match(/system\\.narrativeEffects\\.(\\d+)\\.text/);\r\n        if (nameMatch) {\r\n          const index = parseInt(nameMatch[1]);\r\n          const text = textareaElement.value || '';\r\n          const isNegative = html.find(`input[name=\"system.narrativeEffects.${index}.isNegative\"]`).is(':checked');\r\n          const valueInput = html.find(`select[name=\"system.narrativeEffects.${index}.value\"]`);\r\n          const value = valueInput.length > 0 ? parseInt(valueInput.val() as string) || 0 : 0;\r\n          \r\n          currentNarrativeEffects[index] = {\r\n            text: text,\r\n            isNegative: isNegative,\r\n            value: value\r\n          };\r\n        }\r\n      });\r\n      \r\n      // Fill gaps in array\r\n      for (let i = 0; i < currentNarrativeEffects.length; i++) {\r\n        if (!currentNarrativeEffects[i]) {\r\n          currentNarrativeEffects[i] = { text: '', isNegative: false, value: 0 };\r\n        }\r\n      }\r\n      \r\n      // Add new empty effect\r\n      currentNarrativeEffects.push({ text: '', isNegative: false, value: 0 });\r\n      \r\n      await this.actor.update({\r\n        'system.narrativeEffects': currentNarrativeEffects\r\n      } as any);\r\n    });\r\n\r\n    // Remove narrative effect\r\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', async (event) => {\r\n      event.preventDefault();\r\n      const index = parseInt($(event.currentTarget).data('index') || '0');\r\n      \r\n      // Read current narrative effects from form inputs to preserve unsaved changes\r\n      const currentNarrativeEffects: any[] = [];\r\n      \r\n      // Extract all narrative effect values from form (preserve order and unsaved changes)\r\n      const narrativeEffectTextareas = html.find('textarea[name^=\"system.narrativeEffects.\"]');\r\n      narrativeEffectTextareas.each((_inputIndex, textarea) => {\r\n        const textareaElement = textarea as HTMLTextAreaElement;\r\n        const nameMatch = textareaElement.name.match(/system\\.narrativeEffects\\.(\\d+)\\.text/);\r\n        if (nameMatch) {\r\n          const effectIndex = parseInt(nameMatch[1]);\r\n          const text = textareaElement.value || '';\r\n          const isNegative = html.find(`input[name=\"system.narrativeEffects.${effectIndex}.isNegative\"]`).is(':checked');\r\n          const valueInput = html.find(`select[name=\"system.narrativeEffects.${effectIndex}.value\"]`);\r\n          const value = valueInput.length > 0 ? parseInt(valueInput.val() as string) || 0 : 0;\r\n          \r\n          currentNarrativeEffects[effectIndex] = {\r\n            text: text,\r\n            isNegative: isNegative,\r\n            value: value\r\n          };\r\n        }\r\n      });\r\n      \r\n      // Fill gaps in array\r\n      for (let i = 0; i < currentNarrativeEffects.length; i++) {\r\n        if (!currentNarrativeEffects[i]) {\r\n          currentNarrativeEffects[i] = { text: '', isNegative: false, value: 0 };\r\n        }\r\n      }\r\n      \r\n      // Remove the effect at the specified index\r\n      currentNarrativeEffects.splice(index, 1);\r\n      \r\n      await this.actor.update({\r\n        'system.narrativeEffects': currentNarrativeEffects\r\n      } as any);\r\n    });\r\n\r\n    // Handle damage checkbox changes (both in header and combat section)\r\n    html.find('input[name^=\"system.damage.\"]').on('change', async (event) => {\r\n      const input = event.currentTarget as HTMLInputElement;\r\n      const name = input.name;\r\n      const checked = input.checked;\r\n      \r\n      // DEBUG: Log which actor we're updating damage for\r\n      console.log('VehicleSheet damage change - DEBUG:', {\r\n        'this.actor.id': this.actor.id,\r\n        'this.actor.name': this.actor.name,\r\n        'this.actor.type': this.actor.type,\r\n        'input.name': name,\r\n        'checked': checked\r\n      });\r\n      \r\n      // Save current active section before update\r\n      const activeSection = SheetHelpers.getCurrentActiveSection(html);\r\n      \r\n      // Get current damage from actor data (read from _source for persisted values)\r\n      const actorSource = (this.actor as any)._source;\r\n      const currentDamage = actorSource?.system?.damage || (this.actor.system as any).damage || {\r\n        light: [false, false],\r\n        severe: [false],\r\n        incapacitating: false\r\n      };\r\n      \r\n      // Use helper to parse and update damage\r\n      const updatedDamage = SheetHelpers.parseDamageCheckboxChange(name, checked, currentDamage);\r\n      if (!updatedDamage) return;\r\n      \r\n      // Update the actor with the complete damage object\r\n      await this.actor.update({\r\n        'system.damage': updatedDamage\r\n      } as any, { render: false });\r\n      \r\n      // Synchronize all checkboxes with the same name and update visual state\r\n      html.find(`input[name=\"${name}\"]`).each((_, checkbox) => {\r\n        const $checkbox = $(checkbox);\r\n        $checkbox.prop('checked', checked);\r\n        $checkbox.closest('label.track-box').toggleClass('checked', checked);\r\n      });\r\n      \r\n      // Restore active section after update\r\n      const form = $(this.element).closest('form')[0] as HTMLElement;\r\n      if (form && activeSection) {\r\n        SheetHelpers.restoreActiveSection(form, activeSection);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    const button = event.currentTarget as HTMLElement;\r\n    const form = button.closest('form') as HTMLElement;\r\n    if (!form) return;\r\n    \r\n    const section = SheetHelpers.handleSectionNavigation(event, form);\r\n    if (section) {\r\n      this._activeSection = section;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle vehicle type selection change\r\n   */\r\n  private async _onVehicleTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const vehicleType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    if (!vehicleType || !VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES]) {\r\n      return;\r\n    }\r\n    \r\n    // Update vehicle type - the prepareDerivedData will calculate the attributes\r\n    await this.actor.update({\r\n      'system.vehicleType': vehicleType\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle bonus changes - update actor and re-render to show updated attributes\r\n   */\r\n  private async _onBonusChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    const value = parseInt(input.value) || 0;\r\n    \r\n    // Save current active section before update\r\n    const activeSection = SheetHelpers.getCurrentActiveSection($(this.element)) || 'attributes';\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate attributes\r\n    await this.actor.update({\r\n      [name]: value\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n    \r\n    // Restore active section after render\r\n    const form = $(this.element).closest('form')[0] as HTMLElement;\r\n    if (form) {\r\n      SheetHelpers.restoreActiveSection(form, activeSection);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle option changes (isFixed, isFlying, weaponMountImprovement, etc.) - update actor and re-render\r\n   */\r\n  private async _onOptionChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const name = input.name;\r\n    \r\n    // Save current active section before update\r\n    const activeSection = SheetHelpers.getCurrentActiveSection($(this.element)) || 'attributes';\r\n    \r\n    // Determine value based on input type\r\n    let value: any;\r\n    if (input.type === 'checkbox') {\r\n      value = input.checked;\r\n    } else if (input.type === 'number') {\r\n      value = parseInt(input.value) || 0;\r\n    } else {\r\n      value = input.value;\r\n    }\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate attributes\r\n    await this.actor.update({\r\n      [name]: value\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n    \r\n    // Restore active section after render\r\n    const form = $(this.element).closest('form')[0] as HTMLElement;\r\n    if (form) {\r\n      SheetHelpers.restoreActiveSection(form, activeSection);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show item browser dialog\r\n   */\r\n  private async _showItemBrowser(itemType: string, weaponsOnly: boolean = false): Promise<void> {\r\n    let items = game.items!.filter((item: any) => item.type === itemType);\r\n    \r\n    // Filter to only weapons if requested\r\n    if (weaponsOnly) {\r\n      items = items.filter((item: any) => {\r\n        const featType = item.system?.featType;\r\n        return featType === 'weapon' || featType === 'weapons-spells';\r\n      });\r\n    }\r\n    \r\n    const itemOptions = items.map((item: any) => {\r\n      return `<option value=\"${item.id}\">${item.name}</option>`;\r\n    }).join('');\r\n\r\n    const content = `\r\n      <div class=\"form-group\">\r\n        <label>${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.WORLD_ITEMS`)}</label>\r\n        <select id=\"item-select\" style=\"width: 100%;\">\r\n          <option value=\"\">${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.SEARCH_PLACEHOLDER`)}</option>\r\n          ${itemOptions}\r\n        </select>\r\n      </div>\r\n    `;\r\n\r\n    new Dialog({\r\n      title: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\r\n      content,\r\n      buttons: {\r\n        add: {\r\n          icon: '<i class=\"fas fa-plus\"></i>',\r\n          label: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\r\n          callback: async (html: JQuery) => {\r\n            const itemId = html.find('#item-select').val() as string;\r\n            if (itemId) {\r\n              const item = game.items!.get(itemId);\r\n              if (item) {\r\n                // The sheet will auto-render, and activateListeners will restore the section\r\n                await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n              }\r\n            }\r\n          }\r\n        },\r\n        cancel: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: game.i18n!.localize('Cancel')\r\n        }\r\n      },\r\n      default: 'add'\r\n    }).render(true);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping items onto the sheet\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<boolean | void> {\r\n    // Save current active section before drop\r\n    const activeNavItem = $(this.element).find('.section-nav .nav-item.active');\r\n    this._activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : 'attributes';\r\n    \r\n    // Get the dropped data\r\n    let data;\r\n    try {\r\n      data = JSON.parse(event.dataTransfer?.getData('text/plain') || '{}');\r\n    } catch (err) {\r\n      return super._onDrop(event);\r\n    }\r\n    \r\n    // Only allow weapons (feats of type weapon or weapons-spells)\r\n    if (data.type === 'Item') {\r\n      const item = await Item.fromDropData(data);\r\n      if (item && item.type === 'feat') {\r\n        const featType = (item.system as any).featType;\r\n        if (featType === 'weapon' || featType === 'weapons-spells') {\r\n          // Create the item on the actor\r\n          // The sheet will auto-render, and activateListeners will restore the section\r\n          await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\r\n          \r\n          return false; // Prevent default behavior\r\n        } else {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.VEHICLE.ONLY_WEAPONS_ALLOWED'));\r\n          return false; // Prevent default behavior\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Fall back to default behavior for other item types\r\n    return super._onDrop(event);\r\n  }\r\n}\r\n\r\n","import * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\r\nimport { ICE_TYPES } from '../models/actor-ice.js';\r\n\r\n/**\r\n * ICE Sheet Application\r\n */\r\nexport class IceSheet extends ActorSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'actor', 'ice'],\r\n      template: 'systems/sra2/templates/actor-ice-sheet.hbs',\r\n      width: 600,\r\n      height: 500,\r\n      tabs: [],\r\n      dragDrop: [],\r\n      submitOnChange: false,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle form submission to update actor data\r\n   */\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\r\n    return this.actor.update(expandedData);\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n\r\n    // Ensure system data is available\r\n    context.system = this.actor.system;\r\n\r\n    // Add ICE types for selection\r\n    context.iceTypes = ICE_TYPES;\r\n\r\n    // Get ICE type description\r\n    const iceType = (this.actor.system as any).iceType || '';\r\n    context.iceTypeDescription = this._getIceTypeDescription(iceType);\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n\r\n    // Handle ICE type change\r\n    html.find('.ice-type-select').on('change', this._onIceTypeChange.bind(this));\r\n\r\n    // Handle server index change\r\n    html.find('input[name=\"system.serverIndex\"]').on('change', this._onServerIndexChange.bind(this));\r\n\r\n    // Handle ICE attack button\r\n    html.find('.ice-attack-button').on('click', this._onIceAttack.bind(this));\r\n  }\r\n\r\n  /**\r\n   * Handle ICE type selection change\r\n   */\r\n  private async _onIceTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const iceType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    // Update ICE type - the prepareDerivedData will calculate the attributes\r\n    await this.actor.update({\r\n      'system.iceType': iceType || null\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle server index change - update actor and re-render\r\n   */\r\n  private async _onServerIndexChange(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(input.value) || 1;\r\n    \r\n    // Update the actor - prepareDerivedData will recalculate threshold and damage\r\n    await this.actor.update({\r\n      'system.serverIndex': Math.max(1, Math.min(12, value))\r\n    } as any);\r\n    \r\n    // Re-render to show updated calculated attributes\r\n    await this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Get description for ICE type\r\n   */\r\n  private _getIceTypeDescription(iceType: string): string {\r\n    const descriptions: Record<string, string> = {\r\n      patrol: 'SRA2.ICE.DESCRIPTION.PATROL',\r\n      acid: 'SRA2.ICE.DESCRIPTION.ACID',\r\n      blaster: 'SRA2.ICE.DESCRIPTION.BLASTER',\r\n      blocker: 'SRA2.ICE.DESCRIPTION.BLOCKER',\r\n      black: 'SRA2.ICE.DESCRIPTION.BLACK',\r\n      glue: 'SRA2.ICE.DESCRIPTION.GLUE',\r\n      tracker: 'SRA2.ICE.DESCRIPTION.TRACKER',\r\n      killer: 'SRA2.ICE.DESCRIPTION.KILLER'\r\n    };\r\n    \r\n    return descriptions[iceType] || '';\r\n  }\r\n\r\n  /**\r\n   * Handle ICE attack button click\r\n   */\r\n  private async _onIceAttack(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    // Get selected token (defender)\r\n    const controlledTokens = canvas?.tokens?.controlled || [];\r\n    if (controlledTokens.length === 0) {\r\n      ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.ATTACK.NO_TARGET'));\r\n      return;\r\n    }\r\n    \r\n    const defenderToken = controlledTokens[0];\r\n    const defender = defenderToken.actor;\r\n    \r\n    if (!defender) {\r\n      ui.notifications?.warn(game.i18n!.localize('SRA2.ICE.ATTACK.NO_TARGET'));\r\n      return;\r\n    }\r\n    \r\n    // Get ICE token (if on canvas) or use actor\r\n    let iceToken = null;\r\n    if (this.actor.isToken) {\r\n      iceToken = this.actor.token;\r\n    } else {\r\n      // Try to find token on canvas\r\n      const tokens = canvas?.tokens?.placeables || [];\r\n      iceToken = tokens.find((token: any) => token.actor?.id === this.actor.id) || null;\r\n    }\r\n    \r\n    // Create attack message\r\n    await CombatHelpers.createIceAttackMessage(this.actor, iceToken, defender, defenderToken);\r\n  }\r\n}\r\n\r\n","import { WEAPON_TYPES } from '../models/item-feat.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Feat Sheet Application\r\n */\r\nexport class FeatSheet extends ItemSheet {\r\n  /** Track the currently active section */\r\n  private _activeSection: string = 'general';\r\n  \r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'feat'],\r\n      template: 'systems/sra2/templates/item-feat-sheet.hbs',\r\n      width: 720,\r\n      height: 680,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dropSelector: '.rr-target-drop-zone' }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    \r\n    // Ensure prepareDerivedData is called to calculate recommendedLevel\r\n    this.item.prepareData();\r\n    \r\n    context.system = this.item.system;\r\n    \r\n    // Pass the active section to the template\r\n    context.activeSection = this._activeSection;\r\n    \r\n    // Calculate final damage value\r\n    context.finalDamageValue = this._calculateFinalDamageValue();\r\n    \r\n    // Calculate cyberdeck damage thresholds\r\n    context.cyberdeckDamageThresholds = this._calculateCyberdeckDamageThresholds();\r\n    \r\n    // Build RR entries array from rrList\r\n    context.rrEntries = [];\r\n    const rrList = context.system.rrList || [];\r\n    \r\n    for (let i = 0; i < rrList.length; i++) {\r\n      const rrEntry = rrList[i];\r\n      const rrType = rrEntry.rrType;\r\n      const rrValue = rrEntry.rrValue || 0;\r\n      const rrTarget = rrEntry.rrTarget || '';\r\n      \r\n      const entry: any = {\r\n        index: i,\r\n        rrType,\r\n        rrValue,\r\n        rrTarget,\r\n        rrTargetName: rrTarget\r\n      };\r\n      \r\n      if (rrType === 'skill' || rrType === 'specialization') {\r\n        entry.rrTargetType = rrType === 'skill' \r\n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\r\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\r\n        \r\n        // If the feat is on an actor, check if the target exists\r\n        if (this.item.actor && rrTarget) {\r\n          const targetItem = this.item.actor.items.find((i: any) => \r\n            i.type === rrType && i.name === rrTarget\r\n          );\r\n          \r\n          if (!targetItem) {\r\n            entry.rrTargetNotFound = true;\r\n          }\r\n        }\r\n      }\r\n      \r\n      context.rrEntries.push(entry);\r\n    }\r\n    \r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Add RR entry button\r\n    html.find('[data-action=\"add-rr-entry\"]').on('click', this._onAddRREntry.bind(this));\r\n    \r\n    // Remove RR entry button\r\n    html.find('[data-action=\"remove-rr-entry\"]').on('click', this._onRemoveRREntry.bind(this));\r\n    \r\n    // Clear RR target button\r\n    html.find('[data-action=\"clear-rr-target\"]').on('click', this._onClearRRTarget.bind(this));\r\n    \r\n    // Add narrative effect button\r\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', this._onAddNarrativeEffect.bind(this));\r\n    \r\n    // Remove narrative effect button\r\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', this._onRemoveNarrativeEffect.bind(this));\r\n    \r\n    // Narrative effect negative checkbox change\r\n    html.find('input[name^=\"system.narrativeEffects\"][name$=\".isNegative\"]').on('change', this._onNarrativeEffectNegativeChange.bind(this));\r\n    \r\n    // Weapon type selection\r\n    html.find('[data-action=\"select-weapon-type\"]').on('change', this._onWeaponTypeChange.bind(this));\r\n    \r\n    // Damage value bonus checkboxes\r\n    html.find('.damage-bonus-checkbox').on('change', this._onDamageValueBonusChange.bind(this));\r\n    \r\n    // Sustained spell checkboxes\r\n    html.find('.sustained-spell-checkbox').on('change', this._onSustainedSpellChange.bind(this));\r\n    \r\n    // Summoned spirit checkbox\r\n    html.find('.summoned-spirit-checkbox').on('change', this._onSummonedSpiritChange.bind(this));\r\n    \r\n    // Range improvement checkboxes\r\n    html.find('.range-improvement-checkbox input[type=\"checkbox\"]').on('change', this._onRangeImprovementChange.bind(this));\r\n    \r\n    // Astral projection checkbox change - automatically enable astral perception\r\n    html.find('input[name=\"system.astralProjection\"]').on('change', this._onAstralProjectionChange.bind(this));\r\n    \r\n    // Section navigation\r\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\r\n    \r\n    // RR target search\r\n    html.find('.rr-target-search-input').on('input', this._onRRTargetSearch.bind(this));\r\n    html.find('.rr-target-search-input').on('focus', this._onRRTargetSearchFocus.bind(this));\r\n    html.find('.rr-target-search-input').on('blur', this._onRRTargetSearchBlur.bind(this));\r\n    \r\n    // Close RR target search results when clicking outside\r\n    $(document).on('click.rr-target-search', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const searchContainers = html.find('.rr-target-search-container');\r\n      searchContainers.each((_, container) => {\r\n        if (!container.contains(target)) {\r\n          $(container).find('.rr-target-search-results').hide();\r\n        }\r\n      });\r\n    });\r\n  }\r\n  \r\n  /**\r\n   * Handle section navigation\r\n   */\r\n  private _onSectionNavigation(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const button = event.currentTarget as HTMLElement;\r\n    const section = button.dataset.section;\r\n    \r\n    if (!section) return;\r\n    \r\n    // Save the active section\r\n    this._activeSection = section;\r\n    \r\n    // Find the form element\r\n    if (!this.form) return;\r\n    const form = $(this.form);\r\n    \r\n    // Update navigation buttons\r\n    form.find('.section-nav .nav-item').removeClass('active');\r\n    button.classList.add('active');\r\n    \r\n    // Update content sections\r\n    form.find('.content-section').removeClass('active');\r\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\r\n  }\r\n\r\n  /**\r\n   * Handle adding a new RR entry\r\n   */\r\n  private async _onAddRREntry(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    rrList.push({\r\n      rrType: 'skill',\r\n      rrValue: 0,\r\n      rrTarget: ''\r\n    });\r\n    \r\n    await this.item.update({\r\n      'system.rrList': rrList\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle removing an RR entry\r\n   */\r\n  private async _onRemoveRREntry(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    rrList.splice(index, 1);\r\n    \r\n    await this.item.update({\r\n      'system.rrList': rrList\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle clearing the RR target for a specific entry\r\n   */\r\n  private async _onClearRRTarget(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    if (rrList[index]) {\r\n      rrList[index] = { ...rrList[index], rrTarget: '' };\r\n    }\r\n    \r\n    await this.item.update({ 'system.rrList': rrList } as any);\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping a skill or specialization onto the RR target field\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    const data = TextEditor.getDragEventData(event) as any;\r\n    \r\n    // Handle Item drops\r\n    if (data && data.type === 'Item') {\r\n      const item = await Item.implementation.fromDropData(data) as any;\r\n      \r\n      if (!item) return super._onDrop(event);\r\n      \r\n      // Find the drop zone and get the index\r\n      const dropZone = (event.target as HTMLElement).closest('[data-rr-index]');\r\n      if (!dropZone) return super._onDrop(event);\r\n      \r\n      const index = parseInt((dropZone as HTMLElement).dataset.rrIndex || '0');\r\n      const rrList = [...((this.item.system as any).rrList || [])];\r\n      const rrType = rrList[index]?.rrType;\r\n      \r\n      // Check if it's a skill or specialization matching the RR type\r\n      if (item.type === 'skill' && rrType === 'skill') {\r\n        // Store the skill name (not ID) so the feat can be prepared in advance\r\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\r\n        await this.item.update({ 'system.rrList': rrList } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\r\n        return;\r\n      } else if (item.type === 'specialization' && rrType === 'specialization') {\r\n        // Store the specialization name (not ID) so the feat can be prepared in advance\r\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\r\n        await this.item.update({ 'system.rrList': rrList } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\r\n        return;\r\n      } else if (rrType === 'skill' || rrType === 'specialization') {\r\n        // Wrong type of item\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.WRONG_TARGET_TYPE'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    return super._onDrop(event);\r\n  }\r\n\r\n  /**\r\n   * Handle adding a new narrative effect\r\n   */\r\n  private async _onAddNarrativeEffect(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    narrativeEffects.push({\r\n      text: \"\",\r\n      isNegative: false,\r\n      value: 1\r\n    });\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle removing a narrative effect\r\n   */\r\n  private async _onRemoveNarrativeEffect(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    narrativeEffects.splice(index, 1);\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle narrative effect negative checkbox change\r\n   * Reset value to appropriate default when switching between positive and negative\r\n   */\r\n  private async _onNarrativeEffectNegativeChange(event: Event): Promise<void> {\r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const name = checkbox.name;\r\n    \r\n    // Extract index from name like \"system.narrativeEffects.0.isNegative\"\r\n    const match = name.match(/system\\.narrativeEffects\\.(\\d+)\\.isNegative/);\r\n    if (!match) return;\r\n    \r\n    const index = parseInt(match[1]);\r\n    const isNegative = checkbox.checked;\r\n    \r\n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\r\n    \r\n    if (narrativeEffects[index]) {\r\n      // Reset value to appropriate default: 1 for positive, -1 for negative\r\n      narrativeEffects[index] = {\r\n        ...narrativeEffects[index],\r\n        isNegative: isNegative,\r\n        value: isNegative ? -1 : 1\r\n      };\r\n    }\r\n    \r\n    await this.item.update({\r\n      'system.narrativeEffects': narrativeEffects\r\n    } as any);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Calculate the final damage value taking into account STRENGTH attribute\r\n   */\r\n  private _calculateFinalDamageValue(): string {\r\n    const damageValue = (this.item.system as any).damageValue || \"0\";\r\n    const damageValueBonus = (this.item.system as any).damageValueBonus || 0;\r\n    \r\n    // Get the actor's strength if available\r\n    const strength = this.item.actor ? ((this.item.actor.system as any)?.attributes?.strength || 0) : 0;\r\n    \r\n    // Parse the damage value\r\n    if (damageValue === \"FOR\") {\r\n      // Pure STRENGTH\r\n      const total = strength + damageValueBonus;\r\n      if (!this.item.actor) {\r\n        return damageValueBonus > 0 ? `FOR+${damageValueBonus}` : \"FOR\";\r\n      }\r\n      return `${total} (FOR${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\r\n    } else if (damageValue.startsWith(\"FOR+\")) {\r\n      // STRENGTH + modifier\r\n      const modifier = parseInt(damageValue.substring(4)) || 0;\r\n      const total = strength + modifier + damageValueBonus;\r\n      if (!this.item.actor) {\r\n        return damageValueBonus > 0 ? `FOR+${modifier}+${damageValueBonus}` : `FOR+${modifier}`;\r\n      }\r\n      return `${total} (FOR+${modifier}${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\r\n    } else if (damageValue === \"toxin\") {\r\n      // Special case for gas grenades\r\n      return \"selon toxine\";\r\n    } else {\r\n      // Numeric value\r\n      const base = parseInt(damageValue) || 0;\r\n      const total = base + damageValueBonus;\r\n      if (damageValueBonus > 0) {\r\n        return `${total} (${base}+${damageValueBonus})`;\r\n      }\r\n      return total.toString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle weapon type selection change\r\n   */\r\n  private async _onWeaponTypeChange(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    \r\n    const weaponType = (event.currentTarget as HTMLSelectElement).value;\r\n    \r\n    if (!weaponType || !WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES]) {\r\n      return;\r\n    }\r\n    \r\n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n    \r\n    // Convert damage value to string\r\n    const damageValue = typeof weaponStats.vd === 'number' ? weaponStats.vd.toString() : weaponStats.vd;\r\n    \r\n    const updateData: any = {\r\n      'system.weaponType': weaponType,\r\n      'system.damageValue': damageValue,\r\n      'system.meleeRange': weaponStats.melee,\r\n      'system.shortRange': weaponStats.short,\r\n      'system.mediumRange': weaponStats.medium,\r\n      'system.longRange': weaponStats.long\r\n    };\r\n    \r\n    // For custom weapons, initialize linked skills/specializations with default values if not already set\r\n    if (weaponType === 'custom-weapon') {\r\n      const currentSystem = (this.item.system as any);\r\n      if (!currentSystem.linkedAttackSkill) {\r\n        updateData['system.linkedAttackSkill'] = weaponStats.linkedSkill;\r\n      }\r\n      if (!currentSystem.linkedAttackSpecialization) {\r\n        updateData['system.linkedAttackSpecialization'] = weaponStats.linkedSpecialization;\r\n      }\r\n      if (!currentSystem.linkedDefenseSkill) {\r\n        updateData['system.linkedDefenseSkill'] = weaponStats.linkedDefenseSkill;\r\n      }\r\n      if (!currentSystem.linkedDefenseSpecialization) {\r\n        updateData['system.linkedDefenseSpecialization'] = weaponStats.linkedDefenseSpecialization;\r\n      }\r\n    }\r\n    \r\n    await this.item.update(updateData);\r\n    \r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Calculate cyberdeck damage thresholds based on firewall\r\n   */\r\n  private _calculateCyberdeckDamageThresholds(): any {\r\n    const firewall = (this.item.system as any).firewall || 1;\r\n    \r\n    return {\r\n      light: firewall,\r\n      severe: firewall * 2,\r\n      incapacitating: firewall * 3\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Handle damage value bonus checkbox changes\r\n   */\r\n  private _onDamageValueBonusChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(checkbox.dataset.bonusValue || '0');\r\n    const currentBonus = (this.item.system as any).damageValueBonus || 0;\r\n    \r\n    let newBonus: number;\r\n    \r\n    if (checkbox.checked) {\r\n      // If checking, set to the checkbox value\r\n      newBonus = value;\r\n    } else {\r\n      // If unchecking, decrease appropriately\r\n      if (value === 2 && currentBonus === 2) {\r\n        newBonus = 1;\r\n      } else if (value === 1 && currentBonus >= 1) {\r\n        newBonus = 0;\r\n      } else {\r\n        newBonus = currentBonus;\r\n      }\r\n    }\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.damageValueBonus\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newBonus.toString();\r\n    }\r\n    \r\n    // Update the checkboxes state\r\n    const checkboxes = this.element.find('.damage-bonus-checkbox');\r\n    checkboxes.each((_, cb) => {\r\n      const cbElement = cb as HTMLInputElement;\r\n      const cbValue = parseInt(cbElement.dataset.bonusValue || '0');\r\n      if (cbValue === 1) {\r\n        cbElement.checked = newBonus >= 1;\r\n      } else if (cbValue === 2) {\r\n        cbElement.checked = newBonus === 2;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle sustained spell checkbox changes\r\n   */\r\n  private _onSustainedSpellChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const value = parseInt(checkbox.dataset.spellValue || '0');\r\n    const currentCount = (this.item.system as any).sustainedSpellCount || 0;\r\n    \r\n    let newCount: number;\r\n    \r\n    if (checkbox.checked) {\r\n      // If checking, set to the checkbox value\r\n      newCount = value;\r\n    } else {\r\n      // If unchecking, decrease appropriately\r\n      if (value === 2 && currentCount === 2) {\r\n        newCount = 1;\r\n      } else if (value === 1 && currentCount >= 1) {\r\n        newCount = 0;\r\n      } else {\r\n        newCount = currentCount;\r\n      }\r\n    }\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.sustainedSpellCount\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newCount.toString();\r\n    }\r\n    \r\n    // Update the checkboxes state\r\n    const checkboxes = this.element.find('.sustained-spell-checkbox');\r\n    checkboxes.each((_, cb) => {\r\n      const cbElement = cb as HTMLInputElement;\r\n      const cbValue = parseInt(cbElement.dataset.spellValue || '0');\r\n      if (cbValue === 1) {\r\n        cbElement.checked = newCount >= 1;\r\n      } else if (cbValue === 2) {\r\n        cbElement.checked = newCount === 2;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle summoned spirit checkbox change\r\n   */\r\n  private _onSummonedSpiritChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const newCount = checkbox.checked ? 1 : 0;\r\n    \r\n    // Update the hidden input field\r\n    const hiddenInput = this.element.find('input[name=\"system.summonedSpiritCount\"]')[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newCount.toString();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle range improvement checkbox change\r\n   * When checked, automatically improves the range: none -> disadvantage, disadvantage -> ok\r\n   * When unchecked, automatically downgrades the range: ok -> disadvantage, disadvantage -> none\r\n   */\r\n  private _onRangeImprovementChange(event: Event): void {\r\n    event.preventDefault();\r\n    \r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const isChecked = checkbox.checked;\r\n    \r\n    // Find which range this checkbox is for\r\n    const rangeRow = checkbox.closest('.range-row');\r\n    if (!rangeRow) return;\r\n    \r\n    const select = rangeRow.querySelector('select') as HTMLSelectElement;\r\n    if (!select) return;\r\n    \r\n    // Determine which range field we're dealing with\r\n    const rangeLabel = rangeRow.querySelector('.range-label')?.textContent || '';\r\n    let fieldName = '';\r\n    if (rangeLabel.includes('Contact') || rangeLabel.includes('Melee') || rangeLabel.includes('Mêlée')) {\r\n      fieldName = 'system.meleeRange';\r\n    } else if (rangeLabel.includes('Courte') || rangeLabel.includes('Short')) {\r\n      fieldName = 'system.shortRange';\r\n    } else if (rangeLabel.includes('Moyenne') || rangeLabel.includes('Medium')) {\r\n      fieldName = 'system.mediumRange';\r\n    } else if (rangeLabel.includes('Longue') || rangeLabel.includes('Long')) {\r\n      fieldName = 'system.longRange';\r\n    }\r\n    \r\n    const currentValue = select.value;\r\n    let newValue = currentValue;\r\n    \r\n    if (isChecked) {\r\n      // Improve the range: none -> disadvantage, disadvantage -> ok\r\n      if (currentValue === 'none') {\r\n        newValue = 'disadvantage';\r\n      } else if (currentValue === 'disadvantage') {\r\n        newValue = 'ok';\r\n      }\r\n      // If already 'ok', keep it at 'ok'\r\n    } else {\r\n      // Downgrade the range: ok -> disadvantage, disadvantage -> none\r\n      if (currentValue === 'ok') {\r\n        newValue = 'disadvantage';\r\n      } else if (currentValue === 'disadvantage') {\r\n        newValue = 'none';\r\n      }\r\n      // If already 'none', keep it at 'none'\r\n    }\r\n    \r\n    // Update the disabled select for visual display\r\n    select.value = newValue;\r\n    \r\n    // Update the hidden input that holds the actual value\r\n    const hiddenInput = this.element.find(`input[name=\"${fieldName}\"]`)[0] as HTMLInputElement;\r\n    if (hiddenInput) {\r\n      hiddenInput.value = newValue;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle astral projection checkbox change\r\n   * Automatically enable astral perception when projection is enabled\r\n   */\r\n  private async _onAstralProjectionChange(event: Event): Promise<void> {\r\n    const checkbox = event.currentTarget as HTMLInputElement;\r\n    const isProjectionEnabled = checkbox.checked;\r\n    \r\n    if (isProjectionEnabled) {\r\n      // Automatically enable astral perception\r\n      const astralPerceptionInput = this.element.find('input[name=\"system.astralPerception\"]')[0] as HTMLInputElement;\r\n      if (astralPerceptionInput) {\r\n        astralPerceptionInput.checked = true;\r\n      }\r\n      \r\n      // Update the item to set astralPerception to true\r\n      await this.item.update({\r\n        'system.astralPerception': true\r\n      } as any);\r\n      \r\n      // Re-render to update the disabled state\r\n      this.render(false);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search input\r\n   */\r\n  private rrTargetSearchTimeout: any = null;\r\n  \r\n  private async _onRRTargetSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const rrIndex = parseInt(input.dataset.rrIndex || '0');\r\n    const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.rrTargetSearchTimeout) {\r\n      clearTimeout(this.rrTargetSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.rrTargetSearchTimeout = setTimeout(async () => {\r\n      await this._performRRTargetSearch(searchTerm, rrIndex, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual RR target search in actor items and compendiums\r\n   */\r\n  private async _performRRTargetSearch(searchTerm: string, rrIndex: number, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    const rrList = (this.item.system as any).rrList || [];\r\n    const rrType = rrList[rrIndex]?.rrType;\r\n    \r\n    if (!rrType || rrType === 'attribute') {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Search in actor items if this feat is on an actor\r\n    if (this.item.actor) {\r\n      for (const item of this.item.actor.items as any) {\r\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\r\n            type: rrType\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in world items\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === item.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: item.name,\r\n              uuid: item.uuid,\r\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\r\n              type: rrType\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for items that match the search term and type\r\n      for (const doc of documents) {\r\n        if (doc.type === rrType && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          // Check if not already in results\r\n          const exists = results.some(r => r.name === doc.name);\r\n          if (!exists) {\r\n            results.push({\r\n              name: doc.name,\r\n              uuid: doc.uuid,\r\n              source: pack.title,\r\n              type: rrType\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displayRRTargetSearchResults(results, rrIndex, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display RR target search results\r\n   */\r\n  private _displayRRTargetSearchResults(results: any[], rrIndex: number, resultsDiv: HTMLElement): void {\r\n    let html = '';\r\n    \r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const typeLabel = result.type === 'skill' \r\n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\r\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\r\n        \r\n        html += `\r\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\r\n            </div>\r\n            <button class=\"add-rr-target-btn\" data-target-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\r\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers to buttons\r\n    $(resultsDiv).find('.add-rr-target-btn').on('click', this._onSelectRRTarget.bind(this));\r\n    \r\n    // Make entire result items clickable\r\n    $(resultsDiv).find('.search-result-item:not(.no-results)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.add-rr-target-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.add-rr-target-btn')[0] as HTMLButtonElement;\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Handle selecting an RR target from search results\r\n   */\r\n  private async _onSelectRRTarget(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const targetName = button.dataset.targetName;\r\n    const rrIndex = parseInt(button.dataset.rrIndex || '0');\r\n    \r\n    if (!targetName) return;\r\n    \r\n    const rrList = [...((this.item.system as any).rrList || [])];\r\n    \r\n    if (rrList[rrIndex]) {\r\n      rrList[rrIndex] = { ...rrList[rrIndex], rrTarget: targetName };\r\n    }\r\n    \r\n    await this.item.update({ 'system.rrList': rrList } as any);\r\n    this.render(false);\r\n    \r\n    ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: targetName }));\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search focus\r\n   */\r\n  private _onRRTargetSearchFocus(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle RR target search blur\r\n   */\r\n  private _onRRTargetSearchBlur(event: Event): void {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.rr-target-search');\r\n    return super.close(options);\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData) as any;\r\n    \r\n    // If astral projection is enabled, automatically enable astral perception\r\n    if (expandedData.system?.astralProjection === true) {\r\n      expandedData.system.astralPerception = true;\r\n    }\r\n    \r\n    // Check if isFirstFeat is being set to true for a trait\r\n    if (expandedData.system?.isFirstFeat === true && \r\n        expandedData.system?.featType === 'trait' && \r\n        this.item.actor) {\r\n      \r\n      // Find all other traits on the same actor that have isFirstFeat = true\r\n      const otherFirstFeats = this.item.actor.items.filter((item: any) => \r\n        item.type === 'feat' &&\r\n        item.id !== this.item.id &&\r\n        item.system?.featType === 'trait' &&\r\n        item.system?.isFirstFeat === true\r\n      );\r\n      \r\n      // If there are other traits with isFirstFeat, uncheck them\r\n      if (otherFirstFeats.length > 0) {\r\n        for (const otherFeat of otherFirstFeats) {\r\n          await otherFeat.update({\r\n            'system.isFirstFeat': false\r\n          } as any);\r\n        }\r\n        \r\n        ui.notifications?.info(\r\n          game.i18n!.localize('SRA2.FEATS.FIRST_FEAT_TRANSFERRED') || \r\n          'The \"first trait\" flag has been moved from the other trait(s) to this one.'\r\n        );\r\n      }\r\n    }\r\n    \r\n    // Update the item first to recalculate recommendedLevel\r\n    await this.item.update(expandedData);\r\n    \r\n    // Recalculate derived data to get the new recommendedLevel\r\n    this.item.prepareData();\r\n    \r\n    // Sync rating with recommendedLevel\r\n    const recommendedLevel = (this.item.system as any).recommendedLevel || 0;\r\n    const currentRating = (this.item.system as any).rating || 0;\r\n    \r\n    // Only update rating if it's different from recommendedLevel\r\n    if (currentRating !== recommendedLevel) {\r\n      await this.item.update({\r\n        'system.rating': recommendedLevel\r\n      } as any);\r\n    }\r\n    \r\n    return this.item;\r\n  }\r\n}\r\n\r\n","/**\r\n * Skill Sheet Application\r\n */\r\nexport class SkillSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'skill'],\r\n      template: 'systems/sra2/templates/item-skill-sheet.hbs',\r\n      width: 520,\r\n      height: 480,\r\n      tabs: [],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    return context;\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n}\r\n\r\n","import * as ItemSearch from '../../../item-search.js';\r\n\r\n/**\r\n * Specialization Sheet Application\r\n */\r\nexport class SpecializationSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'specialization'],\r\n      template: 'systems/sra2/templates/item-specialization-sheet.hbs',\r\n      width: 520,\r\n      height: 480,\r\n      tabs: [],\r\n      dragDrop: [\r\n        { dropSelector: '.linked-skill-drop-zone' }\r\n      ],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    \r\n    // Get linked skill info if exists\r\n    if (context.system.linkedSkill) {\r\n      // linkedSkill is stored as a name, so we display it directly\r\n      context.linkedSkillName = context.system.linkedSkill;\r\n      \r\n      // If the specialization is on an actor, check if the skill exists\r\n      if (this.item.actor) {\r\n        const linkedSkill = this.item.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === context.system.linkedSkill\r\n        );\r\n        \r\n        if (!linkedSkill) {\r\n          // Mark as warning if skill doesn't exist on this actor\r\n          context.linkedSkillNotFound = true;\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Get list of skills from the actor if this item is owned (for dropdown)\r\n    if (this.item.actor) {\r\n      const skills = this.item.actor.items.filter((i: any) => i.type === 'skill');\r\n      context.skills = skills.map((s: any) => ({\r\n        name: s.name\r\n      }));\r\n    } else {\r\n      context.skills = [];\r\n    }\r\n    \r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Clear linked skill button\r\n    html.find('[data-action=\"clear-linked-skill\"]').on('click', this._onClearLinkedSkill.bind(this));\r\n    \r\n    // Skill search\r\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\r\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\r\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\r\n    \r\n    // Close skill search results when clicking outside\r\n    $(document).on('click.skill-search-spec', (event) => {\r\n      const target = event.target as unknown as HTMLElement;\r\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\r\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\r\n        html.find('.skill-search-results').hide();\r\n      }\r\n    });\r\n  }\r\n\r\n  override async close(options?: Application.CloseOptions): Promise<void> {\r\n    // Clean up document-level event listeners\r\n    $(document).off('click.skill-search-spec');\r\n    return super.close(options);\r\n  }\r\n\r\n  /**\r\n   * Handle clearing the linked skill\r\n   */\r\n  private async _onClearLinkedSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    await this.item.update({ 'system.linkedSkill': '' } as any);\r\n    this.render(false);\r\n  }\r\n\r\n  /**\r\n   * Handle dropping a skill onto the linked skill field\r\n   */\r\n  protected override async _onDrop(event: DragEvent): Promise<any> {\r\n    const data = TextEditor.getDragEventData(event) as any;\r\n    \r\n    // Handle Item drops\r\n    if (data && data.type === 'Item') {\r\n      const item = await Item.implementation.fromDropData(data) as any;\r\n      \r\n      if (!item) return super._onDrop(event);\r\n      \r\n      // Check if it's a skill\r\n      if (item.type === 'skill') {\r\n        // Store the skill name (not ID) so the specialization can be prepared in advance\r\n        await this.item.update({ 'system.linkedSkill': item.name } as any);\r\n        this.render(false);\r\n        ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.LINKED_TO_SKILL', { name: item.name }));\r\n        return;\r\n      } else {\r\n        ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.ONLY_SKILLS_CAN_BE_LINKED'));\r\n        return;\r\n      }\r\n    }\r\n\r\n    return super._onDrop(event);\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n\r\n  /**\r\n   * SKILL SEARCH FUNCTIONS\r\n   */\r\n  \r\n  private skillSearchTimeout: any = null;\r\n  private lastSkillSearchTerm: string = '';\r\n  \r\n  /**\r\n   * Handle skill search input\r\n   */\r\n  private async _onSkillSearch(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\r\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n    \r\n    // Clear previous timeout\r\n    if (this.skillSearchTimeout) {\r\n      clearTimeout(this.skillSearchTimeout);\r\n    }\r\n    \r\n    // If search term is empty, hide results\r\n    if (searchTerm.length === 0) {\r\n      resultsDiv.style.display = 'none';\r\n      return;\r\n    }\r\n    \r\n    // Debounce search\r\n    this.skillSearchTimeout = setTimeout(async () => {\r\n      await this._performSkillSearch(searchTerm, resultsDiv);\r\n    }, 300);\r\n  }\r\n\r\n  /**\r\n   * Perform the actual skill search in compendiums and world items\r\n   */\r\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\r\n    const results: any[] = [];\r\n    \r\n    // Store search term for potential creation\r\n    this.lastSkillSearchTerm = searchTerm;\r\n    \r\n    // Search in world items first\r\n    if (game.items) {\r\n      for (const item of game.items as any) {\r\n        if (item.type === 'skill' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: item.name,\r\n            uuid: item.uuid,\r\n            pack: game.i18n!.localize('SRA2.SPECIALIZATIONS.WORLD_ITEMS'),\r\n            linkedAttribute: item.system.linkedAttribute,\r\n            isWorldItem: true\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Search in all compendiums\r\n    for (const pack of game.packs as any) {\r\n      // Only search in Item compendiums\r\n      if (pack.documentName !== 'Item') continue;\r\n      \r\n      // Get all documents from the pack\r\n      const documents = await pack.getDocuments();\r\n      \r\n      // Filter for skills that match the search term\r\n      for (const doc of documents) {\r\n        if (doc.type === 'skill' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\r\n          results.push({\r\n            name: doc.name,\r\n            uuid: doc.uuid,\r\n            pack: pack.title,\r\n            linkedAttribute: doc.system.linkedAttribute,\r\n            isWorldItem: false\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Display results\r\n    this._displaySkillSearchResults(results, resultsDiv);\r\n  }\r\n\r\n  /**\r\n   * Display skill search results\r\n   */\r\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\r\n    // Check if exact match exists\r\n    const formattedSearchTerm = this.lastSkillSearchTerm\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    const exactMatch = results.find((r: any) => \r\n      ItemSearch.normalizeSearchText(r.name) === ItemSearch.normalizeSearchText(this.lastSkillSearchTerm)\r\n    );\r\n    \r\n    let html = '';\r\n    \r\n    // If no results at all, show only the create button with message\r\n    if (results.length === 0) {\r\n      html = `\r\n        <div class=\"search-result-item no-results-create\">\r\n          <div class=\"no-results-text\">\r\n            ${game.i18n!.localize('SRA2.SPECIALIZATIONS.SEARCH_NO_RESULTS')}\r\n          </div>\r\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSkillSearchTerm}\">\r\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\r\n          </button>\r\n        </div>\r\n      `;\r\n    } else {\r\n      // Display search results\r\n      for (const result of results) {\r\n        const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${result.linkedAttribute.toUpperCase()}`);\r\n        \r\n        html += `\r\n          <div class=\"search-result-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\">${result.name}</span>\r\n              <span class=\"result-pack\">${result.pack} - ${attributeLabel}</span>\r\n            </div>\r\n            <button class=\"link-skill-btn\" data-skill-name=\"${result.name}\">\r\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.LINK_SKILL')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n      \r\n      // Add create button if exact match doesn't exist\r\n      if (!exactMatch) {\r\n        html += `\r\n          <div class=\"search-result-item create-new-item\">\r\n            <div class=\"result-info\">\r\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\r\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_NEW_SKILL')}</span>\r\n            </div>\r\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSkillSearchTerm}\">\r\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\r\n            </button>\r\n          </div>\r\n        `;\r\n      }\r\n    }\r\n    \r\n    resultsDiv.innerHTML = html;\r\n    resultsDiv.style.display = 'block';\r\n    \r\n    // Attach click handlers\r\n    $(resultsDiv).find('.link-skill-btn').on('click', this._onLinkSkillFromSearch.bind(this));\r\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\r\n    \r\n    // Make entire result items clickable (except create button)\r\n    $(resultsDiv).find('.search-result-item:not(.no-results-create):not(.create-new-item)').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.link-skill-btn').length > 0) return;\r\n      \r\n      // Find the button in this item and trigger its click\r\n      const button = $(event.currentTarget).find('.link-skill-btn')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    // Make create items clickable on the entire row\r\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\r\n      // Don't trigger if clicking directly on the button\r\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\r\n      \r\n      // Find the button and trigger its click\r\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\r\n      if (button) {\r\n        $(button).trigger('click');\r\n      }\r\n    });\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle linking a skill from search results\r\n   */\r\n  private async _onLinkSkillFromSearch(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Link the skill to the specialization\r\n    await this.item.update({ 'system.linkedSkill': skillName } as any);\r\n    \r\n    // Clear the search input and hide results\r\n    const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n    if (searchInput) {\r\n      searchInput.value = '';\r\n    }\r\n    \r\n    const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n    if (resultsDiv) {\r\n      resultsDiv.style.display = 'none';\r\n    }\r\n    \r\n    this.render(false);\r\n    ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_LINKED', { name: skillName }));\r\n  }\r\n\r\n  /**\r\n   * Handle skill search focus\r\n   */\r\n  private _onSkillSearchFocus(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    \r\n    // If there's already content and results, show them\r\n    if (input.value.trim().length > 0) {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\r\n        resultsDiv.style.display = 'block';\r\n      }\r\n    }\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle skill search blur\r\n   */\r\n  private _onSkillSearchBlur(event: Event): Promise<void> {\r\n    const input = event.currentTarget as HTMLInputElement;\r\n    const blurEvent = event as FocusEvent;\r\n    \r\n    // Check if the new focus target is within the results div\r\n    setTimeout(() => {\r\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        // Check if the related target (where focus is going) is inside the results div\r\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\r\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\r\n          // Don't hide if focus is moving to an element within the results\r\n          return;\r\n        }\r\n        \r\n        // Also check if any element in the results is focused\r\n        const activeElement = document.activeElement as HTMLElement;\r\n        if (activeElement && resultsDiv.contains(activeElement)) {\r\n          // Don't hide if an element in results is active\r\n          return;\r\n        }\r\n        \r\n        resultsDiv.style.display = 'none';\r\n      }\r\n    }, 200);\r\n    \r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Handle creating a new skill from search and linking it\r\n   */\r\n  private async _onCreateNewSkill(event: Event): Promise<void> {\r\n    event.preventDefault();\r\n    event.stopPropagation();\r\n    \r\n    const button = event.currentTarget as HTMLButtonElement;\r\n    const skillName = button.dataset.skillName;\r\n    \r\n    if (!skillName) return;\r\n    \r\n    // Capitalize first letter of each word\r\n    const formattedName = skillName\r\n      .split(' ')\r\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\r\n      .join(' ');\r\n    \r\n    // Create the new skill as a world item with default values\r\n    const skillData = {\r\n      name: formattedName,\r\n      type: 'skill',\r\n      system: {\r\n        rating: 1,\r\n        linkedAttribute: 'strength',\r\n        description: ''\r\n      }\r\n    } as any;\r\n    \r\n    // Create as a world item\r\n    const createdItems = await Item.create(skillData) as any;\r\n    \r\n    if (createdItems) {\r\n      // Link the skill to the specialization\r\n      await this.item.update({ 'system.linkedSkill': formattedName } as any);\r\n      \r\n      // Clear the search input and hide results\r\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\r\n      if (searchInput) {\r\n        searchInput.value = '';\r\n      }\r\n      \r\n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\r\n      if (resultsDiv) {\r\n        resultsDiv.style.display = 'none';\r\n      }\r\n      \r\n      this.render(false);\r\n      \r\n      // Open the skill sheet for editing\r\n      setTimeout(() => {\r\n        if (createdItems.sheet) {\r\n          createdItems.sheet.render(true);\r\n        }\r\n      }, 100);\r\n      \r\n      ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_CREATED_AND_LINKED', { name: formattedName }));\r\n    }\r\n  }\r\n}\r\n\r\n","/**\r\n * Metatype Sheet Application\r\n */\r\nexport class MetatypeSheet extends ItemSheet {\r\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'sheet', 'item', 'metatype'],\r\n      template: 'systems/sra2/templates/item-metatype-sheet.hbs',\r\n      width: 520,\r\n      height: 580,\r\n      tabs: [],\r\n      submitOnChange: true,\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context = super.getData() as any;\r\n    context.system = this.item.system;\r\n    return context;\r\n  }\r\n\r\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\r\n    const expandedData = foundry.utils.expandObject(formData);\r\n    return this.item.update(expandedData);\r\n  }\r\n}\r\n\r\n","import { RollRequestData } from '../helpers/dice-roller.js';\r\nimport * as DiceRoller from '../helpers/dice-roller.js';\r\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\r\nimport * as ItemSearch from '../../../item-search.js';\r\nimport { WEAPON_TYPES } from '../models/item-feat.js';\r\nimport shadowAmpProbabilities from '../config/shadow-amp-probabilities.json';\r\n\r\n/**\r\n * Roll Dialog Application\r\n * Displays roll information in a popup dialog\r\n */\r\nexport class RollDialog extends Application {\r\n  private rollData: RollRequestData;\r\n  private actor: any = null;\r\n  private attackerToken: any = null;\r\n  private targetToken: any = null;\r\n  private rrEnabled: Map<string, boolean> = new Map(); // Track which RR sources are enabled\r\n  private riskDiceCount: number = 0; // Number of risk dice selected (will be auto-set based on RR)\r\n  private riskDiceManuallySet: boolean = false; // Track if user has manually changed risk dice selection\r\n  private lastAutoRR: number = -1; // Track last RR value used for auto-selection\r\n  private selectedRange: string | null = null; // Selected range: 'melee', 'short', 'medium', 'long'\r\n  private rollMode: 'normal' | 'disadvantage' | 'advantage' = 'normal'; // Roll mode\r\n  private manualRRBonus: string = ''; // Manual RR bonus entered by user\r\n\r\n  constructor(rollData: RollRequestData) {\r\n    super();\r\n    this.rollData = rollData;\r\n    \r\n    // Get actor from roll data\r\n    if (rollData.actorUuid) {\r\n      this.actor = (fromUuidSync as any)(rollData.actorUuid);\r\n    } else if (rollData.actorId) {\r\n      this.actor = game.actors?.get(rollData.actorId) || null;\r\n    }\r\n    \r\n    // Get attacker token (priority: rollData.attackerTokenUuid > canvas search)\r\n    if (rollData.attackerTokenUuid) {\r\n      try {\r\n        this.attackerToken = (foundry.utils as any)?.fromUuidSync?.(rollData.attackerTokenUuid) || null;\r\n        console.log('RollDialog: Attacker token loaded from UUID:', rollData.attackerTokenUuid);\r\n      } catch (e) {\r\n        console.warn('RollDialog: Failed to load attacker token from UUID:', e);\r\n      }\r\n    }\r\n    \r\n    // If no attacker token from UUID, try to find it on canvas\r\n    if (!this.attackerToken && this.actor) {\r\n      this.attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\r\n      }) || null;\r\n      if (this.attackerToken) {\r\n        console.log('RollDialog: Attacker token found on canvas');\r\n      }\r\n    }\r\n    \r\n    // Get target token (first targeted token)\r\n    const targets = Array.from(game.user?.targets || []);\r\n    if (targets.length > 0) {\r\n      this.targetToken = targets[0] || null;\r\n    }\r\n    \r\n    // For vehicle weapons, we should prioritize selected targets over vehicle UUID\r\n    // The defender should be the target, not the vehicle/drone itself\r\n    const isVehicleWeapon = rollData.isVehicleWeapon;\r\n    \r\n    // Also try to get defender token from rollData.defenderTokenUuid if available\r\n    // Priority: selected targets > rollData.defenderTokenUuid (unless no targets selected)\r\n    // For vehicle weapons, always prioritize selected targets to avoid using the drone as defender\r\n    if (!this.targetToken && rollData.defenderTokenUuid) {\r\n      try {\r\n        const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(rollData.defenderTokenUuid) || null;\r\n        if (defenderTokenFromUuid) {\r\n          // For vehicle weapons, skip if this is the vehicle itself (we want the target, not the drone)\r\n          if (isVehicleWeapon && rollData.vehicleUuid) {\r\n            const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || defenderTokenFromUuid?.document?.actorLink ? defenderTokenFromUuid?.actor?.uuid : undefined;\r\n            if (tokenActorUuid === rollData.vehicleUuid) {\r\n              console.log('RollDialog: Skipping vehicle token as defender for vehicle weapon - need target instead');\r\n            } else {\r\n              this.targetToken = defenderTokenFromUuid;\r\n              console.log('RollDialog: Defender token loaded from UUID:', rollData.defenderTokenUuid);\r\n            }\r\n          } else {\r\n            this.targetToken = defenderTokenFromUuid;\r\n            console.log('RollDialog: Defender token loaded from UUID:', rollData.defenderTokenUuid);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.warn('RollDialog: Failed to load defender token from UUID:', e);\r\n      }\r\n    }\r\n    \r\n    // If still no target token, try to find it on canvas based on defender info\r\n    if (!this.targetToken && rollData.defenderTokenUuid) {\r\n      // Try to find on canvas as fallback\r\n      const foundToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.uuid === rollData.defenderTokenUuid || \r\n               token.document?.uuid === rollData.defenderTokenUuid;\r\n      }) || null;\r\n      \r\n      // For vehicle weapons, skip if this is the vehicle itself\r\n      if (foundToken && isVehicleWeapon && rollData.vehicleUuid) {\r\n        const tokenActorUuid = foundToken?.actor?.uuid || undefined;\r\n        if (tokenActorUuid !== rollData.vehicleUuid) {\r\n          this.targetToken = foundToken;\r\n        }\r\n      } else if (foundToken) {\r\n        this.targetToken = foundToken;\r\n      }\r\n    }\r\n    \r\n    // Auto-select best weapon for counter-attack\r\n    if (rollData.isCounterAttack && rollData.availableWeapons && rollData.availableWeapons.length > 0 && this.actor) {\r\n      this.autoSelectWeaponForCounterAttack();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Auto-select the best weapon for counter-attack\r\n   * Priority: 1) Weapon with highest damage value, 2) Combat rapproché skill\r\n   */\r\n  private autoSelectWeaponForCounterAttack(): void {\r\n    if (!this.rollData.availableWeapons || !this.actor) return;\r\n    \r\n    // Find weapon with highest damage value\r\n    let bestWeapon: any = null;\r\n    let highestDamage = -1;\r\n    \r\n    for (const weapon of this.rollData.availableWeapons) {\r\n      const damageValueStr = weapon.damageValue || '0';\r\n      let damageValue = 0;\r\n      \r\n      // Parse damage value (handle FOR, FOR+X, or numeric)\r\n      if (damageValueStr === 'FOR') {\r\n        damageValue = (this.actor.system as any)?.attributes?.strength || 1;\r\n      } else if (damageValueStr.startsWith('FOR+')) {\r\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\r\n        damageValue = ((this.actor.system as any)?.attributes?.strength || 1) + bonus;\r\n      } else {\r\n        damageValue = parseInt(damageValueStr, 10) || 0;\r\n      }\r\n      \r\n      // Add bonus\r\n      damageValue += weapon.damageValueBonus || 0;\r\n      \r\n      if (damageValue > highestDamage) {\r\n        highestDamage = damageValue;\r\n        bestWeapon = weapon;\r\n      }\r\n    }\r\n    \r\n    // If we found a weapon with damage, select it\r\n    if (bestWeapon && highestDamage > 0) {\r\n      this.selectWeaponForCounterAttack(bestWeapon.id);\r\n    } else {\r\n      // Otherwise, select \"Combat rapproché\" skill\r\n      this.selectCombatRapprocheSkill();\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Select a specific weapon for counter-attack\r\n   */\r\n  private selectWeaponForCounterAttack(weaponId: string): void {\r\n    if (!this.rollData.availableWeapons || !this.actor) return;\r\n    \r\n    const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\r\n    if (!selectedWeapon) return;\r\n    \r\n    // Get the actual weapon item\r\n    const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\r\n    const weaponSystem = actualWeapon?.system as any;\r\n    \r\n    // Get weapon type data from WEAPON_TYPES if available\r\n    const wepTypeName = weaponSystem?.weaponType;\r\n    const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\r\n    \r\n    // Get linkedAttackSkill and linkedAttackSpecialization\r\n    let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\r\n    const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\r\n    \r\n    const damageValue = selectedWeapon.damageValue;\r\n    const damageValueBonus = selectedWeapon.damageValueBonus || 0;\r\n    \r\n    // Default to \"Combat rapproché\" if no skill found\r\n    if (!baseSkillName) {\r\n      baseSkillName = 'Combat rapproché';\r\n    }\r\n    \r\n    // Find the linked skill in actor's items\r\n    const linkedSkillItem = this.actor.items.find((item: any) => \r\n      item.type === 'skill' && item.name === baseSkillName\r\n    );\r\n    \r\n    // Find specializations for the linked skill\r\n    const linkedSpecs = this.actor.items.filter((item: any) => \r\n      item.type === 'specialization' && \r\n      item.system.linkedSkill === baseSkillName\r\n    );\r\n    \r\n    // Check if weapon has a specialization and if actor has that specialization\r\n    let preferredSpecName: string | undefined = undefined;\r\n    if (weaponLinkedSpecialization) {\r\n      const specExists = linkedSpecs.find((spec: any) => \r\n        spec.name === weaponLinkedSpecialization\r\n      );\r\n      if (specExists) {\r\n        preferredSpecName = weaponLinkedSpecialization;\r\n      }\r\n    }\r\n    \r\n    // Calculate skill level and linked attribute\r\n    let skillLevel: number | undefined = undefined;\r\n    let specLevel: number | undefined = undefined;\r\n    let linkedAttribute: string | undefined = undefined;\r\n    let skillName: string | undefined = baseSkillName;\r\n    let specName: string | undefined = undefined;\r\n    \r\n    if (linkedSkillItem) {\r\n      const skillSystem = linkedSkillItem.system as any;\r\n      const skillRating = skillSystem.rating || 0;\r\n      linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n      \r\n      skillLevel = attributeValue + skillRating;\r\n    }\r\n    \r\n    // Get RR sources\r\n    let rrList: any[] = [];\r\n    \r\n    // Get RR from weapon itself\r\n    const weaponRRList = weaponSystem?.rrList || [];\r\n    const itemRRList = weaponRRList.map((rrEntry: any) => ({\r\n      ...rrEntry,\r\n      featName: selectedWeapon.name\r\n    }));\r\n    \r\n    let skillSpecRRList: any[] = [];\r\n    \r\n    if (preferredSpecName) {\r\n      // Use specialization\r\n      specName = preferredSpecName;\r\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n      const parentSkill = linkedSkillItem;\r\n      const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n      specLevel = attributeValue + skillRating + 2;\r\n      \r\n      const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\r\n      const skillRRSources = linkedSkillItem ? SheetHelpers.getRRSources(this.actor, 'skill', baseSkillName) : [];\r\n      const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n      \r\n      skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n    } else {\r\n      // Use skill\r\n      if (skillName) {\r\n        const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n        const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n        \r\n        skillSpecRRList = [...skillRRSources, ...attributeRRSources];\r\n      }\r\n    }\r\n    \r\n    // Merge weapon RR with skill/spec/attribute RR\r\n    rrList = [...itemRRList, ...skillSpecRRList];\r\n    \r\n    // Get weapon ranges\r\n    const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\r\n    const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\r\n    const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\r\n    const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\r\n    \r\n    // Update roll data\r\n    this.rollData.skillName = skillName;\r\n    this.rollData.specName = specName;\r\n    this.rollData.linkedAttackSkill = baseSkillName;\r\n    this.rollData.linkedAttribute = linkedAttribute;\r\n    this.rollData.skillLevel = skillLevel;\r\n    this.rollData.specLevel = specLevel;\r\n    this.rollData.itemName = selectedWeapon.name;\r\n    this.rollData.itemType = 'weapon';\r\n    this.rollData.damageValue = damageValue;\r\n    this.rollData.damageValueBonus = damageValueBonus;\r\n    this.rollData.rrList = rrList;\r\n    this.rollData.selectedWeaponId = weaponId;\r\n    this.rollData.meleeRange = meleeRange;\r\n    this.rollData.shortRange = shortRange;\r\n    this.rollData.mediumRange = mediumRange;\r\n    this.rollData.longRange = longRange;\r\n    this.rollData.weaponType = wepTypeName;\r\n  }\r\n  \r\n  /**\r\n   * Select Combat rapproché skill for counter-attack\r\n   */\r\n  private selectCombatRapprocheSkill(): void {\r\n    if (!this.actor) return;\r\n    \r\n    const combatRapprocheSkill = this.actor.items.find((item: any) => \r\n      item.type === 'skill' && item.name === 'Combat rapproché'\r\n    );\r\n    \r\n    if (!combatRapprocheSkill) return;\r\n    \r\n    const skillSystem = combatRapprocheSkill.system as any;\r\n    const skillRating = skillSystem.rating || 0;\r\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n    const attributeValue = (this.actor.system as any)?.attributes?.[linkedAttribute] || 0;\r\n    const skillLevel = attributeValue + skillRating;\r\n    \r\n    // Get RR sources\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', 'Combat rapproché');\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    const rrList = [...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Update roll data\r\n    this.rollData.skillName = 'Combat rapproché';\r\n    this.rollData.specName = undefined;\r\n    this.rollData.linkedAttackSkill = 'Combat rapproché';\r\n    this.rollData.linkedAttribute = linkedAttribute;\r\n    this.rollData.skillLevel = skillLevel;\r\n    this.rollData.specLevel = undefined;\r\n    this.rollData.itemName = undefined;\r\n    this.rollData.itemType = undefined;\r\n    this.rollData.damageValue = 'FOR'; // Bare hands damage\r\n    this.rollData.damageValueBonus = 0;\r\n    this.rollData.rrList = rrList;\r\n    this.rollData.selectedWeaponId = undefined;\r\n  }\r\n\r\n  static override get defaultOptions(): any {\r\n    return foundry.utils.mergeObject(super.defaultOptions, {\r\n      classes: ['sra2', 'roll-dialog'],\r\n      template: 'systems/sra2/templates/roll-dialog.hbs',\r\n      width: 760,\r\n      height: 630,\r\n      resizable: true,\r\n      minimizable: false,\r\n      title: 'Jet de Dés'\r\n    });\r\n  }\r\n\r\n  override getData(): any {\r\n    const context: any = {\r\n      rollData: this.rollData,\r\n      actor: this.actor,\r\n      targetToken: this.targetToken\r\n    };\r\n\r\n    // Calculate distance between protagonist and target\r\n    let distance: number | null = null;\r\n    let distanceText: string = '';\r\n    \r\n    if (this.actor && this.targetToken && canvas?.grid) {\r\n      // Get protagonist token\r\n      const protagonistToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\r\n      });\r\n      \r\n      if (protagonistToken && this.targetToken) {\r\n        try {\r\n          // Calculate distance using Foundry's grid measurement\r\n          const grid = canvas.grid as any;\r\n          const distancePixels = grid.measureDistance(\r\n            { x: protagonistToken.x, y: protagonistToken.y },\r\n            { x: this.targetToken.x, y: this.targetToken.y },\r\n            { gridSpaces: true }\r\n          );\r\n          \r\n          if (typeof distancePixels === 'number' && !isNaN(distancePixels)) {\r\n            distance = Math.round(distancePixels * 10) / 10; // Round to 1 decimal\r\n            \r\n            // Get grid units from scene\r\n            const scene = canvas?.scene;\r\n            const gridUnits = (scene?.grid as any)?.units || 'm';\r\n            distanceText = `${distance} ${gridUnits}`;\r\n          }\r\n        } catch (e) {\r\n          // Fallback: calculate euclidean distance\r\n          const dx = this.targetToken.x - protagonistToken.x;\r\n          const dy = this.targetToken.y - protagonistToken.y;\r\n          const pixelDistance = Math.sqrt(dx * dx + dy * dy);\r\n          const gridSize = (canvas.grid as any)?.size || 1;\r\n          const gridDistance = pixelDistance / gridSize;\r\n          distance = Math.round(gridDistance * 10) / 10;\r\n          \r\n          const scene = canvas?.scene;\r\n          const gridUnits = (scene?.grid as any)?.units || 'm';\r\n          distanceText = `${distance} ${gridUnits}`;\r\n        }\r\n      }\r\n    }\r\n    \r\n    context.distance = distance;\r\n    context.distanceText = distanceText;\r\n\r\n    // Calculate range based on distance for default selection (only if not already selected by user)\r\n    let calculatedRange: string | null = null;\r\n    \r\n    // Calculate what range should be based on distance (for display purposes)\r\n    if (distance !== null) {\r\n      if (distance < 3) {\r\n        calculatedRange = 'melee';\r\n      } else if (distance >= 3 && distance <= 15) {\r\n        calculatedRange = 'short';\r\n      } else if (distance > 15 && distance <= 60) {\r\n        calculatedRange = 'medium';\r\n      } else if (distance > 60) {\r\n        calculatedRange = 'long';\r\n      }\r\n    }\r\n\r\n    // Only set default range if user hasn't selected one yet\r\n    if (this.selectedRange === null) {\r\n      // For counter-attacks, always default to melee range\r\n      if (this.rollData.isCounterAttack) {\r\n        this.selectedRange = 'melee';\r\n      } else if (calculatedRange !== null) {\r\n        // For other cases, use calculated range based on distance\r\n      this.selectedRange = calculatedRange;\r\n    }\r\n    }\r\n    // If selectedRange is already set, don't change it (user selection is preserved)\r\n\r\n    // Get weapon range properties\r\n    const meleeRange = this.rollData.meleeRange || 'none';\r\n    const shortRange = this.rollData.shortRange || 'none';\r\n    const mediumRange = this.rollData.mediumRange || 'none';\r\n    const longRange = this.rollData.longRange || 'none';\r\n\r\n    // Check if this is a weapon roll (has range properties)\r\n    const isWeaponRoll = this.rollData.itemType === 'weapon' || \r\n                         this.rollData.weaponType !== undefined ||\r\n                         (meleeRange !== 'none' || shortRange !== 'none' || mediumRange !== 'none' || longRange !== 'none');\r\n\r\n    // Get range value for selected range\r\n    let selectedRangeValue: string | null = null;\r\n    if (this.selectedRange === 'melee') {\r\n      selectedRangeValue = meleeRange;\r\n    } else if (this.selectedRange === 'short') {\r\n      selectedRangeValue = shortRange;\r\n    } else if (this.selectedRange === 'medium') {\r\n      selectedRangeValue = mediumRange;\r\n    } else if (this.selectedRange === 'long') {\r\n      selectedRangeValue = longRange;\r\n    }\r\n\r\n    // Determine roll mode based on range value (but allow user to override)\r\n    if (selectedRangeValue === 'disadvantage') {\r\n      this.rollMode = 'disadvantage';\r\n    } else if (selectedRangeValue === 'ok') {\r\n      this.rollMode = 'normal';\r\n    }\r\n    // Allow selection even if range is 'none' - user can still roll\r\n\r\n    // Check if actor has severe wound - force disadvantage mode\r\n    let hasSevereWound = false;\r\n    if (this.actor) {\r\n      const actorSystem = this.actor.system as any;\r\n      if (actorSystem.damage && actorSystem.damage.severe) {\r\n        // Check if at least one severe wound is marked (true)\r\n        hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                         actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n      }\r\n    }\r\n    \r\n    // Force disadvantage mode if actor has severe wound\r\n    if (hasSevereWound) {\r\n      this.rollMode = 'disadvantage';\r\n    }\r\n\r\n    context.isWeaponRoll = isWeaponRoll;\r\n    // Check if this is a skill/spec/attribute roll (not a weapon roll and not a defense roll)\r\n    context.isSkillSpecAttributeRoll = !isWeaponRoll && !this.rollData.isDefend && \r\n                                       (this.rollData.skillName || this.rollData.specName || this.rollData.linkedAttribute);\r\n    context.calculatedRange = calculatedRange;\r\n    context.selectedRange = this.selectedRange;\r\n    context.selectedRangeValue = selectedRangeValue;\r\n    context.rollMode = this.rollMode;\r\n    context.hasSevereWound = hasSevereWound; // Pass to template to disable mode selection\r\n    context.rangeOptions = {\r\n      melee: { label: 'Mêlée (< 3m)', value: meleeRange },\r\n      short: { label: 'Portée courte (3-15m)', value: shortRange },\r\n      medium: { label: 'Portée moyenne (15-60m)', value: mediumRange },\r\n      long: { label: 'Portée longue (> 60m)', value: longRange }\r\n    };\r\n\r\n    // Calculate dice pool\r\n    let dicePool = 0;\r\n    if (this.rollData.specLevel !== undefined) {\r\n      dicePool = this.rollData.specLevel;\r\n    } else if (this.rollData.skillLevel !== undefined) {\r\n      dicePool = this.rollData.skillLevel;\r\n    } else if (this.rollData.linkedAttribute) {\r\n      const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n      dicePool = attributeValue;\r\n    }\r\n    \r\n    // Debug: Log dice pool calculation\r\n    console.log('SRA2 | RollDialog - Dice pool calculation:', {\r\n      specLevel: this.rollData.specLevel,\r\n      skillLevel: this.rollData.skillLevel,\r\n      linkedAttribute: this.rollData.linkedAttribute,\r\n      itemRating: this.rollData.itemRating,\r\n      calculatedDicePool: dicePool,\r\n      skillName: this.rollData.skillName,\r\n      specName: this.rollData.specName\r\n    });\r\n    \r\n    context.dicePool = dicePool;\r\n\r\n    let threshold = this.rollData.threshold;\r\n    context.threshold = threshold;\r\n    context.hasThreshold = threshold !== undefined;\r\n\r\n    // Get skill/spec name\r\n    context.skillDisplayName = this.rollData.specName || this.rollData.skillName || this.rollData.linkedAttackSkill || 'Aucune';\r\n\r\n    // Calculate total RR and get RR sources\r\n    // For defense rolls, always recalculate rrList from defender's skill/spec to ensure we use the correct actor\r\n    // For attack rolls, use rollData.rrList as passed from character-sheet (already merged: item RR + skill/spec/attribute RR)\r\n    // rrList already contains RRSource objects with featName and rrValue (enriched before passing to handleRollRequest)\r\n    \r\n    // For defense rolls, always recalculate rrList from this.actor (the defender) to ensure correctness\r\n    if (this.rollData.isDefend && this.actor) {\r\n      const { getRRSources } = SheetHelpers;\r\n      let defenseRRList: any[] = [];\r\n      \r\n      if (this.rollData.specName) {\r\n        const rrSources = getRRSources(this.actor, 'specialization', this.rollData.specName);\r\n        defenseRRList = rrSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n      } else if (this.rollData.skillName) {\r\n        const rrSources = getRRSources(this.actor, 'skill', this.rollData.skillName);\r\n        defenseRRList = rrSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n      }\r\n      \r\n      // Also add attribute RR if linkedAttribute is set\r\n      if (this.rollData.linkedAttribute) {\r\n        const attributeRRSources = getRRSources(this.actor, 'attribute', this.rollData.linkedAttribute);\r\n        const attributeRRList = attributeRRSources.map((rr: any) => ({\r\n          ...rr,\r\n          featName: rr.featName\r\n        }));\r\n        defenseRRList = [...defenseRRList, ...attributeRRList];\r\n      }\r\n      \r\n      // Always update rollData with correct rrList from defender\r\n      this.rollData.rrList = defenseRRList;\r\n    }\r\n    // For attack rolls (not defense), use rollData.rrList as is (already merged in character-sheet.ts)\r\n    // The rrList should already contain: item RR + skill/spec/attribute RR\r\n    // No need to recalculate here, it's already correct from the sheet\r\n    \r\n    let totalRR = 0;\r\n    const rrSources: any[] = [];\r\n    if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n      for (const rrSource of this.rollData.rrList) {\r\n        if (rrSource && typeof rrSource === 'object') {\r\n          const rrValue = rrSource.rrValue || 0;\r\n          if (rrValue > 0) {\r\n            // featName is now always present in rrList (enriched in character-sheet.ts)\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const rrId = `${featName}-${rrValue}`;\r\n            \r\n            // Initialize as enabled if not already set\r\n            if (!this.rrEnabled.has(rrId)) {\r\n              this.rrEnabled.set(rrId, true);\r\n            }\r\n            \r\n            const isEnabled = this.rrEnabled.get(rrId) || false;\r\n            \r\n            rrSources.push({\r\n              id: rrId,\r\n              featName: featName,\r\n              rrValue: rrValue,\r\n              enabled: isEnabled\r\n            });\r\n            \r\n            if (isEnabled) {\r\n              totalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // Add manual RR bonus\r\n    totalRR += this.manualRRBonus;\r\n    context.totalRR = Math.min(3, totalRR); // RR is capped at 3\r\n    context.rrSources = rrSources;\r\n    context.manualRRBonus = this.manualRRBonus; // Pass to template\r\n\r\n    // Auto-select risk dice count based on RR (mode normal: 2, 5, 8, 12 for RR 0, 1, 2, 3)\r\n    // Only auto-update if:\r\n    // 1. User hasn't manually set it, OR\r\n    // 2. RR has changed since last auto-selection (reset manual flag)\r\n    const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(context.totalRR);\r\n    const maxRiskDice = Math.min(autoRiskDiceCount, dicePool);\r\n    \r\n    // If RR changed, reset manual flag to allow auto-update\r\n    if (context.totalRR !== this.lastAutoRR) {\r\n      this.riskDiceManuallySet = false;\r\n      this.lastAutoRR = context.totalRR;\r\n    }\r\n    \r\n    // Auto-update only if not manually set\r\n    if (!this.riskDiceManuallySet) {\r\n      this.riskDiceCount = maxRiskDice;\r\n    }\r\n\r\n    // Get VD (Valeur de Défense) - this would be from the target or weapon\r\n    // For now, we'll show weapon VD if available\r\n    context.vd = this.rollData.damageValue || 0;\r\n\r\n    // Calculate risk probabilities based on risk dice count and RR\r\n    const getRiskProbabilities = (riskDice: number, rr: number): any => {\r\n      // If no risk dice, return 100% all good\r\n      if (riskDice <= 0) {\r\n        return {\r\n          allGood: 100.0,\r\n          glitch: 0.0,\r\n          criticalGlitch: 0.0,\r\n          disaster: 0.0\r\n        };\r\n      }\r\n      \r\n      // Clamp values to valid ranges\r\n      const clampedRiskDice = Math.max(1, Math.min(16, riskDice));\r\n      const clampedRR = Math.max(0, Math.min(3, rr));\r\n      \r\n      // Get the condition data for the current RR level\r\n      const probabilitiesData = (shadowAmpProbabilities as any)?.shadowAmpProbabilities || (shadowAmpProbabilities as any);\r\n      const condition = probabilitiesData?.conditions?.find(\r\n        (c: any) => c.id === clampedRR\r\n      );\r\n      \r\n      if (!condition) {\r\n        // Fallback to default values if condition not found\r\n        return {\r\n          allGood: 0,\r\n          glitch: 0,\r\n          criticalGlitch: 0,\r\n          disaster: 0\r\n        };\r\n      }\r\n      \r\n      // Find the data entry for the current dice count\r\n      const diceData = condition.data.find((d: any) => d.dice === clampedRiskDice);\r\n      \r\n      if (!diceData) {\r\n        // If exact match not found, use the closest (shouldn't happen with our data)\r\n        return {\r\n          allGood: 0,\r\n          glitch: 0,\r\n          criticalGlitch: 0,\r\n          disaster: 0\r\n        };\r\n      }\r\n      \r\n      return {\r\n        allGood: diceData.allGood,\r\n        glitch: diceData.glitch,\r\n        criticalGlitch: diceData.criticalGlitch,\r\n        disaster: diceData.disaster\r\n      };\r\n    };\r\n    \r\n    // Calculate probabilities (always calculate, even if no risk dice)\r\n    const riskProbabilities = getRiskProbabilities(this.riskDiceCount, context.totalRR);\r\n    \r\n    // Determine risk level based on Critical Glitch and Disaster probabilities\r\n    // Low to no risk: <2% Critical glitch & < 0.2% Disaster\r\n    // Normal risk: <7.5% Critical glitch & <1% Disaster\r\n    // High risk: <20% Critical glitch & <5% Disaster\r\n    // Extreme risk: >20% Critical glitch or >5% Disaster\r\n    const criticalGlitch = riskProbabilities.criticalGlitch;\r\n    const disaster = riskProbabilities.disaster;\r\n    \r\n    // Same color for all 4 percentages based on the risk level\r\n    let riskColorClass = 'probability-extreme'; // Default to extreme risk\r\n    let riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME';\r\n    if (criticalGlitch < 2 && disaster < 0.2) {\r\n      riskColorClass = 'probability-low';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.LOW_TO_NO';\r\n    } else if (criticalGlitch < 7.5 && disaster < 1) {\r\n      riskColorClass = 'probability-normal';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.NORMAL';\r\n    } else if (criticalGlitch < 20 && disaster < 5) {\r\n      riskColorClass = 'probability-high';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.HIGH';\r\n    } else {\r\n      riskColorClass = 'probability-extreme';\r\n      riskLevelTextKey = 'SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME';\r\n    }\r\n    const riskLevelText = game.i18n?.localize(riskLevelTextKey) || riskLevelTextKey;\r\n    \r\n    // Format probabilities with comma as decimal separator\r\n    context.riskProbabilities = {\r\n      allGood: riskProbabilities.allGood.toFixed(1).replace('.', ','),\r\n      allGoodColorClass: riskColorClass,\r\n      glitch: riskProbabilities.glitch.toFixed(1).replace('.', ','),\r\n      glitchColorClass: riskColorClass,\r\n      criticalGlitch: riskProbabilities.criticalGlitch.toFixed(1).replace('.', ','),\r\n      criticalGlitchColorClass: riskColorClass,\r\n      disaster: riskProbabilities.disaster.toFixed(1).replace('.', ','),\r\n      disasterColorClass: riskColorClass\r\n    };\r\n\r\n    // Generate dice list with risk color based on risk level\r\n    // Map risk color class to dice color name\r\n    const getDiceColorFromRiskClass = (riskClass: string): string => {\r\n      switch (riskClass) {\r\n        case 'probability-low':\r\n          return 'green';\r\n        case 'probability-normal':\r\n          return 'blue';\r\n        case 'probability-high':\r\n          return 'yellow';\r\n        case 'probability-extreme':\r\n          return 'red';\r\n        default:\r\n          return 'green';\r\n      }\r\n    };\r\n    \r\n    const diceColor = getDiceColorFromRiskClass(riskColorClass);\r\n    context.diceList = [];\r\n    context.riskDiceCount = this.riskDiceCount;\r\n    context.riskLevelText = riskLevelText;\r\n    context.riskColorClass = riskColorClass;\r\n    \r\n    for (let i = 0; i < dicePool; i++) {\r\n      context.diceList.push({ \r\n        index: i,\r\n        isRiskDice: i < this.riskDiceCount,  // First N dice are risk dice\r\n        riskColor: diceColor  // Color based on risk level\r\n      });\r\n    }\r\n\r\n    // Get all skills and specializations from actor, organized hierarchically\r\n    if (this.actor) {\r\n      const skills = this.actor.items\r\n        .filter((item: any) => item.type === 'skill')\r\n        .map((skill: any) => {\r\n          const linkedAttribute = skill.system?.linkedAttribute || 'strength';\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\r\n          const skillRating = skill.system?.rating || 0;\r\n          return {\r\n            id: skill.id,\r\n            name: skill.name,\r\n            rating: skillRating,\r\n            linkedAttribute: linkedAttribute,\r\n            dicePool: attributeValue + skillRating,\r\n            type: 'skill',\r\n            specializations: [] as any[]\r\n          };\r\n        })\r\n        .sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n\r\n      // Get all specializations and group them under their parent skills\r\n      const allSpecializations = this.actor.items\r\n        .filter((item: any) => item.type === 'specialization')\r\n        .map((spec: any) => {\r\n          const linkedAttribute = spec.system?.linkedAttribute || 'strength';\r\n          const linkedSkillName = spec.system?.linkedSkill;\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\r\n          \r\n          // Find parent skill\r\n          const parentSkill = this.actor!.items.find((i: any) => \r\n            i.type === 'skill' && i.name === linkedSkillName\r\n          );\r\n          const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n          const effectiveRating = skillRating + 2; // +2 from specialization\r\n          \r\n          return {\r\n            id: spec.id,\r\n            name: spec.name,\r\n            rating: effectiveRating,\r\n            linkedAttribute: linkedAttribute,\r\n            dicePool: attributeValue + effectiveRating,\r\n            type: 'specialization',\r\n            linkedSkillName: linkedSkillName\r\n          };\r\n        });\r\n\r\n      // Group specializations under their parent skills\r\n      for (const spec of allSpecializations) {\r\n        const parentSkill = skills.find((s: any) => s.name === spec.linkedSkillName);\r\n        if (parentSkill) {\r\n          parentSkill.specializations.push(spec);\r\n        }\r\n      }\r\n\r\n      // Sort specializations within each skill\r\n      for (const skill of skills) {\r\n        skill.specializations.sort((a: any, b: any) => a.name.localeCompare(b.name));\r\n      }\r\n\r\n      // Create flat list for dropdown (skill first, then its specializations)\r\n      const dropdownOptions: any[] = [];\r\n      for (const skill of skills) {\r\n        // Add skill option\r\n        // Use normalized comparison for linkedAttackSkill to handle case/space differences\r\n        const skillSelected = skill.name === this.rollData.skillName || \r\n                             (this.rollData.linkedAttackSkill && \r\n                              ItemSearch.normalizeSearchText(skill.name) === ItemSearch.normalizeSearchText(this.rollData.linkedAttackSkill));\r\n        dropdownOptions.push({\r\n          value: `skill:${skill.id}`,\r\n          label: `${skill.name} (${skill.dicePool} dés)`,\r\n          type: 'skill',\r\n          id: skill.id,\r\n          name: skill.name,\r\n          dicePool: skill.dicePool,\r\n          linkedAttribute: skill.linkedAttribute,\r\n          rating: skill.rating,\r\n          isSelected: skillSelected && !this.rollData.specName\r\n        });\r\n\r\n        // Add specializations under this skill\r\n        for (const spec of skill.specializations) {\r\n          // Use normalized comparison for linkedAttackSpecialization to handle case/space differences\r\n          const specSelected = spec.name === this.rollData.specName ||\r\n                              (this.rollData.linkedAttackSpecialization && \r\n                               ItemSearch.normalizeSearchText(spec.name) === ItemSearch.normalizeSearchText(this.rollData.linkedAttackSpecialization));\r\n          dropdownOptions.push({\r\n            value: `spec:${spec.id}`,\r\n            label: `  └ ${spec.name} (${spec.dicePool} dés)`,\r\n            type: 'specialization',\r\n            id: spec.id,\r\n            name: spec.name,\r\n            dicePool: spec.dicePool,\r\n            linkedAttribute: spec.linkedAttribute,\r\n            linkedSkillName: spec.linkedSkillName,\r\n            rating: spec.rating,\r\n            isSelected: specSelected\r\n          });\r\n        }\r\n      }\r\n\r\n      context.skillsWithSpecs = skills;\r\n      context.dropdownOptions = dropdownOptions;\r\n      \r\n      // Determine selected value for dropdown\r\n      // Priority: specName > skillName > linkedAttackSpecialization > linkedAttackSkill\r\n      // This ensures that if skillName is set but spec is not found, we still select the skill\r\n      if (this.rollData.specName) {\r\n        const selectedSpec = dropdownOptions.find((opt: any) => opt.type === 'specialization' && opt.name === this.rollData.specName);\r\n        context.selectedValue = selectedSpec ? selectedSpec.value : '';\r\n      } else if (this.rollData.skillName) {\r\n        // If skillName is set but no specName, prioritize skill selection\r\n        const selectedSkill = dropdownOptions.find((opt: any) => opt.type === 'skill' && opt.name === this.rollData.skillName);\r\n        context.selectedValue = selectedSkill ? selectedSkill.value : '';\r\n      } else if (this.rollData.linkedAttackSpecialization) {\r\n        // Fallback: try to find by linkedAttackSpecialization using normalized comparison\r\n        const normalizedLinkedSpec = ItemSearch.normalizeSearchText(this.rollData.linkedAttackSpecialization);\r\n        const selectedSpec = dropdownOptions.find((opt: any) => \r\n          opt.type === 'specialization' && \r\n          ItemSearch.normalizeSearchText(opt.name) === normalizedLinkedSpec\r\n        );\r\n        context.selectedValue = selectedSpec ? selectedSpec.value : '';\r\n      } else if (this.rollData.linkedAttackSkill) {\r\n        // Fallback: try to find by linkedAttackSkill using normalized comparison\r\n        const normalizedLinkedSkill = ItemSearch.normalizeSearchText(this.rollData.linkedAttackSkill);\r\n        const selectedSkill = dropdownOptions.find((opt: any) => \r\n          opt.type === 'skill' && \r\n          ItemSearch.normalizeSearchText(opt.name) === normalizedLinkedSkill\r\n        );\r\n        context.selectedValue = selectedSkill ? selectedSkill.value : '';\r\n      } else {\r\n        context.selectedValue = '';\r\n      }\r\n    }\r\n\r\n    // Generate attribute options for attribute dropdown\r\n    const attributeOptions: any[] = [];\r\n    if (this.actor) {\r\n      const actorSystem = this.actor.system as any;\r\n      const attributes = actorSystem?.attributes || {};\r\n      \r\n      const attributeNames = ['strength', 'agility', 'willpower', 'logic', 'charisma'];\r\n      const attributeLabels: Record<string, string> = {\r\n        strength: game.i18n?.localize('SRA2.ATTRIBUTES.STRENGTH') || 'Force',\r\n        agility: game.i18n?.localize('SRA2.ATTRIBUTES.AGILITY') || 'Agilité',\r\n        willpower: game.i18n?.localize('SRA2.ATTRIBUTES.WILLPOWER') || 'Volonté',\r\n        logic: game.i18n?.localize('SRA2.ATTRIBUTES.LOGIC') || 'Logique',\r\n        charisma: game.i18n?.localize('SRA2.ATTRIBUTES.CHARISMA') || 'Charisme'\r\n      };\r\n      \r\n      for (const attrName of attributeNames) {\r\n        const attrValue = attributes[attrName] || 0;\r\n        attributeOptions.push({\r\n          value: attrName,\r\n          label: attributeLabels[attrName] || attrName,\r\n          diceValue: attrValue\r\n        });\r\n      }\r\n    }\r\n    \r\n    context.attributeOptions = attributeOptions;\r\n    \r\n    // Determine selected attribute: use linkedAttribute from rollData if set,\r\n    // otherwise try to get it from the selected skill/spec, otherwise default based on skill presence\r\n    let selectedAttribute = this.rollData.linkedAttribute;\r\n    let hasSkillRating = false;\r\n    \r\n    if (!selectedAttribute && this.actor) {\r\n      // Try to get from selected spec\r\n      if (this.rollData.specName) {\r\n        const specItem = this.actor.items.find((i: any) => \r\n          i.type === 'specialization' && i.name === this.rollData.specName\r\n        );\r\n        if (specItem) {\r\n          selectedAttribute = (specItem.system as any)?.linkedAttribute;\r\n          // Check if spec has a rating > 0 (parent skill rating)\r\n          const parentSkillName = (specItem.system as any)?.linkedSkill;\r\n          if (parentSkillName) {\r\n            const parentSkillItem = this.actor.items.find((i: any) => \r\n              i.type === 'skill' && i.name === parentSkillName\r\n            );\r\n            if (parentSkillItem) {\r\n              const skillRating = (parentSkillItem.system as any)?.rating || 0;\r\n              hasSkillRating = skillRating > 0;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Try to get from selected skill\r\n      if (!selectedAttribute && this.rollData.skillName) {\r\n        const skillItem = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === this.rollData.skillName\r\n        );\r\n        if (skillItem) {\r\n          selectedAttribute = (skillItem.system as any)?.linkedAttribute;\r\n          // Check if skill has a rating > 0\r\n          const skillRating = (skillItem.system as any)?.rating || 0;\r\n          hasSkillRating = skillRating > 0;\r\n        } else {\r\n          // Skill not found - person doesn't have the skill\r\n          hasSkillRating = false;\r\n        }\r\n      } else if (!this.rollData.skillName && !this.rollData.specName) {\r\n        // No skill or spec selected - person doesn't have the skill\r\n        hasSkillRating = false;\r\n      }\r\n      \r\n      // If still not set and person doesn't have the skill rating, use default attribute logic\r\n      if (!selectedAttribute && !hasSkillRating) {\r\n        // Person doesn't have the skill - use default attribute based on skill type\r\n        const linkedAttackSkill = this.rollData.linkedAttackSkill || this.rollData.skillName;\r\n        \r\n        // If skill is \"Combat rapproché\", default to Strength\r\n        // Otherwise default to Agility\r\n        if (linkedAttackSkill && ItemSearch.normalizeSearchText(linkedAttackSkill) === ItemSearch.normalizeSearchText('Combat rapproché')) {\r\n          selectedAttribute = 'strength';\r\n        } else {\r\n          selectedAttribute = 'agility';\r\n        }\r\n      } else if (!selectedAttribute && attributeOptions.length > 0) {\r\n        // Has skill but no linked attribute found, default to first attribute\r\n        selectedAttribute = attributeOptions[0].value;\r\n      }\r\n    }\r\n    \r\n    context.selectedAttribute = selectedAttribute || '';\r\n\r\n    return context;\r\n  }\r\n\r\n  override activateListeners(html: JQuery): void {\r\n    super.activateListeners(html);\r\n    \r\n    // Close button\r\n    html.find('.close-button').on('click', () => {\r\n      this.close();\r\n    });\r\n\r\n    // Weapon selection for counter-attack\r\n    html.find('.weapon-select').on('change', async (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const weaponId = select.value;\r\n      \r\n      if (!weaponId || !this.rollData.availableWeapons || !this.actor) return;\r\n      \r\n      const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\r\n      if (!selectedWeapon) return;\r\n\r\n      // Get the actual weapon item to check its linkedAttackSkill and linkedAttackSpecialization\r\n      const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\r\n      const weaponSystem = actualWeapon?.system as any;\r\n      \r\n      // Get weapon type data from WEAPON_TYPES if available\r\n      const wepTypeName = weaponSystem?.weaponType;\r\n      const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\r\n      \r\n      // Get linkedAttackSkill and linkedAttackSpecialization from weapon, fallback to weapon type\r\n      let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\r\n      const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\r\n      \r\n      const damageValue = selectedWeapon.damageValue;\r\n      const damageValueBonus = selectedWeapon.damageValueBonus || 0;\r\n\r\n      // Default to \"Combat rapproché\" if no skill found\r\n      if (!baseSkillName) {\r\n        baseSkillName = 'Combat rapproché';\r\n      }\r\n\r\n      // Find the linked skill in actor's items\r\n      const linkedSkillItem = this.actor.items.find((item: any) => \r\n        item.type === 'skill' && item.name === baseSkillName\r\n      );\r\n\r\n      // Find specializations for the linked skill\r\n      const linkedSpecs = this.actor.items.filter((item: any) => \r\n        item.type === 'specialization' && \r\n        item.system.linkedSkill === baseSkillName\r\n      );\r\n      \r\n      // Check if weapon has a specialization and if actor has that specialization\r\n      let preferredSpecName: string | undefined = undefined;\r\n      if (weaponLinkedSpecialization) {\r\n        const specExists = linkedSpecs.find((spec: any) => \r\n          spec.name === weaponLinkedSpecialization\r\n        );\r\n        if (specExists) {\r\n          preferredSpecName = weaponLinkedSpecialization;\r\n        }\r\n      }\r\n\r\n      // Calculate skill level and linked attribute\r\n      let skillLevel: number | undefined = undefined;\r\n      let specLevel: number | undefined = undefined;\r\n      let linkedAttribute: string | undefined = undefined;\r\n      let skillName: string | undefined = baseSkillName;\r\n      let specName: string | undefined = undefined;\r\n\r\n      if (linkedSkillItem) {\r\n        const skillSystem = linkedSkillItem.system as any;\r\n        const skillRating = skillSystem.rating || 0;\r\n        linkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n        \r\n        skillLevel = attributeValue + skillRating;\r\n      }\r\n\r\n      // Get RR sources (weapon RR + skill/spec/attribute RR)\r\n      const { getRRSources } = await import('../helpers/sheet-helpers.js');\r\n      \r\n      // Get RR from weapon itself\r\n      const weaponRRList = weaponSystem?.rrList || [];\r\n      const itemRRList = weaponRRList.map((rrEntry: any) => ({\r\n        ...rrEntry,\r\n        featName: selectedWeapon.name\r\n      }));\r\n      \r\n      let skillSpecRRList: any[] = [];\r\n      \r\n      // Simple logic: if weapon has a specialization and actor has it, use it\r\n      // Otherwise, use the skill\r\n      if (preferredSpecName) {\r\n        // Weapon has a specialization and actor has it - use the specialization\r\n        specName = preferredSpecName;\r\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\r\n        const parentSkill = linkedSkillItem;\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        specLevel = attributeValue + skillRating + 2;\r\n        \r\n        const specRRSources = getRRSources(this.actor, 'specialization', specName);\r\n        const skillRRSources = linkedSkillItem ? getRRSources(this.actor, 'skill', baseSkillName) : [];\r\n        const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n        \r\n        skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n      } else {\r\n        // Use skill (no specialization or actor doesn't have the specialization)\r\n        if (skillName) {\r\n          const skillRRSources = getRRSources(this.actor, 'skill', skillName);\r\n          const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\r\n          \r\n          skillSpecRRList = [...skillRRSources, ...attributeRRSources];\r\n        }\r\n      }\r\n      \r\n      // Merge weapon RR with skill/spec/attribute RR\r\n      const rrList = [...itemRRList, ...skillSpecRRList];\r\n\r\n      // Get weapon ranges from selected weapon or weapon type\r\n      // Use the same wepTypeName and wepTypeData from above\r\n      const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\r\n      const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\r\n      const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\r\n      const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\r\n      \r\n      // Update roll data with weapon information\r\n      this.rollData.skillName = skillName;\r\n      this.rollData.specName = specName;\r\n      this.rollData.linkedAttackSkill = baseSkillName;\r\n      this.rollData.linkedAttribute = linkedAttribute;\r\n      this.rollData.skillLevel = skillLevel;\r\n      this.rollData.specLevel = specLevel;\r\n      this.rollData.itemName = selectedWeapon.name;\r\n      this.rollData.itemType = 'weapon';\r\n      this.rollData.damageValue = damageValue;\r\n      this.rollData.damageValueBonus = damageValueBonus;\r\n      this.rollData.rrList = rrList;\r\n      this.rollData.selectedWeaponId = weaponId; // Store selected weapon ID for template\r\n      \r\n      // Update weapon ranges\r\n      this.rollData.meleeRange = meleeRange;\r\n      this.rollData.shortRange = shortRange;\r\n      this.rollData.mediumRange = mediumRange;\r\n      this.rollData.longRange = longRange;\r\n      this.rollData.weaponType = wepTypeName;\r\n\r\n      // Re-render to update the UI\r\n      this.render();\r\n    });\r\n\r\n    // Skill/Spec selection dropdown (only if no threshold)\r\n    html.find('.skill-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      \r\n      // Don't allow changes if threshold is set\r\n      if (this.rollData.threshold !== undefined) {\r\n        return;\r\n      }\r\n      \r\n      const value = select.value;\r\n      \r\n      if (!value || !this.actor) return;\r\n\r\n      const [type, id] = value.split(':');\r\n      if (!type || !id) return;\r\n\r\n      const item = this.actor.items.get(id);\r\n      if (!item) return;\r\n\r\n      if (type === 'skill') {\r\n        const skillSystem = item.system as any;\r\n        // Use selected attribute if available, otherwise use skill's linked attribute\r\n        const selectedAttribute = this.rollData.linkedAttribute || skillSystem.linkedAttribute || 'strength';\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const skillRating = skillSystem.rating || 0;\r\n        const dicePool = attributeValue + skillRating;\r\n        \r\n        // Update roll data\r\n        this.rollData.skillName = item.name;\r\n        this.rollData.specName = undefined;\r\n        this.rollData.skillLevel = dicePool;\r\n        this.rollData.specLevel = undefined;\r\n        this.rollData.linkedAttribute = selectedAttribute;\r\n        \r\n        // Recalculate RR and threshold (synchronously)\r\n        this.updateRRForSkill(item.name, selectedAttribute, dicePool);\r\n        \r\n        // Re-render after RR is updated\r\n        this.render();\r\n      } else if (type === 'spec') {\r\n        const specSystem = item.system as any;\r\n        // Use selected attribute if available, otherwise use spec's linked attribute\r\n        const selectedAttribute = this.rollData.linkedAttribute || specSystem.linkedAttribute || 'strength';\r\n        const linkedSkillName = specSystem.linkedSkill;\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        \r\n        // Find parent skill\r\n        const parentSkill = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === linkedSkillName\r\n        );\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        const effectiveRating = skillRating + 2;\r\n        const dicePool = attributeValue + effectiveRating;\r\n        \r\n        // Update roll data\r\n        this.rollData.specName = item.name;\r\n        this.rollData.skillName = linkedSkillName;\r\n        this.rollData.skillLevel = skillRating;\r\n        this.rollData.specLevel = dicePool;\r\n        this.rollData.linkedAttribute = selectedAttribute;\r\n        \r\n        // Recalculate RR and threshold (synchronously)\r\n        this.updateRRForSpec(item.name, linkedSkillName, selectedAttribute, dicePool);\r\n        \r\n        // Re-render after RR is updated\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Attribute selection dropdown\r\n    html.find('.attribute-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const selectedAttribute = select.value;\r\n      \r\n      if (!selectedAttribute || !this.actor) return;\r\n      \r\n      // Update linked attribute\r\n      this.rollData.linkedAttribute = selectedAttribute;\r\n      \r\n      // Recalculate dice pool based on current skill/spec and new attribute\r\n      if (this.rollData.specName && this.rollData.skillName) {\r\n        // Update spec level with new attribute\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const linkedSkillName = this.rollData.skillName;\r\n        const parentSkill = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === linkedSkillName\r\n        );\r\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\r\n        const effectiveRating = skillRating + 2;\r\n        const dicePool = attributeValue + effectiveRating;\r\n        \r\n        this.rollData.specLevel = dicePool;\r\n        this.rollData.skillLevel = skillRating;\r\n        \r\n        // Recalculate RR\r\n        this.updateRRForSpec(this.rollData.specName, linkedSkillName, selectedAttribute, dicePool);\r\n      } else if (this.rollData.skillName) {\r\n        // Update skill level with new attribute\r\n        const attributeValue = (this.actor.system as any).attributes?.[selectedAttribute] || 0;\r\n        const skillItem = this.actor.items.find((i: any) => \r\n          i.type === 'skill' && i.name === this.rollData.skillName\r\n        );\r\n        const skillRating = skillItem ? (skillItem.system as any).rating || 0 : 0;\r\n        const dicePool = attributeValue + skillRating;\r\n        \r\n        this.rollData.skillLevel = dicePool;\r\n        this.rollData.specLevel = undefined;\r\n        \r\n        // Recalculate RR\r\n        this.updateRRForSkill(this.rollData.skillName, selectedAttribute, dicePool);\r\n      } else {\r\n        // Pure attribute roll (no skill/spec)\r\n        this.rollData.skillLevel = undefined;\r\n        this.rollData.specLevel = undefined;\r\n        \r\n        // Recalculate RR for attribute only\r\n        const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', selectedAttribute);\r\n        this.rollData.rrList = attributeRRSources;\r\n        \r\n        // Reset RR enabled state\r\n        this.rrEnabled.clear();\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            if (rrValue > 0) {\r\n              const rrId = `${featName}-${rrValue}`;\r\n              this.rrEnabled.set(rrId, true);\r\n            }\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Re-render to update UI\r\n      this.render();\r\n    });\r\n\r\n    // RR checkbox toggles\r\n    html.find('.rr-checkbox').on('change', (event) => {\r\n      const checkbox = event.currentTarget as HTMLInputElement;\r\n      const rrId = checkbox.dataset.rrId;\r\n      const enabled = checkbox.checked;\r\n      \r\n      if (rrId) {\r\n        this.rrEnabled.set(rrId, enabled);\r\n        \r\n        // Calculate new total RR\r\n        let newTotalRR = 0;\r\n        if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n          for (const rrSource of this.rollData.rrList) {\r\n            if (rrSource && typeof rrSource === 'object') {\r\n              const rrValue = rrSource.rrValue || 0;\r\n              const featName = rrSource.featName || 'Inconnu';\r\n              const sourceId = `${featName}-${rrValue}`;\r\n              \r\n              if (this.rrEnabled.get(sourceId)) {\r\n                newTotalRR += rrValue;\r\n              }\r\n            }\r\n          }\r\n        }\r\n        // Add manual RR bonus\r\n        newTotalRR += this.manualRRBonus;\r\n        newTotalRR = Math.min(3, newTotalRR); // RR is capped at 3\r\n        \r\n        // Update risk dice count based on new RR (mode normal)\r\n        // Only auto-update if user hasn't manually changed it\r\n        if (!this.riskDiceManuallySet) {\r\n          const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(newTotalRR);\r\n          // Calculate dice pool\r\n          let dicePool = 0;\r\n          if (this.rollData.specLevel !== undefined) {\r\n            dicePool = this.rollData.specLevel;\r\n          } else if (this.rollData.skillLevel !== undefined) {\r\n            dicePool = this.rollData.skillLevel;\r\n          } else if (this.rollData.linkedAttribute) {\r\n            const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n            dicePool = attributeValue;\r\n          }\r\n          // Don't exceed dice pool\r\n          this.riskDiceCount = Math.min(autoRiskDiceCount, dicePool);\r\n          this.lastAutoRR = newTotalRR;\r\n        }\r\n        \r\n        // Re-render to update total RR and risk dice selection\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Range selection\r\n    html.find('.range-dropdown').on('change', (event) => {\r\n      const select = event.currentTarget as HTMLSelectElement;\r\n      const rangeValue = select.value;\r\n      \r\n      this.selectedRange = rangeValue || null;\r\n      \r\n      // Update roll mode based on range value\r\n      if (this.selectedRange) {\r\n        const meleeRange = this.rollData.meleeRange || 'none';\r\n        const shortRange = this.rollData.shortRange || 'none';\r\n        const mediumRange = this.rollData.mediumRange || 'none';\r\n        const longRange = this.rollData.longRange || 'none';\r\n        \r\n        let rangeValueForSelected: string = 'none';\r\n        if (this.selectedRange === 'melee') {\r\n          rangeValueForSelected = meleeRange;\r\n        } else if (this.selectedRange === 'short') {\r\n          rangeValueForSelected = shortRange;\r\n        } else if (this.selectedRange === 'medium') {\r\n          rangeValueForSelected = mediumRange;\r\n        } else if (this.selectedRange === 'long') {\r\n          rangeValueForSelected = longRange;\r\n        }\r\n        \r\n        // Check if actor has severe wound - if so, always force disadvantage\r\n        let hasSevereWound = false;\r\n        if (this.actor) {\r\n          const actorSystem = this.actor.system as any;\r\n          if (actorSystem.damage && actorSystem.damage.severe) {\r\n            hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                             actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n          }\r\n        }\r\n        \r\n        // Auto-set roll mode based on range value (can be overridden by user)\r\n        // But if actor has severe wound, always force disadvantage\r\n        if (hasSevereWound) {\r\n          this.rollMode = 'disadvantage';\r\n        } else {\r\n          if (rangeValueForSelected === 'disadvantage') {\r\n            this.rollMode = 'disadvantage';\r\n          } else if (rangeValueForSelected === 'ok') {\r\n            this.rollMode = 'normal';\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Re-render to update UI\r\n      this.render();\r\n    });\r\n\r\n    // Roll mode selection\r\n    html.find('input[name=\"roll-mode\"]').on('change', (event) => {\r\n      // Check if actor has severe wound - prevent changing mode\r\n      let hasSevereWound = false;\r\n      if (this.actor) {\r\n        const actorSystem = this.actor.system as any;\r\n        if (actorSystem.damage && actorSystem.damage.severe) {\r\n          hasSevereWound = Array.isArray(actorSystem.damage.severe) && \r\n                           actorSystem.damage.severe.some((wound: boolean) => wound === true);\r\n        }\r\n      }\r\n      \r\n      // If actor has severe wound, force disadvantage and prevent change\r\n      if (hasSevereWound) {\r\n        this.rollMode = 'disadvantage';\r\n        // Re-render to reset the selection\r\n        this.render();\r\n        return;\r\n      }\r\n      \r\n      const radio = event.currentTarget as HTMLInputElement;\r\n      const modeValue = radio.value;\r\n      \r\n      if (modeValue === 'normal' || modeValue === 'disadvantage' || modeValue === 'advantage') {\r\n        this.rollMode = modeValue as 'normal' | 'disadvantage' | 'advantage';\r\n      }\r\n    });\r\n\r\n    // Manual RR bonus input\r\n    html.find('.manual-rr-bonus-input').on('input', (event) => {\r\n      const input = event.currentTarget as HTMLInputElement;\r\n      const inputValue = input.value;\r\n      this.manualRRBonus = inputValue;\r\n      let manualRRBonus = 0;\r\n      if (inputValue !== '' && !isNaN(Number(inputValue))) {\r\n        manualRRBonus = parseInt(inputValue);\r\n      }\r\n      \r\n      // Calculate new total RR\r\n      let newTotalRR = 0;\r\n      if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const sourceId = `${featName}-${rrValue}`;\r\n            \r\n            if (this.rrEnabled.get(sourceId)) {\r\n              newTotalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add manual RR bonus\r\n      newTotalRR += manualRRBonus;\r\n      newTotalRR = Math.min(3, newTotalRR); // RR is capped at 3\r\n      \r\n      // Update risk dice count based on new RR (mode normal)\r\n      // Only auto-update if user hasn't manually changed it\r\n      if (!this.riskDiceManuallySet) {\r\n        const autoRiskDiceCount = DiceRoller.getRiskDiceByRR(newTotalRR);\r\n        // Calculate dice pool\r\n        let dicePool = 0;\r\n        if (this.rollData.specLevel !== undefined) {\r\n          dicePool = this.rollData.specLevel;\r\n        } else if (this.rollData.skillLevel !== undefined) {\r\n          dicePool = this.rollData.skillLevel;\r\n        } else if (this.rollData.linkedAttribute) {\r\n          const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n          dicePool = attributeValue;\r\n        }\r\n        // Don't exceed dice pool\r\n        this.riskDiceCount = Math.min(autoRiskDiceCount, dicePool);\r\n        this.lastAutoRR = newTotalRR;\r\n      }\r\n      \r\n      // Re-render to update total RR and risk dice selection\r\n      if (manualRRBonus !== 0) {\r\n        this.render();\r\n      }\r\n    });\r\n\r\n    // Risk dice selection\r\n    html.find('.dice-icon').on('click', (event) => {\r\n      const diceIcon = $(event.currentTarget);\r\n      const diceIndex = parseInt(diceIcon.data('dice-index') || '0');\r\n      const isCurrentlySelected = diceIcon.hasClass('risk-dice');\r\n      \r\n      // Mark as manually set when user clicks\r\n      this.riskDiceManuallySet = true;\r\n      \r\n      // If clicking on the last selected dice, deselect all\r\n      if (isCurrentlySelected && diceIndex === this.riskDiceCount - 1) {\r\n        this.riskDiceCount = 0;\r\n      } else {\r\n        // Otherwise, select all dice up to and including the clicked one\r\n        this.riskDiceCount = diceIndex + 1;\r\n      }\r\n      \r\n      // Re-render to update dice selection\r\n      this.render();\r\n    });\r\n\r\n    // Roll Dice button\r\n    html.find('.roll-dice-button').on('click', async () => {\r\n      // Calculate final RR based on enabled checkboxes\r\n      let finalRR = 0;\r\n      if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\r\n        for (const rrSource of this.rollData.rrList) {\r\n          if (rrSource && typeof rrSource === 'object') {\r\n            const rrValue = rrSource.rrValue || 0;\r\n            const featName = rrSource.featName || 'Inconnu';\r\n            const rrId = `${featName}-${rrValue}`;\r\n            \r\n            if (this.rrEnabled.get(rrId)) {\r\n              finalRR += rrValue;\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add manual RR bonus\r\n      finalRR += this.manualRRBonus;\r\n      \r\n      // Update roll data with final RR\r\n      const finalRRList = this.rollData.rrList?.filter((rr: any) => {\r\n        const rrId = `${rr.featName || 'Inconnu'}-${rr.rrValue || 0}`;\r\n        return this.rrEnabled.get(rrId);\r\n      }) || [];\r\n      \r\n      // Calculate dice pool\r\n      let dicePool = 0;\r\n      if (this.rollData.specLevel !== undefined) {\r\n        dicePool = this.rollData.specLevel;\r\n      } else if (this.rollData.skillLevel !== undefined) {\r\n        dicePool = this.rollData.skillLevel;\r\n      } else if (this.rollData.linkedAttribute) {\r\n        const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\r\n        dicePool = attributeValue;\r\n      }\r\n      \r\n      // Block defense roll if no skill/spec is selected (unless using threshold for NPCs)\r\n      if (this.rollData.isDefend && !this.rollData.threshold) {\r\n        if (!this.rollData.skillName && !this.rollData.specName && dicePool === 0) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.NO_SKILL_SELECTED') || 'Veuillez sélectionner une compétence pour la défense');\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // Block counter-attack roll if no weapon or skill is selected\r\n      if (this.rollData.isCounterAttack && !this.rollData.threshold) {\r\n        if (!this.rollData.selectedWeaponId && !this.rollData.skillName && !this.rollData.specName) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPON_SELECTED') || 'Veuillez sélectionner une arme pour la contre-attaque');\r\n          return;\r\n        }\r\n        if (dicePool === 0) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_DICE_POOL') || 'La réserve de dés pour la contre-attaque est de 0. Veuillez sélectionner une arme valide.');\r\n          return;\r\n        }\r\n      }\r\n      \r\n      // Block roll if selected range is \"none\" (for weapon rolls, not defense)\r\n      if (this.rollData.itemType === 'weapon' || this.rollData.itemType === 'spell' || this.rollData.itemType === 'weapons-spells') {\r\n        if (!this.rollData.isDefend && this.selectedRange) {\r\n          // Get the current range value\r\n          let selectedRangeValue: string | null = null;\r\n          const meleeRange = this.rollData.meleeRange || 'none';\r\n          const shortRange = this.rollData.shortRange || 'none';\r\n          const mediumRange = this.rollData.mediumRange || 'none';\r\n          const longRange = this.rollData.longRange || 'none';\r\n          \r\n          if (this.selectedRange === 'melee') {\r\n            selectedRangeValue = meleeRange;\r\n          } else if (this.selectedRange === 'short') {\r\n            selectedRangeValue = shortRange;\r\n          } else if (this.selectedRange === 'medium') {\r\n            selectedRangeValue = mediumRange;\r\n          } else if (this.selectedRange === 'long') {\r\n            selectedRangeValue = longRange;\r\n          }\r\n          \r\n          // Block if range value is \"none\"\r\n          if (selectedRangeValue === 'none') {\r\n            ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.INVALID_RANGE') || 'La portée sélectionnée n\\'est pas disponible pour cette arme. Veuillez sélectionner une portée valide.');\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      \r\n      // Get attacker and defender\r\n      const attacker = this.actor;\r\n      const attackerToken = this.attackerToken || null;\r\n      const defender = this.targetToken?.actor || null;\r\n      const defenderToken = this.targetToken || null;\r\n      \r\n      // Get token UUIDs\r\n      const attackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\r\n      const defenderTokenUuid = defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n      \r\n      // Log token information\r\n      console.log('=== ROLL DICE BUTTON ===');\r\n      console.log('Attacker:', attacker?.name || 'Unknown');\r\n      console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\r\n      console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\r\n      if (attackerToken?.actor) {\r\n        console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\r\n      }\r\n      console.log('Defender:', defender?.name || 'None');\r\n      console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\r\n      console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\r\n      if (defenderToken?.actor) {\r\n        console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\r\n      }\r\n      console.log('========================');\r\n      \r\n      // Prepare roll data\r\n      const updatedRollData = {\r\n        ...this.rollData,\r\n        rrList: finalRRList,\r\n        riskDiceCount: this.riskDiceCount,  // Add risk dice count to roll data\r\n        selectedRange: this.selectedRange,  // Add selected range\r\n        rollMode: this.rollMode,  // Add roll mode (normal/disadvantage/advantage)\r\n        finalRR: Math.min(3, finalRR),  // Final RR (capped at 3)\r\n        dicePool: dicePool,\r\n        attackerTokenUuid: attackerTokenUuid,  // Add attacker token UUID\r\n        defenderTokenUuid: defenderTokenUuid   // Add defender token UUID\r\n      };\r\n      \r\n      // Import and execute roll\r\n      const { executeRoll } = await import('../helpers/dice-roller.js');\r\n      await executeRoll(attacker, defender, attackerToken, defenderToken, updatedRollData);\r\n      \r\n      // Close the dialog\r\n      this.close();\r\n    });\r\n  }\r\n\r\n  private updateRRForSkill(skillName: string, linkedAttribute: string, dicePool: number): void {\r\n    // For defense, always use this.actor (the defender)\r\n    // For other rolls, also use this.actor (the one making the roll)\r\n    if (!this.actor) return;\r\n    \r\n    // Get RR sources synchronously (already imported at top)\r\n    // Always use this.actor which is correctly set to the defender for defense rolls\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    \r\n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with skill/attribute RR\r\n    // For non-weapon rolls, use only skill/attribute RR\r\n    let itemRRList: any[] = [];\r\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\r\n      // Get the weapon item to extract its rrList\r\n      const weapon = this.actor.items.get(this.rollData.itemId);\r\n      if (weapon) {\r\n        const weaponSystem = weapon.system as any;\r\n        const rawItemRRList = weaponSystem.rrList || [];\r\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n          ...rrEntry,\r\n          featName: weapon.name  // Add featName (the weapon name itself)\r\n        }));\r\n      }\r\n    }\r\n    \r\n    // Merge item RR (if weapon) + skill RR + attribute RR\r\n    this.rollData.rrList = [...itemRRList, ...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Reset RR enabled state for new sources\r\n    this.rrEnabled.clear();\r\n    for (const rrSource of this.rollData.rrList) {\r\n      if (rrSource && typeof rrSource === 'object') {\r\n        const rrValue = rrSource.rrValue || 0;\r\n        const featName = rrSource.featName || 'Inconnu';\r\n        if (rrValue > 0) {\r\n          const rrId = `${featName}-${rrValue}`;\r\n          this.rrEnabled.set(rrId, true);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Recalculate threshold if it was set\r\n    if (this.rollData.threshold !== undefined) {\r\n      const totalRR = Math.min(3, skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\r\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n    }\r\n  }\r\n\r\n  private updateRRForSpec(specName: string, skillName: string, linkedAttribute: string, dicePool: number): void {\r\n    // For defense, always use this.actor (the defender)\r\n    // For other rolls, also use this.actor (the one making the roll)\r\n    if (!this.actor) return;\r\n    \r\n    // Get RR sources synchronously (already imported at top)\r\n    // Always use this.actor which is correctly set to the defender for defense rolls\r\n    const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\r\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\r\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\r\n    \r\n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with spec/skill/attribute RR\r\n    // For non-weapon rolls, use only spec/skill/attribute RR\r\n    let itemRRList: any[] = [];\r\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\r\n      // Get the weapon item to extract its rrList\r\n      const weapon = this.actor.items.get(this.rollData.itemId);\r\n      if (weapon) {\r\n        const weaponSystem = weapon.system as any;\r\n        const rawItemRRList = weaponSystem.rrList || [];\r\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\r\n          ...rrEntry,\r\n          featName: weapon.name  // Add featName (the weapon name itself)\r\n        }));\r\n      }\r\n    }\r\n    \r\n    // Merge item RR (if weapon) + spec RR + skill RR + attribute RR\r\n    this.rollData.rrList = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\r\n    \r\n    // Reset RR enabled state for new sources\r\n    this.rrEnabled.clear();\r\n    for (const rrSource of this.rollData.rrList) {\r\n      if (rrSource && typeof rrSource === 'object') {\r\n        const rrValue = rrSource.rrValue || 0;\r\n        const featName = rrSource.featName || 'Inconnu';\r\n        if (rrValue > 0) {\r\n          const rrId = `${featName}-${rrValue}`;\r\n          this.rrEnabled.set(rrId, true);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Recalculate threshold if it was set\r\n    if (this.rollData.threshold !== undefined) {\r\n      const totalRR = Math.min(3, specRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \r\n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\r\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\r\n    }\r\n  }\r\n}\r\n\r\n","export const HOOKS = {\r\n  MIGRATIONS: 'sra2-declareMigration',\r\n}","import { HOOKS } from \"../hooks.mjs\"\r\n\r\nconst CURRENT_SYSTEM_VERSION = \"currentSystemVersion\";\r\n\r\nexport class Migration {\r\n  get code() { return \"sample\"; }\r\n\r\n  get version() { return \"0.0.0\"; }\r\n\r\n  async migrate() { return () => { } };\r\n\r\n  async applyItemsUpdates(computeUpdates = (items) => []) {\r\n    await game.actors.forEach(async (actor) => {\r\n      const actorItemUpdates = computeUpdates(actor.items);\r\n      if (actorItemUpdates.length > 0) {\r\n        const message = game.i18n.format('SRA2.MIGRATION.APPLYING_ACTOR_ITEMS', { name: actor.name });\r\n        console.log(SYSTEM.LOG.HEAD, this.code, message, actorItemUpdates);\r\n        await actor.updateEmbeddedDocuments('Item', actorItemUpdates);\r\n      }\r\n    })\r\n\r\n    const itemUpdates = computeUpdates(game.items);\r\n    if (itemUpdates.length > 0) {\r\n      const message = game.i18n.localize('SRA2.MIGRATION.APPLYING_ITEMS');\r\n      console.log(SYSTEM.LOG.HEAD, this.code, message, itemUpdates);\r\n      await Item.updateDocuments(itemUpdates);\r\n    }\r\n  }\r\n}\r\n\r\nexport class Migrations {\r\n  constructor() {\r\n    // Hooks.once(HOOKS.MIGRATIONS, declareMigrations => declareMigrations(\r\n    //   /* add system migrations here, can declared anywhere */\r\n    // ))\r\n\r\n    game.settings.register(SYSTEM.id, CURRENT_SYSTEM_VERSION, {\r\n      name: \"SRA2.MIGRATION.SETTING_NAME\",\r\n      scope: \"world\",\r\n      config: false,\r\n      type: String,\r\n      default: \"0.0.0\"\r\n    })\r\n  }\r\n\r\n  migrate() {\r\n    const currentVersion = game.settings.get(SYSTEM.id, CURRENT_SYSTEM_VERSION)\r\n    if (foundry.utils.isNewerVersion(game.system.version, currentVersion)) {\r\n      //if (true) {\r\n      let migrations = []\r\n      Hooks.callAll(HOOKS.MIGRATIONS, (...list) =>\r\n        migrations = migrations.concat(list.filter(m => foundry.utils.isNewerVersion(m.version, currentVersion)))\r\n      )\r\n      Hooks.off(HOOKS.MIGRATIONS, () => { })\r\n\r\n      if (migrations.length > 0) {\r\n        migrations.sort((a, b) => foundry.utils.isNewerVersion(a.version, b.version) ? 1 : foundry.utils.isNewerVersion(b.version, a.version) ? -1 : 0)\r\n        migrations.forEach(async m => {\r\n          const message = game.i18n.format('SRA2.MIGRATION.EXECUTING', { code: m.code, currentVersion: currentVersion, targetVersion: m.version });\r\n          this.$notify(message);\r\n          await m.migrate()\r\n        })\r\n        const message = game.i18n.format('SRA2.MIGRATION.DONE', { version: game.system.version });\r\n        this.$notify(message)\r\n      }\r\n      else {\r\n        const message = game.i18n.format('SRA2.MIGRATION.NOT_NEEDED', { version: game.system.version });\r\n        console.log(SYSTEM.LOG.HEAD + message)\r\n      }\r\n      game.settings.set(SYSTEM.id, CURRENT_SYSTEM_VERSION, game.system.version)\r\n    }\r\n    else {\r\n      const message = game.i18n.localize('SRA2.MIGRATION.VERSION_UNCHANGED');\r\n      console.log(SYSTEM.LOG.HEAD + message)\r\n    }\r\n  }\r\n\r\n\r\n  $notify(message) {\r\n    ui.notifications.info(message);\r\n    console.log(SYSTEM.LOG.HEAD + message);\r\n  }\r\n}\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.3: Convert rrType, rrValue, rrTarget arrays to rrList\r\n * This migration transforms the three separate arrays into a single array of objects\r\n * where each object contains {rrType, rrValue, rrTarget}\r\n */\r\nexport class Migration_13_0_3 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.3\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.3\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.3: Converting rrType/rrValue/rrTarget to rrList\");\r\n    \r\n    let totalMigrated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the raw source data which contains fields even if they're not in the schema\r\n        const sourceSystem = item._source?.system || item.system;\r\n        const system = item.system;\r\n        \r\n        // Check for old format in the source data (raw data from database)\r\n        const hasOldFormat = (\r\n          (sourceSystem.rrType !== undefined && Array.isArray(sourceSystem.rrType)) ||\r\n          (sourceSystem.rrValue !== undefined && Array.isArray(sourceSystem.rrValue)) ||\r\n          (sourceSystem.rrTarget !== undefined && Array.isArray(sourceSystem.rrTarget))\r\n        );\r\n        \r\n        // Check if rrList already exists with content in source\r\n        const hasNewFormatInSource = (\r\n          sourceSystem.rrList !== undefined && \r\n          Array.isArray(sourceSystem.rrList)\r\n        );\r\n        \r\n        // Skip if already migrated (has new format in source AND no old format)\r\n        if (hasNewFormatInSource && !hasOldFormat) {\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - already has rrList in source (${sourceSystem.rrList.length} entries), no old data`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Skip if no old format to migrate\r\n        if (!hasOldFormat) {\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - no old format fields found`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Get the arrays from source data\r\n        const rrType = Array.isArray(sourceSystem.rrType) ? sourceSystem.rrType : [];\r\n        const rrValue = Array.isArray(sourceSystem.rrValue) ? sourceSystem.rrValue : [];\r\n        const rrTarget = Array.isArray(sourceSystem.rrTarget) ? sourceSystem.rrTarget : [];\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Found \"${item.name}\" with old format:`, {\r\n          rrType: rrType,\r\n          rrValue: rrValue,\r\n          rrTarget: rrTarget\r\n        });\r\n        \r\n        // Convert the three arrays into a single rrList array\r\n        const rrList = [];\r\n        const maxLength = Math.max(rrType.length, rrValue.length, rrTarget.length);\r\n        \r\n        for (let i = 0; i < maxLength; i++) {\r\n          // Only add entries where rrType exists and is not \"none\"\r\n          const type = rrType[i];\r\n          if (type && type !== 'none') {\r\n            rrList.push({\r\n              rrType: type,\r\n              rrValue: rrValue[i] !== undefined ? rrValue[i] : 0,\r\n              rrTarget: rrTarget[i] !== undefined ? rrTarget[i] : ''\r\n            });\r\n          }\r\n        }\r\n        \r\n        // Create the update object\r\n        const update = {\r\n          _id: item.id,\r\n          'system.rrList': rrList,\r\n          // Store backup of old data before deletion\r\n          'system._rrTypeBackup': rrType,\r\n          'system._rrValueBackup': rrValue,\r\n          'system._rrTargetBackup': rrTarget,\r\n          // Remove old fields by setting them to null (Foundry will delete them)\r\n          'system.rrType': null,\r\n          'system.rrValue': null,\r\n          'system.rrTarget': null\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalMigrated++;\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Converting feat \"${item.name}\":`);\r\n        console.log(SYSTEM.LOG.HEAD + `  Old data (will be deleted, backed up as _rrTypeBackup/_rrValueBackup/_rrTargetBackup):`, { rrType, rrValue, rrTarget });\r\n        console.log(SYSTEM.LOG.HEAD + `  New rrList (${rrList.length} entries):`, rrList);\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.3 completed - Migrated: ${totalMigrated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalMigrated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_3_INFO') :\r\n        'Migration 13.0.3: Risk Reduction data converted. Check console for details.';\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.4: Clean up old RR fields and backups\r\n * This migration removes the old rrType/rrValue/rrTarget fields and their backups\r\n * after confirming that rrList is working properly\r\n */\r\nexport class Migration_13_0_4 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.4\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.4\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.4: Cleaning up old RR fields and backups\");\r\n    \r\n    let totalCleaned = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the raw source data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Check if there are any old fields or backups to clean\r\n        const hasOldFields = (\r\n          sourceSystem.rrType !== undefined ||\r\n          sourceSystem.rrValue !== undefined ||\r\n          sourceSystem.rrTarget !== undefined\r\n        );\r\n        \r\n        const hasBackups = (\r\n          sourceSystem._rrTypeBackup !== undefined ||\r\n          sourceSystem._rrValueBackup !== undefined ||\r\n          sourceSystem._rrTargetBackup !== undefined\r\n        );\r\n        \r\n        // Skip if nothing to clean\r\n        if (!hasOldFields && !hasBackups) {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check that rrList exists (safety check)\r\n        const hasRrList = sourceSystem.rrList !== undefined && Array.isArray(sourceSystem.rrList);\r\n        \r\n        if (!hasRrList) {\r\n          console.warn(SYSTEM.LOG.HEAD + `Migration 13.0.4: Skipping \"${item.name}\" - no rrList found! This item may need manual review.`);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.4: Cleaning up feat \"${item.name}\":`);\r\n        if (hasOldFields) {\r\n          console.log(SYSTEM.LOG.HEAD + `  Removing old fields: rrType, rrValue, rrTarget`);\r\n        }\r\n        if (hasBackups) {\r\n          console.log(SYSTEM.LOG.HEAD + `  Removing backups: _rrTypeBackup, _rrValueBackup, _rrTargetBackup`);\r\n        }\r\n        console.log(SYSTEM.LOG.HEAD + `  Keeping rrList with ${sourceSystem.rrList.length} entries`);\r\n        \r\n        // Create the update object to remove all old fields\r\n        const update = {\r\n          _id: item.id,\r\n          // Remove old fields\r\n          'system.rrType': null,\r\n          'system.rrValue': null,\r\n          'system.rrTarget': null,\r\n          // Remove backup fields\r\n          'system._rrTypeBackup': null,\r\n          'system._rrValueBackup': null,\r\n          'system._rrTargetBackup': null\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalCleaned++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.4 completed - Cleaned: ${totalCleaned}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalCleaned > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_4_INFO') :\r\n        'Migration 13.0.4: Old RR fields cleaned up. Data migration complete.';\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.5: Separate weapons and spells feat types\r\n * This migration converts \"weapons-spells\" feat type to separate \"weapon\" and \"spell\" types\r\n * By default, all \"weapons-spells\" are converted to \"weapon\" type\r\n */\r\nexport class Migration_13_0_5 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.5\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.5\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.5: Separating weapons and spells feat types\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Check if this is a \"weapons-spells\" feat type\r\n        if (sourceSystem.featType !== 'weapons-spells') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.5: Converting feat \"${item.name}\" from \"weapons-spells\" to \"weapon\"`);\r\n        \r\n        // Convert to \"weapon\" type by default\r\n        // Users can manually change specific items to \"spell\" if needed\r\n        const update = {\r\n          _id: item.id,\r\n          'system.featType': 'weapon'\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalConverted++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    const summaryMessage = `Migration 13.0.5 completed - Converted: ${totalConverted} weapons-spells to weapon, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.localize('SRA2.MIGRATION.13_0_5_INFO') :\r\n        `Migration 13.0.5: Converted ${totalConverted} \"weapons-spells\" feats to \"weapon\" type. You can manually change specific items to \"spell\" type if needed.`;\r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.6: Rollback migration 13.0.5\r\n * This migration does NOT convert anything - keeps weapons-spells as valid type\r\n * Only marks that this version has been applied\r\n */\r\nexport class Migration_13_0_6 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.6\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.6\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Migration 13.0.6: Rollback - keeping old weapons-spells type valid\");\r\n    console.log(SYSTEM.LOG.HEAD + \"No conversion needed. weapons-spells, weapon, and spell types are all valid.\");\r\n    \r\n    // This migration does nothing, just marks the version as applied\r\n    // Old items with \"weapons-spells\" will continue to work\r\n    // New items can use \"weapon\" or \"spell\" as separate types\r\n    \r\n    const message = \"Migration 13.0.6: All feat types (weapons-spells, weapon, spell) are now valid. No data conversion performed.\";\r\n    console.log(SYSTEM.LOG.HEAD + message);\r\n    \r\n    if (ui.notifications) {\r\n      ui.notifications.info(message, {permanent: false});\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.7: Convert weapons-spells to weapon (with backup)\r\n * This migration safely converts all \"weapons-spells\" feat types to \"weapon\"\r\n * Creates a backup of the old value before conversion\r\n */\r\nexport class Migration_13_0_7 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.7\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.7\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.7: Converting weapons-spells to weapon (with backup)\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    let conversionDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if not weapons-spells type\r\n        if (sourceSystem.featType !== 'weapons-spells') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Log what we're converting\r\n        const itemInfo = {\r\n          name: item.name,\r\n          id: item.id,\r\n          oldType: 'weapons-spells',\r\n          newType: 'weapon',\r\n          hasWeaponFocus: sourceSystem.isWeaponFocus || false,\r\n          hasDamageValue: (sourceSystem.damageValue || 0) > 0,\r\n          hasRanges: (\r\n            sourceSystem.meleeRange !== 'none' ||\r\n            sourceSystem.shortRange !== 'none' ||\r\n            sourceSystem.mediumRange !== 'none' ||\r\n            sourceSystem.longRange !== 'none'\r\n          )\r\n        };\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.7: Converting \"${item.name}\" (ID: ${item.id})`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Old type: weapons-spells`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - New type: weapon`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has weapon focus: ${itemInfo.hasWeaponFocus}`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has damage value: ${itemInfo.hasDamageValue}`);\r\n        console.log(SYSTEM.LOG.HEAD + `  - Has ranges: ${itemInfo.hasRanges}`);\r\n        \r\n        conversionDetails.push(itemInfo);\r\n        \r\n        // Create the update object\r\n        const update = {\r\n          _id: item.id,\r\n          // Change the type\r\n          'system.featType': 'weapon',\r\n          // Create a backup of the old type for safety\r\n          'system._oldFeatTypeBackup': 'weapons-spells',\r\n          // Add a migration timestamp\r\n          'system._migratedAt': new Date().toISOString(),\r\n          'system._migrationVersion': '13.0.7'\r\n        };\r\n        \r\n        updates.push(update);\r\n        totalConverted++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.7 completed - Converted: ${totalConverted}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (conversionDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\r\n      \r\n      const withWeaponFocus = conversionDetails.filter(d => d.hasWeaponFocus).length;\r\n      const withDamage = conversionDetails.filter(d => d.hasDamageValue).length;\r\n      const withRanges = conversionDetails.filter(d => d.hasRanges).length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with weapon focus: ${withWeaponFocus}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with damage value: ${withDamage}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Items with ranges: ${withRanges}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\r\n      \r\n      // List all converted items\r\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\r\n      conversionDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id})`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_7_INFO', { count: totalConverted }) :\r\n        `Migration 13.0.7: Converted ${totalConverted} \"weapons-spells\" items to \"weapon\" type. All data preserved with backup.`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete. All items have been backed up.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Old type saved in system._oldFeatTypeBackup\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to convert - all items already migrated or are other types\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.8: Convert narrativeEffects from string array to object array\r\n * This migration safely converts all narrativeEffects from simple strings\r\n * to objects with { text: string, isNegative: boolean } structure\r\n */\r\nexport class Migration_13_0_8 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.8\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.8\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.8: Converting narrativeEffects to new format and fixing damageValueBonus\");\r\n    \r\n    let totalConverted = 0;\r\n    let totalSkipped = 0;\r\n    let totalFixed = 0;\r\n    let conversionDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        // Check and fix narrativeEffects\r\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\r\n          // Check if it's already in the new format (first element is an object with 'text' property)\r\n          const firstEffect = sourceSystem.narrativeEffects[0];\r\n          if (!(typeof firstEffect === 'object' && firstEffect !== null && 'text' in firstEffect)) {\r\n            // Convert string array to object array\r\n            const convertedEffects = sourceSystem.narrativeEffects.map(effect => {\r\n              if (typeof effect === 'string') {\r\n                return {\r\n                  text: effect,\r\n                  isNegative: false\r\n                };\r\n              }\r\n              // If it's already an object but missing properties, normalize it\r\n              return {\r\n                text: effect?.text || effect?.toString() || \"\",\r\n                isNegative: effect?.isNegative || false\r\n              };\r\n            });\r\n            \r\n            update['system.narrativeEffects'] = convertedEffects;\r\n            update['system._migratedNarrativeEffectsAt'] = new Date().toISOString();\r\n            update['system._narrativeEffectsMigrationVersion'] = '13.0.8';\r\n            needsUpdate = true;\r\n            \r\n            // Log what we're converting\r\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Converting narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\r\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${sourceSystem.narrativeEffects.length}`);\r\n            \r\n            conversionDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: sourceSystem.narrativeEffects.length\r\n            });\r\n            totalConverted++;\r\n          }\r\n        }\r\n        \r\n        // Fix missing or invalid damageValueBonus values for ALL feat items\r\n        if (sourceSystem.damageValueBonus === null || \r\n            sourceSystem.damageValueBonus === undefined || \r\n            typeof sourceSystem.damageValueBonus !== 'number' ||\r\n            !Number.isInteger(sourceSystem.damageValueBonus)) {\r\n          update['system.damageValueBonus'] = 0;\r\n          needsUpdate = true;\r\n          totalFixed++;\r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Fixing damageValueBonus for \"${item.name}\" (ID: ${item.id})`);\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          updates.push(update);\r\n        } else {\r\n          totalSkipped++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.8 completed - NarrativeEffects converted: ${totalConverted}, DamageValueBonus fixed: ${totalFixed}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (conversionDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\r\n      \r\n      const totalEffects = conversionDetails.reduce((sum, d) => sum + d.effectCount, 0);\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects migrated: ${totalEffects}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\r\n      \r\n      // List all converted items\r\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\r\n      conversionDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${detail.effectCount} effect(s)`);\r\n      });\r\n    }\r\n    \r\n    if (totalFixed > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + `Fixed damageValueBonus on ${totalFixed} item(s)`);\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalConverted > 0 || totalFixed > 0) {\r\n      let userMessage = \"\";\r\n      if (totalConverted > 0 && totalFixed > 0) {\r\n        userMessage = game.i18n ? \r\n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted, fixed: totalFixed }) :\r\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) and fixed damageValueBonus on ${totalFixed} feat(s).`;\r\n      } else if (totalConverted > 0) {\r\n        userMessage = game.i18n ? \r\n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted }) :\r\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) to new format.`;\r\n      } else if (totalFixed > 0) {\r\n        userMessage = `Migration 13.0.8: Fixed damageValueBonus on ${totalFixed} feat(s).`;\r\n      }\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      if (totalConverted > 0) {\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects converted to new format.\");\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All effects default to positive (isNegative: false)\");\r\n      }\r\n      if (totalFixed > 0) {\r\n        console.log(SYSTEM.LOG.HEAD + \"✓ All damageValueBonus fields set to valid integer values.\");\r\n      }\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.9: Add value field to narrativeEffects and isFirstFeat field\r\n * This migration adds a 'value' field to all narrative effects\r\n * with a default of -1 for consistency with the new schema,\r\n * and adds an 'isFirstFeat' boolean field with default false\r\n */\r\nexport class Migration_13_0_9 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.9\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.9\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.9: Adding value field to narrativeEffects and isFirstFeat field\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    let totalFirstFeatAdded = 0;\r\n    let updateDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        // Check if item has narrativeEffects that need updating\r\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\r\n          const updatedEffects = sourceSystem.narrativeEffects.map(effect => {\r\n            // Check if effect already has a value field\r\n            if (typeof effect === 'object' && effect !== null && !('value' in effect)) {\r\n              needsUpdate = true;\r\n              return {\r\n                ...effect,\r\n                value: -1  // Default value for all effects\r\n              };\r\n            }\r\n            return effect;\r\n          });\r\n          \r\n          if (needsUpdate) {\r\n            update['system.narrativeEffects'] = updatedEffects;\r\n            update['system._migratedNarrativeEffectsValueAt'] = new Date().toISOString();\r\n            \r\n            // Log what we're converting\r\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding value field to narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\r\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${updatedEffects.length}`);\r\n            \r\n            updateDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: updatedEffects.length,\r\n              hasFirstFeat: false\r\n            });\r\n          }\r\n        }\r\n        \r\n        // Check if item needs isFirstFeat field (add to all feats that don't have it)\r\n        if (sourceSystem.isFirstFeat === undefined || sourceSystem.isFirstFeat === null) {\r\n          update['system.isFirstFeat'] = false;\r\n          needsUpdate = true;\r\n          totalFirstFeatAdded++;\r\n          \r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding isFirstFeat field to \"${item.name}\" (ID: ${item.id})`);\r\n          \r\n          // Update details if not already added\r\n          const existingDetail = updateDetails.find(d => d.id === item.id);\r\n          if (existingDetail) {\r\n            existingDetail.hasFirstFeat = true;\r\n          } else {\r\n            updateDetails.push({\r\n              name: item.name,\r\n              id: item.id,\r\n              effectCount: 0,\r\n              hasFirstFeat: true\r\n            });\r\n          }\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          update['system._narrativeEffectsValueMigrationVersion'] = '13.0.9';\r\n          updates.push(update);\r\n          totalUpdated++;\r\n        } else {\r\n          totalSkipped++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.9 completed - Items updated: ${totalUpdated}, isFirstFeat added: ${totalFirstFeatAdded}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (updateDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\r\n      \r\n      const totalEffects = updateDetails.reduce((sum, d) => sum + d.effectCount, 0);\r\n      const totalWithFirstFeat = updateDetails.filter(d => d.hasFirstFeat).length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects updated: ${totalEffects}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - Total items with isFirstFeat added: ${totalWithFirstFeat}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\r\n      \r\n      // List all updated items\r\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\r\n      updateDetails.forEach((detail, index) => {\r\n        const updates = [];\r\n        if (detail.effectCount > 0) updates.push(`${detail.effectCount} effect(s)`);\r\n        if (detail.hasFirstFeat) updates.push('isFirstFeat added');\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${updates.join(', ')}`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_9_INFO', { count: totalUpdated, firstFeatCount: totalFirstFeatAdded }) :\r\n        `Migration 13.0.9: Updated ${totalUpdated} feat(s) - added value field to narrative effects and isFirstFeat field to ${totalFirstFeatAdded} feat(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects now have a value field (default: -1)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All feats now have isFirstFeat field (default: false)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.10: Update cost field values\r\n * This migration updates the cost field to use the new simplified system:\r\n * - 'specialized-equipment' -> 'advanced-equipment'\r\n * - 'feat' -> removed (defaults to 0 cost for non-equipment items)\r\n * - Cost field only applies to equipment and weapon types\r\n */\r\nexport class Migration_13_0_10 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.10\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.10\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.10: Updating cost field values\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    let updateDetails = [];\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      // Log all feat items for debugging\r\n      const featItems = items.filter(item => item.type === 'feat');\r\n      console.log(SYSTEM.LOG.HEAD + `Found ${featItems.length} feat items to check`);\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._costMigrationVersion === '13.0.10') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        let needsUpdate = false;\r\n        const update = {\r\n          _id: item.id\r\n        };\r\n        \r\n        const currentCost = sourceSystem.cost || 'free-equipment';\r\n        const featType = sourceSystem.featType || 'equipment';\r\n        let newCost = currentCost;\r\n        let reason = '';\r\n        \r\n        // Log current state for debugging\r\n        console.log(SYSTEM.LOG.HEAD + `Checking \"${item.name}\" - cost: \"${currentCost}\", type: \"${featType}\"`);\r\n        \r\n        // Convert specialized-equipment to advanced-equipment\r\n        if (currentCost === 'specialized-equipment') {\r\n          newCost = 'advanced-equipment';\r\n          needsUpdate = true;\r\n          reason = 'specialized-equipment → advanced-equipment';\r\n        }\r\n        // Convert old 'feat' cost type to appropriate value\r\n        else if (currentCost === 'feat') {\r\n          // For equipment and weapons, set to free-equipment (0 cost)\r\n          // For other types, the cost doesn't apply anyway but we set it to free-equipment for consistency\r\n          newCost = 'free-equipment';\r\n          needsUpdate = true;\r\n          reason = 'feat → free-equipment (cost = 0 for non-equipment types)';\r\n        }\r\n        // Ensure all items have a valid cost value\r\n        else if (!currentCost || !['free-equipment', 'equipment', 'advanced-equipment'].includes(currentCost)) {\r\n          newCost = 'free-equipment';\r\n          needsUpdate = true;\r\n          reason = `invalid or missing cost (${currentCost}) → free-equipment`;\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          update['system.cost'] = newCost;\r\n          update['system._costMigrationVersion'] = '13.0.10';\r\n          \r\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.10: Updating cost for \"${item.name}\" (ID: ${item.id})`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Type: ${featType}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Old cost: ${currentCost}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - New cost: ${newCost}`);\r\n          console.log(SYSTEM.LOG.HEAD + `  - Reason: ${reason}`);\r\n          \r\n          updateDetails.push({\r\n            name: item.name,\r\n            id: item.id,\r\n            featType: featType,\r\n            oldCost: currentCost,\r\n            newCost: newCost,\r\n            reason: reason\r\n          });\r\n          \r\n          updates.push(update);\r\n          totalUpdated++;\r\n        }\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.10 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Detailed summary\r\n    if (updateDetails.length > 0) {\r\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\r\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\r\n      \r\n      const specializedToAdvanced = updateDetails.filter(d => d.oldCost === 'specialized-equipment').length;\r\n      const featToFree = updateDetails.filter(d => d.oldCost === 'feat').length;\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + `  - specialized-equipment → advanced-equipment: ${specializedToAdvanced}`);\r\n      console.log(SYSTEM.LOG.HEAD + `  - feat → free-equipment: ${featToFree}`);\r\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\r\n      \r\n      // List all updated items\r\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\r\n      updateDetails.forEach((detail, index) => {\r\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (${detail.featType}): ${detail.oldCost} → ${detail.newCost}`);\r\n      });\r\n    }\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_10_INFO', { \r\n          count: totalUpdated,\r\n          specializedCount: updateDetails.filter(d => d.oldCost === 'specialized-equipment').length,\r\n          featCount: updateDetails.filter(d => d.oldCost === 'feat').length\r\n        }) :\r\n        `Migration 13.0.10: Updated ${totalUpdated} feat(s) cost values.`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost system simplified: free (0¥), equipment (2500¥), advanced (5000¥)\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost now only applies to equipment and weapon types\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.11: Add linked specializations fields to weapons\r\n * This migration adds the new linkedAttackSpecialization and linkedDefenseSpecialization fields\r\n * to all weapon and weapons-spells type feats\r\n */\r\nexport class Migration_13_0_11 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.11\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.11\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.11: Adding linked specializations fields to weapons\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items of type weapon or weapons-spells\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        const featType = sourceSystem.featType || 'equipment';\r\n        \r\n        // Only process weapon and weapons-spells types\r\n        if (featType !== 'weapon' && featType !== 'weapons-spells') {\r\n          continue;\r\n        }\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._specializationLinkMigrationVersion === '13.0.11') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check if the fields already exist\r\n        const hasAttackSpec = sourceSystem.hasOwnProperty('linkedAttackSpecialization');\r\n        const hasDefenseSpec = sourceSystem.hasOwnProperty('linkedDefenseSpecialization');\r\n        \r\n        if (hasAttackSpec && hasDefenseSpec) {\r\n          // Fields already exist, just mark as migrated\r\n          const update = {\r\n            _id: item.id,\r\n            'system._specializationLinkMigrationVersion': '13.0.11'\r\n          };\r\n          updates.push(update);\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Add the new fields\r\n        const update = {\r\n          _id: item.id,\r\n          'system.linkedAttackSpecialization': sourceSystem.linkedAttackSpecialization || '',\r\n          'system.linkedDefenseSpecialization': sourceSystem.linkedDefenseSpecialization || '',\r\n          'system._specializationLinkMigrationVersion': '13.0.11'\r\n        };\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.11: Adding specialization link fields to weapon \"${item.name}\" (ID: ${item.id})`);\r\n        \r\n        updates.push(update);\r\n        totalUpdated++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.11 completed - Weapons updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_11_INFO', { count: totalUpdated }) :\r\n        `Migration 13.0.11: Added specialization link fields to ${totalUpdated} weapon(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Weapons can now be linked to attack and defense specializations\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n","import { Migration } from \"./migration.mjs\";\r\n\r\n/**\r\n * Migration 13.0.12: Convert \"dice\" to \"disadvantage\" in weapon ranges\r\n * This migration updates all weapon/spell range values from \"dice\" to \"disadvantage\"\r\n * for meleeRange, shortRange, mediumRange, and longRange fields\r\n */\r\nexport class Migration_13_0_12 extends Migration {\r\n  get code() { \r\n    return \"migration-13.0.12\"; \r\n  }\r\n\r\n  get version() { \r\n    return \"13.0.12\"; \r\n  }\r\n\r\n  async migrate() {\r\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.12: Converting 'dice' to 'disadvantage' in weapon ranges\");\r\n    \r\n    let totalUpdated = 0;\r\n    let totalSkipped = 0;\r\n    \r\n    await this.applyItemsUpdates((items) => {\r\n      const updates = [];\r\n      \r\n      for (const item of items) {\r\n        // Only process feat items\r\n        if (item.type !== 'feat') {\r\n          continue;\r\n        }\r\n        \r\n        // Access the system data\r\n        const sourceSystem = item._source?.system || item.system;\r\n        \r\n        // Skip if already migrated\r\n        if (sourceSystem._rangeDiceToDisadvantageMigrationVersion === '13.0.12') {\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Check if any range has \"dice\" value\r\n        const hasDiceValue = \r\n          sourceSystem.meleeRange === 'dice' ||\r\n          sourceSystem.shortRange === 'dice' ||\r\n          sourceSystem.mediumRange === 'dice' ||\r\n          sourceSystem.longRange === 'dice';\r\n        \r\n        if (!hasDiceValue) {\r\n          // No \"dice\" values found, skip (don't mark as migrated to allow re-running)\r\n          totalSkipped++;\r\n          continue;\r\n        }\r\n        \r\n        // Build update object with converted values\r\n        const update = {\r\n          _id: item.id,\r\n          'system._rangeDiceToDisadvantageMigrationVersion': '13.0.12'\r\n        };\r\n        \r\n        if (sourceSystem.meleeRange === 'dice') {\r\n          update['system.meleeRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.shortRange === 'dice') {\r\n          update['system.shortRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.mediumRange === 'dice') {\r\n          update['system.mediumRange'] = 'disadvantage';\r\n        }\r\n        if (sourceSystem.longRange === 'dice') {\r\n          update['system.longRange'] = 'disadvantage';\r\n        }\r\n        \r\n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.12: Converting ranges for \"${item.name}\" (ID: ${item.id})`);\r\n        \r\n        updates.push(update);\r\n        totalUpdated++;\r\n      }\r\n      \r\n      return updates;\r\n    });\r\n    \r\n    // Summary message\r\n    const summaryMessage = `Migration 13.0.12 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\r\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\r\n    \r\n    // Show user-friendly notification\r\n    if (totalUpdated > 0) {\r\n      const userMessage = game.i18n ? \r\n        game.i18n.format('SRA2.MIGRATION.13_0_12_INFO', { count: totalUpdated }) :\r\n        `Migration 13.0.12: Converted weapon ranges from \"dice\" to \"disadvantage\" for ${totalUpdated} item(s).`;\r\n      \r\n      ui.notifications?.info(userMessage, {permanent: false});\r\n      \r\n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\r\n      console.log(SYSTEM.LOG.HEAD + \"✓ All weapon ranges now use 'disadvantage' instead of 'dice'\");\r\n    } else {\r\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\r\n    }\r\n  }\r\n}\r\n\r\n","import { SYSTEM } from \"./config/system.ts\";\r\nimport { setSidebarIcons, setControlIcons, setCompendiumBanners } from \"./config/ui-config.ts\";\r\n\r\n// Expose the SYSTEM object to the global scope\r\nglobalThis.SYSTEM = SYSTEM;\r\n\r\n// Declare global Foundry objects\r\ndeclare const Roll: any;\r\ndeclare const renderTemplate: any;\r\ndeclare const ChatMessage: any;\r\n\r\nimport * as models from \"./models/_module.ts\";\r\nimport * as documents from \"./documents/_module.ts\";\r\nimport * as applications from \"./applications/_module.ts\";\r\nimport * as CombatHelpers from \"./helpers/combat-helpers.ts\";\r\nimport * as SheetHelpers from \"./helpers/sheet-helpers.ts\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migrations } from \"./migration/migration.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_3 } from \"./migration/migration-13.0.3.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_4 } from \"./migration/migration-13.0.4.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_5 } from \"./migration/migration-13.0.5.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_6 } from \"./migration/migration-13.0.6.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_7 } from \"./migration/migration-13.0.7.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_8 } from \"./migration/migration-13.0.8.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_9 } from \"./migration/migration-13.0.9.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_10 } from \"./migration/migration-13.0.10.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_11 } from \"./migration/migration-13.0.11.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { Migration_13_0_12 } from \"./migration/migration-13.0.12.mjs\";\r\n// @ts-ignore - JavaScript module without type declarations\r\nimport { HOOKS } from \"./hooks.mjs\";\r\n\r\nexport class SRA2System {\r\n  static start(): void {\r\n    new SRA2System();\r\n  }\r\n\r\n  constructor() {\r\n    if (game.system) {\r\n      game.system.sra2 = this;\r\n    }\r\n    Hooks.once('init', () => this.onInit());\r\n  }\r\n  \r\n  onInit(): void {\r\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onInit');\r\n    if (game.system) {\r\n      game.system.api = {\r\n        applications,\r\n        models,\r\n        documents,\r\n      };\r\n    }\r\n    \r\n    // Register theme setting\r\n    this.registerThemeSetting();\r\n    \r\n    // Configure UI elements (icons, banners)\r\n    setSidebarIcons();\r\n    setControlIcons();\r\n    setCompendiumBanners();\r\n    \r\n    // Register migrations\r\n    new Migrations();\r\n    Hooks.on(HOOKS.MIGRATIONS, (declareMigration: any) => {\r\n      declareMigration(new Migration_13_0_3());\r\n      declareMigration(new Migration_13_0_4());\r\n      declareMigration(new Migration_13_0_5());\r\n      declareMigration(new Migration_13_0_6());\r\n      declareMigration(new Migration_13_0_7());\r\n      declareMigration(new Migration_13_0_8());\r\n      declareMigration(new Migration_13_0_9());\r\n      declareMigration(new Migration_13_0_10());\r\n      declareMigration(new Migration_13_0_11());\r\n      declareMigration(new Migration_13_0_12());\r\n    });\r\n    \r\n    // Register custom Actor document class\r\n    CONFIG.Actor.documentClass = documents.SRA2Actor;\r\n    \r\n    // Register Actor data models\r\n    CONFIG.Actor.dataModels = {\r\n      character: models.CharacterDataModel,\r\n      vehicle: models.VehicleDataModel,\r\n      ice: models.IceDataModel,\r\n    };\r\n    \r\n    // Register Item data models\r\n    CONFIG.Item.dataModels = {\r\n      skill: models.SkillDataModel,\r\n      feat: models.FeatDataModel,\r\n      specialization: models.SpecializationDataModel,\r\n      metatype: models.MetatypeDataModel,\r\n    };\r\n    \r\n    // Register character sheet (PC view - default)\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheet, {\r\n      types: [\"character\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.CHARACTER\"\r\n    });\r\n    \r\n    // Register character sheet V2 (alternative template/style)\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheetV2, {\r\n      types: [\"character\"],\r\n      makeDefault: false,\r\n      label: \"SRA2.SHEET.CHARACTER_V2\"\r\n    });\r\n    \r\n    // Register vehicle sheet\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.VehicleSheet, {\r\n      types: [\"vehicle\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.VEHICLE\"\r\n    });\r\n    \r\n    // Register ICE sheet\r\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.IceSheet, {\r\n      types: [\"ice\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.ICE\"\r\n    });\r\n    \r\n    // Hook to ensure all vehicle actors are available in game.actors before cost calculations\r\n    // This runs after all actors are loaded to ensure vehicles are accessible synchronously\r\n    Hooks.on('ready', () => {\r\n      if (!game.actors) return;\r\n      \r\n      // Find all character actors and ensure their linked vehicles have calculatedCost\r\n      const characterActors = (game.actors as any).filter((actor: any) => actor.type === 'character');\r\n      \r\n      for (const charActor of characterActors) {\r\n        const linkedVehicles = (charActor.system as any)?.linkedVehicles || [];\r\n        \r\n        // Ensure all linked vehicles have their costs calculated\r\n        for (const vehicleUuid of linkedVehicles) {\r\n          try {\r\n            // Find vehicle in game.actors (should be available at 'ready' hook)\r\n            let vehicleActor = (game.actors as any).find((actor: any) => actor.uuid === vehicleUuid);\r\n            \r\n            // If not found by UUID, try by ID\r\n            if (!vehicleActor) {\r\n              const uuidParts = vehicleUuid.split('.');\r\n              if (uuidParts.length >= 3) {\r\n                const actorId = uuidParts[uuidParts.length - 1];\r\n                vehicleActor = (game.actors as any).get(actorId);\r\n              }\r\n            }\r\n            \r\n            // If vehicle found and it's a vehicle type, ensure its cost is calculated\r\n            if (vehicleActor && vehicleActor.type === 'vehicle') {\r\n              // Trigger prepareDerivedData on vehicle if not already calculated\r\n              if (vehicleActor.system && (vehicleActor.system as any).prepareDerivedData) {\r\n                (vehicleActor.system as any).prepareDerivedData();\r\n              }\r\n            }\r\n          } catch (error) {\r\n            console.debug(`Vehicle ${vehicleUuid} not found in game.actors (may be in compendium)`);\r\n          }\r\n        }\r\n        \r\n        // Now trigger prepareDerivedData on character to recalculate cost with vehicles\r\n        try {\r\n          if (charActor.system && (charActor.system as any).prepareDerivedData) {\r\n            (charActor.system as any).prepareDerivedData();\r\n          }\r\n        } catch (error) {\r\n          console.debug(`Failed to recalculate cost for character ${charActor.name}:`, error);\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Hook to update character sheets when linked vehicles are updated\r\n    Hooks.on('updateActor', (actor: any, updateData: any, options: any, userId: string) => {\r\n      // DEBUG: Log all actor updates\r\n      console.log('Hook updateActor - DEBUG:', {\r\n        'actor.id': actor?.id,\r\n        'actor.name': actor?.name,\r\n        'actor.type': actor?.type,\r\n        'updateData keys': updateData ? Object.keys(updateData) : 'no updateData',\r\n        'updateData.system keys': updateData?.system ? Object.keys(updateData.system) : 'no system'\r\n      });\r\n      \r\n      // Only process vehicle actors\r\n      if (actor.type !== 'vehicle') return;\r\n      \r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n        \r\n        // DEBUG: Log which character sheets will be re-rendered\r\n        if (characterActors.length > 0) {\r\n          console.log('Hook updateActor - Re-rendering character sheets:', {\r\n            'vehicle.id': actor.id,\r\n            'vehicle.name': actor.name,\r\n            'characterCount': characterActors.length,\r\n            'characters': characterActors.map((c: any) => ({ id: c.id, name: c.name }))\r\n          });\r\n        }\r\n        \r\n        // Re-render character sheets that have this vehicle linked\r\n        // Use a small delay to ensure derived data is recalculated\r\n        setTimeout(() => {\r\n          characterActors.forEach((char: any) => {\r\n            if (char.sheet && char.sheet.rendered) {\r\n              char.sheet.render(false);\r\n            }\r\n          });\r\n        }, 100);\r\n      }\r\n    });\r\n\r\n    // Hook to update character sheets when items are created/deleted on linked vehicles\r\n    // This ensures the cost is recalculated when weapons are added/removed\r\n    Hooks.on('createItem', (item: any, options: any, userId: string) => {\r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'vehicle') return;\r\n\r\n      // Check if this is a weapon item\r\n      const featType = item.system?.featType;\r\n      if (featType !== 'weapon' && featType !== 'weapons-spells') return;\r\n\r\n      // Force vehicle to recalculate its cost first\r\n      if (actor.system) {\r\n        (actor.system as any).prepareDerivedData();\r\n      }\r\n\r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n\r\n        // Force recalculation of derived data and re-render character sheets\r\n        characterActors.forEach((char: any) => {\r\n          // Force prepareDerivedData to recalculate\r\n          if (char.system) {\r\n            (char.system as any).prepareDerivedData();\r\n          }\r\n          if (char.sheet && char.sheet.rendered) {\r\n            setTimeout(() => {\r\n              char.sheet.render(false);\r\n            }, 100);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    Hooks.on('deleteItem', (item: any, options: any, userId: string) => {\r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'vehicle') return;\r\n\r\n      // Check if this was a weapon item\r\n      const featType = item.system?.featType;\r\n      if (featType !== 'weapon' && featType !== 'weapons-spells') return;\r\n\r\n      // Force vehicle to recalculate its cost first\r\n      if (actor.system) {\r\n        (actor.system as any).prepareDerivedData();\r\n      }\r\n\r\n      // Find all character actors that have this vehicle linked\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n\r\n        // Force recalculation of derived data and re-render character sheets\r\n        characterActors.forEach((char: any) => {\r\n          // Force prepareDerivedData to recalculate\r\n          if (char.system) {\r\n            (char.system as any).prepareDerivedData();\r\n          }\r\n          if (char.sheet && char.sheet.rendered) {\r\n            setTimeout(() => {\r\n              char.sheet.render(false);\r\n            }, 100);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    // Hook to automatically add linked skill when a specialization is created\r\n    Hooks.on('createItem', async (item: any, options: any, userId: string) => {\r\n      // Only process specializations on character actors\r\n      if (item.type !== 'specialization') return;\r\n      \r\n      const actor = item.parent;\r\n      if (!actor || actor.type !== 'character') return;\r\n\r\n      // Get the linked skill name from the specialization\r\n      const linkedSkillName = item.system?.linkedSkill;\r\n      if (!linkedSkillName) return;\r\n\r\n      // Check if the skill already exists on the actor\r\n      const existingSkill = SheetHelpers.findSkillByName(actor, linkedSkillName);\r\n      if (existingSkill) {\r\n        // Skill already exists, nothing to do\r\n        return;\r\n      }\r\n\r\n      // Try to find the skill in game.items\r\n      const skillTemplate = SheetHelpers.findItemInGame('skill', linkedSkillName);\r\n      \r\n      if (skillTemplate) {\r\n        // Skill found in game.items, create it on the actor\r\n        try {\r\n          await actor.createEmbeddedDocuments('Item', [skillTemplate.toObject()]);\r\n          console.log(SYSTEM.LOG.HEAD + `Auto-added linked skill \"${linkedSkillName}\" for specialization \"${item.name}\"`);\r\n        } catch (error) {\r\n          console.error(SYSTEM.LOG.HEAD + `Error auto-adding skill \"${linkedSkillName}\":`, error);\r\n        }\r\n      } else {\r\n        // Skill not found in game.items, create a new one with default values\r\n        // Use the linkedAttribute from the specialization\r\n        const linkedAttribute = item.system?.linkedAttribute || 'strength';\r\n        const skillData = {\r\n          name: linkedSkillName,\r\n          type: 'skill',\r\n          system: {\r\n            rating: 0,\r\n            linkedAttribute: linkedAttribute,\r\n            description: '',\r\n            bookmarked: false\r\n          }\r\n        };\r\n        \r\n        try {\r\n          await actor.createEmbeddedDocuments('Item', [skillData]);\r\n          console.log(SYSTEM.LOG.HEAD + `Auto-created linked skill \"${linkedSkillName}\" for specialization \"${item.name}\"`);\r\n        } catch (error) {\r\n          console.error(SYSTEM.LOG.HEAD + `Error auto-creating skill \"${linkedSkillName}\":`, error);\r\n        }\r\n      }\r\n    });\r\n    \r\n    // Also handle when vehicle is deleted\r\n    Hooks.on('deleteActor', (actor: any, options: any, userId: string) => {\r\n      // Only process vehicle actors\r\n      if (actor.type !== 'vehicle') return;\r\n      \r\n      // Find all character actors that have this vehicle linked and remove it\r\n      if (game.actors) {\r\n        const vehicleUuid = actor.uuid;\r\n        const characterActors = (game.actors as any).filter((char: any) => {\r\n          if (char.type !== 'character') return false;\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          return linkedVehicles.includes(vehicleUuid);\r\n        });\r\n        \r\n        // Remove the vehicle from linked vehicles and re-render\r\n        characterActors.forEach(async (char: any) => {\r\n          const linkedVehicles = (char.system as any)?.linkedVehicles || [];\r\n          const updatedLinkedVehicles = linkedVehicles.filter((uuid: string) => uuid !== vehicleUuid);\r\n          await char.update({ 'system.linkedVehicles': updatedLinkedVehicles });\r\n          \r\n          if (char.sheet && char.sheet.rendered) {\r\n            char.sheet.render(false);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Register feat sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.FeatSheet, {\r\n      types: [\"feat\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.FEAT\"\r\n    });\r\n    \r\n    // Register skill sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SkillSheet, {\r\n      types: [\"skill\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.SKILL\"\r\n    });\r\n    \r\n    // Register specialization sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SpecializationSheet, {\r\n      types: [\"specialization\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.SPECIALIZATION\"\r\n    });\r\n    \r\n    // Register metatype sheet\r\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.MetatypeSheet, {\r\n      types: [\"metatype\"],\r\n      makeDefault: true,\r\n      label: \"SRA2.SHEET.METATYPE\"\r\n    });\r\n    \r\n    // Register Handlebars helpers\r\n    Handlebars.registerHelper('add', function(a: number, b: number) {\r\n      return a + b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('eq', function(a: any, b: any) {\r\n      return a === b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('gt', function(a: any, b: any) {\r\n      return a > b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('gte', function(a: any, b: any) {\r\n      return a >= b;\r\n    });\r\n    \r\n    Handlebars.registerHelper('concat', function(...args: any[]) {\r\n      // Remove the last argument which is the Handlebars options object\r\n      const values = args.slice(0, -1);\r\n      return values.join('');\r\n    });\r\n    \r\n    Handlebars.registerHelper('uppercase', function(str: string) {\r\n      return str ? str.toUpperCase() : '';\r\n    });\r\n    \r\n    // Helper to check if a dice result is a success based on roll mode\r\n    Handlebars.registerHelper('isSuccess', function(result: number, rollMode: string) {\r\n      if (rollMode === 'advantage') {\r\n        return result >= 4;\r\n      } else if (rollMode === 'disadvantage') {\r\n        return result === 6;\r\n      } else {\r\n        return result >= 5;\r\n      }\r\n    });\r\n    \r\n    // Helper to multiply two numbers\r\n    Handlebars.registerHelper('multiply', function(a: number, b: number) {\r\n      return a * b;\r\n    });\r\n    \r\n    // Helper to check if two values are not equal\r\n    Handlebars.registerHelper('ne', function(a: any, b: any) {\r\n      return a !== b;\r\n    });\r\n    \r\n    // Helper to stringify JSON\r\n    Handlebars.registerHelper('json', function(context: any) {\r\n      return JSON.stringify(context);\r\n    });\r\n    \r\n    // Register chat message hook for apply damage buttons\r\n    Hooks.on('renderChatMessage', (message: any, html: any) => {\r\n      // Remove existing handlers first to prevent duplicates\r\n      html.find('.apply-damage-button').off('click');\r\n      \r\n      html.find('.apply-damage-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        event.stopImmediatePropagation(); // Prevent other handlers from executing\r\n        \r\n        const button = $(event.currentTarget);\r\n        \r\n        // Check if button is already disabled to prevent double-clicks\r\n        if (button.prop('disabled')) {\r\n          return;\r\n        }\r\n        \r\n        // Template uses data-target-uuid, not data-defender-uuid\r\n        const targetUuid = button.data('target-uuid') || button.data('defender-uuid');\r\n        const damage = parseInt(button.data('damage')) || 0;\r\n        const targetName = button.data('target-name') || button.data('defender-name');\r\n        const damageType = (button.data('damage-type') || 'physical') as 'physical' | 'mental';\r\n        \r\n        if (!targetUuid) {\r\n          console.error('Apply damage button: No target UUID found in button data attributes');\r\n          ui.notifications?.error('Impossible de trouver la cible pour appliquer les dégâts');\r\n          return;\r\n        }\r\n        \r\n        if (damage <= 0) {\r\n          ui.notifications?.info('Aucun dégât à appliquer');\r\n          return;\r\n        }\r\n        \r\n        // Disable button to prevent double-click\r\n        button.prop('disabled', true);\r\n        \r\n        console.log('Apply damage button clicked:', { targetUuid, targetName, damage, damageType });\r\n        \r\n        try {\r\n          await CombatHelpers.applyDamage(targetUuid, damage, targetName, damageType);\r\n        } catch (error) {\r\n          console.error('Error applying damage:', error);\r\n          ui.notifications?.error('Erreur lors de l\\'application des dégâts');\r\n        } finally {\r\n          // Re-enable button after a short delay\r\n          setTimeout(() => button.prop('disabled', false), 1000);\r\n        }\r\n      });\r\n\r\n      // Defense button handler - remove existing handlers first to prevent duplicates\r\n      html.find('.defend-button').off('click');\r\n      \r\n      html.find('.defend-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        \r\n        // Get data from message flags (more reliable)\r\n        const messageFlags = message.flags?.sra2;\r\n        if (!messageFlags) {\r\n          console.error('Missing message flags');\r\n          return;\r\n        }\r\n\r\n        const rollResult = messageFlags.rollResult;\r\n        const rollData = messageFlags.rollData;\r\n        \r\n        if (!rollResult || !rollData) {\r\n          console.error('Missing roll data in message flags');\r\n          return;\r\n        }\r\n\r\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\r\n        let attackerToken: any = null;\r\n        let defenderToken: any = null;\r\n        let attacker: any = null;\r\n        let defender: any = null;\r\n        \r\n        // Log all flags for debugging\r\n        console.log('=== DEFENSE BUTTON - MESSAGE FLAGS ===');\r\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\r\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\r\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\r\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\r\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\r\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\r\n        console.log('======================================');\r\n        \r\n        // Use attacker UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\r\n        if (messageFlags.attackerUuid) {\r\n          try {\r\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\r\n            if (attacker) {\r\n              console.log('Defense button: Attacker loaded directly from attackerUuid flag:', messageFlags.attackerUuid);\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load attacker from attackerUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get attacker token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.attackerTokenUuid) {\r\n          try {\r\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\r\n            if (attackerToken?.actor && !attacker) {\r\n              // Use token's actor if attacker not loaded yet\r\n              attacker = attackerToken.actor;\r\n              console.log('Defense button: Attacker loaded from attackerTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load attacker token from attackerTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!attacker) {\r\n          if (messageFlags.attackerId) {\r\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\r\n          }\r\n          \r\n          if (attacker && !attackerToken) {\r\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n        \r\n        // Check if this is a vehicle weapon attack\r\n        const isVehicleWeapon = rollData.isVehicleWeapon;\r\n        const vehicleUuid = rollData.vehicleUuid;\r\n        \r\n        // For vehicle weapons, prioritize selected targets over flags to avoid using the drone as defender\r\n        // The defender should be the target, not the vehicle/drone itself\r\n        const selectedTargets = Array.from(game.user?.targets || []);\r\n        if (isVehicleWeapon && selectedTargets.length > 0) {\r\n          // Use the first selected target as defender (not the drone)\r\n          defenderToken = selectedTargets[0];\r\n          if (defenderToken?.actor) {\r\n            defender = defenderToken.actor;\r\n            console.log('Defense button: For vehicle weapon, using selected target as defender:', defender?.name);\r\n          }\r\n        }\r\n        \r\n        // Use defender UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\r\n        // Skip if we already have a defender from selected targets for vehicle weapons\r\n        if (!defender && messageFlags.defenderUuid) {\r\n          try {\r\n            const defenderFromUuid = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderFromUuid) {\r\n              if (isVehicleWeapon && vehicleUuid && defenderFromUuid.uuid === vehicleUuid) {\r\n                console.log('Defense button: Skipping vehicle as defender for vehicle weapon - need target instead');\r\n              } else {\r\n                defender = defenderFromUuid;\r\n                console.log('Defense button: Defender loaded directly from defenderUuid flag');\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load defender from defenderUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get defender token from UUID if available (priority: flag > canvas search)\r\n        // Skip if we already have a defender from selected targets for vehicle weapons\r\n        if (!defenderToken && messageFlags.defenderTokenUuid) {\r\n          try {\r\n            const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderTokenFromUuid) {\r\n              if (isVehicleWeapon && vehicleUuid) {\r\n                const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || undefined;\r\n                if (tokenActorUuid === vehicleUuid) {\r\n                  console.log('Defense button: Skipping vehicle token as defender for vehicle weapon - need target instead');\r\n                } else {\r\n                  defenderToken = defenderTokenFromUuid;\r\n                  if (defenderToken?.actor && !defender) {\r\n                    defender = defenderToken.actor;\r\n                    console.log('Defense button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n                  }\r\n                }\r\n              } else {\r\n                defenderToken = defenderTokenFromUuid;\r\n                if (defenderToken?.actor && !defender) {\r\n                  defender = defenderToken.actor;\r\n                  console.log('Defense button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n                }\r\n              }\r\n            }\r\n          } catch (e) {\r\n            console.warn('Defense button: Failed to load defender token from defenderTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!defender) {\r\n          if (messageFlags.defenderId) {\r\n            const defenderFromId = game.actors?.get(messageFlags.defenderId) || null;\r\n            // For vehicle weapons, skip if this is the vehicle itself\r\n            if (defenderFromId) {\r\n              if (isVehicleWeapon && vehicleUuid && defenderFromId.uuid === vehicleUuid) {\r\n                console.log('Defense button: Skipping vehicle as defender for vehicle weapon - need target instead');\r\n              } else {\r\n                defender = defenderFromId;\r\n              }\r\n            }\r\n          }\r\n          \r\n          if (defender && !defenderToken) {\r\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n\r\n        // Extract information - use UUIDs directly from flags as they are already correctly calculated\r\n        const success = rollResult.totalSuccesses || 0;\r\n        const damage = rollData.damageValue || 0;\r\n        const attackerName = attacker?.name || 'Unknown';\r\n        const attackerId = attacker?.id || messageFlags.attackerId || 'Unknown';\r\n        const attackerUuid = messageFlags.attackerUuid || attacker?.uuid || 'Unknown'; // Use flag UUID first (already calculated correctly)\r\n        const defenderName = defender?.name || 'Unknown';\r\n        const defenderId = defender?.id || messageFlags.defenderId || 'Unknown';\r\n        // For vehicle weapons, use the actual defender (target), not the vehicle/drone\r\n        // If we have a defender from selected targets, use it; otherwise use flag UUID\r\n        let defenderUuid = defender?.uuid || 'Unknown';\r\n        if (!defender || (isVehicleWeapon && vehicleUuid && defender.uuid === vehicleUuid)) {\r\n          // Fallback to flag UUID only if we don't have a valid defender\r\n          defenderUuid = messageFlags.defenderUuid || defender?.uuid || 'Unknown';\r\n        }\r\n        \r\n        // Log the UUIDs that will be used\r\n        console.log('--- UUIDs being used from flags ---');\r\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\r\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\r\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\r\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\r\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\r\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\r\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\r\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\r\n        const defenseSkill = rollData.linkedDefenseSkill || null;\r\n        const defenseSpec = rollData.linkedDefenseSpecialization || null;\r\n        const attackSkill = rollData.linkedAttackSkill || rollData.skillName || null;\r\n        const attackSpec = rollData.linkedAttackSpecialization || rollData.specName || null;\r\n\r\n        // Console log all information\r\n        console.log('=== DEFENSE CLICK ===');\r\n        console.log('Success:', success);\r\n        console.log('Damage:', damage);\r\n        console.log('Attacker:', attackerName);\r\n        console.log('Attacker ID:', attackerId);\r\n        console.log('Attacker UUID:', attackerUuid);\r\n        console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || 'Unknown');\r\n        console.log('Defender:', defenderName);\r\n        console.log('Defender ID:', defenderId);\r\n        console.log('Defender UUID:', defenderUuid);\r\n        console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || 'Unknown');\r\n        console.log('Skill de defense:', defenseSkill);\r\n        console.log('Spe de defense:', defenseSpec);\r\n        console.log('Skill d\\'attaque:', attackSkill);\r\n        console.log('Spe d\\'attaque:', attackSpec);\r\n        console.log('===================');\r\n\r\n        // Check if defender is a vehicle (vehicles use autopilot instead of defense skill)\r\n        const isVehicleDefender = defender?.type === 'vehicle';\r\n        \r\n        // Open defense roll dialog\r\n        if (!defender) {\r\n          console.error('Missing defender');\r\n          return;\r\n        }\r\n\r\n        // Get defender token from UUID (for NPCs, we need the token instance)\r\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\r\n        let defenderTokenForRoll: any = null;\r\n        let defenderActorForRoll: any = defender; // Default to defender actor\r\n        \r\n        // For vehicle weapons, use the defender we already found (which should be the target, not the drone)\r\n        if (isVehicleWeapon && defenderToken) {\r\n          defenderTokenForRoll = defenderToken;\r\n          if (defenderToken?.actor) {\r\n            defenderActorForRoll = defenderToken.actor;\r\n          }\r\n        } else {\r\n          const defenderTokenUuidFromFlags = messageFlags.defenderTokenUuid;\r\n          if (defenderTokenUuidFromFlags) {\r\n            try {\r\n              const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidFromFlags) || null;\r\n              // For vehicle weapons, skip if this is the vehicle itself\r\n              if (defenderTokenFromUuid) {\r\n                if (isVehicleWeapon && vehicleUuid) {\r\n                  const tokenActorUuid = defenderTokenFromUuid?.actor?.uuid || undefined;\r\n                  if (tokenActorUuid === vehicleUuid) {\r\n                    console.log('Defense: Skipping vehicle token as defender for vehicle weapon - using target instead');\r\n                    defenderTokenForRoll = defenderToken;\r\n                    if (defenderToken?.actor) {\r\n                      defenderActorForRoll = defenderToken.actor;\r\n                    }\r\n                  } else {\r\n                    defenderTokenForRoll = defenderTokenFromUuid;\r\n                    if (defenderTokenForRoll?.actor) {\r\n                      defenderActorForRoll = defenderTokenForRoll.actor;\r\n                    }\r\n                  }\r\n                } else {\r\n                  defenderTokenForRoll = defenderTokenFromUuid;\r\n                  if (defenderTokenForRoll?.actor) {\r\n                    defenderActorForRoll = defenderTokenForRoll.actor;\r\n                  }\r\n                }\r\n              }\r\n            } catch (e) {\r\n              // Fallback to finding token on canvas\r\n              defenderTokenForRoll = defenderToken;\r\n              if (defenderToken?.actor) {\r\n                defenderActorForRoll = defenderToken.actor;\r\n              }\r\n            }\r\n          } else {\r\n            defenderTokenForRoll = defenderToken;\r\n            if (defenderToken?.actor) {\r\n              defenderActorForRoll = defenderToken.actor;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Check if this is an ICE attack\r\n        const isIceAttack = messageFlags.rollType === 'ice-attack' || rollData.itemType === 'ice-attack';\r\n        \r\n        // Determine which skill/spec to use for defense\r\n        // Priority: 1) attack spec from weapon (if using weapon for defense), 2) defenseSpec if found, 3) defenseSkill if found, 4) fallback based on attack type\r\n        let finalDefenseSkill: string | null = null;\r\n        let finalDefenseSpec: string | null = null;\r\n        \r\n        // For ICE attacks, always use Piratage (cybercombat)\r\n        if (isIceAttack) {\r\n          finalDefenseSkill = 'Piratage';\r\n          // Try to find cybercombat specialization\r\n          const cybercombatSpec = defenderActorForRoll.items.find((item: any) => {\r\n            if (item.type !== 'specialization') return false;\r\n            const specSystem = item.system as any;\r\n            return item.name === 'Cybercombat' && specSystem.linkedSkill === 'Piratage';\r\n          });\r\n          if (cybercombatSpec) {\r\n            finalDefenseSpec = 'Cybercombat';\r\n          }\r\n        }\r\n        \r\n        // First, try to use the attack specialization from the weapon (if defending with a weapon)\r\n        // This allows using \"Lames\" specialization when defending with a short weapon\r\n        // Priority: use attack spec over defense spec when defending with a weapon\r\n        if (!isIceAttack && attackSpec) {\r\n          // Check if this attack spec exists in the defender's items and is linked to \"Combat rapproché\"\r\n          const spec = defenderActorForRoll.items.find((item: any) => {\r\n            if (item.type !== 'specialization') return false;\r\n            const specSystem = item.system as any;\r\n            return item.name === attackSpec && specSystem.linkedSkill === 'Combat rapproché';\r\n          });\r\n          if (spec) {\r\n            finalDefenseSpec = spec.name;\r\n            const specSystem = spec.system as any;\r\n            finalDefenseSkill = specSystem.linkedSkill;\r\n          }\r\n        }\r\n        \r\n        // Try to find the defense spec (from weapon's linkedDefenseSpecialization)\r\n        if (!finalDefenseSpec && defenseSpec) {\r\n          const spec = defenderActorForRoll.items.find((item: any) => \r\n            item.type === 'specialization' && item.name === defenseSpec\r\n          );\r\n          if (spec) {\r\n            finalDefenseSpec = defenseSpec;\r\n            const specSystem = spec.system as any;\r\n            const linkedSkillName = specSystem.linkedSkill;\r\n            finalDefenseSkill = linkedSkillName;\r\n          }\r\n        }\r\n        \r\n        // If spec not found, try to find the defense skill\r\n        if (!finalDefenseSpec && defenseSkill) {\r\n          const skill = defenderActorForRoll.items.find((item: any) => \r\n            item.type === 'skill' && item.name === defenseSkill\r\n          );\r\n          if (skill) {\r\n            finalDefenseSkill = defenseSkill;\r\n          }\r\n        }\r\n        \r\n        // Calculate skill/spec levels for defender (use token's actor for NPCs)\r\n        let defenseSkillLevel: number | undefined = undefined;\r\n        let defenseSpecLevel: number | undefined = undefined;\r\n        let defenseLinkedAttribute: string | undefined = undefined;\r\n\r\n        // For vehicles, use autopilot instead of defense skill\r\n        if (isVehicleDefender) {\r\n          // Vehicles use autopilot for defense\r\n          const autopilot = (defenderActorForRoll.system as any)?.attributes?.autopilot || 0;\r\n          finalDefenseSkill = 'Autopilot'; // Special skill name for vehicles\r\n          defenseSkillLevel = autopilot;\r\n          defenseLinkedAttribute = undefined; // Vehicles don't use attributes\r\n        } else {\r\n          // Fallback: determine based on attack type (melee or ranged)\r\n          if (!finalDefenseSkill) {\r\n            // Check if it's a melee attack (check meleeRange in rollData)\r\n            const isMeleeAttack = rollData.meleeRange && rollData.meleeRange !== 'none';\r\n            if (isMeleeAttack) {\r\n              finalDefenseSkill = 'Combat rapproché';\r\n            } else {\r\n              finalDefenseSkill = 'Athlétisme';\r\n            }\r\n          }\r\n\r\n          // Calculate skill/spec levels for defender\r\n          if (finalDefenseSpec) {\r\n            const spec = defenderActorForRoll.items.find((item: any) => \r\n              item.type === 'specialization' && item.name === finalDefenseSpec\r\n            );\r\n            if (spec) {\r\n              const specSystem = spec.system as any;\r\n              const linkedSkillName = specSystem.linkedSkill;\r\n              const linkedSkill = defenderActorForRoll.items.find((item: any) => \r\n                item.type === 'skill' && item.name === linkedSkillName\r\n              );\r\n              if (linkedSkill) {\r\n                const skillRating = (linkedSkill.system as any).rating || 0;\r\n                const specRating = specSystem.rating || 0;\r\n                defenseLinkedAttribute = specSystem.linkedAttribute || (linkedSkill.system as any).linkedAttribute || 'strength';\r\n                const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\r\n                \r\n                defenseSkillLevel = attributeValue + skillRating;\r\n                defenseSpecLevel = defenseSkillLevel + specRating;\r\n              }\r\n            }\r\n          } else if (finalDefenseSkill) {\r\n            const skill = defenderActorForRoll.items.find((item: any) => \r\n              item.type === 'skill' && item.name === finalDefenseSkill\r\n            );\r\n            if (skill) {\r\n              const skillSystem = skill.system as any;\r\n              const skillRating = skillSystem.rating || 0;\r\n              defenseLinkedAttribute = skillSystem.linkedAttribute || 'strength';\r\n              const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\r\n              \r\n              defenseSkillLevel = attributeValue + skillRating;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Final check: ensure we have a defense skill (or autopilot for vehicles)\r\n        if (!finalDefenseSkill && !isVehicleDefender) {\r\n          console.error('Could not determine defense skill for non-vehicle defender');\r\n          return;\r\n        }\r\n\r\n        // Get RR sources for defense skill/spec (use token's actor for NPCs)\r\n        // Note: Vehicles don't have RR sources for autopilot\r\n        const { getRRSources } = await import('./helpers/sheet-helpers.js');\r\n        let defenseRRList: any[] = [];\r\n        if (!isVehicleDefender) {\r\n          // Only get RR sources for non-vehicles\r\n          if (finalDefenseSpec) {\r\n            const rrSources = getRRSources(defenderActorForRoll, 'specialization', finalDefenseSpec);\r\n            defenseRRList = rrSources.map((rr: any) => ({\r\n              ...rr,\r\n              featName: rr.featName\r\n            }));\r\n          } else if (finalDefenseSkill) {\r\n            const rrSources = getRRSources(defenderActorForRoll, 'skill', finalDefenseSkill);\r\n            defenseRRList = rrSources.map((rr: any) => ({\r\n              ...rr,\r\n              featName: rr.featName\r\n            }));\r\n          }\r\n        }\r\n\r\n        // Get token UUIDs\r\n        // For defense: attacker = defender (one defending), defender = original attacker\r\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || messageFlags.attackerTokenUuid || undefined;\r\n        const defenderTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || messageFlags.defenderTokenUuid || undefined;\r\n        \r\n        // Prepare defense roll data\r\n        // In defense context:\r\n        // - attacker = defender (one defending) -> attackerTokenUuid should be defender's token\r\n        // - defender = original attacker -> defenderTokenUuid should be original attacker's token\r\n        const defenseRollData: any = {\r\n          // Use final defense skill/spec (with fallback)\r\n          skillName: finalDefenseSkill,\r\n          specName: finalDefenseSpec,\r\n          linkedAttribute: defenseLinkedAttribute,\r\n          skillLevel: defenseSkillLevel,\r\n          specLevel: defenseSpecLevel,\r\n          \r\n          // Actor is the defender - for vehicle weapons, use the actual defender (target) UUID, not the vehicle\r\n          actorId: defenderActorForRoll.id,\r\n          actorUuid: defenderActorForRoll.uuid, // Use the actual defender actor UUID (target, not drone)\r\n          \r\n          // Token UUIDs - for defense, attackerToken is the defender's token, defenderToken is the original attacker's token\r\n          attackerTokenUuid: defenderTokenUuid, // Defender's token (one defending) - this is what will be attacker in RollDialog\r\n          defenderTokenUuid: originalAttackerTokenUuid, // Original attacker's token (target) - this is what will be target/defender in RollDialog\r\n          \r\n          // RR List\r\n          rrList: defenseRRList,\r\n          \r\n          // Defense flags\r\n          isDefend: true,\r\n          isCounterAttack: false,\r\n          \r\n          // Store original attack roll data for comparison\r\n          attackRollResult: rollResult,\r\n          attackRollData: rollData\r\n        };\r\n\r\n        // Import and open RollDialog\r\n        const { RollDialog } = await import('./applications/roll-dialog.js');\r\n        const dialog = new RollDialog(defenseRollData);\r\n        \r\n        // Set target token to original attacker's token (in defense context, target = original attacker)\r\n        // For vehicle weapons, this should be the character's token (the one who attacked), not the drone\r\n        if (attackerToken) {\r\n          (dialog as any).targetToken = attackerToken;\r\n        }\r\n        \r\n        // For vehicle weapons, make sure we don't use the vehicle as target\r\n        // The target should be the character who attacked with the drone weapon\r\n        if (isVehicleWeapon && vehicleUuid) {\r\n          // Ensure targetToken is not the vehicle\r\n          if ((dialog as any).targetToken?.actor?.uuid === vehicleUuid) {\r\n            console.log('Defense: Target token is the vehicle, should be the character instead');\r\n            // Find the character's token (the original attacker)\r\n            const characterToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker?.id || token.actor?.uuid === attacker?.uuid;\r\n            }) || null;\r\n            if (characterToken) {\r\n              (dialog as any).targetToken = characterToken;\r\n            }\r\n          }\r\n        }\r\n        \r\n        dialog.render(true);\r\n      });\r\n\r\n      // Counter-attack button handler - remove existing handlers first to prevent duplicates\r\n      html.find('.counter-attack-button').off('click');\r\n      \r\n      html.find('.counter-attack-button').on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        \r\n        // Get data from message flags (more reliable)\r\n        const messageFlags = message.flags?.sra2;\r\n        if (!messageFlags) {\r\n          console.error('Missing message flags');\r\n          return;\r\n        }\r\n\r\n        const rollResult = messageFlags.rollResult;\r\n        const rollData = messageFlags.rollData;\r\n        \r\n        if (!rollResult || !rollData) {\r\n          console.error('Missing roll data in message flags');\r\n          return;\r\n        }\r\n\r\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\r\n        let attackerToken: any = null;\r\n        let defenderToken: any = null;\r\n        let attacker: any = null;\r\n        let defender: any = null;\r\n        \r\n        // Log all flags for debugging\r\n        console.log('=== COUNTER-ATTACK BUTTON - MESSAGE FLAGS ===');\r\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\r\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\r\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\r\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\r\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\r\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\r\n        console.log('==============================================');\r\n        \r\n        // Use attacker UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\r\n        if (messageFlags.attackerUuid) {\r\n          try {\r\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\r\n            if (attacker) {\r\n              console.log('Counter-attack button: Attacker loaded directly from attackerUuid flag');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load attacker from attackerUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get attacker token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.attackerTokenUuid) {\r\n          try {\r\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\r\n            if (attackerToken?.actor && !attacker) {\r\n              // Use token's actor if attacker not loaded yet\r\n              attacker = attackerToken.actor;\r\n              console.log('Counter-attack button: Attacker loaded from attackerTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load attacker token from attackerTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!attacker) {\r\n          if (messageFlags.attackerId) {\r\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\r\n          }\r\n          \r\n          if (attacker && !attackerToken) {\r\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n        \r\n        // Use defender UUID directly from flags (already correctly calculated)\r\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\r\n        if (messageFlags.defenderUuid) {\r\n          try {\r\n            defender = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\r\n            if (defender) {\r\n              console.log('Counter-attack button: Defender loaded directly from defenderUuid flag');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load defender from defenderUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Get defender token from UUID if available (priority: flag > canvas search)\r\n        if (messageFlags.defenderTokenUuid) {\r\n          try {\r\n            defenderToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\r\n            if (defenderToken?.actor && !defender) {\r\n              // Use token's actor if defender not loaded yet\r\n              defender = defenderToken.actor;\r\n              console.log('Counter-attack button: Defender loaded from defenderTokenUuid flag, using token actor');\r\n            }\r\n          } catch (e) {\r\n            console.warn('Counter-attack button: Failed to load defender token from defenderTokenUuid flag:', e);\r\n          }\r\n        }\r\n        \r\n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\r\n        if (!defender) {\r\n          if (messageFlags.defenderId) {\r\n            defender = game.actors?.get(messageFlags.defenderId) || null;\r\n          }\r\n          \r\n          if (defender && !defenderToken) {\r\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\r\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\r\n            }) || null;\r\n          }\r\n        }\r\n\r\n        // Log the UUIDs that will be used\r\n        console.log('--- UUIDs being used from flags (counter-attack) ---');\r\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\r\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\r\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\r\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\r\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\r\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\r\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\r\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\r\n        \r\n        // Open counter-attack roll dialog\r\n        if (!defender) {\r\n          console.error('Missing defender');\r\n          return;\r\n        }\r\n\r\n        // Get defender token from UUID (for NPCs, we need the token instance)\r\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\r\n        // Use defenderTokenUuid directly from flags (already correctly calculated)\r\n        let defenderTokenForRoll: any = null;\r\n        let defenderActorForRoll: any = defender; // Default to defender actor\r\n        \r\n        const defenderTokenUuidForCounter = messageFlags.defenderTokenUuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n        if (defenderTokenUuidForCounter) {\r\n          try {\r\n            defenderTokenForRoll = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidForCounter) || null;\r\n            // For NPCs, use the token's actor (which may be different from the base actor)\r\n            if (defenderTokenForRoll?.actor) {\r\n              defenderActorForRoll = defenderTokenForRoll.actor;\r\n            }\r\n          } catch (e) {\r\n            // Fallback to finding token on canvas\r\n            defenderTokenForRoll = defenderToken;\r\n            if (defenderToken?.actor) {\r\n              defenderActorForRoll = defenderToken.actor;\r\n            }\r\n          }\r\n        } else {\r\n          defenderTokenForRoll = defenderToken;\r\n          if (defenderToken?.actor) {\r\n            defenderActorForRoll = defenderToken.actor;\r\n          }\r\n        }\r\n\r\n        // Get all weapons from defender's items for counter-attack\r\n        // Get all items of type 'feat' with featType 'weapon' or 'weapons-spells'\r\n        const allWeapons = defenderActorForRoll.items.filter((item: any) => {\r\n          const isFeat = item.type === 'feat';\r\n          const isWeapon = item.system?.featType === 'weapon' || item.system?.featType === 'weapons-spells';\r\n          return isFeat && isWeapon;\r\n        });\r\n\r\n        // Import WEAPON_TYPES to check melee capability\r\n        const { WEAPON_TYPES } = await import('./models/item-feat.js');\r\n        \r\n        // Filter weapons that:\r\n        // 1. Have melee \"ok\" or \"disadvantage\"\r\n        // 2. Are linked to \"Combat rapproché\" skill or a specialization of \"Combat rapproché\"\r\n        const defenderWeapons = allWeapons.filter((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          const weaponType = weaponSystem.weaponType;\r\n          \r\n          // Check meleeRange in weapon system\r\n          const meleeRange = weaponSystem.meleeRange || 'none';\r\n          const hasMeleeInSystem = meleeRange === 'ok' || meleeRange === 'disadvantage';\r\n          \r\n          // Check melee in weapon type\r\n          let hasMeleeInType = false;\r\n          if (weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats && weaponStats.melee) {\r\n              hasMeleeInType = weaponStats.melee === 'ok' || weaponStats.melee === 'disadvantage';\r\n            }\r\n          }\r\n          \r\n          // Must have melee capability\r\n          if (!hasMeleeInSystem && !hasMeleeInType) {\r\n            return false;\r\n          }\r\n          \r\n          // Get linked attack skill\r\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\r\n\r\n          // If no linkedAttackSkill, try to get it from weapon type\r\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats) {\r\n              linkedAttackSkill = weaponStats.linkedSkill;\r\n            }\r\n          }\r\n          \r\n          // Must be linked to \"Combat rapproché\" skill\r\n          if (linkedAttackSkill === 'Combat rapproché') {\r\n            return true;\r\n          }\r\n          \r\n          // Check if weapon has a specialization linked to \"Combat rapproché\"\r\n          // Look for specializations linked to \"Combat rapproché\" in the actor's items\r\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \r\n            item.type === 'specialization' && \r\n            item.system.linkedSkill === 'Combat rapproché'\r\n          );\r\n          \r\n          // Check if weapon's linkedAttackSkill matches any specialization name\r\n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\r\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSkill\r\n            );\r\n            if (hasCombatRapprocheSpec) {\r\n              return true;\r\n            }\r\n          }\r\n          \r\n          // Also check weapon's linkedAttackSpecialization\r\n          const linkedAttackSpecialization = weaponSystem.linkedAttackSpecialization;\r\n          if (linkedAttackSpecialization) {\r\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSpecialization\r\n            );\r\n            if (hasCombatRapprocheSpec) {\r\n              return true;\r\n            }\r\n          }\r\n          \r\n          return false;\r\n        });\r\n\r\n        console.log('Counter-attack: Filtered weapons with melee capability:', defenderWeapons.length, defenderWeapons.map((w: any) => ({\r\n          name: w.name,\r\n          meleeRange: w.system?.meleeRange,\r\n          weaponType: w.system?.weaponType,\r\n          meleeInType: w.system?.weaponType ? WEAPON_TYPES[w.system.weaponType as keyof typeof WEAPON_TYPES]?.melee : null\r\n        })));\r\n\r\n        if (defenderWeapons.length === 0) {\r\n          console.error('Counter-attack: No weapons with melee capability. All items:', defenderActorForRoll.items.map((i: any) => ({\r\n            name: i.name,\r\n            type: i.type,\r\n            featType: i.system?.featType,\r\n            meleeRange: i.system?.meleeRange,\r\n            weaponType: i.system?.weaponType\r\n          })));\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPONS') || 'Aucune arme disponible pour la contre-attaque');\r\n          return;\r\n        }\r\n\r\n        // Prepare available weapons data for RollDialog\r\n        const availableWeapons = defenderWeapons.map((weapon: any) => {\r\n          const weaponSystem = weapon.system as any;\r\n          const weaponType = weaponSystem.weaponType;\r\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\r\n          \r\n          // If no linkedAttackSkill, try to get it from weapon type\r\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\r\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\r\n            if (weaponStats) {\r\n              linkedAttackSkill = weaponStats.linkedSkill;\r\n            }\r\n        }\r\n\r\n          // Check if linkedAttackSkill is a specialization of \"Combat rapproché\"\r\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \r\n            item.type === 'specialization' && \r\n            item.system.linkedSkill === 'Combat rapproché'\r\n          );\r\n          \r\n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\r\n            const isCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \r\n              spec.name === linkedAttackSkill\r\n            );\r\n            if (isCombatRapprocheSpec) {\r\n              // Keep the specialization name, but the skill is \"Combat rapproché\"\r\n              // We'll use this in the weapon selection to show both\r\n            } else if (linkedAttackSkill !== 'Combat rapproché') {\r\n              // Not a specialization of Combat rapproché, use \"Combat rapproché\" as base skill\r\n              linkedAttackSkill = 'Combat rapproché';\r\n            }\r\n          } else {\r\n            // Default to \"Combat rapproché\" if still no skill\r\n            linkedAttackSkill = 'Combat rapproché';\r\n          }\r\n          \r\n          // Get weapon stats from WEAPON_TYPES if weapon type exists\r\n          const weaponStats = weaponType && weaponType !== 'custom-weapon' \r\n            ? WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES] \r\n            : undefined;\r\n          \r\n          return {\r\n            id: weapon.id,\r\n            name: weapon.name,\r\n            linkedAttackSkill: linkedAttackSkill,\r\n            damageValue: weaponSystem.damageValue || '0',\r\n            damageValueBonus: weaponSystem.damageValueBonus || 0,\r\n            weaponType: weaponType,\r\n            meleeRange: weaponSystem.meleeRange || weaponStats?.melee || 'none',\r\n            shortRange: weaponSystem.shortRange || weaponStats?.short || 'none',\r\n            mediumRange: weaponSystem.mediumRange || weaponStats?.medium || 'none',\r\n            longRange: weaponSystem.longRange || weaponStats?.long || 'none'\r\n          };\r\n        });\r\n\r\n        // Get token UUIDs\r\n        const counterAttackerTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\r\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\r\n        \r\n        // Prepare counter-attack roll data with available weapons\r\n        // Use UUIDs directly from flags (already correctly calculated)\r\n        const counterAttackRollData: any = {\r\n          // Actor is the defender - use UUID directly from flags (already correctly calculated)\r\n          actorId: defenderActorForRoll.id,\r\n          actorUuid: messageFlags.defenderUuid || defenderActorForRoll.uuid, // Use flag UUID first\r\n          \r\n          // Token UUIDs - for counter-attack, the defender becomes the attacker\r\n          // Use UUIDs directly from flags (already correctly calculated)\r\n          attackerTokenUuid: messageFlags.defenderTokenUuid || counterAttackerTokenUuid, // Token of the defender (who is counter-attacking)\r\n          defenderTokenUuid: messageFlags.attackerTokenUuid || originalAttackerTokenUuid, // Token of the original attacker\r\n          \r\n          // Available weapons for selection\r\n          availableWeapons: availableWeapons,\r\n          \r\n          // Counter-attack flags\r\n          isDefend: false,\r\n          isCounterAttack: true,\r\n          \r\n          // Store original attack roll data for comparison\r\n          attackRollResult: rollResult,\r\n          attackRollData: rollData\r\n        };\r\n\r\n        // Import and open RollDialog\r\n        const { RollDialog } = await import('./applications/roll-dialog.js');\r\n        const dialog = new RollDialog(counterAttackRollData);\r\n        \r\n        // Note: targetToken should already be loaded from defenderTokenUuid in RollDialog constructor\r\n        // Only set it manually if it wasn't loaded from UUID (fallback)\r\n        if (attackerToken && !(dialog as any).targetToken) {\r\n          (dialog as any).targetToken = attackerToken;\r\n        }\r\n        \r\n        dialog.render(true);\r\n      });\r\n    });\r\n    \r\n    // Register token context menu hook for bookmarks/favorites\r\n    (Hooks as any).on('getTokenHUDOptions', (_hud: any, buttons: any[], token: any) => {\r\n      const actor = token.actor;\r\n      if (!actor) return;\r\n      \r\n      // Get bookmarked items\r\n      const bookmarkedItems = actor.items.filter((i: any) => \r\n        (i.type === 'skill' || i.type === 'feat') && i.system.bookmarked\r\n      );\r\n      \r\n      if (bookmarkedItems.length > 0) {\r\n        buttons.unshift({\r\n          name: 'SRA2_BOOKMARKS',\r\n          title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE'),\r\n          icon: 'fa-solid fa-star',\r\n          button: true,\r\n          onclick: () => {\r\n            // Show bookmarks dialog\r\n            this.showBookmarksDialog(actor);\r\n          }\r\n        });\r\n      }\r\n    });\r\n    \r\n    // Function to add roll dice button to chat\r\n    const addRollDiceButton = () => {\r\n      // Find the chat message input form in the DOM\r\n      const chatForm = $('.chat-form');\r\n      if (chatForm.length === 0) {\r\n        return false;\r\n      }\r\n      \r\n      // Check if button already exists to avoid duplicates\r\n      if (chatForm.find('.sra2-roll-dice-container').length > 0) {\r\n        return true;\r\n      }\r\n      \r\n      // Create the roll dice container with inputs and radio\r\n      const rollDiceContainer = $(`\r\n        <div class=\"sra2-roll-dice-container\">\r\n          <div class=\"sra2-roll-dice-inputs\">\r\n            <input type=\"text\" value=\"3\" class=\"sra2-dice-count-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.DICE_COUNT')}\" title=\"${game.i18n!.localize('SRA2.CHAT.DICE_COUNT')}\">\r\n            <input type=\"text\" value=\"0\" class=\"sra2-risk-dice-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.RISK_DICE')}\" title=\"${game.i18n!.localize('SRA2.CHAT.RISK_DICE')}\">\r\n            <input type=\"text\" value=\"\" class=\"sra2-rr-input\" placeholder=\"${game.i18n!.localize('SRA2.CHAT.RR')} 0\" title=\"${game.i18n!.localize('SRA2.CHAT.RR')}\">\r\n            <div class=\"sra2-roll-mode-radio\">\r\n              <label class=\"sra2-radio-advantage\" title=\"${game.i18n!.localize('SRA2.CHAT.ADVANTAGE')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"advantage\">\r\n                <span>A</span>\r\n              </label>\r\n              <label class=\"sra2-radio-normal\" title=\"${game.i18n!.localize('SRA2.CHAT.NORMAL')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"normal\" checked>\r\n                <span>N</span>\r\n              </label>\r\n              <label class=\"sra2-radio-disadvantage\" title=\"${game.i18n!.localize('SRA2.CHAT.DISADVANTAGE')}\">\r\n                <input type=\"radio\" name=\"sra2-roll-mode\" value=\"disadvantage\">\r\n                <span>D</span>\r\n              </label>\r\n            </div>\r\n          </div>\r\n          <button type=\"button\" class=\"sra2-roll-dice-button\" title=\"${game.i18n!.localize('SRA2.CHAT.ROLL_DICE')}\">\r\n            <i class=\"fas fa-dice-d6\"></i> ${game.i18n!.localize('SRA2.CHAT.ROLL_DICE')}\r\n          </button>\r\n        </div>\r\n      `);\r\n      \r\n      // Insert container as first element in .chat-form\r\n      chatForm.prepend(rollDiceContainer);\r\n      \r\n      // Add click handler to button\r\n      const rollDiceButton = rollDiceContainer.find('.sra2-roll-dice-button');\r\n      rollDiceButton.on('click', async (event: any) => {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        \r\n        // Get controlled actor (first controlled token's actor, or first owned actor)\r\n        let actor: any = null;\r\n        const controlledTokens = canvas?.tokens?.controlled || [];\r\n        \r\n        if (controlledTokens.length > 0) {\r\n          actor = controlledTokens[0].actor;\r\n        } else {\r\n          // Fallback: get first owned actor\r\n          const ownedActors = (game.actors as any).filter((a: any) => a.isOwner);\r\n          if (ownedActors.length > 0) {\r\n            actor = ownedActors[0];\r\n          }\r\n        }\r\n        \r\n        if (!actor) {\r\n          ui.notifications?.warn(game.i18n!.localize('SRA2.CHAT.NO_ACTOR') || 'Aucun personnage contrôlé');\r\n          return;\r\n        }\r\n        \r\n        // Get values from inputs and radio\r\n        const diceCount = parseInt(rollDiceContainer.find('.sra2-dice-count-input').val() as string) || 0;\r\n        const riskDiceCount = parseInt(rollDiceContainer.find('.sra2-risk-dice-input').val() as string) || 0;\r\n        const rr = parseInt(rollDiceContainer.find('.sra2-rr-input').val() as string) || 0;\r\n        const rollMode = rollDiceContainer.find('input[name=\"sra2-roll-mode\"]:checked').val() as string || 'normal';\r\n        \r\n        if (diceCount <= 0) {\r\n          ui.notifications?.warn('Veuillez entrer un nombre de dés valide');\r\n          return;\r\n        }\r\n        \r\n        // Import dice roller functions\r\n        const DiceRoller = await import('./helpers/dice-roller.js');\r\n        const { getSuccessThreshold } = DiceRoller;\r\n        \r\n        // Use manual risk dice count, ensure it doesn't exceed total dice count\r\n        const finalRiskDiceCount = Math.min(riskDiceCount, diceCount);\r\n        const normalDiceCount = Math.max(0, diceCount - finalRiskDiceCount);\r\n        const finalRR = Math.min(3, Math.max(0, rr));\r\n        \r\n        // Roll dice\r\n        let normalRoll: any = null;\r\n        let riskRoll: any = null;\r\n        \r\n        if (normalDiceCount > 0) {\r\n          normalRoll = new Roll(`${normalDiceCount}d6`);\r\n          await normalRoll.evaluate();\r\n          \r\n          if ((game as any).dice3d && normalRoll) {\r\n            (game as any).dice3d.showForRoll(normalRoll, game.user, true, null, false);\r\n          }\r\n        }\r\n        \r\n        if (finalRiskDiceCount > 0) {\r\n          riskRoll = new Roll(`${finalRiskDiceCount}d6`);\r\n          await riskRoll.evaluate();\r\n          \r\n          if ((game as any).dice3d && riskRoll) {\r\n            const dice3dConfig = {\r\n              colorset: 'purple',\r\n              theme: 'default'\r\n            };\r\n            (game as any).dice3d.showForRoll(riskRoll, game.user, true, dice3dConfig, false);\r\n          }\r\n        }\r\n        \r\n        // Calculate results\r\n        const normalResults: number[] = normalRoll ? (normalRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n        const riskResults: number[] = riskRoll ? (riskRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\r\n        \r\n        const successThreshold = getSuccessThreshold(rollMode);\r\n        \r\n        // Calculate successes for normal dice\r\n        let normalSuccesses = 0;\r\n        for (const result of normalResults) {\r\n          if (result >= successThreshold) {\r\n            normalSuccesses++;\r\n          }\r\n        }\r\n        \r\n        // Calculate successes and critical failures for risk dice\r\n        let riskSuccesses = 0;\r\n        let criticalFailures = 0;\r\n        for (const result of riskResults) {\r\n          if (result === 1) {\r\n            criticalFailures++;\r\n          } else if (result >= successThreshold) {\r\n            riskSuccesses++;\r\n          }\r\n        }\r\n        \r\n        // Risk dice successes count double\r\n        const totalRiskSuccesses = riskSuccesses * 2;\r\n        const totalSuccesses = normalSuccesses + totalRiskSuccesses;\r\n        \r\n        // Calculate complications\r\n        const remainingFailures = Math.max(0, criticalFailures - finalRR);\r\n        \r\n        let complication: 'none' | 'minor' | 'critical' | 'disaster' = 'none';\r\n        if (remainingFailures === 1) {\r\n          complication = 'minor';\r\n        } else if (remainingFailures === 2) {\r\n          complication = 'critical';\r\n        } else if (remainingFailures >= 3) {\r\n          complication = 'disaster';\r\n        }\r\n        \r\n        const rollResult = {\r\n          normalDice: normalResults,\r\n          riskDice: riskResults,\r\n          normalSuccesses: normalSuccesses,\r\n          riskSuccesses: riskSuccesses,\r\n          totalSuccesses: totalSuccesses,\r\n          criticalFailures: criticalFailures,\r\n          finalRR: finalRR,\r\n          remainingFailures: remainingFailures,\r\n          complication: complication\r\n        };\r\n        \r\n        // Get actor token if available\r\n        const actorTokens = canvas?.tokens?.controlled || [];\r\n        const actorToken = actorTokens.length > 0 ? actorTokens[0] : null;\r\n        \r\n        // Create roll data for template\r\n        const rollData: any = {\r\n          dicePool: diceCount,\r\n          riskDiceCount: finalRiskDiceCount,\r\n          rollMode: rollMode,\r\n          finalRR: finalRR,\r\n          actorId: actor.id,\r\n          actorUuid: actor.uuid,\r\n          actorName: actor.name\r\n        };\r\n        \r\n        // Prepare template data\r\n        const templateData: any = {\r\n          attacker: actor,\r\n          defender: null,\r\n          rollData: rollData,\r\n          rollResult: rollResult,\r\n          isAttack: false,\r\n          isDefend: false,\r\n          isCounterAttack: false,\r\n          skillName: 'Jet de dés',\r\n          itemName: null,\r\n          damageValue: null,\r\n          defenseResult: null,\r\n          attackerUuid: actor.uuid,\r\n          defenderUuid: null,\r\n          attackerTokenUuid: (actorToken as any)?.uuid || (actorToken as any)?.document?.uuid,\r\n          defenderTokenUuid: null\r\n        };\r\n        \r\n        // Render template\r\n        const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\r\n        \r\n        // Create chat message\r\n        const messageData: any = {\r\n          user: game.user?.id,\r\n          speaker: {\r\n            actor: actor.id,\r\n            alias: actor.name\r\n          },\r\n          content: html,\r\n          type: CONST.CHAT_MESSAGE_TYPES.OTHER,\r\n          flags: {\r\n            sra2: {\r\n              rollType: 'skill',\r\n              attackerId: actor.id,\r\n              attackerUuid: actor.uuid,\r\n              attackerTokenUuid: (actorToken as any)?.uuid || (actorToken as any)?.document?.uuid,\r\n              rollResult: rollResult,\r\n              rollData: rollData\r\n            }\r\n          }\r\n        };\r\n        \r\n        await ChatMessage.create(messageData);\r\n      });\r\n      \r\n      return true;\r\n    };\r\n    \r\n    // Register chat log hook to add roll dice button\r\n    // Using a more generic approach that works with Foundry's hook system\r\n    Hooks.on('renderChatLog' as any, (app: any, html: any, data: any) => {\r\n      // Use setTimeout to ensure the chat form is fully rendered\r\n      setTimeout(() => {\r\n        if (!addRollDiceButton()) {\r\n          // If button wasn't added, try again after a longer delay\r\n          setTimeout(addRollDiceButton, 500);\r\n        }\r\n      }, 100);\r\n    });\r\n    \r\n    // Also register for chat popout\r\n    Hooks.on('renderChatPopout' as any, (app: any, html: any, data: any) => {\r\n      setTimeout(() => {\r\n        if (!addRollDiceButton()) {\r\n          setTimeout(addRollDiceButton, 500);\r\n        }\r\n      }, 100);\r\n    });\r\n    \r\n    // Use MutationObserver to watch for chat form appearance (more robust)\r\n    Hooks.once('ready', () => {\r\n      // Try immediately\r\n      addRollDiceButton();\r\n      \r\n      // Also set up a MutationObserver to watch for chat form\r\n      const observer = new MutationObserver(() => {\r\n        addRollDiceButton();\r\n      });\r\n      \r\n      // Observe the document body for changes\r\n      if (document.body) {\r\n        observer.observe(document.body, {\r\n          childList: true,\r\n          subtree: true\r\n        });\r\n      }\r\n    });\r\n    \r\n    Hooks.once(\"ready\", () => this.onReady());\r\n  }\r\n  \r\n  /**\r\n   * Show bookmarks/favorites dialog for quick actions\r\n   */\r\n  showBookmarksDialog(actor: any): void {\r\n    const bookmarkedSkills = actor.items.filter((i: any) => i.type === 'skill' && i.system.bookmarked);\r\n    const bookmarkedFeats = actor.items.filter((i: any) => i.type === 'feat' && i.system.bookmarked);\r\n    \r\n    let content = '<div class=\"sra2-bookmark-menu\">';\r\n    \r\n    if (bookmarkedSkills.length > 0) {\r\n      content += '<h3>' + game.i18n!.localize('SRA2.SKILLS.LABEL') + '</h3>';\r\n      content += '<div class=\"bookmark-list\">';\r\n      bookmarkedSkills.forEach((skill: any) => {\r\n        content += `<button class=\"bookmark-item\" data-item-id=\"${skill.id}\" data-item-type=\"skill\">\r\n          <i class=\"fas fa-dice-d6\"></i> ${skill.name}\r\n        </button>`;\r\n      });\r\n      content += '</div>';\r\n    }\r\n    \r\n    if (bookmarkedFeats.length > 0) {\r\n      content += '<h3>' + game.i18n!.localize('SRA2.FEATS.LABEL') + '</h3>';\r\n      content += '<div class=\"bookmark-list\">';\r\n      bookmarkedFeats.forEach((feat: any) => {\r\n        content += `<button class=\"bookmark-item\" data-item-id=\"${feat.id}\" data-item-type=\"feat\">\r\n          <i class=\"fas fa-scroll\"></i> ${feat.name}\r\n        </button>`;\r\n      });\r\n      content += '</div>';\r\n    }\r\n    \r\n    content += '</div>';\r\n    \r\n    new Dialog({\r\n      title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE') + ' - ' + actor.name,\r\n      content,\r\n      buttons: {\r\n        close: {\r\n          icon: '<i class=\"fas fa-times\"></i>',\r\n          label: game.i18n!.localize('Close')\r\n        }\r\n      },\r\n      render: (html: any) => {\r\n        html.find('.bookmark-item').on('click', async (event: any) => {\r\n          const itemId = $(event.currentTarget).data('item-id');\r\n          const item = actor.items.get(itemId);\r\n          if (!item) return;\r\n          \r\n          // Open item sheet\r\n          item.sheet?.render(true);\r\n        });\r\n      }\r\n    }, { width: 350 }).render(true);\r\n  }\r\n\r\n  /**\r\n   * Register the UI theme setting\r\n   */\r\n  registerThemeSetting(): void {\r\n    game.settings.register(SYSTEM.id, 'uiTheme', {\r\n      name: 'SRA2.SETTINGS.THEME.TITLE',\r\n      hint: 'SRA2.SETTINGS.THEME.DESC',\r\n      scope: 'client',\r\n      config: true,\r\n      type: String,\r\n      choices: () => {\r\n        return {\r\n          'sra2': game.i18n.localize('SRA2.SETTINGS.THEME.SRA2'),\r\n        };\r\n      },\r\n      default: 'sra2',\r\n      onChange: (value: string) => {\r\n        this.applyTheme(value);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Apply the selected theme to the body element\r\n   */\r\n  applyTheme(theme?: string): void {\r\n    if (!document.body) {\r\n      console.warn(SYSTEM.LOG.HEAD + 'Cannot apply theme: document.body is not available');\r\n      return;\r\n    }\r\n\r\n    // Get theme from setting if not provided\r\n    if (!theme) {\r\n      theme = game.settings.get(SYSTEM.id, 'uiTheme') as string || 'sra2';\r\n    }\r\n\r\n    // List of all possible theme classes\r\n    const themeClasses = ['sr-theme-sra2', 'sr-theme-sr6', 'sr-theme-sr5'];\r\n\r\n    // Remove all theme classes\r\n    document.body.classList.remove(...themeClasses);\r\n\r\n    // Add the selected theme class\r\n    const themeClass = `sr-theme-${theme}`;\r\n    document.body.classList.add(themeClass);\r\n\r\n    console.log(SYSTEM.LOG.HEAD + `Applied theme: ${themeClass}`);\r\n  }\r\n\r\n  async onReady(): Promise<void> {\r\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onReady');\r\n    \r\n    // Apply theme from setting\r\n    this.applyTheme();\r\n    \r\n    // Run migrations\r\n    const migrations = new Migrations();\r\n    migrations.migrate();\r\n    \r\n    // Migrate old feat data to new array format (deprecated, keeping for older versions)\r\n    await this.migrateFeatsToArrayFormat();\r\n    \r\n    // Migrate anarchyNimbus to anarchySpent\r\n    await this.migrateAnarchyNimbusToSpent();\r\n  }\r\n  \r\n  /**\r\n   * Migrate old feat data (single rrType/rrValue/rrTarget) to new array format\r\n   */\r\n  async migrateFeatsToArrayFormat(): Promise<void> {\r\n    const featsToUpdate: any[] = [];\r\n    \r\n    // Check all feats in the world\r\n    for (const item of game.items! as any) {\r\n      if ((item as any).type === 'feat') {\r\n        const system = (item as any).system as any;\r\n        let needsUpdate = false;\r\n        const updates: any = { _id: (item as any).id };\r\n        \r\n        // Check if rrType is not an array (old format)\r\n        if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\r\n          needsUpdate = true;\r\n          // Convert single value to array (only if not \"none\")\r\n          if (system.rrType !== 'none') {\r\n            updates['system.rrType'] = [system.rrType];\r\n            updates['system.rrValue'] = [system.rrValue || 0];\r\n            updates['system.rrTarget'] = [system.rrTarget || ''];\r\n          } else {\r\n            updates['system.rrType'] = [];\r\n            updates['system.rrValue'] = [];\r\n            updates['system.rrTarget'] = [];\r\n          }\r\n        }\r\n        \r\n        if (needsUpdate) {\r\n          featsToUpdate.push(updates);\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Check all feats on actors\r\n    for (const actor of game.actors! as any) {\r\n      const actorUpdates: any[] = [];\r\n      \r\n      for (const item of (actor as any).items) {\r\n        if ((item as any).type === 'feat') {\r\n          const system = (item as any).system as any;\r\n          let needsUpdate = false;\r\n          const updates: any = { _id: (item as any).id };\r\n          \r\n          // Check if rrType is not an array (old format)\r\n          if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\r\n            needsUpdate = true;\r\n            // Convert single value to array (only if not \"none\")\r\n            if (system.rrType !== 'none') {\r\n              updates['system.rrType'] = [system.rrType];\r\n              updates['system.rrValue'] = [system.rrValue || 0];\r\n              updates['system.rrTarget'] = [system.rrTarget || ''];\r\n            } else {\r\n              updates['system.rrType'] = [];\r\n              updates['system.rrValue'] = [];\r\n              updates['system.rrTarget'] = [];\r\n            }\r\n          }\r\n          \r\n          if (needsUpdate) {\r\n            actorUpdates.push(updates);\r\n          }\r\n        }\r\n      }\r\n      \r\n      if (actorUpdates.length > 0) {\r\n        console.log(`${SYSTEM.LOG.HEAD} Migrating ${actorUpdates.length} feats on actor ${(actor as any).name}`);\r\n        await (actor as any).updateEmbeddedDocuments('Item', actorUpdates);\r\n      }\r\n    }\r\n    \r\n    if (featsToUpdate.length > 0) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Migrating ${featsToUpdate.length} world feats`);\r\n      await Item.updateDocuments(featsToUpdate);\r\n    }\r\n    \r\n    if (featsToUpdate.length > 0 || (game.actors! as any).some((a: any) => a.items.some((i: any) => i.type === 'feat'))) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Feat migration to array format complete`);\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * Migrate anarchyNimbus to anarchySpent\r\n   */\r\n  async migrateAnarchyNimbusToSpent(): Promise<void> {\r\n    const actorsToUpdate: any[] = [];\r\n    \r\n    // Check all character actors in the world\r\n    for (const actor of game.actors! as any) {\r\n      if ((actor as any).type === 'character') {\r\n        const system = (actor as any).system as any;\r\n        \r\n        // Check if the old anarchyNimbus field exists\r\n        if (system.anarchyNimbus !== undefined && system.anarchySpent === undefined) {\r\n          actorsToUpdate.push({\r\n            _id: (actor as any).id,\r\n            'system.anarchySpent': system.anarchyNimbus\r\n          });\r\n        }\r\n      }\r\n    }\r\n    \r\n    if (actorsToUpdate.length > 0) {\r\n      console.log(`${SYSTEM.LOG.HEAD} Migrating anarchyNimbus to anarchySpent for ${actorsToUpdate.length} actors`);\r\n      await Actor.updateDocuments(actorsToUpdate);\r\n      console.log(`${SYSTEM.LOG.HEAD} anarchyNimbus to anarchySpent migration complete`);\r\n    }\r\n  }\r\n}\r\n\r\n","import { SYSTEM } from './system.ts';\r\n\r\n/**\r\n * Configure sidebar icons for Foundry VTT UI\r\n */\r\nexport function setSidebarIcons(): void {\r\n  CONFIG.Actor.sidebarIcon = 'fas fa-user';\r\n  CONFIG.Adventure.sidebarIcon = 'fas fa-tree';\r\n  CONFIG.Cards.sidebarIcon = 'fa-solid fa-cards';\r\n  CONFIG.ChatMessage.sidebarIcon = 'fas fa-comments';\r\n  CONFIG.Combat.sidebarIcon = 'fas fa-gun';\r\n  CONFIG.Folder.sidebarIcon = 'fas fa-folder';\r\n  CONFIG.Item.sidebarIcon = 'fas fa-suitcase';\r\n  CONFIG.JournalEntry.sidebarIcon = 'fas fa-book-open';\r\n  CONFIG.JournalEntryPage.sidebarIcon = 'fas fa-book-open';\r\n  CONFIG.Macro.sidebarIcon = 'fas fa-code';\r\n  CONFIG.Playlist.sidebarIcon = 'fas fa-music';\r\n  CONFIG.PlaylistSound.sidebarIcon = 'fas fa-music';\r\n  CONFIG.RollTable.sidebarIcon = 'fas fa-th-list';\r\n  CONFIG.Scene.sidebarIcon = 'fas fa-map';\r\n\r\n  console.log(SYSTEM.LOG.HEAD + 'Configured sidebar icons');\r\n}\r\n\r\n/**\r\n * Configure control icons for Foundry VTT tokens\r\n */\r\nexport function setControlIcons(): void {\r\n  CONFIG.controlIcons = {\r\n    combat: 'icons/svg/combat.svg',\r\n    visibility: 'icons/svg/cowled.svg',\r\n    effects: 'icons/svg/aura.svg',\r\n    lock: 'icons/svg/padlock.svg',\r\n    up: 'icons/svg/up.svg',\r\n    down: 'icons/svg/down.svg',\r\n    defeated: 'icons/svg/skull.svg',\r\n    light: 'icons/svg/light.svg',\r\n    lightOff: 'icons/svg/light-off.svg',\r\n    template: 'icons/svg/explosion.svg',\r\n    sound: 'icons/svg/sound-off.svg',\r\n    soundOff: 'icons/svg/combat.svg',\r\n    doorClosed: 'icons/svg/door-closed-outline.svg',\r\n    doorOpen: 'icons/svg/door-open-outline.svg',\r\n    doorSecret: 'icons/svg/door-secret-outline.svg',\r\n    doorLocked: 'icons/svg/door-locked-outline.svg'\r\n  };\r\n\r\n  console.log(SYSTEM.LOG.HEAD + 'Configured control icons');\r\n}\r\n\r\n/**\r\n * Configure compendium banners\r\n */\r\nexport function setCompendiumBanners(): void {\r\n  // Note: If you have a banner image, uncomment and adjust the path\r\n  // CONFIG.Actor.compendiumBanner = `${SYSTEM.PATH.ROOT}/img/interface/sra2/banner-actors.webp`;\r\n  \r\n  console.log(SYSTEM.LOG.HEAD + 'Configured compendium banners');\r\n}\r\n\r\n","import { SRA2System } from \"./module/sra2-system.ts\";\r\n\r\nSRA2System.start();\r\n\r\nimport \"./styles/global.scss\";\r\nimport \"./less/index.less\";\r\n\r\n"],"names":["SYSTEM_ID","SYSTEM","id","LOG","HEAD","SOCKET","PATH","ROOT","STYLE","TEMPLATES","ASSETS","CharacterDataModel","foundry","abstract","TypeDataModel","defineSchema","fields","data","attributes","SchemaField","strength","NumberField","required","initial","min","integer","agility","willpower","logic","charisma","resources","yens","anarchy","maxEssence","armorLevel","max","damage","light","ArrayField","BooleanField","severe","incapacitating","anarchySpent","bio","background","HTMLField","notes","keywords","keyword1","StringField","keyword2","keyword3","keyword4","keyword5","behaviors","behavior1","behavior2","behavior3","behavior4","catchphrases","catchphrase1","catchphrase2","catchphrase3","catchphrase4","linkedVehicles","label","reference","calculateAttributeCost","level","maxLevel","cost","i","prepareDerivedData","parent","this","attributeMaxes","anarchyBonus","items","metatype","find","item","type","system","maxStrength","maxAgility","maxWillpower","maxLogic","maxCharisma","bonusLightDamage","bonusSevereDamage","bonusPhysicalThreshold","bonusMentalThreshold","bonusAnarchy","totalEssenceCost","totalNarrations","narrationsDetails","filter","active","forEach","feat","essenceCost","grantsNarration","push","name","actions","narrationActions","totalAnarchy","featsAnarchyBonus","bonusNarrations","totalLightBoxes","totalSevereBoxes","sourceDamage","_source","Array","isArray","length","pop","armorCost","firewall","activeCyberdeck","featType","damageThresholds","withoutArmor","withArmor","mental","matrix","currentEssence","Math","attributeCosts","totalCost","Object","values","reduce","sum","calculatedCost","console","log","vehicleUuid","vehicleActor","utils","fromUuidSync","e","game","actors","actor","uuid","uuidParts","split","actorId","get","vehicleCost","error","warn","WEAPON_TYPES","vd","melee","short","medium","long","linkedSkill","linkedSpecialization","linkedDefenseSkill","linkedDefenseSpecialization","tasers","throwing","grenades","bows","crossbows","smgs","shotguns","VEHICLE_TYPES","FeatDataModel","description","bookmarked","rating","choices","equipment","rrList","rrType","attribute","skill","specialization","rrValue","rrTarget","nullable","isBioware","trait","contact","awakened","cyberware","cyberdeck","vehicle","weapon","spell","connaissance","weaponType","vehicleType","damageValue","damageValueBonus","meleeRange","none","ok","dice","disadvantage","shortRange","mediumRange","longRange","rangeImprovements","autopilot","structure","handling","speed","flyingSpeed","armor","weaponMount","weaponInfo","autopilotBonus","speedBonus","handlingBonus","armorBonus","isFixed","isFlying","weaponMountImprovement","autopilotUnlocked","additionalDroneCount","vehicleActorUuid","attack","cyberdeckDamage","cyberdeckBonusLightDamage","contactName","astralPerception","astralProjection","sorcery","conjuration","adept","riggerConsoleCount","hasVehicleControlWiring","isWeaponFocus","isAdeptPowerWeapon","narrativeEffects","text","isNegative","value","sustainedSpellCount","summonedSpiritCount","isFirstFeat","shamanicMask","spellType","direct","indirect","weaponDamageBonus","weaponTypeBonus","keys","key","spellSpecializationType","combat","detection","health","illusion","manipulation","counterspell","linkedAttackSkill","linkedAttackSpecialization","costType","spellSpecType","spellSpecMap","recommendedLevel","recommendedLevelBreakdown","labelKey","labelParams","abs","rangeImprovementCount","rr","positiveEffects","effect","trim","negativeEffects","positiveEffectValue","negativeEffectValue","VehicleDataModel","vehicleTypeChoices","vehicleStats","baseAutopilot","baseStructure","baseHandling","baseSpeed","baseFlyingSpeed","baseArmor","baseWeaponMount","finalAutopilot","finalHandling","finalSpeed","finalFlyingSpeed","finalArmor","finalWeaponMount","baseAttributes","narrativeEffectsCost","hasText","weaponCost","ICE_TYPES","patrol","acid","blaster","blocker","black","glue","tracker","killer","IceDataModel","iceTypeChoices","entries","iceType","serverIndex","threshold","ceil","SkillDataModel","linkedAttribute","SpecializationDataModel","MetatypeDataModel","SRA2Actor","Actor","feats","normalizeSearchText","toLowerCase","normalize","replace","itemMatchesSearch","itemType","searchTerm","includePackName","packTitle","normalizedSearch","includes","searchItemsInWorld","existingItemsCheck","results","alreadyExists","source","i18n","localize","searchItemsOnActor","async","searchItemsInCompendiums","seenNames","Set","pack","packs","documentName","documents","getDocuments","doc","title","has","add","searchItemsEverywhere","result","buildSingleResultHtml","typeLabel","isExactMatch","html","itemExistsOnActor","itemName","some","itemUuid","fromUuid","ui","notifications","format","createEmbeddedDocuments","toObject","info","options","lastSearchTerm","noResultsMessage","normalizedLastSearch","exactMatch","r","otherResults","searchFunction","delay","timeoutId","clearTimeout","setTimeout","resultsDiv","show","style","display","RISK_DICE_BY_RR","getRiskDiceByRR","handleRollRequest","skillName","specName","itemId","actorUuid","actorName","specLevel","skillLevel","itemRating","itemActive","Promise","then","module","RollDialog","render","attacker","defender","attackerToken","defenderToken","rollData","document","attackerTokenUuid","defenderTokenUuid","dicePool","riskDiceCount","normalDiceCount","rollMode","finalRR","rollResult","normalDice","riskDice","normalSuccesses","riskSuccesses","totalSuccesses","criticalFailures","remainingFailures","complication","normalRoll","riskRoll","Roll","evaluate","dice3d","showForRoll","user","dice3dConfig","colorset","theme","normalResults","map","riskResults","isAttack","finalAttackerUuid","finalDefenderUuid","defenderData","tokenImg","img","texture","src","defenseResult","calculatedDamage","attackFailed","isDefend","attackRollResult","attackRollData","attackSuccesses","defenseSuccesses","isIceAttack","originalAttackerName","defenderName","iceDamageValue","damageValueStr","startsWith","attackerStrength","parseInt","substring","originalAttackerUuid","defenderUuid","isCounterAttack","originalDefenderName","counterAttackSuccesses","attackDamageValue","attackDamageValueStr","counterAttackDamageValue","actorStrength","selectedWeaponId","weaponSystem","baseDamageValue","weaponDamageValueStr","toString","attackerDamage","defenderDamage","isTie","winner","originalDefenderUuid","damageInflicterUuid","damageReceiverUuid","damageInflicterName","damageReceiverName","attackerWithUuid","defenderWithUuid","templateData","attackerUuid","isSpellDirect","renderTemplate","messageData","speaker","alias","content","CONST","CHAT_MESSAGE_TYPES","OTHER","flags","sra2","rollType","attackerId","defenderId","ChatMessage","create","isSpell","normalizedSkillName","ItemSearch.normalizeSearchText","specItem","isConjuration","actorSystem","message","lightWounds","woundApplied","update","severeWounds","severeApplied","handleDrain","createRollChatMessage","mode","handleSheetUpdate","formData","expandedData","expandObject","currentDamage","convertToArray","obj","expectedLength","arr","fill","currentLightLength","currentSevereLength","calculateFinalDamageValue","total","modifier","base","organizeSpecializationsBySkill","allSpecializations","actorItems","specializationsBySkill","Map","unlinkedSpecializations","spec","linkedSkillName","skillId","set","bySkill","unlinked","handleItemDrop","event","allowedTypes","TextEditor","getDragEventData","Item","implementation","fromDropData","handleVehicleActorDrop","updatedLinkedVehicles","prototypeToken","updateData","mergeObject","PrototypeToken","defaults","actorLink","getRRSources","sources","normalizedItemName","rrEntry","normalizedRRTarget","featName","calculateRR","handleEditItem","preventDefault","element","currentTarget","dataset","closest","getAttribute","sheet","handleDeleteItem","sheetRender","delete","calculateRawDamageString","parseDamageCheckboxChange","inputName","checked","match","damageType","index","updatedDamage","handleSectionNavigation","formElement","button","section","form","HTMLElement","querySelectorAll","classList","remove","contentSection","targetSection","querySelector","restoreActiveSection","activeSection","navButton","getCurrentActiveSection","activeNavItem","enrichFeats","calculateFinalDamageValueFn","rrEntries","allRRList","ItemSearch","linkedAttackSpec","attackSpecName","attackSkillName","attackLinkedAttribute","foundSpec","specSystem","parentSkill","foundSkill","specRRSources","skillRRSources","attributeRRSources","entry","rrTargetLabel","toUpperCase","activeFeat","finalDamageValue","normalizeForComparison","findAttackSkillAndSpec","targetSpec","targetSkill","defaultAttribute","normalizedTargetSpec","_extractSpecAndSkillInfo","normalizedKeywords","kw","foundSpecByKeyword","normalizedName","normalizedKeyword","_trySpellSpecKeywordSearch","specInGameItems","specKeywords","specToUse","skillSystem","_searchGameItemsForSpellSpec","foundLinkedAttribute","skillRating","attributeValue","_searchGameItemsForSorcellerie","calculateAttackPool","skillSpecResult","itemRRList","totalDicePool","allRRSources","totalRR","findSkillByName","findSpecByName","findItemInGame","calculateSkillDicePool","linkedDefenseSpec","defaultSelection","linkedSpec","skills","specTemplate","itemSystem","numericValue","displayValue","rawDamageString","isStrengthBased","isToxin","totalModifier","prepareVehicleWeaponRollRequest","attackData","vehicleSystem","activeFeats","prepareVehicleWeaponAttack","weaponLinkedDefenseSkill","weaponLinkedDefenseSpecialization","weaponStats","finalDefenseSkill","finalDefenseSpec","applyDamage","defenderActor","defenderSystem","isVehicle","isIce","woundType","overflow","applied","target","CharacterSheet","ActorSheet","_activeSection","defaultOptions","super","classes","template","width","height","tabs","dragDrop","dragSelector","dropSelector","submitOnChange","getData","context","stack","Error","slice","join","systemData","metatypes","metatypeAnarchyBonus","baseAnarchy","baseAnarchySpent","bonusAnarchySpent","allFeats","SheetHelpers.enrichFeats","SheetHelpers.calculateFinalDamageValue","linkedVehicleUuids","vehicleWeapons","vehicleItems","enrichedWeapon","_id","vehicleName","weaponId","crr","vehicleLevel","hasValue","vehicleDamage","hasSevereDamage","box","isIncapacitating","weapons","vehicleFeats","cyberdeckFeats","cyberdeckDamageThresholds","baseLightBoxes","currentLength","featsByType","adeptPower","weaponsSpells","weaponLinkedSkill","weaponLinkedSpecialization","finalAttackSkill","finalAttackSpec","SheetHelpers.findAttackSkillAndSpec","poolResult","SheetHelpers.calculateAttackPool","attackSpecLevel","spellSystem","bookmarkedItems","sort","a","b","localeCompare","SheetHelpers.organizeSpecializationsBySkill","contents","attributesRR","linkedAttributeLabel","skillRR","attributeRR","specs","specializations","parentRating","effectiveRating","parentSkillName","specLinkedAttribute","specRR","specAttributeRR","parentSkillRR","specAttributeValue","severeDamage","close","$","off","activateListeners","on","_onSwitchSheet","bind","_onSectionNavigation","_onEditMetatype","_onDeleteMetatype","_onEditFeat","_onDeleteFeat","_onOpenVehicle","_onUnlinkVehicle","_onEditSkill","_onDeleteSkill","_onEditSpecialization","_onDeleteSpecialization","_onRollAttribute","_onRollSkill","_onQuickRollSkill","_onRollSpecialization","_onQuickRollSpecialization","_onSendCatchphrase","_onToggleBookmark","_onBookmarkItemClick","_onDamageChange","_onAnarchyChange","_onCyberdeckDamageChange","_onRollWeapon","_onRollSpell","_onRollWeaponSpell","_onRollVehicleWeaponFromSheet","_onRollVehicleWeaponAutopilot","_onRollVehicleAutopilot","_onRatingChange","_onSkillSearch","_onSkillSearchFocus","_onSkillSearchBlur","skillSearchContainer","contains","hide","_onFeatSearch","_onFeatSearchFocus","_onFeatSearchBlur","featSearchContainer","each","_index","setAttribute","addEventListener","_onDragStart","_updateObject","_event","SheetHelpers.handleSectionNavigation","SheetHelpers.handleEditItem","SheetHelpers.handleDeleteItem","SheetHelpers.getRRSources","SheetHelpers.calculateRR","newRating","isNaN","DiceRoller.handleRollRequest","attributeName","attributeLabel","rrSources","CombatHelpers.applyDamage","dragData","dataTransfer","setData","JSON","stringify","_onDrop","SheetHelpers.handleItemDrop","SheetHelpers.handleVehicleActorDrop","searchTimeout","input","siblings","_performSkillSearch","ItemSearch.searchItemsEverywhere","ItemSearch.itemExistsOnActor","_displaySkillSearchResults","formattedSearchTerm","word","charAt","exactMatchOnActor","disabledClass","buttonText","innerHTML","_onAddSkillFromSearch","_onCreateNewSkill","disabled","trigger","stopPropagation","textContent","resolve","blurEvent","relatedTarget","activeElement","formattedName","skillData","createdItems","newSkill","searchInput","featSearchTimeout","lastFeatSearchTerm","_performFeatSearch","searchResults","exists","_displayFeatSearchResults","featTypeLabel","_onAddFeatFromSearch","_onCreateNewFeat","catchphrase","getSpeaker","actorSource","SheetHelpers.parseDamageCheckboxChange","itemIdMatch","itemSource","stopImmediatePropagation","tagName","parentElement","hasAttribute","currentBookmarkState","fakeEvent","_onRollVehicleWeapon","CombatHelpers.prepareVehicleWeaponRollRequest","autopilotLabel","attackSkillSpecResult","attackSkillLevel","defenseSkillSpecResult","defenseSkillName","defenseSkillLevel","defenseSpecName","defenseSpecLevel","defenseLinkedAttribute","SheetHelpers.calculateRawDamageString","isVehicleWeapon","_rollWeaponOrSpell","_rollSkillWithWeapon","weaponName","_skillType","weaponDamageValue","_rollSpecializationWithWeapon","selector","featData","newFeat","CharacterSheetV2","characterSheetV2","isV2","newSheet","VehicleSheet","fromEntries","SheetHelpers.handleSheetUpdate","vehicleTypes","vehicleStructure","calculateWeaponStats","itemData","Dialog","confirm","yes","no","defaultYes","_showItemBrowser","_onVehicleTypeChange","_onBonusChange","_onOptionChange","currentNarrativeEffects","textarea","textareaElement","nameMatch","is","valueInput","val","_inputIndex","effectIndex","splice","SheetHelpers.getCurrentActiveSection","_","checkbox","$checkbox","prop","toggleClass","SheetHelpers.restoreActiveSection","weaponsOnly","itemOptions","buttons","icon","callback","cancel","default","parse","err","IceSheet","iceTypes","iceTypeDescription","_getIceTypeDescription","_onIceTypeChange","_onServerIndexChange","_onIceAttack","controlledTokens","canvas","tokens","controlled","iceToken","isToken","token","placeables","iceActor","iceSystem","iceTokenUuid","finalIceUuid","iceThreshold","CombatHelpers.createIceAttackMessage","FeatSheet","ItemSheet","prepareData","_calculateFinalDamageValue","_calculateCyberdeckDamageThresholds","rrTargetName","rrTargetType","rrTargetNotFound","_onAddRREntry","_onRemoveRREntry","_onClearRRTarget","_onAddNarrativeEffect","_onRemoveNarrativeEffect","_onNarrativeEffectNegativeChange","_onWeaponTypeChange","_onDamageValueBonusChange","_onSustainedSpellChange","_onSummonedSpiritChange","_onRangeImprovementChange","_onAstralProjectionChange","_onRRTargetSearch","_onRRTargetSearchFocus","_onRRTargetSearchBlur","container","removeClass","addClass","dropZone","rrIndex","currentSystem","bonusValue","currentBonus","newBonus","hiddenInput","cb","cbElement","cbValue","spellValue","currentCount","newCount","isChecked","rangeRow","select","rangeLabel","fieldName","currentValue","newValue","astralPerceptionInput","rrTargetSearchTimeout","_performRRTargetSearch","_displayRRTargetSearchResults","_onSelectRRTarget","targetName","otherFirstFeats","otherFeat","SkillSheet","SpecializationSheet","linkedSkillNotFound","s","_onClearLinkedSkill","skillSearchTimeout","lastSkillSearchTerm","isWorldItem","_onLinkSkillFromSearch","MetatypeSheet","Application","targetToken","rrEnabled","riskDiceManuallySet","lastAutoRR","selectedRange","manualRRBonus","constructor","targets","from","defenderTokenFromUuid","foundToken","availableWeapons","autoSelectWeaponForCounterAttack","bestWeapon","highestDamage","bonus","selectWeaponForCounterAttack","selectCombatRapprocheSkill","selectedWeapon","w","actualWeapon","wepTypeName","wepTypeData","baseSkillName","linkedSkillItem","linkedSpecs","preferredSpecName","skillSpecRRList","combatRapprocheSkill","resizable","minimizable","distance","distanceText","grid","protagonistToken","distancePixels","measureDistance","x","y","gridSpaces","round","scene","units","dx","dy","gridDistance","sqrt","size","calculatedRange","isWeaponRoll","selectedRangeValue","hasSevereWound","wound","isSkillSpecAttributeRoll","rangeOptions","calculatedDicePool","hasThreshold","skillDisplayName","SheetHelpers","defenseRRList","attributeRRList","rrSource","rrId","isEnabled","enabled","autoRiskDiceCount","DiceRoller.getRiskDiceByRR","maxRiskDice","riskProbabilities","allGood","glitch","criticalGlitch","disaster","clampedRiskDice","clampedRR","probabilitiesData","shadowAmpProbabilities","condition","conditions","c","diceData","d","getRiskProbabilities","riskColorClass","riskLevelTextKey","riskLevelText","toFixed","allGoodColorClass","glitchColorClass","criticalGlitchColorClass","disasterColorClass","diceColor","riskClass","getDiceColorFromRiskClass","diceList","isRiskDice","riskColor","dropdownOptions","skillSelected","isSelected","specSelected","skillsWithSpecs","selectedSpec","opt","selectedValue","selectedSkill","normalizedLinkedSpec","normalizedLinkedSkill","attributeOptions","attributeNames","attributeLabels","attrName","attrValue","diceValue","selectedAttribute","hasSkillRating","parentSkillItem","skillItem","updateRRForSkill","updateRRForSpec","clear","newTotalRR","sourceId","rangeValue","rangeValueForSelected","modeValue","inputValue","Number","diceIcon","diceIndex","isCurrentlySelected","hasClass","finalRRList","updatedRollData","executeRoll","diceRoller","HOOKS","CURRENT_SYSTEM_VERSION","Migration","code","version","migrate","applyItemsUpdates","computeUpdates","actorItemUpdates","updateEmbeddedDocuments","itemUpdates","updateDocuments","Migrations","settings","register","scope","config","String","currentVersion","isNewerVersion","migrations","Hooks","callAll","list","concat","m","targetVersion","$notify","Migration_13_0_3","totalMigrated","totalSkipped","updates","sourceSystem","hasOldFormat","maxLength","summaryMessage","userMessage","permanent","Migration_13_0_4","totalCleaned","hasOldFields","hasBackups","_rrTypeBackup","_rrValueBackup","_rrTargetBackup","Migration_13_0_5","totalConverted","Migration_13_0_6","Migration_13_0_7","conversionDetails","itemInfo","oldType","newType","hasWeaponFocus","hasDamageValue","hasRanges","Date","toISOString","withWeaponFocus","withDamage","withRanges","detail","count","Migration_13_0_8","totalFixed","needsUpdate","firstEffect","convertedEffects","effectCount","isInteger","totalEffects","fixed","Migration_13_0_9","totalUpdated","totalFirstFeatAdded","updateDetails","updatedEffects","hasFirstFeat","existingDetail","totalWithFirstFeat","firstFeatCount","Migration_13_0_10","featItems","_costMigrationVersion","currentCost","newCost","reason","oldCost","specializedToAdvanced","featToFree","specializedCount","featCount","Migration_13_0_11","_specializationLinkMigrationVersion","hasAttackSpec","hasOwnProperty","hasDefenseSpec","Migration_13_0_12","_rangeDiceToDisadvantageMigrationVersion","globalThis","SRA2System","start","once","onInit","api","applications","models","registerThemeSetting","CONFIG","sidebarIcon","Adventure","Cards","Combat","Folder","JournalEntry","JournalEntryPage","Macro","Playlist","PlaylistSound","RollTable","Scene","controlIcons","visibility","effects","lock","up","down","defeated","lightOff","sound","soundOff","doorClosed","doorOpen","doorSecret","doorLocked","declareMigration","documentClass","documents.SRA2Actor","dataModels","character","models.CharacterDataModel","models.VehicleDataModel","ice","models.IceDataModel","models.SkillDataModel","models.FeatDataModel","models.SpecializationDataModel","models.MetatypeDataModel","DocumentSheetConfig","registerSheet","applications.CharacterSheet","types","makeDefault","applications.CharacterSheetV2","applications.VehicleSheet","applications.IceSheet","characterActors","charActor","debug","userId","char","characterCount","characters","rendered","SheetHelpers.findSkillByName","skillTemplate","SheetHelpers.findItemInGame","applications.FeatSheet","applications.SkillSheet","applications.SpecializationSheet","applications.MetatypeSheet","Handlebars","registerHelper","args","str","targetUuid","messageFlags","selectedTargets","defenderFromUuid","defenderFromId","success","attackerName","defenseSkill","defenseSpec","attackSkill","attackSpec","isVehicleDefender","defenderTokenForRoll","defenderActorForRoll","defenderTokenUuidFromFlags","isMeleeAttack","specRating","originalAttackerTokenUuid","defenseRollData","rollDialog","dialog","characterToken","defenderTokenUuidForCounter","allWeapons","isFeat","isWeapon","itemFeat","defenderWeapons","hasMeleeInSystem","hasMeleeInType","combatRapprocheSpecs","meleeInType","counterAttackerTokenUuid","counterAttackRollData","_hud","unshift","onclick","showBookmarksDialog","addRollDiceButton","chatForm","rollDiceContainer","prepend","ownedActors","isOwner","diceCount","DiceRoller","getSuccessThreshold","finalRiskDiceCount","successThreshold","actorTokens","actorToken","app","observer","MutationObserver","body","observe","childList","subtree","onReady","bookmarkedSkills","bookmarkedFeats","hint","onChange","applyTheme","themeClass","migrateFeatsToArrayFormat","migrateAnarchyNimbusToSpent","featsToUpdate","actorUpdates","actorsToUpdate","anarchyNimbus"],"mappings":"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"}