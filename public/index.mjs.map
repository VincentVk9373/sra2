{"version":3,"file":"index.mjs","sources":["../src/module/config/system.ts","../src/module/models/actor-character.ts","../src/module/models/actor-npc.ts","../src/module/models/item-skill.ts","../src/module/models/item-feat.ts","../src/module/models/item-specialization.ts","../src/module/models/item-metatype.ts","../src/module/documents/actor.ts","../src/module/applications/character-sheet.ts","../src/module/applications/feat-sheet.ts","../src/module/applications/skill-sheet.ts","../src/module/applications/specialization-sheet.ts","../src/module/applications/metatype-sheet.ts","../src/module/hooks.mjs","../src/module/migration/migration.mjs","../src/module/migration/migration-13.0.3.mjs","../src/module/migration/migration-13.0.4.mjs","../src/module/migration/migration-13.0.5.mjs","../src/module/migration/migration-13.0.6.mjs","../src/module/migration/migration-13.0.7.mjs","../src/module/migration/migration-13.0.8.mjs","../src/module/migration/migration-13.0.9.mjs","../src/module/migration/migration-13.0.10.mjs","../src/module/sra2-system.ts","../src/start.ts"],"sourcesContent":["const SYSTEM_ID = 'sra2';\n\nexport interface SystemConfig {\n  id: string;\n  LOG: {\n    HEAD: string;\n  };\n  SOCKET: string;\n  PATH: {\n    ROOT: string;\n    STYLE: string;\n    TEMPLATES: string;\n    ASSETS: string;\n  };\n}\n\nexport const SYSTEM: SystemConfig = {\n  id: SYSTEM_ID,\n  LOG: {\n    HEAD: `${SYSTEM_ID} | `\n  },\n  SOCKET: `system.${SYSTEM_ID}`,\n  PATH: {\n    ROOT: `systems/${SYSTEM_ID}`,\n    STYLE: `systems/${SYSTEM_ID}/style`,\n    TEMPLATES: `systems/${SYSTEM_ID}/templates`,\n    ASSETS: `systems/${SYSTEM_ID}/assets`,\n  }\n};\n\n","/**\n * Data model for Character actors\n */\nexport class CharacterDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      attributes: new fields.SchemaField({\n        strength: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        agility: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        willpower: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        logic: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        charisma: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        })\n      }),\n      resources: new fields.SchemaField({\n        yens: new fields.NumberField({\n          required: true,\n          initial: 0,\n          min: 0,\n          integer: true\n        }),\n        anarchy: new fields.NumberField({\n          required: true,\n          initial: 0,\n          min: 0,\n          integer: true\n        })\n      }),\n      maxEssence: new fields.NumberField({\n        required: true,\n        initial: 6,\n        min: 0,\n        integer: true\n      }),\n      armorLevel: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 5,\n        integer: true\n      }),\n      damage: new fields.SchemaField({\n        light: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false, false]\n        }),\n        severe: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false]\n        }),\n        incapacitating: new fields.BooleanField({\n          required: true,\n          initial: false\n        })\n      }),\n      anarchySpent: new fields.ArrayField(new fields.BooleanField({\n        required: true,\n        initial: false\n      }), {\n        required: true,\n        initial: [false, false, false]\n      }),\n      bio: new fields.SchemaField({\n        background: new fields.HTMLField({\n          required: true,\n          initial: \"\"\n        }),\n        notes: new fields.HTMLField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      keywords: new fields.SchemaField({\n        keyword1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword5: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      behaviors: new fields.SchemaField({\n        behavior1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      catchphrases: new fields.SchemaField({\n        catchphrase1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      })\n    };\n  }\n\n  /**\n   * Calculate the cost of an attribute based on its level\n   * Each level costs 10000, except the last level (maximum) which costs 20000\n   */\n  private calculateAttributeCost(level: number, maxLevel: number): number {\n    let cost = 0;\n    for (let i = 1; i <= level; i++) {\n      if (i === maxLevel) {\n        cost += 20000;\n      } else {\n        cost += 10000;\n      }\n    }\n    return cost;\n  }\n\n  override prepareDerivedData(): void {\n    // Get metatype to determine attribute maximums and anarchy bonus\n    const parent = (this as any).parent;\n    let attributeMaxes = {\n      strength: 99,\n      agility: 99,\n      willpower: 99,\n      logic: 99,\n      charisma: 99\n    };\n    let anarchyBonus = 0;\n    \n    if (parent && parent.items) {\n      const metatype = parent.items.find((item: any) => item.type === 'metatype');\n      if (metatype && metatype.system) {\n        attributeMaxes = {\n          strength: metatype.system.maxStrength || 99,\n          agility: metatype.system.maxAgility || 99,\n          willpower: metatype.system.maxWillpower || 99,\n          logic: metatype.system.maxLogic || 99,\n          charisma: metatype.system.maxCharisma || 99\n        };\n        anarchyBonus = metatype.system.anarchyBonus || 0;\n      }\n    }\n    \n    (this as any).attributeMaxes = attributeMaxes;\n    \n    // Calculate damage boxes, thresholds bonuses, essence cost, anarchy bonus, and narrations from active feats\n    let bonusLightDamage = 0;\n    let bonusSevereDamage = 0;\n    let bonusPhysicalThreshold = 0;\n    let bonusMentalThreshold = 0;\n    let bonusAnarchy = 0;\n    let totalEssenceCost = 0;\n    let totalNarrations = 0;\n    const narrationsDetails: Array<{ name: string; actions: number }> = [];\n    \n    if (parent && parent.items) {\n      const activeFeats = parent.items.filter((item: any) => \n        item.type === 'feat' && item.system.active === true\n      );\n      \n      activeFeats.forEach((feat: any) => {\n        bonusLightDamage += feat.system.bonusLightDamage || 0;\n        bonusSevereDamage += feat.system.bonusSevereDamage || 0;\n        bonusPhysicalThreshold += feat.system.bonusPhysicalThreshold || 0;\n        bonusMentalThreshold += feat.system.bonusMentalThreshold || 0;\n        bonusAnarchy += feat.system.bonusAnarchy || 0;\n        totalEssenceCost += feat.system.essenceCost || 0;\n        \n        // Count narrations\n        if (feat.system.grantsNarration) {\n          totalNarrations++;\n          narrationsDetails.push({\n            name: feat.name,\n            actions: feat.system.narrationActions || 1\n          });\n        }\n      });\n    }\n    \n    // Calculate total anarchy (base 3 + metatype bonus + feats bonus)\n    (this as any).totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\n    (this as any).anarchyBonus = anarchyBonus;\n    (this as any).featsAnarchyBonus = bonusAnarchy;\n    \n    // Store narrations information (base 1 + feats bonus)\n    (this as any).totalNarrations = 1 + totalNarrations;\n    (this as any).bonusNarrations = totalNarrations;\n    (this as any).narrationsDetails = narrationsDetails;\n    \n    // Base: 2 light, 1 severe, 1 incapacitating\n    const totalLightBoxes = 2 + bonusLightDamage;\n    const totalSevereBoxes = 1 + bonusSevereDamage;\n    \n    // Ensure damage arrays match the required size\n    const damage = (this as any).damage || {};\n    \n    // Adjust light damage array\n    if (!Array.isArray(damage.light)) {\n      damage.light = [false, false];\n    }\n    while (damage.light.length < totalLightBoxes) {\n      damage.light.push(false);\n    }\n    while (damage.light.length > totalLightBoxes) {\n      damage.light.pop();\n    }\n    \n    // Adjust severe damage array\n    if (!Array.isArray(damage.severe)) {\n      damage.severe = [false];\n    }\n    while (damage.severe.length < totalSevereBoxes) {\n      damage.severe.push(false);\n    }\n    while (damage.severe.length > totalSevereBoxes) {\n      damage.severe.pop();\n    }\n    \n    (this as any).totalLightBoxes = totalLightBoxes;\n    (this as any).totalSevereBoxes = totalSevereBoxes;\n    \n    // Adjust anarchy spent array to match total anarchy\n    const totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\n    const anarchySpent = (this as any).anarchySpent || [];\n    \n    if (!Array.isArray(anarchySpent)) {\n      (this as any).anarchySpent = [];\n    }\n    while ((this as any).anarchySpent.length < totalAnarchy) {\n      (this as any).anarchySpent.push(false);\n    }\n    while ((this as any).anarchySpent.length > totalAnarchy) {\n      (this as any).anarchySpent.pop();\n    }\n    \n    // Calculate armor cost (2500 per level)\n    const armorLevel = (this as any).armorLevel || 0;\n    (this as any).armorCost = armorLevel * 2500;\n    \n    // Calculate damage thresholds (with bonuses from feats)\n    const strength = (this as any).attributes?.strength || 1;\n    const willpower = (this as any).attributes?.willpower || 1;\n    \n    (this as any).damageThresholds = {\n      withoutArmor: {\n        light: strength + bonusPhysicalThreshold,\n        moderate: strength + bonusPhysicalThreshold + 3,\n        severe: strength + bonusPhysicalThreshold + 6\n      },\n      withArmor: {\n        light: strength + armorLevel + bonusPhysicalThreshold,\n        moderate: strength + armorLevel + bonusPhysicalThreshold + 3,\n        severe: strength + armorLevel + bonusPhysicalThreshold + 6\n      },\n      mental: {\n        light: willpower + bonusMentalThreshold,\n        moderate: willpower + bonusMentalThreshold + 3,\n        severe: willpower + bonusMentalThreshold + 6\n      }\n    };\n    \n    // Calculate current essence\n    const maxEssence = (this as any).maxEssence || 6;\n    (this as any).currentEssence = Math.max(0, maxEssence - totalEssenceCost);\n    \n    // Calculate costs for each attribute\n    const attributes = (this as any).attributes;\n    if (attributes) {\n      // Clamp attributes to their maximums\n      attributes.strength = Math.min(attributes.strength || 1, attributeMaxes.strength);\n      attributes.agility = Math.min(attributes.agility || 1, attributeMaxes.agility);\n      attributes.willpower = Math.min(attributes.willpower || 1, attributeMaxes.willpower);\n      attributes.logic = Math.min(attributes.logic || 1, attributeMaxes.logic);\n      attributes.charisma = Math.min(attributes.charisma || 1, attributeMaxes.charisma);\n      \n      (this as any).attributeCosts = {\n        strength: this.calculateAttributeCost(attributes.strength || 1, attributeMaxes.strength),\n        agility: this.calculateAttributeCost(attributes.agility || 1, attributeMaxes.agility),\n        willpower: this.calculateAttributeCost(attributes.willpower || 1, attributeMaxes.willpower),\n        logic: this.calculateAttributeCost(attributes.logic || 1, attributeMaxes.logic),\n        charisma: this.calculateAttributeCost(attributes.charisma || 1, attributeMaxes.charisma)\n      };\n      \n      // Calculate total cost of attributes\n      const attributeCosts = (this as any).attributeCosts;\n      let totalCost = Object.values(attributeCosts).reduce((sum: number, cost: any) => sum + cost, 0);\n      \n      // Add armor cost\n      totalCost += (this as any).armorCost || 0;\n      \n      // Add items cost (skills and feats)\n      if (parent && parent.items) {\n        parent.items.forEach((item: any) => {\n          if (item.system && item.system.calculatedCost !== undefined) {\n            totalCost += item.system.calculatedCost;\n          }\n        });\n      }\n      \n      (this as any).totalCost = totalCost;\n    }\n  }\n}\n\n","/**\n * Data model for NPC actors\n */\nexport class NpcDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      state: new fields.SchemaField({\n        health: new fields.NumberField({\n          required: true,\n          initial: 10,\n          min: 0,\n          integer: true\n        }),\n        maxHealth: new fields.NumberField({\n          required: true,\n          initial: 10,\n          min: 1,\n          integer: true\n        }),\n        armor: new fields.NumberField({\n          required: true,\n          initial: 0,\n          min: 0,\n          integer: true\n        })\n      }),\n      difficulty: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 1,\n        max: 6,\n        integer: true,\n        label: \"SRA2.NPC.DIFFICULTY\"\n      }),\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Add any derived data calculations here\n  }\n}\n\n","/**\n * Data model for Skill items\n */\nexport class SkillDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      rating: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 0,\n        max: 8,\n        integer: true,\n        label: \"SRA2.SKILLS.RATING\"\n      }),\n      linkedAttribute: new fields.StringField({\n        required: true,\n        initial: \"strength\",\n        choices: {\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\n        },\n        label: \"SRA2.SKILLS.LINKED_ATTRIBUTE\"\n      }),\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Calculate cost based on rating\n    // 2500 per rating up to 5, then 5000 per rating above 5\n    const rating = (this as any).rating || 0;\n    \n    let calculatedCost = 0;\n    if (rating <= 5) {\n      calculatedCost = rating * 2500;\n    } else {\n      // First 5 levels at 2500 each, remaining levels at 5000 each\n      calculatedCost = 5 * 2500 + (rating - 5) * 5000;\n    }\n    \n    (this as any).calculatedCost = calculatedCost;\n  }\n}\n\n","/**\n * Weapon types configuration with their stats\n */\nexport const WEAPON_TYPES = {\n  \"custom-weapon\": { vd: \"0\", melee: \"none\", short: \"none\", medium: \"none\", long: \"none\" },\n  \"bare-hands\": { vd: \"FOR\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\" },\n  \"short-weapons\": { vd: \"FOR+1\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\" },\n  \"long-weapons\": { vd: \"FOR+2\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\" },\n  \"advanced-melee\": { vd: 5, melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\" },\n  \"throwing\": { vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"bows\": { vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\" },\n  \"crossbows\": { vd: 4, melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\" },\n  \"tasers\": { vd: 5, melee: \"ok\", short: \"ok\", medium: \"none\", long: \"none\" },\n  \"pocket-pistols\": { vd: 3, melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"light-pistols\": { vd: 4, melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"automatic-pistols\": { vd: 4, melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"heavy-pistols\": { vd: 5, melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"smgs\": { vd: 5, melee: \"dice\", short: \"ok\", medium: \"ok\", long: \"none\" },\n  \"assault-rifles\": { vd: 7, melee: \"dice\", short: \"ok\", medium: \"ok\", long: \"dice\" },\n  \"shotguns\": { vd: 8, melee: \"dice\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"sniper-rifles\": { vd: 10, melee: \"none\", short: \"dice\", medium: \"dice\", long: \"ok\" },\n  \"machine-guns\": { vd: 9, melee: \"none\", short: \"ok\", medium: \"ok\", long: \"ok\" },\n  \"grenades\": { vd: 7, melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"gas-grenades\": { vd: \"toxin\", melee: \"ok\", short: \"ok\", medium: \"dice\", long: \"none\" },\n  \"grenade-launchers\": { vd: 7, melee: \"none\", short: \"dice\", medium: \"ok\", long: \"ok\" },\n  \"rocket-launchers\": { vd: 12, melee: \"none\", short: \"none\", medium: \"dice\", long: \"ok\" }\n} as const;\n\n/**\n * Vehicle/Drone types configuration with their stats\n */\nexport const VEHICLE_TYPES = {\n  \"microdrone\": { autopilot: 6, structure: 0, handling: 10, speed: 0, flyingSpeed: 1, armor: 0, weaponMount: \"none\" },\n  \"small-drone\": { autopilot: 6, structure: 1, handling: 9, speed: 2, flyingSpeed: 4, armor: 0, weaponMount: \"smg\" },\n  \"medium-drone\": { autopilot: 6, structure: 2, handling: 7, speed: 3, flyingSpeed: 6, armor: 0, weaponMount: \"rifle\" },\n  \"large-drone\": { autopilot: 6, structure: 4, handling: 4, speed: 4, flyingSpeed: 8, armor: 0, weaponMount: \"rifle\" },\n  \"racing-motorcycle\": { autopilot: 6, structure: 4, handling: 2, speed: 6, flyingSpeed: 0, armor: 0, weaponMount: \"rifle\" },\n  \"offroad-motorcycle\": { autopilot: 6, structure: 4, handling: 3, speed: 5, flyingSpeed: 0, armor: 0, weaponMount: \"rifle\" },\n  \"chopper\": { autopilot: 6, structure: 5, handling: 2, speed: 5, flyingSpeed: 0, armor: 0, weaponMount: \"rifle\" },\n  \"sports-car\": { autopilot: 6, structure: 5, handling: 2, speed: 5, flyingSpeed: 0, armor: 0, weaponMount: \"none\" },\n  \"sedan\": { autopilot: 6, structure: 6, handling: 2, speed: 4, flyingSpeed: 0, armor: 0, weaponMount: \"none\" },\n  \"suv-pickup\": { autopilot: 6, structure: 7, handling: 1, speed: 4, flyingSpeed: 0, armor: 0, weaponMount: \"none\" },\n  \"van\": { autopilot: 6, structure: 8, handling: 1, speed: 3, flyingSpeed: 0, armor: 0, weaponMount: \"none\" },\n  \"bus-truck\": { autopilot: 6, structure: 10, handling: 0, speed: 2, flyingSpeed: 0, armor: 0, weaponMount: \"none\" }\n} as const;\n\n/**\n * Data model for Feat items\n */\nexport class FeatDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      rating: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.RATING\"\n      }),\n      cost: new fields.StringField({\n        required: true,\n        initial: \"free-equipment\",\n        choices: {\n          \"free-equipment\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\",\n          \"equipment\": \"SRA2.FEATS.COST.EQUIPMENT\",\n          \"advanced-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\n          // Legacy values kept for migration compatibility (not shown in UI)\n          \"specialized-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\n          \"feat\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\"\n        },\n        label: \"SRA2.FEATS.COST.LABEL\"\n      }),\n      active: new fields.BooleanField({\n        required: true,\n        initial: true,\n        label: \"SRA2.FEATS.ACTIVE\"\n      }),\n      rrList: new fields.ArrayField(new fields.SchemaField({\n        rrType: new fields.StringField({\n          required: true,\n          initial: \"skill\",\n          choices: {\n            \"attribute\": \"SRA2.FEATS.RR_TYPE.ATTRIBUTE\",\n            \"skill\": \"SRA2.FEATS.RR_TYPE.SKILL\",\n            \"specialization\": \"SRA2.FEATS.RR_TYPE.SPECIALIZATION\"\n          },\n          label: \"SRA2.FEATS.RR_TYPE.LABEL\"\n        }),\n        rrValue: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 0,\n          max: 3,\n          integer: true,\n          label: \"SRA2.FEATS.RR_VALUE\"\n        }),\n        rrTarget: new fields.StringField({\n          required: false,\n          initial: \"\",\n          nullable: false,\n          label: \"SRA2.FEATS.RR_TARGET\"\n        })\n      }), {\n        initial: [],\n        label: \"SRA2.FEATS.RR_LIST\"\n      }),\n      bonusLightDamage: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_LIGHT_DAMAGE\"\n      }),\n      bonusSevereDamage: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_SEVERE_DAMAGE\"\n      }),\n      bonusPhysicalThreshold: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_PHYSICAL_THRESHOLD\"\n      }),\n      bonusMentalThreshold: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_MENTAL_THRESHOLD\"\n      }),\n      bonusAnarchy: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_ANARCHY\"\n      }),\n      essenceCost: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.ESSENCE_COST\"\n      }),\n      featType: new fields.StringField({\n        required: true,\n        initial: \"equipment\",\n        choices: {\n          \"trait\": \"SRA2.FEATS.FEAT_TYPE.TRAIT\",\n          \"contact\": \"SRA2.FEATS.FEAT_TYPE.CONTACT\",\n          \"awakened\": \"SRA2.FEATS.FEAT_TYPE.AWAKENED\",\n          \"adept-power\": \"SRA2.FEATS.FEAT_TYPE.ADEPT_POWER\",\n          \"equipment\": \"SRA2.FEATS.FEAT_TYPE.EQUIPMENT\",\n          \"cyberware\": \"SRA2.FEATS.FEAT_TYPE.CYBERWARE\",\n          \"cyberdeck\": \"SRA2.FEATS.FEAT_TYPE.CYBERDECK\",\n          \"vehicle\": \"SRA2.FEATS.FEAT_TYPE.VEHICLE\",\n          \"weapons-spells\": \"SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS\",\n          \"weapon\": \"SRA2.FEATS.FEAT_TYPE.WEAPON\",\n          \"spell\": \"SRA2.FEATS.FEAT_TYPE.SPELL\"\n        },\n        label: \"SRA2.FEATS.FEAT_TYPE.LABEL\"\n      }),\n      weaponType: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.WEAPON_TYPE\"\n      }),\n      vehicleType: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.VEHICLE.VEHICLE_TYPE\"\n      }),\n      // Weapon/Spell specific fields\n      damageValue: new fields.StringField({\n        required: true,\n        initial: \"0\",\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE\"\n      }),\n      damageValueBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE_BONUS\"\n      }),\n      meleeRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.MELEE_RANGE\"\n      }),\n      shortRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.SHORT_RANGE\"\n      }),\n      mediumRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.MEDIUM_RANGE\"\n      }),\n      longRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.LONG_RANGE\"\n      }),\n      rangeImprovements: new fields.SchemaField({\n        melee: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        short: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        medium: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        long: new fields.BooleanField({\n          required: true,\n          initial: false\n        })\n      }, {\n        required: true,\n        label: \"SRA2.FEATS.WEAPON.RANGE_IMPROVEMENTS\"\n      }),\n      // Vehicle/Drone specific fields\n      autopilot: new fields.NumberField({\n        required: true,\n        initial: 6,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT\"\n      }),\n      structure: new fields.NumberField({\n        required: true,\n        initial: 2,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.STRUCTURE\"\n      }),\n      handling: new fields.NumberField({\n        required: true,\n        initial: 5,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.HANDLING\"\n      }),\n      speed: new fields.NumberField({\n        required: true,\n        initial: 3,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.SPEED\"\n      }),\n      flyingSpeed: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.FLYING_SPEED\"\n      }),\n      armor: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ARMOR\"\n      }),\n      weaponMount: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\n      }),\n      weaponInfo: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\n      }),\n      // Vehicle bonuses\n      autopilotBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 6,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\n      }),\n      speedBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\n      }),\n      handlingBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\n      }),\n      armorBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\n      }),\n      isFixed: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\n      }),\n      isFlying: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\n      }),\n      weaponMountImprovement: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\n      }),\n      autopilotUnlocked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\n      }),\n      additionalDroneCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\n      }),\n      // Cyberdeck specific fields\n      firewall: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.CYBERDECK.FIREWALL\"\n      }),\n      attack: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.CYBERDECK.ATTACK\"\n      }),\n      // Contact specific fields\n      contactName: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.CONTACT.NAME\"\n      }),\n      // Awakened specific fields\n      astralPerception: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PERCEPTION\"\n      }),\n      astralProjection: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PROJECTION\"\n      }),\n      sorcery: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.SORCERY\"\n      }),\n      conjuration: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.CONJURATION\"\n      }),\n      adept: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ADEPT\"\n      }),\n      // Additional fields for recommended level calculation\n      riggerConsoleCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.RIGGER_CONSOLE_COUNT\"\n      }),\n      hasVehicleControlWiring: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.HAS_VEHICLE_CONTROL_WIRING\"\n      }),\n      isWeaponFocus: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.IS_WEAPON_FOCUS\"\n      }),\n      // Narrative effects\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\n        text: new fields.StringField({\n          required: false,\n          initial: \"\"\n        }),\n        isNegative: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        value: new fields.NumberField({\n          required: true,\n          initial: -1,\n          min: -5,\n          max: -1,\n          integer: true\n        })\n      }), {\n        initial: [],\n        label: \"SRA2.FEATS.NARRATIVE_EFFECTS\"\n      }),\n      // Grants narration\n      grantsNarration: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.GRANTS_NARRATION\"\n      }),\n      narrationActions: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 1,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.NARRATION_ACTIONS\"\n      }),\n      // Additional sustained spells and summoned spirits\n      sustainedSpellCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.SUSTAINED_SPELL_COUNT\"\n      }),\n      summonedSpiritCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 1,\n        integer: true,\n        label: \"SRA2.FEATS.SUMMONED_SPIRIT_COUNT\"\n      }),\n      // First feat flag\n      isFirstFeat: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.IS_FIRST_FEAT\"\n      }),\n      // Shamanic mask (for awakened feats)\n      shamanicMask: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.SHAMANIC_MASK\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Get common properties\n    const costType = (this as any).cost || 'free-equipment';\n    const featType = (this as any).featType || 'equipment';\n    const rating = (this as any).rating || 0;\n    \n    // Calculate cost based on cost type (for equipment and weapons)\n    let calculatedCost = 0;\n    \n    // Apply cost calculations for equipment, weapon, and weapons-spells types\n    if (featType === 'equipment' || featType === 'weapon' || featType === 'weapons-spells') {\n      switch (costType) {\n        case 'free-equipment':\n          calculatedCost = 0;\n          break;\n        case 'equipment':\n          calculatedCost = 2500;\n          break;\n        case 'advanced-equipment':\n          calculatedCost = 5000;\n          break;\n        // Legacy values (kept for migration compatibility)\n        case 'specialized-equipment':\n          calculatedCost = 5000;\n          break;\n        case 'feat':\n          calculatedCost = 0;\n          break;\n        default:\n          calculatedCost = 0;\n      }\n    }\n\n    calculatedCost += rating * 5000;\n    \n    (this as any).calculatedCost = calculatedCost;\n\n    // Calculate recommended attribute level\n    let recommendedLevel = 0;\n    const recommendedLevelBreakdown: Array<{ labelKey: string; labelParams?: string; value: number }> = [];\n    \n    const bonusLightDamage = (this as any).bonusLightDamage || 0;\n    const bonusSevereDamage = (this as any).bonusSevereDamage || 0;\n    const bonusPhysicalThreshold = (this as any).bonusPhysicalThreshold || 0;\n    const bonusMentalThreshold = (this as any).bonusMentalThreshold || 0;\n    const firewall = (this as any).firewall || 0;\n    const attack = (this as any).attack || 0;\n    const riggerConsoleCount = (this as any).riggerConsoleCount || 0;\n    const hasVehicleControlWiring = (this as any).hasVehicleControlWiring || false;\n    const isWeaponFocus = (this as any).isWeaponFocus || false;\n    const bonusAnarchy = (this as any).bonusAnarchy || 0;\n    const grantsNarration = (this as any).grantsNarration || false;\n    const narrativeEffects = (this as any).narrativeEffects || [];\n    const rrList = (this as any).rrList || [];\n    const isFirstFeat = (this as any).isFirstFeat || false;\n    \n    // Base cost for trait (not first feat): +3 levels\n    if (featType === 'trait' && !isFirstFeat) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BASE_FEAT_COST', value: 3 });\n    }\n    \n    // Cyberware/bioware: 1 level\n    if (featType === 'cyberware') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERWARE', value: 1 });\n    }\n    \n    // Adept power: 1 level\n    if (featType === 'adept-power') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER', value: 1 });\n    }\n    \n    // Spell: 1 level\n    if (featType === 'spell') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPELL', value: 1 });\n    }\n    \n    // Vehicle/Drone: 1 level\n    if (featType === 'vehicle') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE', value: 1 });\n    }\n    \n    // Light wounds: +3 per wound\n    if (bonusLightDamage > 0) {\n      const value = bonusLightDamage * 3;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.LIGHT_WOUNDS', labelParams: `(${bonusLightDamage})`, value });\n    }\n    \n    // Heavy wounds: +6 per wound\n    if (bonusSevereDamage > 0) {\n      const value = bonusSevereDamage * 6;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SEVERE_WOUNDS', labelParams: `(${bonusSevereDamage})`, value });\n    }\n    \n    // Physical threshold bonus: +1 per point (positive or negative)\n    if (bonusPhysicalThreshold !== 0) {\n      const value = Math.abs(bonusPhysicalThreshold);\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.PHYSICAL_THRESHOLD', labelParams: `(${bonusPhysicalThreshold > 0 ? '+' : ''}${bonusPhysicalThreshold})`, value });\n    }\n    \n    // Mental threshold bonus: +1 per point (positive or negative)\n    if (bonusMentalThreshold !== 0) {\n      const value = Math.abs(bonusMentalThreshold);\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.MENTAL_THRESHOLD', labelParams: `(${bonusMentalThreshold > 0 ? '+' : ''}${bonusMentalThreshold})`, value });\n    }\n    \n    // Cyberdeck firewall: starts at 1, each level is +1\n    if (featType === 'cyberdeck' && firewall > 0) {\n      recommendedLevel += firewall;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.FIREWALL', labelParams: `(${firewall})`, value: firewall });\n    }\n    \n    // Attack: starts at 0, each level is +1\n    if (attack > 0) {\n      recommendedLevel += attack;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ATTACK', labelParams: `(${attack})`, value: attack });\n    }\n    \n    // Rigger console: +1 per drone controller\n    if (riggerConsoleCount > 0) {\n      recommendedLevel += riggerConsoleCount;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RIGGER_CONSOLE', labelParams: `(${riggerConsoleCount})`, value: riggerConsoleCount });\n    }\n    \n    // Vehicle control wiring: +2\n    if (hasVehicleControlWiring) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE_WIRING', value: 2 });\n    }\n    \n    // Weapon focus: +1\n    if (isWeaponFocus) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_FOCUS', value: 1 });\n    }\n    \n    // Damage value bonus: +1 per bonus\n    const damageValueBonus = (this as any).damageValueBonus || 0;\n    if (damageValueBonus > 0) {\n      recommendedLevel += damageValueBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.DAMAGE_VALUE_BONUS', labelParams: `(+${damageValueBonus})`, value: damageValueBonus });\n    }\n    \n    // Range improvements: +2 per improved range\n    const rangeImprovements = (this as any).rangeImprovements || {};\n    let rangeImprovementCount = 0;\n    if (rangeImprovements.melee) rangeImprovementCount++;\n    if (rangeImprovements.short) rangeImprovementCount++;\n    if (rangeImprovements.medium) rangeImprovementCount++;\n    if (rangeImprovements.long) rangeImprovementCount++;\n    if (rangeImprovementCount > 0) {\n      const value = rangeImprovementCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RANGE_IMPROVEMENTS', labelParams: `(${rangeImprovementCount})`, value });\n    }\n    \n    // Resource Reduction (RR) entries\n    for (const rr of rrList) {\n      const rrType = rr.rrType;\n      const rrValue = rr.rrValue || 0;\n      \n      if (rrValue > 0) {\n        if (rrType === 'specialization') {\n          // RR specialization: +2 levels per value\n          const value = rrValue * 2;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SPECIALIZATION', labelParams: `(${rrValue})`, value });\n        } else if (rrType === 'skill') {\n          // RR skill: +5 levels per value\n          const value = rrValue * 5;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SKILL', labelParams: `(${rrValue})`, value });\n        } else if (rrType === 'attribute') {\n          // RR attribute: +10 levels per value\n          const value = rrValue * 10;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_ATTRIBUTE', labelParams: `(${rrValue})`, value });\n        }\n      }\n    }\n    \n    // Anarchy bonus: +2 per anarchy point\n    if (bonusAnarchy > 0) {\n      const value = bonusAnarchy * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ANARCHY_BONUS', labelParams: `(${bonusAnarchy})`, value });\n    }\n    \n    // Grants narration: +3 levels\n    if (grantsNarration) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.GRANTS_NARRATION', value: 3 });\n    }\n    \n    // Narrative effects: +1 level per positive effect, value per negative effect (count non-empty strings)\n    const positiveEffectsCount = narrativeEffects.filter((effect: any) => effect?.text && effect.text.trim() !== '' && !effect.isNegative).length;\n    const negativeEffects = narrativeEffects.filter((effect: any) => effect?.text && effect.text.trim() !== '' && effect.isNegative);\n    \n    if (positiveEffectsCount > 0) {\n      recommendedLevel += positiveEffectsCount;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_POSITIVE', labelParams: `(${positiveEffectsCount})`, value: positiveEffectsCount });\n    }\n    \n    if (negativeEffects.length > 0) {\n      const negativeEffectValue = negativeEffects.reduce((sum: number, effect: any) => sum + (effect.value || -1), 0);\n      recommendedLevel += negativeEffectValue; // Adding because value is already negative\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_NEGATIVE', labelParams: `(${negativeEffects.length})`, value: negativeEffectValue });\n    }\n    \n    // Additional sustained spells: +2 per spell (max 2)\n    const sustainedSpellCount = (this as any).sustainedSpellCount || 0;\n    if (sustainedSpellCount > 0) {\n      const value = sustainedSpellCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUSTAINED_SPELLS', labelParams: `(${sustainedSpellCount})`, value });\n    }\n    \n    // Additional summoned spirit: +3 (max 1)\n    const summonedSpiritCount = (this as any).summonedSpiritCount || 0;\n    if (summonedSpiritCount > 0) {\n      const value = summonedSpiritCount * 3;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUMMONED_SPIRITS', labelParams: `(${summonedSpiritCount})`, value });\n    }\n    \n    // Awakened abilities\n    const astralPerception = (this as any).astralPerception || false;\n    const astralProjection = (this as any).astralProjection || false;\n    const sorcery = (this as any).sorcery || false;\n    const conjuration = (this as any).conjuration || false;\n    const adept = (this as any).adept || false;\n    \n    // Astral perception AND projection: +2\n    if (astralPerception && astralProjection) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION_PROJECTION', value: 2 });\n    }\n    \n    // Sorcery: +1\n    if (sorcery) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SORCERY', value: 1 });\n    }\n    \n    // Conjuration: +2\n    if (conjuration) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CONJURATION', value: 2 });\n    }\n    \n    // Adept: +1\n    if (adept) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT', value: 1 });\n    }\n    \n    // Vehicle/Drone bonuses\n    const autopilotBonus = (this as any).autopilotBonus || 0;\n    const speedBonus = (this as any).speedBonus || 0;\n    const handlingBonus = (this as any).handlingBonus || 0;\n    const armorBonus = (this as any).armorBonus || 0;\n    const isFixed = (this as any).isFixed || false;\n    const isFlying = (this as any).isFlying || false;\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\n    \n    // Autopilot bonus: +1 per level\n    if (autopilotBonus > 0) {\n      recommendedLevel += autopilotBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_BONUS', labelParams: `(+${autopilotBonus})`, value: autopilotBonus });\n    }\n    \n    // Speed bonus: +1 per level\n    if (speedBonus > 0) {\n      recommendedLevel += speedBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPEED_BONUS', labelParams: `(+${speedBonus})`, value: speedBonus });\n    }\n    \n    // Handling bonus: +1 per level\n    if (handlingBonus > 0) {\n      recommendedLevel += handlingBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.HANDLING_BONUS', labelParams: `(+${handlingBonus})`, value: handlingBonus });\n    }\n    \n    // Armor bonus: +1 per level\n    if (armorBonus > 0) {\n      recommendedLevel += armorBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ARMOR_BONUS', labelParams: `(+${armorBonus})`, value: armorBonus });\n    }\n    \n    // Fixed (unable to move): -1\n    if (isFixed) {\n      recommendedLevel -= 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FIXED', value: -1 });\n    }\n    \n    // Flying: +1\n    if (isFlying) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FLYING', value: 1 });\n    }\n    \n    // Weapon mount improvement: +1\n    if (weaponMountImprovement) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_MOUNT_IMPROVEMENT', value: 1 });\n    }\n    \n    // Autopilot unlocked: +3\n    if (autopilotUnlocked) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_UNLOCKED', value: 3 });\n    }\n    \n    // Additional drones: +2 per drone\n    if (additionalDroneCount > 0) {\n      const value = additionalDroneCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADDITIONAL_DRONES', labelParams: `(${additionalDroneCount})`, value });\n    }\n    \n    // Shamanic mask: -1 level (for awakened feats only)\n    const shamanicMask = (this as any).shamanicMask || false;\n    if (shamanicMask && featType === 'awakened') {\n      recommendedLevel -= 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SHAMANIC_MASK', value: -1 });\n    }\n    \n    (this as any).recommendedLevel = recommendedLevel;\n    (this as any).recommendedLevelBreakdown = recommendedLevelBreakdown;\n  }\n}\n\n","/**\n * Data model for Specialization items\n * A specialization is linked to a skill and costs 2500 yens\n */\nexport class SpecializationDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      linkedSkill: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.SPECIALIZATIONS.LINKED_SKILL\"\n      }),\n      linkedAttribute: new fields.StringField({\n        required: true,\n        initial: \"strength\",\n        choices: {\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\n        },\n        label: \"SRA2.SPECIALIZATIONS.LINKED_ATTRIBUTE\"\n      }),\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Specializations have a fixed cost of 2500 yens\n    (this as any).calculatedCost = 2500;\n  }\n}\n\n","/**\n * Data model for Metatype items\n * Metatypes define maximum values for character attributes\n */\nexport class MetatypeDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      maxStrength: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_STRENGTH\"\n      }),\n      maxAgility: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_AGILITY\"\n      }),\n      maxWillpower: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_WILLPOWER\"\n      }),\n      maxLogic: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_LOGIC\"\n      }),\n      maxCharisma: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_CHARISMA\"\n      }),\n      anarchyBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.ANARCHY_BONUS\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Metatypes don't have a cost, they're character features\n    // No derived data needed for now\n  }\n}\n\n","/**\n * Custom Actor document for SRA2\n */\nexport class SRA2Actor<SubType extends Actor.SubType = Actor.SubType> extends Actor<SubType> {\n  get feats(): Item[] {\n    return this.items.filter((item: Item) => item.type === 'feat');\n  }\n}","/**\n * Character Sheet Application\n */\nexport class CharacterSheet extends ActorSheet {\n  /** Active section for tabbed navigation */\n  private _activeSection: string = 'identity';\n\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'actor', 'character'],\n      template: 'systems/sra2/templates/actor-character-sheet.hbs',\n      width: 900,\n      height: 700,\n      tabs: [],\n      dragDrop: [\n        { dragSelector: '.metatype-item', dropSelector: '.metatype-drop-zone' },\n        { dragSelector: '.feat-item', dropSelector: '.feats-list' },\n        { dragSelector: '.skill-item', dropSelector: '.skills-list' },\n        { dragSelector: '.specialization-item', dropSelector: '.skills-list' }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n\n    // Ensure system data is available\n    context.system = this.actor.system;\n\n    // Get metatype (there should be only one)\n    const metatypes = this.actor.items.filter((item: any) => item.type === 'metatype');\n    context.metatype = metatypes.length > 0 ? metatypes[0] : null;\n\n    // Get feats and enrich with RR target labels\n    const allFeats = this.actor.items.filter((item: any) => item.type === 'feat').map((feat: any) => {\n      // Add translated labels for attribute targets in RR entries\n      feat.rrEntries = [];\n      const rrList = feat.system.rrList || [];\n      \n      for (let i = 0; i < rrList.length; i++) {\n        const rrEntry = rrList[i];\n        const rrType = rrEntry.rrType;\n        const rrValue = rrEntry.rrValue || 0;\n        const rrTarget = rrEntry.rrTarget || '';\n        \n        const entry: any = { rrType, rrValue, rrTarget };\n        \n        if (rrType === 'attribute' && rrTarget) {\n          entry.rrTargetLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${rrTarget.toUpperCase()}`);\n        }\n        \n        feat.rrEntries.push(entry);\n      }\n      \n      return feat;\n    });\n    \n    // Group feats by type\n    context.featsByType = {\n      trait: allFeats.filter((feat: any) => feat.system.featType === 'trait'),\n      contact: allFeats.filter((feat: any) => feat.system.featType === 'contact'),\n      awakened: allFeats.filter((feat: any) => feat.system.featType === 'awakened'),\n      adeptPower: allFeats.filter((feat: any) => feat.system.featType === 'adept-power'),\n      equipment: allFeats.filter((feat: any) => feat.system.featType === 'equipment'),\n      cyberware: allFeats.filter((feat: any) => feat.system.featType === 'cyberware'),\n      cyberdeck: allFeats.filter((feat: any) => feat.system.featType === 'cyberdeck'),\n      vehicle: allFeats.filter((feat: any) => feat.system.featType === 'vehicle'),\n      weaponsSpells: allFeats.filter((feat: any) => feat.system.featType === 'weapons-spells'),\n      weapon: allFeats.filter((feat: any) => feat.system.featType === 'weapon'),\n      spell: allFeats.filter((feat: any) => feat.system.featType === 'spell')\n    };\n    \n    // Keep the feats array for backwards compatibility\n    context.feats = allFeats;\n    \n    // Get skills\n    const skills = this.actor.items.filter((item: any) => item.type === 'skill');\n    \n    // Get all specializations\n    const allSpecializations = this.actor.items.filter((item: any) => item.type === 'specialization');\n    \n    // Organize specializations by linked skill\n    const specializationsBySkill = new Map<string, any[]>();\n    const unlinkedSpecializations: any[] = [];\n    \n    allSpecializations.forEach((spec: any) => {\n      const linkedSkillName = spec.system.linkedSkill;\n      if (linkedSkillName) {\n        // linkedSkill is stored as a name, find the skill by name\n        const linkedSkill = this.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === linkedSkillName\n        );\n        \n        if (linkedSkill && linkedSkill.id) {\n          // Valid linked skill found\n          const skillId = linkedSkill.id;\n          if (!specializationsBySkill.has(skillId)) {\n            specializationsBySkill.set(skillId, []);\n          }\n          specializationsBySkill.get(skillId)!.push(spec);\n        } else {\n          // Linked skill doesn't exist (name doesn't match any skill), mark as unlinked\n          unlinkedSpecializations.push(spec);\n        }\n      } else {\n        // No linked skill specified\n        unlinkedSpecializations.push(spec);\n      }\n    });\n    \n    // Calculate RR for attributes first (needed for skills and specializations)\n    const attributesRR = {\n      strength: Math.min(3, this.calculateRR('attribute', 'strength')),\n      agility: Math.min(3, this.calculateRR('attribute', 'agility')),\n      willpower: Math.min(3, this.calculateRR('attribute', 'willpower')),\n      logic: Math.min(3, this.calculateRR('attribute', 'logic')),\n      charisma: Math.min(3, this.calculateRR('attribute', 'charisma'))\n    };\n    \n    // Add specializations to each skill and calculate RR\n    context.skills = skills.map((skill: any) => {\n      // Get linked attribute label for the skill\n      const linkedAttribute = skill.system?.linkedAttribute || 'strength';\n      skill.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n      \n      // Calculate RR for this skill (skill RR + attribute RR, max 3)\n      const skillRR = this.calculateRR('skill', skill.name);\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\n      skill.rr = Math.min(3, skillRR + attributeRR);\n      \n      // Calculate total dice pool (attribute + skill rating)\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\n      const skillRating = skill.system?.rating || 0;\n      skill.totalDicePool = attributeValue + skillRating;\n      \n      // Get specializations for this skill and add calculated ratings\n      const specs = specializationsBySkill.get(skill.id) || [];\n      skill.specializations = specs.map((spec: any) => {\n        const parentRating = skill.system?.rating || 0;\n        // Add properties directly to the spec object instead of creating a new one\n        spec.parentRating = parentRating;\n        spec.effectiveRating = parentRating + 2;  // Specialization adds +2 to skill rating\n        spec.parentSkillName = skill.name;\n        \n        // Get linked attribute label for the specialization\n        const specLinkedAttribute = spec.system?.linkedAttribute || 'strength';\n        spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${specLinkedAttribute.toUpperCase()}`);\n        \n        // Calculate RR for this specialization (attribute RR + skill RR + spec RR, max 3)\n        const specRR = this.calculateRR('specialization', spec.name);\n        const specAttributeRR = (attributesRR as any)[specLinkedAttribute] || 0;\n        const parentSkillRR = skillRR; // RR of the parent skill\n        spec.rr = Math.min(3, specAttributeRR + parentSkillRR + specRR);\n        \n        // Calculate total dice pool (attribute + effective rating)\n        const specAttributeValue = (this.actor.system as any).attributes[specLinkedAttribute] || 0;\n        spec.totalDicePool = specAttributeValue + spec.effectiveRating;\n        \n        return spec;\n      });\n      return skill;\n    });\n    \n    // Add unlinked specializations with attribute labels and RR\n    context.unlinkedSpecializations = unlinkedSpecializations.map((spec: any) => {\n      const linkedAttribute = spec.system?.linkedAttribute || 'strength';\n      spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n      \n      // Calculate RR for this specialization (spec RR + attribute RR, max 3)\n      // Note: unlinked specializations don't have a parent skill, so only attribute + spec RR\n      const specRR = this.calculateRR('specialization', spec.name);\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\n      spec.rr = Math.min(3, specRR + attributeRR);\n      \n      // Calculate total dice pool (attribute only, since no skill linked)\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\n      spec.totalDicePool = attributeValue;\n      \n      return spec;\n    });\n    \n    // Store attributesRR in context\n    context.attributesRR = attributesRR;\n\n    // Add active section for navigation\n    context.activeSection = this._activeSection;\n\n    return context;\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.skill-search');\n    $(document).off('click.feat-search');\n    return super.close(options);\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Section navigation\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\n\n    // Edit metatype\n    html.find('[data-action=\"edit-metatype\"]').on('click', this._onEditMetatype.bind(this));\n    \n    // Delete metatype\n    html.find('[data-action=\"delete-metatype\"]').on('click', this._onDeleteMetatype.bind(this));\n\n    // Edit feat\n    html.find('[data-action=\"edit-feat\"]').on('click', this._onEditFeat.bind(this));\n\n    // Delete feat\n    html.find('[data-action=\"delete-feat\"]').on('click', this._onDeleteFeat.bind(this));\n\n    // Edit skill\n    html.find('[data-action=\"edit-skill\"]').on('click', this._onEditSkill.bind(this));\n\n    // Delete skill\n    html.find('[data-action=\"delete-skill\"]').on('click', this._onDeleteSkill.bind(this));\n\n    // Edit specialization\n    html.find('[data-action=\"edit-specialization\"]').on('click', this._onEditSpecialization.bind(this));\n\n    // Delete specialization\n    html.find('[data-action=\"delete-specialization\"]').on('click', this._onDeleteSpecialization.bind(this));\n\n    // Roll attribute\n    html.find('[data-action=\"roll-attribute\"]').on('click', this._onRollAttribute.bind(this));\n\n    // Roll skill\n    html.find('[data-action=\"roll-skill\"]').on('click', this._onRollSkill.bind(this));\n\n    // Quick roll skill (from dice badge)\n    html.find('[data-action=\"quick-roll-skill\"]').on('click', this._onQuickRollSkill.bind(this));\n\n    // Roll specialization\n    html.find('[data-action=\"roll-specialization\"]').on('click', this._onRollSpecialization.bind(this));\n\n    // Quick roll specialization (from dice badge)\n    html.find('[data-action=\"quick-roll-specialization\"]').on('click', this._onQuickRollSpecialization.bind(this));\n\n    // Send catchphrase to chat\n    html.find('[data-action=\"send-catchphrase\"]').on('click', this._onSendCatchphrase.bind(this));\n\n    // Roll weapon\n    html.find('[data-action=\"roll-weapon\"]').on('click', this._onRollWeapon.bind(this));\n\n    // Roll spell\n    html.find('[data-action=\"roll-spell\"]').on('click', this._onRollSpell.bind(this));\n\n    // Roll weapon/spell (old type)\n    html.find('[data-action=\"roll-weapon-spell\"]').on('click', this._onRollWeaponSpell.bind(this));\n\n    // Handle rating changes\n    html.find('.rating-input').on('change', this._onRatingChange.bind(this));\n\n    // Skill search\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\n    \n    // Close skill search results when clicking outside\n    $(document).on('click.skill-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\n        html.find('.skill-search-results').hide();\n      }\n    });\n\n    // Feat search\n    html.find('.feat-search-input').on('input', this._onFeatSearch.bind(this));\n    html.find('.feat-search-input').on('focus', this._onFeatSearchFocus.bind(this));\n    html.find('.feat-search-input').on('blur', this._onFeatSearchBlur.bind(this));\n    \n    // Close feat search results when clicking outside\n    $(document).on('click.feat-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const featSearchContainer = html.find('.feat-search-container')[0] as HTMLElement;\n      if (featSearchContainer && !featSearchContainer.contains(target)) {\n        html.find('.feat-search-results').hide();\n      }\n    });\n\n    // Make feat items draggable\n    html.find('.feat-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n\n    // Make skill items draggable\n    html.find('.skill-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n\n    // Make specialization items draggable\n    html.find('.specialization-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n  }\n\n  /**\n   * Handle form submission to update actor data\n   */\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    // Filter out item data (handled separately by _onRatingChange)\n    const actorData: any = {};\n    for (const [key, value] of Object.entries(formData)) {\n      if (!key.startsWith('items.')) {\n        actorData[key] = value;\n      }\n    }\n    \n    // Expand the form data to handle nested properties\n    const expandedData = foundry.utils.expandObject(actorData);\n    \n    // Update the actor with the form data\n    return this.actor.update(expandedData);\n  }\n\n  /**\n   * Handle section navigation\n   */\n  private _onSectionNavigation(event: Event): void {\n    event.preventDefault();\n    const button = event.currentTarget as HTMLElement;\n    const section = button.dataset.section;\n    \n    if (!section) return;\n    \n    // Update active section\n    this._activeSection = section;\n    \n    // Update UI\n    const form = $(this.form);\n    form.find('.section-nav .nav-item').removeClass('active');\n    button.classList.add('active');\n    \n    form.find('.content-section').removeClass('active');\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\n  }\n\n  /**\n   * Handle editing a metatype\n   */\n  private async _onEditMetatype(event: Event): Promise<void> {\n    event.preventDefault();\n    const metatypeId = (event.currentTarget as HTMLElement).closest('.metatype-item')?.getAttribute('data-item-id');\n    if (metatypeId) {\n      const metatype = this.actor.items.get(metatypeId);\n      if (metatype) {\n        metatype.sheet?.render(true);\n      }\n    }\n  }\n\n  /**\n   * Handle deleting a metatype\n   */\n  private async _onDeleteMetatype(event: Event): Promise<void> {\n    event.preventDefault();\n    const metatypeId = (event.currentTarget as HTMLElement).closest('.metatype-item')?.getAttribute('data-item-id');\n    if (metatypeId) {\n      const metatype = this.actor.items.get(metatypeId);\n      if (metatype) {\n        await metatype.delete();\n        this.render(false);\n      }\n    }\n  }\n\n  /**\n   * Handle editing a feat\n   */\n  private async _onEditFeat(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const feat = this.actor.items.get(itemId);\n    if (feat) {\n      feat.sheet?.render(true);\n    }\n  }\n\n  /**\n   * Handle deleting a feat\n   */\n  private async _onDeleteFeat(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (item) {\n      await item.delete();\n    }\n  }\n\n  /**\n   * Handle editing a skill\n   */\n  private async _onEditSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const skill = this.actor.items.get(itemId);\n    if (skill) {\n      skill.sheet?.render(true);\n    }\n  }\n\n  /**\n   * Handle deleting a skill\n   */\n  private async _onDeleteSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (item) {\n      await item.delete();\n    }\n  }\n\n  /**\n   * Handle editing a specialization\n   */\n  private async _onEditSpecialization(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const specialization = this.actor.items.get(itemId);\n    if (specialization) {\n      specialization.sheet?.render(true);\n    }\n  }\n\n  /**\n   * Handle deleting a specialization\n   */\n  private async _onDeleteSpecialization(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (item) {\n      await item.delete();\n    }\n  }\n\n  /**\n   * Get detailed RR sources for a given skill, specialization, or attribute\n   */\n  private getRRSources(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\n    const sources: Array<{featName: string, rrValue: number}> = [];\n    \n    // Get all active feats from the actor\n    const feats = this.actor.items.filter((item: any) => \n      item.type === 'feat' && \n      item.system.active === true\n    );\n    \n    // Calculate RR from feats that target this item\n    for (const feat of feats) {\n      const featSystem = feat.system as any;\n      const rrList = featSystem.rrList || [];\n      \n      // Loop through all RR entries in this feat\n      for (const rrEntry of rrList) {\n        const rrType = rrEntry.rrType;\n        const rrValue = rrEntry.rrValue || 0;\n        const rrTarget = rrEntry.rrTarget || '';\n        \n        // Check if this RR entry provides RR for the given item\n        if (rrType === itemType && rrTarget === itemName && rrValue > 0) {\n          sources.push({\n            featName: feat.name,\n            rrValue: rrValue\n          });\n        }\n      }\n    }\n    \n    return sources;\n  }\n\n  /**\n   * Calculate Risk Reduction (RR) from active feats for a given skill, specialization, or attribute\n   */\n  private calculateRR(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\n    const sources = this.getRRSources(itemType, itemName);\n    return sources.reduce((total, source) => total + source.rrValue, 0);\n  }\n\n  /**\n   * Handle rating changes for items\n   */\n  private async _onRatingChange(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLInputElement;\n    const itemId = element.dataset.itemId;\n    const newRating = parseInt(element.value);\n    \n    if (!itemId || isNaN(newRating)) return;\n\n    const item = this.actor.items.get(itemId);\n    if (item) {\n      await item.update({ system: { rating: newRating } } as any);\n    }\n  }\n\n  /**\n   * Handle rolling a specialization\n   */\n  private async _onRollSpecialization(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    const effectiveRating = parseInt(element.dataset.effectiveRating || '0');\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No specialization ID found\");\n      return;\n    }\n\n    const specialization = this.actor.items.get(itemId);\n    if (!specialization || specialization.type !== 'specialization') return;\n\n    const specSystem = specialization.system as any;\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\n    \n    // Get the attribute value from the actor\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    const basePool = effectiveRating + attributeValue;\n\n    if (basePool <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.NO_DICE'));\n      return;\n    }\n\n    // Get localized attribute name\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n    \n    // Get RR sources for specialization, skill, and attribute\n    const specRRSources = this.getRRSources('specialization', specialization.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const linkedSkillName = specSystem.linkedSkill;\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\n    \n    const allRRSources = [\n      ...specRRSources,\n      ...skillRRSources.map(s => ({ ...s, featName: s.featName + ` (${linkedSkillName})` })),\n      ...attributeRRSources.map(s => ({ ...s, featName: s.featName + ` (${attributeLabel})` }))\n    ];\n    const autoRR = Math.min(3, allRRSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(basePool, this.getRiskDiceByRR(autoRR));\n\n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (allRRSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      allRRSources.forEach((source) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n\n    // Create a dialog to optionally add modifiers and risk dice\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.SPECIALIZATIONS.ROLL_TITLE', { name: specialization.name }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.BASE_POOL')}: <strong>${basePool}</strong></label>\n            <p class=\"notes\">(${game.i18n!.localize('SRA2.SPECIALIZATIONS.BONUS')}: ${effectiveRating} + ${attributeLabel}: ${attributeValue})</p>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: basePool}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${basePool};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            // Risk thresholds based on RR level\n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              // Get current RR if not provided\n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                // Toggle: si on clique sur le dernier d slectionn, dslectionner tout\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            // Initial color setup\n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const totalPool = basePool;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            this._rollSkillDice(specialization.name, normalDice, riskDice, riskReduction, rollMode);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Handle quick rolling a skill (from dice badge click) - opens dialog\n   */\n  private async _onQuickRollSkill(event: Event): Promise<void> {\n    // Simply call the regular roll skill function which opens the dialog\n    return this._onRollSkill(event);\n  }\n\n  /**\n   * Handle quick rolling a specialization (from dice badge click) - opens dialog\n   */\n  private async _onQuickRollSpecialization(event: Event): Promise<void> {\n    // Simply call the regular roll specialization function which opens the dialog\n    return this._onRollSpecialization(event);\n  }\n\n  /**\n   * Get risk dice count based on RR level\n   */\n  private getRiskDiceByRR(rr: number): number {\n    const riskDiceByRR = [2, 5, 8, 12];\n    return riskDiceByRR[Math.min(3, Math.max(0, rr))] || 2;\n  }\n\n  /**\n   * Handle rolling an attribute\n   */\n  private async _onRollAttribute(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const attributeName = element.dataset.attribute;\n    \n    if (!attributeName) return;\n\n    const attributeValue = (this.actor.system as any).attributes?.[attributeName] || 0;\n    \n    if (attributeValue <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\n      return;\n    }\n\n    // Get RR sources for this attribute\n    const rrSources = this.getRRSources('attribute', attributeName);\n    const autoRR = Math.min(3, rrSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(attributeValue, this.getRiskDiceByRR(autoRR));\n\n    // Get localized attribute name\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${attributeName.toUpperCase()}`);\n\n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (rrSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      rrSources.forEach((source, index) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n\n    // Create a dialog to optionally add modifiers and risk dice\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.ATTRIBUTES.ROLL_TITLE', { name: attributeLabel }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.ATTRIBUTES.BASE_POOL')}: <strong>${attributeValue}</strong></label>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: attributeValue}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${attributeValue};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            // Risk thresholds based on RR level\n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              // Get current RR if not provided\n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                // Toggle: si on clique sur le dernier d slectionn, dslectionner tout\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            // Initial color setup\n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const totalPool = attributeValue;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            this._rollSkillDice(attributeLabel, normalDice, riskDice, riskReduction, rollMode);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Handle rolling a skill\n   */\n  private async _onRollSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No item ID found\");\n      return;\n    }\n\n    const skill = this.actor.items.get(itemId);\n    if (!skill || skill.type !== 'skill') return;\n\n    const skillSystem = skill.system as any;\n    const rating = skillSystem.rating || 0;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    \n    // Get the attribute value from the actor\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    const basePool = rating + attributeValue;\n    \n    if (basePool <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.SKILLS.NO_DICE'));\n      return;\n    }\n\n    // Get localized attribute name\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n    \n    // Get RR sources for skill and attribute\n    const skillRRSources = this.getRRSources('skill', skill.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const allRRSources = [...skillRRSources, ...attributeRRSources.map(s => ({ ...s, featName: s.featName + ` (${attributeLabel})` }))];\n    const autoRR = Math.min(3, allRRSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(basePool, this.getRiskDiceByRR(autoRR));\n\n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (allRRSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      allRRSources.forEach((source) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n\n    // Create a dialog to optionally add modifiers and risk dice\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.SKILLS.ROLL_TITLE', { name: skill.name }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.BASE_POOL')}: <strong>${basePool}</strong></label>\n            <p class=\"notes\">(${game.i18n!.localize('SRA2.SKILLS.RATING')}: ${rating} + ${attributeLabel}: ${attributeValue})</p>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: basePool}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${basePool};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            // Risk thresholds based on RR level\n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              // Get current RR if not provided\n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                // Toggle: si on clique sur le dernier d slectionn, dslectionner tout\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            // Initial color setup\n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const totalPool = basePool;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            this._rollSkillDice(skill.name, normalDice, riskDice, riskReduction, rollMode);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n\n  /**\n   * Roll skill dice and display results with Dice So Nice\n   */\n  private async _rollSkillDice(skillName: string, dicePool: number, riskDice: number = 0, riskReduction: number = 0, rollMode: string = 'normal', weaponDamageValue?: string): Promise<void> {\n    let normalSuccesses = 0;\n    let riskSuccesses = 0;\n    let criticalFailures = 0;\n    let normalDiceResults = '';\n    let riskDiceResults = '';\n    \n    // Define success threshold based on roll mode\n    const getSuccessThreshold = (mode: string): number => {\n      switch (mode) {\n        case 'advantage': return 4;  // 4, 5, 6 = success\n        case 'disadvantage': return 6; // only 6 = success\n        default: return 5;  // 5, 6 = success\n      }\n    };\n    \n    const successThreshold = getSuccessThreshold(rollMode);\n    \n    // Roll normal dice\n    let normalRoll: Roll | null = null;\n    if (dicePool > 0) {\n      normalRoll = new Roll(`${dicePool}d6`);\n      await normalRoll.evaluate();\n      \n      const normalResults = normalRoll.dice[0]?.results || [];\n      normalSuccesses = normalResults.filter((r: any) => r.result >= successThreshold).length;\n      \n      normalDiceResults = normalResults.map((r: any) => {\n        const isSuccess = r.result >= successThreshold;\n        return `<span class=\"die normal ${isSuccess ? 'success' : 'failure'}\">${r.result}</span>`;\n      }).join(' ');\n    }\n    \n    // Roll risk dice\n    let riskRoll: Roll | null = null;\n    if (riskDice > 0) {\n      riskRoll = new Roll(`${riskDice}d6`);\n      await riskRoll.evaluate();\n      \n      const riskResults = riskRoll.dice[0]?.results || [];\n      \n      // Risk dice: success threshold gives 2 successes, 1 gives critical failure\n      riskResults.forEach((r: any) => {\n        if (r.result >= successThreshold) {\n          riskSuccesses += 2; // Double success on risk dice\n        } else if (r.result === 1) {\n          criticalFailures++;\n        }\n      });\n      \n      riskDiceResults = riskResults.map((r: any) => {\n        let cssClass = 'die risk ';\n        if (r.result >= successThreshold) {\n          cssClass += 'success';\n        } else if (r.result === 1) {\n          cssClass += 'critical';\n        } else {\n          cssClass += 'failure';\n        }\n        return `<span class=\"${cssClass}\">${r.result}</span>`;\n      }).join(' ');\n    }\n    \n    // Show Dice So Nice animations if available\n    if ((game as any).dice3d) {\n      const dice3d = (game as any).dice3d;\n      const promises: Promise<any>[] = [];\n      \n      // Show normal dice with gray color\n      if (normalRoll) {\n        promises.push(\n          dice3d.showForRoll(normalRoll, game.user, true, null, false, null, null, {\n            colorset: \"grey\"  // Grey color for normal dice\n          }).catch(() => {})\n        );\n      }\n      \n      // Show risk dice with purple color\n      if (riskRoll) {\n        // Wait a bit before showing risk dice so they appear after normal dice\n        await new Promise(resolve => setTimeout(resolve, 100));\n        promises.push(\n          dice3d.showForRoll(riskRoll, game.user, true, null, false, null, null, {\n            colorset: \"black\"  // Black color for risk dice\n          }).catch(() => {})\n        );\n      }\n      \n      // Wait for all dice animations to complete\n      await Promise.all(promises);\n    }\n    \n    // Apply risk reduction to critical failures\n    const rawCriticalFailures = criticalFailures;\n    criticalFailures = Math.max(0, criticalFailures - riskReduction);\n    \n    const totalSuccesses = normalSuccesses + riskSuccesses;\n    \n    // Build the results display\n    let resultsHtml = '<div class=\"sra2-skill-roll\">';\n    \n    // Dice pool info\n    const totalPool = dicePool + riskDice;\n    resultsHtml += '<div class=\"dice-pool\">';\n    resultsHtml += `<strong>${game.i18n!.localize('SRA2.SKILLS.DICE_POOL')}:</strong> `;\n    resultsHtml += `${totalPool}d6`;\n    if (riskDice > 0) {\n      resultsHtml += ` (${dicePool} ${game.i18n!.localize('SRA2.SKILLS.NORMAL')} + <span class=\"risk-label\">${riskDice} ${game.i18n!.localize('SRA2.SKILLS.RISK')}</span>`;\n      if (riskReduction > 0) {\n        resultsHtml += ` | <span class=\"rr-label\">RR ${riskReduction}</span>`;\n      }\n      resultsHtml += `)`;\n    } else if (riskReduction > 0) {\n      resultsHtml += ` | <span class=\"rr-label\">RR ${riskReduction}</span>`;\n    }\n    \n    // Display roll mode if not normal\n    if (rollMode !== 'normal') {\n      const modeKey = rollMode === 'advantage' ? 'ROLL_MODE_ADVANTAGE' : 'ROLL_MODE_DISADVANTAGE';\n      resultsHtml += ` | <span class=\"mode-label\">${game.i18n!.localize(`SRA2.SKILLS.${modeKey}`)}</span>`;\n    }\n    \n    resultsHtml += '</div>';\n    \n    // Normal dice results\n    if (normalDiceResults) {\n      resultsHtml += '<div class=\"dice-results\">';\n      resultsHtml += `<strong>${game.i18n!.localize('SRA2.SKILLS.NORMAL_DICE')}:</strong> ${normalDiceResults}`;\n      resultsHtml += '</div>';\n    }\n    \n    // Risk dice results\n    if (riskDiceResults) {\n      resultsHtml += '<div class=\"dice-results risk\">';\n      resultsHtml += `<strong>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</strong> ${riskDiceResults}`;\n      resultsHtml += '</div>';\n    }\n    \n    // Total successes\n    resultsHtml += `<div class=\"successes ${totalSuccesses > 0 ? 'has-success' : 'no-success'}\">`;\n    resultsHtml += `<strong>${game.i18n!.localize('SRA2.SKILLS.TOTAL_SUCCESSES')}:</strong> ${totalSuccesses}`;\n    \n    // Weapon Damage Value (VD) displayed next to successes\n    if (weaponDamageValue && weaponDamageValue !== '0') {\n      const strength = (this.actor.system as any).attributes?.strength || 0;\n      let baseVD = 0;\n      let vdDisplay = weaponDamageValue;\n      \n      // Parse the damage value\n      if (weaponDamageValue === 'FOR') {\n        baseVD = strength;\n        vdDisplay = `FOR (${strength})`;\n      } else if (weaponDamageValue.startsWith('FOR+')) {\n        const modifier = parseInt(weaponDamageValue.substring(4)) || 0;\n        baseVD = strength + modifier;\n        vdDisplay = `FOR+${modifier} (${baseVD})`;\n      } else if (weaponDamageValue === 'toxin') {\n        vdDisplay = 'selon toxine';\n        baseVD = -1; // Special case, don't calculate final VD\n      } else {\n        baseVD = parseInt(weaponDamageValue) || 0;\n      }\n      \n      if (baseVD >= 0) {\n        const finalVD = totalSuccesses + baseVD;\n        resultsHtml += ` | `;\n        resultsHtml += `<strong>${game.i18n!.localize('SRA2.FEATS.WEAPON.DAMAGE_VALUE_SHORT')}:</strong> `;\n        resultsHtml += `<span class=\"final-damage-value\">`;\n        resultsHtml += `<span class=\"calculation\">${totalSuccesses} + ${baseVD} = </span>`;\n        resultsHtml += `<span class=\"final-value\">${finalVD}</span>`;\n        resultsHtml += `</span>`;\n      }\n    }\n    \n    resultsHtml += '</div>';\n    \n    // Critical failures with severity levels\n    if (rawCriticalFailures > 0 || riskReduction > 0) {\n      let criticalLabel = '';\n      let criticalClass = '';\n      \n      if (criticalFailures >= 3) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.DISASTER');\n        criticalClass = 'disaster';\n      } else if (criticalFailures === 2) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.CRITICAL_COMPLICATION');\n        criticalClass = 'critical-complication';\n      } else if (criticalFailures === 1) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.MINOR_COMPLICATION');\n        criticalClass = 'minor-complication';\n      } else {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.NO_COMPLICATION');\n        criticalClass = 'reduced-to-zero';\n      }\n      \n      resultsHtml += `<div class=\"critical-failures ${criticalClass}\">`;\n      resultsHtml += `<div class=\"complication-header\">`;\n      resultsHtml += `<div class=\"complication-icon\"></div>`;\n      resultsHtml += `<div class=\"complication-title\">${criticalLabel}</div>`;\n      resultsHtml += `</div>`;\n      \n      if (riskReduction > 0) {\n        resultsHtml += `<div class=\"complication-calculation\">Attaque: ${rawCriticalFailures} - ${riskReduction} RR = ${criticalFailures}</div>`;\n      }\n      \n      resultsHtml += '</div>';\n    }\n    \n    resultsHtml += '</div>';\n    \n    // Create the chat message\n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n      flavor: game.i18n!.format('SRA2.SKILLS.ROLL_FLAVOR', { name: skillName }),\n      content: resultsHtml,\n      sound: CONFIG.sounds?.dice\n    };\n    \n    await ChatMessage.create(messageData);\n  }\n\n  /**\n   * Roll an attack with defense system\n   */\n  private async _rollAttackWithDefense(skillName: string, dicePool: number, riskDice: number = 0, riskReduction: number = 0, rollMode: string = 'normal', weaponDamageValue?: string): Promise<void> {\n    // First, roll the attack\n    const attackResult = await this._performDiceRoll(dicePool, riskDice, riskReduction, rollMode);\n    \n    // Check if there are any targeted tokens\n    const targets = Array.from((game as any).user?.targets || []);\n    \n    if (targets.length === 0 || !weaponDamageValue || weaponDamageValue === '0') {\n      // No target or no weapon damage, just display normal roll\n      await this._displayRollResult(skillName, attackResult, weaponDamageValue);\n      return;\n    }\n    \n    // There's at least one target, ask for defense roll\n    const target = targets[0] as any;\n    const targetActor = target.actor;\n    \n    if (!targetActor) {\n      // No actor on target, just display normal roll\n      await this._displayRollResult(skillName, attackResult, weaponDamageValue);\n      return;\n    }\n    \n    // Prepare defense dialog\n    ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.WAITING_FOR_DEFENSE', { \n      attacker: this.actor.name,\n      defender: targetActor.name,\n      successes: attackResult.totalSuccesses\n    }));\n    \n    // Prompt defense roll\n    await this._promptDefenseRoll(targetActor, attackResult, skillName, weaponDamageValue);\n  }\n\n  /**\n   * Prompt target to make a defense roll\n   */\n  private async _promptDefenseRoll(defenderActor: any, attackResult: any, attackName: string, weaponDamageValue: string): Promise<void> {\n    // Get all skills and specializations from defender\n    const skills = defenderActor.items.filter((i: any) => i.type === 'skill');\n    const allSpecializations = defenderActor.items.filter((i: any) => i.type === 'specialization');\n    \n    // Build skill options HTML\n    let skillOptionsHtml = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.COMBAT.SELECT_DEFENSE_SKILL') + ' --</option>';\n    skills.forEach((skill: any) => {\n      const skillSystem = skill.system as any;\n      const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n      const attributeValue = (defenderActor.system as any).attributes?.[linkedAttribute] || 0;\n      const skillRating = skillSystem.rating || 0;\n      const totalDicePool = attributeValue + skillRating;\n      \n      skillOptionsHtml += `<option value=\"skill-${skill.id}\" data-dice-pool=\"${totalDicePool}\">${skill.name} (${totalDicePool} ds)</option>`;\n      \n      // Add specializations for this skill\n      const specs = allSpecializations.filter((spec: any) => {\n        const linkedSkillName = spec.system.linkedSkill;\n        return linkedSkillName === skill.name;\n      });\n      \n      specs.forEach((spec: any) => {\n        const specSystem = spec.system as any;\n        const specLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const specAttributeValue = (defenderActor.system as any).attributes?.[specLinkedAttribute] || 0;\n        const parentRating = skillRating;\n        const effectiveRating = parentRating + 2;\n        const specTotalDicePool = specAttributeValue + effectiveRating;\n        \n        skillOptionsHtml += `<option value=\"spec-${spec.id}\" data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\">   ${spec.name} (${specTotalDicePool} ds)</option>`;\n      });\n    });\n    \n    // Create defense dialog\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.COMBAT.DEFENSE_ROLL_TITLE', { \n        attacker: this.actor.name,\n        defender: defenderActor.name\n      }),\n      content: `\n        <form class=\"sra2-defense-roll-dialog\">\n          <div class=\"form-group\">\n            <p><strong>${game.i18n!.localize('SRA2.COMBAT.ATTACK_INFO')}:</strong></p>\n            <p>${attackName}</p>\n            <p><strong>${game.i18n!.localize('SRA2.COMBAT.ATTACK_SUCCESSES')}:</strong> ${attackResult.totalSuccesses}</p>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.COMBAT.SELECT_DEFENSE_SKILL')}:</label>\n            <select id=\"defense-skill-select\" class=\"skill-select\">\n              ${skillOptionsHtml}\n            </select>\n          </div>\n        </form>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-shield-alt\"></i>',\n          label: game.i18n!.localize('SRA2.COMBAT.DEFEND'),\n          callback: async (html: any) => {\n            const selectedValue = html.find('#defense-skill-select').val();\n            if (!selectedValue || selectedValue === '') {\n              ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.NO_DEFENSE_SKILL_SELECTED'));\n              // No defense, full damage\n              await this._displayAttackResult(attackName, attackResult, null, weaponDamageValue, defenderActor.name, defenderActor);\n              return;\n            }\n            \n            const [itemType, itemId] = (selectedValue as string).split('-');\n            const defenseItem = defenderActor.items.get(itemId);\n            \n            if (defenseItem) {\n              await this._rollDefenseAndCalculateDamage(defenseItem, itemType as 'skill' | 'spec', attackName, attackResult, weaponDamageValue, defenderActor);\n            }\n          }\n        },\n        noDefense: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('SRA2.COMBAT.NO_DEFENSE'),\n          callback: async () => {\n            // No defense, full damage\n            await this._displayAttackResult(attackName, attackResult, null, weaponDamageValue, defenderActor.name, defenderActor);\n          }\n        }\n      },\n      default: 'roll'\n    }, { width: 500 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Roll defense and calculate final damage\n   */\n  private async _rollDefenseAndCalculateDamage(defenseItem: any, itemType: 'skill' | 'spec', attackName: string, attackResult: any, weaponDamageValue: string, defenderActor: any): Promise<void> {\n    const defenseSystem = defenseItem.system as any;\n    const linkedAttribute = defenseSystem.linkedAttribute || 'strength';\n    const attributeValue = (defenderActor.system as any).attributes?.[linkedAttribute] || 0;\n    \n    let rating = 0;\n    let defenseName = defenseItem.name;\n    \n    if (itemType === 'skill') {\n      rating = defenseSystem.rating || 0;\n    } else {\n      // Specialization\n      const parentSkillName = defenseSystem.linkedSkill;\n      const parentSkill = defenderActor.items.find((i: any) => i.type === 'skill' && i.name === parentSkillName);\n      const parentRating = parentSkill ? (parentSkill.system.rating || 0) : 0;\n      rating = parentRating + 2;\n    }\n    \n    const basePool = rating + attributeValue;\n    \n    if (basePool <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.SKILLS.NO_DICE'));\n      // No defense dice, full damage\n      await this._displayAttackResult(attackName, attackResult, null, weaponDamageValue, defenderActor.name, defenderActor);\n      return;\n    }\n    \n    // Get RR for defense\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n    const skillRRSources = itemType === 'skill' ? this._getRRSourcesForActor(defenderActor, 'skill', defenseItem.name) : this._getRRSourcesForActor(defenderActor, 'specialization', defenseItem.name);\n    const attributeRRSources = this._getRRSourcesForActor(defenderActor, 'attribute', linkedAttribute);\n    const allRRSources = [...skillRRSources, ...attributeRRSources.map(s => ({ ...s, featName: s.featName + ` (${attributeLabel})` }))];\n    const autoRR = Math.min(3, allRRSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(basePool, this.getRiskDiceByRR(autoRR));\n    \n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (allRRSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      allRRSources.forEach((source) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n    \n    // Create defense roll dialog\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.COMBAT.DEFENSE_ROLL_CONFIG', { skill: defenseName }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.BASE_POOL')}: <strong>${basePool}</strong></label>\n            <p class=\"notes\">(${game.i18n!.localize(itemType === 'skill' ? 'SRA2.SKILLS.RATING' : 'SRA2.SPECIALIZATIONS.BONUS')}: ${rating} + ${attributeLabel}: ${attributeValue})</p>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: basePool}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${basePool};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-shield-alt\"></i>',\n          label: game.i18n!.localize('SRA2.COMBAT.DEFEND'),\n          callback: async (html: any) => {\n            const totalPool = basePool;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            \n            // Roll defense\n            const defenseResult = await this._performDiceRoll(normalDice, riskDice, riskReduction, rollMode);\n            defenseResult.skillName = defenseName;\n            \n            // Display combined result\n            await this._displayAttackResult(attackName, attackResult, defenseResult, weaponDamageValue, defenderActor.name, defenderActor);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Perform dice roll and return results\n   */\n  private async _performDiceRoll(dicePool: number, riskDice: number, riskReduction: number, rollMode: string): Promise<any> {\n    let normalSuccesses = 0;\n    let riskSuccesses = 0;\n    let criticalFailures = 0;\n    let normalDiceResults = '';\n    let riskDiceResults = '';\n    \n    const getSuccessThreshold = (mode: string): number => {\n      switch (mode) {\n        case 'advantage': return 4;\n        case 'disadvantage': return 6;\n        default: return 5;\n      }\n    };\n    \n    const successThreshold = getSuccessThreshold(rollMode);\n    \n    // Roll normal dice\n    let normalRoll: Roll | null = null;\n    if (dicePool > 0) {\n      normalRoll = new Roll(`${dicePool}d6`);\n      await normalRoll.evaluate();\n      \n      const normalResults = normalRoll.dice[0]?.results || [];\n      normalSuccesses = normalResults.filter((r: any) => r.result >= successThreshold).length;\n      \n      normalDiceResults = normalResults.map((r: any) => {\n        const isSuccess = r.result >= successThreshold;\n        return `<span class=\"die normal ${isSuccess ? 'success' : 'failure'}\">${r.result}</span>`;\n      }).join(' ');\n    }\n    \n    // Roll risk dice\n    let riskRoll: Roll | null = null;\n    if (riskDice > 0) {\n      riskRoll = new Roll(`${riskDice}d6`);\n      await riskRoll.evaluate();\n      \n      const riskResults = riskRoll.dice[0]?.results || [];\n      \n      riskResults.forEach((r: any) => {\n        if (r.result >= successThreshold) {\n          riskSuccesses += 2;\n        } else if (r.result === 1) {\n          criticalFailures++;\n        }\n      });\n      \n      riskDiceResults = riskResults.map((r: any) => {\n        let cssClass = 'die risk ';\n        if (r.result >= successThreshold) {\n          cssClass += 'success';\n        } else if (r.result === 1) {\n          cssClass += 'critical';\n        } else {\n          cssClass += 'failure';\n        }\n        return `<span class=\"${cssClass}\">${r.result}</span>`;\n      }).join(' ');\n    }\n    \n    // Show Dice So Nice animations if available\n    if ((game as any).dice3d) {\n      const dice3d = (game as any).dice3d;\n      const promises: Promise<any>[] = [];\n      \n      if (normalRoll) {\n        promises.push(\n          dice3d.showForRoll(normalRoll, game.user, true, null, false, null, null, {\n            colorset: \"grey\"\n          }).catch(() => {})\n        );\n      }\n      \n      if (riskRoll) {\n        await new Promise(resolve => setTimeout(resolve, 100));\n        promises.push(\n          dice3d.showForRoll(riskRoll, game.user, true, null, false, null, null, {\n            colorset: \"black\"\n          }).catch(() => {})\n        );\n      }\n      \n      await Promise.all(promises);\n    }\n    \n    const rawCriticalFailures = criticalFailures;\n    criticalFailures = Math.max(0, criticalFailures - riskReduction);\n    const totalSuccesses = normalSuccesses + riskSuccesses;\n    \n    return {\n      dicePool,\n      riskDice,\n      riskReduction,\n      rollMode,\n      normalSuccesses,\n      riskSuccesses,\n      totalSuccesses,\n      rawCriticalFailures,\n      criticalFailures,\n      normalDiceResults,\n      riskDiceResults\n    };\n  }\n\n  /**\n   * Display attack result with optional defense\n   */\n  private async _displayAttackResult(attackName: string, attackResult: any, defenseResult: any | null, weaponDamageValue: string, defenderName?: string, defenderActor?: any): Promise<void> {\n    const strength = (this.actor.system as any).attributes?.strength || 0;\n    let baseVD = 0;\n    let vdDisplay = weaponDamageValue;\n    \n    // Parse the damage value\n    if (weaponDamageValue === 'FOR') {\n      baseVD = strength;\n      vdDisplay = `FOR (${strength})`;\n    } else if (weaponDamageValue.startsWith('FOR+')) {\n      const modifier = parseInt(weaponDamageValue.substring(4)) || 0;\n      baseVD = strength + modifier;\n      vdDisplay = `FOR+${modifier} (${baseVD})`;\n    } else if (weaponDamageValue === 'toxin') {\n      vdDisplay = 'selon toxine';\n      baseVD = -1;\n    } else {\n      baseVD = parseInt(weaponDamageValue) || 0;\n    }\n    \n    let resultsHtml = '<div class=\"sra2-combat-roll\">';\n    \n    // Determine outcome first\n    const attackSuccess = !defenseResult || defenseResult.totalSuccesses <= attackResult.totalSuccesses;\n    \n    // Display outcome header FIRST\n    if (attackSuccess) {\n      resultsHtml += `<div class=\"combat-outcome-header attack-success\">`;\n      resultsHtml += `<div class=\"outcome-icon\"><i class=\"fas fa-crosshairs\"></i></div>`;\n      resultsHtml += `<div class=\"outcome-text\">${game.i18n!.localize('SRA2.COMBAT.ATTACK_SUCCESS')}</div>`;\n      resultsHtml += '</div>';\n    } else {\n      resultsHtml += `<div class=\"combat-outcome-header attack-failed\">`;\n      resultsHtml += `<div class=\"outcome-icon\"><i class=\"fas fa-shield-alt\"></i></div>`;\n      resultsHtml += `<div class=\"outcome-text\">${game.i18n!.localize('SRA2.COMBAT.ATTACK_FAILED')}</div>`;\n      resultsHtml += '</div>';\n    }\n    \n    // Attack section\n    resultsHtml += '<div class=\"attack-section\">';\n    resultsHtml += `<h3>${game.i18n!.localize('SRA2.COMBAT.ATTACK')}: ${attackName}</h3>`;\n    resultsHtml += this._buildDiceResultsHtml(attackResult, weaponDamageValue);\n    resultsHtml += '</div>';\n    \n    // Defense section\n    if (defenseResult) {\n      resultsHtml += '<div class=\"defense-section\">';\n      resultsHtml += `<h3>${game.i18n!.localize('SRA2.COMBAT.DEFENSE')}: ${defenseResult.skillName}</h3>`;\n      resultsHtml += this._buildDiceResultsHtml(defenseResult);\n      resultsHtml += '</div>';\n    }\n    \n    // Combat result\n    resultsHtml += '<div class=\"combat-result\">';\n    \n    if (!attackSuccess) {\n      // Defense successful - ECHEC DE L'ATTAQUE\n      resultsHtml += `<div class=\"defense-success\">`;\n      resultsHtml += `<p>${game.i18n!.format('SRA2.COMBAT.DEFENSE_BLOCKS_ATTACK', {\n        defender: defenderName || '?',\n        defenseSuccesses: defenseResult!.totalSuccesses,\n        attackSuccesses: attackResult.totalSuccesses\n      })}</p>`;\n      resultsHtml += '</div>';\n    } else {\n      // Attack successful, calculate damage\n      const defenseSuccesses = defenseResult ? defenseResult.totalSuccesses : 0;\n      const netSuccesses = attackResult.totalSuccesses - defenseSuccesses;\n      \n      if (baseVD >= 0) {\n        const finalDamage = baseVD + netSuccesses;\n        resultsHtml += `<div class=\"final-damage-value\">`;\n        resultsHtml += `<div class=\"damage-label\">${game.i18n!.localize('SRA2.FEATS.WEAPON.DAMAGE')} : ${finalDamage}</div>`;\n        if (defenseResult) {\n          resultsHtml += `<div class=\"calculation\">${baseVD} VD + ${attackResult.totalSuccesses} succs attaque - ${defenseSuccesses} succs dfense</div>`;\n        } else {\n          resultsHtml += `<div class=\"calculation\">${attackResult.totalSuccesses} succs + ${baseVD} VD</div>`;\n        }\n        \n        // Add button to apply damage if we have a defender\n        if (defenderActor && defenderName) {\n          resultsHtml += `<button class=\"apply-damage-btn\" data-defender-id=\"${defenderActor.id}\" data-damage=\"${finalDamage}\" data-defender-name=\"${defenderName}\" title=\"${game.i18n!.format('SRA2.COMBAT.APPLY_DAMAGE_TITLE', {damage: finalDamage, defender: defenderName})}\">`;\n          resultsHtml += `<i class=\"fas fa-heart-broken\"></i> ${game.i18n!.localize('SRA2.COMBAT.APPLY_DAMAGE')}`;\n          resultsHtml += `</button>`;\n        }\n        \n        resultsHtml += '</div>';\n      }\n    }\n    \n    resultsHtml += '</div>';\n    resultsHtml += '</div>';\n    \n    // Create the chat message\n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n      flavor: game.i18n!.format('SRA2.COMBAT.ATTACK_ROLL', { name: attackName }),\n      content: resultsHtml,\n      sound: CONFIG.sounds?.dice\n    };\n    \n    await ChatMessage.create(messageData);\n  }\n\n  /**\n   * Apply damage to a defender\n   */\n  static async applyDamage(defenderId: string, damageValue: number, defenderName: string): Promise<void> {\n    const defender = game.actors?.get(defenderId);\n    \n    if (!defender) {\n      ui.notifications?.error(`Cannot find defender: ${defenderName}`);\n      return;\n    }\n    \n    const defenderSystem = defender.system as any;\n    const damageThresholds = defenderSystem.damageThresholds?.withArmor || {\n      light: 1,\n      moderate: 4,\n      severe: 7\n    };\n    \n    // Deep copy of damage object with arrays\n    let damage = {\n      light: [...(defenderSystem.damage?.light || [])],\n      severe: [...(defenderSystem.damage?.severe || [])],\n      incapacitating: defenderSystem.damage?.incapacitating || false\n    };\n    let damageType = '';\n    let overflow = false;\n    \n    // Determine damage type based on thresholds\n    if (damageValue >= damageThresholds.severe) {\n      // Incapacitating wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\n      damage.incapacitating = true;\n    } else if (damageValue >= damageThresholds.moderate) {\n      // Severe wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\n      \n      // Find first empty severe box\n      let applied = false;\n      for (let i = 0; i < damage.severe.length; i++) {\n        if (!damage.severe[i]) {\n          damage.severe[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in severe, overflow to incapacitating\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n        damage.incapacitating = true;\n        overflow = true;\n      }\n    } else if (damageValue >= damageThresholds.light) {\n      // Light wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\n      \n      // Find first empty light box\n      let applied = false;\n      for (let i = 0; i < damage.light.length; i++) {\n        if (!damage.light[i]) {\n          damage.light[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in light, overflow to severe\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\n        \n        // Try to apply to severe\n        let severeApplied = false;\n        for (let i = 0; i < damage.severe.length; i++) {\n          if (!damage.severe[i]) {\n            damage.severe[i] = true;\n            severeApplied = true;\n            break;\n          }\n        }\n        \n        // If no space in severe either, overflow to incapacitating\n        if (!severeApplied) {\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n          damage.incapacitating = true;\n        }\n        overflow = true;\n      }\n    } else {\n      // Damage below light threshold, no wound\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \n        damage: `${damageValue} (en dessous du seuil)`,\n        target: defenderName \n      }));\n      return;\n    }\n    \n    // Update the actor's damage\n    await defender.update({ 'system.damage': damage });\n    \n    // Check if now incapacitated\n    if (damage.incapacitating === true) {\n      ui.notifications?.error(game.i18n!.format('SRA2.COMBAT.NOW_INCAPACITATED', { target: defenderName }));\n    } else {\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \n        damage: overflow ? `${damageType} (dbordement)` : damageType,\n        target: defenderName \n      }));\n    }\n  }\n\n  /**\n   * Build dice results HTML\n   */\n  private _buildDiceResultsHtml(rollResult: any, weaponDamageValue?: string): string {\n    let html = '';\n    \n    const totalPool = rollResult.dicePool + rollResult.riskDice;\n    html += '<div class=\"dice-pool\">';\n    html += `<strong>${game.i18n!.localize('SRA2.SKILLS.DICE_POOL')}:</strong> `;\n    html += `${totalPool}d6`;\n    if (rollResult.riskDice > 0) {\n      html += ` (${rollResult.dicePool} ${game.i18n!.localize('SRA2.SKILLS.NORMAL')} + <span class=\"risk-label\">${rollResult.riskDice} ${game.i18n!.localize('SRA2.SKILLS.RISK')}</span>`;\n      if (rollResult.riskReduction > 0) {\n        html += ` | <span class=\"rr-label\">RR ${rollResult.riskReduction}</span>`;\n      }\n      html += `)`;\n    } else if (rollResult.riskReduction > 0) {\n      html += ` | <span class=\"rr-label\">RR ${rollResult.riskReduction}</span>`;\n    }\n    html += '</div>';\n    \n    // Normal dice results\n    if (rollResult.normalDiceResults) {\n      html += '<div class=\"dice-results\">';\n      html += `<strong>${game.i18n!.localize('SRA2.SKILLS.NORMAL_DICE')}:</strong> ${rollResult.normalDiceResults}`;\n      html += '</div>';\n    }\n    \n    // Risk dice results\n    if (rollResult.riskDiceResults) {\n      html += '<div class=\"dice-results risk\">';\n      html += `<strong>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</strong> ${rollResult.riskDiceResults}`;\n      html += '</div>';\n    }\n    \n    // Total successes with weapon damage value next to it\n    html += `<div class=\"successes ${rollResult.totalSuccesses > 0 ? 'has-success' : 'no-success'}\">`;\n    html += `<strong>${game.i18n!.localize('SRA2.SKILLS.TOTAL_SUCCESSES')}:</strong> ${rollResult.totalSuccesses}`;\n    \n    // Weapon Damage Value (VD) displayed next to successes\n    if (weaponDamageValue && weaponDamageValue !== '0') {\n      const strength = (this.actor.system as any).attributes?.strength || 0;\n      let baseVD = 0;\n      let vdDisplay = weaponDamageValue;\n      \n      // Parse the damage value\n      if (weaponDamageValue === 'FOR') {\n        baseVD = strength;\n        vdDisplay = `FOR (${strength})`;\n      } else if (weaponDamageValue.startsWith('FOR+')) {\n        const modifier = parseInt(weaponDamageValue.substring(4)) || 0;\n        baseVD = strength + modifier;\n        vdDisplay = `FOR+${modifier} (${baseVD})`;\n      } else if (weaponDamageValue === 'toxin') {\n        vdDisplay = 'selon toxine';\n        baseVD = -1; // Special case, don't calculate final VD\n      } else {\n        baseVD = parseInt(weaponDamageValue) || 0;\n      }\n      \n      if (baseVD >= 0) {\n        const finalVD = rollResult.totalSuccesses + baseVD;\n        html += ` | `;\n        html += `<strong>${game.i18n!.localize('SRA2.FEATS.WEAPON.DAMAGE_VALUE_SHORT')}:</strong> `;\n        html += `<span class=\"final-damage-value\">`;\n        html += `<span class=\"calculation\">${rollResult.totalSuccesses} + ${baseVD} = </span>`;\n        html += `<span class=\"final-value\">${finalVD}</span>`;\n        html += `</span>`;\n      }\n    }\n    \n    html += '</div>';\n    \n    // Critical failures\n    if (rollResult.rawCriticalFailures > 0 || rollResult.riskReduction > 0) {\n      let criticalLabel = '';\n      let criticalClass = '';\n      \n      if (rollResult.criticalFailures >= 3) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.DISASTER');\n        criticalClass = 'disaster';\n      } else if (rollResult.criticalFailures === 2) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.CRITICAL_COMPLICATION');\n        criticalClass = 'critical-complication';\n      } else if (rollResult.criticalFailures === 1) {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.MINOR_COMPLICATION');\n        criticalClass = 'minor-complication';\n      } else {\n        criticalLabel = game.i18n!.localize('SRA2.SKILLS.NO_COMPLICATION');\n        criticalClass = 'reduced-to-zero';\n      }\n      \n      html += `<div class=\"critical-failures ${criticalClass}\">`;\n      html += `<div class=\"complication-header\">`;\n      html += `<div class=\"complication-icon\"></div>`;\n      html += `<div class=\"complication-title\">${criticalLabel}</div>`;\n      html += `</div>`;\n      \n      if (rollResult.riskReduction > 0) {\n        html += `<div class=\"complication-calculation\">Attaque: ${rollResult.rawCriticalFailures} - ${rollResult.riskReduction} RR = ${rollResult.criticalFailures}</div>`;\n      }\n      \n      html += '</div>';\n    }\n    \n    return html;\n  }\n\n  /**\n   * Display simple roll result (without defense)\n   */\n  private async _displayRollResult(skillName: string, rollResult: any, weaponDamageValue?: string): Promise<void> {\n    let resultsHtml = '<div class=\"sra2-skill-roll\">';\n    resultsHtml += this._buildDiceResultsHtml(rollResult, weaponDamageValue);\n    resultsHtml += '</div>';\n    \n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n      flavor: game.i18n!.format('SRA2.SKILLS.ROLL_FLAVOR', { name: skillName }),\n      content: resultsHtml,\n      sound: CONFIG.sounds?.dice\n    };\n    \n    await ChatMessage.create(messageData);\n  }\n\n  /**\n   * Get RR sources for an actor\n   */\n  private _getRRSourcesForActor(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\n    const sources: Array<{featName: string, rrValue: number}> = [];\n    \n    const feats = actor.items.filter((item: any) => \n      item.type === 'feat' && \n      item.system.active === true\n    );\n    \n    for (const feat of feats) {\n      const featSystem = feat.system as any;\n      const rrList = featSystem.rrList || [];\n      \n      for (const rrEntry of rrList) {\n        const rrType = rrEntry.rrType;\n        const rrValue = rrEntry.rrValue || 0;\n        const rrTarget = rrEntry.rrTarget || '';\n        \n        if (rrType === itemType && rrTarget === itemName && rrValue > 0) {\n          sources.push({\n            featName: feat.name,\n            rrValue: rrValue\n          });\n        }\n      }\n    }\n    \n    return sources;\n  }\n\n  /**\n   * Handle drag start for feat items\n   */\n  protected override _onDragStart(event: DragEvent): void {\n    const itemId = (event.currentTarget as HTMLElement).dataset.itemId;\n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n\n    const dragData = {\n      type: 'Item',\n      uuid: item.uuid,\n    };\n\n    event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\n  }\n\n  /**\n   * Override to handle dropping feats and skills\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const data = TextEditor.getDragEventData(event) as any;\n    const dropTarget = (event.target as HTMLElement).closest('[data-drop-zone]') as HTMLElement;\n    \n    // Handle Item drops\n    if (data && data.type === 'Item') {\n      const item = await Item.implementation.fromDropData(data) as any;\n      \n      if (!item) return super._onDrop(event);\n      \n      // Check if dropping in metatype section\n      if (dropTarget && dropTarget.dataset.dropZone === 'metatype') {\n        if (item.type === 'metatype') {\n          // Check if the item is from a compendium or another actor\n          if (!item.actor || item.actor.id !== this.actor.id) {\n            // Check if there's already a metatype\n            const existingMetatype = this.actor.items.find((i: any) => i.type === 'metatype');\n            \n            if (existingMetatype) {\n              const message = game.i18n!.localize('SRA2.METATYPES.ONLY_ONE_METATYPE');\n              ui.notifications?.warn(message);\n              return;\n            }\n            \n            await this.actor.createEmbeddedDocuments('Item', [item.toObject()]);\n            return;\n          }\n        } else {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.METATYPES.ONLY_METATYPES'));\n          return;\n        }\n      }\n      \n      // Check if dropping in feats section\n      if (dropTarget && dropTarget.dataset.dropZone === 'feat') {\n        if (item.type === 'feat') {\n          // Check if the item is from a compendium or another actor\n          if (!item.actor || item.actor.id !== this.actor.id) {\n            // Check for duplicates by name\n            const existingFeat = this.actor.items.find((i: any) => \n              i.type === 'feat' && i.name === item.name\n            );\n            \n            if (existingFeat) {\n              const message = game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: item.name });\n              ui.notifications?.warn(message);\n              return;\n            }\n            \n            await this.actor.createEmbeddedDocuments('Item', [item.toObject()]);\n            return;\n          }\n        } else {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.ONLY_FEATS'));\n          return;\n        }\n      }\n      \n      // Check if dropping in skills section\n      if (dropTarget && dropTarget.dataset.dropZone === 'skill') {\n        if (item.type === 'skill' || item.type === 'specialization') {\n          // Check if the item is from a compendium or another actor\n          if (!item.actor || item.actor.id !== this.actor.id) {\n            // Check for duplicates by name\n            const existingItem = this.actor.items.find((i: any) => \n              i.type === item.type && i.name === item.name\n            );\n            \n            if (existingItem) {\n              const messageKey = item.type === 'skill' ? 'SRA2.SKILLS.ALREADY_EXISTS' : 'SRA2.SPECIALIZATIONS.ALREADY_EXISTS';\n              const message = game.i18n!.format(messageKey, { name: item.name });\n              ui.notifications?.warn(message);\n              return;\n            }\n            \n            await this.actor.createEmbeddedDocuments('Item', [item.toObject()]);\n            return;\n          }\n        } else {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.SKILLS.ONLY_SKILLS'));\n          return;\n        }\n      }\n    }\n\n    return super._onDrop(event);\n  }\n\n  /**\n   * Handle skill search input\n   */\n  private searchTimeout: any = null;\n  \n  private async _onSkillSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = input.value.trim().toLowerCase();\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.searchTimeout) {\n      clearTimeout(this.searchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.searchTimeout = setTimeout(async () => {\n      await this._performSkillSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual skill search in compendiums and world items\n   */\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    \n    // Store search term for potential creation\n    this.lastSearchTerm = searchTerm;\n    \n    // Search in world items first\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === 'skill' && item.name.toLowerCase().includes(searchTerm)) {\n          // Check if skill already exists on actor\n          const existingSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === item.name\n          );\n          \n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            pack: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\n            exists: !!existingSkill\n          });\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for skills that match the search term\n      for (const doc of documents) {\n        if (doc.type === 'skill' && doc.name.toLowerCase().includes(searchTerm)) {\n          // Check if skill already exists on actor\n          const existingSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === doc.name\n          );\n          \n          results.push({\n            name: doc.name,\n            uuid: doc.uuid,\n            pack: pack.title,\n            exists: !!existingSkill\n          });\n        }\n      }\n    }\n    \n    // Display results\n    this._displaySkillSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display skill search results\n   */\n  private lastSearchTerm: string = '';\n  \n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): void {\n    // Check if exact match exists on the actor\n    const formattedSearchTerm = this.lastSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatchOnActor = this.actor.items.find((i: any) => \n      i.type === 'skill' && i.name.toLowerCase() === this.lastSearchTerm.toLowerCase()\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\n          </div>\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SKILLS.CREATE_SKILL')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const disabledClass = result.exists ? 'disabled' : '';\n        const buttonText = result.exists ? '' : game.i18n!.localize('SRA2.SKILLS.ADD_SKILL');\n        \n        html += `\n          <div class=\"search-result-item ${disabledClass}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.pack}</span>\n            </div>\n            <button class=\"add-skill-btn\" data-uuid=\"${result.uuid}\" ${result.exists ? 'disabled' : ''}>\n              ${buttonText}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist on actor\n      if (!exactMatchOnActor) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SKILLS.CREATE_NEW')}</span>\n            </div>\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSearchTerm}\">\n              ${game.i18n!.localize('SRA2.SKILLS.CREATE')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers to buttons\n    $(resultsDiv).find('.add-skill-btn').on('click', this._onAddSkillFromSearch.bind(this));\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\n    \n    // Make entire result items clickable (except disabled ones and create button)\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-skill-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-skill-btn')[0] as HTMLButtonElement;\n      if (button && !button.disabled) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n  }\n\n  /**\n   * Handle adding a skill from search results\n   */\n  private async _onAddSkillFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const uuid = button.dataset.uuid;\n    \n    if (!uuid) return;\n    \n    // Get the skill from the compendium\n    const skill = await fromUuid(uuid as any) as any;\n    \n    if (!skill) {\n      ui.notifications?.error('Skill not found');\n      return;\n    }\n    \n    // Check if skill already exists\n    const existingSkill = this.actor.items.find((i: any) => \n      i.type === 'skill' && i.name === skill.name\n    );\n    \n    if (existingSkill) {\n      ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: skill.name }));\n      return;\n    }\n    \n    // Add the skill to the actor\n    await this.actor.createEmbeddedDocuments('Item', [skill.toObject()]);\n    \n    // Mark button as added\n    button.textContent = '';\n    button.disabled = true;\n    button.closest('.search-result-item')?.classList.add('disabled');\n    \n    ui.notifications?.info(`${skill.name} ${game.i18n!.localize('SRA2.SKILLS.ADD_SKILL')}`);\n  }\n\n  /**\n   * Handle skill search focus\n   */\n  private _onSkillSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle skill search blur\n   */\n  private _onSkillSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle creating a new skill from search\n   */\n  private async _onCreateNewSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Capitalize first letter of each word\n    const formattedName = skillName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new skill with default values\n    const skillData = {\n      name: formattedName,\n      type: 'skill',\n      system: {\n        rating: 1,\n        linkedAttribute: 'strength',\n        description: ''\n      }\n    } as any;\n    \n    // Add the skill to the actor\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [skillData]) as any;\n    \n    if (createdItems && createdItems.length > 0) {\n      const newSkill = createdItems[0] as any;\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      // Open the skill sheet for editing\n      if (newSkill && newSkill.sheet) {\n        setTimeout(() => {\n          newSkill.sheet.render(true);\n        }, 100);\n      }\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.SKILL_CREATED', { name: formattedName }));\n    }\n  }\n\n  /**\n   * FEAT SEARCH FUNCTIONS\n   */\n  \n  private featSearchTimeout: any = null;\n  private lastFeatSearchTerm: string = '';\n  \n  /**\n   * Handle feat search input\n   */\n  private async _onFeatSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = input.value.trim().toLowerCase();\n    const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.featSearchTimeout) {\n      clearTimeout(this.featSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.featSearchTimeout = setTimeout(async () => {\n      await this._performFeatSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual feat search in compendiums and world items\n   */\n  private async _performFeatSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    \n    // Store search term for potential creation\n    this.lastFeatSearchTerm = searchTerm;\n    \n    // Search in world items first\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === 'feat' && item.name.toLowerCase().includes(searchTerm)) {\n          // Check if feat already exists on actor\n          const existingFeat = this.actor.items.find((i: any) => \n            i.type === 'feat' && i.name === item.name\n          );\n          \n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            pack: game.i18n!.localize('SRA2.FEATS.WORLD_ITEMS'),\n            featType: item.system.featType,\n            exists: !!existingFeat\n          });\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for feats that match the search term\n      for (const doc of documents) {\n        if (doc.type === 'feat' && doc.name.toLowerCase().includes(searchTerm)) {\n          // Check if feat already exists on actor\n          const existingFeat = this.actor.items.find((i: any) => \n            i.type === 'feat' && i.name === doc.name\n          );\n          \n          results.push({\n            name: doc.name,\n            uuid: doc.uuid,\n            pack: pack.title,\n            featType: doc.system.featType,\n            exists: !!existingFeat\n          });\n        }\n      }\n    }\n    \n    // Display results\n    this._displayFeatSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display feat search results\n   */\n  private _displayFeatSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\n    // Check if exact match exists on the actor\n    const formattedSearchTerm = this.lastFeatSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatchOnActor = this.actor.items.find((i: any) => \n      i.type === 'feat' && i.name.toLowerCase() === this.lastFeatSearchTerm.toLowerCase()\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message and type selector\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.FEATS.SEARCH_NO_RESULTS')}\n          </div>\n          <select class=\"feat-type-selector\">\n            <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\n            <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\n            <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\n            <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\n            <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\n            <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\n            <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\n            <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\n            <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\n            <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\n            <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\n          </select>\n          <button class=\"create-feat-btn\" data-feat-name=\"${this.lastFeatSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.FEATS.CREATE')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const disabledClass = result.exists ? 'disabled' : '';\n        const buttonText = result.exists ? '' : game.i18n!.localize('SRA2.FEATS.ADD_FEAT');\n        const featTypeLabel = game.i18n!.localize(`SRA2.FEATS.FEAT_TYPE.${result.featType.toUpperCase().replace('-', '_')}`);\n        \n        html += `\n          <div class=\"search-result-item ${disabledClass}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.pack} - ${featTypeLabel}</span>\n            </div>\n            <button class=\"add-feat-btn\" data-uuid=\"${result.uuid}\" ${result.exists ? 'disabled' : ''}>\n              ${buttonText}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist on actor\n      if (!exactMatchOnActor) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.FEATS.CREATE_NEW')}</span>\n            </div>\n            <select class=\"feat-type-selector-inline\">\n              <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\n              <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\n              <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\n              <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\n              <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\n              <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\n              <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\n              <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\n              <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\n              <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\n              <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\n            </select>\n            <button class=\"create-feat-btn-inline\" data-feat-name=\"${this.lastFeatSearchTerm}\">\n              ${game.i18n!.localize('SRA2.FEATS.CREATE')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers\n    $(resultsDiv).find('.add-feat-btn').on('click', this._onAddFeatFromSearch.bind(this));\n    $(resultsDiv).find('.create-feat-btn, .create-feat-btn-inline').on('click', this._onCreateNewFeat.bind(this));\n    \n    // Make entire result items clickable (except disabled ones and create button)\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-feat-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-feat-btn')[0] as HTMLButtonElement;\n      if (button && !button.disabled) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button or select\n      if ($(event.target).closest('.create-feat-btn-inline, .feat-type-selector-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-feat-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle adding a feat from search results\n   */\n  private async _onAddFeatFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const uuid = button.dataset.uuid;\n    \n    if (!uuid) return;\n    \n    // Get the feat from the compendium\n    const feat = await fromUuid(uuid as any) as any;\n    \n    if (!feat) {\n      ui.notifications?.error('Feat not found');\n      return;\n    }\n    \n    // Check if feat already exists\n    const existingFeat = this.actor.items.find((i: any) => \n      i.type === 'feat' && i.name === feat.name\n    );\n    \n    if (existingFeat) {\n      ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: feat.name }));\n      return;\n    }\n    \n    // Add the feat to the actor\n    await this.actor.createEmbeddedDocuments('Item', [feat.toObject()]);\n    \n    // Mark button as added\n    button.textContent = '';\n    button.disabled = true;\n    button.closest('.search-result-item')?.classList.add('disabled');\n    \n    ui.notifications?.info(`${feat.name} ${game.i18n!.localize('SRA2.FEATS.ADD_FEAT')}`);\n  }\n\n  /**\n   * Handle feat search focus\n   */\n  private _onFeatSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle feat search blur\n   */\n  private _onFeatSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any select element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if a select or other element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle sending a catchphrase to chat\n   */\n  private async _onSendCatchphrase(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const catchphrase = element.dataset.catchphrase;\n    \n    if (!catchphrase) return;\n\n    // Create the chat message\n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n      content: `<div class=\"sra2-catchphrase\">${catchphrase}</div>`\n    };\n    \n    await ChatMessage.create(messageData as any);\n  }\n\n  /**\n   * Handle rolling a weapon\n   */\n  private async _onRollWeapon(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No weapon ID found\");\n      return;\n    }\n\n    const weapon = this.actor.items.get(itemId);\n    if (!weapon || weapon.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(weapon, 'weapon');\n  }\n\n  /**\n   * Handle rolling a spell\n   */\n  private async _onRollSpell(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No spell ID found\");\n      return;\n    }\n\n    const spell = this.actor.items.get(itemId);\n    if (!spell || spell.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(spell, 'spell');\n  }\n\n  /**\n   * Handle rolling a weapon/spell (old type)\n   */\n  private async _onRollWeaponSpell(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No weapon/spell ID found\");\n      return;\n    }\n\n    const item = this.actor.items.get(itemId);\n    if (!item || item.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(item, 'weapon-spell');\n  }\n\n  /**\n   * Handle rolling dice for a weapon or spell\n   */\n  private async _rollWeaponOrSpell(item: any, type: 'weapon' | 'spell' | 'weapon-spell'): Promise<void> {\n    const itemSystem = item.system as any;\n    \n    // Get all skills and specializations\n    const skills = this.actor.items.filter((i: any) => i.type === 'skill');\n    const allSpecializations = this.actor.items.filter((i: any) => i.type === 'specialization');\n    \n    // Build skill options HTML\n    let skillOptionsHtml = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.FEATS.WEAPON.SELECT_SKILL') + ' --</option>';\n    skills.forEach((skill: any) => {\n      const skillSystem = skill.system as any;\n      const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n      const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n      const skillRating = skillSystem.rating || 0;\n      const totalDicePool = attributeValue + skillRating;\n      \n      skillOptionsHtml += `<option value=\"skill-${skill.id}\" data-dice-pool=\"${totalDicePool}\">${skill.name} (${totalDicePool} ds)</option>`;\n      \n      // Add specializations for this skill\n      const specs = allSpecializations.filter((spec: any) => {\n        const linkedSkillName = spec.system.linkedSkill;\n        return linkedSkillName === skill.name;\n      });\n      \n      specs.forEach((spec: any) => {\n        const specSystem = spec.system as any;\n        const specLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const specAttributeValue = (this.actor.system as any).attributes?.[specLinkedAttribute] || 0;\n        const parentRating = skillRating;\n        const effectiveRating = parentRating + 2;\n        const specTotalDicePool = specAttributeValue + effectiveRating;\n        \n        skillOptionsHtml += `<option value=\"spec-${spec.id}\" data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\">   ${spec.name} (${specTotalDicePool} ds)</option>`;\n      });\n    });\n    \n    // Get weapon/spell info\n    const damageValue = itemSystem.damageValue || '0';\n    const weaponName = item.name;\n    \n    const titleKey = type === 'spell' ? 'SRA2.FEATS.SPELL.ROLL_TITLE' : 'SRA2.FEATS.WEAPON.ROLL_TITLE';\n    \n    // Create dialog to select skill/specialization\n    const dialog = new Dialog({\n      title: game.i18n!.format(titleKey, { name: weaponName }),\n      content: `\n        <form class=\"sra2-weapon-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.FEATS.WEAPON.WEAPON_NAME')}:</label>\n            <p class=\"weapon-name\"><strong>${weaponName}</strong></p>\n          </div>\n          ${damageValue !== '0' ? `\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.FEATS.WEAPON.DAMAGE_VALUE')}:</label>\n            <p class=\"damage-value\"><strong>${damageValue}</strong></p>\n          </div>\n          ` : ''}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.FEATS.WEAPON.SELECT_SKILL')}:</label>\n            <select id=\"skill-select\" class=\"skill-select\">\n              ${skillOptionsHtml}\n            </select>\n          </div>\n        </form>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const selectedValue = html.find('#skill-select').val();\n            if (!selectedValue || selectedValue === '') {\n              ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.WEAPON.NO_SKILL_SELECTED'));\n              return;\n            }\n            \n            const [itemType, itemId] = (selectedValue as string).split('-');\n            \n            if (!itemId) return;\n            \n            if (itemType === 'skill') {\n              const skill = this.actor.items.get(itemId);\n              if (skill) {\n                // Trigger the skill roll with weapon name (using old method for non-combat rolls)\n                // This is kept for backward compatibility with spells and non-targeted attacks\n                this._rollSkillWithWeapon(skill, weaponName, 'skill', damageValue || '0');\n              }\n            } else if (itemType === 'spec') {\n              const spec = this.actor.items.get(itemId);\n              if (spec) {\n                // Trigger the specialization roll with weapon name\n                const effectiveRating = parseInt(html.find(`#skill-select option:selected`).data('effective-rating') || '0');\n                this._rollSpecializationWithWeapon(spec, weaponName, effectiveRating, damageValue || '0');\n              }\n            }\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 500 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Roll a skill with weapon context\n   */\n  private async _rollSkillWithWeapon(skill: any, weaponName: string, _skillType: 'skill', weaponDamageValue?: string): Promise<void> {\n    const skillSystem = skill.system as any;\n    const rating = skillSystem.rating || 0;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    \n    // Get the attribute value from the actor\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    const basePool = rating + attributeValue;\n    \n    if (basePool <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.SKILLS.NO_DICE'));\n      return;\n    }\n\n    // Get localized attribute name\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n    \n    // Get RR sources for skill and attribute\n    const skillRRSources = this.getRRSources('skill', skill.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const allRRSources = [...skillRRSources, ...attributeRRSources.map(s => ({ ...s, featName: s.featName + ` (${attributeLabel})` }))];\n    const autoRR = Math.min(3, allRRSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(basePool, this.getRiskDiceByRR(autoRR));\n\n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (allRRSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      allRRSources.forEach((source) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n\n    // Create a dialog to optionally add modifiers and risk dice\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.FEATS.WEAPON.ROLL_WITH_SKILL', { weapon: weaponName, skill: skill.name }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.BASE_POOL')}: <strong>${basePool}</strong></label>\n            <p class=\"notes\">(${game.i18n!.localize('SRA2.SKILLS.RATING')}: ${rating} + ${attributeLabel}: ${attributeValue})</p>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: basePool}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${basePool};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            // Risk thresholds based on RR level\n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              // Get current RR if not provided\n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                // Toggle: si on clique sur le dernier d slectionn, dslectionner tout\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            // Initial color setup\n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const totalPool = basePool;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            this._rollAttackWithDefense(`${weaponName} (${skill.name})`, normalDice, riskDice, riskReduction, rollMode, weaponDamageValue);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Roll a specialization with weapon context\n   */\n  private async _rollSpecializationWithWeapon(specialization: any, weaponName: string, effectiveRating: number, weaponDamageValue?: string): Promise<void> {\n    const specSystem = specialization.system as any;\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\n    \n    // Get the attribute value from the actor\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    const basePool = effectiveRating + attributeValue;\n\n    if (basePool <= 0) {\n      ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.NO_DICE'));\n      return;\n    }\n\n    // Get localized attribute name\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n    \n    // Get RR sources for specialization, skill, and attribute\n    const specRRSources = this.getRRSources('specialization', specialization.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const linkedSkillName = specSystem.linkedSkill;\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\n    \n    const allRRSources = [\n      ...specRRSources,\n      ...skillRRSources.map(s => ({ ...s, featName: s.featName + ` (${linkedSkillName})` })),\n      ...attributeRRSources.map(s => ({ ...s, featName: s.featName + ` (${attributeLabel})` }))\n    ];\n    const autoRR = Math.min(3, allRRSources.reduce((total, s) => total + s.rrValue, 0));\n    const defaultRiskDice = Math.min(basePool, this.getRiskDiceByRR(autoRR));\n\n    // Build RR sources HTML\n    let rrSourcesHtml = '';\n    if (allRRSources.length > 0) {\n      rrSourcesHtml = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n      allRRSources.forEach((source) => {\n        rrSourcesHtml += `\n          <label class=\"rr-source-item\">\n            <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n            <span>${source.featName} (+${source.rrValue})</span>\n          </label>`;\n      });\n      rrSourcesHtml += '</div>';\n    }\n\n    // Create a dialog to optionally add modifiers and risk dice\n    const dialog = new Dialog({\n      title: game.i18n!.format('SRA2.FEATS.WEAPON.ROLL_WITH_SKILL', { weapon: weaponName, skill: specialization.name }),\n      content: `\n        <form class=\"sra2-roll-dialog\">\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.BASE_POOL')}: <strong>${basePool}</strong></label>\n            <p class=\"notes\">(${game.i18n!.localize('SRA2.SPECIALIZATIONS.BONUS')}: ${effectiveRating} + ${attributeLabel}: ${attributeValue})</p>\n          </div>\n          <div class=\"form-group roll-mode-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE')}:</label>\n            <div class=\"radio-group\">\n              <label class=\"radio-option disadvantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"disadvantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_DISADVANTAGE')}</span>\n              </label>\n              <label class=\"radio-option normal\">\n                <input type=\"radio\" name=\"rollMode\" value=\"normal\" checked />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_NORMAL')}</span>\n              </label>\n              <label class=\"radio-option advantage\">\n                <input type=\"radio\" name=\"rollMode\" value=\"advantage\" />\n                <span>${game.i18n!.localize('SRA2.SKILLS.ROLL_MODE_ADVANTAGE')}</span>\n              </label>\n            </div>\n          </div>\n          ${rrSourcesHtml}\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_REDUCTION')}: <span id=\"rr-display\">${autoRR}</span>/3</label>\n          </div>\n          <div class=\"form-group\">\n            <label>${game.i18n!.localize('SRA2.SKILLS.RISK_DICE')}:</label>\n            <input type=\"hidden\" name=\"riskDice\" id=\"risk-dice-input\" value=\"${defaultRiskDice}\" />\n            <div class=\"dice-selector\" id=\"dice-selector\">\n              ${Array.from({length: basePool}, (_, i) => \n                `<div class=\"dice-icon ${i < defaultRiskDice ? 'selected' : ''}\" data-dice-index=\"${i + 1}\">\n                  <i class=\"fas fa-dice-d6\"></i>\n                  <span class=\"dice-number\">${i + 1}</span>\n                </div>`\n              ).join('')}\n            </div>\n            <p class=\"notes\">${game.i18n!.localize('SRA2.SKILLS.RISK_DICE_HINT')}</p>\n          </div>\n        </form>\n        <script>\n          (function() {\n            const form = document.querySelector('.sra2-roll-dialog');\n            const checkboxes = form.querySelectorAll('.rr-source-checkbox');\n            const rrDisplay = form.querySelector('#rr-display');\n            const riskDiceInput = form.querySelector('#risk-dice-input');\n            const diceSelector = form.querySelector('#dice-selector');\n            const diceIcons = diceSelector.querySelectorAll('.dice-icon');\n            const maxDice = ${basePool};\n            const riskDiceByRR = [2, 5, 8, 12];\n            \n            // Risk thresholds based on RR level\n            const riskThresholds = {\n              0: { normal: 2, fort: 4, extreme: 6 },\n              1: { normal: 5, fort: 7, extreme: 9 },\n              2: { normal: 8, fort: 11, extreme: 13 },\n              3: { normal: 12, fort: 15, extreme: 999 }\n            };\n            \n            function getRiskLevel(diceCount, rr) {\n              const thresholds = riskThresholds[rr] || riskThresholds[0];\n              if (diceCount <= thresholds.normal) return 'faible';\n              if (diceCount <= thresholds.fort) return 'normal';\n              if (diceCount <= thresholds.extreme) return 'fort';\n              return 'extreme';\n            }\n            \n            function updateRR() {\n              let totalRR = 0;\n              checkboxes.forEach(cb => {\n                if (cb.checked) {\n                  totalRR += parseInt(cb.dataset.rrValue);\n                }\n              });\n              totalRR = Math.min(3, totalRR);\n              rrDisplay.textContent = totalRR;\n              \n              const suggestedRisk = Math.min(maxDice, riskDiceByRR[totalRR]);\n              setDiceSelection(suggestedRisk, totalRR);\n            }\n            \n            function setDiceSelection(count, currentRR) {\n              riskDiceInput.value = count;\n              \n              // Get current RR if not provided\n              if (currentRR === undefined) {\n                currentRR = 0;\n                checkboxes.forEach(cb => {\n                  if (cb.checked) {\n                    currentRR += parseInt(cb.dataset.rrValue);\n                  }\n                });\n                currentRR = Math.min(3, currentRR);\n              }\n              \n              diceIcons.forEach((dice, index) => {\n                const diceNumber = index + 1;\n                dice.classList.remove('selected', 'risk-faible', 'risk-normal', 'risk-fort', 'risk-extreme');\n                \n                const riskLevel = getRiskLevel(diceNumber, currentRR);\n                dice.classList.add('risk-' + riskLevel);\n                \n                if (index < count) {\n                  dice.classList.add('selected');\n                }\n              });\n            }\n            \n            diceIcons.forEach((dice) => {\n              dice.addEventListener('click', function() {\n                const index = parseInt(this.dataset.diceIndex);\n                const currentValue = parseInt(riskDiceInput.value);\n                // Toggle: si on clique sur le dernier d slectionn, dslectionner tout\n                if (index === currentValue) {\n                  setDiceSelection(0);\n                } else {\n                  setDiceSelection(index);\n                }\n              });\n            });\n            \n            checkboxes.forEach(cb => {\n              cb.addEventListener('change', updateRR);\n            });\n            \n            // Initial color setup\n            setDiceSelection(riskDiceInput.value);\n          })();\n        </script>\n      `,\n      buttons: {\n        roll: {\n          icon: '<i class=\"fas fa-dice-d6\"></i>',\n          label: game.i18n!.localize('SRA2.SKILLS.ROLL'),\n          callback: (html: any) => {\n            const totalPool = basePool;\n            const riskDice = Math.min(totalPool, parseInt(html.find('[name=\"riskDice\"]').val()) || 0);\n            const normalDice = totalPool - riskDice;\n            let riskReduction = 0;\n            html.find('.rr-source-checkbox:checked').each((_: number, cb: any) => {\n              riskReduction += parseInt(cb.dataset.rrValue);\n            });\n            riskReduction = Math.min(3, riskReduction);\n            const rollMode = html.find('[name=\"rollMode\"]:checked').val() || 'normal';\n            this._rollAttackWithDefense(`${weaponName} (${specialization.name})`, normalDice, riskDice, riskReduction, rollMode, weaponDamageValue);\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'roll'\n    }, { width: 600 });\n    \n    dialog.render(true);\n  }\n\n  /**\n   * Handle creating a new feat from search\n   */\n  private async _onCreateNewFeat(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const featName = button.dataset.featName;\n    \n    if (!featName) return;\n    \n    // Get the feat type from the selector\n    const selector = $(button).siblings('.feat-type-selector, .feat-type-selector-inline')[0] as HTMLSelectElement;\n    const featType = selector ? selector.value : 'equipment';\n    \n    // Capitalize first letter of each word\n    const formattedName = featName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new feat with default values\n    const featData = {\n      name: formattedName,\n      type: 'feat',\n      system: {\n        description: '',\n        rating: 0,\n        cost: 'free-equipment',\n        active: true,\n        featType: featType,\n        rrType: [],\n        rrValue: [],\n        rrTarget: [],\n        bonusLightDamage: 0,\n        bonusSevereDamage: 0,\n        bonusPhysicalThreshold: 0,\n        bonusMentalThreshold: 0,\n        bonusAnarchy: 0,\n        essenceCost: 0\n      }\n    } as any;\n    \n    // Add the feat to the actor\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [featData]) as any;\n    \n    if (createdItems && createdItems.length > 0) {\n      const newFeat = createdItems[0] as any;\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.feat-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      // Open the feat sheet for editing\n      if (newFeat && newFeat.sheet) {\n        setTimeout(() => {\n          newFeat.sheet.render(true);\n        }, 100);\n      }\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.FEAT_CREATED', { name: formattedName }));\n    }\n  }\n}\n\n","import { WEAPON_TYPES, VEHICLE_TYPES } from '../models/item-feat.js';\n\n/**\n * Feat Sheet Application\n */\nexport class FeatSheet extends ItemSheet {\n  /** Track the currently active section */\n  private _activeSection: string = 'general';\n  \n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'feat'],\n      template: 'systems/sra2/templates/item-feat-sheet.hbs',\n      width: 720,\n      height: 680,\n      tabs: [],\n      dragDrop: [\n        { dropSelector: '.rr-target-drop-zone' }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    \n    // Ensure prepareDerivedData is called to calculate recommendedLevel\n    this.item.prepareData();\n    \n    context.system = this.item.system;\n    \n    // Pass the active section to the template\n    context.activeSection = this._activeSection;\n    \n    // Calculate final damage value\n    context.finalDamageValue = this._calculateFinalDamageValue();\n    \n    // Calculate final vehicle stats\n    context.finalVehicleStats = this._calculateFinalVehicleStats();\n    \n    // Build RR entries array from rrList\n    context.rrEntries = [];\n    const rrList = context.system.rrList || [];\n    \n    for (let i = 0; i < rrList.length; i++) {\n      const rrEntry = rrList[i];\n      const rrType = rrEntry.rrType;\n      const rrValue = rrEntry.rrValue || 0;\n      const rrTarget = rrEntry.rrTarget || '';\n      \n      const entry: any = {\n        index: i,\n        rrType,\n        rrValue,\n        rrTarget,\n        rrTargetName: rrTarget\n      };\n      \n      if (rrType === 'skill' || rrType === 'specialization') {\n        entry.rrTargetType = rrType === 'skill' \n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\n        \n        // If the feat is on an actor, check if the target exists\n        if (this.item.actor && rrTarget) {\n          const targetItem = this.item.actor.items.find((i: any) => \n            i.type === rrType && i.name === rrTarget\n          );\n          \n          if (!targetItem) {\n            entry.rrTargetNotFound = true;\n          }\n        }\n      }\n      \n      context.rrEntries.push(entry);\n    }\n    \n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    \n    // Add RR entry button\n    html.find('[data-action=\"add-rr-entry\"]').on('click', this._onAddRREntry.bind(this));\n    \n    // Remove RR entry button\n    html.find('[data-action=\"remove-rr-entry\"]').on('click', this._onRemoveRREntry.bind(this));\n    \n    // Clear RR target button\n    html.find('[data-action=\"clear-rr-target\"]').on('click', this._onClearRRTarget.bind(this));\n    \n    // Add narrative effect button\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', this._onAddNarrativeEffect.bind(this));\n    \n    // Remove narrative effect button\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', this._onRemoveNarrativeEffect.bind(this));\n    \n    // Weapon type selection\n    html.find('[data-action=\"select-weapon-type\"]').on('change', this._onWeaponTypeChange.bind(this));\n    \n    // Vehicle type selection\n    html.find('[data-action=\"select-vehicle-type\"]').on('change', this._onVehicleTypeChange.bind(this));\n    \n    // Damage value bonus checkboxes\n    html.find('.damage-bonus-checkbox').on('change', this._onDamageValueBonusChange.bind(this));\n    \n    // Sustained spell checkboxes\n    html.find('.sustained-spell-checkbox').on('change', this._onSustainedSpellChange.bind(this));\n    \n    // Summoned spirit checkbox\n    html.find('.summoned-spirit-checkbox').on('change', this._onSummonedSpiritChange.bind(this));\n    \n    // Range improvement checkboxes\n    html.find('.range-improvement-checkbox input[type=\"checkbox\"]').on('change', this._onRangeImprovementChange.bind(this));\n    \n    // Section navigation\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\n    \n    // RR target search\n    html.find('.rr-target-search-input').on('input', this._onRRTargetSearch.bind(this));\n    html.find('.rr-target-search-input').on('focus', this._onRRTargetSearchFocus.bind(this));\n    html.find('.rr-target-search-input').on('blur', this._onRRTargetSearchBlur.bind(this));\n    \n    // Close RR target search results when clicking outside\n    $(document).on('click.rr-target-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const searchContainers = html.find('.rr-target-search-container');\n      searchContainers.each((_, container) => {\n        if (!container.contains(target)) {\n          $(container).find('.rr-target-search-results').hide();\n        }\n      });\n    });\n  }\n  \n  /**\n   * Handle section navigation\n   */\n  private _onSectionNavigation(event: Event): void {\n    event.preventDefault();\n    \n    const button = event.currentTarget as HTMLElement;\n    const section = button.dataset.section;\n    \n    if (!section) return;\n    \n    // Save the active section\n    this._activeSection = section;\n    \n    // Find the form element\n    if (!this.form) return;\n    const form = $(this.form);\n    \n    // Update navigation buttons\n    form.find('.section-nav .nav-item').removeClass('active');\n    button.classList.add('active');\n    \n    // Update content sections\n    form.find('.content-section').removeClass('active');\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\n  }\n\n  /**\n   * Handle adding a new RR entry\n   */\n  private async _onAddRREntry(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    rrList.push({\n      rrType: 'skill',\n      rrValue: 0,\n      rrTarget: ''\n    });\n    \n    await this.item.update({\n      'system.rrList': rrList\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle removing an RR entry\n   */\n  private async _onRemoveRREntry(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    rrList.splice(index, 1);\n    \n    await this.item.update({\n      'system.rrList': rrList\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle clearing the RR target for a specific entry\n   */\n  private async _onClearRRTarget(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    if (rrList[index]) {\n      rrList[index] = { ...rrList[index], rrTarget: '' };\n    }\n    \n    await this.item.update({ 'system.rrList': rrList } as any);\n    this.render(false);\n  }\n\n  /**\n   * Handle dropping a skill or specialization onto the RR target field\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const data = TextEditor.getDragEventData(event) as any;\n    \n    // Handle Item drops\n    if (data && data.type === 'Item') {\n      const item = await Item.implementation.fromDropData(data) as any;\n      \n      if (!item) return super._onDrop(event);\n      \n      // Find the drop zone and get the index\n      const dropZone = (event.target as HTMLElement).closest('[data-rr-index]');\n      if (!dropZone) return super._onDrop(event);\n      \n      const index = parseInt((dropZone as HTMLElement).dataset.rrIndex || '0');\n      const rrList = [...((this.item.system as any).rrList || [])];\n      const rrType = rrList[index]?.rrType;\n      \n      // Check if it's a skill or specialization matching the RR type\n      if (item.type === 'skill' && rrType === 'skill') {\n        // Store the skill name (not ID) so the feat can be prepared in advance\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\n        await this.item.update({ 'system.rrList': rrList } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\n        return;\n      } else if (item.type === 'specialization' && rrType === 'specialization') {\n        // Store the specialization name (not ID) so the feat can be prepared in advance\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\n        await this.item.update({ 'system.rrList': rrList } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\n        return;\n      } else if (rrType === 'skill' || rrType === 'specialization') {\n        // Wrong type of item\n        ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.WRONG_TARGET_TYPE'));\n        return;\n      }\n    }\n\n    return super._onDrop(event);\n  }\n\n  /**\n   * Handle adding a new narrative effect\n   */\n  private async _onAddNarrativeEffect(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\n    \n    narrativeEffects.push({\n      text: \"\",\n      isNegative: false\n    });\n    \n    await this.item.update({\n      'system.narrativeEffects': narrativeEffects\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle removing a narrative effect\n   */\n  private async _onRemoveNarrativeEffect(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    \n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\n    \n    narrativeEffects.splice(index, 1);\n    \n    await this.item.update({\n      'system.narrativeEffects': narrativeEffects\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Calculate the final damage value taking into account STRENGTH attribute\n   */\n  private _calculateFinalDamageValue(): string {\n    const damageValue = (this.item.system as any).damageValue || \"0\";\n    const damageValueBonus = (this.item.system as any).damageValueBonus || 0;\n    \n    // Get the actor's strength if available\n    const strength = this.item.actor ? ((this.item.actor.system as any)?.attributes?.strength || 0) : 0;\n    \n    // Parse the damage value\n    if (damageValue === \"FOR\") {\n      // Pure STRENGTH\n      const total = strength + damageValueBonus;\n      if (!this.item.actor) {\n        return damageValueBonus > 0 ? `FOR+${damageValueBonus}` : \"FOR\";\n      }\n      return `${total} (FOR${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\n    } else if (damageValue.startsWith(\"FOR+\")) {\n      // STRENGTH + modifier\n      const modifier = parseInt(damageValue.substring(4)) || 0;\n      const total = strength + modifier + damageValueBonus;\n      if (!this.item.actor) {\n        return damageValueBonus > 0 ? `FOR+${modifier}+${damageValueBonus}` : `FOR+${modifier}`;\n      }\n      return `${total} (FOR+${modifier}${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\n    } else if (damageValue === \"toxin\") {\n      // Special case for gas grenades\n      return \"selon toxine\";\n    } else {\n      // Numeric value\n      const base = parseInt(damageValue) || 0;\n      const total = base + damageValueBonus;\n      if (damageValueBonus > 0) {\n        return `${total} (${base}+${damageValueBonus})`;\n      }\n      return total.toString();\n    }\n  }\n\n  /**\n   * Handle weapon type selection change\n   */\n  private async _onWeaponTypeChange(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const weaponType = (event.currentTarget as HTMLSelectElement).value;\n    \n    if (!weaponType || !WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES]) {\n      return;\n    }\n    \n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n    \n    // Convert damage value to string\n    const damageValue = typeof weaponStats.vd === 'number' ? weaponStats.vd.toString() : weaponStats.vd;\n    \n    await this.item.update({\n      'system.weaponType': weaponType,\n      'system.damageValue': damageValue,\n      'system.meleeRange': weaponStats.melee,\n      'system.shortRange': weaponStats.short,\n      'system.mediumRange': weaponStats.medium,\n      'system.longRange': weaponStats.long\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle vehicle type selection change\n   */\n  private async _onVehicleTypeChange(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const vehicleType = (event.currentTarget as HTMLSelectElement).value;\n    \n    if (!vehicleType || !VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES]) {\n      return;\n    }\n    \n    const vehicleStats = VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES];\n    \n    await this.item.update({\n      'system.vehicleType': vehicleType,\n      'system.autopilot': vehicleStats.autopilot,\n      'system.structure': vehicleStats.structure,\n      'system.handling': vehicleStats.handling,\n      'system.speed': vehicleStats.speed,\n      'system.flyingSpeed': vehicleStats.flyingSpeed,\n      'system.armor': vehicleStats.armor,\n      'system.weaponMount': vehicleStats.weaponMount\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Calculate the final vehicle stats taking into account bonuses\n   */\n  private _calculateFinalVehicleStats(): any {\n    const baseAutopilot = (this.item.system as any).autopilot || 6;\n    const baseStructure = (this.item.system as any).structure || 2;\n    const baseHandling = (this.item.system as any).handling || 5;\n    const baseSpeed = (this.item.system as any).speed || 3;\n    const baseFlyingSpeed = (this.item.system as any).flyingSpeed || 0;\n    const baseArmor = (this.item.system as any).armor || 0;\n    \n    const autopilotBonus = (this.item.system as any).autopilotBonus || 0;\n    const speedBonus = (this.item.system as any).speedBonus || 0;\n    const handlingBonus = (this.item.system as any).handlingBonus || 0;\n    const armorBonus = (this.item.system as any).armorBonus || 0;\n    const isFlying = (this.item.system as any).isFlying || false;\n    const isFixed = (this.item.system as any).isFixed || false;\n    \n    // Calculate final values\n    const finalAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\n    const finalHandling = baseHandling + handlingBonus;\n    const finalSpeed = isFixed ? 0 : (baseSpeed + speedBonus);\n    const finalFlyingSpeed = isFlying ? (baseFlyingSpeed > 0 ? baseFlyingSpeed : 1) : 0;\n    const finalArmor = Math.min(baseStructure, baseArmor + armorBonus);\n    \n    return {\n      autopilot: finalAutopilot,\n      structure: baseStructure,\n      handling: finalHandling,\n      speed: finalSpeed,\n      flyingSpeed: finalFlyingSpeed,\n      armor: finalArmor\n    };\n  }\n\n  /**\n   * Handle damage value bonus checkbox changes\n   */\n  private _onDamageValueBonusChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const value = parseInt(checkbox.dataset.bonusValue || '0');\n    const currentBonus = (this.item.system as any).damageValueBonus || 0;\n    \n    let newBonus: number;\n    \n    if (checkbox.checked) {\n      // If checking, set to the checkbox value\n      newBonus = value;\n    } else {\n      // If unchecking, decrease appropriately\n      if (value === 2 && currentBonus === 2) {\n        newBonus = 1;\n      } else if (value === 1 && currentBonus >= 1) {\n        newBonus = 0;\n      } else {\n        newBonus = currentBonus;\n      }\n    }\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.damageValueBonus\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newBonus.toString();\n    }\n    \n    // Update the checkboxes state\n    const checkboxes = this.element.find('.damage-bonus-checkbox');\n    checkboxes.each((_, cb) => {\n      const cbElement = cb as HTMLInputElement;\n      const cbValue = parseInt(cbElement.dataset.bonusValue || '0');\n      if (cbValue === 1) {\n        cbElement.checked = newBonus >= 1;\n      } else if (cbValue === 2) {\n        cbElement.checked = newBonus === 2;\n      }\n    });\n  }\n\n  /**\n   * Handle sustained spell checkbox changes\n   */\n  private _onSustainedSpellChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const value = parseInt(checkbox.dataset.spellValue || '0');\n    const currentCount = (this.item.system as any).sustainedSpellCount || 0;\n    \n    let newCount: number;\n    \n    if (checkbox.checked) {\n      // If checking, set to the checkbox value\n      newCount = value;\n    } else {\n      // If unchecking, decrease appropriately\n      if (value === 2 && currentCount === 2) {\n        newCount = 1;\n      } else if (value === 1 && currentCount >= 1) {\n        newCount = 0;\n      } else {\n        newCount = currentCount;\n      }\n    }\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.sustainedSpellCount\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newCount.toString();\n    }\n    \n    // Update the checkboxes state\n    const checkboxes = this.element.find('.sustained-spell-checkbox');\n    checkboxes.each((_, cb) => {\n      const cbElement = cb as HTMLInputElement;\n      const cbValue = parseInt(cbElement.dataset.spellValue || '0');\n      if (cbValue === 1) {\n        cbElement.checked = newCount >= 1;\n      } else if (cbValue === 2) {\n        cbElement.checked = newCount === 2;\n      }\n    });\n  }\n\n  /**\n   * Handle summoned spirit checkbox change\n   */\n  private _onSummonedSpiritChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const newCount = checkbox.checked ? 1 : 0;\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.summonedSpiritCount\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newCount.toString();\n    }\n  }\n\n  /**\n   * Handle range improvement checkbox change\n   * When checked, automatically improves the range: none -> dice, dice -> ok\n   * When unchecked, automatically downgrades the range: ok -> dice, dice -> none\n   */\n  private _onRangeImprovementChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const isChecked = checkbox.checked;\n    \n    // Find which range this checkbox is for\n    const rangeRow = checkbox.closest('.range-row');\n    if (!rangeRow) return;\n    \n    const select = rangeRow.querySelector('select') as HTMLSelectElement;\n    if (!select) return;\n    \n    // Determine which range field we're dealing with\n    const rangeLabel = rangeRow.querySelector('.range-label')?.textContent || '';\n    let fieldName = '';\n    if (rangeLabel.includes('Contact') || rangeLabel.includes('Melee') || rangeLabel.includes('Mle')) {\n      fieldName = 'system.meleeRange';\n    } else if (rangeLabel.includes('Courte') || rangeLabel.includes('Short')) {\n      fieldName = 'system.shortRange';\n    } else if (rangeLabel.includes('Moyenne') || rangeLabel.includes('Medium')) {\n      fieldName = 'system.mediumRange';\n    } else if (rangeLabel.includes('Longue') || rangeLabel.includes('Long')) {\n      fieldName = 'system.longRange';\n    }\n    \n    const currentValue = select.value;\n    let newValue = currentValue;\n    \n    if (isChecked) {\n      // Improve the range: none -> dice, dice -> ok\n      if (currentValue === 'none') {\n        newValue = 'dice';\n      } else if (currentValue === 'dice') {\n        newValue = 'ok';\n      }\n      // If already 'ok', keep it at 'ok'\n    } else {\n      // Downgrade the range: ok -> dice, dice -> none\n      if (currentValue === 'ok') {\n        newValue = 'dice';\n      } else if (currentValue === 'dice') {\n        newValue = 'none';\n      }\n      // If already 'none', keep it at 'none'\n    }\n    \n    // Update the disabled select for visual display\n    select.value = newValue;\n    \n    // Update the hidden input that holds the actual value\n    const hiddenInput = this.element.find(`input[name=\"${fieldName}\"]`)[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newValue;\n    }\n  }\n\n  /**\n   * Handle RR target search input\n   */\n  private rrTargetSearchTimeout: any = null;\n  \n  private async _onRRTargetSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = input.value.trim().toLowerCase();\n    const rrIndex = parseInt(input.dataset.rrIndex || '0');\n    const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.rrTargetSearchTimeout) {\n      clearTimeout(this.rrTargetSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.rrTargetSearchTimeout = setTimeout(async () => {\n      await this._performRRTargetSearch(searchTerm, rrIndex, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual RR target search in actor items and compendiums\n   */\n  private async _performRRTargetSearch(searchTerm: string, rrIndex: number, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    const rrList = (this.item.system as any).rrList || [];\n    const rrType = rrList[rrIndex]?.rrType;\n    \n    if (!rrType || rrType === 'attribute') {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Search in actor items if this feat is on an actor\n    if (this.item.actor) {\n      for (const item of this.item.actor.items as any) {\n        if (item.type === rrType && item.name.toLowerCase().includes(searchTerm)) {\n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\n            type: rrType\n          });\n        }\n      }\n    }\n    \n    // Search in world items\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === rrType && item.name.toLowerCase().includes(searchTerm)) {\n          // Check if not already in results\n          const exists = results.some(r => r.name === item.name);\n          if (!exists) {\n            results.push({\n              name: item.name,\n              uuid: item.uuid,\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\n              type: rrType\n            });\n          }\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for items that match the search term and type\n      for (const doc of documents) {\n        if (doc.type === rrType && doc.name.toLowerCase().includes(searchTerm)) {\n          // Check if not already in results\n          const exists = results.some(r => r.name === doc.name);\n          if (!exists) {\n            results.push({\n              name: doc.name,\n              uuid: doc.uuid,\n              source: pack.title,\n              type: rrType\n            });\n          }\n        }\n      }\n    }\n    \n    // Display results\n    this._displayRRTargetSearchResults(results, rrIndex, resultsDiv);\n  }\n\n  /**\n   * Display RR target search results\n   */\n  private _displayRRTargetSearchResults(results: any[], rrIndex: number, resultsDiv: HTMLElement): void {\n    let html = '';\n    \n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\n          </div>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const typeLabel = result.type === 'skill' \n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\n        \n        html += `\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\n            </div>\n            <button class=\"add-rr-target-btn\" data-target-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers to buttons\n    $(resultsDiv).find('.add-rr-target-btn').on('click', this._onSelectRRTarget.bind(this));\n    \n    // Make entire result items clickable\n    $(resultsDiv).find('.search-result-item:not(.no-results)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-rr-target-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-rr-target-btn')[0] as HTMLButtonElement;\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n  }\n\n  /**\n   * Handle selecting an RR target from search results\n   */\n  private async _onSelectRRTarget(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const targetName = button.dataset.targetName;\n    const rrIndex = parseInt(button.dataset.rrIndex || '0');\n    \n    if (!targetName) return;\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    if (rrList[rrIndex]) {\n      rrList[rrIndex] = { ...rrList[rrIndex], rrTarget: targetName };\n    }\n    \n    await this.item.update({ 'system.rrList': rrList } as any);\n    this.render(false);\n    \n    ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: targetName }));\n  }\n\n  /**\n   * Handle RR target search focus\n   */\n  private _onRRTargetSearchFocus(event: Event): void {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n  }\n\n  /**\n   * Handle RR target search blur\n   */\n  private _onRRTargetSearchBlur(event: Event): void {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.rr-target-search');\n    return super.close(options);\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData) as any;\n    \n    // Check if isFirstFeat is being set to true for a trait\n    if (expandedData.system?.isFirstFeat === true && \n        expandedData.system?.featType === 'trait' && \n        this.item.actor) {\n      \n      // Find all other traits on the same actor that have isFirstFeat = true\n      const otherFirstFeats = this.item.actor.items.filter((item: any) => \n        item.type === 'feat' &&\n        item.id !== this.item.id &&\n        item.system?.featType === 'trait' &&\n        item.system?.isFirstFeat === true\n      );\n      \n      // If there are other traits with isFirstFeat, uncheck them\n      if (otherFirstFeats.length > 0) {\n        for (const otherFeat of otherFirstFeats) {\n          await otherFeat.update({\n            'system.isFirstFeat': false\n          } as any);\n        }\n        \n        ui.notifications?.info(\n          game.i18n!.localize('SRA2.FEATS.FIRST_FEAT_TRANSFERRED') || \n          'The \"first trait\" flag has been moved from the other trait(s) to this one.'\n        );\n      }\n    }\n    \n    // Update the item first to recalculate recommendedLevel\n    await this.item.update(expandedData);\n    \n    // Recalculate derived data to get the new recommendedLevel\n    this.item.prepareData();\n    \n    // Sync rating with recommendedLevel\n    const recommendedLevel = (this.item.system as any).recommendedLevel || 0;\n    const currentRating = (this.item.system as any).rating || 0;\n    \n    // Only update rating if it's different from recommendedLevel\n    if (currentRating !== recommendedLevel) {\n      await this.item.update({\n        'system.rating': recommendedLevel\n      } as any);\n    }\n    \n    return this.item;\n  }\n}\n\n","/**\n * Skill Sheet Application\n */\nexport class SkillSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'skill'],\n      template: 'systems/sra2/templates/item-skill-sheet.hbs',\n      width: 520,\n      height: 480,\n      tabs: [],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    return context;\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n}\n\n","/**\n * Specialization Sheet Application\n */\nexport class SpecializationSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'specialization'],\n      template: 'systems/sra2/templates/item-specialization-sheet.hbs',\n      width: 520,\n      height: 480,\n      tabs: [],\n      dragDrop: [\n        { dropSelector: '.linked-skill-drop-zone' }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    \n    // Get linked skill info if exists\n    if (context.system.linkedSkill) {\n      // linkedSkill is stored as a name, so we display it directly\n      context.linkedSkillName = context.system.linkedSkill;\n      \n      // If the specialization is on an actor, check if the skill exists\n      if (this.item.actor) {\n        const linkedSkill = this.item.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === context.system.linkedSkill\n        );\n        \n        if (!linkedSkill) {\n          // Mark as warning if skill doesn't exist on this actor\n          context.linkedSkillNotFound = true;\n        }\n      }\n    }\n    \n    // Get list of skills from the actor if this item is owned (for dropdown)\n    if (this.item.actor) {\n      const skills = this.item.actor.items.filter((i: any) => i.type === 'skill');\n      context.skills = skills.map((s: any) => ({\n        name: s.name\n      }));\n    } else {\n      context.skills = [];\n    }\n    \n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    \n    // Clear linked skill button\n    html.find('[data-action=\"clear-linked-skill\"]').on('click', this._onClearLinkedSkill.bind(this));\n    \n    // Skill search\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\n    \n    // Close skill search results when clicking outside\n    $(document).on('click.skill-search-spec', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\n        html.find('.skill-search-results').hide();\n      }\n    });\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.skill-search-spec');\n    return super.close(options);\n  }\n\n  /**\n   * Handle clearing the linked skill\n   */\n  private async _onClearLinkedSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    await this.item.update({ 'system.linkedSkill': '' } as any);\n    this.render(false);\n  }\n\n  /**\n   * Handle dropping a skill onto the linked skill field\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const data = TextEditor.getDragEventData(event) as any;\n    \n    // Handle Item drops\n    if (data && data.type === 'Item') {\n      const item = await Item.implementation.fromDropData(data) as any;\n      \n      if (!item) return super._onDrop(event);\n      \n      // Check if it's a skill\n      if (item.type === 'skill') {\n        // Store the skill name (not ID) so the specialization can be prepared in advance\n        await this.item.update({ 'system.linkedSkill': item.name } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.LINKED_TO_SKILL', { name: item.name }));\n        return;\n      } else {\n        ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.ONLY_SKILLS_CAN_BE_LINKED'));\n        return;\n      }\n    }\n\n    return super._onDrop(event);\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n\n  /**\n   * SKILL SEARCH FUNCTIONS\n   */\n  \n  private skillSearchTimeout: any = null;\n  private lastSkillSearchTerm: string = '';\n  \n  /**\n   * Handle skill search input\n   */\n  private async _onSkillSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = input.value.trim().toLowerCase();\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.skillSearchTimeout) {\n      clearTimeout(this.skillSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.skillSearchTimeout = setTimeout(async () => {\n      await this._performSkillSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual skill search in compendiums and world items\n   */\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    \n    // Store search term for potential creation\n    this.lastSkillSearchTerm = searchTerm;\n    \n    // Search in world items first\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === 'skill' && item.name.toLowerCase().includes(searchTerm)) {\n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            pack: game.i18n!.localize('SRA2.SPECIALIZATIONS.WORLD_ITEMS'),\n            linkedAttribute: item.system.linkedAttribute,\n            isWorldItem: true\n          });\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for skills that match the search term\n      for (const doc of documents) {\n        if (doc.type === 'skill' && doc.name.toLowerCase().includes(searchTerm)) {\n          results.push({\n            name: doc.name,\n            uuid: doc.uuid,\n            pack: pack.title,\n            linkedAttribute: doc.system.linkedAttribute,\n            isWorldItem: false\n          });\n        }\n      }\n    }\n    \n    // Display results\n    this._displaySkillSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display skill search results\n   */\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\n    // Check if exact match exists\n    const formattedSearchTerm = this.lastSkillSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatch = results.find((r: any) => \n      r.name.toLowerCase() === this.lastSkillSearchTerm.toLowerCase()\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SPECIALIZATIONS.SEARCH_NO_RESULTS')}\n          </div>\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSkillSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${result.linkedAttribute.toUpperCase()}`);\n        \n        html += `\n          <div class=\"search-result-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.pack} - ${attributeLabel}</span>\n            </div>\n            <button class=\"link-skill-btn\" data-skill-name=\"${result.name}\">\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.LINK_SKILL')}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist\n      if (!exactMatch) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_NEW_SKILL')}</span>\n            </div>\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSkillSearchTerm}\">\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers\n    $(resultsDiv).find('.link-skill-btn').on('click', this._onLinkSkillFromSearch.bind(this));\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\n    \n    // Make entire result items clickable (except create button)\n    $(resultsDiv).find('.search-result-item:not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.link-skill-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.link-skill-btn')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle linking a skill from search results\n   */\n  private async _onLinkSkillFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Link the skill to the specialization\n    await this.item.update({ 'system.linkedSkill': skillName } as any);\n    \n    // Clear the search input and hide results\n    const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n    if (searchInput) {\n      searchInput.value = '';\n    }\n    \n    const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n    if (resultsDiv) {\n      resultsDiv.style.display = 'none';\n    }\n    \n    this.render(false);\n    ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_LINKED', { name: skillName }));\n  }\n\n  /**\n   * Handle skill search focus\n   */\n  private _onSkillSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle skill search blur\n   */\n  private _onSkillSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle creating a new skill from search and linking it\n   */\n  private async _onCreateNewSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Capitalize first letter of each word\n    const formattedName = skillName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new skill as a world item with default values\n    const skillData = {\n      name: formattedName,\n      type: 'skill',\n      system: {\n        rating: 1,\n        linkedAttribute: 'strength',\n        description: ''\n      }\n    } as any;\n    \n    // Create as a world item\n    const createdItems = await Item.create(skillData) as any;\n    \n    if (createdItems) {\n      // Link the skill to the specialization\n      await this.item.update({ 'system.linkedSkill': formattedName } as any);\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      this.render(false);\n      \n      // Open the skill sheet for editing\n      setTimeout(() => {\n        if (createdItems.sheet) {\n          createdItems.sheet.render(true);\n        }\n      }, 100);\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_CREATED_AND_LINKED', { name: formattedName }));\n    }\n  }\n}\n\n","/**\n * Metatype Sheet Application\n */\nexport class MetatypeSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'metatype'],\n      template: 'systems/sra2/templates/item-metatype-sheet.hbs',\n      width: 520,\n      height: 580,\n      tabs: [],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    return context;\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n}\n\n","export const HOOKS = {\n  MIGRATIONS: 'sra2-declareMigration',\n}","import { HOOKS } from \"../hooks.mjs\"\n\nconst CURRENT_SYSTEM_VERSION = \"currentSystemVersion\";\n\nexport class Migration {\n  get code() { return \"sample\"; }\n\n  get version() { return \"0.0.0\"; }\n\n  async migrate() { return () => { } };\n\n  async applyItemsUpdates(computeUpdates = (items) => []) {\n    await game.actors.forEach(async (actor) => {\n      const actorItemUpdates = computeUpdates(actor.items);\n      if (actorItemUpdates.length > 0) {\n        const message = game.i18n.format('SRA2.MIGRATION.APPLYING_ACTOR_ITEMS', { name: actor.name });\n        console.log(SYSTEM.LOG.HEAD, this.code, message, actorItemUpdates);\n        await actor.updateEmbeddedDocuments('Item', actorItemUpdates);\n      }\n    })\n\n    const itemUpdates = computeUpdates(game.items);\n    if (itemUpdates.length > 0) {\n      const message = game.i18n.localize('SRA2.MIGRATION.APPLYING_ITEMS');\n      console.log(SYSTEM.LOG.HEAD, this.code, message, itemUpdates);\n      await Item.updateDocuments(itemUpdates);\n    }\n  }\n}\n\nexport class Migrations {\n  constructor() {\n    // Hooks.once(HOOKS.MIGRATIONS, declareMigrations => declareMigrations(\n    //   /* add system migrations here, can declared anywhere */\n    // ))\n\n    game.settings.register(SYSTEM.id, CURRENT_SYSTEM_VERSION, {\n      name: \"SRA2.MIGRATION.SETTING_NAME\",\n      scope: \"world\",\n      config: false,\n      type: String,\n      default: \"0.0.0\"\n    })\n  }\n\n  migrate() {\n    const currentVersion = game.settings.get(SYSTEM.id, CURRENT_SYSTEM_VERSION)\n    if (foundry.utils.isNewerVersion(game.system.version, currentVersion)) {\n      //if (true) {\n      let migrations = []\n      Hooks.callAll(HOOKS.MIGRATIONS, (...list) =>\n        migrations = migrations.concat(list.filter(m => foundry.utils.isNewerVersion(m.version, currentVersion)))\n      )\n      Hooks.off(HOOKS.MIGRATIONS, () => { })\n\n      if (migrations.length > 0) {\n        migrations.sort((a, b) => foundry.utils.isNewerVersion(a.version, b.version) ? 1 : foundry.utils.isNewerVersion(b.version, a.version) ? -1 : 0)\n        migrations.forEach(async m => {\n          const message = game.i18n.format('SRA2.MIGRATION.EXECUTING', { code: m.code, currentVersion: currentVersion, targetVersion: m.version });\n          this.$notify(message);\n          await m.migrate()\n        })\n        const message = game.i18n.format('SRA2.MIGRATION.DONE', { version: game.system.version });\n        this.$notify(message)\n      }\n      else {\n        const message = game.i18n.format('SRA2.MIGRATION.NOT_NEEDED', { version: game.system.version });\n        console.log(SYSTEM.LOG.HEAD + message)\n      }\n      game.settings.set(SYSTEM.id, CURRENT_SYSTEM_VERSION, game.system.version)\n    }\n    else {\n      const message = game.i18n.localize('SRA2.MIGRATION.VERSION_UNCHANGED');\n      console.log(SYSTEM.LOG.HEAD + message)\n    }\n  }\n\n\n  $notify(message) {\n    ui.notifications.info(message);\n    console.log(SYSTEM.LOG.HEAD + message);\n  }\n}\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.3: Convert rrType, rrValue, rrTarget arrays to rrList\n * This migration transforms the three separate arrays into a single array of objects\n * where each object contains {rrType, rrValue, rrTarget}\n */\nexport class Migration_13_0_3 extends Migration {\n  get code() { \n    return \"migration-13.0.3\"; \n  }\n\n  get version() { \n    return \"13.0.3\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.3: Converting rrType/rrValue/rrTarget to rrList\");\n    \n    let totalMigrated = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the raw source data which contains fields even if they're not in the schema\n        const sourceSystem = item._source?.system || item.system;\n        const system = item.system;\n        \n        // Check for old format in the source data (raw data from database)\n        const hasOldFormat = (\n          (sourceSystem.rrType !== undefined && Array.isArray(sourceSystem.rrType)) ||\n          (sourceSystem.rrValue !== undefined && Array.isArray(sourceSystem.rrValue)) ||\n          (sourceSystem.rrTarget !== undefined && Array.isArray(sourceSystem.rrTarget))\n        );\n        \n        // Check if rrList already exists with content in source\n        const hasNewFormatInSource = (\n          sourceSystem.rrList !== undefined && \n          Array.isArray(sourceSystem.rrList)\n        );\n        \n        // Skip if already migrated (has new format in source AND no old format)\n        if (hasNewFormatInSource && !hasOldFormat) {\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - already has rrList in source (${sourceSystem.rrList.length} entries), no old data`);\n          totalSkipped++;\n          continue;\n        }\n        \n        // Skip if no old format to migrate\n        if (!hasOldFormat) {\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - no old format fields found`);\n          totalSkipped++;\n          continue;\n        }\n        \n        // Get the arrays from source data\n        const rrType = Array.isArray(sourceSystem.rrType) ? sourceSystem.rrType : [];\n        const rrValue = Array.isArray(sourceSystem.rrValue) ? sourceSystem.rrValue : [];\n        const rrTarget = Array.isArray(sourceSystem.rrTarget) ? sourceSystem.rrTarget : [];\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Found \"${item.name}\" with old format:`, {\n          rrType: rrType,\n          rrValue: rrValue,\n          rrTarget: rrTarget\n        });\n        \n        // Convert the three arrays into a single rrList array\n        const rrList = [];\n        const maxLength = Math.max(rrType.length, rrValue.length, rrTarget.length);\n        \n        for (let i = 0; i < maxLength; i++) {\n          // Only add entries where rrType exists and is not \"none\"\n          const type = rrType[i];\n          if (type && type !== 'none') {\n            rrList.push({\n              rrType: type,\n              rrValue: rrValue[i] !== undefined ? rrValue[i] : 0,\n              rrTarget: rrTarget[i] !== undefined ? rrTarget[i] : ''\n            });\n          }\n        }\n        \n        // Create the update object\n        const update = {\n          _id: item.id,\n          'system.rrList': rrList,\n          // Store backup of old data before deletion\n          'system._rrTypeBackup': rrType,\n          'system._rrValueBackup': rrValue,\n          'system._rrTargetBackup': rrTarget,\n          // Remove old fields by setting them to null (Foundry will delete them)\n          'system.rrType': null,\n          'system.rrValue': null,\n          'system.rrTarget': null\n        };\n        \n        updates.push(update);\n        totalMigrated++;\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Converting feat \"${item.name}\":`);\n        console.log(SYSTEM.LOG.HEAD + `  Old data (will be deleted, backed up as _rrTypeBackup/_rrValueBackup/_rrTargetBackup):`, { rrType, rrValue, rrTarget });\n        console.log(SYSTEM.LOG.HEAD + `  New rrList (${rrList.length} entries):`, rrList);\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.3 completed - Migrated: ${totalMigrated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalMigrated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_3_INFO') :\n        'Migration 13.0.3: Risk Reduction data converted. Check console for details.';\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.4: Clean up old RR fields and backups\n * This migration removes the old rrType/rrValue/rrTarget fields and their backups\n * after confirming that rrList is working properly\n */\nexport class Migration_13_0_4 extends Migration {\n  get code() { \n    return \"migration-13.0.4\"; \n  }\n\n  get version() { \n    return \"13.0.4\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.4: Cleaning up old RR fields and backups\");\n    \n    let totalCleaned = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the raw source data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Check if there are any old fields or backups to clean\n        const hasOldFields = (\n          sourceSystem.rrType !== undefined ||\n          sourceSystem.rrValue !== undefined ||\n          sourceSystem.rrTarget !== undefined\n        );\n        \n        const hasBackups = (\n          sourceSystem._rrTypeBackup !== undefined ||\n          sourceSystem._rrValueBackup !== undefined ||\n          sourceSystem._rrTargetBackup !== undefined\n        );\n        \n        // Skip if nothing to clean\n        if (!hasOldFields && !hasBackups) {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Check that rrList exists (safety check)\n        const hasRrList = sourceSystem.rrList !== undefined && Array.isArray(sourceSystem.rrList);\n        \n        if (!hasRrList) {\n          console.warn(SYSTEM.LOG.HEAD + `Migration 13.0.4: Skipping \"${item.name}\" - no rrList found! This item may need manual review.`);\n          totalSkipped++;\n          continue;\n        }\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.4: Cleaning up feat \"${item.name}\":`);\n        if (hasOldFields) {\n          console.log(SYSTEM.LOG.HEAD + `  Removing old fields: rrType, rrValue, rrTarget`);\n        }\n        if (hasBackups) {\n          console.log(SYSTEM.LOG.HEAD + `  Removing backups: _rrTypeBackup, _rrValueBackup, _rrTargetBackup`);\n        }\n        console.log(SYSTEM.LOG.HEAD + `  Keeping rrList with ${sourceSystem.rrList.length} entries`);\n        \n        // Create the update object to remove all old fields\n        const update = {\n          _id: item.id,\n          // Remove old fields\n          'system.rrType': null,\n          'system.rrValue': null,\n          'system.rrTarget': null,\n          // Remove backup fields\n          'system._rrTypeBackup': null,\n          'system._rrValueBackup': null,\n          'system._rrTargetBackup': null\n        };\n        \n        updates.push(update);\n        totalCleaned++;\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.4 completed - Cleaned: ${totalCleaned}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalCleaned > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_4_INFO') :\n        'Migration 13.0.4: Old RR fields cleaned up. Data migration complete.';\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.5: Separate weapons and spells feat types\n * This migration converts \"weapons-spells\" feat type to separate \"weapon\" and \"spell\" types\n * By default, all \"weapons-spells\" are converted to \"weapon\" type\n */\nexport class Migration_13_0_5 extends Migration {\n  get code() { \n    return \"migration-13.0.5\"; \n  }\n\n  get version() { \n    return \"13.0.5\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.5: Separating weapons and spells feat types\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Check if this is a \"weapons-spells\" feat type\n        if (sourceSystem.featType !== 'weapons-spells') {\n          totalSkipped++;\n          continue;\n        }\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.5: Converting feat \"${item.name}\" from \"weapons-spells\" to \"weapon\"`);\n        \n        // Convert to \"weapon\" type by default\n        // Users can manually change specific items to \"spell\" if needed\n        const update = {\n          _id: item.id,\n          'system.featType': 'weapon'\n        };\n        \n        updates.push(update);\n        totalConverted++;\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.5 completed - Converted: ${totalConverted} weapons-spells to weapon, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalConverted > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_5_INFO') :\n        `Migration 13.0.5: Converted ${totalConverted} \"weapons-spells\" feats to \"weapon\" type. You can manually change specific items to \"spell\" type if needed.`;\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.6: Rollback migration 13.0.5\n * This migration does NOT convert anything - keeps weapons-spells as valid type\n * Only marks that this version has been applied\n */\nexport class Migration_13_0_6 extends Migration {\n  get code() { \n    return \"migration-13.0.6\"; \n  }\n\n  get version() { \n    return \"13.0.6\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Migration 13.0.6: Rollback - keeping old weapons-spells type valid\");\n    console.log(SYSTEM.LOG.HEAD + \"No conversion needed. weapons-spells, weapon, and spell types are all valid.\");\n    \n    // This migration does nothing, just marks the version as applied\n    // Old items with \"weapons-spells\" will continue to work\n    // New items can use \"weapon\" or \"spell\" as separate types\n    \n    const message = \"Migration 13.0.6: All feat types (weapons-spells, weapon, spell) are now valid. No data conversion performed.\";\n    console.log(SYSTEM.LOG.HEAD + message);\n    \n    if (ui.notifications) {\n      ui.notifications.info(message, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.7: Convert weapons-spells to weapon (with backup)\n * This migration safely converts all \"weapons-spells\" feat types to \"weapon\"\n * Creates a backup of the old value before conversion\n */\nexport class Migration_13_0_7 extends Migration {\n  get code() { \n    return \"migration-13.0.7\"; \n  }\n\n  get version() { \n    return \"13.0.7\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.7: Converting weapons-spells to weapon (with backup)\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    let conversionDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Skip if not weapons-spells type\n        if (sourceSystem.featType !== 'weapons-spells') {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Log what we're converting\n        const itemInfo = {\n          name: item.name,\n          id: item.id,\n          oldType: 'weapons-spells',\n          newType: 'weapon',\n          hasWeaponFocus: sourceSystem.isWeaponFocus || false,\n          hasDamageValue: (sourceSystem.damageValue || 0) > 0,\n          hasRanges: (\n            sourceSystem.meleeRange !== 'none' ||\n            sourceSystem.shortRange !== 'none' ||\n            sourceSystem.mediumRange !== 'none' ||\n            sourceSystem.longRange !== 'none'\n          )\n        };\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.7: Converting \"${item.name}\" (ID: ${item.id})`);\n        console.log(SYSTEM.LOG.HEAD + `  - Old type: weapons-spells`);\n        console.log(SYSTEM.LOG.HEAD + `  - New type: weapon`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has weapon focus: ${itemInfo.hasWeaponFocus}`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has damage value: ${itemInfo.hasDamageValue}`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has ranges: ${itemInfo.hasRanges}`);\n        \n        conversionDetails.push(itemInfo);\n        \n        // Create the update object\n        const update = {\n          _id: item.id,\n          // Change the type\n          'system.featType': 'weapon',\n          // Create a backup of the old type for safety\n          'system._oldFeatTypeBackup': 'weapons-spells',\n          // Add a migration timestamp\n          'system._migratedAt': new Date().toISOString(),\n          'system._migrationVersion': '13.0.7'\n        };\n        \n        updates.push(update);\n        totalConverted++;\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.7 completed - Converted: ${totalConverted}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (conversionDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\n      \n      const withWeaponFocus = conversionDetails.filter(d => d.hasWeaponFocus).length;\n      const withDamage = conversionDetails.filter(d => d.hasDamageValue).length;\n      const withRanges = conversionDetails.filter(d => d.hasRanges).length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Items with weapon focus: ${withWeaponFocus}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Items with damage value: ${withDamage}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Items with ranges: ${withRanges}`);\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\n      \n      // List all converted items\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\n      conversionDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id})`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalConverted > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_7_INFO', { count: totalConverted }) :\n        `Migration 13.0.7: Converted ${totalConverted} \"weapons-spells\" items to \"weapon\" type. All data preserved with backup.`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \" Migration complete. All items have been backed up.\");\n      console.log(SYSTEM.LOG.HEAD + \" Old type saved in system._oldFeatTypeBackup\");\n      console.log(SYSTEM.LOG.HEAD + \" No data was lost in the conversion\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to convert - all items already migrated or are other types\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.8: Convert narrativeEffects from string array to object array\n * This migration safely converts all narrativeEffects from simple strings\n * to objects with { text: string, isNegative: boolean } structure\n */\nexport class Migration_13_0_8 extends Migration {\n  get code() { \n    return \"migration-13.0.8\"; \n  }\n\n  get version() { \n    return \"13.0.8\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.8: Converting narrativeEffects to new format and fixing damageValueBonus\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    let totalFixed = 0;\n    let conversionDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        // Check and fix narrativeEffects\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\n          // Check if it's already in the new format (first element is an object with 'text' property)\n          const firstEffect = sourceSystem.narrativeEffects[0];\n          if (!(typeof firstEffect === 'object' && firstEffect !== null && 'text' in firstEffect)) {\n            // Convert string array to object array\n            const convertedEffects = sourceSystem.narrativeEffects.map(effect => {\n              if (typeof effect === 'string') {\n                return {\n                  text: effect,\n                  isNegative: false\n                };\n              }\n              // If it's already an object but missing properties, normalize it\n              return {\n                text: effect?.text || effect?.toString() || \"\",\n                isNegative: effect?.isNegative || false\n              };\n            });\n            \n            update['system.narrativeEffects'] = convertedEffects;\n            update['system._migratedNarrativeEffectsAt'] = new Date().toISOString();\n            update['system._narrativeEffectsMigrationVersion'] = '13.0.8';\n            needsUpdate = true;\n            \n            // Log what we're converting\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Converting narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${sourceSystem.narrativeEffects.length}`);\n            \n            conversionDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: sourceSystem.narrativeEffects.length\n            });\n            totalConverted++;\n          }\n        }\n        \n        // Fix missing or invalid damageValueBonus values for ALL feat items\n        if (sourceSystem.damageValueBonus === null || \n            sourceSystem.damageValueBonus === undefined || \n            typeof sourceSystem.damageValueBonus !== 'number' ||\n            !Number.isInteger(sourceSystem.damageValueBonus)) {\n          update['system.damageValueBonus'] = 0;\n          needsUpdate = true;\n          totalFixed++;\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Fixing damageValueBonus for \"${item.name}\" (ID: ${item.id})`);\n        }\n        \n        if (needsUpdate) {\n          updates.push(update);\n        } else {\n          totalSkipped++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.8 completed - NarrativeEffects converted: ${totalConverted}, DamageValueBonus fixed: ${totalFixed}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (conversionDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\n      \n      const totalEffects = conversionDetails.reduce((sum, d) => sum + d.effectCount, 0);\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects migrated: ${totalEffects}`);\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\n      \n      // List all converted items\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\n      conversionDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${detail.effectCount} effect(s)`);\n      });\n    }\n    \n    if (totalFixed > 0) {\n      console.log(SYSTEM.LOG.HEAD + `Fixed damageValueBonus on ${totalFixed} item(s)`);\n    }\n    \n    // Show user-friendly notification\n    if (totalConverted > 0 || totalFixed > 0) {\n      let userMessage = \"\";\n      if (totalConverted > 0 && totalFixed > 0) {\n        userMessage = game.i18n ? \n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted, fixed: totalFixed }) :\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) and fixed damageValueBonus on ${totalFixed} feat(s).`;\n      } else if (totalConverted > 0) {\n        userMessage = game.i18n ? \n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted }) :\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) to new format.`;\n      } else if (totalFixed > 0) {\n        userMessage = `Migration 13.0.8: Fixed damageValueBonus on ${totalFixed} feat(s).`;\n      }\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \" Migration complete.\");\n      if (totalConverted > 0) {\n        console.log(SYSTEM.LOG.HEAD + \" All narrative effects converted to new format.\");\n        console.log(SYSTEM.LOG.HEAD + \" All effects default to positive (isNegative: false)\");\n      }\n      if (totalFixed > 0) {\n        console.log(SYSTEM.LOG.HEAD + \" All damageValueBonus fields set to valid integer values.\");\n      }\n      console.log(SYSTEM.LOG.HEAD + \" No data was lost in the conversion\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.9: Add value field to narrativeEffects and isFirstFeat field\n * This migration adds a 'value' field to all narrative effects\n * with a default of -1 for consistency with the new schema,\n * and adds an 'isFirstFeat' boolean field with default false\n */\nexport class Migration_13_0_9 extends Migration {\n  get code() { \n    return \"migration-13.0.9\"; \n  }\n\n  get version() { \n    return \"13.0.9\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.9: Adding value field to narrativeEffects and isFirstFeat field\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    let totalFirstFeatAdded = 0;\n    let updateDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        // Check if item has narrativeEffects that need updating\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\n          const updatedEffects = sourceSystem.narrativeEffects.map(effect => {\n            // Check if effect already has a value field\n            if (typeof effect === 'object' && effect !== null && !('value' in effect)) {\n              needsUpdate = true;\n              return {\n                ...effect,\n                value: -1  // Default value for all effects\n              };\n            }\n            return effect;\n          });\n          \n          if (needsUpdate) {\n            update['system.narrativeEffects'] = updatedEffects;\n            update['system._migratedNarrativeEffectsValueAt'] = new Date().toISOString();\n            \n            // Log what we're converting\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding value field to narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${updatedEffects.length}`);\n            \n            updateDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: updatedEffects.length,\n              hasFirstFeat: false\n            });\n          }\n        }\n        \n        // Check if item needs isFirstFeat field (add to all feats that don't have it)\n        if (sourceSystem.isFirstFeat === undefined || sourceSystem.isFirstFeat === null) {\n          update['system.isFirstFeat'] = false;\n          needsUpdate = true;\n          totalFirstFeatAdded++;\n          \n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding isFirstFeat field to \"${item.name}\" (ID: ${item.id})`);\n          \n          // Update details if not already added\n          const existingDetail = updateDetails.find(d => d.id === item.id);\n          if (existingDetail) {\n            existingDetail.hasFirstFeat = true;\n          } else {\n            updateDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: 0,\n              hasFirstFeat: true\n            });\n          }\n        }\n        \n        if (needsUpdate) {\n          update['system._narrativeEffectsValueMigrationVersion'] = '13.0.9';\n          updates.push(update);\n          totalUpdated++;\n        } else {\n          totalSkipped++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.9 completed - Items updated: ${totalUpdated}, isFirstFeat added: ${totalFirstFeatAdded}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (updateDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\n      \n      const totalEffects = updateDetails.reduce((sum, d) => sum + d.effectCount, 0);\n      const totalWithFirstFeat = updateDetails.filter(d => d.hasFirstFeat).length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects updated: ${totalEffects}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Total items with isFirstFeat added: ${totalWithFirstFeat}`);\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\n      \n      // List all updated items\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\n      updateDetails.forEach((detail, index) => {\n        const updates = [];\n        if (detail.effectCount > 0) updates.push(`${detail.effectCount} effect(s)`);\n        if (detail.hasFirstFeat) updates.push('isFirstFeat added');\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${updates.join(', ')}`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_9_INFO', { count: totalUpdated, firstFeatCount: totalFirstFeatAdded }) :\n        `Migration 13.0.9: Updated ${totalUpdated} feat(s) - added value field to narrative effects and isFirstFeat field to ${totalFirstFeatAdded} feat(s).`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \" Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \" All narrative effects now have a value field (default: -1)\");\n      console.log(SYSTEM.LOG.HEAD + \" All feats now have isFirstFeat field (default: false)\");\n      console.log(SYSTEM.LOG.HEAD + \" No data was lost in the migration\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.10: Update cost field values\n * This migration updates the cost field to use the new simplified system:\n * - 'specialized-equipment' -> 'advanced-equipment'\n * - 'feat' -> removed (defaults to 0 cost for non-equipment items)\n * - Cost field only applies to equipment and weapon types\n */\nexport class Migration_13_0_10 extends Migration {\n  get code() { \n    return \"migration-13.0.10\"; \n  }\n\n  get version() { \n    return \"13.0.10\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.10: Updating cost field values\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    let updateDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      // Log all feat items for debugging\n      const featItems = items.filter(item => item.type === 'feat');\n      console.log(SYSTEM.LOG.HEAD + `Found ${featItems.length} feat items to check`);\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Skip if already migrated\n        if (sourceSystem._costMigrationVersion === '13.0.10') {\n          totalSkipped++;\n          continue;\n        }\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        const currentCost = sourceSystem.cost || 'free-equipment';\n        const featType = sourceSystem.featType || 'equipment';\n        let newCost = currentCost;\n        let reason = '';\n        \n        // Log current state for debugging\n        console.log(SYSTEM.LOG.HEAD + `Checking \"${item.name}\" - cost: \"${currentCost}\", type: \"${featType}\"`);\n        \n        // Convert specialized-equipment to advanced-equipment\n        if (currentCost === 'specialized-equipment') {\n          newCost = 'advanced-equipment';\n          needsUpdate = true;\n          reason = 'specialized-equipment  advanced-equipment';\n        }\n        // Convert old 'feat' cost type to appropriate value\n        else if (currentCost === 'feat') {\n          // For equipment and weapons, set to free-equipment (0 cost)\n          // For other types, the cost doesn't apply anyway but we set it to free-equipment for consistency\n          newCost = 'free-equipment';\n          needsUpdate = true;\n          reason = 'feat  free-equipment (cost = 0 for non-equipment types)';\n        }\n        // Ensure all items have a valid cost value\n        else if (!currentCost || !['free-equipment', 'equipment', 'advanced-equipment'].includes(currentCost)) {\n          newCost = 'free-equipment';\n          needsUpdate = true;\n          reason = `invalid or missing cost (${currentCost})  free-equipment`;\n        }\n        \n        if (needsUpdate) {\n          update['system.cost'] = newCost;\n          update['system._costMigrationVersion'] = '13.0.10';\n          \n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.10: Updating cost for \"${item.name}\" (ID: ${item.id})`);\n          console.log(SYSTEM.LOG.HEAD + `  - Type: ${featType}`);\n          console.log(SYSTEM.LOG.HEAD + `  - Old cost: ${currentCost}`);\n          console.log(SYSTEM.LOG.HEAD + `  - New cost: ${newCost}`);\n          console.log(SYSTEM.LOG.HEAD + `  - Reason: ${reason}`);\n          \n          updateDetails.push({\n            name: item.name,\n            id: item.id,\n            featType: featType,\n            oldCost: currentCost,\n            newCost: newCost,\n            reason: reason\n          });\n          \n          updates.push(update);\n          totalUpdated++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.10 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (updateDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\n      \n      const specializedToAdvanced = updateDetails.filter(d => d.oldCost === 'specialized-equipment').length;\n      const featToFree = updateDetails.filter(d => d.oldCost === 'feat').length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - specialized-equipment  advanced-equipment: ${specializedToAdvanced}`);\n      console.log(SYSTEM.LOG.HEAD + `  - feat  free-equipment: ${featToFree}`);\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\n      \n      // List all updated items\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\n      updateDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (${detail.featType}): ${detail.oldCost}  ${detail.newCost}`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_10_INFO', { \n          count: totalUpdated,\n          specializedCount: updateDetails.filter(d => d.oldCost === 'specialized-equipment').length,\n          featCount: updateDetails.filter(d => d.oldCost === 'feat').length\n        }) :\n        `Migration 13.0.10: Updated ${totalUpdated} feat(s) cost values.`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \" Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \" Cost system simplified: free (0), equipment (2500), advanced (5000)\");\n      console.log(SYSTEM.LOG.HEAD + \" Cost now only applies to equipment and weapon types\");\n      console.log(SYSTEM.LOG.HEAD + \" No data was lost in the migration\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { SYSTEM } from \"./config/system.ts\";\n\n// Expose the SYSTEM object to the global scope\nglobalThis.SYSTEM = SYSTEM;\n\nimport * as models from \"./models/_module.ts\";\nimport * as documents from \"./documents/_module.ts\";\nimport * as applications from \"./applications/_module.ts\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migrations } from \"./migration/migration.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_3 } from \"./migration/migration-13.0.3.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_4 } from \"./migration/migration-13.0.4.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_5 } from \"./migration/migration-13.0.5.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_6 } from \"./migration/migration-13.0.6.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_7 } from \"./migration/migration-13.0.7.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_8 } from \"./migration/migration-13.0.8.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_9 } from \"./migration/migration-13.0.9.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_10 } from \"./migration/migration-13.0.10.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { HOOKS } from \"./hooks.mjs\";\n\nexport class SRA2System {\n  static start(): void {\n    new SRA2System();\n  }\n\n  constructor() {\n    if (game.system) {\n      game.system.sra2 = this;\n    }\n    Hooks.once('init', () => this.onInit());\n  }\n  \n  onInit(): void {\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onInit');\n    if (game.system) {\n      game.system.api = {\n        applications,\n        models,\n        documents,\n      };\n    }\n    \n    // Register migrations\n    new Migrations();\n    Hooks.on(HOOKS.MIGRATIONS, (declareMigration: any) => {\n      declareMigration(new Migration_13_0_3());\n      declareMigration(new Migration_13_0_4());\n      declareMigration(new Migration_13_0_5());\n      declareMigration(new Migration_13_0_6());\n      declareMigration(new Migration_13_0_7());\n      declareMigration(new Migration_13_0_8());\n      declareMigration(new Migration_13_0_9());\n      declareMigration(new Migration_13_0_10());\n    });\n    \n    // Register custom Actor document class\n    CONFIG.Actor.documentClass = documents.SRA2Actor;\n    \n    // Register Actor data models\n    CONFIG.Actor.dataModels = {\n      character: models.CharacterDataModel,\n      npc: models.NpcDataModel,\n    };\n    \n    // Register Item data models\n    CONFIG.Item.dataModels = {\n      skill: models.SkillDataModel,\n      feat: models.FeatDataModel,\n      specialization: models.SpecializationDataModel,\n      metatype: models.MetatypeDataModel,\n    };\n    \n    // Register character sheet\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheet, {\n      types: [\"character\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.CHARACTER\"\n    });\n    \n    // Register feat sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.FeatSheet, {\n      types: [\"feat\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.FEAT\"\n    });\n    \n    // Register skill sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SkillSheet, {\n      types: [\"skill\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.SKILL\"\n    });\n    \n    // Register specialization sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SpecializationSheet, {\n      types: [\"specialization\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.SPECIALIZATION\"\n    });\n    \n    // Register metatype sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.MetatypeSheet, {\n      types: [\"metatype\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.METATYPE\"\n    });\n    \n    // Register Handlebars helpers\n    Handlebars.registerHelper('add', function(a: number, b: number) {\n      return a + b;\n    });\n    \n    Handlebars.registerHelper('eq', function(a: any, b: any) {\n      return a === b;\n    });\n    \n    Handlebars.registerHelper('gt', function(a: any, b: any) {\n      return a > b;\n    });\n    \n    Handlebars.registerHelper('gte', function(a: any, b: any) {\n      return a >= b;\n    });\n    \n    // Register chat message hook for apply damage buttons\n    Hooks.on('renderChatMessage', (message: any, html: any) => {\n      html.find('.apply-damage-btn').on('click', async (event: any) => {\n        event.preventDefault();\n        const button = $(event.currentTarget);\n        const defenderId = button.data('defender-id');\n        const damage = parseInt(button.data('damage'));\n        const defenderName = button.data('defender-name');\n        \n        await applications.CharacterSheet.applyDamage(defenderId, damage, defenderName);\n      });\n    });\n    \n    Hooks.once(\"ready\", () => this.onReady());\n  }\n\n  async onReady(): Promise<void> {\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onReady');\n    \n    // Run migrations\n    const migrations = new Migrations();\n    migrations.migrate();\n    \n    // Migrate old feat data to new array format (deprecated, keeping for older versions)\n    await this.migrateFeatsToArrayFormat();\n    \n    // Migrate anarchyNimbus to anarchySpent\n    await this.migrateAnarchyNimbusToSpent();\n  }\n  \n  /**\n   * Migrate old feat data (single rrType/rrValue/rrTarget) to new array format\n   */\n  async migrateFeatsToArrayFormat(): Promise<void> {\n    const featsToUpdate: any[] = [];\n    \n    // Check all feats in the world\n    for (const item of game.items! as any) {\n      if ((item as any).type === 'feat') {\n        const system = (item as any).system as any;\n        let needsUpdate = false;\n        const updates: any = { _id: (item as any).id };\n        \n        // Check if rrType is not an array (old format)\n        if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\n          needsUpdate = true;\n          // Convert single value to array (only if not \"none\")\n          if (system.rrType !== 'none') {\n            updates['system.rrType'] = [system.rrType];\n            updates['system.rrValue'] = [system.rrValue || 0];\n            updates['system.rrTarget'] = [system.rrTarget || ''];\n          } else {\n            updates['system.rrType'] = [];\n            updates['system.rrValue'] = [];\n            updates['system.rrTarget'] = [];\n          }\n        }\n        \n        if (needsUpdate) {\n          featsToUpdate.push(updates);\n        }\n      }\n    }\n    \n    // Check all feats on actors\n    for (const actor of game.actors! as any) {\n      const actorUpdates: any[] = [];\n      \n      for (const item of (actor as any).items) {\n        if ((item as any).type === 'feat') {\n          const system = (item as any).system as any;\n          let needsUpdate = false;\n          const updates: any = { _id: (item as any).id };\n          \n          // Check if rrType is not an array (old format)\n          if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\n            needsUpdate = true;\n            // Convert single value to array (only if not \"none\")\n            if (system.rrType !== 'none') {\n              updates['system.rrType'] = [system.rrType];\n              updates['system.rrValue'] = [system.rrValue || 0];\n              updates['system.rrTarget'] = [system.rrTarget || ''];\n            } else {\n              updates['system.rrType'] = [];\n              updates['system.rrValue'] = [];\n              updates['system.rrTarget'] = [];\n            }\n          }\n          \n          if (needsUpdate) {\n            actorUpdates.push(updates);\n          }\n        }\n      }\n      \n      if (actorUpdates.length > 0) {\n        console.log(`${SYSTEM.LOG.HEAD} Migrating ${actorUpdates.length} feats on actor ${(actor as any).name}`);\n        await (actor as any).updateEmbeddedDocuments('Item', actorUpdates);\n      }\n    }\n    \n    if (featsToUpdate.length > 0) {\n      console.log(`${SYSTEM.LOG.HEAD} Migrating ${featsToUpdate.length} world feats`);\n      await Item.updateDocuments(featsToUpdate);\n    }\n    \n    if (featsToUpdate.length > 0 || (game.actors! as any).some((a: any) => a.items.some((i: any) => i.type === 'feat'))) {\n      console.log(`${SYSTEM.LOG.HEAD} Feat migration to array format complete`);\n    }\n  }\n  \n  /**\n   * Migrate anarchyNimbus to anarchySpent\n   */\n  async migrateAnarchyNimbusToSpent(): Promise<void> {\n    const actorsToUpdate: any[] = [];\n    \n    // Check all character actors in the world\n    for (const actor of game.actors! as any) {\n      if ((actor as any).type === 'character') {\n        const system = (actor as any).system as any;\n        \n        // Check if the old anarchyNimbus field exists\n        if (system.anarchyNimbus !== undefined && system.anarchySpent === undefined) {\n          actorsToUpdate.push({\n            _id: (actor as any).id,\n            'system.anarchySpent': system.anarchyNimbus\n          });\n        }\n      }\n    }\n    \n    if (actorsToUpdate.length > 0) {\n      console.log(`${SYSTEM.LOG.HEAD} Migrating anarchyNimbus to anarchySpent for ${actorsToUpdate.length} actors`);\n      await Actor.updateDocuments(actorsToUpdate);\n      console.log(`${SYSTEM.LOG.HEAD} anarchyNimbus to anarchySpent migration complete`);\n    }\n  }\n}\n\n","import { SRA2System } from \"./module/sra2-system.ts\";\n\nSRA2System.start();\n\nimport \"./styles/global.scss\";\n\n"],"names":["SYSTEM","documents","i","message","documents.SRA2Actor","models.CharacterDataModel","models.NpcDataModel","models.SkillDataModel","models.FeatDataModel","models.SpecializationDataModel","models.MetatypeDataModel","applications.CharacterSheet","applications.FeatSheet","applications.SkillSheet","applications.SpecializationSheet","applications.MetatypeSheet"],"mappings":"AAAA,MAAM,YAAY;AAgBX,MAAMA,WAAuB;AAAA,EAClC,IAAI;AAAA,EACJ,KAAK;AAAA,IACH,MAAM,GAAG,SAAS;AAAA,EAAA;AAAA,EAEpB,QAAQ,UAAU,SAAS;AAAA,EAC3B,MAAM;AAAA,IACJ,MAAM,WAAW,SAAS;AAAA,IAC1B,OAAO,WAAW,SAAS;AAAA,IAC3B,WAAW,WAAW,SAAS;AAAA,IAC/B,QAAQ,WAAW,SAAS;AAAA,EAAA;AAEhC;ACzBO,MAAM,2BAA2B,QAAQ,SAAS,cAA0B;AAAA,EACjF,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,SAAS,IAAI,OAAO,YAAY;AAAA,UAC9B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,OAAO,IAAI,OAAO,YAAY;AAAA,UAC5B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,WAAW,IAAI,OAAO,YAAY;AAAA,QAChC,MAAM,IAAI,OAAO,YAAY;AAAA,UAC3B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,SAAS,IAAI,OAAO,YAAY;AAAA,UAC9B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,MAAA,CACV;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,MAAA,CACV;AAAA,MACD,QAAQ,IAAI,OAAO,YAAY;AAAA,QAC7B,OAAO,IAAI,OAAO,WAAW,IAAI,OAAO,aAAa;AAAA,UACnD,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV,GAAG;AAAA,UACF,UAAU;AAAA,UACV,SAAS,CAAC,OAAO,KAAK;AAAA,QAAA,CACvB;AAAA,QACD,QAAQ,IAAI,OAAO,WAAW,IAAI,OAAO,aAAa;AAAA,UACpD,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV,GAAG;AAAA,UACF,UAAU;AAAA,UACV,SAAS,CAAC,KAAK;AAAA,QAAA,CAChB;AAAA,QACD,gBAAgB,IAAI,OAAO,aAAa;AAAA,UACtC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,cAAc,IAAI,OAAO,WAAW,IAAI,OAAO,aAAa;AAAA,QAC1D,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV,GAAG;AAAA,QACF,UAAU;AAAA,QACV,SAAS,CAAC,OAAO,OAAO,KAAK;AAAA,MAAA,CAC9B;AAAA,MACD,KAAK,IAAI,OAAO,YAAY;AAAA,QAC1B,YAAY,IAAI,OAAO,UAAU;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,OAAO,IAAI,OAAO,UAAU;AAAA,UAC1B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,UAAU,IAAI,OAAO,YAAY;AAAA,QAC/B,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,WAAW,IAAI,OAAO,YAAY;AAAA,QAChC,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,cAAc,IAAI,OAAO,YAAY;AAAA,QACnC,cAAc,IAAI,OAAO,YAAY;AAAA,UACnC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,cAAc,IAAI,OAAO,YAAY;AAAA,UACnC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,cAAc,IAAI,OAAO,YAAY;AAAA,UACnC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,cAAc,IAAI,OAAO,YAAY;AAAA,UACnC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,IAAA;AAAA,EAEL;AAAA;AAAA;AAAA;AAAA;AAAA,EAMQ,uBAAuB,OAAe,UAA0B;AACtE,QAAI,OAAO;AACX,aAAS,IAAI,GAAG,KAAK,OAAO,KAAK;AAC/B,UAAI,MAAM,UAAU;AAClB,gBAAQ;AAAA,MACV,OAAO;AACL,gBAAQ;AAAA,MACV;AAAA,IACF;AACA,WAAO;AAAA,EACT;AAAA,EAES,qBAA2B;AAElC,UAAM,SAAU,KAAa;AAC7B,QAAI,iBAAiB;AAAA,MACnB,UAAU;AAAA,MACV,SAAS;AAAA,MACT,WAAW;AAAA,MACX,OAAO;AAAA,MACP,UAAU;AAAA,IAAA;AAEZ,QAAI,eAAe;AAEnB,QAAI,UAAU,OAAO,OAAO;AAC1B,YAAM,WAAW,OAAO,MAAM,KAAK,CAAC,SAAc,KAAK,SAAS,UAAU;AAC1E,UAAI,YAAY,SAAS,QAAQ;AAC/B,yBAAiB;AAAA,UACf,UAAU,SAAS,OAAO,eAAe;AAAA,UACzC,SAAS,SAAS,OAAO,cAAc;AAAA,UACvC,WAAW,SAAS,OAAO,gBAAgB;AAAA,UAC3C,OAAO,SAAS,OAAO,YAAY;AAAA,UACnC,UAAU,SAAS,OAAO,eAAe;AAAA,QAAA;AAE3C,uBAAe,SAAS,OAAO,gBAAgB;AAAA,MACjD;AAAA,IACF;AAEC,SAAa,iBAAiB;AAG/B,QAAI,mBAAmB;AACvB,QAAI,oBAAoB;AACxB,QAAI,yBAAyB;AAC7B,QAAI,uBAAuB;AAC3B,QAAI,eAAe;AACnB,QAAI,mBAAmB;AACvB,QAAI,kBAAkB;AACtB,UAAM,oBAA8D,CAAA;AAEpE,QAAI,UAAU,OAAO,OAAO;AAC1B,YAAM,cAAc,OAAO,MAAM;AAAA,QAAO,CAAC,SACvC,KAAK,SAAS,UAAU,KAAK,OAAO,WAAW;AAAA,MAAA;AAGjD,kBAAY,QAAQ,CAAC,SAAc;AACjC,4BAAoB,KAAK,OAAO,oBAAoB;AACpD,6BAAqB,KAAK,OAAO,qBAAqB;AACtD,kCAA0B,KAAK,OAAO,0BAA0B;AAChE,gCAAwB,KAAK,OAAO,wBAAwB;AAC5D,wBAAgB,KAAK,OAAO,gBAAgB;AAC5C,4BAAoB,KAAK,OAAO,eAAe;AAG/C,YAAI,KAAK,OAAO,iBAAiB;AAC/B;AACA,4BAAkB,KAAK;AAAA,YACrB,MAAM,KAAK;AAAA,YACX,SAAS,KAAK,OAAO,oBAAoB;AAAA,UAAA,CAC1C;AAAA,QACH;AAAA,MACF,CAAC;AAAA,IACH;AAGC,SAAa,eAAe,IAAI,eAAe;AAC/C,SAAa,eAAe;AAC5B,SAAa,oBAAoB;AAGjC,SAAa,kBAAkB,IAAI;AACnC,SAAa,kBAAkB;AAC/B,SAAa,oBAAoB;AAGlC,UAAM,kBAAkB,IAAI;AAC5B,UAAM,mBAAmB,IAAI;AAG7B,UAAM,SAAU,KAAa,UAAU,CAAA;AAGvC,QAAI,CAAC,MAAM,QAAQ,OAAO,KAAK,GAAG;AAChC,aAAO,QAAQ,CAAC,OAAO,KAAK;AAAA,IAC9B;AACA,WAAO,OAAO,MAAM,SAAS,iBAAiB;AAC5C,aAAO,MAAM,KAAK,KAAK;AAAA,IACzB;AACA,WAAO,OAAO,MAAM,SAAS,iBAAiB;AAC5C,aAAO,MAAM,IAAA;AAAA,IACf;AAGA,QAAI,CAAC,MAAM,QAAQ,OAAO,MAAM,GAAG;AACjC,aAAO,SAAS,CAAC,KAAK;AAAA,IACxB;AACA,WAAO,OAAO,OAAO,SAAS,kBAAkB;AAC9C,aAAO,OAAO,KAAK,KAAK;AAAA,IAC1B;AACA,WAAO,OAAO,OAAO,SAAS,kBAAkB;AAC9C,aAAO,OAAO,IAAA;AAAA,IAChB;AAEC,SAAa,kBAAkB;AAC/B,SAAa,mBAAmB;AAGjC,UAAM,eAAe,IAAI,eAAe;AACxC,UAAM,eAAgB,KAAa,gBAAgB,CAAA;AAEnD,QAAI,CAAC,MAAM,QAAQ,YAAY,GAAG;AAC/B,WAAa,eAAe,CAAA;AAAA,IAC/B;AACA,WAAQ,KAAa,aAAa,SAAS,cAAc;AACtD,WAAa,aAAa,KAAK,KAAK;AAAA,IACvC;AACA,WAAQ,KAAa,aAAa,SAAS,cAAc;AACtD,WAAa,aAAa,IAAA;AAAA,IAC7B;AAGA,UAAM,aAAc,KAAa,cAAc;AAC9C,SAAa,YAAY,aAAa;AAGvC,UAAM,WAAY,KAAa,YAAY,YAAY;AACvD,UAAM,YAAa,KAAa,YAAY,aAAa;AAExD,SAAa,mBAAmB;AAAA,MAC/B,cAAc;AAAA,QACZ,OAAO,WAAW;AAAA,QAClB,UAAU,WAAW,yBAAyB;AAAA,QAC9C,QAAQ,WAAW,yBAAyB;AAAA,MAAA;AAAA,MAE9C,WAAW;AAAA,QACT,OAAO,WAAW,aAAa;AAAA,QAC/B,UAAU,WAAW,aAAa,yBAAyB;AAAA,QAC3D,QAAQ,WAAW,aAAa,yBAAyB;AAAA,MAAA;AAAA,MAE3D,QAAQ;AAAA,QACN,OAAO,YAAY;AAAA,QACnB,UAAU,YAAY,uBAAuB;AAAA,QAC7C,QAAQ,YAAY,uBAAuB;AAAA,MAAA;AAAA,IAC7C;AAIF,UAAM,aAAc,KAAa,cAAc;AAC9C,SAAa,iBAAiB,KAAK,IAAI,GAAG,aAAa,gBAAgB;AAGxE,UAAM,aAAc,KAAa;AACjC,QAAI,YAAY;AAEd,iBAAW,WAAW,KAAK,IAAI,WAAW,YAAY,GAAG,eAAe,QAAQ;AAChF,iBAAW,UAAU,KAAK,IAAI,WAAW,WAAW,GAAG,eAAe,OAAO;AAC7E,iBAAW,YAAY,KAAK,IAAI,WAAW,aAAa,GAAG,eAAe,SAAS;AACnF,iBAAW,QAAQ,KAAK,IAAI,WAAW,SAAS,GAAG,eAAe,KAAK;AACvE,iBAAW,WAAW,KAAK,IAAI,WAAW,YAAY,GAAG,eAAe,QAAQ;AAE/E,WAAa,iBAAiB;AAAA,QAC7B,UAAU,KAAK,uBAAuB,WAAW,YAAY,GAAG,eAAe,QAAQ;AAAA,QACvF,SAAS,KAAK,uBAAuB,WAAW,WAAW,GAAG,eAAe,OAAO;AAAA,QACpF,WAAW,KAAK,uBAAuB,WAAW,aAAa,GAAG,eAAe,SAAS;AAAA,QAC1F,OAAO,KAAK,uBAAuB,WAAW,SAAS,GAAG,eAAe,KAAK;AAAA,QAC9E,UAAU,KAAK,uBAAuB,WAAW,YAAY,GAAG,eAAe,QAAQ;AAAA,MAAA;AAIzF,YAAM,iBAAkB,KAAa;AACrC,UAAI,YAAY,OAAO,OAAO,cAAc,EAAE,OAAO,CAAC,KAAa,SAAc,MAAM,MAAM,CAAC;AAG9F,mBAAc,KAAa,aAAa;AAGxC,UAAI,UAAU,OAAO,OAAO;AAC1B,eAAO,MAAM,QAAQ,CAAC,SAAc;AAClC,cAAI,KAAK,UAAU,KAAK,OAAO,mBAAmB,QAAW;AAC3D,yBAAa,KAAK,OAAO;AAAA,UAC3B;AAAA,QACF,CAAC;AAAA,MACH;AAEC,WAAa,YAAY;AAAA,IAC5B;AAAA,EACF;AACF;AC3WO,MAAM,qBAAqB,QAAQ,SAAS,cAA0B;AAAA,EAC3E,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,OAAO,IAAI,OAAO,YAAY;AAAA,QAC5B,QAAQ,IAAI,OAAO,YAAY;AAAA,UAC7B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,WAAW,IAAI,OAAO,YAAY;AAAA,UAChC,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,QACD,OAAO,IAAI,OAAO,YAAY;AAAA,UAC5B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,UAAU;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV;AAAA,IAAA;AAAA,EAEL;AAAA,EAES,qBAA2B;AAAA,EAEpC;AACF;AC3CO,MAAM,uBAAuB,QAAQ,SAAS,cAAyB;AAAA,EAC5E,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,QAAQ,IAAI,OAAO,YAAY;AAAA,QAC7B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,iBAAiB,IAAI,OAAO,YAAY;AAAA,QACtC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,UAAU;AAAA,UACV,SAAS;AAAA,UACT,WAAW;AAAA,UACX,OAAO;AAAA,UACP,UAAU;AAAA,QAAA;AAAA,QAEZ,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,UAAU;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV;AAAA,IAAA;AAAA,EAEL;AAAA,EAES,qBAA2B;AAGlC,UAAM,SAAU,KAAa,UAAU;AAEvC,QAAI,iBAAiB;AACrB,QAAI,UAAU,GAAG;AACf,uBAAiB,SAAS;AAAA,IAC5B,OAAO;AAEL,uBAAiB,IAAI,QAAQ,SAAS,KAAK;AAAA,IAC7C;AAEC,SAAa,iBAAiB;AAAA,EACjC;AACF;AC/CO,MAAM,eAAe;AAAA,EAC1B,iBAAiB,EAAE,IAAI,KAAK,OAAO,QAAQ,OAAO,QAAQ,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAChF,cAAc,EAAE,IAAI,OAAO,OAAO,MAAM,OAAO,QAAQ,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC7E,iBAAiB,EAAE,IAAI,SAAS,OAAO,MAAM,OAAO,QAAQ,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAClF,gBAAgB,EAAE,IAAI,SAAS,OAAO,MAAM,OAAO,QAAQ,QAAQ,QAAQ,MAAM,OAAA;AAAA,EACjF,kBAAkB,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,QAAQ,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC7E,YAAY,EAAE,IAAI,SAAS,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC3E,QAAQ,EAAE,IAAI,SAAS,OAAO,MAAM,OAAO,MAAM,QAAQ,MAAM,MAAM,OAAA;AAAA,EACrE,aAAa,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,MAAM,MAAM,OAAA;AAAA,EACpE,UAAU,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EACnE,kBAAkB,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC3E,iBAAiB,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC1E,qBAAqB,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC9E,iBAAiB,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC1E,QAAQ,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,MAAM,QAAQ,MAAM,MAAM,OAAA;AAAA,EACjE,kBAAkB,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,MAAM,QAAQ,MAAM,MAAM,OAAA;AAAA,EAC3E,YAAY,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EACvE,iBAAiB,EAAE,IAAI,IAAI,OAAO,QAAQ,OAAO,QAAQ,QAAQ,QAAQ,MAAM,KAAA;AAAA,EAC/E,gBAAgB,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,MAAM,QAAQ,MAAM,MAAM,KAAA;AAAA,EACzE,YAAY,EAAE,IAAI,GAAG,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EACrE,gBAAgB,EAAE,IAAI,SAAS,OAAO,MAAM,OAAO,MAAM,QAAQ,QAAQ,MAAM,OAAA;AAAA,EAC/E,qBAAqB,EAAE,IAAI,GAAG,OAAO,QAAQ,OAAO,QAAQ,QAAQ,MAAM,MAAM,KAAA;AAAA,EAChF,oBAAoB,EAAE,IAAI,IAAI,OAAO,QAAQ,OAAO,QAAQ,QAAQ,QAAQ,MAAM,KAAA;AACpF;AAKO,MAAM,gBAAgB;AAAA,EAC3B,cAAc,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,IAAI,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAAA,EAC3G,eAAe,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,MAAA;AAAA,EAC3G,gBAAgB,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,QAAA;AAAA,EAC5G,eAAe,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,QAAA;AAAA,EAC3G,qBAAqB,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,QAAA;AAAA,EACjH,sBAAsB,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,QAAA;AAAA,EAClH,WAAW,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,QAAA;AAAA,EACvG,cAAc,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAAA,EAC1G,SAAS,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAAA,EACrG,cAAc,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAAA,EAC1G,OAAO,EAAE,WAAW,GAAG,WAAW,GAAG,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAAA,EACnG,aAAa,EAAE,WAAW,GAAG,WAAW,IAAI,UAAU,GAAG,OAAO,GAAG,aAAa,GAAG,OAAO,GAAG,aAAa,OAAA;AAC5G;AAKO,MAAM,sBAAsB,QAAQ,SAAS,cAAyB;AAAA,EAC3E,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,aAAa,IAAI,OAAO,UAAU;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV;AAAA,MACD,QAAQ,IAAI,OAAO,YAAY;AAAA,QAC7B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,MAAM,IAAI,OAAO,YAAY;AAAA,QAC3B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,kBAAkB;AAAA,UAClB,aAAa;AAAA,UACb,sBAAsB;AAAA;AAAA,UAEtB,yBAAyB;AAAA,UACzB,QAAQ;AAAA,QAAA;AAAA,QAEV,OAAO;AAAA,MAAA,CACR;AAAA,MACD,QAAQ,IAAI,OAAO,aAAa;AAAA,QAC9B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,QAAQ,IAAI,OAAO,WAAW,IAAI,OAAO,YAAY;AAAA,QACnD,QAAQ,IAAI,OAAO,YAAY;AAAA,UAC7B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,SAAS;AAAA,YACP,aAAa;AAAA,YACb,SAAS;AAAA,YACT,kBAAkB;AAAA,UAAA;AAAA,UAEpB,OAAO;AAAA,QAAA,CACR;AAAA,QACD,SAAS,IAAI,OAAO,YAAY;AAAA,UAC9B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,KAAK;AAAA,UACL,SAAS;AAAA,UACT,OAAO;AAAA,QAAA,CACR;AAAA,QACD,UAAU,IAAI,OAAO,YAAY;AAAA,UAC/B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,UAAU;AAAA,UACV,OAAO;AAAA,QAAA,CACR;AAAA,MAAA,CACF,GAAG;AAAA,QACF,SAAS,CAAA;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,kBAAkB,IAAI,OAAO,YAAY;AAAA,QACvC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,mBAAmB,IAAI,OAAO,YAAY;AAAA,QACxC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,wBAAwB,IAAI,OAAO,YAAY;AAAA,QAC7C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,sBAAsB,IAAI,OAAO,YAAY;AAAA,QAC3C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,cAAc,IAAI,OAAO,YAAY;AAAA,QACnC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,UAAU,IAAI,OAAO,YAAY;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,SAAS;AAAA,UACT,WAAW;AAAA,UACX,YAAY;AAAA,UACZ,eAAe;AAAA,UACf,aAAa;AAAA,UACb,aAAa;AAAA,UACb,aAAa;AAAA,UACb,WAAW;AAAA,UACX,kBAAkB;AAAA,UAClB,UAAU;AAAA,UACV,SAAS;AAAA,QAAA;AAAA,QAEX,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,kBAAkB,IAAI,OAAO,YAAY;AAAA,QACvC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA;AAAA,QAEV,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA;AAAA,QAEV,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA;AAAA,QAEV,OAAO;AAAA,MAAA,CACR;AAAA,MACD,WAAW,IAAI,OAAO,YAAY;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,QAAA;AAAA,QAEV,OAAO;AAAA,MAAA,CACR;AAAA,MACD,mBAAmB,IAAI,OAAO,YAAY;AAAA,QACxC,OAAO,IAAI,OAAO,aAAa;AAAA,UAC7B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,OAAO,IAAI,OAAO,aAAa;AAAA,UAC7B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,QAAQ,IAAI,OAAO,aAAa;AAAA,UAC9B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,MAAM,IAAI,OAAO,aAAa;AAAA,UAC5B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,GACA;AAAA,QACD,UAAU;AAAA,QACV,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,WAAW,IAAI,OAAO,YAAY;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,WAAW,IAAI,OAAO,YAAY;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,UAAU,IAAI,OAAO,YAAY;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,OAAO,IAAI,OAAO,YAAY;AAAA,QAC5B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,OAAO,IAAI,OAAO,YAAY;AAAA,QAC5B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,gBAAgB,IAAI,OAAO,YAAY;AAAA,QACrC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,eAAe,IAAI,OAAO,YAAY;AAAA,QACpC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,SAAS,IAAI,OAAO,aAAa;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,UAAU,IAAI,OAAO,aAAa;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,wBAAwB,IAAI,OAAO,aAAa;AAAA,QAC9C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,mBAAmB,IAAI,OAAO,aAAa;AAAA,QACzC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,sBAAsB,IAAI,OAAO,YAAY;AAAA,QAC3C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,UAAU,IAAI,OAAO,YAAY;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,QAAQ,IAAI,OAAO,YAAY;AAAA,QAC7B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,kBAAkB,IAAI,OAAO,aAAa;AAAA,QACxC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,kBAAkB,IAAI,OAAO,aAAa;AAAA,QACxC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,SAAS,IAAI,OAAO,aAAa;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,aAAa;AAAA,QACnC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,OAAO,IAAI,OAAO,aAAa;AAAA,QAC7B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,oBAAoB,IAAI,OAAO,YAAY;AAAA,QACzC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,yBAAyB,IAAI,OAAO,aAAa;AAAA,QAC/C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,eAAe,IAAI,OAAO,aAAa;AAAA,QACrC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,kBAAkB,IAAI,OAAO,WAAW,IAAI,OAAO,YAAY;AAAA,QAC7D,MAAM,IAAI,OAAO,YAAY;AAAA,UAC3B,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,YAAY,IAAI,OAAO,aAAa;AAAA,UAClC,UAAU;AAAA,UACV,SAAS;AAAA,QAAA,CACV;AAAA,QACD,OAAO,IAAI,OAAO,YAAY;AAAA,UAC5B,UAAU;AAAA,UACV,SAAS;AAAA,UACT,KAAK;AAAA,UACL,KAAK;AAAA,UACL,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,CACF,GAAG;AAAA,QACF,SAAS,CAAA;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,iBAAiB,IAAI,OAAO,aAAa;AAAA,QACvC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,kBAAkB,IAAI,OAAO,YAAY;AAAA,QACvC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,qBAAqB,IAAI,OAAO,YAAY;AAAA,QAC1C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,qBAAqB,IAAI,OAAO,YAAY;AAAA,QAC1C,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,aAAa,IAAI,OAAO,aAAa;AAAA,QACnC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA;AAAA,MAED,cAAc,IAAI,OAAO,aAAa;AAAA,QACpC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,IAAA;AAAA,EAEL;AAAA,EAES,qBAA2B;AAElC,UAAM,WAAY,KAAa,QAAQ;AACvC,UAAM,WAAY,KAAa,YAAY;AAC3C,UAAM,SAAU,KAAa,UAAU;AAGvC,QAAI,iBAAiB;AAGrB,QAAI,aAAa,eAAe,aAAa,YAAY,aAAa,kBAAkB;AACtF,cAAQ,UAAA;AAAA,QACN,KAAK;AACH,2BAAiB;AACjB;AAAA,QACF,KAAK;AACH,2BAAiB;AACjB;AAAA,QACF,KAAK;AACH,2BAAiB;AACjB;AAAA;AAAA,QAEF,KAAK;AACH,2BAAiB;AACjB;AAAA,QACF,KAAK;AACH,2BAAiB;AACjB;AAAA,QACF;AACE,2BAAiB;AAAA,MAAA;AAAA,IAEvB;AAEA,sBAAkB,SAAS;AAE1B,SAAa,iBAAiB;AAG/B,QAAI,mBAAmB;AACvB,UAAM,4BAA8F,CAAA;AAEpG,UAAM,mBAAoB,KAAa,oBAAoB;AAC3D,UAAM,oBAAqB,KAAa,qBAAqB;AAC7D,UAAM,yBAA0B,KAAa,0BAA0B;AACvE,UAAM,uBAAwB,KAAa,wBAAwB;AACnE,UAAM,WAAY,KAAa,YAAY;AAC3C,UAAM,SAAU,KAAa,UAAU;AACvC,UAAM,qBAAsB,KAAa,sBAAsB;AAC/D,UAAM,0BAA2B,KAAa,2BAA2B;AACzE,UAAM,gBAAiB,KAAa,iBAAiB;AACrD,UAAM,eAAgB,KAAa,gBAAgB;AACnD,UAAM,kBAAmB,KAAa,mBAAmB;AACzD,UAAM,mBAAoB,KAAa,oBAAoB,CAAA;AAC3D,UAAM,SAAU,KAAa,UAAU,CAAA;AACvC,UAAM,cAAe,KAAa,eAAe;AAGjD,QAAI,aAAa,WAAW,CAAC,aAAa;AACxC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,uCAAuC,OAAO,GAAG;AAAA,IAC9F;AAGA,QAAI,aAAa,aAAa;AAC5B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,kCAAkC,OAAO,GAAG;AAAA,IACzF;AAGA,QAAI,aAAa,eAAe;AAC9B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,oCAAoC,OAAO,GAAG;AAAA,IAC3F;AAGA,QAAI,aAAa,SAAS;AACxB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,8BAA8B,OAAO,GAAG;AAAA,IACrF;AAGA,QAAI,aAAa,WAAW;AAC1B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,gCAAgC,OAAO,GAAG;AAAA,IACvF;AAGA,QAAI,mBAAmB,GAAG;AACxB,YAAM,QAAQ,mBAAmB;AACjC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,qCAAqC,aAAa,IAAI,gBAAgB,KAAK,MAAA,CAAO;AAAA,IAC/H;AAGA,QAAI,oBAAoB,GAAG;AACzB,YAAM,QAAQ,oBAAoB;AAClC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,sCAAsC,aAAa,IAAI,iBAAiB,KAAK,MAAA,CAAO;AAAA,IACjI;AAGA,QAAI,2BAA2B,GAAG;AAChC,YAAM,QAAQ,KAAK,IAAI,sBAAsB;AAC7C,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,2CAA2C,aAAa,IAAI,yBAAyB,IAAI,MAAM,EAAE,GAAG,sBAAsB,KAAK,OAAO;AAAA,IACnL;AAGA,QAAI,yBAAyB,GAAG;AAC9B,YAAM,QAAQ,KAAK,IAAI,oBAAoB;AAC3C,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,yCAAyC,aAAa,IAAI,uBAAuB,IAAI,MAAM,EAAE,GAAG,oBAAoB,KAAK,OAAO;AAAA,IAC7K;AAGA,QAAI,aAAa,eAAe,WAAW,GAAG;AAC5C,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,iCAAiC,aAAa,IAAI,QAAQ,KAAK,OAAO,SAAA,CAAU;AAAA,IAC7H;AAGA,QAAI,SAAS,GAAG;AACd,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,+BAA+B,aAAa,IAAI,MAAM,KAAK,OAAO,OAAA,CAAQ;AAAA,IACvH;AAGA,QAAI,qBAAqB,GAAG;AAC1B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,uCAAuC,aAAa,IAAI,kBAAkB,KAAK,OAAO,mBAAA,CAAoB;AAAA,IACvJ;AAGA,QAAI,yBAAyB;AAC3B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,uCAAuC,OAAO,GAAG;AAAA,IAC9F;AAGA,QAAI,eAAe;AACjB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,qCAAqC,OAAO,GAAG;AAAA,IAC5F;AAGA,UAAM,mBAAoB,KAAa,oBAAoB;AAC3D,QAAI,mBAAmB,GAAG;AACxB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,2CAA2C,aAAa,KAAK,gBAAgB,KAAK,OAAO,iBAAA,CAAkB;AAAA,IACxJ;AAGA,UAAM,oBAAqB,KAAa,qBAAqB,CAAA;AAC7D,QAAI,wBAAwB;AAC5B,QAAI,kBAAkB,MAAO;AAC7B,QAAI,kBAAkB,MAAO;AAC7B,QAAI,kBAAkB,OAAQ;AAC9B,QAAI,kBAAkB,KAAM;AAC5B,QAAI,wBAAwB,GAAG;AAC7B,YAAM,QAAQ,wBAAwB;AACtC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,2CAA2C,aAAa,IAAI,qBAAqB,KAAK,MAAA,CAAO;AAAA,IAC1I;AAGA,eAAW,MAAM,QAAQ;AACvB,YAAM,SAAS,GAAG;AAClB,YAAM,UAAU,GAAG,WAAW;AAE9B,UAAI,UAAU,GAAG;AACf,YAAI,WAAW,kBAAkB;AAE/B,gBAAM,QAAQ,UAAU;AACxB,8BAAoB;AACpB,oCAA0B,KAAK,EAAE,UAAU,0CAA0C,aAAa,IAAI,OAAO,KAAK,MAAA,CAAO;AAAA,QAC3H,WAAW,WAAW,SAAS;AAE7B,gBAAM,QAAQ,UAAU;AACxB,8BAAoB;AACpB,oCAA0B,KAAK,EAAE,UAAU,iCAAiC,aAAa,IAAI,OAAO,KAAK,MAAA,CAAO;AAAA,QAClH,WAAW,WAAW,aAAa;AAEjC,gBAAM,QAAQ,UAAU;AACxB,8BAAoB;AACpB,oCAA0B,KAAK,EAAE,UAAU,qCAAqC,aAAa,IAAI,OAAO,KAAK,MAAA,CAAO;AAAA,QACtH;AAAA,MACF;AAAA,IACF;AAGA,QAAI,eAAe,GAAG;AACpB,YAAM,QAAQ,eAAe;AAC7B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,sCAAsC,aAAa,IAAI,YAAY,KAAK,MAAA,CAAO;AAAA,IAC5H;AAGA,QAAI,iBAAiB;AACnB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,yCAAyC,OAAO,GAAG;AAAA,IAChG;AAGA,UAAM,uBAAuB,iBAAiB,OAAO,CAAC,WAAgB,QAAQ,QAAQ,OAAO,KAAK,WAAW,MAAM,CAAC,OAAO,UAAU,EAAE;AACvI,UAAM,kBAAkB,iBAAiB,OAAO,CAAC,WAAgB,QAAQ,QAAQ,OAAO,KAAK,KAAA,MAAW,MAAM,OAAO,UAAU;AAE/H,QAAI,uBAAuB,GAAG;AAC5B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,mDAAmD,aAAa,IAAI,oBAAoB,KAAK,OAAO,qBAAA,CAAsB;AAAA,IACvK;AAEA,QAAI,gBAAgB,SAAS,GAAG;AAC9B,YAAM,sBAAsB,gBAAgB,OAAO,CAAC,KAAa,WAAgB,OAAO,OAAO,SAAS,KAAK,CAAC;AAC9G,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,mDAAmD,aAAa,IAAI,gBAAgB,MAAM,KAAK,OAAO,oBAAA,CAAqB;AAAA,IACxK;AAGA,UAAM,sBAAuB,KAAa,uBAAuB;AACjE,QAAI,sBAAsB,GAAG;AAC3B,YAAM,QAAQ,sBAAsB;AACpC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,yCAAyC,aAAa,IAAI,mBAAmB,KAAK,MAAA,CAAO;AAAA,IACtI;AAGA,UAAM,sBAAuB,KAAa,uBAAuB;AACjE,QAAI,sBAAsB,GAAG;AAC3B,YAAM,QAAQ,sBAAsB;AACpC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,yCAAyC,aAAa,IAAI,mBAAmB,KAAK,MAAA,CAAO;AAAA,IACtI;AAGA,UAAM,mBAAoB,KAAa,oBAAoB;AAC3D,UAAM,mBAAoB,KAAa,oBAAoB;AAC3D,UAAM,UAAW,KAAa,WAAW;AACzC,UAAM,cAAe,KAAa,eAAe;AACjD,UAAM,QAAS,KAAa,SAAS;AAGrC,QAAI,oBAAoB,kBAAkB;AACxC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,qDAAqD,OAAO,GAAG;AAAA,IAC5G;AAGA,QAAI,SAAS;AACX,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,gCAAgC,OAAO,GAAG;AAAA,IACvF;AAGA,QAAI,aAAa;AACf,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,oCAAoC,OAAO,GAAG;AAAA,IAC3F;AAGA,QAAI,OAAO;AACT,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,8BAA8B,OAAO,GAAG;AAAA,IACrF;AAGA,UAAM,iBAAkB,KAAa,kBAAkB;AACvD,UAAM,aAAc,KAAa,cAAc;AAC/C,UAAM,gBAAiB,KAAa,iBAAiB;AACrD,UAAM,aAAc,KAAa,cAAc;AAC/C,UAAM,UAAW,KAAa,WAAW;AACzC,UAAM,WAAY,KAAa,YAAY;AAC3C,UAAM,yBAA0B,KAAa,0BAA0B;AACvE,UAAM,oBAAqB,KAAa,qBAAqB;AAC7D,UAAM,uBAAwB,KAAa,wBAAwB;AAGnE,QAAI,iBAAiB,GAAG;AACtB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,wCAAwC,aAAa,KAAK,cAAc,KAAK,OAAO,eAAA,CAAgB;AAAA,IACjJ;AAGA,QAAI,aAAa,GAAG;AAClB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,oCAAoC,aAAa,KAAK,UAAU,KAAK,OAAO,WAAA,CAAY;AAAA,IACrI;AAGA,QAAI,gBAAgB,GAAG;AACrB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,uCAAuC,aAAa,KAAK,aAAa,KAAK,OAAO,cAAA,CAAe;AAAA,IAC9I;AAGA,QAAI,aAAa,GAAG;AAClB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,oCAAoC,aAAa,KAAK,UAAU,KAAK,OAAO,WAAA,CAAY;AAAA,IACrI;AAGA,QAAI,SAAS;AACX,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,iCAAiC,OAAO,IAAI;AAAA,IACzF;AAGA,QAAI,UAAU;AACZ,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,kCAAkC,OAAO,GAAG;AAAA,IACzF;AAGA,QAAI,wBAAwB;AAC1B,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,iDAAiD,OAAO,GAAG;AAAA,IACxG;AAGA,QAAI,mBAAmB;AACrB,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,2CAA2C,OAAO,GAAG;AAAA,IAClG;AAGA,QAAI,uBAAuB,GAAG;AAC5B,YAAM,QAAQ,uBAAuB;AACrC,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,0CAA0C,aAAa,IAAI,oBAAoB,KAAK,MAAA,CAAO;AAAA,IACxI;AAGA,UAAM,eAAgB,KAAa,gBAAgB;AACnD,QAAI,gBAAgB,aAAa,YAAY;AAC3C,0BAAoB;AACpB,gCAA0B,KAAK,EAAE,UAAU,sCAAsC,OAAO,IAAI;AAAA,IAC9F;AAEC,SAAa,mBAAmB;AAChC,SAAa,4BAA4B;AAAA,EAC5C;AACF;ACn0BO,MAAM,gCAAgC,QAAQ,SAAS,cAAyB;AAAA,EACrF,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,iBAAiB,IAAI,OAAO,YAAY;AAAA,QACtC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,SAAS;AAAA,UACP,UAAU;AAAA,UACV,SAAS;AAAA,UACT,WAAW;AAAA,UACX,OAAO;AAAA,UACP,UAAU;AAAA,QAAA;AAAA,QAEZ,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,UAAU;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV;AAAA,IAAA;AAAA,EAEL;AAAA,EAES,qBAA2B;AAEjC,SAAa,iBAAiB;AAAA,EACjC;AACF;ACjCO,MAAM,0BAA0B,QAAQ,SAAS,cAAyB;AAAA,EAC/E,OAAgB,eAAoB;AAClC,UAAM,SAAS,QAAQ,KAAK;AAE5B,WAAO;AAAA,MACL,aAAa,IAAI,OAAO,UAAU;AAAA,QAChC,UAAU;AAAA,QACV,SAAS;AAAA,MAAA,CACV;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,YAAY,IAAI,OAAO,YAAY;AAAA,QACjC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,cAAc,IAAI,OAAO,YAAY;AAAA,QACnC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,UAAU,IAAI,OAAO,YAAY;AAAA,QAC/B,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,aAAa,IAAI,OAAO,YAAY;AAAA,QAClC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,MACD,cAAc,IAAI,OAAO,YAAY;AAAA,QACnC,UAAU;AAAA,QACV,SAAS;AAAA,QACT,KAAK;AAAA,QACL,KAAK;AAAA,QACL,SAAS;AAAA,QACT,OAAO;AAAA,MAAA,CACR;AAAA,IAAA;AAAA,EAEL;AAAA,EAES,qBAA2B;AAAA,EAGpC;AACF;;;;;;;;;;ACjEO,MAAM,kBAAiE,MAAe;AAAA,EAC3F,IAAI,QAAgB;AAClB,WAAO,KAAK,MAAM,OAAO,CAAC,SAAe,KAAK,SAAS,MAAM;AAAA,EAC/D;AACF;;;;;ACJO,MAAM,uBAAuB,WAAW;AAAA;AAAA,EAErC,iBAAyB;AAAA,EAEjC,WAAoB,iBAA+C;AACjE,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,SAAS,CAAC,QAAQ,SAAS,SAAS,WAAW;AAAA,MAC/C,UAAU;AAAA,MACV,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA,MACN,UAAU;AAAA,QACR,EAAE,cAAc,kBAAkB,cAAc,sBAAA;AAAA,QAChD,EAAE,cAAc,cAAc,cAAc,cAAA;AAAA,QAC5C,EAAE,cAAc,eAAe,cAAc,eAAA;AAAA,QAC7C,EAAE,cAAc,wBAAwB,cAAc,eAAA;AAAA,MAAe;AAAA,MAEvE,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH;AAAA,EAES,UAAe;AACtB,UAAM,UAAU,MAAM,QAAA;AAGtB,YAAQ,SAAS,KAAK,MAAM;AAG5B,UAAM,YAAY,KAAK,MAAM,MAAM,OAAO,CAAC,SAAc,KAAK,SAAS,UAAU;AACjF,YAAQ,WAAW,UAAU,SAAS,IAAI,UAAU,CAAC,IAAI;AAGzD,UAAM,WAAW,KAAK,MAAM,MAAM,OAAO,CAAC,SAAc,KAAK,SAAS,MAAM,EAAE,IAAI,CAAC,SAAc;AAE/F,WAAK,YAAY,CAAA;AACjB,YAAM,SAAS,KAAK,OAAO,UAAU,CAAA;AAErC,eAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,cAAM,UAAU,OAAO,CAAC;AACxB,cAAM,SAAS,QAAQ;AACvB,cAAM,UAAU,QAAQ,WAAW;AACnC,cAAM,WAAW,QAAQ,YAAY;AAErC,cAAM,QAAa,EAAE,QAAQ,SAAS,SAAA;AAEtC,YAAI,WAAW,eAAe,UAAU;AACtC,gBAAM,gBAAgB,KAAK,KAAM,SAAS,mBAAmB,SAAS,YAAA,CAAa,EAAE;AAAA,QACvF;AAEA,aAAK,UAAU,KAAK,KAAK;AAAA,MAC3B;AAEA,aAAO;AAAA,IACT,CAAC;AAGD,YAAQ,cAAc;AAAA,MACpB,OAAO,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,OAAO;AAAA,MACtE,SAAS,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,SAAS;AAAA,MAC1E,UAAU,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,UAAU;AAAA,MAC5E,YAAY,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,aAAa;AAAA,MACjF,WAAW,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,WAAW;AAAA,MAC9E,WAAW,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,WAAW;AAAA,MAC9E,WAAW,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,WAAW;AAAA,MAC9E,SAAS,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,SAAS;AAAA,MAC1E,eAAe,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,gBAAgB;AAAA,MACvF,QAAQ,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,QAAQ;AAAA,MACxE,OAAO,SAAS,OAAO,CAAC,SAAc,KAAK,OAAO,aAAa,OAAO;AAAA,IAAA;AAIxE,YAAQ,QAAQ;AAGhB,UAAM,SAAS,KAAK,MAAM,MAAM,OAAO,CAAC,SAAc,KAAK,SAAS,OAAO;AAG3E,UAAM,qBAAqB,KAAK,MAAM,MAAM,OAAO,CAAC,SAAc,KAAK,SAAS,gBAAgB;AAGhG,UAAM,6CAA6B,IAAA;AACnC,UAAM,0BAAiC,CAAA;AAEvC,uBAAmB,QAAQ,CAAC,SAAc;AACxC,YAAM,kBAAkB,KAAK,OAAO;AACpC,UAAI,iBAAiB;AAEnB,cAAM,cAAc,KAAK,MAAM,MAAM;AAAA,UAAK,CAAC,MACzC,EAAE,SAAS,WAAW,EAAE,SAAS;AAAA,QAAA;AAGnC,YAAI,eAAe,YAAY,IAAI;AAEjC,gBAAM,UAAU,YAAY;AAC5B,cAAI,CAAC,uBAAuB,IAAI,OAAO,GAAG;AACxC,mCAAuB,IAAI,SAAS,EAAE;AAAA,UACxC;AACA,iCAAuB,IAAI,OAAO,EAAG,KAAK,IAAI;AAAA,QAChD,OAAO;AAEL,kCAAwB,KAAK,IAAI;AAAA,QACnC;AAAA,MACF,OAAO;AAEL,gCAAwB,KAAK,IAAI;AAAA,MACnC;AAAA,IACF,CAAC;AAGD,UAAM,eAAe;AAAA,MACnB,UAAU,KAAK,IAAI,GAAG,KAAK,YAAY,aAAa,UAAU,CAAC;AAAA,MAC/D,SAAS,KAAK,IAAI,GAAG,KAAK,YAAY,aAAa,SAAS,CAAC;AAAA,MAC7D,WAAW,KAAK,IAAI,GAAG,KAAK,YAAY,aAAa,WAAW,CAAC;AAAA,MACjE,OAAO,KAAK,IAAI,GAAG,KAAK,YAAY,aAAa,OAAO,CAAC;AAAA,MACzD,UAAU,KAAK,IAAI,GAAG,KAAK,YAAY,aAAa,UAAU,CAAC;AAAA,IAAA;AAIjE,YAAQ,SAAS,OAAO,IAAI,CAAC,UAAe;AAE1C,YAAM,kBAAkB,MAAM,QAAQ,mBAAmB;AACzD,YAAM,uBAAuB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAGnG,YAAM,UAAU,KAAK,YAAY,SAAS,MAAM,IAAI;AACpD,YAAM,cAAe,aAAqB,eAAe,KAAK;AAC9D,YAAM,KAAK,KAAK,IAAI,GAAG,UAAU,WAAW;AAG5C,YAAM,iBAAkB,KAAK,MAAM,OAAe,WAAW,eAAe,KAAK;AACjF,YAAM,cAAc,MAAM,QAAQ,UAAU;AAC5C,YAAM,gBAAgB,iBAAiB;AAGvC,YAAM,QAAQ,uBAAuB,IAAI,MAAM,EAAE,KAAK,CAAA;AACtD,YAAM,kBAAkB,MAAM,IAAI,CAAC,SAAc;AAC/C,cAAM,eAAe,MAAM,QAAQ,UAAU;AAE7C,aAAK,eAAe;AACpB,aAAK,kBAAkB,eAAe;AACtC,aAAK,kBAAkB,MAAM;AAG7B,cAAM,sBAAsB,KAAK,QAAQ,mBAAmB;AAC5D,aAAK,uBAAuB,KAAK,KAAM,SAAS,mBAAmB,oBAAoB,YAAA,CAAa,EAAE;AAGtG,cAAM,SAAS,KAAK,YAAY,kBAAkB,KAAK,IAAI;AAC3D,cAAM,kBAAmB,aAAqB,mBAAmB,KAAK;AACtE,cAAM,gBAAgB;AACtB,aAAK,KAAK,KAAK,IAAI,GAAG,kBAAkB,gBAAgB,MAAM;AAG9D,cAAM,qBAAsB,KAAK,MAAM,OAAe,WAAW,mBAAmB,KAAK;AACzF,aAAK,gBAAgB,qBAAqB,KAAK;AAE/C,eAAO;AAAA,MACT,CAAC;AACD,aAAO;AAAA,IACT,CAAC;AAGD,YAAQ,0BAA0B,wBAAwB,IAAI,CAAC,SAAc;AAC3E,YAAM,kBAAkB,KAAK,QAAQ,mBAAmB;AACxD,WAAK,uBAAuB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAIlG,YAAM,SAAS,KAAK,YAAY,kBAAkB,KAAK,IAAI;AAC3D,YAAM,cAAe,aAAqB,eAAe,KAAK;AAC9D,WAAK,KAAK,KAAK,IAAI,GAAG,SAAS,WAAW;AAG1C,YAAM,iBAAkB,KAAK,MAAM,OAAe,WAAW,eAAe,KAAK;AACjF,WAAK,gBAAgB;AAErB,aAAO;AAAA,IACT,CAAC;AAGD,YAAQ,eAAe;AAGvB,YAAQ,gBAAgB,KAAK;AAE7B,WAAO;AAAA,EACT;AAAA,EAEA,MAAe,MAAM,SAAmD;AAEtE,MAAE,QAAQ,EAAE,IAAI,oBAAoB;AACpC,MAAE,QAAQ,EAAE,IAAI,mBAAmB;AACnC,WAAO,MAAM,MAAM,OAAO;AAAA,EAC5B;AAAA,EAES,kBAAkB,MAAoB;AAC7C,UAAM,kBAAkB,IAAI;AAG5B,SAAK,KAAK,wBAAwB,EAAE,GAAG,SAAS,KAAK,qBAAqB,KAAK,IAAI,CAAC;AAGpF,SAAK,KAAK,+BAA+B,EAAE,GAAG,SAAS,KAAK,gBAAgB,KAAK,IAAI,CAAC;AAGtF,SAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAG1F,SAAK,KAAK,2BAA2B,EAAE,GAAG,SAAS,KAAK,YAAY,KAAK,IAAI,CAAC;AAG9E,SAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AAGlF,SAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC;AAGhF,SAAK,KAAK,8BAA8B,EAAE,GAAG,SAAS,KAAK,eAAe,KAAK,IAAI,CAAC;AAGpF,SAAK,KAAK,qCAAqC,EAAE,GAAG,SAAS,KAAK,sBAAsB,KAAK,IAAI,CAAC;AAGlG,SAAK,KAAK,uCAAuC,EAAE,GAAG,SAAS,KAAK,wBAAwB,KAAK,IAAI,CAAC;AAGtG,SAAK,KAAK,gCAAgC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC;AAGxF,SAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC;AAGhF,SAAK,KAAK,kCAAkC,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAG3F,SAAK,KAAK,qCAAqC,EAAE,GAAG,SAAS,KAAK,sBAAsB,KAAK,IAAI,CAAC;AAGlG,SAAK,KAAK,2CAA2C,EAAE,GAAG,SAAS,KAAK,2BAA2B,KAAK,IAAI,CAAC;AAG7G,SAAK,KAAK,kCAAkC,EAAE,GAAG,SAAS,KAAK,mBAAmB,KAAK,IAAI,CAAC;AAG5F,SAAK,KAAK,6BAA6B,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AAGlF,SAAK,KAAK,4BAA4B,EAAE,GAAG,SAAS,KAAK,aAAa,KAAK,IAAI,CAAC;AAGhF,SAAK,KAAK,mCAAmC,EAAE,GAAG,SAAS,KAAK,mBAAmB,KAAK,IAAI,CAAC;AAG7F,SAAK,KAAK,eAAe,EAAE,GAAG,UAAU,KAAK,gBAAgB,KAAK,IAAI,CAAC;AAGvE,SAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,KAAK,eAAe,KAAK,IAAI,CAAC;AAC3E,SAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,KAAK,oBAAoB,KAAK,IAAI,CAAC;AAChF,SAAK,KAAK,qBAAqB,EAAE,GAAG,QAAQ,KAAK,mBAAmB,KAAK,IAAI,CAAC;AAG9E,MAAE,QAAQ,EAAE,GAAG,sBAAsB,CAAC,UAAU;AAC9C,YAAM,SAAS,MAAM;AACrB,YAAM,uBAAuB,KAAK,KAAK,yBAAyB,EAAE,CAAC;AACnE,UAAI,wBAAwB,CAAC,qBAAqB,SAAS,MAAM,GAAG;AAClE,aAAK,KAAK,uBAAuB,EAAE,KAAA;AAAA,MACrC;AAAA,IACF,CAAC;AAGD,SAAK,KAAK,oBAAoB,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AACzE,SAAK,KAAK,oBAAoB,EAAE,GAAG,SAAS,KAAK,mBAAmB,KAAK,IAAI,CAAC;AAC9E,SAAK,KAAK,oBAAoB,EAAE,GAAG,QAAQ,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAG5E,MAAE,QAAQ,EAAE,GAAG,qBAAqB,CAAC,UAAU;AAC7C,YAAM,SAAS,MAAM;AACrB,YAAM,sBAAsB,KAAK,KAAK,wBAAwB,EAAE,CAAC;AACjE,UAAI,uBAAuB,CAAC,oBAAoB,SAAS,MAAM,GAAG;AAChE,aAAK,KAAK,sBAAsB,EAAE,KAAA;AAAA,MACpC;AAAA,IACF,CAAC;AAGD,SAAK,KAAK,YAAY,EAAE,KAAK,CAAC,QAAQ,SAAS;AAC7C,WAAK,aAAa,aAAa,MAAM;AACrC,WAAK,iBAAiB,aAAa,KAAK,aAAa,KAAK,IAAI,CAAC;AAAA,IACjE,CAAC;AAGD,SAAK,KAAK,aAAa,EAAE,KAAK,CAAC,QAAQ,SAAS;AAC9C,WAAK,aAAa,aAAa,MAAM;AACrC,WAAK,iBAAiB,aAAa,KAAK,aAAa,KAAK,IAAI,CAAC;AAAA,IACjE,CAAC;AAGD,SAAK,KAAK,sBAAsB,EAAE,KAAK,CAAC,QAAQ,SAAS;AACvD,WAAK,aAAa,aAAa,MAAM;AACrC,WAAK,iBAAiB,aAAa,KAAK,aAAa,KAAK,IAAI,CAAC;AAAA,IACjE,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAyB,cAAc,QAAe,UAA6B;AAEjF,UAAM,YAAiB,CAAA;AACvB,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,QAAQ,GAAG;AACnD,UAAI,CAAC,IAAI,WAAW,QAAQ,GAAG;AAC7B,kBAAU,GAAG,IAAI;AAAA,MACnB;AAAA,IACF;AAGA,UAAM,eAAe,QAAQ,MAAM,aAAa,SAAS;AAGzD,WAAO,KAAK,MAAM,OAAO,YAAY;AAAA,EACvC;AAAA;AAAA;AAAA;AAAA,EAKQ,qBAAqB,OAAoB;AAC/C,UAAM,eAAA;AACN,UAAM,SAAS,MAAM;AACrB,UAAM,UAAU,OAAO,QAAQ;AAE/B,QAAI,CAAC,QAAS;AAGd,SAAK,iBAAiB;AAGtB,UAAM,OAAO,EAAE,KAAK,IAAI;AACxB,SAAK,KAAK,wBAAwB,EAAE,YAAY,QAAQ;AACxD,WAAO,UAAU,IAAI,QAAQ;AAE7B,SAAK,KAAK,kBAAkB,EAAE,YAAY,QAAQ;AAClD,SAAK,KAAK,0BAA0B,OAAO,IAAI,EAAE,SAAS,QAAQ;AAAA,EACpE;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,gBAAgB,OAA6B;AACzD,UAAM,eAAA;AACN,UAAM,aAAc,MAAM,cAA8B,QAAQ,gBAAgB,GAAG,aAAa,cAAc;AAC9G,QAAI,YAAY;AACd,YAAM,WAAW,KAAK,MAAM,MAAM,IAAI,UAAU;AAChD,UAAI,UAAU;AACZ,iBAAS,OAAO,OAAO,IAAI;AAAA,MAC7B;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,kBAAkB,OAA6B;AAC3D,UAAM,eAAA;AACN,UAAM,aAAc,MAAM,cAA8B,QAAQ,gBAAgB,GAAG,aAAa,cAAc;AAC9G,QAAI,YAAY;AACd,YAAM,WAAW,KAAK,MAAM,MAAM,IAAI,UAAU;AAChD,UAAI,UAAU;AACZ,cAAM,SAAS,OAAA;AACf,aAAK,OAAO,KAAK;AAAA,MACnB;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,YAAY,OAA6B;AACrD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,MAAM;AACR,WAAK,OAAO,OAAO,IAAI;AAAA,IACzB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,cAAc,OAA6B;AACvD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,MAAM;AACR,YAAM,KAAK,OAAA;AAAA,IACb;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,aAAa,OAA6B;AACtD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,QAAQ,KAAK,MAAM,MAAM,IAAI,MAAM;AACzC,QAAI,OAAO;AACT,YAAM,OAAO,OAAO,IAAI;AAAA,IAC1B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,eAAe,OAA6B;AACxD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,MAAM;AACR,YAAM,KAAK,OAAA;AAAA,IACb;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,sBAAsB,OAA6B;AAC/D,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,iBAAiB,KAAK,MAAM,MAAM,IAAI,MAAM;AAClD,QAAI,gBAAgB;AAClB,qBAAe,OAAO,OAAO,IAAI;AAAA,IACnC;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,wBAAwB,OAA6B;AACjE,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,OAAQ;AAEb,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,MAAM;AACR,YAAM,KAAK,OAAA;AAAA,IACb;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,aAAa,UAAoD,UAA8D;AACrI,UAAM,UAAsD,CAAA;AAG5D,UAAM,QAAQ,KAAK,MAAM,MAAM;AAAA,MAAO,CAAC,SACrC,KAAK,SAAS,UACd,KAAK,OAAO,WAAW;AAAA,IAAA;AAIzB,eAAW,QAAQ,OAAO;AACxB,YAAM,aAAa,KAAK;AACxB,YAAM,SAAS,WAAW,UAAU,CAAA;AAGpC,iBAAW,WAAW,QAAQ;AAC5B,cAAM,SAAS,QAAQ;AACvB,cAAM,UAAU,QAAQ,WAAW;AACnC,cAAM,WAAW,QAAQ,YAAY;AAGrC,YAAI,WAAW,YAAY,aAAa,YAAY,UAAU,GAAG;AAC/D,kBAAQ,KAAK;AAAA,YACX,UAAU,KAAK;AAAA,YACf;AAAA,UAAA,CACD;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKQ,YAAY,UAAoD,UAA0B;AAChG,UAAM,UAAU,KAAK,aAAa,UAAU,QAAQ;AACpD,WAAO,QAAQ,OAAO,CAAC,OAAO,WAAW,QAAQ,OAAO,SAAS,CAAC;AAAA,EACpE;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,gBAAgB,OAA6B;AACzD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAC/B,UAAM,YAAY,SAAS,QAAQ,KAAK;AAExC,QAAI,CAAC,UAAU,MAAM,SAAS,EAAG;AAEjC,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,MAAM;AACR,YAAM,KAAK,OAAO,EAAE,QAAQ,EAAE,QAAQ,UAAA,GAAoB;AAAA,IAC5D;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,sBAAsB,OAA6B;AAC/D,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAC/B,UAAM,kBAAkB,SAAS,QAAQ,QAAQ,mBAAmB,GAAG;AAEvE,QAAI,CAAC,QAAQ;AACX,cAAQ,MAAM,mCAAmC;AACjD;AAAA,IACF;AAEA,UAAM,iBAAiB,KAAK,MAAM,MAAM,IAAI,MAAM;AAClD,QAAI,CAAC,kBAAkB,eAAe,SAAS,iBAAkB;AAEjE,UAAM,aAAa,eAAe;AAClC,UAAM,kBAAkB,WAAW,mBAAmB;AAGtD,UAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,eAAe,KAAK;AACnF,UAAM,WAAW,kBAAkB;AAEnC,QAAI,YAAY,GAAG;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAC1E;AAAA,IACF;AAGA,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAG7F,UAAM,gBAAgB,KAAK,aAAa,kBAAkB,eAAe,IAAI;AAC7E,UAAM,qBAAqB,KAAK,aAAa,aAAa,eAAe;AACzE,UAAM,kBAAkB,WAAW;AACnC,UAAM,iBAAiB,kBAAkB,KAAK,aAAa,SAAS,eAAe,IAAI,CAAA;AAEvF,UAAM,eAAe;AAAA,MACnB,GAAG;AAAA,MACH,GAAG,eAAe,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,eAAe,MAAM;AAAA,MACrF,GAAG,mBAAmB,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,cAAc,MAAM;AAAA,IAAA;AAE1F,UAAM,SAAS,KAAK,IAAI,GAAG,aAAa,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAClF,UAAM,kBAAkB,KAAK,IAAI,UAAU,KAAK,gBAAgB,MAAM,CAAC;AAGvE,QAAI,gBAAgB;AACpB,QAAI,aAAa,SAAS,GAAG;AAC3B,sBAAgB;AAChB,mBAAa,QAAQ,CAAC,WAAW;AAC/B,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,mCAAmC,EAAE,MAAM,eAAe,MAAM;AAAA,MACzF,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,uBAAuB,CAAC,aAAa,QAAQ;AAAA,gCACtD,KAAK,KAAM,SAAS,4BAA4B,CAAC,KAAK,eAAe,MAAM,cAAc,KAAK,cAAc;AAAA;AAAA;AAAA,qBAGvH,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,SAAA;AAAA,QAAW,CAAC,GAAG,MACnC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkFhC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AACjE,iBAAK,eAAe,eAAe,MAAM,YAAY,UAAU,eAAe,QAAQ;AAAA,UACxF;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,kBAAkB,OAA6B;AAE3D,WAAO,KAAK,aAAa,KAAK;AAAA,EAChC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,2BAA2B,OAA6B;AAEpE,WAAO,KAAK,sBAAsB,KAAK;AAAA,EACzC;AAAA;AAAA;AAAA;AAAA,EAKQ,gBAAgB,IAAoB;AAC1C,UAAM,eAAe,CAAC,GAAG,GAAG,GAAG,EAAE;AACjC,WAAO,aAAa,KAAK,IAAI,GAAG,KAAK,IAAI,GAAG,EAAE,CAAC,CAAC,KAAK;AAAA,EACvD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,iBAAiB,OAA6B;AAC1D,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,gBAAgB,QAAQ,QAAQ;AAEtC,QAAI,CAAC,cAAe;AAEpB,UAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,aAAa,KAAK;AAEjF,QAAI,kBAAkB,GAAG;AACvB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,yBAAyB,CAAC;AACrE;AAAA,IACF;AAGA,UAAM,YAAY,KAAK,aAAa,aAAa,aAAa;AAC9D,UAAM,SAAS,KAAK,IAAI,GAAG,UAAU,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAC/E,UAAM,kBAAkB,KAAK,IAAI,gBAAgB,KAAK,gBAAgB,MAAM,CAAC;AAG7E,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,cAAc,YAAA,CAAa,EAAE;AAG3F,QAAI,gBAAgB;AACpB,QAAI,UAAU,SAAS,GAAG;AACxB,sBAAgB;AAChB,gBAAU,QAAQ,CAAC,QAAQ,UAAU;AACnC,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,8BAA8B,EAAE,MAAM,gBAAgB;AAAA,MAC/E,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,2BAA2B,CAAC,aAAa,cAAc;AAAA;AAAA;AAAA,qBAG3E,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,eAAA;AAAA,QAAiB,CAAC,GAAG,MACzC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,cAAc;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkFtC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AACjE,iBAAK,eAAe,gBAAgB,YAAY,UAAU,eAAe,QAAQ;AAAA,UACnF;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,aAAa,OAA6B;AACtD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,QAAQ;AACX,cAAQ,MAAM,yBAAyB;AACvC;AAAA,IACF;AAEA,UAAM,QAAQ,KAAK,MAAM,MAAM,IAAI,MAAM;AACzC,QAAI,CAAC,SAAS,MAAM,SAAS,QAAS;AAEtC,UAAM,cAAc,MAAM;AAC1B,UAAM,SAAS,YAAY,UAAU;AACrC,UAAM,kBAAkB,YAAY,mBAAmB;AAGvD,UAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,eAAe,KAAK;AACnF,UAAM,WAAW,SAAS;AAE1B,QAAI,YAAY,GAAG;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,qBAAqB,CAAC;AACjE;AAAA,IACF;AAGA,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAG7F,UAAM,iBAAiB,KAAK,aAAa,SAAS,MAAM,IAAI;AAC5D,UAAM,qBAAqB,KAAK,aAAa,aAAa,eAAe;AACzE,UAAM,eAAe,CAAC,GAAG,gBAAgB,GAAG,mBAAmB,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,cAAc,IAAA,EAAM,CAAC;AAClI,UAAM,SAAS,KAAK,IAAI,GAAG,aAAa,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAClF,UAAM,kBAAkB,KAAK,IAAI,UAAU,KAAK,gBAAgB,MAAM,CAAC;AAGvE,QAAI,gBAAgB;AACpB,QAAI,aAAa,SAAS,GAAG;AAC3B,sBAAgB;AAChB,mBAAa,QAAQ,CAAC,WAAW;AAC/B,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,0BAA0B,EAAE,MAAM,MAAM,MAAM;AAAA,MACvE,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,uBAAuB,CAAC,aAAa,QAAQ;AAAA,gCACtD,KAAK,KAAM,SAAS,oBAAoB,CAAC,KAAK,MAAM,MAAM,cAAc,KAAK,cAAc;AAAA;AAAA;AAAA,qBAGtG,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,SAAA;AAAA,QAAW,CAAC,GAAG,MACnC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkFhC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AACjE,iBAAK,eAAe,MAAM,MAAM,YAAY,UAAU,eAAe,QAAQ;AAAA,UAC/E;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAMA,MAAc,eAAe,WAAmB,UAAkB,WAAmB,GAAG,gBAAwB,GAAG,WAAmB,UAAU,mBAA2C;AACzL,QAAI,kBAAkB;AACtB,QAAI,gBAAgB;AACpB,QAAI,mBAAmB;AACvB,QAAI,oBAAoB;AACxB,QAAI,kBAAkB;AAGtB,UAAM,sBAAsB,CAAC,SAAyB;AACpD,cAAQ,MAAA;AAAA,QACN,KAAK;AAAa,iBAAO;AAAA;AAAA,QACzB,KAAK;AAAgB,iBAAO;AAAA;AAAA,QAC5B;AAAS,iBAAO;AAAA,MAAA;AAAA,IAEpB;AAEA,UAAM,mBAAmB,oBAAoB,QAAQ;AAGrD,QAAI,aAA0B;AAC9B,QAAI,WAAW,GAAG;AAChB,mBAAa,IAAI,KAAK,GAAG,QAAQ,IAAI;AACrC,YAAM,WAAW,SAAA;AAEjB,YAAM,gBAAgB,WAAW,KAAK,CAAC,GAAG,WAAW,CAAA;AACrD,wBAAkB,cAAc,OAAO,CAAC,MAAW,EAAE,UAAU,gBAAgB,EAAE;AAEjF,0BAAoB,cAAc,IAAI,CAAC,MAAW;AAChD,cAAM,YAAY,EAAE,UAAU;AAC9B,eAAO,2BAA2B,YAAY,YAAY,SAAS,KAAK,EAAE,MAAM;AAAA,MAClF,CAAC,EAAE,KAAK,GAAG;AAAA,IACb;AAGA,QAAI,WAAwB;AAC5B,QAAI,WAAW,GAAG;AAChB,iBAAW,IAAI,KAAK,GAAG,QAAQ,IAAI;AACnC,YAAM,SAAS,SAAA;AAEf,YAAM,cAAc,SAAS,KAAK,CAAC,GAAG,WAAW,CAAA;AAGjD,kBAAY,QAAQ,CAAC,MAAW;AAC9B,YAAI,EAAE,UAAU,kBAAkB;AAChC,2BAAiB;AAAA,QACnB,WAAW,EAAE,WAAW,GAAG;AACzB;AAAA,QACF;AAAA,MACF,CAAC;AAED,wBAAkB,YAAY,IAAI,CAAC,MAAW;AAC5C,YAAI,WAAW;AACf,YAAI,EAAE,UAAU,kBAAkB;AAChC,sBAAY;AAAA,QACd,WAAW,EAAE,WAAW,GAAG;AACzB,sBAAY;AAAA,QACd,OAAO;AACL,sBAAY;AAAA,QACd;AACA,eAAO,gBAAgB,QAAQ,KAAK,EAAE,MAAM;AAAA,MAC9C,CAAC,EAAE,KAAK,GAAG;AAAA,IACb;AAGA,QAAK,KAAa,QAAQ;AACxB,YAAM,SAAU,KAAa;AAC7B,YAAM,WAA2B,CAAA;AAGjC,UAAI,YAAY;AACd,iBAAS;AAAA,UACP,OAAO,YAAY,YAAY,KAAK,MAAM,MAAM,MAAM,OAAO,MAAM,MAAM;AAAA,YACvE,UAAU;AAAA;AAAA,UAAA,CACX,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAAA,QAAA;AAAA,MAErB;AAGA,UAAI,UAAU;AAEZ,cAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AACrD,iBAAS;AAAA,UACP,OAAO,YAAY,UAAU,KAAK,MAAM,MAAM,MAAM,OAAO,MAAM,MAAM;AAAA,YACrE,UAAU;AAAA;AAAA,UAAA,CACX,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAAA,QAAA;AAAA,MAErB;AAGA,YAAM,QAAQ,IAAI,QAAQ;AAAA,IAC5B;AAGA,UAAM,sBAAsB;AAC5B,uBAAmB,KAAK,IAAI,GAAG,mBAAmB,aAAa;AAE/D,UAAM,iBAAiB,kBAAkB;AAGzC,QAAI,cAAc;AAGlB,UAAM,YAAY,WAAW;AAC7B,mBAAe;AACf,mBAAe,WAAW,KAAK,KAAM,SAAS,uBAAuB,CAAC;AACtE,mBAAe,GAAG,SAAS;AAC3B,QAAI,WAAW,GAAG;AAChB,qBAAe,KAAK,QAAQ,IAAI,KAAK,KAAM,SAAS,oBAAoB,CAAC,+BAA+B,QAAQ,IAAI,KAAK,KAAM,SAAS,kBAAkB,CAAC;AAC3J,UAAI,gBAAgB,GAAG;AACrB,uBAAe,gCAAgC,aAAa;AAAA,MAC9D;AACA,qBAAe;AAAA,IACjB,WAAW,gBAAgB,GAAG;AAC5B,qBAAe,gCAAgC,aAAa;AAAA,IAC9D;AAGA,QAAI,aAAa,UAAU;AACzB,YAAM,UAAU,aAAa,cAAc,wBAAwB;AACnE,qBAAe,+BAA+B,KAAK,KAAM,SAAS,eAAe,OAAO,EAAE,CAAC;AAAA,IAC7F;AAEA,mBAAe;AAGf,QAAI,mBAAmB;AACrB,qBAAe;AACf,qBAAe,WAAW,KAAK,KAAM,SAAS,yBAAyB,CAAC,cAAc,iBAAiB;AACvG,qBAAe;AAAA,IACjB;AAGA,QAAI,iBAAiB;AACnB,qBAAe;AACf,qBAAe,WAAW,KAAK,KAAM,SAAS,uBAAuB,CAAC,cAAc,eAAe;AACnG,qBAAe;AAAA,IACjB;AAGA,mBAAe,yBAAyB,iBAAiB,IAAI,gBAAgB,YAAY;AACzF,mBAAe,WAAW,KAAK,KAAM,SAAS,6BAA6B,CAAC,cAAc,cAAc;AAGxG,QAAI,qBAAqB,sBAAsB,KAAK;AAClD,YAAM,WAAY,KAAK,MAAM,OAAe,YAAY,YAAY;AACpE,UAAI,SAAS;AAIb,UAAI,sBAAsB,OAAO;AAC/B,iBAAS;AAAA,MAEX,WAAW,kBAAkB,WAAW,MAAM,GAAG;AAC/C,cAAM,WAAW,SAAS,kBAAkB,UAAU,CAAC,CAAC,KAAK;AAC7D,iBAAS,WAAW;AAAA,MAEtB,WAAW,sBAAsB,SAAS;AAExC,iBAAS;AAAA,MACX,OAAO;AACL,iBAAS,SAAS,iBAAiB,KAAK;AAAA,MAC1C;AAEA,UAAI,UAAU,GAAG;AACf,cAAM,UAAU,iBAAiB;AACjC,uBAAe;AACf,uBAAe,WAAW,KAAK,KAAM,SAAS,sCAAsC,CAAC;AACrF,uBAAe;AACf,uBAAe,6BAA6B,cAAc,MAAM,MAAM;AACtE,uBAAe,6BAA6B,OAAO;AACnD,uBAAe;AAAA,MACjB;AAAA,IACF;AAEA,mBAAe;AAGf,QAAI,sBAAsB,KAAK,gBAAgB,GAAG;AAChD,UAAI,gBAAgB;AACpB,UAAI,gBAAgB;AAEpB,UAAI,oBAAoB,GAAG;AACzB,wBAAgB,KAAK,KAAM,SAAS,sBAAsB;AAC1D,wBAAgB;AAAA,MAClB,WAAW,qBAAqB,GAAG;AACjC,wBAAgB,KAAK,KAAM,SAAS,mCAAmC;AACvE,wBAAgB;AAAA,MAClB,WAAW,qBAAqB,GAAG;AACjC,wBAAgB,KAAK,KAAM,SAAS,gCAAgC;AACpE,wBAAgB;AAAA,MAClB,OAAO;AACL,wBAAgB,KAAK,KAAM,SAAS,6BAA6B;AACjE,wBAAgB;AAAA,MAClB;AAEA,qBAAe,iCAAiC,aAAa;AAC7D,qBAAe;AACf,qBAAe;AACf,qBAAe,mCAAmC,aAAa;AAC/D,qBAAe;AAEf,UAAI,gBAAgB,GAAG;AACrB,uBAAe,kDAAkD,mBAAmB,MAAM,aAAa,SAAS,gBAAgB;AAAA,MAClI;AAEA,qBAAe;AAAA,IACjB;AAEA,mBAAe;AAGf,UAAM,cAAc;AAAA,MAClB,SAAS,YAAY,WAAW,EAAE,OAAO,KAAK,OAAO;AAAA,MACrD,QAAQ,KAAK,KAAM,OAAO,2BAA2B,EAAE,MAAM,WAAW;AAAA,MACxE,SAAS;AAAA,MACT,OAAO,OAAO,QAAQ;AAAA,IAAA;AAGxB,UAAM,YAAY,OAAO,WAAW;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,uBAAuB,WAAmB,UAAkB,WAAmB,GAAG,gBAAwB,GAAG,WAAmB,UAAU,mBAA2C;AAEjM,UAAM,eAAe,MAAM,KAAK,iBAAiB,UAAU,UAAU,eAAe,QAAQ;AAG5F,UAAM,UAAU,MAAM,KAAM,KAAa,MAAM,WAAW,EAAE;AAE5D,QAAI,QAAQ,WAAW,KAAK,CAAC,qBAAqB,sBAAsB,KAAK;AAE3E,YAAM,KAAK,mBAAmB,WAAW,cAAc,iBAAiB;AACxE;AAAA,IACF;AAGA,UAAM,SAAS,QAAQ,CAAC;AACxB,UAAM,cAAc,OAAO;AAE3B,QAAI,CAAC,aAAa;AAEhB,YAAM,KAAK,mBAAmB,WAAW,cAAc,iBAAiB;AACxE;AAAA,IACF;AAGA,OAAG,eAAe,KAAK,KAAK,KAAM,OAAO,mCAAmC;AAAA,MAC1E,UAAU,KAAK,MAAM;AAAA,MACrB,UAAU,YAAY;AAAA,MACtB,WAAW,aAAa;AAAA,IAAA,CACzB,CAAC;AAGF,UAAM,KAAK,mBAAmB,aAAa,cAAc,WAAW,iBAAiB;AAAA,EACvF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,eAAoB,cAAmB,YAAoB,mBAA0C;AAEpI,UAAM,SAAS,cAAc,MAAM,OAAO,CAAC,MAAW,EAAE,SAAS,OAAO;AACxE,UAAM,qBAAqB,cAAc,MAAM,OAAO,CAAC,MAAW,EAAE,SAAS,gBAAgB;AAG7F,QAAI,mBAAmB,yBAAyB,KAAK,KAAM,SAAS,kCAAkC,IAAI;AAC1G,WAAO,QAAQ,CAAC,UAAe;AAC7B,YAAM,cAAc,MAAM;AAC1B,YAAM,kBAAkB,YAAY,mBAAmB;AACvD,YAAM,iBAAkB,cAAc,OAAe,aAAa,eAAe,KAAK;AACtF,YAAM,cAAc,YAAY,UAAU;AAC1C,YAAM,gBAAgB,iBAAiB;AAEvC,0BAAoB,wBAAwB,MAAM,EAAE,qBAAqB,aAAa,KAAK,MAAM,IAAI,KAAK,aAAa;AAGvH,YAAM,QAAQ,mBAAmB,OAAO,CAAC,SAAc;AACrD,cAAM,kBAAkB,KAAK,OAAO;AACpC,eAAO,oBAAoB,MAAM;AAAA,MACnC,CAAC;AAED,YAAM,QAAQ,CAAC,SAAc;AAC3B,cAAM,aAAa,KAAK;AACxB,cAAM,sBAAsB,WAAW,mBAAmB;AAC1D,cAAM,qBAAsB,cAAc,OAAe,aAAa,mBAAmB,KAAK;AAC9F,cAAM,eAAe;AACrB,cAAM,kBAAkB,eAAe;AACvC,cAAM,oBAAoB,qBAAqB;AAE/C,4BAAoB,uBAAuB,KAAK,EAAE,qBAAqB,iBAAiB,4BAA4B,eAAe,SAAS,KAAK,IAAI,KAAK,iBAAiB;AAAA,MAC7K,CAAC;AAAA,IACH,CAAC;AAGD,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,kCAAkC;AAAA,QACzD,UAAU,KAAK,MAAM;AAAA,QACrB,UAAU,cAAc;AAAA,MAAA,CACzB;AAAA,MACD,SAAS;AAAA;AAAA;AAAA,yBAGU,KAAK,KAAM,SAAS,yBAAyB,CAAC;AAAA,iBACtD,UAAU;AAAA,yBACF,KAAK,KAAM,SAAS,8BAA8B,CAAC,cAAc,aAAa,cAAc;AAAA;AAAA;AAAA,qBAGhG,KAAK,KAAM,SAAS,kCAAkC,CAAC;AAAA;AAAA,gBAE5D,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA,MAK1B,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,oBAAoB;AAAA,UAC/C,UAAU,OAAO,SAAc;AAC7B,kBAAM,gBAAgB,KAAK,KAAK,uBAAuB,EAAE,IAAA;AACzD,gBAAI,CAAC,iBAAiB,kBAAkB,IAAI;AAC1C,iBAAG,eAAe,KAAK,KAAK,KAAM,SAAS,uCAAuC,CAAC;AAEnF,oBAAM,KAAK,qBAAqB,YAAY,cAAc,MAAM,mBAAmB,cAAc,MAAM,aAAa;AACpH;AAAA,YACF;AAEA,kBAAM,CAAC,UAAU,MAAM,IAAK,cAAyB,MAAM,GAAG;AAC9D,kBAAM,cAAc,cAAc,MAAM,IAAI,MAAM;AAElD,gBAAI,aAAa;AACf,oBAAM,KAAK,+BAA+B,aAAa,UAA8B,YAAY,cAAc,mBAAmB,aAAa;AAAA,YACjJ;AAAA,UACF;AAAA,QAAA;AAAA,QAEF,WAAW;AAAA,UACT,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,wBAAwB;AAAA,UACnD,UAAU,YAAY;AAEpB,kBAAM,KAAK,qBAAqB,YAAY,cAAc,MAAM,mBAAmB,cAAc,MAAM,aAAa;AAAA,UACtH;AAAA,QAAA;AAAA,MACF;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,+BAA+B,aAAkB,UAA4B,YAAoB,cAAmB,mBAA2B,eAAmC;AAC9L,UAAM,gBAAgB,YAAY;AAClC,UAAM,kBAAkB,cAAc,mBAAmB;AACzD,UAAM,iBAAkB,cAAc,OAAe,aAAa,eAAe,KAAK;AAEtF,QAAI,SAAS;AACb,QAAI,cAAc,YAAY;AAE9B,QAAI,aAAa,SAAS;AACxB,eAAS,cAAc,UAAU;AAAA,IACnC,OAAO;AAEL,YAAM,kBAAkB,cAAc;AACtC,YAAM,cAAc,cAAc,MAAM,KAAK,CAAC,MAAW,EAAE,SAAS,WAAW,EAAE,SAAS,eAAe;AACzG,YAAM,eAAe,cAAe,YAAY,OAAO,UAAU,IAAK;AACtE,eAAS,eAAe;AAAA,IAC1B;AAEA,UAAM,WAAW,SAAS;AAE1B,QAAI,YAAY,GAAG;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,qBAAqB,CAAC;AAEjE,YAAM,KAAK,qBAAqB,YAAY,cAAc,MAAM,mBAAmB,cAAc,MAAM,aAAa;AACpH;AAAA,IACF;AAGA,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAC7F,UAAM,iBAAiB,aAAa,UAAU,KAAK,sBAAsB,eAAe,SAAS,YAAY,IAAI,IAAI,KAAK,sBAAsB,eAAe,kBAAkB,YAAY,IAAI;AACjM,UAAM,qBAAqB,KAAK,sBAAsB,eAAe,aAAa,eAAe;AACjG,UAAM,eAAe,CAAC,GAAG,gBAAgB,GAAG,mBAAmB,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,cAAc,IAAA,EAAM,CAAC;AAClI,UAAM,SAAS,KAAK,IAAI,GAAG,aAAa,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAClF,UAAM,kBAAkB,KAAK,IAAI,UAAU,KAAK,gBAAgB,MAAM,CAAC;AAGvE,QAAI,gBAAgB;AACpB,QAAI,aAAa,SAAS,GAAG;AAC3B,sBAAgB;AAChB,mBAAa,QAAQ,CAAC,WAAW;AAC/B,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,mCAAmC,EAAE,OAAO,aAAa;AAAA,MAClF,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,uBAAuB,CAAC,aAAa,QAAQ;AAAA,gCACtD,KAAK,KAAM,SAAS,aAAa,UAAU,uBAAuB,4BAA4B,CAAC,KAAK,MAAM,MAAM,cAAc,KAAK,cAAc;AAAA;AAAA;AAAA,qBAG5J,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,SAAA;AAAA,QAAW,CAAC,GAAG,MACnC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MA8EhC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,oBAAoB;AAAA,UAC/C,UAAU,OAAO,SAAc;AAC7B,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AAGjE,kBAAM,gBAAgB,MAAM,KAAK,iBAAiB,YAAY,UAAU,eAAe,QAAQ;AAC/F,0BAAc,YAAY;AAG1B,kBAAM,KAAK,qBAAqB,YAAY,cAAc,eAAe,mBAAmB,cAAc,MAAM,aAAa;AAAA,UAC/H;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,iBAAiB,UAAkB,UAAkB,eAAuB,UAAgC;AACxH,QAAI,kBAAkB;AACtB,QAAI,gBAAgB;AACpB,QAAI,mBAAmB;AACvB,QAAI,oBAAoB;AACxB,QAAI,kBAAkB;AAEtB,UAAM,sBAAsB,CAAC,SAAyB;AACpD,cAAQ,MAAA;AAAA,QACN,KAAK;AAAa,iBAAO;AAAA,QACzB,KAAK;AAAgB,iBAAO;AAAA,QAC5B;AAAS,iBAAO;AAAA,MAAA;AAAA,IAEpB;AAEA,UAAM,mBAAmB,oBAAoB,QAAQ;AAGrD,QAAI,aAA0B;AAC9B,QAAI,WAAW,GAAG;AAChB,mBAAa,IAAI,KAAK,GAAG,QAAQ,IAAI;AACrC,YAAM,WAAW,SAAA;AAEjB,YAAM,gBAAgB,WAAW,KAAK,CAAC,GAAG,WAAW,CAAA;AACrD,wBAAkB,cAAc,OAAO,CAAC,MAAW,EAAE,UAAU,gBAAgB,EAAE;AAEjF,0BAAoB,cAAc,IAAI,CAAC,MAAW;AAChD,cAAM,YAAY,EAAE,UAAU;AAC9B,eAAO,2BAA2B,YAAY,YAAY,SAAS,KAAK,EAAE,MAAM;AAAA,MAClF,CAAC,EAAE,KAAK,GAAG;AAAA,IACb;AAGA,QAAI,WAAwB;AAC5B,QAAI,WAAW,GAAG;AAChB,iBAAW,IAAI,KAAK,GAAG,QAAQ,IAAI;AACnC,YAAM,SAAS,SAAA;AAEf,YAAM,cAAc,SAAS,KAAK,CAAC,GAAG,WAAW,CAAA;AAEjD,kBAAY,QAAQ,CAAC,MAAW;AAC9B,YAAI,EAAE,UAAU,kBAAkB;AAChC,2BAAiB;AAAA,QACnB,WAAW,EAAE,WAAW,GAAG;AACzB;AAAA,QACF;AAAA,MACF,CAAC;AAED,wBAAkB,YAAY,IAAI,CAAC,MAAW;AAC5C,YAAI,WAAW;AACf,YAAI,EAAE,UAAU,kBAAkB;AAChC,sBAAY;AAAA,QACd,WAAW,EAAE,WAAW,GAAG;AACzB,sBAAY;AAAA,QACd,OAAO;AACL,sBAAY;AAAA,QACd;AACA,eAAO,gBAAgB,QAAQ,KAAK,EAAE,MAAM;AAAA,MAC9C,CAAC,EAAE,KAAK,GAAG;AAAA,IACb;AAGA,QAAK,KAAa,QAAQ;AACxB,YAAM,SAAU,KAAa;AAC7B,YAAM,WAA2B,CAAA;AAEjC,UAAI,YAAY;AACd,iBAAS;AAAA,UACP,OAAO,YAAY,YAAY,KAAK,MAAM,MAAM,MAAM,OAAO,MAAM,MAAM;AAAA,YACvE,UAAU;AAAA,UAAA,CACX,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAAA,QAAA;AAAA,MAErB;AAEA,UAAI,UAAU;AACZ,cAAM,IAAI,QAAQ,CAAA,YAAW,WAAW,SAAS,GAAG,CAAC;AACrD,iBAAS;AAAA,UACP,OAAO,YAAY,UAAU,KAAK,MAAM,MAAM,MAAM,OAAO,MAAM,MAAM;AAAA,YACrE,UAAU;AAAA,UAAA,CACX,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAAA,QAAA;AAAA,MAErB;AAEA,YAAM,QAAQ,IAAI,QAAQ;AAAA,IAC5B;AAEA,UAAM,sBAAsB;AAC5B,uBAAmB,KAAK,IAAI,GAAG,mBAAmB,aAAa;AAC/D,UAAM,iBAAiB,kBAAkB;AAEzC,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA;AAAA,EAEJ;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,qBAAqB,YAAoB,cAAmB,eAA2B,mBAA2B,cAAuB,eAAoC;AACzL,UAAM,WAAY,KAAK,MAAM,OAAe,YAAY,YAAY;AACpE,QAAI,SAAS;AAIb,QAAI,sBAAsB,OAAO;AAC/B,eAAS;AAAA,IAEX,WAAW,kBAAkB,WAAW,MAAM,GAAG;AAC/C,YAAM,WAAW,SAAS,kBAAkB,UAAU,CAAC,CAAC,KAAK;AAC7D,eAAS,WAAW;AAAA,IAEtB,WAAW,sBAAsB,SAAS;AAExC,eAAS;AAAA,IACX,OAAO;AACL,eAAS,SAAS,iBAAiB,KAAK;AAAA,IAC1C;AAEA,QAAI,cAAc;AAGlB,UAAM,gBAAgB,CAAC,iBAAiB,cAAc,kBAAkB,aAAa;AAGrF,QAAI,eAAe;AACjB,qBAAe;AACf,qBAAe;AACf,qBAAe,6BAA6B,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAC7F,qBAAe;AAAA,IACjB,OAAO;AACL,qBAAe;AACf,qBAAe;AACf,qBAAe,6BAA6B,KAAK,KAAM,SAAS,2BAA2B,CAAC;AAC5F,qBAAe;AAAA,IACjB;AAGA,mBAAe;AACf,mBAAe,OAAO,KAAK,KAAM,SAAS,oBAAoB,CAAC,KAAK,UAAU;AAC9E,mBAAe,KAAK,sBAAsB,cAAc,iBAAiB;AACzE,mBAAe;AAGf,QAAI,eAAe;AACjB,qBAAe;AACf,qBAAe,OAAO,KAAK,KAAM,SAAS,qBAAqB,CAAC,KAAK,cAAc,SAAS;AAC5F,qBAAe,KAAK,sBAAsB,aAAa;AACvD,qBAAe;AAAA,IACjB;AAGA,mBAAe;AAEf,QAAI,CAAC,eAAe;AAElB,qBAAe;AACf,qBAAe,MAAM,KAAK,KAAM,OAAO,qCAAqC;AAAA,QAC1E,UAAU,gBAAgB;AAAA,QAC1B,kBAAkB,cAAe;AAAA,QACjC,iBAAiB,aAAa;AAAA,MAAA,CAC/B,CAAC;AACF,qBAAe;AAAA,IACjB,OAAO;AAEL,YAAM,mBAAmB,gBAAgB,cAAc,iBAAiB;AACxE,YAAM,eAAe,aAAa,iBAAiB;AAEnD,UAAI,UAAU,GAAG;AACf,cAAM,cAAc,SAAS;AAC7B,uBAAe;AACf,uBAAe,6BAA6B,KAAK,KAAM,SAAS,0BAA0B,CAAC,MAAM,WAAW;AAC5G,YAAI,eAAe;AACjB,yBAAe,4BAA4B,MAAM,SAAS,aAAa,cAAc,qBAAqB,gBAAgB;AAAA,QAC5H,OAAO;AACL,yBAAe,4BAA4B,aAAa,cAAc,aAAa,MAAM;AAAA,QAC3F;AAGA,YAAI,iBAAiB,cAAc;AACjC,yBAAe,sDAAsD,cAAc,EAAE,kBAAkB,WAAW,yBAAyB,YAAY,YAAY,KAAK,KAAM,OAAO,kCAAkC,EAAC,QAAQ,aAAa,UAAU,cAAa,CAAC;AACrQ,yBAAe,uCAAuC,KAAK,KAAM,SAAS,0BAA0B,CAAC;AACrG,yBAAe;AAAA,QACjB;AAEA,uBAAe;AAAA,MACjB;AAAA,IACF;AAEA,mBAAe;AACf,mBAAe;AAGf,UAAM,cAAc;AAAA,MAClB,SAAS,YAAY,WAAW,EAAE,OAAO,KAAK,OAAO;AAAA,MACrD,QAAQ,KAAK,KAAM,OAAO,2BAA2B,EAAE,MAAM,YAAY;AAAA,MACzE,SAAS;AAAA,MACT,OAAO,OAAO,QAAQ;AAAA,IAAA;AAGxB,UAAM,YAAY,OAAO,WAAW;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EAKA,aAAa,YAAY,YAAoB,aAAqB,cAAqC;AACrG,UAAM,WAAW,KAAK,QAAQ,IAAI,UAAU;AAE5C,QAAI,CAAC,UAAU;AACb,SAAG,eAAe,MAAM,yBAAyB,YAAY,EAAE;AAC/D;AAAA,IACF;AAEA,UAAM,iBAAiB,SAAS;AAChC,UAAM,mBAAmB,eAAe,kBAAkB,aAAa;AAAA,MACrE,OAAO;AAAA,MACP,UAAU;AAAA,MACV,QAAQ;AAAA,IAAA;AAIV,QAAI,SAAS;AAAA,MACX,OAAO,CAAC,GAAI,eAAe,QAAQ,SAAS,CAAA,CAAG;AAAA,MAC/C,QAAQ,CAAC,GAAI,eAAe,QAAQ,UAAU,CAAA,CAAG;AAAA,MACjD,gBAAgB,eAAe,QAAQ,kBAAkB;AAAA,IAAA;AAE3D,QAAI,aAAa;AACjB,QAAI,WAAW;AAGf,QAAI,eAAe,iBAAiB,QAAQ;AAE1C,mBAAa,KAAK,KAAM,SAAS,mCAAmC;AACpE,aAAO,iBAAiB;AAAA,IAC1B,WAAW,eAAe,iBAAiB,UAAU;AAEnD,mBAAa,KAAK,KAAM,SAAS,2BAA2B;AAG5D,UAAI,UAAU;AACd,eAAS,IAAI,GAAG,IAAI,OAAO,OAAO,QAAQ,KAAK;AAC7C,YAAI,CAAC,OAAO,OAAO,CAAC,GAAG;AACrB,iBAAO,OAAO,CAAC,IAAI;AACnB,oBAAU;AACV;AAAA,QACF;AAAA,MACF;AAGA,UAAI,CAAC,SAAS;AACZ,WAAG,eAAe,KAAK,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAChF,eAAO,iBAAiB;AACxB,mBAAW;AAAA,MACb;AAAA,IACF,WAAW,eAAe,iBAAiB,OAAO;AAEhD,mBAAa,KAAK,KAAM,SAAS,0BAA0B;AAG3D,UAAI,UAAU;AACd,eAAS,IAAI,GAAG,IAAI,OAAO,MAAM,QAAQ,KAAK;AAC5C,YAAI,CAAC,OAAO,MAAM,CAAC,GAAG;AACpB,iBAAO,MAAM,CAAC,IAAI;AAClB,oBAAU;AACV;AAAA,QACF;AAAA,MACF;AAGA,UAAI,CAAC,SAAS;AACZ,WAAG,eAAe,KAAK,KAAK,KAAM,SAAS,mCAAmC,CAAC;AAG/E,YAAI,gBAAgB;AACpB,iBAAS,IAAI,GAAG,IAAI,OAAO,OAAO,QAAQ,KAAK;AAC7C,cAAI,CAAC,OAAO,OAAO,CAAC,GAAG;AACrB,mBAAO,OAAO,CAAC,IAAI;AACnB,4BAAgB;AAChB;AAAA,UACF;AAAA,QACF;AAGA,YAAI,CAAC,eAAe;AAClB,aAAG,eAAe,KAAK,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAChF,iBAAO,iBAAiB;AAAA,QAC1B;AACA,mBAAW;AAAA,MACb;AAAA,IACF,OAAO;AAEL,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,8BAA8B;AAAA,QACrE,QAAQ,GAAG,WAAW;AAAA,QACtB,QAAQ;AAAA,MAAA,CACT,CAAC;AACF;AAAA,IACF;AAGA,UAAM,SAAS,OAAO,EAAE,iBAAiB,QAAQ;AAGjD,QAAI,OAAO,mBAAmB,MAAM;AAClC,SAAG,eAAe,MAAM,KAAK,KAAM,OAAO,iCAAiC,EAAE,QAAQ,aAAA,CAAc,CAAC;AAAA,IACtG,OAAO;AACL,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,8BAA8B;AAAA,QACrE,QAAQ,WAAW,GAAG,UAAU,mBAAmB;AAAA,QACnD,QAAQ;AAAA,MAAA,CACT,CAAC;AAAA,IACJ;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,sBAAsB,YAAiB,mBAAoC;AACjF,QAAI,OAAO;AAEX,UAAM,YAAY,WAAW,WAAW,WAAW;AACnD,YAAQ;AACR,YAAQ,WAAW,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAC/D,YAAQ,GAAG,SAAS;AACpB,QAAI,WAAW,WAAW,GAAG;AAC3B,cAAQ,KAAK,WAAW,QAAQ,IAAI,KAAK,KAAM,SAAS,oBAAoB,CAAC,+BAA+B,WAAW,QAAQ,IAAI,KAAK,KAAM,SAAS,kBAAkB,CAAC;AAC1K,UAAI,WAAW,gBAAgB,GAAG;AAChC,gBAAQ,gCAAgC,WAAW,aAAa;AAAA,MAClE;AACA,cAAQ;AAAA,IACV,WAAW,WAAW,gBAAgB,GAAG;AACvC,cAAQ,gCAAgC,WAAW,aAAa;AAAA,IAClE;AACA,YAAQ;AAGR,QAAI,WAAW,mBAAmB;AAChC,cAAQ;AACR,cAAQ,WAAW,KAAK,KAAM,SAAS,yBAAyB,CAAC,cAAc,WAAW,iBAAiB;AAC3G,cAAQ;AAAA,IACV;AAGA,QAAI,WAAW,iBAAiB;AAC9B,cAAQ;AACR,cAAQ,WAAW,KAAK,KAAM,SAAS,uBAAuB,CAAC,cAAc,WAAW,eAAe;AACvG,cAAQ;AAAA,IACV;AAGA,YAAQ,yBAAyB,WAAW,iBAAiB,IAAI,gBAAgB,YAAY;AAC7F,YAAQ,WAAW,KAAK,KAAM,SAAS,6BAA6B,CAAC,cAAc,WAAW,cAAc;AAG5G,QAAI,qBAAqB,sBAAsB,KAAK;AAClD,YAAM,WAAY,KAAK,MAAM,OAAe,YAAY,YAAY;AACpE,UAAI,SAAS;AAIb,UAAI,sBAAsB,OAAO;AAC/B,iBAAS;AAAA,MAEX,WAAW,kBAAkB,WAAW,MAAM,GAAG;AAC/C,cAAM,WAAW,SAAS,kBAAkB,UAAU,CAAC,CAAC,KAAK;AAC7D,iBAAS,WAAW;AAAA,MAEtB,WAAW,sBAAsB,SAAS;AAExC,iBAAS;AAAA,MACX,OAAO;AACL,iBAAS,SAAS,iBAAiB,KAAK;AAAA,MAC1C;AAEA,UAAI,UAAU,GAAG;AACf,cAAM,UAAU,WAAW,iBAAiB;AAC5C,gBAAQ;AACR,gBAAQ,WAAW,KAAK,KAAM,SAAS,sCAAsC,CAAC;AAC9E,gBAAQ;AACR,gBAAQ,6BAA6B,WAAW,cAAc,MAAM,MAAM;AAC1E,gBAAQ,6BAA6B,OAAO;AAC5C,gBAAQ;AAAA,MACV;AAAA,IACF;AAEA,YAAQ;AAGR,QAAI,WAAW,sBAAsB,KAAK,WAAW,gBAAgB,GAAG;AACtE,UAAI,gBAAgB;AACpB,UAAI,gBAAgB;AAEpB,UAAI,WAAW,oBAAoB,GAAG;AACpC,wBAAgB,KAAK,KAAM,SAAS,sBAAsB;AAC1D,wBAAgB;AAAA,MAClB,WAAW,WAAW,qBAAqB,GAAG;AAC5C,wBAAgB,KAAK,KAAM,SAAS,mCAAmC;AACvE,wBAAgB;AAAA,MAClB,WAAW,WAAW,qBAAqB,GAAG;AAC5C,wBAAgB,KAAK,KAAM,SAAS,gCAAgC;AACpE,wBAAgB;AAAA,MAClB,OAAO;AACL,wBAAgB,KAAK,KAAM,SAAS,6BAA6B;AACjE,wBAAgB;AAAA,MAClB;AAEA,cAAQ,iCAAiC,aAAa;AACtD,cAAQ;AACR,cAAQ;AACR,cAAQ,mCAAmC,aAAa;AACxD,cAAQ;AAER,UAAI,WAAW,gBAAgB,GAAG;AAChC,gBAAQ,kDAAkD,WAAW,mBAAmB,MAAM,WAAW,aAAa,SAAS,WAAW,gBAAgB;AAAA,MAC5J;AAEA,cAAQ;AAAA,IACV;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,WAAmB,YAAiB,mBAA2C;AAC9G,QAAI,cAAc;AAClB,mBAAe,KAAK,sBAAsB,YAAY,iBAAiB;AACvE,mBAAe;AAEf,UAAM,cAAc;AAAA,MAClB,SAAS,YAAY,WAAW,EAAE,OAAO,KAAK,OAAO;AAAA,MACrD,QAAQ,KAAK,KAAM,OAAO,2BAA2B,EAAE,MAAM,WAAW;AAAA,MACxE,SAAS;AAAA,MACT,OAAO,OAAO,QAAQ;AAAA,IAAA;AAGxB,UAAM,YAAY,OAAO,WAAW;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EAKQ,sBAAsB,OAAY,UAAoD,UAA8D;AAC1J,UAAM,UAAsD,CAAA;AAE5D,UAAM,QAAQ,MAAM,MAAM;AAAA,MAAO,CAAC,SAChC,KAAK,SAAS,UACd,KAAK,OAAO,WAAW;AAAA,IAAA;AAGzB,eAAW,QAAQ,OAAO;AACxB,YAAM,aAAa,KAAK;AACxB,YAAM,SAAS,WAAW,UAAU,CAAA;AAEpC,iBAAW,WAAW,QAAQ;AAC5B,cAAM,SAAS,QAAQ;AACvB,cAAM,UAAU,QAAQ,WAAW;AACnC,cAAM,WAAW,QAAQ,YAAY;AAErC,YAAI,WAAW,YAAY,aAAa,YAAY,UAAU,GAAG;AAC/D,kBAAQ,KAAK;AAAA,YACX,UAAU,KAAK;AAAA,YACf;AAAA,UAAA,CACD;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA,EAKmB,aAAa,OAAwB;AACtD,UAAM,SAAU,MAAM,cAA8B,QAAQ;AAC5D,QAAI,CAAC,OAAQ;AAEb,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,CAAC,KAAM;AAEX,UAAM,WAAW;AAAA,MACf,MAAM;AAAA,MACN,MAAM,KAAK;AAAA,IAAA;AAGb,UAAM,cAAc,QAAQ,cAAc,KAAK,UAAU,QAAQ,CAAC;AAAA,EACpE;AAAA;AAAA;AAAA;AAAA,EAKA,MAAyB,QAAQ,OAAgC;AAC/D,UAAM,OAAO,WAAW,iBAAiB,KAAK;AAC9C,UAAM,aAAc,MAAM,OAAuB,QAAQ,kBAAkB;AAG3E,QAAI,QAAQ,KAAK,SAAS,QAAQ;AAChC,YAAM,OAAO,MAAM,KAAK,eAAe,aAAa,IAAI;AAExD,UAAI,CAAC,KAAM,QAAO,MAAM,QAAQ,KAAK;AAGrC,UAAI,cAAc,WAAW,QAAQ,aAAa,YAAY;AAC5D,YAAI,KAAK,SAAS,YAAY;AAE5B,cAAI,CAAC,KAAK,SAAS,KAAK,MAAM,OAAO,KAAK,MAAM,IAAI;AAElD,kBAAM,mBAAmB,KAAK,MAAM,MAAM,KAAK,CAAC,MAAW,EAAE,SAAS,UAAU;AAEhF,gBAAI,kBAAkB;AACpB,oBAAM,UAAU,KAAK,KAAM,SAAS,kCAAkC;AACtE,iBAAG,eAAe,KAAK,OAAO;AAC9B;AAAA,YACF;AAEA,kBAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,KAAK,SAAA,CAAU,CAAC;AAClE;AAAA,UACF;AAAA,QACF,OAAO;AACL,aAAG,eAAe,KAAK,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAC3E;AAAA,QACF;AAAA,MACF;AAGA,UAAI,cAAc,WAAW,QAAQ,aAAa,QAAQ;AACxD,YAAI,KAAK,SAAS,QAAQ;AAExB,cAAI,CAAC,KAAK,SAAS,KAAK,MAAM,OAAO,KAAK,MAAM,IAAI;AAElD,kBAAM,eAAe,KAAK,MAAM,MAAM;AAAA,cAAK,CAAC,MAC1C,EAAE,SAAS,UAAU,EAAE,SAAS,KAAK;AAAA,YAAA;AAGvC,gBAAI,cAAc;AAChB,oBAAM,UAAU,KAAK,KAAM,OAAO,6BAA6B,EAAE,MAAM,KAAK,MAAM;AAClF,iBAAG,eAAe,KAAK,OAAO;AAC9B;AAAA,YACF;AAEA,kBAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,KAAK,SAAA,CAAU,CAAC;AAClE;AAAA,UACF;AAAA,QACF,OAAO;AACL,aAAG,eAAe,KAAK,KAAK,KAAM,SAAS,uBAAuB,CAAC;AACnE;AAAA,QACF;AAAA,MACF;AAGA,UAAI,cAAc,WAAW,QAAQ,aAAa,SAAS;AACzD,YAAI,KAAK,SAAS,WAAW,KAAK,SAAS,kBAAkB;AAE3D,cAAI,CAAC,KAAK,SAAS,KAAK,MAAM,OAAO,KAAK,MAAM,IAAI;AAElD,kBAAM,eAAe,KAAK,MAAM,MAAM;AAAA,cAAK,CAAC,MAC1C,EAAE,SAAS,KAAK,QAAQ,EAAE,SAAS,KAAK;AAAA,YAAA;AAG1C,gBAAI,cAAc;AAChB,oBAAM,aAAa,KAAK,SAAS,UAAU,+BAA+B;AAC1E,oBAAM,UAAU,KAAK,KAAM,OAAO,YAAY,EAAE,MAAM,KAAK,MAAM;AACjE,iBAAG,eAAe,KAAK,OAAO;AAC9B;AAAA,YACF;AAEA,kBAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,KAAK,SAAA,CAAU,CAAC;AAClE;AAAA,UACF;AAAA,QACF,OAAO;AACL,aAAG,eAAe,KAAK,KAAK,KAAM,SAAS,yBAAyB,CAAC;AACrE;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAEA,WAAO,MAAM,QAAQ,KAAK;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKQ,gBAAqB;AAAA,EAE7B,MAAc,eAAe,OAA6B;AACxD,UAAM,QAAQ,MAAM;AACpB,UAAM,aAAa,MAAM,MAAM,KAAA,EAAO,YAAA;AACtC,UAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAG/D,QAAI,KAAK,eAAe;AACtB,mBAAa,KAAK,aAAa;AAAA,IACjC;AAGA,QAAI,WAAW,WAAW,GAAG;AAC3B,iBAAW,MAAM,UAAU;AAC3B;AAAA,IACF;AAGA,SAAK,gBAAgB,WAAW,YAAY;AAC1C,YAAM,KAAK,oBAAoB,YAAY,UAAU;AAAA,IACvD,GAAG,GAAG;AAAA,EACR;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,oBAAoB,YAAoB,YAAwC;AAC5F,UAAM,UAAiB,CAAA;AAGvB,SAAK,iBAAiB;AAGtB,QAAI,KAAK,OAAO;AACd,iBAAW,QAAQ,KAAK,OAAc;AACpC,YAAI,KAAK,SAAS,WAAW,KAAK,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAEzE,gBAAM,gBAAgB,KAAK,MAAM,MAAM;AAAA,YAAK,CAAC,MAC3C,EAAE,SAAS,WAAW,EAAE,SAAS,KAAK;AAAA,UAAA;AAGxC,kBAAQ,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK,KAAM,SAAS,yBAAyB;AAAA,YACnD,QAAQ,CAAC,CAAC;AAAA,UAAA,CACX;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,eAAW,QAAQ,KAAK,OAAc;AAEpC,UAAI,KAAK,iBAAiB,OAAQ;AAGlC,YAAMC,aAAY,MAAM,KAAK,aAAA;AAG7B,iBAAW,OAAOA,YAAW;AAC3B,YAAI,IAAI,SAAS,WAAW,IAAI,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAEvE,gBAAM,gBAAgB,KAAK,MAAM,MAAM;AAAA,YAAK,CAAC,MAC3C,EAAE,SAAS,WAAW,EAAE,SAAS,IAAI;AAAA,UAAA;AAGvC,kBAAQ,KAAK;AAAA,YACX,MAAM,IAAI;AAAA,YACV,MAAM,IAAI;AAAA,YACV,MAAM,KAAK;AAAA,YACX,QAAQ,CAAC,CAAC;AAAA,UAAA,CACX;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,SAAK,2BAA2B,SAAS,UAAU;AAAA,EACrD;AAAA;AAAA;AAAA;AAAA,EAKQ,iBAAyB;AAAA,EAEzB,2BAA2B,SAAgB,YAA+B;AAEhF,UAAM,sBAAsB,KAAK,eAC9B,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,gBAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAEX,UAAM,oBAAoB,KAAK,MAAM,MAAM;AAAA,MAAK,CAAC,MAC/C,EAAE,SAAS,WAAW,EAAE,KAAK,YAAA,MAAkB,KAAK,eAAe,YAAA;AAAA,IAAY;AAGjF,QAAI,OAAO;AAGX,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA;AAAA;AAAA,cAGC,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAAA;AAAA,8DAEJ,KAAK,cAAc;AAAA,0CACvC,KAAK,KAAM,SAAS,0BAA0B,CAAC;AAAA;AAAA;AAAA;AAAA,IAIrF,OAAO;AAEL,iBAAW,UAAU,SAAS;AAC5B,cAAM,gBAAgB,OAAO,SAAS,aAAa;AACnD,cAAM,aAAa,OAAO,SAAS,MAAM,KAAK,KAAM,SAAS,uBAAuB;AAEpF,gBAAQ;AAAA,2CAC2B,aAAa;AAAA;AAAA,0CAEd,OAAO,IAAI;AAAA,0CACX,OAAO,IAAI;AAAA;AAAA,uDAEE,OAAO,IAAI,KAAK,OAAO,SAAS,aAAa,EAAE;AAAA,gBACtF,UAAU;AAAA;AAAA;AAAA;AAAA,MAIpB;AAGA,UAAI,CAAC,mBAAmB;AACtB,gBAAQ;AAAA;AAAA;AAAA,6EAG6D,mBAAmB;AAAA,0CACtD,KAAK,KAAM,SAAS,wBAAwB,CAAC;AAAA;AAAA,uEAEhB,KAAK,cAAc;AAAA,gBAC1E,KAAK,KAAM,SAAS,oBAAoB,CAAC;AAAA;AAAA;AAAA;AAAA,MAInD;AAAA,IACF;AAEA,eAAW,YAAY;AACvB,eAAW,MAAM,UAAU;AAG3B,MAAE,UAAU,EAAE,KAAK,gBAAgB,EAAE,GAAG,SAAS,KAAK,sBAAsB,KAAK,IAAI,CAAC;AACtF,MAAE,UAAU,EAAE,KAAK,6CAA6C,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAG/G,MAAE,UAAU,EAAE,KAAK,kFAAkF,EAAE,GAAG,SAAS,CAAC,UAAU;AAE5H,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,gBAAgB,EAAE,SAAS,EAAG;AAG1D,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,gBAAgB,EAAE,CAAC;AAC9D,UAAI,UAAU,CAAC,OAAO,UAAU;AAC9B,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAGD,MAAE,UAAU,EAAE,KAAK,qCAAqC,EAAE,GAAG,SAAS,CAAC,UAAU;AAE/E,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,0BAA0B,EAAE,SAAS,EAAG;AAGpE,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,0BAA0B,EAAE,CAAC;AACxE,UAAI,QAAQ;AACV,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,sBAAsB,OAA6B;AAC/D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,OAAO,OAAO,QAAQ;AAE5B,QAAI,CAAC,KAAM;AAGX,UAAM,QAAQ,MAAM,SAAS,IAAW;AAExC,QAAI,CAAC,OAAO;AACV,SAAG,eAAe,MAAM,iBAAiB;AACzC;AAAA,IACF;AAGA,UAAM,gBAAgB,KAAK,MAAM,MAAM;AAAA,MAAK,CAAC,MAC3C,EAAE,SAAS,WAAW,EAAE,SAAS,MAAM;AAAA,IAAA;AAGzC,QAAI,eAAe;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,8BAA8B,EAAE,MAAM,MAAM,KAAA,CAAM,CAAC;AAC5F;AAAA,IACF;AAGA,UAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,MAAM,SAAA,CAAU,CAAC;AAGnE,WAAO,cAAc;AACrB,WAAO,WAAW;AAClB,WAAO,QAAQ,qBAAqB,GAAG,UAAU,IAAI,UAAU;AAE/D,OAAG,eAAe,KAAK,GAAG,MAAM,IAAI,IAAI,KAAK,KAAM,SAAS,uBAAuB,CAAC,EAAE;AAAA,EACxF;AAAA;AAAA;AAAA;AAAA,EAKQ,oBAAoB,OAA6B;AACvD,UAAM,QAAQ,MAAM;AAGpB,QAAI,MAAM,MAAM,KAAA,EAAO,SAAS,GAAG;AACjC,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAC/D,UAAI,cAAc,WAAW,UAAU,KAAA,EAAO,SAAS,GAAG;AACxD,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF;AAEA,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKQ,mBAAmB,OAA6B;AACtD,UAAM,QAAQ,MAAM;AACpB,UAAM,YAAY;AAGlB,eAAW,MAAM;AACf,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAC/D,UAAI,YAAY;AAEd,cAAM,gBAAgB,UAAU;AAChC,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAGA,cAAM,gBAAgB,SAAS;AAC/B,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAEA,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF,GAAG,GAAG;AAEN,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,kBAAkB,OAA6B;AAC3D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,YAAY,OAAO,QAAQ;AAEjC,QAAI,CAAC,UAAW;AAGhB,UAAM,gBAAgB,UACnB,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,YAAA,IAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAGX,UAAM,YAAY;AAAA,MAChB,MAAM;AAAA,MACN,MAAM;AAAA,MACN,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,iBAAiB;AAAA,QACjB,aAAa;AAAA,MAAA;AAAA,IACf;AAIF,UAAM,eAAe,MAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,SAAS,CAAC;AAEjF,QAAI,gBAAgB,aAAa,SAAS,GAAG;AAC3C,YAAM,WAAW,aAAa,CAAC;AAG/B,YAAM,cAAc,KAAK,QAAQ,KAAK,qBAAqB,EAAE,CAAC;AAC9D,UAAI,aAAa;AACf,oBAAY,QAAQ;AAAA,MACtB;AAEA,YAAM,aAAa,KAAK,QAAQ,KAAK,uBAAuB,EAAE,CAAC;AAC/D,UAAI,YAAY;AACd,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAGA,UAAI,YAAY,SAAS,OAAO;AAC9B,mBAAW,MAAM;AACf,mBAAS,MAAM,OAAO,IAAI;AAAA,QAC5B,GAAG,GAAG;AAAA,MACR;AAEA,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,6BAA6B,EAAE,MAAM,cAAA,CAAe,CAAC;AAAA,IAChG;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAMQ,oBAAyB;AAAA,EACzB,qBAA6B;AAAA;AAAA;AAAA;AAAA,EAKrC,MAAc,cAAc,OAA6B;AACvD,UAAM,QAAQ,MAAM;AACpB,UAAM,aAAa,MAAM,MAAM,KAAA,EAAO,YAAA;AACtC,UAAM,aAAa,EAAE,KAAK,EAAE,SAAS,sBAAsB,EAAE,CAAC;AAG9D,QAAI,KAAK,mBAAmB;AAC1B,mBAAa,KAAK,iBAAiB;AAAA,IACrC;AAGA,QAAI,WAAW,WAAW,GAAG;AAC3B,iBAAW,MAAM,UAAU;AAC3B;AAAA,IACF;AAGA,SAAK,oBAAoB,WAAW,YAAY;AAC9C,YAAM,KAAK,mBAAmB,YAAY,UAAU;AAAA,IACtD,GAAG,GAAG;AAAA,EACR;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,YAAoB,YAAwC;AAC3F,UAAM,UAAiB,CAAA;AAGvB,SAAK,qBAAqB;AAG1B,QAAI,KAAK,OAAO;AACd,iBAAW,QAAQ,KAAK,OAAc;AACpC,YAAI,KAAK,SAAS,UAAU,KAAK,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAExE,gBAAM,eAAe,KAAK,MAAM,MAAM;AAAA,YAAK,CAAC,MAC1C,EAAE,SAAS,UAAU,EAAE,SAAS,KAAK;AAAA,UAAA;AAGvC,kBAAQ,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK,KAAM,SAAS,wBAAwB;AAAA,YAClD,UAAU,KAAK,OAAO;AAAA,YACtB,QAAQ,CAAC,CAAC;AAAA,UAAA,CACX;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,eAAW,QAAQ,KAAK,OAAc;AAEpC,UAAI,KAAK,iBAAiB,OAAQ;AAGlC,YAAMA,aAAY,MAAM,KAAK,aAAA;AAG7B,iBAAW,OAAOA,YAAW;AAC3B,YAAI,IAAI,SAAS,UAAU,IAAI,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAEtE,gBAAM,eAAe,KAAK,MAAM,MAAM;AAAA,YAAK,CAAC,MAC1C,EAAE,SAAS,UAAU,EAAE,SAAS,IAAI;AAAA,UAAA;AAGtC,kBAAQ,KAAK;AAAA,YACX,MAAM,IAAI;AAAA,YACV,MAAM,IAAI;AAAA,YACV,MAAM,KAAK;AAAA,YACX,UAAU,IAAI,OAAO;AAAA,YACrB,QAAQ,CAAC,CAAC;AAAA,UAAA,CACX;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,SAAK,0BAA0B,SAAS,UAAU;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAKQ,0BAA0B,SAAgB,YAAwC;AAExF,UAAM,sBAAsB,KAAK,mBAC9B,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,gBAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAEX,UAAM,oBAAoB,KAAK,MAAM,MAAM;AAAA,MAAK,CAAC,MAC/C,EAAE,SAAS,UAAU,EAAE,KAAK,YAAA,MAAkB,KAAK,mBAAmB,YAAA;AAAA,IAAY;AAGpF,QAAI,OAAO;AAGX,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA;AAAA;AAAA,cAGC,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA,wCAGzB,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,oCACzD,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA,sCAC/C,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA,uCAClD,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAAA,0CACjD,KAAK,KAAM,SAAS,kCAAkC,CAAC;AAAA,wCACzD,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,wCACrD,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,sCACvD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA,6CAC5C,KAAK,KAAM,SAAS,qCAAqC,CAAC;AAAA,qCAClE,KAAK,KAAM,SAAS,6BAA6B,CAAC;AAAA,oCACnD,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA,4DAEzB,KAAK,kBAAkB;AAAA,0CACzC,KAAK,KAAM,SAAS,mBAAmB,CAAC;AAAA;AAAA;AAAA;AAAA,IAI9E,OAAO;AAEL,iBAAW,UAAU,SAAS;AAC5B,cAAM,gBAAgB,OAAO,SAAS,aAAa;AACnD,cAAM,aAAa,OAAO,SAAS,MAAM,KAAK,KAAM,SAAS,qBAAqB;AAClF,cAAM,gBAAgB,KAAK,KAAM,SAAS,wBAAwB,OAAO,SAAS,YAAA,EAAc,QAAQ,KAAK,GAAG,CAAC,EAAE;AAEnH,gBAAQ;AAAA,2CAC2B,aAAa;AAAA;AAAA,0CAEd,OAAO,IAAI;AAAA,0CACX,OAAO,IAAI,MAAM,aAAa;AAAA;AAAA,sDAElB,OAAO,IAAI,KAAK,OAAO,SAAS,aAAa,EAAE;AAAA,gBACrF,UAAU;AAAA;AAAA;AAAA;AAAA,MAIpB;AAGA,UAAI,CAAC,mBAAmB;AACtB,gBAAQ;AAAA;AAAA;AAAA,6EAG6D,mBAAmB;AAAA,0CACtD,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA,0CAG5C,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,sCACzD,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA,wCAC/C,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA,yCAClD,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAAA,4CACjD,KAAK,KAAM,SAAS,kCAAkC,CAAC;AAAA,0CACzD,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,0CACrD,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,wCACvD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA,+CAC5C,KAAK,KAAM,SAAS,qCAAqC,CAAC;AAAA,uCAClE,KAAK,KAAM,SAAS,6BAA6B,CAAC;AAAA,sCACnD,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA,qEAElB,KAAK,kBAAkB;AAAA,gBAC5E,KAAK,KAAM,SAAS,mBAAmB,CAAC;AAAA;AAAA;AAAA;AAAA,MAIlD;AAAA,IACF;AAEA,eAAW,YAAY;AACvB,eAAW,MAAM,UAAU;AAG3B,MAAE,UAAU,EAAE,KAAK,eAAe,EAAE,GAAG,SAAS,KAAK,qBAAqB,KAAK,IAAI,CAAC;AACpF,MAAE,UAAU,EAAE,KAAK,2CAA2C,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC;AAG5G,MAAE,UAAU,EAAE,KAAK,kFAAkF,EAAE,GAAG,SAAS,CAAC,UAAU;AAE5H,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,eAAe,EAAE,SAAS,EAAG;AAGzD,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,eAAe,EAAE,CAAC;AAC7D,UAAI,UAAU,CAAC,OAAO,UAAU;AAC9B,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAGD,MAAE,UAAU,EAAE,KAAK,qCAAqC,EAAE,GAAG,SAAS,CAAC,UAAU;AAE/E,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,qDAAqD,EAAE,SAAS,EAAG;AAG/F,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,yBAAyB,EAAE,CAAC;AACvE,UAAI,QAAQ;AACV,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAED,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,qBAAqB,OAA6B;AAC9D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,OAAO,OAAO,QAAQ;AAE5B,QAAI,CAAC,KAAM;AAGX,UAAM,OAAO,MAAM,SAAS,IAAW;AAEvC,QAAI,CAAC,MAAM;AACT,SAAG,eAAe,MAAM,gBAAgB;AACxC;AAAA,IACF;AAGA,UAAM,eAAe,KAAK,MAAM,MAAM;AAAA,MAAK,CAAC,MAC1C,EAAE,SAAS,UAAU,EAAE,SAAS,KAAK;AAAA,IAAA;AAGvC,QAAI,cAAc;AAChB,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,6BAA6B,EAAE,MAAM,KAAK,KAAA,CAAM,CAAC;AAC1F;AAAA,IACF;AAGA,UAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,KAAK,SAAA,CAAU,CAAC;AAGlE,WAAO,cAAc;AACrB,WAAO,WAAW;AAClB,WAAO,QAAQ,qBAAqB,GAAG,UAAU,IAAI,UAAU;AAE/D,OAAG,eAAe,KAAK,GAAG,KAAK,IAAI,IAAI,KAAK,KAAM,SAAS,qBAAqB,CAAC,EAAE;AAAA,EACrF;AAAA;AAAA;AAAA;AAAA,EAKQ,mBAAmB,OAA6B;AACtD,UAAM,QAAQ,MAAM;AAGpB,QAAI,MAAM,MAAM,KAAA,EAAO,SAAS,GAAG;AACjC,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,sBAAsB,EAAE,CAAC;AAC9D,UAAI,cAAc,WAAW,UAAU,KAAA,EAAO,SAAS,GAAG;AACxD,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF;AAEA,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKQ,kBAAkB,OAA6B;AACrD,UAAM,QAAQ,MAAM;AACpB,UAAM,YAAY;AAGlB,eAAW,MAAM;AACf,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,sBAAsB,EAAE,CAAC;AAC9D,UAAI,YAAY;AAEd,cAAM,gBAAgB,UAAU;AAChC,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAGA,cAAM,gBAAgB,SAAS;AAC/B,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAEA,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF,GAAG,GAAG;AAEN,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,OAA6B;AAC5D,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,cAAc,QAAQ,QAAQ;AAEpC,QAAI,CAAC,YAAa;AAGlB,UAAM,cAAc;AAAA,MAClB,SAAS,YAAY,WAAW,EAAE,OAAO,KAAK,OAAO;AAAA,MACrD,SAAS,iCAAiC,WAAW;AAAA,IAAA;AAGvD,UAAM,YAAY,OAAO,WAAkB;AAAA,EAC7C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,cAAc,OAA6B;AACvD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,QAAQ;AACX,cAAQ,MAAM,2BAA2B;AACzC;AAAA,IACF;AAEA,UAAM,SAAS,KAAK,MAAM,MAAM,IAAI,MAAM;AAC1C,QAAI,CAAC,UAAU,OAAO,SAAS,OAAQ;AAEvC,UAAM,KAAK,mBAAmB,QAAQ,QAAQ;AAAA,EAChD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,aAAa,OAA6B;AACtD,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,QAAQ;AACX,cAAQ,MAAM,0BAA0B;AACxC;AAAA,IACF;AAEA,UAAM,QAAQ,KAAK,MAAM,MAAM,IAAI,MAAM;AACzC,QAAI,CAAC,SAAS,MAAM,SAAS,OAAQ;AAErC,UAAM,KAAK,mBAAmB,OAAO,OAAO;AAAA,EAC9C;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,OAA6B;AAC5D,UAAM,eAAA;AACN,UAAM,UAAU,MAAM;AACtB,UAAM,SAAS,QAAQ,QAAQ;AAE/B,QAAI,CAAC,QAAQ;AACX,cAAQ,MAAM,iCAAiC;AAC/C;AAAA,IACF;AAEA,UAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,QAAI,CAAC,QAAQ,KAAK,SAAS,OAAQ;AAEnC,UAAM,KAAK,mBAAmB,MAAM,cAAc;AAAA,EACpD;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,mBAAmB,MAAW,MAA0D;AACpG,UAAM,aAAa,KAAK;AAGxB,UAAM,SAAS,KAAK,MAAM,MAAM,OAAO,CAAC,MAAW,EAAE,SAAS,OAAO;AACrE,UAAM,qBAAqB,KAAK,MAAM,MAAM,OAAO,CAAC,MAAW,EAAE,SAAS,gBAAgB;AAG1F,QAAI,mBAAmB,yBAAyB,KAAK,KAAM,SAAS,gCAAgC,IAAI;AACxG,WAAO,QAAQ,CAAC,UAAe;AAC7B,YAAM,cAAc,MAAM;AAC1B,YAAM,kBAAkB,YAAY,mBAAmB;AACvD,YAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,eAAe,KAAK;AACnF,YAAM,cAAc,YAAY,UAAU;AAC1C,YAAM,gBAAgB,iBAAiB;AAEvC,0BAAoB,wBAAwB,MAAM,EAAE,qBAAqB,aAAa,KAAK,MAAM,IAAI,KAAK,aAAa;AAGvH,YAAM,QAAQ,mBAAmB,OAAO,CAAC,SAAc;AACrD,cAAM,kBAAkB,KAAK,OAAO;AACpC,eAAO,oBAAoB,MAAM;AAAA,MACnC,CAAC;AAED,YAAM,QAAQ,CAAC,SAAc;AAC3B,cAAM,aAAa,KAAK;AACxB,cAAM,sBAAsB,WAAW,mBAAmB;AAC1D,cAAM,qBAAsB,KAAK,MAAM,OAAe,aAAa,mBAAmB,KAAK;AAC3F,cAAM,eAAe;AACrB,cAAM,kBAAkB,eAAe;AACvC,cAAM,oBAAoB,qBAAqB;AAE/C,4BAAoB,uBAAuB,KAAK,EAAE,qBAAqB,iBAAiB,4BAA4B,eAAe,SAAS,KAAK,IAAI,KAAK,iBAAiB;AAAA,MAC7K,CAAC;AAAA,IACH,CAAC;AAGD,UAAM,cAAc,WAAW,eAAe;AAC9C,UAAM,aAAa,KAAK;AAExB,UAAM,WAAW,SAAS,UAAU,gCAAgC;AAGpE,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,UAAU,EAAE,MAAM,YAAY;AAAA,MACvD,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAAA,6CAC5B,UAAU;AAAA;AAAA,YAE3C,gBAAgB,MAAM;AAAA;AAAA,qBAEb,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA,8CAC5B,WAAW;AAAA;AAAA,cAE3C,EAAE;AAAA;AAAA,qBAEK,KAAK,KAAM,SAAS,gCAAgC,CAAC;AAAA;AAAA,gBAE1D,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA,MAK1B,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,gBAAgB,KAAK,KAAK,eAAe,EAAE,IAAA;AACjD,gBAAI,CAAC,iBAAiB,kBAAkB,IAAI;AAC1C,iBAAG,eAAe,KAAK,KAAK,KAAM,SAAS,qCAAqC,CAAC;AACjF;AAAA,YACF;AAEA,kBAAM,CAAC,UAAU,MAAM,IAAK,cAAyB,MAAM,GAAG;AAE9D,gBAAI,CAAC,OAAQ;AAEb,gBAAI,aAAa,SAAS;AACxB,oBAAM,QAAQ,KAAK,MAAM,MAAM,IAAI,MAAM;AACzC,kBAAI,OAAO;AAGT,qBAAK,qBAAqB,OAAO,YAAY,SAAS,WAAkB;AAAA,cAC1E;AAAA,YACF,WAAW,aAAa,QAAQ;AAC9B,oBAAM,OAAO,KAAK,MAAM,MAAM,IAAI,MAAM;AACxC,kBAAI,MAAM;AAER,sBAAM,kBAAkB,SAAS,KAAK,KAAK,+BAA+B,EAAE,KAAK,kBAAkB,KAAK,GAAG;AAC3G,qBAAK,8BAA8B,MAAM,YAAY,iBAAiB,WAAkB;AAAA,cAC1F;AAAA,YACF;AAAA,UACF;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,qBAAqB,OAAY,YAAoB,YAAqB,mBAA2C;AACjI,UAAM,cAAc,MAAM;AAC1B,UAAM,SAAS,YAAY,UAAU;AACrC,UAAM,kBAAkB,YAAY,mBAAmB;AAGvD,UAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,eAAe,KAAK;AACnF,UAAM,WAAW,SAAS;AAE1B,QAAI,YAAY,GAAG;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,qBAAqB,CAAC;AACjE;AAAA,IACF;AAGA,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAG7F,UAAM,iBAAiB,KAAK,aAAa,SAAS,MAAM,IAAI;AAC5D,UAAM,qBAAqB,KAAK,aAAa,aAAa,eAAe;AACzE,UAAM,eAAe,CAAC,GAAG,gBAAgB,GAAG,mBAAmB,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,cAAc,IAAA,EAAM,CAAC;AAClI,UAAM,SAAS,KAAK,IAAI,GAAG,aAAa,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAClF,UAAM,kBAAkB,KAAK,IAAI,UAAU,KAAK,gBAAgB,MAAM,CAAC;AAGvE,QAAI,gBAAgB;AACpB,QAAI,aAAa,SAAS,GAAG;AAC3B,sBAAgB;AAChB,mBAAa,QAAQ,CAAC,WAAW;AAC/B,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,qCAAqC,EAAE,QAAQ,YAAY,OAAO,MAAM,KAAA,CAAM;AAAA,MACvG,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,uBAAuB,CAAC,aAAa,QAAQ;AAAA,gCACtD,KAAK,KAAM,SAAS,oBAAoB,CAAC,KAAK,MAAM,MAAM,cAAc,KAAK,cAAc;AAAA;AAAA;AAAA,qBAGtG,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,SAAA;AAAA,QAAW,CAAC,GAAG,MACnC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkFhC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AACjE,iBAAK,uBAAuB,GAAG,UAAU,KAAK,MAAM,IAAI,KAAK,YAAY,UAAU,eAAe,UAAU,iBAAiB;AAAA,UAC/H;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,8BAA8B,gBAAqB,YAAoB,iBAAyB,mBAA2C;AACvJ,UAAM,aAAa,eAAe;AAClC,UAAM,kBAAkB,WAAW,mBAAmB;AAGtD,UAAM,iBAAkB,KAAK,MAAM,OAAe,aAAa,eAAe,KAAK;AACnF,UAAM,WAAW,kBAAkB;AAEnC,QAAI,YAAY,GAAG;AACjB,SAAG,eAAe,KAAK,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAC1E;AAAA,IACF;AAGA,UAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,gBAAgB,YAAA,CAAa,EAAE;AAG7F,UAAM,gBAAgB,KAAK,aAAa,kBAAkB,eAAe,IAAI;AAC7E,UAAM,qBAAqB,KAAK,aAAa,aAAa,eAAe;AACzE,UAAM,kBAAkB,WAAW;AACnC,UAAM,iBAAiB,kBAAkB,KAAK,aAAa,SAAS,eAAe,IAAI,CAAA;AAEvF,UAAM,eAAe;AAAA,MACnB,GAAG;AAAA,MACH,GAAG,eAAe,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,eAAe,MAAM;AAAA,MACrF,GAAG,mBAAmB,IAAI,CAAA,OAAM,EAAE,GAAG,GAAG,UAAU,EAAE,WAAW,KAAK,cAAc,MAAM;AAAA,IAAA;AAE1F,UAAM,SAAS,KAAK,IAAI,GAAG,aAAa,OAAO,CAAC,OAAO,MAAM,QAAQ,EAAE,SAAS,CAAC,CAAC;AAClF,UAAM,kBAAkB,KAAK,IAAI,UAAU,KAAK,gBAAgB,MAAM,CAAC;AAGvE,QAAI,gBAAgB;AACpB,QAAI,aAAa,SAAS,GAAG;AAC3B,sBAAgB;AAChB,mBAAa,QAAQ,CAAC,WAAW;AAC/B,yBAAiB;AAAA;AAAA,+EAEsD,OAAO,OAAO;AAAA,oBACzE,OAAO,QAAQ,MAAM,OAAO,OAAO;AAAA;AAAA,MAEjD,CAAC;AACD,uBAAiB;AAAA,IACnB;AAGA,UAAM,SAAS,IAAI,OAAO;AAAA,MACxB,OAAO,KAAK,KAAM,OAAO,qCAAqC,EAAE,QAAQ,YAAY,OAAO,eAAe,KAAA,CAAM;AAAA,MAChH,SAAS;AAAA;AAAA;AAAA,qBAGM,KAAK,KAAM,SAAS,uBAAuB,CAAC,aAAa,QAAQ;AAAA,gCACtD,KAAK,KAAM,SAAS,4BAA4B,CAAC,KAAK,eAAe,MAAM,cAAc,KAAK,cAAc;AAAA;AAAA;AAAA,qBAGvH,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzC,KAAK,KAAM,SAAS,oCAAoC,CAAC;AAAA;AAAA;AAAA;AAAA,wBAIzD,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAAA;AAAA;AAAA;AAAA,wBAInD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,YAIlE,aAAa;AAAA;AAAA,qBAEJ,KAAK,KAAM,SAAS,4BAA4B,CAAC,2BAA2B,MAAM;AAAA;AAAA;AAAA,qBAGlF,KAAK,KAAM,SAAS,uBAAuB,CAAC;AAAA,+EACc,eAAe;AAAA;AAAA,gBAE9E,MAAM;AAAA,QAAK,EAAC,QAAQ,SAAA;AAAA,QAAW,CAAC,GAAG,MACnC,yBAAyB,IAAI,kBAAkB,aAAa,EAAE,sBAAsB,IAAI,CAAC;AAAA;AAAA,8CAE3D,IAAI,CAAC;AAAA;AAAA,MAAA,EAEnC,KAAK,EAAE,CAAC;AAAA;AAAA,+BAEO,KAAK,KAAM,SAAS,4BAA4B,CAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,8BAWlD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAkFhC,SAAS;AAAA,QACP,MAAM;AAAA,UACJ,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,kBAAkB;AAAA,UAC7C,UAAU,CAAC,SAAc;AACvB,kBAAM,YAAY;AAClB,kBAAM,WAAW,KAAK,IAAI,WAAW,SAAS,KAAK,KAAK,mBAAmB,EAAE,IAAA,CAAK,KAAK,CAAC;AACxF,kBAAM,aAAa,YAAY;AAC/B,gBAAI,gBAAgB;AACpB,iBAAK,KAAK,6BAA6B,EAAE,KAAK,CAAC,GAAW,OAAY;AACpE,+BAAiB,SAAS,GAAG,QAAQ,OAAO;AAAA,YAC9C,CAAC;AACD,4BAAgB,KAAK,IAAI,GAAG,aAAa;AACzC,kBAAM,WAAW,KAAK,KAAK,2BAA2B,EAAE,SAAS;AACjE,iBAAK,uBAAuB,GAAG,UAAU,KAAK,eAAe,IAAI,KAAK,YAAY,UAAU,eAAe,UAAU,iBAAiB;AAAA,UACxI;AAAA,QAAA;AAAA,QAEF,QAAQ;AAAA,UACN,MAAM;AAAA,UACN,OAAO,KAAK,KAAM,SAAS,QAAQ;AAAA,QAAA;AAAA,MACrC;AAAA,MAEF,SAAS;AAAA,IAAA,GACR,EAAE,OAAO,KAAK;AAEjB,WAAO,OAAO,IAAI;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,iBAAiB,OAA6B;AAC1D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,WAAW,OAAO,QAAQ;AAEhC,QAAI,CAAC,SAAU;AAGf,UAAM,WAAW,EAAE,MAAM,EAAE,SAAS,iDAAiD,EAAE,CAAC;AACxF,UAAM,WAAW,WAAW,SAAS,QAAQ;AAG7C,UAAM,gBAAgB,SACnB,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,YAAA,IAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAGX,UAAM,WAAW;AAAA,MACf,MAAM;AAAA,MACN,MAAM;AAAA,MACN,QAAQ;AAAA,QACN,aAAa;AAAA,QACb,QAAQ;AAAA,QACR,MAAM;AAAA,QACN,QAAQ;AAAA,QACR;AAAA,QACA,QAAQ,CAAA;AAAA,QACR,SAAS,CAAA;AAAA,QACT,UAAU,CAAA;AAAA,QACV,kBAAkB;AAAA,QAClB,mBAAmB;AAAA,QACnB,wBAAwB;AAAA,QACxB,sBAAsB;AAAA,QACtB,cAAc;AAAA,QACd,aAAa;AAAA,MAAA;AAAA,IACf;AAIF,UAAM,eAAe,MAAM,KAAK,MAAM,wBAAwB,QAAQ,CAAC,QAAQ,CAAC;AAEhF,QAAI,gBAAgB,aAAa,SAAS,GAAG;AAC3C,YAAM,UAAU,aAAa,CAAC;AAG9B,YAAM,cAAc,KAAK,QAAQ,KAAK,oBAAoB,EAAE,CAAC;AAC7D,UAAI,aAAa;AACf,oBAAY,QAAQ;AAAA,MACtB;AAEA,YAAM,aAAa,KAAK,QAAQ,KAAK,sBAAsB,EAAE,CAAC;AAC9D,UAAI,YAAY;AACd,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAGA,UAAI,WAAW,QAAQ,OAAO;AAC5B,mBAAW,MAAM;AACf,kBAAQ,MAAM,OAAO,IAAI;AAAA,QAC3B,GAAG,GAAG;AAAA,MACR;AAEA,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,2BAA2B,EAAE,MAAM,cAAA,CAAe,CAAC;AAAA,IAC9F;AAAA,EACF;AACF;ACzkHO,MAAM,kBAAkB,UAAU;AAAA;AAAA,EAE/B,iBAAyB;AAAA,EAEjC,WAAoB,iBAA8C;AAChE,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,SAAS,CAAC,QAAQ,SAAS,QAAQ,MAAM;AAAA,MACzC,UAAU;AAAA,MACV,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA,MACN,UAAU;AAAA,QACR,EAAE,cAAc,uBAAA;AAAA,MAAuB;AAAA,MAEzC,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH;AAAA,EAES,UAAe;AACtB,UAAM,UAAU,MAAM,QAAA;AAGtB,SAAK,KAAK,YAAA;AAEV,YAAQ,SAAS,KAAK,KAAK;AAG3B,YAAQ,gBAAgB,KAAK;AAG7B,YAAQ,mBAAmB,KAAK,2BAAA;AAGhC,YAAQ,oBAAoB,KAAK,4BAAA;AAGjC,YAAQ,YAAY,CAAA;AACpB,UAAM,SAAS,QAAQ,OAAO,UAAU,CAAA;AAExC,aAAS,IAAI,GAAG,IAAI,OAAO,QAAQ,KAAK;AACtC,YAAM,UAAU,OAAO,CAAC;AACxB,YAAM,SAAS,QAAQ;AACvB,YAAM,UAAU,QAAQ,WAAW;AACnC,YAAM,WAAW,QAAQ,YAAY;AAErC,YAAM,QAAa;AAAA,QACjB,OAAO;AAAA,QACP;AAAA,QACA;AAAA,QACA;AAAA,QACA,cAAc;AAAA,MAAA;AAGhB,UAAI,WAAW,WAAW,WAAW,kBAAkB;AACrD,cAAM,eAAe,WAAW,UAC5B,KAAK,KAAM,SAAS,0BAA0B,IAC9C,KAAK,KAAM,SAAS,mCAAmC;AAG3D,YAAI,KAAK,KAAK,SAAS,UAAU;AAC/B,gBAAM,aAAa,KAAK,KAAK,MAAM,MAAM;AAAA,YAAK,CAACC,OAC7CA,GAAE,SAAS,UAAUA,GAAE,SAAS;AAAA,UAAA;AAGlC,cAAI,CAAC,YAAY;AACf,kBAAM,mBAAmB;AAAA,UAC3B;AAAA,QACF;AAAA,MACF;AAEA,cAAQ,UAAU,KAAK,KAAK;AAAA,IAC9B;AAEA,WAAO;AAAA,EACT;AAAA,EAES,kBAAkB,MAAoB;AAC7C,UAAM,kBAAkB,IAAI;AAG5B,SAAK,KAAK,8BAA8B,EAAE,GAAG,SAAS,KAAK,cAAc,KAAK,IAAI,CAAC;AAGnF,SAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC;AAGzF,SAAK,KAAK,iCAAiC,EAAE,GAAG,SAAS,KAAK,iBAAiB,KAAK,IAAI,CAAC;AAGzF,SAAK,KAAK,sCAAsC,EAAE,GAAG,SAAS,KAAK,sBAAsB,KAAK,IAAI,CAAC;AAGnG,SAAK,KAAK,yCAAyC,EAAE,GAAG,SAAS,KAAK,yBAAyB,KAAK,IAAI,CAAC;AAGzG,SAAK,KAAK,oCAAoC,EAAE,GAAG,UAAU,KAAK,oBAAoB,KAAK,IAAI,CAAC;AAGhG,SAAK,KAAK,qCAAqC,EAAE,GAAG,UAAU,KAAK,qBAAqB,KAAK,IAAI,CAAC;AAGlG,SAAK,KAAK,wBAAwB,EAAE,GAAG,UAAU,KAAK,0BAA0B,KAAK,IAAI,CAAC;AAG1F,SAAK,KAAK,2BAA2B,EAAE,GAAG,UAAU,KAAK,wBAAwB,KAAK,IAAI,CAAC;AAG3F,SAAK,KAAK,2BAA2B,EAAE,GAAG,UAAU,KAAK,wBAAwB,KAAK,IAAI,CAAC;AAG3F,SAAK,KAAK,oDAAoD,EAAE,GAAG,UAAU,KAAK,0BAA0B,KAAK,IAAI,CAAC;AAGtH,SAAK,KAAK,wBAAwB,EAAE,GAAG,SAAS,KAAK,qBAAqB,KAAK,IAAI,CAAC;AAGpF,SAAK,KAAK,yBAAyB,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAClF,SAAK,KAAK,yBAAyB,EAAE,GAAG,SAAS,KAAK,uBAAuB,KAAK,IAAI,CAAC;AACvF,SAAK,KAAK,yBAAyB,EAAE,GAAG,QAAQ,KAAK,sBAAsB,KAAK,IAAI,CAAC;AAGrF,MAAE,QAAQ,EAAE,GAAG,0BAA0B,CAAC,UAAU;AAClD,YAAM,SAAS,MAAM;AACrB,YAAM,mBAAmB,KAAK,KAAK,6BAA6B;AAChE,uBAAiB,KAAK,CAAC,GAAG,cAAc;AACtC,YAAI,CAAC,UAAU,SAAS,MAAM,GAAG;AAC/B,YAAE,SAAS,EAAE,KAAK,2BAA2B,EAAE,KAAA;AAAA,QACjD;AAAA,MACF,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKQ,qBAAqB,OAAoB;AAC/C,UAAM,eAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,UAAU,OAAO,QAAQ;AAE/B,QAAI,CAAC,QAAS;AAGd,SAAK,iBAAiB;AAGtB,QAAI,CAAC,KAAK,KAAM;AAChB,UAAM,OAAO,EAAE,KAAK,IAAI;AAGxB,SAAK,KAAK,wBAAwB,EAAE,YAAY,QAAQ;AACxD,WAAO,UAAU,IAAI,QAAQ;AAG7B,SAAK,KAAK,kBAAkB,EAAE,YAAY,QAAQ;AAClD,SAAK,KAAK,0BAA0B,OAAO,IAAI,EAAE,SAAS,QAAQ;AAAA,EACpE;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,cAAc,OAA6B;AACvD,UAAM,eAAA;AAEN,UAAM,SAAS,CAAC,GAAK,KAAK,KAAK,OAAe,UAAU,EAAG;AAE3D,WAAO,KAAK;AAAA,MACV,QAAQ;AAAA,MACR,SAAS;AAAA,MACT,UAAU;AAAA,IAAA,CACX;AAED,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,iBAAiB;AAAA,IAAA,CACX;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,iBAAiB,OAA6B;AAC1D,UAAM,eAAA;AAEN,UAAM,QAAQ,SAAU,MAAM,cAA8B,QAAQ,SAAS,GAAG;AAEhF,UAAM,SAAS,CAAC,GAAK,KAAK,KAAK,OAAe,UAAU,EAAG;AAE3D,WAAO,OAAO,OAAO,CAAC;AAEtB,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,iBAAiB;AAAA,IAAA,CACX;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,iBAAiB,OAA6B;AAC1D,UAAM,eAAA;AAEN,UAAM,QAAQ,SAAU,MAAM,cAA8B,QAAQ,SAAS,GAAG;AAChF,UAAM,SAAS,CAAC,GAAK,KAAK,KAAK,OAAe,UAAU,EAAG;AAE3D,QAAI,OAAO,KAAK,GAAG;AACjB,aAAO,KAAK,IAAI,EAAE,GAAG,OAAO,KAAK,GAAG,UAAU,GAAA;AAAA,IAChD;AAEA,UAAM,KAAK,KAAK,OAAO,EAAE,iBAAiB,QAAe;AACzD,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAyB,QAAQ,OAAgC;AAC/D,UAAM,OAAO,WAAW,iBAAiB,KAAK;AAG9C,QAAI,QAAQ,KAAK,SAAS,QAAQ;AAChC,YAAM,OAAO,MAAM,KAAK,eAAe,aAAa,IAAI;AAExD,UAAI,CAAC,KAAM,QAAO,MAAM,QAAQ,KAAK;AAGrC,YAAM,WAAY,MAAM,OAAuB,QAAQ,iBAAiB;AACxE,UAAI,CAAC,SAAU,QAAO,MAAM,QAAQ,KAAK;AAEzC,YAAM,QAAQ,SAAU,SAAyB,QAAQ,WAAW,GAAG;AACvE,YAAM,SAAS,CAAC,GAAK,KAAK,KAAK,OAAe,UAAU,EAAG;AAC3D,YAAM,SAAS,OAAO,KAAK,GAAG;AAG9B,UAAI,KAAK,SAAS,WAAW,WAAW,SAAS;AAE/C,eAAO,KAAK,IAAI,EAAE,GAAG,OAAO,KAAK,GAAG,UAAU,KAAK,KAAA;AACnD,cAAM,KAAK,KAAK,OAAO,EAAE,iBAAiB,QAAe;AACzD,aAAK,OAAO,KAAK;AACjB,WAAG,eAAe,KAAK,KAAK,KAAM,OAAO,+BAA+B,EAAE,MAAM,KAAK,KAAA,CAAM,CAAC;AAC5F;AAAA,MACF,WAAW,KAAK,SAAS,oBAAoB,WAAW,kBAAkB;AAExE,eAAO,KAAK,IAAI,EAAE,GAAG,OAAO,KAAK,GAAG,UAAU,KAAK,KAAA;AACnD,cAAM,KAAK,KAAK,OAAO,EAAE,iBAAiB,QAAe;AACzD,aAAK,OAAO,KAAK;AACjB,WAAG,eAAe,KAAK,KAAK,KAAM,OAAO,+BAA+B,EAAE,MAAM,KAAK,KAAA,CAAM,CAAC;AAC5F;AAAA,MACF,WAAW,WAAW,WAAW,WAAW,kBAAkB;AAE5D,WAAG,eAAe,KAAK,KAAK,KAAM,SAAS,8BAA8B,CAAC;AAC1E;AAAA,MACF;AAAA,IACF;AAEA,WAAO,MAAM,QAAQ,KAAK;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,sBAAsB,OAA6B;AAC/D,UAAM,eAAA;AAEN,UAAM,mBAAmB,CAAC,GAAK,KAAK,KAAK,OAAe,oBAAoB,EAAG;AAE/E,qBAAiB,KAAK;AAAA,MACpB,MAAM;AAAA,MACN,YAAY;AAAA,IAAA,CACb;AAED,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,2BAA2B;AAAA,IAAA,CACrB;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,yBAAyB,OAA6B;AAClE,UAAM,eAAA;AAEN,UAAM,QAAQ,SAAU,MAAM,cAA8B,QAAQ,SAAS,GAAG;AAEhF,UAAM,mBAAmB,CAAC,GAAK,KAAK,KAAK,OAAe,oBAAoB,EAAG;AAE/E,qBAAiB,OAAO,OAAO,CAAC;AAEhC,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,2BAA2B;AAAA,IAAA,CACrB;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKQ,6BAAqC;AAC3C,UAAM,cAAe,KAAK,KAAK,OAAe,eAAe;AAC7D,UAAM,mBAAoB,KAAK,KAAK,OAAe,oBAAoB;AAGvE,UAAM,WAAW,KAAK,KAAK,QAAU,KAAK,KAAK,MAAM,QAAgB,YAAY,YAAY,IAAK;AAGlG,QAAI,gBAAgB,OAAO;AAEzB,YAAM,QAAQ,WAAW;AACzB,UAAI,CAAC,KAAK,KAAK,OAAO;AACpB,eAAO,mBAAmB,IAAI,OAAO,gBAAgB,KAAK;AAAA,MAC5D;AACA,aAAO,GAAG,KAAK,QAAQ,mBAAmB,IAAI,IAAI,gBAAgB,KAAK,EAAE;AAAA,IAC3E,WAAW,YAAY,WAAW,MAAM,GAAG;AAEzC,YAAM,WAAW,SAAS,YAAY,UAAU,CAAC,CAAC,KAAK;AACvD,YAAM,QAAQ,WAAW,WAAW;AACpC,UAAI,CAAC,KAAK,KAAK,OAAO;AACpB,eAAO,mBAAmB,IAAI,OAAO,QAAQ,IAAI,gBAAgB,KAAK,OAAO,QAAQ;AAAA,MACvF;AACA,aAAO,GAAG,KAAK,SAAS,QAAQ,GAAG,mBAAmB,IAAI,IAAI,gBAAgB,KAAK,EAAE;AAAA,IACvF,WAAW,gBAAgB,SAAS;AAElC,aAAO;AAAA,IACT,OAAO;AAEL,YAAM,OAAO,SAAS,WAAW,KAAK;AACtC,YAAM,QAAQ,OAAO;AACrB,UAAI,mBAAmB,GAAG;AACxB,eAAO,GAAG,KAAK,KAAK,IAAI,IAAI,gBAAgB;AAAA,MAC9C;AACA,aAAO,MAAM,SAAA;AAAA,IACf;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,oBAAoB,OAA6B;AAC7D,UAAM,eAAA;AAEN,UAAM,aAAc,MAAM,cAAoC;AAE9D,QAAI,CAAC,cAAc,CAAC,aAAa,UAAuC,GAAG;AACzE;AAAA,IACF;AAEA,UAAM,cAAc,aAAa,UAAuC;AAGxE,UAAM,cAAc,OAAO,YAAY,OAAO,WAAW,YAAY,GAAG,aAAa,YAAY;AAEjG,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,qBAAqB;AAAA,MACrB,sBAAsB;AAAA,MACtB,qBAAqB,YAAY;AAAA,MACjC,qBAAqB,YAAY;AAAA,MACjC,sBAAsB,YAAY;AAAA,MAClC,oBAAoB,YAAY;AAAA,IAAA,CAC1B;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,qBAAqB,OAA6B;AAC9D,UAAM,eAAA;AAEN,UAAM,cAAe,MAAM,cAAoC;AAE/D,QAAI,CAAC,eAAe,CAAC,cAAc,WAAyC,GAAG;AAC7E;AAAA,IACF;AAEA,UAAM,eAAe,cAAc,WAAyC;AAE5E,UAAM,KAAK,KAAK,OAAO;AAAA,MACrB,sBAAsB;AAAA,MACtB,oBAAoB,aAAa;AAAA,MACjC,oBAAoB,aAAa;AAAA,MACjC,mBAAmB,aAAa;AAAA,MAChC,gBAAgB,aAAa;AAAA,MAC7B,sBAAsB,aAAa;AAAA,MACnC,gBAAgB,aAAa;AAAA,MAC7B,sBAAsB,aAAa;AAAA,IAAA,CAC7B;AAER,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKQ,8BAAmC;AACzC,UAAM,gBAAiB,KAAK,KAAK,OAAe,aAAa;AAC7D,UAAM,gBAAiB,KAAK,KAAK,OAAe,aAAa;AAC7D,UAAM,eAAgB,KAAK,KAAK,OAAe,YAAY;AAC3D,UAAM,YAAa,KAAK,KAAK,OAAe,SAAS;AACrD,UAAM,kBAAmB,KAAK,KAAK,OAAe,eAAe;AACjE,UAAM,YAAa,KAAK,KAAK,OAAe,SAAS;AAErD,UAAM,iBAAkB,KAAK,KAAK,OAAe,kBAAkB;AACnE,UAAM,aAAc,KAAK,KAAK,OAAe,cAAc;AAC3D,UAAM,gBAAiB,KAAK,KAAK,OAAe,iBAAiB;AACjE,UAAM,aAAc,KAAK,KAAK,OAAe,cAAc;AAC3D,UAAM,WAAY,KAAK,KAAK,OAAe,YAAY;AACvD,UAAM,UAAW,KAAK,KAAK,OAAe,WAAW;AAGrD,UAAM,iBAAiB,KAAK,IAAI,IAAI,gBAAgB,cAAc;AAClE,UAAM,gBAAgB,eAAe;AACrC,UAAM,aAAa,UAAU,IAAK,YAAY;AAC9C,UAAM,mBAAmB,WAAY,kBAAkB,IAAI,kBAAkB,IAAK;AAClF,UAAM,aAAa,KAAK,IAAI,eAAe,YAAY,UAAU;AAEjE,WAAO;AAAA,MACL,WAAW;AAAA,MACX,WAAW;AAAA,MACX,UAAU;AAAA,MACV,OAAO;AAAA,MACP,aAAa;AAAA,MACb,OAAO;AAAA,IAAA;AAAA,EAEX;AAAA;AAAA;AAAA;AAAA,EAKQ,0BAA0B,OAAoB;AACpD,UAAM,eAAA;AAEN,UAAM,WAAW,MAAM;AACvB,UAAM,QAAQ,SAAS,SAAS,QAAQ,cAAc,GAAG;AACzD,UAAM,eAAgB,KAAK,KAAK,OAAe,oBAAoB;AAEnE,QAAI;AAEJ,QAAI,SAAS,SAAS;AAEpB,iBAAW;AAAA,IACb,OAAO;AAEL,UAAI,UAAU,KAAK,iBAAiB,GAAG;AACrC,mBAAW;AAAA,MACb,WAAW,UAAU,KAAK,gBAAgB,GAAG;AAC3C,mBAAW;AAAA,MACb,OAAO;AACL,mBAAW;AAAA,MACb;AAAA,IACF;AAGA,UAAM,cAAc,KAAK,QAAQ,KAAK,uCAAuC,EAAE,CAAC;AAChF,QAAI,aAAa;AACf,kBAAY,QAAQ,SAAS,SAAA;AAAA,IAC/B;AAGA,UAAM,aAAa,KAAK,QAAQ,KAAK,wBAAwB;AAC7D,eAAW,KAAK,CAAC,GAAG,OAAO;AACzB,YAAM,YAAY;AAClB,YAAM,UAAU,SAAS,UAAU,QAAQ,cAAc,GAAG;AAC5D,UAAI,YAAY,GAAG;AACjB,kBAAU,UAAU,YAAY;AAAA,MAClC,WAAW,YAAY,GAAG;AACxB,kBAAU,UAAU,aAAa;AAAA,MACnC;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKQ,wBAAwB,OAAoB;AAClD,UAAM,eAAA;AAEN,UAAM,WAAW,MAAM;AACvB,UAAM,QAAQ,SAAS,SAAS,QAAQ,cAAc,GAAG;AACzD,UAAM,eAAgB,KAAK,KAAK,OAAe,uBAAuB;AAEtE,QAAI;AAEJ,QAAI,SAAS,SAAS;AAEpB,iBAAW;AAAA,IACb,OAAO;AAEL,UAAI,UAAU,KAAK,iBAAiB,GAAG;AACrC,mBAAW;AAAA,MACb,WAAW,UAAU,KAAK,gBAAgB,GAAG;AAC3C,mBAAW;AAAA,MACb,OAAO;AACL,mBAAW;AAAA,MACb;AAAA,IACF;AAGA,UAAM,cAAc,KAAK,QAAQ,KAAK,0CAA0C,EAAE,CAAC;AACnF,QAAI,aAAa;AACf,kBAAY,QAAQ,SAAS,SAAA;AAAA,IAC/B;AAGA,UAAM,aAAa,KAAK,QAAQ,KAAK,2BAA2B;AAChE,eAAW,KAAK,CAAC,GAAG,OAAO;AACzB,YAAM,YAAY;AAClB,YAAM,UAAU,SAAS,UAAU,QAAQ,cAAc,GAAG;AAC5D,UAAI,YAAY,GAAG;AACjB,kBAAU,UAAU,YAAY;AAAA,MAClC,WAAW,YAAY,GAAG;AACxB,kBAAU,UAAU,aAAa;AAAA,MACnC;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKQ,wBAAwB,OAAoB;AAClD,UAAM,eAAA;AAEN,UAAM,WAAW,MAAM;AACvB,UAAM,WAAW,SAAS,UAAU,IAAI;AAGxC,UAAM,cAAc,KAAK,QAAQ,KAAK,0CAA0C,EAAE,CAAC;AACnF,QAAI,aAAa;AACf,kBAAY,QAAQ,SAAS,SAAA;AAAA,IAC/B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOQ,0BAA0B,OAAoB;AACpD,UAAM,eAAA;AAEN,UAAM,WAAW,MAAM;AACvB,UAAM,YAAY,SAAS;AAG3B,UAAM,WAAW,SAAS,QAAQ,YAAY;AAC9C,QAAI,CAAC,SAAU;AAEf,UAAM,SAAS,SAAS,cAAc,QAAQ;AAC9C,QAAI,CAAC,OAAQ;AAGb,UAAM,aAAa,SAAS,cAAc,cAAc,GAAG,eAAe;AAC1E,QAAI,YAAY;AAChB,QAAI,WAAW,SAAS,SAAS,KAAK,WAAW,SAAS,OAAO,KAAK,WAAW,SAAS,OAAO,GAAG;AAClG,kBAAY;AAAA,IACd,WAAW,WAAW,SAAS,QAAQ,KAAK,WAAW,SAAS,OAAO,GAAG;AACxE,kBAAY;AAAA,IACd,WAAW,WAAW,SAAS,SAAS,KAAK,WAAW,SAAS,QAAQ,GAAG;AAC1E,kBAAY;AAAA,IACd,WAAW,WAAW,SAAS,QAAQ,KAAK,WAAW,SAAS,MAAM,GAAG;AACvE,kBAAY;AAAA,IACd;AAEA,UAAM,eAAe,OAAO;AAC5B,QAAI,WAAW;AAEf,QAAI,WAAW;AAEb,UAAI,iBAAiB,QAAQ;AAC3B,mBAAW;AAAA,MACb,WAAW,iBAAiB,QAAQ;AAClC,mBAAW;AAAA,MACb;AAAA,IAEF,OAAO;AAEL,UAAI,iBAAiB,MAAM;AACzB,mBAAW;AAAA,MACb,WAAW,iBAAiB,QAAQ;AAClC,mBAAW;AAAA,MACb;AAAA,IAEF;AAGA,WAAO,QAAQ;AAGf,UAAM,cAAc,KAAK,QAAQ,KAAK,eAAe,SAAS,IAAI,EAAE,CAAC;AACrE,QAAI,aAAa;AACf,kBAAY,QAAQ;AAAA,IACtB;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,wBAA6B;AAAA,EAErC,MAAc,kBAAkB,OAA6B;AAC3D,UAAM,QAAQ,MAAM;AACpB,UAAM,aAAa,MAAM,MAAM,KAAA,EAAO,YAAA;AACtC,UAAM,UAAU,SAAS,MAAM,QAAQ,WAAW,GAAG;AACrD,UAAM,aAAa,EAAE,KAAK,EAAE,SAAS,2BAA2B,EAAE,CAAC;AAGnE,QAAI,KAAK,uBAAuB;AAC9B,mBAAa,KAAK,qBAAqB;AAAA,IACzC;AAGA,QAAI,WAAW,WAAW,GAAG;AAC3B,iBAAW,MAAM,UAAU;AAC3B;AAAA,IACF;AAGA,SAAK,wBAAwB,WAAW,YAAY;AAClD,YAAM,KAAK,uBAAuB,YAAY,SAAS,UAAU;AAAA,IACnE,GAAG,GAAG;AAAA,EACR;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,uBAAuB,YAAoB,SAAiB,YAAwC;AAChH,UAAM,UAAiB,CAAA;AACvB,UAAM,SAAU,KAAK,KAAK,OAAe,UAAU,CAAA;AACnD,UAAM,SAAS,OAAO,OAAO,GAAG;AAEhC,QAAI,CAAC,UAAU,WAAW,aAAa;AACrC,iBAAW,MAAM,UAAU;AAC3B;AAAA,IACF;AAGA,QAAI,KAAK,KAAK,OAAO;AACnB,iBAAW,QAAQ,KAAK,KAAK,MAAM,OAAc;AAC/C,YAAI,KAAK,SAAS,UAAU,KAAK,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AACxE,kBAAQ,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,QAAQ,KAAK,KAAM,SAAS,uBAAuB;AAAA,YACnD,MAAM;AAAA,UAAA,CACP;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,QAAI,KAAK,OAAO;AACd,iBAAW,QAAQ,KAAK,OAAc;AACpC,YAAI,KAAK,SAAS,UAAU,KAAK,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAExE,gBAAM,SAAS,QAAQ,KAAK,OAAK,EAAE,SAAS,KAAK,IAAI;AACrD,cAAI,CAAC,QAAQ;AACX,oBAAQ,KAAK;AAAA,cACX,MAAM,KAAK;AAAA,cACX,MAAM,KAAK;AAAA,cACX,QAAQ,KAAK,KAAM,SAAS,yBAAyB;AAAA,cACrD,MAAM;AAAA,YAAA,CACP;AAAA,UACH;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAGA,eAAW,QAAQ,KAAK,OAAc;AAEpC,UAAI,KAAK,iBAAiB,OAAQ;AAGlC,YAAMD,aAAY,MAAM,KAAK,aAAA;AAG7B,iBAAW,OAAOA,YAAW;AAC3B,YAAI,IAAI,SAAS,UAAU,IAAI,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AAEtE,gBAAM,SAAS,QAAQ,KAAK,OAAK,EAAE,SAAS,IAAI,IAAI;AACpD,cAAI,CAAC,QAAQ;AACX,oBAAQ,KAAK;AAAA,cACX,MAAM,IAAI;AAAA,cACV,MAAM,IAAI;AAAA,cACV,QAAQ,KAAK;AAAA,cACb,MAAM;AAAA,YAAA,CACP;AAAA,UACH;AAAA,QACF;AAAA,MACF;AAAA,IACF;AAGA,SAAK,8BAA8B,SAAS,SAAS,UAAU;AAAA,EACjE;AAAA;AAAA;AAAA;AAAA,EAKQ,8BAA8B,SAAgB,SAAiB,YAA+B;AACpG,QAAI,OAAO;AAEX,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA;AAAA;AAAA,cAGC,KAAK,KAAM,SAAS,+BAA+B,CAAC;AAAA;AAAA;AAAA;AAAA,IAI9D,OAAO;AAEL,iBAAW,UAAU,SAAS;AAC5B,cAAM,YAAY,OAAO,SAAS,UAC9B,KAAK,KAAM,SAAS,0BAA0B,IAC9C,KAAK,KAAM,SAAS,mCAAmC;AAE3D,gBAAQ;AAAA,8DAC8C,OAAO,IAAI,oBAAoB,OAAO;AAAA;AAAA,0CAE1D,OAAO,IAAI;AAAA,0CACX,OAAO,MAAM,MAAM,SAAS;AAAA;AAAA,kEAEJ,OAAO,IAAI,oBAAoB,OAAO;AAAA,gBACxF,KAAK,KAAM,SAAS,mBAAmB,CAAC;AAAA;AAAA;AAAA;AAAA,MAIlD;AAAA,IACF;AAEA,eAAW,YAAY;AACvB,eAAW,MAAM,UAAU;AAG3B,MAAE,UAAU,EAAE,KAAK,oBAAoB,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAGtF,MAAE,UAAU,EAAE,KAAK,sCAAsC,EAAE,GAAG,SAAS,CAAC,UAAU;AAEhF,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,oBAAoB,EAAE,SAAS,EAAG;AAG9D,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,oBAAoB,EAAE,CAAC;AAClE,UAAI,QAAQ;AACV,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAAA,EACH;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,kBAAkB,OAA6B;AAC3D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,aAAa,OAAO,QAAQ;AAClC,UAAM,UAAU,SAAS,OAAO,QAAQ,WAAW,GAAG;AAEtD,QAAI,CAAC,WAAY;AAEjB,UAAM,SAAS,CAAC,GAAK,KAAK,KAAK,OAAe,UAAU,EAAG;AAE3D,QAAI,OAAO,OAAO,GAAG;AACnB,aAAO,OAAO,IAAI,EAAE,GAAG,OAAO,OAAO,GAAG,UAAU,WAAA;AAAA,IACpD;AAEA,UAAM,KAAK,KAAK,OAAO,EAAE,iBAAiB,QAAe;AACzD,SAAK,OAAO,KAAK;AAEjB,OAAG,eAAe,KAAK,KAAK,KAAM,OAAO,+BAA+B,EAAE,MAAM,WAAA,CAAY,CAAC;AAAA,EAC/F;AAAA;AAAA;AAAA;AAAA,EAKQ,uBAAuB,OAAoB;AACjD,UAAM,QAAQ,MAAM;AAGpB,QAAI,MAAM,MAAM,KAAA,EAAO,SAAS,GAAG;AACjC,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,2BAA2B,EAAE,CAAC;AACnE,UAAI,cAAc,WAAW,UAAU,KAAA,EAAO,SAAS,GAAG;AACxD,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKQ,sBAAsB,OAAoB;AAChD,UAAM,QAAQ,MAAM;AACpB,UAAM,YAAY;AAGlB,eAAW,MAAM;AACf,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,2BAA2B,EAAE,CAAC;AACnE,UAAI,YAAY;AAEd,cAAM,gBAAgB,UAAU;AAChC,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAGA,cAAM,gBAAgB,SAAS;AAC/B,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAEA,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF,GAAG,GAAG;AAAA,EACR;AAAA,EAEA,MAAe,MAAM,SAAmD;AAEtE,MAAE,QAAQ,EAAE,IAAI,wBAAwB;AACxC,WAAO,MAAM,MAAM,OAAO;AAAA,EAC5B;AAAA,EAEA,MAAyB,cAAc,QAAe,UAA6B;AACjF,UAAM,eAAe,QAAQ,MAAM,aAAa,QAAQ;AAGxD,QAAI,aAAa,QAAQ,gBAAgB,QACrC,aAAa,QAAQ,aAAa,WAClC,KAAK,KAAK,OAAO;AAGnB,YAAM,kBAAkB,KAAK,KAAK,MAAM,MAAM;AAAA,QAAO,CAAC,SACpD,KAAK,SAAS,UACd,KAAK,OAAO,KAAK,KAAK,MACtB,KAAK,QAAQ,aAAa,WAC1B,KAAK,QAAQ,gBAAgB;AAAA,MAAA;AAI/B,UAAI,gBAAgB,SAAS,GAAG;AAC9B,mBAAW,aAAa,iBAAiB;AACvC,gBAAM,UAAU,OAAO;AAAA,YACrB,sBAAsB;AAAA,UAAA,CAChB;AAAA,QACV;AAEA,WAAG,eAAe;AAAA,UAChB,KAAK,KAAM,SAAS,mCAAmC,KACvD;AAAA,QAAA;AAAA,MAEJ;AAAA,IACF;AAGA,UAAM,KAAK,KAAK,OAAO,YAAY;AAGnC,SAAK,KAAK,YAAA;AAGV,UAAM,mBAAoB,KAAK,KAAK,OAAe,oBAAoB;AACvE,UAAM,gBAAiB,KAAK,KAAK,OAAe,UAAU;AAG1D,QAAI,kBAAkB,kBAAkB;AACtC,YAAM,KAAK,KAAK,OAAO;AAAA,QACrB,iBAAiB;AAAA,MAAA,CACX;AAAA,IACV;AAEA,WAAO,KAAK;AAAA,EACd;AACF;ACp3BO,MAAM,mBAAmB,UAAU;AAAA,EACxC,WAAoB,iBAA8C;AAChE,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,SAAS,CAAC,QAAQ,SAAS,QAAQ,OAAO;AAAA,MAC1C,UAAU;AAAA,MACV,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA,MACN,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH;AAAA,EAES,UAAe;AACtB,UAAM,UAAU,MAAM,QAAA;AACtB,YAAQ,SAAS,KAAK,KAAK;AAC3B,WAAO;AAAA,EACT;AAAA,EAEA,MAAyB,cAAc,QAAe,UAA6B;AACjF,UAAM,eAAe,QAAQ,MAAM,aAAa,QAAQ;AACxD,WAAO,KAAK,KAAK,OAAO,YAAY;AAAA,EACtC;AACF;ACtBO,MAAM,4BAA4B,UAAU;AAAA,EACjD,WAAoB,iBAA8C;AAChE,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,SAAS,CAAC,QAAQ,SAAS,QAAQ,gBAAgB;AAAA,MACnD,UAAU;AAAA,MACV,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA,MACN,UAAU;AAAA,QACR,EAAE,cAAc,0BAAA;AAAA,MAA0B;AAAA,MAE5C,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH;AAAA,EAES,UAAe;AACtB,UAAM,UAAU,MAAM,QAAA;AACtB,YAAQ,SAAS,KAAK,KAAK;AAG3B,QAAI,QAAQ,OAAO,aAAa;AAE9B,cAAQ,kBAAkB,QAAQ,OAAO;AAGzC,UAAI,KAAK,KAAK,OAAO;AACnB,cAAM,cAAc,KAAK,KAAK,MAAM,MAAM;AAAA,UAAK,CAAC,MAC9C,EAAE,SAAS,WAAW,EAAE,SAAS,QAAQ,OAAO;AAAA,QAAA;AAGlD,YAAI,CAAC,aAAa;AAEhB,kBAAQ,sBAAsB;AAAA,QAChC;AAAA,MACF;AAAA,IACF;AAGA,QAAI,KAAK,KAAK,OAAO;AACnB,YAAM,SAAS,KAAK,KAAK,MAAM,MAAM,OAAO,CAAC,MAAW,EAAE,SAAS,OAAO;AAC1E,cAAQ,SAAS,OAAO,IAAI,CAAC,OAAY;AAAA,QACvC,MAAM,EAAE;AAAA,MAAA,EACR;AAAA,IACJ,OAAO;AACL,cAAQ,SAAS,CAAA;AAAA,IACnB;AAEA,WAAO;AAAA,EACT;AAAA,EAES,kBAAkB,MAAoB;AAC7C,UAAM,kBAAkB,IAAI;AAG5B,SAAK,KAAK,oCAAoC,EAAE,GAAG,SAAS,KAAK,oBAAoB,KAAK,IAAI,CAAC;AAG/F,SAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,KAAK,eAAe,KAAK,IAAI,CAAC;AAC3E,SAAK,KAAK,qBAAqB,EAAE,GAAG,SAAS,KAAK,oBAAoB,KAAK,IAAI,CAAC;AAChF,SAAK,KAAK,qBAAqB,EAAE,GAAG,QAAQ,KAAK,mBAAmB,KAAK,IAAI,CAAC;AAG9E,MAAE,QAAQ,EAAE,GAAG,2BAA2B,CAAC,UAAU;AACnD,YAAM,SAAS,MAAM;AACrB,YAAM,uBAAuB,KAAK,KAAK,yBAAyB,EAAE,CAAC;AACnE,UAAI,wBAAwB,CAAC,qBAAqB,SAAS,MAAM,GAAG;AAClE,aAAK,KAAK,uBAAuB,EAAE,KAAA;AAAA,MACrC;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,MAAe,MAAM,SAAmD;AAEtE,MAAE,QAAQ,EAAE,IAAI,yBAAyB;AACzC,WAAO,MAAM,MAAM,OAAO;AAAA,EAC5B;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,oBAAoB,OAA6B;AAC7D,UAAM,eAAA;AACN,UAAM,KAAK,KAAK,OAAO,EAAE,sBAAsB,IAAW;AAC1D,SAAK,OAAO,KAAK;AAAA,EACnB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAyB,QAAQ,OAAgC;AAC/D,UAAM,OAAO,WAAW,iBAAiB,KAAK;AAG9C,QAAI,QAAQ,KAAK,SAAS,QAAQ;AAChC,YAAM,OAAO,MAAM,KAAK,eAAe,aAAa,IAAI;AAExD,UAAI,CAAC,KAAM,QAAO,MAAM,QAAQ,KAAK;AAGrC,UAAI,KAAK,SAAS,SAAS;AAEzB,cAAM,KAAK,KAAK,OAAO,EAAE,sBAAsB,KAAK,MAAa;AACjE,aAAK,OAAO,KAAK;AACjB,WAAG,eAAe,KAAK,KAAK,KAAM,OAAO,wCAAwC,EAAE,MAAM,KAAK,KAAA,CAAM,CAAC;AACrG;AAAA,MACF,OAAO;AACL,WAAG,eAAe,KAAK,KAAK,KAAM,SAAS,gDAAgD,CAAC;AAC5F;AAAA,MACF;AAAA,IACF;AAEA,WAAO,MAAM,QAAQ,KAAK;AAAA,EAC5B;AAAA,EAEA,MAAyB,cAAc,QAAe,UAA6B;AACjF,UAAM,eAAe,QAAQ,MAAM,aAAa,QAAQ;AACxD,WAAO,KAAK,KAAK,OAAO,YAAY;AAAA,EACtC;AAAA;AAAA;AAAA;AAAA,EAMQ,qBAA0B;AAAA,EAC1B,sBAA8B;AAAA;AAAA;AAAA;AAAA,EAKtC,MAAc,eAAe,OAA6B;AACxD,UAAM,QAAQ,MAAM;AACpB,UAAM,aAAa,MAAM,MAAM,KAAA,EAAO,YAAA;AACtC,UAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAG/D,QAAI,KAAK,oBAAoB;AAC3B,mBAAa,KAAK,kBAAkB;AAAA,IACtC;AAGA,QAAI,WAAW,WAAW,GAAG;AAC3B,iBAAW,MAAM,UAAU;AAC3B;AAAA,IACF;AAGA,SAAK,qBAAqB,WAAW,YAAY;AAC/C,YAAM,KAAK,oBAAoB,YAAY,UAAU;AAAA,IACvD,GAAG,GAAG;AAAA,EACR;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,oBAAoB,YAAoB,YAAwC;AAC5F,UAAM,UAAiB,CAAA;AAGvB,SAAK,sBAAsB;AAG3B,QAAI,KAAK,OAAO;AACd,iBAAW,QAAQ,KAAK,OAAc;AACpC,YAAI,KAAK,SAAS,WAAW,KAAK,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AACzE,kBAAQ,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK;AAAA,YACX,MAAM,KAAK,KAAM,SAAS,kCAAkC;AAAA,YAC5D,iBAAiB,KAAK,OAAO;AAAA,YAC7B,aAAa;AAAA,UAAA,CACd;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,eAAW,QAAQ,KAAK,OAAc;AAEpC,UAAI,KAAK,iBAAiB,OAAQ;AAGlC,YAAMA,aAAY,MAAM,KAAK,aAAA;AAG7B,iBAAW,OAAOA,YAAW;AAC3B,YAAI,IAAI,SAAS,WAAW,IAAI,KAAK,YAAA,EAAc,SAAS,UAAU,GAAG;AACvE,kBAAQ,KAAK;AAAA,YACX,MAAM,IAAI;AAAA,YACV,MAAM,IAAI;AAAA,YACV,MAAM,KAAK;AAAA,YACX,iBAAiB,IAAI,OAAO;AAAA,YAC5B,aAAa;AAAA,UAAA,CACd;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAGA,SAAK,2BAA2B,SAAS,UAAU;AAAA,EACrD;AAAA;AAAA;AAAA;AAAA,EAKQ,2BAA2B,SAAgB,YAAwC;AAEzF,UAAM,sBAAsB,KAAK,oBAC9B,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,gBAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAEX,UAAM,aAAa,QAAQ;AAAA,MAAK,CAAC,MAC/B,EAAE,KAAK,kBAAkB,KAAK,oBAAoB,YAAA;AAAA,IAAY;AAGhE,QAAI,OAAO;AAGX,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA;AAAA;AAAA,cAGC,KAAK,KAAM,SAAS,wCAAwC,CAAC;AAAA;AAAA,8DAEb,KAAK,mBAAmB;AAAA,0CAC5C,KAAK,KAAM,SAAS,mCAAmC,CAAC;AAAA;AAAA;AAAA;AAAA,IAI9F,OAAO;AAEL,iBAAW,UAAU,SAAS;AAC5B,cAAM,iBAAiB,KAAK,KAAM,SAAS,mBAAmB,OAAO,gBAAgB,YAAA,CAAa,EAAE;AAEpG,gBAAQ;AAAA;AAAA;AAAA,0CAG0B,OAAO,IAAI;AAAA,0CACX,OAAO,IAAI,MAAM,cAAc;AAAA;AAAA,8DAEX,OAAO,IAAI;AAAA,gBACzD,KAAK,KAAM,SAAS,iCAAiC,CAAC;AAAA;AAAA;AAAA;AAAA,MAIhE;AAGA,UAAI,CAAC,YAAY;AACf,gBAAQ;AAAA;AAAA;AAAA,6EAG6D,mBAAmB;AAAA,0CACtD,KAAK,KAAM,SAAS,uCAAuC,CAAC;AAAA;AAAA,uEAE/B,KAAK,mBAAmB;AAAA,gBAC/E,KAAK,KAAM,SAAS,mCAAmC,CAAC;AAAA;AAAA;AAAA;AAAA,MAIlE;AAAA,IACF;AAEA,eAAW,YAAY;AACvB,eAAW,MAAM,UAAU;AAG3B,MAAE,UAAU,EAAE,KAAK,iBAAiB,EAAE,GAAG,SAAS,KAAK,uBAAuB,KAAK,IAAI,CAAC;AACxF,MAAE,UAAU,EAAE,KAAK,6CAA6C,EAAE,GAAG,SAAS,KAAK,kBAAkB,KAAK,IAAI,CAAC;AAG/G,MAAE,UAAU,EAAE,KAAK,mEAAmE,EAAE,GAAG,SAAS,CAAC,UAAU;AAE7G,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,iBAAiB,EAAE,SAAS,EAAG;AAG3D,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,iBAAiB,EAAE,CAAC;AAC/D,UAAI,QAAQ;AACV,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAGD,MAAE,UAAU,EAAE,KAAK,qCAAqC,EAAE,GAAG,SAAS,CAAC,UAAU;AAE/E,UAAI,EAAE,MAAM,MAAM,EAAE,QAAQ,0BAA0B,EAAE,SAAS,EAAG;AAGpE,YAAM,SAAS,EAAE,MAAM,aAAa,EAAE,KAAK,0BAA0B,EAAE,CAAC;AACxE,UAAI,QAAQ;AACV,UAAE,MAAM,EAAE,QAAQ,OAAO;AAAA,MAC3B;AAAA,IACF,CAAC;AAED,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,uBAAuB,OAA6B;AAChE,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,YAAY,OAAO,QAAQ;AAEjC,QAAI,CAAC,UAAW;AAGhB,UAAM,KAAK,KAAK,OAAO,EAAE,sBAAsB,WAAkB;AAGjE,UAAM,cAAc,KAAK,QAAQ,KAAK,qBAAqB,EAAE,CAAC;AAC9D,QAAI,aAAa;AACf,kBAAY,QAAQ;AAAA,IACtB;AAEA,UAAM,aAAa,KAAK,QAAQ,KAAK,uBAAuB,EAAE,CAAC;AAC/D,QAAI,YAAY;AACd,iBAAW,MAAM,UAAU;AAAA,IAC7B;AAEA,SAAK,OAAO,KAAK;AACjB,OAAG,eAAe,KAAK,KAAK,KAAM,OAAO,qCAAqC,EAAE,MAAM,UAAA,CAAW,CAAC;AAAA,EACpG;AAAA;AAAA;AAAA;AAAA,EAKQ,oBAAoB,OAA6B;AACvD,UAAM,QAAQ,MAAM;AAGpB,QAAI,MAAM,MAAM,KAAA,EAAO,SAAS,GAAG;AACjC,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAC/D,UAAI,cAAc,WAAW,UAAU,KAAA,EAAO,SAAS,GAAG;AACxD,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF;AAEA,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKQ,mBAAmB,OAA6B;AACtD,UAAM,QAAQ,MAAM;AACpB,UAAM,YAAY;AAGlB,eAAW,MAAM;AACf,YAAM,aAAa,EAAE,KAAK,EAAE,SAAS,uBAAuB,EAAE,CAAC;AAC/D,UAAI,YAAY;AAEd,cAAM,gBAAgB,UAAU;AAChC,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAGA,cAAM,gBAAgB,SAAS;AAC/B,YAAI,iBAAiB,WAAW,SAAS,aAAa,GAAG;AAEvD;AAAA,QACF;AAEA,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAAA,IACF,GAAG,GAAG;AAEN,WAAO,QAAQ,QAAA;AAAA,EACjB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAc,kBAAkB,OAA6B;AAC3D,UAAM,eAAA;AACN,UAAM,gBAAA;AAEN,UAAM,SAAS,MAAM;AACrB,UAAM,YAAY,OAAO,QAAQ;AAEjC,QAAI,CAAC,UAAW;AAGhB,UAAM,gBAAgB,UACnB,MAAM,GAAG,EACT,IAAI,CAAA,SAAQ,KAAK,OAAO,CAAC,EAAE,YAAA,IAAgB,KAAK,MAAM,CAAC,EAAE,YAAA,CAAa,EACtE,KAAK,GAAG;AAGX,UAAM,YAAY;AAAA,MAChB,MAAM;AAAA,MACN,MAAM;AAAA,MACN,QAAQ;AAAA,QACN,QAAQ;AAAA,QACR,iBAAiB;AAAA,QACjB,aAAa;AAAA,MAAA;AAAA,IACf;AAIF,UAAM,eAAe,MAAM,KAAK,OAAO,SAAS;AAEhD,QAAI,cAAc;AAEhB,YAAM,KAAK,KAAK,OAAO,EAAE,sBAAsB,eAAsB;AAGrE,YAAM,cAAc,KAAK,QAAQ,KAAK,qBAAqB,EAAE,CAAC;AAC9D,UAAI,aAAa;AACf,oBAAY,QAAQ;AAAA,MACtB;AAEA,YAAM,aAAa,KAAK,QAAQ,KAAK,uBAAuB,EAAE,CAAC;AAC/D,UAAI,YAAY;AACd,mBAAW,MAAM,UAAU;AAAA,MAC7B;AAEA,WAAK,OAAO,KAAK;AAGjB,iBAAW,MAAM;AACf,YAAI,aAAa,OAAO;AACtB,uBAAa,MAAM,OAAO,IAAI;AAAA,QAChC;AAAA,MACF,GAAG,GAAG;AAEN,SAAG,eAAe,KAAK,KAAK,KAAM,OAAO,iDAAiD,EAAE,MAAM,cAAA,CAAe,CAAC;AAAA,IACpH;AAAA,EACF;AACF;ACnbO,MAAM,sBAAsB,UAAU;AAAA,EAC3C,WAAoB,iBAA8C;AAChE,WAAO,QAAQ,MAAM,YAAY,MAAM,gBAAgB;AAAA,MACrD,SAAS,CAAC,QAAQ,SAAS,QAAQ,UAAU;AAAA,MAC7C,UAAU;AAAA,MACV,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,CAAA;AAAA,MACN,gBAAgB;AAAA,IAAA,CACjB;AAAA,EACH;AAAA,EAES,UAAe;AACtB,UAAM,UAAU,MAAM,QAAA;AACtB,YAAQ,SAAS,KAAK,KAAK;AAC3B,WAAO;AAAA,EACT;AAAA,EAEA,MAAyB,cAAc,QAAe,UAA6B;AACjF,UAAM,eAAe,QAAQ,MAAM,aAAa,QAAQ;AACxD,WAAO,KAAK,KAAK,OAAO,YAAY;AAAA,EACtC;AACF;;;;;;;;;ACzBO,MAAM,QAAQ;AAAA,EACnB,YAAY;AACd;ACAA,MAAM,yBAAyB;AAExB,MAAM,UAAU;AAAA,EACrB,IAAI,OAAO;AAAE,WAAO;AAAA,EAAU;AAAA,EAE9B,IAAI,UAAU;AAAE,WAAO;AAAA,EAAS;AAAA,EAEhC,MAAM,UAAU;AAAE,WAAO,MAAM;AAAA,IAAE;AAAA,EAAE;AAAA,EAEnC,MAAM,kBAAkB,iBAAiB,CAAC,UAAU,CAAA,GAAI;AACtD,UAAM,KAAK,OAAO,QAAQ,OAAO,UAAU;AACzC,YAAM,mBAAmB,eAAe,MAAM,KAAK;AACnD,UAAI,iBAAiB,SAAS,GAAG;AAC/B,cAAM,UAAU,KAAK,KAAK,OAAO,uCAAuC,EAAE,MAAM,MAAM,MAAM;AAC5F,gBAAQ,IAAI,OAAO,IAAI,MAAM,KAAK,MAAM,SAAS,gBAAgB;AACjE,cAAM,MAAM,wBAAwB,QAAQ,gBAAgB;AAAA,MAC9D;AAAA,IACF,CAAC;AAED,UAAM,cAAc,eAAe,KAAK,KAAK;AAC7C,QAAI,YAAY,SAAS,GAAG;AAC1B,YAAM,UAAU,KAAK,KAAK,SAAS,+BAA+B;AAClE,cAAQ,IAAI,OAAO,IAAI,MAAM,KAAK,MAAM,SAAS,WAAW;AAC5D,YAAM,KAAK,gBAAgB,WAAW;AAAA,IACxC;AAAA,EACF;AACF;AAEO,MAAM,WAAW;AAAA,EACtB,cAAc;AAKZ,SAAK,SAAS,SAAS,OAAO,IAAI,wBAAwB;AAAA,MACxD,MAAM;AAAA,MACN,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM;AAAA,MACN,SAAS;AAAA,IACf,CAAK;AAAA,EACH;AAAA,EAEA,UAAU;AACR,UAAM,iBAAiB,KAAK,SAAS,IAAI,OAAO,IAAI,sBAAsB;AAC1E,QAAI,QAAQ,MAAM,eAAe,KAAK,OAAO,SAAS,cAAc,GAAG;AAErE,UAAI,aAAa,CAAA;AACjB,YAAM;AAAA,QAAQ,MAAM;AAAA,QAAY,IAAI,SAClC,aAAa,WAAW,OAAO,KAAK,OAAO,OAAK,QAAQ,MAAM,eAAe,EAAE,SAAS,cAAc,CAAC,CAAC;AAAA,MAChH;AACM,YAAM,IAAI,MAAM,YAAY,MAAM;AAAA,MAAE,CAAC;AAErC,UAAI,WAAW,SAAS,GAAG;AACzB,mBAAW,KAAK,CAAC,GAAG,MAAM,QAAQ,MAAM,eAAe,EAAE,SAAS,EAAE,OAAO,IAAI,IAAI,QAAQ,MAAM,eAAe,EAAE,SAAS,EAAE,OAAO,IAAI,KAAK,CAAC;AAC9I,mBAAW,QAAQ,OAAM,MAAK;AAC5B,gBAAME,WAAU,KAAK,KAAK,OAAO,4BAA4B,EAAE,MAAM,EAAE,MAAM,gBAAgC,eAAe,EAAE,QAAO,CAAE;AACvI,eAAK,QAAQA,QAAO;AACpB,gBAAM,EAAE,QAAO;AAAA,QACjB,CAAC;AACD,cAAM,UAAU,KAAK,KAAK,OAAO,uBAAuB,EAAE,SAAS,KAAK,OAAO,SAAS;AACxF,aAAK,QAAQ,OAAO;AAAA,MACtB,OACK;AACH,cAAM,UAAU,KAAK,KAAK,OAAO,6BAA6B,EAAE,SAAS,KAAK,OAAO,SAAS;AAC9F,gBAAQ,IAAI,OAAO,IAAI,OAAO,OAAO;AAAA,MACvC;AACA,WAAK,SAAS,IAAI,OAAO,IAAI,wBAAwB,KAAK,OAAO,OAAO;AAAA,IAC1E,OACK;AACH,YAAM,UAAU,KAAK,KAAK,SAAS,kCAAkC;AACrE,cAAQ,IAAI,OAAO,IAAI,OAAO,OAAO;AAAA,IACvC;AAAA,EACF;AAAA,EAGA,QAAQ,SAAS;AACf,OAAG,cAAc,KAAK,OAAO;AAC7B,YAAQ,IAAI,OAAO,IAAI,OAAO,OAAO;AAAA,EACvC;AACF;AC3EO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,yEAAyE;AAEvG,QAAI,gBAAgB;AACpB,QAAI,eAAe;AAEnB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AACnC,aAAK;AAGpB,cAAM,eACH,aAAa,WAAW,UAAa,MAAM,QAAQ,aAAa,MAAM,KACtE,aAAa,YAAY,UAAa,MAAM,QAAQ,aAAa,OAAO,KACxE,aAAa,aAAa,UAAa,MAAM,QAAQ,aAAa,QAAQ;AAI7E,cAAM,uBACJ,aAAa,WAAW,UACxB,MAAM,QAAQ,aAAa,MAAM;AAInC,YAAI,wBAAwB,CAAC,cAAc;AACzC,kBAAQ,IAAI,OAAO,IAAI,OAAO,+BAA+B,KAAK,IAAI,qCAAqC,aAAa,OAAO,MAAM,wBAAwB;AAC7J;AACA;AAAA,QACF;AAGA,YAAI,CAAC,cAAc;AACjB,kBAAQ,IAAI,OAAO,IAAI,OAAO,+BAA+B,KAAK,IAAI,gCAAgC;AACtG;AACA;AAAA,QACF;AAGA,cAAM,SAAS,MAAM,QAAQ,aAAa,MAAM,IAAI,aAAa,SAAS,CAAA;AAC1E,cAAM,UAAU,MAAM,QAAQ,aAAa,OAAO,IAAI,aAAa,UAAU,CAAA;AAC7E,cAAM,WAAW,MAAM,QAAQ,aAAa,QAAQ,IAAI,aAAa,WAAW,CAAA;AAEhF,gBAAQ,IAAI,OAAO,IAAI,OAAO,4BAA4B,KAAK,IAAI,sBAAsB;AAAA,UACvF;AAAA,UACA;AAAA,UACA;AAAA,QACV,CAAS;AAGD,cAAM,SAAS,CAAA;AACf,cAAM,YAAY,KAAK,IAAI,OAAO,QAAQ,QAAQ,QAAQ,SAAS,MAAM;AAEzE,iBAAS,IAAI,GAAG,IAAI,WAAW,KAAK;AAElC,gBAAM,OAAO,OAAO,CAAC;AACrB,cAAI,QAAQ,SAAS,QAAQ;AAC3B,mBAAO,KAAK;AAAA,cACV,QAAQ;AAAA,cACR,SAAS,QAAQ,CAAC,MAAM,SAAY,QAAQ,CAAC,IAAI;AAAA,cACjD,UAAU,SAAS,CAAC,MAAM,SAAY,SAAS,CAAC,IAAI;AAAA,YAClE,CAAa;AAAA,UACH;AAAA,QACF;AAGA,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA,UACV,iBAAiB;AAAA;AAAA,UAEjB,wBAAwB;AAAA,UACxB,yBAAyB;AAAA,UACzB,0BAA0B;AAAA;AAAA,UAE1B,iBAAiB;AAAA,UACjB,kBAAkB;AAAA,UAClB,mBAAmB;AAAA,QAC7B;AAEQ,gBAAQ,KAAK,MAAM;AACnB;AAEA,gBAAQ,IAAI,OAAO,IAAI,OAAO,sCAAsC,KAAK,IAAI,IAAI;AACjF,gBAAQ,IAAI,OAAO,IAAI,OAAO,4FAA4F,EAAE,QAAQ,SAAS,SAAQ,CAAE;AACvJ,gBAAQ,IAAI,OAAO,IAAI,OAAO,iBAAiB,OAAO,MAAM,cAAc,MAAM;AAAA,MAClF;AAEA,aAAO;AAAA,IACT,CAAC;AAED,UAAM,iBAAiB,0CAA0C,aAAa,cAAc,YAAY;AACxG,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,gBAAgB,GAAG;AACrB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,SAAS,4BAA4B,IAC/C;AACF,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAAA,IACxD;AAAA,EACF;AACF;ACtHO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,kEAAkE;AAEhG,QAAI,eAAe;AACnB,QAAI,eAAe;AAEnB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAGlD,cAAM,eACJ,aAAa,WAAW,UACxB,aAAa,YAAY,UACzB,aAAa,aAAa;AAG5B,cAAM,aACJ,aAAa,kBAAkB,UAC/B,aAAa,mBAAmB,UAChC,aAAa,oBAAoB;AAInC,YAAI,CAAC,gBAAgB,CAAC,YAAY;AAChC;AACA;AAAA,QACF;AAGA,cAAM,YAAY,aAAa,WAAW,UAAa,MAAM,QAAQ,aAAa,MAAM;AAExF,YAAI,CAAC,WAAW;AACd,kBAAQ,KAAK,OAAO,IAAI,OAAO,+BAA+B,KAAK,IAAI,wDAAwD;AAC/H;AACA;AAAA,QACF;AAEA,gBAAQ,IAAI,OAAO,IAAI,OAAO,uCAAuC,KAAK,IAAI,IAAI;AAClF,YAAI,cAAc;AAChB,kBAAQ,IAAI,OAAO,IAAI,OAAO,kDAAkD;AAAA,QAClF;AACA,YAAI,YAAY;AACd,kBAAQ,IAAI,OAAO,IAAI,OAAO,oEAAoE;AAAA,QACpG;AACA,gBAAQ,IAAI,OAAO,IAAI,OAAO,yBAAyB,aAAa,OAAO,MAAM,UAAU;AAG3F,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA;AAAA,UAEV,iBAAiB;AAAA,UACjB,kBAAkB;AAAA,UAClB,mBAAmB;AAAA;AAAA,UAEnB,wBAAwB;AAAA,UACxB,yBAAyB;AAAA,UACzB,0BAA0B;AAAA,QACpC;AAEQ,gBAAQ,KAAK,MAAM;AACnB;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAED,UAAM,iBAAiB,yCAAyC,YAAY,cAAc,YAAY;AACtG,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,eAAe,GAAG;AACpB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,SAAS,4BAA4B,IAC/C;AACF,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAAA,IACxD;AAAA,EACF;AACF;AC/FO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,qEAAqE;AAEnG,QAAI,iBAAiB;AACrB,QAAI,eAAe;AAEnB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAGlD,YAAI,aAAa,aAAa,kBAAkB;AAC9C;AACA;AAAA,QACF;AAEA,gBAAQ,IAAI,OAAO,IAAI,OAAO,sCAAsC,KAAK,IAAI,qCAAqC;AAIlH,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA,UACV,mBAAmB;AAAA,QAC7B;AAEQ,gBAAQ,KAAK,MAAM;AACnB;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAED,UAAM,iBAAiB,2CAA2C,cAAc,uCAAuC,YAAY;AACnI,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,iBAAiB,GAAG;AACtB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,SAAS,4BAA4B,IAC/C,+BAA+B,cAAc;AAC/C,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAAA,IACxD;AAAA,EACF;AACF;AC5DO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,oEAAoE;AAClG,YAAQ,IAAI,OAAO,IAAI,OAAO,8EAA8E;AAM5G,UAAM,UAAU;AAChB,YAAQ,IAAI,OAAO,IAAI,OAAO,OAAO;AAErC,QAAI,GAAG,eAAe;AACpB,SAAG,cAAc,KAAK,SAAS,EAAC,WAAW,MAAK,CAAC;AAAA,IACnD;AAAA,EACF;AACF;ACxBO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,8EAA8E;AAE5G,QAAI,iBAAiB;AACrB,QAAI,eAAe;AACnB,QAAI,oBAAoB,CAAA;AAExB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAGlD,YAAI,aAAa,aAAa,kBAAkB;AAC9C;AACA;AAAA,QACF;AAGA,cAAM,WAAW;AAAA,UACf,MAAM,KAAK;AAAA,UACX,IAAI,KAAK;AAAA,UACT,SAAS;AAAA,UACT,SAAS;AAAA,UACT,gBAAgB,aAAa,iBAAiB;AAAA,UAC9C,iBAAiB,aAAa,eAAe,KAAK;AAAA,UAClD,WACE,aAAa,eAAe,UAC5B,aAAa,eAAe,UAC5B,aAAa,gBAAgB,UAC7B,aAAa,cAAc;AAAA,QAEvC;AAEQ,gBAAQ,IAAI,OAAO,IAAI,OAAO,iCAAiC,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AAC5F,gBAAQ,IAAI,OAAO,IAAI,OAAO,8BAA8B;AAC5D,gBAAQ,IAAI,OAAO,IAAI,OAAO,sBAAsB;AACpD,gBAAQ,IAAI,OAAO,IAAI,OAAO,yBAAyB,SAAS,cAAc,EAAE;AAChF,gBAAQ,IAAI,OAAO,IAAI,OAAO,yBAAyB,SAAS,cAAc,EAAE;AAChF,gBAAQ,IAAI,OAAO,IAAI,OAAO,mBAAmB,SAAS,SAAS,EAAE;AAErE,0BAAkB,KAAK,QAAQ;AAG/B,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA;AAAA,UAEV,mBAAmB;AAAA;AAAA,UAEnB,6BAA6B;AAAA;AAAA,UAE7B,uBAAsB,oBAAI,KAAI,GAAG,YAAW;AAAA,UAC5C,4BAA4B;AAAA,QACtC;AAEQ,gBAAQ,KAAK,MAAM;AACnB;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,iBAAiB,2CAA2C,cAAc,cAAc,YAAY;AAC1G,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,kBAAkB,SAAS,GAAG;AAChC,cAAQ,IAAI,OAAO,IAAI,OAAO,4BAA4B;AAC1D,cAAQ,IAAI,OAAO,IAAI,OAAO,0BAA0B,kBAAkB,MAAM,EAAE;AAElF,YAAM,kBAAkB,kBAAkB,OAAO,OAAK,EAAE,cAAc,EAAE;AACxE,YAAM,aAAa,kBAAkB,OAAO,OAAK,EAAE,cAAc,EAAE;AACnE,YAAM,aAAa,kBAAkB,OAAO,OAAK,EAAE,SAAS,EAAE;AAE9D,cAAQ,IAAI,OAAO,IAAI,OAAO,gCAAgC,eAAe,EAAE;AAC/E,cAAQ,IAAI,OAAO,IAAI,OAAO,gCAAgC,UAAU,EAAE;AAC1E,cAAQ,IAAI,OAAO,IAAI,OAAO,0BAA0B,UAAU,EAAE;AACpE,cAAQ,IAAI,OAAO,IAAI,OAAO,2BAA2B;AAGzD,cAAQ,IAAI,OAAO,IAAI,OAAO,kBAAkB;AAChD,wBAAkB,QAAQ,CAAC,QAAQ,UAAU;AAC3C,gBAAQ,IAAI,OAAO,IAAI,OAAO,KAAK,QAAQ,CAAC,MAAM,OAAO,IAAI,UAAU,OAAO,EAAE,GAAG;AAAA,MACrF,CAAC;AAAA,IACH;AAGA,QAAI,iBAAiB,GAAG;AACtB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,OAAO,8BAA8B,EAAE,OAAO,gBAAgB,IACxE,+BAA+B,cAAc;AAE/C,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAEtD,cAAQ,IAAI,OAAO,IAAI,OAAO,sDAAsD;AACpF,cAAQ,IAAI,OAAO,IAAI,OAAO,+CAA+C;AAC7E,cAAQ,IAAI,OAAO,IAAI,OAAO,sCAAsC;AAAA,IACtE,OAAO;AACL,cAAQ,IAAI,OAAO,IAAI,OAAO,qEAAqE;AAAA,IACrG;AAAA,EACF;AACF;ACtHO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,kGAAkG;AAEhI,QAAI,iBAAiB;AACrB,QAAI,eAAe;AACnB,QAAI,aAAa;AACjB,QAAI,oBAAoB,CAAA;AAExB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAElD,YAAI,cAAc;AAClB,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA,QACpB;AAGQ,YAAI,aAAa,oBAAoB,aAAa,iBAAiB,SAAS,GAAG;AAE7E,gBAAM,cAAc,aAAa,iBAAiB,CAAC;AACnD,cAAI,EAAE,OAAO,gBAAgB,YAAY,gBAAgB,QAAQ,UAAU,cAAc;AAEvF,kBAAM,mBAAmB,aAAa,iBAAiB,IAAI,YAAU;AACnE,kBAAI,OAAO,WAAW,UAAU;AAC9B,uBAAO;AAAA,kBACL,MAAM;AAAA,kBACN,YAAY;AAAA,gBAC9B;AAAA,cACc;AAEA,qBAAO;AAAA,gBACL,MAAM,QAAQ,QAAQ,QAAQ,SAAQ,KAAM;AAAA,gBAC5C,YAAY,QAAQ,cAAc;AAAA,cAClD;AAAA,YACY,CAAC;AAED,mBAAO,yBAAyB,IAAI;AACpC,mBAAO,oCAAoC,KAAI,oBAAI,KAAI,GAAG,YAAW;AACrE,mBAAO,0CAA0C,IAAI;AACrD,0BAAc;AAGd,oBAAQ,IAAI,OAAO,IAAI,OAAO,sDAAsD,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AACjH,oBAAQ,IAAI,OAAO,IAAI,OAAO,qBAAqB,aAAa,iBAAiB,MAAM,EAAE;AAEzF,8BAAkB,KAAK;AAAA,cACrB,MAAM,KAAK;AAAA,cACX,IAAI,KAAK;AAAA,cACT,aAAa,aAAa,iBAAiB;AAAA,YACzD,CAAa;AACD;AAAA,UACF;AAAA,QACF;AAGA,YAAI,aAAa,qBAAqB,QAClC,aAAa,qBAAqB,UAClC,OAAO,aAAa,qBAAqB,YACzC,CAAC,OAAO,UAAU,aAAa,gBAAgB,GAAG;AACpD,iBAAO,yBAAyB,IAAI;AACpC,wBAAc;AACd;AACA,kBAAQ,IAAI,OAAO,IAAI,OAAO,kDAAkD,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AAAA,QAC/G;AAEA,YAAI,aAAa;AACf,kBAAQ,KAAK,MAAM;AAAA,QACrB,OAAO;AACL;AAAA,QACF;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,iBAAiB,4DAA4D,cAAc,6BAA6B,UAAU,cAAc,YAAY;AAClK,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,kBAAkB,SAAS,GAAG;AAChC,cAAQ,IAAI,OAAO,IAAI,OAAO,4BAA4B;AAC1D,cAAQ,IAAI,OAAO,IAAI,OAAO,0BAA0B,kBAAkB,MAAM,EAAE;AAElF,YAAM,eAAe,kBAAkB,OAAO,CAAC,KAAK,MAAM,MAAM,EAAE,aAAa,CAAC;AAEhF,cAAQ,IAAI,OAAO,IAAI,OAAO,yCAAyC,YAAY,EAAE;AACrF,cAAQ,IAAI,OAAO,IAAI,OAAO,2BAA2B;AAGzD,cAAQ,IAAI,OAAO,IAAI,OAAO,kBAAkB;AAChD,wBAAkB,QAAQ,CAAC,QAAQ,UAAU;AAC3C,gBAAQ,IAAI,OAAO,IAAI,OAAO,KAAK,QAAQ,CAAC,MAAM,OAAO,IAAI,UAAU,OAAO,EAAE,OAAO,OAAO,WAAW,YAAY;AAAA,MACvH,CAAC;AAAA,IACH;AAEA,QAAI,aAAa,GAAG;AAClB,cAAQ,IAAI,OAAO,IAAI,OAAO,6BAA6B,UAAU,UAAU;AAAA,IACjF;AAGA,QAAI,iBAAiB,KAAK,aAAa,GAAG;AACxC,UAAI,cAAc;AAClB,UAAI,iBAAiB,KAAK,aAAa,GAAG;AACxC,sBAAc,KAAK,OACjB,KAAK,KAAK,OAAO,8BAA8B,EAAE,OAAO,gBAAgB,OAAO,YAAY,IAC3F,oDAAoD,cAAc,0CAA0C,UAAU;AAAA,MAC1H,WAAW,iBAAiB,GAAG;AAC7B,sBAAc,KAAK,OACjB,KAAK,KAAK,OAAO,8BAA8B,EAAE,OAAO,gBAAgB,IACxE,oDAAoD,cAAc;AAAA,MACtE,WAAW,aAAa,GAAG;AACzB,sBAAc,+CAA+C,UAAU;AAAA,MACzE;AAEA,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAEtD,cAAQ,IAAI,OAAO,IAAI,OAAO,uBAAuB;AACrD,UAAI,iBAAiB,GAAG;AACtB,gBAAQ,IAAI,OAAO,IAAI,OAAO,kDAAkD;AAChF,gBAAQ,IAAI,OAAO,IAAI,OAAO,uDAAuD;AAAA,MACvF;AACA,UAAI,aAAa,GAAG;AAClB,gBAAQ,IAAI,OAAO,IAAI,OAAO,4DAA4D;AAAA,MAC5F;AACA,cAAQ,IAAI,OAAO,IAAI,OAAO,sCAAsC;AAAA,IACtE,OAAO;AACL,cAAQ,IAAI,OAAO,IAAI,OAAO,oDAAoD;AAAA,IACpF;AAAA,EACF;AACF;ACnJO,MAAM,yBAAyB,UAAU;AAAA,EAC9C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,yFAAyF;AAEvH,QAAI,eAAe;AACnB,QAAI,eAAe;AACnB,QAAI,sBAAsB;AAC1B,QAAI,gBAAgB,CAAA;AAEpB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAEhB,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAElD,YAAI,cAAc;AAClB,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA,QACpB;AAGQ,YAAI,aAAa,oBAAoB,aAAa,iBAAiB,SAAS,GAAG;AAC7E,gBAAM,iBAAiB,aAAa,iBAAiB,IAAI,YAAU;AAEjE,gBAAI,OAAO,WAAW,YAAY,WAAW,QAAQ,EAAE,WAAW,SAAS;AACzE,4BAAc;AACd,qBAAO;AAAA,gBACL,GAAG;AAAA,gBACH,OAAO;AAAA;AAAA,cACvB;AAAA,YACY;AACA,mBAAO;AAAA,UACT,CAAC;AAED,cAAI,aAAa;AACf,mBAAO,yBAAyB,IAAI;AACpC,mBAAO,yCAAyC,KAAI,oBAAI,KAAI,GAAG,YAAW;AAG1E,oBAAQ,IAAI,OAAO,IAAI,OAAO,iEAAiE,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AAC5H,oBAAQ,IAAI,OAAO,IAAI,OAAO,qBAAqB,eAAe,MAAM,EAAE;AAE1E,0BAAc,KAAK;AAAA,cACjB,MAAM,KAAK;AAAA,cACX,IAAI,KAAK;AAAA,cACT,aAAa,eAAe;AAAA,cAC5B,cAAc;AAAA,YAC5B,CAAa;AAAA,UACH;AAAA,QACF;AAGA,YAAI,aAAa,gBAAgB,UAAa,aAAa,gBAAgB,MAAM;AAC/E,iBAAO,oBAAoB,IAAI;AAC/B,wBAAc;AACd;AAEA,kBAAQ,IAAI,OAAO,IAAI,OAAO,kDAAkD,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AAG7G,gBAAM,iBAAiB,cAAc,KAAK,OAAK,EAAE,OAAO,KAAK,EAAE;AAC/D,cAAI,gBAAgB;AAClB,2BAAe,eAAe;AAAA,UAChC,OAAO;AACL,0BAAc,KAAK;AAAA,cACjB,MAAM,KAAK;AAAA,cACX,IAAI,KAAK;AAAA,cACT,aAAa;AAAA,cACb,cAAc;AAAA,YAC5B,CAAa;AAAA,UACH;AAAA,QACF;AAEA,YAAI,aAAa;AACf,iBAAO,+CAA+C,IAAI;AAC1D,kBAAQ,KAAK,MAAM;AACnB;AAAA,QACF,OAAO;AACL;AAAA,QACF;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,iBAAiB,+CAA+C,YAAY,wBAAwB,mBAAmB,cAAc,YAAY;AACvJ,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,cAAc,SAAS,GAAG;AAC5B,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB;AACtD,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB,cAAc,MAAM,EAAE;AAE5E,YAAM,eAAe,cAAc,OAAO,CAAC,KAAK,MAAM,MAAM,EAAE,aAAa,CAAC;AAC5E,YAAM,qBAAqB,cAAc,OAAO,OAAK,EAAE,YAAY,EAAE;AAErE,cAAQ,IAAI,OAAO,IAAI,OAAO,wCAAwC,YAAY,EAAE;AACpF,cAAQ,IAAI,OAAO,IAAI,OAAO,2CAA2C,kBAAkB,EAAE;AAC7F,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB;AAGtD,cAAQ,IAAI,OAAO,IAAI,OAAO,gBAAgB;AAC9C,oBAAc,QAAQ,CAAC,QAAQ,UAAU;AACvC,cAAM,UAAU,CAAA;AAChB,YAAI,OAAO,cAAc,EAAG,SAAQ,KAAK,GAAG,OAAO,WAAW,YAAY;AAC1E,YAAI,OAAO,aAAc,SAAQ,KAAK,mBAAmB;AACzD,gBAAQ,IAAI,OAAO,IAAI,OAAO,KAAK,QAAQ,CAAC,MAAM,OAAO,IAAI,UAAU,OAAO,EAAE,OAAO,QAAQ,KAAK,IAAI,CAAC,EAAE;AAAA,MAC7G,CAAC;AAAA,IACH;AAGA,QAAI,eAAe,GAAG;AACpB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,OAAO,8BAA8B,EAAE,OAAO,cAAc,gBAAgB,qBAAqB,IAC3G,6BAA6B,YAAY,8EAA8E,mBAAmB;AAE5I,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAEtD,cAAQ,IAAI,OAAO,IAAI,OAAO,uBAAuB;AACrD,cAAQ,IAAI,OAAO,IAAI,OAAO,8DAA8D;AAC5F,cAAQ,IAAI,OAAO,IAAI,OAAO,yDAAyD;AACvF,cAAQ,IAAI,OAAO,IAAI,OAAO,qCAAqC;AAAA,IACrE,OAAO;AACL,cAAQ,IAAI,OAAO,IAAI,OAAO,oDAAoD;AAAA,IACpF;AAAA,EACF;AACF;AC5IO,MAAM,0BAA0B,UAAU;AAAA,EAC/C,IAAI,OAAO;AACT,WAAO;AAAA,EACT;AAAA,EAEA,IAAI,UAAU;AACZ,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,UAAU;AACd,YAAQ,IAAI,OAAO,IAAI,OAAO,wDAAwD;AAEtF,QAAI,eAAe;AACnB,QAAI,eAAe;AACnB,QAAI,gBAAgB,CAAA;AAEpB,UAAM,KAAK,kBAAkB,CAAC,UAAU;AACtC,YAAM,UAAU,CAAA;AAGhB,YAAM,YAAY,MAAM,OAAO,UAAQ,KAAK,SAAS,MAAM;AAC3D,cAAQ,IAAI,OAAO,IAAI,OAAO,SAAS,UAAU,MAAM,sBAAsB;AAE7E,iBAAW,QAAQ,OAAO;AAExB,YAAI,KAAK,SAAS,QAAQ;AACxB;AAAA,QACF;AAGA,cAAM,eAAe,KAAK,SAAS,UAAU,KAAK;AAGlD,YAAI,aAAa,0BAA0B,WAAW;AACpD;AACA;AAAA,QACF;AAEA,YAAI,cAAc;AAClB,cAAM,SAAS;AAAA,UACb,KAAK,KAAK;AAAA,QACpB;AAEQ,cAAM,cAAc,aAAa,QAAQ;AACzC,cAAM,WAAW,aAAa,YAAY;AAC1C,YAAI,UAAU;AACd,YAAI,SAAS;AAGb,gBAAQ,IAAI,OAAO,IAAI,OAAO,aAAa,KAAK,IAAI,cAAc,WAAW,aAAa,QAAQ,GAAG;AAGrG,YAAI,gBAAgB,yBAAyB;AAC3C,oBAAU;AACV,wBAAc;AACd,mBAAS;AAAA,QACX,WAES,gBAAgB,QAAQ;AAG/B,oBAAU;AACV,wBAAc;AACd,mBAAS;AAAA,QACX,WAEyB,CAAC,CAAC,kBAAkB,aAAa,oBAAoB,EAAE,SAAS,WAAW,GAAG;AACrG,oBAAU;AACV,wBAAc;AACd,mBAAS,4BAA4B,WAAW;AAAA,QAClD;AAEA,YAAI,aAAa;AACf,iBAAO,aAAa,IAAI;AACxB,iBAAO,8BAA8B,IAAI;AAEzC,kBAAQ,IAAI,OAAO,IAAI,OAAO,yCAAyC,KAAK,IAAI,UAAU,KAAK,EAAE,GAAG;AACpG,kBAAQ,IAAI,OAAO,IAAI,OAAO,aAAa,QAAQ,EAAE;AACrD,kBAAQ,IAAI,OAAO,IAAI,OAAO,iBAAiB,WAAW,EAAE;AAC5D,kBAAQ,IAAI,OAAO,IAAI,OAAO,iBAAiB,OAAO,EAAE;AACxD,kBAAQ,IAAI,OAAO,IAAI,OAAO,eAAe,MAAM,EAAE;AAErD,wBAAc,KAAK;AAAA,YACjB,MAAM,KAAK;AAAA,YACX,IAAI,KAAK;AAAA,YACT;AAAA,YACA,SAAS;AAAA,YACT;AAAA,YACA;AAAA,UACZ,CAAW;AAED,kBAAQ,KAAK,MAAM;AACnB;AAAA,QACF;AAAA,MACF;AAEA,aAAO;AAAA,IACT,CAAC;AAGD,UAAM,iBAAiB,gDAAgD,YAAY,cAAc,YAAY;AAC7G,YAAQ,IAAI,OAAO,IAAI,OAAO,cAAc;AAG5C,QAAI,cAAc,SAAS,GAAG;AAC5B,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB;AACtD,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB,cAAc,MAAM,EAAE;AAE5E,YAAM,wBAAwB,cAAc,OAAO,OAAK,EAAE,YAAY,uBAAuB,EAAE;AAC/F,YAAM,aAAa,cAAc,OAAO,OAAK,EAAE,YAAY,MAAM,EAAE;AAEnE,cAAQ,IAAI,OAAO,IAAI,OAAO,mDAAmD,qBAAqB,EAAE;AACxG,cAAQ,IAAI,OAAO,IAAI,OAAO,8BAA8B,UAAU,EAAE;AACxE,cAAQ,IAAI,OAAO,IAAI,OAAO,wBAAwB;AAGtD,cAAQ,IAAI,OAAO,IAAI,OAAO,gBAAgB;AAC9C,oBAAc,QAAQ,CAAC,QAAQ,UAAU;AACvC,gBAAQ,IAAI,OAAO,IAAI,OAAO,KAAK,QAAQ,CAAC,MAAM,OAAO,IAAI,MAAM,OAAO,QAAQ,MAAM,OAAO,OAAO,MAAM,OAAO,OAAO,EAAE;AAAA,MAC9H,CAAC;AAAA,IACH;AAGA,QAAI,eAAe,GAAG;AACpB,YAAM,cAAc,KAAK,OACvB,KAAK,KAAK,OAAO,+BAA+B;AAAA,QAC9C,OAAO;AAAA,QACP,kBAAkB,cAAc,OAAO,OAAK,EAAE,YAAY,uBAAuB,EAAE;AAAA,QACnF,WAAW,cAAc,OAAO,OAAK,EAAE,YAAY,MAAM,EAAE;AAAA,MACrE,CAAS,IACD,8BAA8B,YAAY;AAE5C,SAAG,eAAe,KAAK,aAAa,EAAC,WAAW,MAAK,CAAC;AAEtD,cAAQ,IAAI,OAAO,IAAI,OAAO,uBAAuB;AACrD,cAAQ,IAAI,OAAO,IAAI,OAAO,0EAA0E;AACxG,cAAQ,IAAI,OAAO,IAAI,OAAO,uDAAuD;AACrF,cAAQ,IAAI,OAAO,IAAI,OAAO,qCAAqC;AAAA,IACrE,OAAO;AACL,cAAQ,IAAI,OAAO,IAAI,OAAO,oDAAoD;AAAA,IACpF;AAAA,EACF;AACF;ACpJA,WAAW,SAASH;AA0Bb,MAAM,WAAW;AAAA,EACtB,OAAO,QAAc;AACnB,QAAI,WAAA;AAAA,EACN;AAAA,EAEA,cAAc;AACZ,QAAI,KAAK,QAAQ;AACf,WAAK,OAAO,OAAO;AAAA,IACrB;AACA,UAAM,KAAK,QAAQ,MAAM,KAAK,QAAQ;AAAA,EACxC;AAAA,EAEA,SAAe;AACb,YAAQ,IAAIA,SAAO,IAAI,OAAO,mBAAmB;AACjD,QAAI,KAAK,QAAQ;AACf,WAAK,OAAO,MAAM;AAAA,QAChB;AAAA,QACA;AAAA,QACA;AAAA,MAAA;AAAA,IAEJ;AAGA,QAAI,WAAA;AACJ,UAAM,GAAG,MAAM,YAAY,CAAC,qBAA0B;AACpD,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,kBAAkB;AACvC,uBAAiB,IAAI,mBAAmB;AAAA,IAC1C,CAAC;AAGD,WAAO,MAAM,gBAAgBI;AAG7B,WAAO,MAAM,aAAa;AAAA,MACxB,WAAWC;AAAAA,MACX,KAAKC;AAAAA,IAAO;AAId,WAAO,KAAK,aAAa;AAAA,MACvB,OAAOC;AAAAA,MACP,MAAMC;AAAAA,MACN,gBAAgBC;AAAAA,MAChB,UAAUC;AAAAA,IAAO;AAInB,wBAAoB,cAAc,OAAO,QAAQC,gBAA6B;AAAA,MAC5E,OAAO,CAAC,WAAW;AAAA,MACnB,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AAGD,wBAAoB,cAAc,MAAM,QAAQC,WAAwB;AAAA,MACtE,OAAO,CAAC,MAAM;AAAA,MACd,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AAGD,wBAAoB,cAAc,MAAM,QAAQC,YAAyB;AAAA,MACvE,OAAO,CAAC,OAAO;AAAA,MACf,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AAGD,wBAAoB,cAAc,MAAM,QAAQC,qBAAkC;AAAA,MAChF,OAAO,CAAC,gBAAgB;AAAA,MACxB,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AAGD,wBAAoB,cAAc,MAAM,QAAQC,eAA4B;AAAA,MAC1E,OAAO,CAAC,UAAU;AAAA,MAClB,aAAa;AAAA,MACb,OAAO;AAAA,IAAA,CACR;AAGD,eAAW,eAAe,OAAO,SAAS,GAAW,GAAW;AAC9D,aAAO,IAAI;AAAA,IACb,CAAC;AAED,eAAW,eAAe,MAAM,SAAS,GAAQ,GAAQ;AACvD,aAAO,MAAM;AAAA,IACf,CAAC;AAED,eAAW,eAAe,MAAM,SAAS,GAAQ,GAAQ;AACvD,aAAO,IAAI;AAAA,IACb,CAAC;AAED,eAAW,eAAe,OAAO,SAAS,GAAQ,GAAQ;AACxD,aAAO,KAAK;AAAA,IACd,CAAC;AAGD,UAAM,GAAG,qBAAqB,CAAC,SAAc,SAAc;AACzD,WAAK,KAAK,mBAAmB,EAAE,GAAG,SAAS,OAAO,UAAe;AAC/D,cAAM,eAAA;AACN,cAAM,SAAS,EAAE,MAAM,aAAa;AACpC,cAAM,aAAa,OAAO,KAAK,aAAa;AAC5C,cAAM,SAAS,SAAS,OAAO,KAAK,QAAQ,CAAC;AAC7C,cAAM,eAAe,OAAO,KAAK,eAAe;AAEhD,cAAMJ,eAA4B,YAAY,YAAY,QAAQ,YAAY;AAAA,MAChF,CAAC;AAAA,IACH,CAAC;AAED,UAAM,KAAK,SAAS,MAAM,KAAK,SAAS;AAAA,EAC1C;AAAA,EAEA,MAAM,UAAyB;AAC7B,YAAQ,IAAIX,SAAO,IAAI,OAAO,oBAAoB;AAGlD,UAAM,aAAa,IAAI,WAAA;AACvB,eAAW,QAAA;AAGX,UAAM,KAAK,0BAAA;AAGX,UAAM,KAAK,4BAAA;AAAA,EACb;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,4BAA2C;AAC/C,UAAM,gBAAuB,CAAA;AAG7B,eAAW,QAAQ,KAAK,OAAe;AACrC,UAAK,KAAa,SAAS,QAAQ;AACjC,cAAM,SAAU,KAAa;AAC7B,YAAI,cAAc;AAClB,cAAM,UAAe,EAAE,KAAM,KAAa,GAAA;AAG1C,YAAI,OAAO,WAAW,UAAa,CAAC,MAAM,QAAQ,OAAO,MAAM,GAAG;AAChE,wBAAc;AAEd,cAAI,OAAO,WAAW,QAAQ;AAC5B,oBAAQ,eAAe,IAAI,CAAC,OAAO,MAAM;AACzC,oBAAQ,gBAAgB,IAAI,CAAC,OAAO,WAAW,CAAC;AAChD,oBAAQ,iBAAiB,IAAI,CAAC,OAAO,YAAY,EAAE;AAAA,UACrD,OAAO;AACL,oBAAQ,eAAe,IAAI,CAAA;AAC3B,oBAAQ,gBAAgB,IAAI,CAAA;AAC5B,oBAAQ,iBAAiB,IAAI,CAAA;AAAA,UAC/B;AAAA,QACF;AAEA,YAAI,aAAa;AACf,wBAAc,KAAK,OAAO;AAAA,QAC5B;AAAA,MACF;AAAA,IACF;AAGA,eAAW,SAAS,KAAK,QAAgB;AACvC,YAAM,eAAsB,CAAA;AAE5B,iBAAW,QAAS,MAAc,OAAO;AACvC,YAAK,KAAa,SAAS,QAAQ;AACjC,gBAAM,SAAU,KAAa;AAC7B,cAAI,cAAc;AAClB,gBAAM,UAAe,EAAE,KAAM,KAAa,GAAA;AAG1C,cAAI,OAAO,WAAW,UAAa,CAAC,MAAM,QAAQ,OAAO,MAAM,GAAG;AAChE,0BAAc;AAEd,gBAAI,OAAO,WAAW,QAAQ;AAC5B,sBAAQ,eAAe,IAAI,CAAC,OAAO,MAAM;AACzC,sBAAQ,gBAAgB,IAAI,CAAC,OAAO,WAAW,CAAC;AAChD,sBAAQ,iBAAiB,IAAI,CAAC,OAAO,YAAY,EAAE;AAAA,YACrD,OAAO;AACL,sBAAQ,eAAe,IAAI,CAAA;AAC3B,sBAAQ,gBAAgB,IAAI,CAAA;AAC5B,sBAAQ,iBAAiB,IAAI,CAAA;AAAA,YAC/B;AAAA,UACF;AAEA,cAAI,aAAa;AACf,yBAAa,KAAK,OAAO;AAAA,UAC3B;AAAA,QACF;AAAA,MACF;AAEA,UAAI,aAAa,SAAS,GAAG;AAC3B,gBAAQ,IAAI,GAAGA,SAAO,IAAI,IAAI,cAAc,aAAa,MAAM,mBAAoB,MAAc,IAAI,EAAE;AACvG,cAAO,MAAc,wBAAwB,QAAQ,YAAY;AAAA,MACnE;AAAA,IACF;AAEA,QAAI,cAAc,SAAS,GAAG;AAC5B,cAAQ,IAAI,GAAGA,SAAO,IAAI,IAAI,cAAc,cAAc,MAAM,cAAc;AAC9E,YAAM,KAAK,gBAAgB,aAAa;AAAA,IAC1C;AAEA,QAAI,cAAc,SAAS,KAAM,KAAK,OAAgB,KAAK,CAAC,MAAW,EAAE,MAAM,KAAK,CAAC,MAAW,EAAE,SAAS,MAAM,CAAC,GAAG;AACnH,cAAQ,IAAI,GAAGA,SAAO,IAAI,IAAI,0CAA0C;AAAA,IAC1E;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,8BAA6C;AACjD,UAAM,iBAAwB,CAAA;AAG9B,eAAW,SAAS,KAAK,QAAgB;AACvC,UAAK,MAAc,SAAS,aAAa;AACvC,cAAM,SAAU,MAAc;AAG9B,YAAI,OAAO,kBAAkB,UAAa,OAAO,iBAAiB,QAAW;AAC3E,yBAAe,KAAK;AAAA,YAClB,KAAM,MAAc;AAAA,YACpB,uBAAuB,OAAO;AAAA,UAAA,CAC/B;AAAA,QACH;AAAA,MACF;AAAA,IACF;AAEA,QAAI,eAAe,SAAS,GAAG;AAC7B,cAAQ,IAAI,GAAGA,SAAO,IAAI,IAAI,gDAAgD,eAAe,MAAM,SAAS;AAC5G,YAAM,MAAM,gBAAgB,cAAc;AAC1C,cAAQ,IAAI,GAAGA,SAAO,IAAI,IAAI,mDAAmD;AAAA,IACnF;AAAA,EACF;AACF;AC7QA,WAAW,MAAA;"}