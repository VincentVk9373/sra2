{"version":3,"file":"index.mjs","sources":["../src/module/config/system.ts","../src/module/config/ui-config.ts","../src/module/models/actor-character.ts","../src/module/models/item-feat.ts","../src/module/models/actor-vehicle.ts","../src/module/models/item-skill.ts","../src/module/models/item-specialization.ts","../src/module/models/item-metatype.ts","../src/module/documents/actor.ts","../src/module/helpers/dice-roller.ts","../src/module/helpers/item-search.ts","../src/module/helpers/sheet-helpers.ts","../src/module/helpers/combat-helpers.ts","../src/module/applications/character-sheet.ts","../src/module/applications/npc-sheet.ts","../src/module/applications/vehicle-sheet.ts","../src/module/applications/feat-sheet.ts","../src/module/applications/skill-sheet.ts","../src/module/applications/specialization-sheet.ts","../src/module/applications/metatype-sheet.ts","../src/module/applications/roll-dialog.ts","../src/module/hooks.mjs","../src/module/migration/migration.mjs","../src/module/migration/migration-13.0.3.mjs","../src/module/migration/migration-13.0.4.mjs","../src/module/migration/migration-13.0.5.mjs","../src/module/migration/migration-13.0.6.mjs","../src/module/migration/migration-13.0.7.mjs","../src/module/migration/migration-13.0.8.mjs","../src/module/migration/migration-13.0.9.mjs","../src/module/migration/migration-13.0.10.mjs","../src/module/migration/migration-13.0.11.mjs","../src/module/migration/migration-13.0.12.mjs","../src/module/sra2-system.ts","../src/start.ts"],"sourcesContent":["const SYSTEM_ID = 'sra2';\n\nexport interface SystemConfig {\n  id: string;\n  LOG: {\n    HEAD: string;\n  };\n  SOCKET: string;\n  PATH: {\n    ROOT: string;\n    STYLE: string;\n    TEMPLATES: string;\n    ASSETS: string;\n  };\n}\n\nexport const SYSTEM: SystemConfig = {\n  id: SYSTEM_ID,\n  LOG: {\n    HEAD: `${SYSTEM_ID} | `\n  },\n  SOCKET: `system.${SYSTEM_ID}`,\n  PATH: {\n    ROOT: `systems/${SYSTEM_ID}`,\n    STYLE: `systems/${SYSTEM_ID}/style`,\n    TEMPLATES: `systems/${SYSTEM_ID}/templates`,\n    ASSETS: `systems/${SYSTEM_ID}/assets`,\n  }\n};\n\n","import { SYSTEM } from './system.ts';\n\n/**\n * Configure sidebar icons for Foundry VTT UI\n */\nexport function setSidebarIcons(): void {\n  CONFIG.Actor.sidebarIcon = 'fas fa-user';\n  CONFIG.Adventure.sidebarIcon = 'fas fa-tree';\n  CONFIG.Cards.sidebarIcon = 'fa-solid fa-cards';\n  CONFIG.ChatMessage.sidebarIcon = 'fas fa-comments';\n  CONFIG.Combat.sidebarIcon = 'fas fa-gun';\n  CONFIG.Folder.sidebarIcon = 'fas fa-folder';\n  CONFIG.Item.sidebarIcon = 'fas fa-suitcase';\n  CONFIG.JournalEntry.sidebarIcon = 'fas fa-book-open';\n  CONFIG.JournalEntryPage.sidebarIcon = 'fas fa-book-open';\n  CONFIG.Macro.sidebarIcon = 'fas fa-code';\n  CONFIG.Playlist.sidebarIcon = 'fas fa-music';\n  CONFIG.PlaylistSound.sidebarIcon = 'fas fa-music';\n  CONFIG.RollTable.sidebarIcon = 'fas fa-th-list';\n  CONFIG.Scene.sidebarIcon = 'fas fa-map';\n\n  console.log(SYSTEM.LOG.HEAD + 'Configured sidebar icons');\n}\n\n/**\n * Configure control icons for Foundry VTT tokens\n */\nexport function setControlIcons(): void {\n  CONFIG.controlIcons = {\n    combat: 'icons/svg/combat.svg',\n    visibility: 'icons/svg/cowled.svg',\n    effects: 'icons/svg/aura.svg',\n    lock: 'icons/svg/padlock.svg',\n    up: 'icons/svg/up.svg',\n    down: 'icons/svg/down.svg',\n    defeated: 'icons/svg/skull.svg',\n    light: 'icons/svg/light.svg',\n    lightOff: 'icons/svg/light-off.svg',\n    template: 'icons/svg/explosion.svg',\n    sound: 'icons/svg/sound-off.svg',\n    soundOff: 'icons/svg/combat.svg',\n    doorClosed: 'icons/svg/door-closed-outline.svg',\n    doorOpen: 'icons/svg/door-open-outline.svg',\n    doorSecret: 'icons/svg/door-secret-outline.svg',\n    doorLocked: 'icons/svg/door-locked-outline.svg'\n  };\n\n  console.log(SYSTEM.LOG.HEAD + 'Configured control icons');\n}\n\n/**\n * Configure compendium banners\n */\nexport function setCompendiumBanners(): void {\n  // Note: If you have a banner image, uncomment and adjust the path\n  // CONFIG.Actor.compendiumBanner = `${SYSTEM.PATH.ROOT}/img/interface/sra2/banner-actors.webp`;\n  \n  console.log(SYSTEM.LOG.HEAD + 'Configured compendium banners');\n}\n\n","/**\n * Data model for Character actors\n */\nexport class CharacterDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      attributes: new fields.SchemaField({\n        strength: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        agility: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        willpower: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        logic: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        }),\n        charisma: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 1,\n          integer: true\n        })\n      }),\n      resources: new fields.SchemaField({\n        yens: new fields.NumberField({\n          required: true,\n          initial: 0,\n          min: 0,\n          integer: true\n        }),\n        anarchy: new fields.NumberField({\n          required: true,\n          initial: 0,\n          min: 0,\n          integer: true\n        })\n      }),\n      maxEssence: new fields.NumberField({\n        required: true,\n        initial: 6,\n        min: 0,\n        integer: true\n      }),\n      armorLevel: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 5,\n        integer: true\n      }),\n      damage: new fields.SchemaField({\n        light: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false, false]\n        }),\n        severe: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false]\n        }),\n        incapacitating: new fields.BooleanField({\n          required: true,\n          initial: false\n        })\n      }),\n      anarchySpent: new fields.ArrayField(new fields.BooleanField({\n        required: true,\n        initial: false\n      }), {\n        required: true,\n        initial: [false, false, false]\n      }),\n      bio: new fields.SchemaField({\n        background: new fields.HTMLField({\n          required: true,\n          initial: \"\"\n        }),\n        notes: new fields.HTMLField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      keywords: new fields.SchemaField({\n        keyword1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        keyword5: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      behaviors: new fields.SchemaField({\n        behavior1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        behavior4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      }),\n      catchphrases: new fields.SchemaField({\n        catchphrase1: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase2: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase3: new fields.StringField({\n          required: true,\n          initial: \"\"\n        }),\n        catchphrase4: new fields.StringField({\n          required: true,\n          initial: \"\"\n        })\n      })\n    };\n  }\n\n  /**\n   * Calculate the cost of an attribute based on its level\n   * Each level costs 10000, except the last level (maximum) which costs 20000\n   */\n  private calculateAttributeCost(level: number, maxLevel: number): number {\n    let cost = 0;\n    for (let i = 1; i <= level; i++) {\n      if (i === maxLevel) {\n        cost += 20000;\n      } else {\n        cost += 10000;\n      }\n    }\n    return cost;\n  }\n\n  override prepareDerivedData(): void {\n    // Get metatype to determine attribute maximums and anarchy bonus\n    const parent = (this as any).parent;\n    let attributeMaxes = {\n      strength: 99,\n      agility: 99,\n      willpower: 99,\n      logic: 99,\n      charisma: 99\n    };\n    let anarchyBonus = 0;\n    \n    if (parent && parent.items) {\n      const metatype = parent.items.find((item: any) => item.type === 'metatype');\n      if (metatype && metatype.system) {\n        attributeMaxes = {\n          strength: metatype.system.maxStrength || 99,\n          agility: metatype.system.maxAgility || 99,\n          willpower: metatype.system.maxWillpower || 99,\n          logic: metatype.system.maxLogic || 99,\n          charisma: metatype.system.maxCharisma || 99\n        };\n        anarchyBonus = metatype.system.anarchyBonus || 0;\n      }\n    }\n    \n    (this as any).attributeMaxes = attributeMaxes;\n    \n    // Calculate damage boxes, thresholds bonuses, essence cost, anarchy bonus, and narrations from active feats\n    let bonusLightDamage = 0;\n    let bonusSevereDamage = 0;\n    let bonusPhysicalThreshold = 0;\n    let bonusMentalThreshold = 0;\n    let bonusAnarchy = 0;\n    let totalEssenceCost = 0;\n    let totalNarrations = 0;\n    const narrationsDetails: Array<{ name: string; actions: number }> = [];\n    \n    if (parent && parent.items) {\n      const activeFeats = parent.items.filter((item: any) => \n        item.type === 'feat' && item.system.active === true\n      );\n      \n      activeFeats.forEach((feat: any) => {\n        bonusLightDamage += feat.system.bonusLightDamage || 0;\n        bonusSevereDamage += feat.system.bonusSevereDamage || 0;\n        bonusPhysicalThreshold += feat.system.bonusPhysicalThreshold || 0;\n        bonusMentalThreshold += feat.system.bonusMentalThreshold || 0;\n        bonusAnarchy += feat.system.bonusAnarchy || 0;\n        totalEssenceCost += feat.system.essenceCost || 0;\n        \n        // Count narrations\n        if (feat.system.grantsNarration) {\n          totalNarrations++;\n          narrationsDetails.push({\n            name: feat.name,\n            actions: feat.system.narrationActions || 1\n          });\n        }\n      });\n    }\n    \n    // Calculate total anarchy (base 3 + metatype bonus + feats bonus)\n    (this as any).totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\n    (this as any).anarchyBonus = anarchyBonus;\n    (this as any).featsAnarchyBonus = bonusAnarchy;\n    \n    // Store narrations information (base 1 + feats bonus)\n    (this as any).totalNarrations = 1 + totalNarrations;\n    (this as any).bonusNarrations = totalNarrations;\n    (this as any).narrationsDetails = narrationsDetails;\n    \n    // Base: 2 light, 1 severe, 1 incapacitating\n    const totalLightBoxes = 2 + bonusLightDamage;\n    const totalSevereBoxes = 1 + bonusSevereDamage;\n    \n    // Ensure damage arrays match the required size\n    const damage = (this as any).damage || {};\n    \n    // Adjust light damage array\n    if (!Array.isArray(damage.light)) {\n      damage.light = [false, false];\n    }\n    while (damage.light.length < totalLightBoxes) {\n      damage.light.push(false);\n    }\n    while (damage.light.length > totalLightBoxes) {\n      damage.light.pop();\n    }\n    \n    // Adjust severe damage array\n    if (!Array.isArray(damage.severe)) {\n      damage.severe = [false];\n    }\n    while (damage.severe.length < totalSevereBoxes) {\n      damage.severe.push(false);\n    }\n    while (damage.severe.length > totalSevereBoxes) {\n      damage.severe.pop();\n    }\n    \n    (this as any).totalLightBoxes = totalLightBoxes;\n    (this as any).totalSevereBoxes = totalSevereBoxes;\n    \n    // Adjust anarchy spent array to match total anarchy\n    const totalAnarchy = 3 + anarchyBonus + bonusAnarchy;\n    const anarchySpent = (this as any).anarchySpent || [];\n    \n    if (!Array.isArray(anarchySpent)) {\n      (this as any).anarchySpent = [];\n    }\n    while ((this as any).anarchySpent.length < totalAnarchy) {\n      (this as any).anarchySpent.push(false);\n    }\n    while ((this as any).anarchySpent.length > totalAnarchy) {\n      (this as any).anarchySpent.pop();\n    }\n    \n    // Calculate armor cost (2500 per level)\n    const armorLevel = (this as any).armorLevel || 0;\n    (this as any).armorCost = armorLevel * 2500;\n    \n    // Calculate damage thresholds (with bonuses from feats)\n    const strength = (this as any).attributes?.strength || 1;\n    const willpower = (this as any).attributes?.willpower || 1;\n    \n    (this as any).damageThresholds = {\n      withoutArmor: {\n        light: strength + bonusPhysicalThreshold,\n        moderate: strength + bonusPhysicalThreshold + 3,\n        severe: strength + bonusPhysicalThreshold + 6\n      },\n      withArmor: {\n        light: strength + armorLevel + bonusPhysicalThreshold,\n        moderate: strength + armorLevel + bonusPhysicalThreshold + 3,\n        severe: strength + armorLevel + bonusPhysicalThreshold + 6\n      },\n      mental: {\n        light: willpower + bonusMentalThreshold,\n        moderate: willpower + bonusMentalThreshold + 3,\n        severe: willpower + bonusMentalThreshold + 6\n      }\n    };\n    \n    // Calculate current essence\n    const maxEssence = (this as any).maxEssence || 6;\n    (this as any).currentEssence = Math.max(0, maxEssence - totalEssenceCost);\n    \n    // Calculate costs for each attribute\n    const attributes = (this as any).attributes;\n    if (attributes) {\n      // Clamp attributes to their maximums\n      attributes.strength = Math.min(attributes.strength || 1, attributeMaxes.strength);\n      attributes.agility = Math.min(attributes.agility || 1, attributeMaxes.agility);\n      attributes.willpower = Math.min(attributes.willpower || 1, attributeMaxes.willpower);\n      attributes.logic = Math.min(attributes.logic || 1, attributeMaxes.logic);\n      attributes.charisma = Math.min(attributes.charisma || 1, attributeMaxes.charisma);\n      \n      (this as any).attributeCosts = {\n        strength: this.calculateAttributeCost(attributes.strength || 1, attributeMaxes.strength),\n        agility: this.calculateAttributeCost(attributes.agility || 1, attributeMaxes.agility),\n        willpower: this.calculateAttributeCost(attributes.willpower || 1, attributeMaxes.willpower),\n        logic: this.calculateAttributeCost(attributes.logic || 1, attributeMaxes.logic),\n        charisma: this.calculateAttributeCost(attributes.charisma || 1, attributeMaxes.charisma)\n      };\n      \n      // Calculate total cost of attributes\n      const attributeCosts = (this as any).attributeCosts;\n      let totalCost = Object.values(attributeCosts).reduce((sum: number, cost: any) => sum + cost, 0);\n      \n      // Add armor cost\n      totalCost += (this as any).armorCost || 0;\n      \n      // Add items cost (skills and feats)\n      if (parent && parent.items) {\n        parent.items.forEach((item: any) => {\n          if (item.system && item.system.calculatedCost !== undefined) {\n            totalCost += item.system.calculatedCost;\n          }\n        });\n      }\n      \n      (this as any).totalCost = totalCost;\n    }\n  }\n}\n\n","/**\n * Weapon types configuration with their stats\n * Includes recommended skill and specialization for attack AND defense\n * Specializations are prefixed with \"Spé : \" to easily find them in game.items\n */\nexport const WEAPON_TYPES = {\n  \"custom-weapon\": { \n    vd: \"0\", melee: \"none\", short: \"none\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Combat rapproché - Mains nues\n  \"bare-hands\": { \n    vd: \"FOR\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Mains nues\",\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\n  },\n  // Combat rapproché - Lames\n  \"short-weapons\": { \n    vd: \"FOR+1\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\n  },\n  \"long-weapons\": { \n    vd: \"FOR+2\", melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Lames\",\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\n  },\n  // Combat rapproché - Armes contondantes\n  \"advanced-melee\": { \n    vd: 5, melee: \"ok\", short: \"none\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\n  },\n  \"tasers\": { \n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"none\", long: \"none\",\n    linkedSkill: \"Combat rapproché\", linkedSpecialization: \"Spé : Armes contondantes\",\n    linkedDefenseSkill: \"Combat rapproché\", linkedDefenseSpecialization: \"Spé : Défense\"\n  },\n  // Armes à distance - Armes de jet\n  \"throwing\": { \n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"grenades\": { \n    vd: 7, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"gas-grenades\": { \n    vd: \"toxin\", melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de jet\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Armes de trait\n  \"bows\": { \n    vd: \"FOR+1\", melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"crossbows\": { \n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"ok\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes de trait\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Pistolets\n  \"pocket-pistols\": { \n    vd: 3, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"light-pistols\": { \n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"automatic-pistols\": { \n    vd: 4, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"heavy-pistols\": { \n    vd: 5, melee: \"ok\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Pistolets\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Mitraillettes\n  \"smgs\": { \n    vd: 5, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Mitraillettes\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Fusils\n  \"assault-rifles\": { \n    vd: 7, melee: \"disadvantage\", short: \"ok\", medium: \"ok\", long: \"disadvantage\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"shotguns\": { \n    vd: 8, melee: \"disadvantage\", short: \"ok\", medium: \"disadvantage\", long: \"none\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"sniper-rifles\": { \n    vd: 10, melee: \"none\", short: \"disadvantage\", medium: \"disadvantage\", long: \"ok\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Fusils\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Lance-grenades\n  \"grenade-launchers\": { \n    vd: 7, melee: \"none\", short: \"disadvantage\", medium: \"ok\", long: \"disadvantage\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Lance-grenades\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  // Armes à distance - Armes lourdes\n  \"machine-guns\": { \n    vd: 9, melee: \"none\", short: \"ok\", medium: \"ok\", long: \"ok\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  },\n  \"rocket-launchers\": { \n    vd: 12, melee: \"none\", short: \"none\", medium: \"disadvantage\", long: \"ok\",\n    linkedSkill: \"Armes à distance\", linkedSpecialization: \"Spé : Armes lourdes\",\n    linkedDefenseSkill: \"Athlétisme\", linkedDefenseSpecialization: \"Spé : Défense à distance\"\n  }\n} as const;\n\n/**\n * Vehicle/Drone types configuration with their stats\n * Imported from JSON file\n */\nimport vehicleTypesData from '../config/vehicle-types.json';\n\nexport type VehicleType = keyof typeof vehicleTypesData;\nexport type VehicleStats = {\n  autopilot: number;\n  structure: number;\n  handling: number;\n  speed: number;\n  flyingSpeed: number;\n  armor: number;\n  weaponMount: string;\n};\n\nexport const VEHICLE_TYPES: Record<VehicleType, VehicleStats> = vehicleTypesData as Record<VehicleType, VehicleStats>;\n\n/**\n * Data model for Feat items\n */\nexport class FeatDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      bookmarked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\n      }),\n      rating: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.RATING\"\n      }),\n      cost: new fields.StringField({\n        required: true,\n        initial: \"free-equipment\",\n        choices: {\n          \"free-equipment\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\",\n          \"equipment\": \"SRA2.FEATS.COST.EQUIPMENT\",\n          \"advanced-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\n          // Legacy values kept for migration compatibility (not shown in UI)\n          \"specialized-equipment\": \"SRA2.FEATS.COST.ADVANCED_EQUIPMENT\",\n          \"feat\": \"SRA2.FEATS.COST.FREE_EQUIPMENT\"\n        },\n        label: \"SRA2.FEATS.COST.LABEL\"\n      }),\n      active: new fields.BooleanField({\n        required: true,\n        initial: true,\n        label: \"SRA2.FEATS.ACTIVE\"\n      }),\n      rrList: new fields.ArrayField(new fields.SchemaField({\n        rrType: new fields.StringField({\n          required: true,\n          initial: \"skill\",\n          choices: {\n            \"attribute\": \"SRA2.FEATS.RR_TYPE.ATTRIBUTE\",\n            \"skill\": \"SRA2.FEATS.RR_TYPE.SKILL\",\n            \"specialization\": \"SRA2.FEATS.RR_TYPE.SPECIALIZATION\"\n          },\n          label: \"SRA2.FEATS.RR_TYPE.LABEL\"\n        }),\n        rrValue: new fields.NumberField({\n          required: true,\n          initial: 1,\n          min: 0,\n          max: 3,\n          integer: true,\n          label: \"SRA2.FEATS.RR_VALUE\"\n        }),\n        rrTarget: new fields.StringField({\n          required: false,\n          initial: \"\",\n          nullable: false,\n          label: \"SRA2.FEATS.RR_TARGET\"\n        })\n      }), {\n        initial: [],\n        label: \"SRA2.FEATS.RR_LIST\"\n      }),\n      bonusLightDamage: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_LIGHT_DAMAGE\"\n      }),\n      bonusSevereDamage: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_SEVERE_DAMAGE\"\n      }),\n      bonusPhysicalThreshold: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_PHYSICAL_THRESHOLD\"\n      }),\n      bonusMentalThreshold: new fields.NumberField({\n        required: true,\n        initial: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_MENTAL_THRESHOLD\"\n      }),\n      bonusAnarchy: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.BONUS_ANARCHY\"\n      }),\n      essenceCost: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.ESSENCE_COST\"\n      }),\n      featType: new fields.StringField({\n        required: true,\n        initial: \"equipment\",\n        choices: {\n          \"trait\": \"SRA2.FEATS.FEAT_TYPE.TRAIT\",\n          \"contact\": \"SRA2.FEATS.FEAT_TYPE.CONTACT\",\n          \"awakened\": \"SRA2.FEATS.FEAT_TYPE.AWAKENED\",\n          \"adept-power\": \"SRA2.FEATS.FEAT_TYPE.ADEPT_POWER\",\n          \"equipment\": \"SRA2.FEATS.FEAT_TYPE.EQUIPMENT\",\n          \"cyberware\": \"SRA2.FEATS.FEAT_TYPE.CYBERWARE\",\n          \"cyberdeck\": \"SRA2.FEATS.FEAT_TYPE.CYBERDECK\",\n          \"vehicle\": \"SRA2.FEATS.FEAT_TYPE.VEHICLE\",\n          \"weapons-spells\": \"SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS\",\n          \"weapon\": \"SRA2.FEATS.FEAT_TYPE.WEAPON\",\n          \"spell\": \"SRA2.FEATS.FEAT_TYPE.SPELL\"\n        },\n        label: \"SRA2.FEATS.FEAT_TYPE.LABEL\"\n      }),\n      weaponType: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.WEAPON_TYPE\"\n      }),\n      vehicleType: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.VEHICLE.VEHICLE_TYPE\"\n      }),\n      // Weapon/Spell specific fields\n      damageValue: new fields.StringField({\n        required: true,\n        initial: \"0\",\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE\"\n      }),\n      damageValueBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.WEAPON.DAMAGE_VALUE_BONUS\"\n      }),\n      meleeRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.MELEE_RANGE\"\n      }),\n      shortRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.SHORT_RANGE\"\n      }),\n      mediumRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.MEDIUM_RANGE\"\n      }),\n      longRange: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        choices: {\n          \"none\": \"SRA2.FEATS.WEAPON.RANGE_NONE\",\n          \"ok\": \"SRA2.FEATS.WEAPON.RANGE_OK\",\n          \"dice\": \"SRA2.FEATS.WEAPON.RANGE_DICE\",\n          \"disadvantage\": \"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE\"\n        },\n        label: \"SRA2.FEATS.WEAPON.LONG_RANGE\"\n      }),\n      rangeImprovements: new fields.SchemaField({\n        melee: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        short: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        medium: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        long: new fields.BooleanField({\n          required: true,\n          initial: false\n        })\n      }, {\n        required: true,\n        label: \"SRA2.FEATS.WEAPON.RANGE_IMPROVEMENTS\"\n      }),\n      // Vehicle/Drone specific fields\n      autopilot: new fields.NumberField({\n        required: true,\n        initial: 6,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT\"\n      }),\n      structure: new fields.NumberField({\n        required: true,\n        initial: 2,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.STRUCTURE\"\n      }),\n      handling: new fields.NumberField({\n        required: true,\n        initial: 5,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.HANDLING\"\n      }),\n      speed: new fields.NumberField({\n        required: true,\n        initial: 3,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.SPEED\"\n      }),\n      flyingSpeed: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.FLYING_SPEED\"\n      }),\n      armor: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ARMOR\"\n      }),\n      weaponMount: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\n      }),\n      weaponInfo: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\n      }),\n      // Vehicle bonuses\n      autopilotBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 6,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\n      }),\n      speedBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\n      }),\n      handlingBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\n      }),\n      armorBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\n      }),\n      isFixed: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\n      }),\n      isFlying: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\n      }),\n      weaponMountImprovement: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\n      }),\n      autopilotUnlocked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\n      }),\n      additionalDroneCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\n      }),\n      // Cyberdeck specific fields\n      firewall: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.CYBERDECK.FIREWALL\"\n      }),\n      attack: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.CYBERDECK.ATTACK\"\n      }),\n      // Contact specific fields\n      contactName: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.CONTACT.NAME\"\n      }),\n      // Awakened specific fields\n      astralPerception: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PERCEPTION\"\n      }),\n      astralProjection: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ASTRAL_PROJECTION\"\n      }),\n      sorcery: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.SORCERY\"\n      }),\n      conjuration: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.CONJURATION\"\n      }),\n      adept: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.ADEPT\"\n      }),\n      // Additional fields for recommended level calculation\n      riggerConsoleCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.RIGGER_CONSOLE_COUNT\"\n      }),\n      hasVehicleControlWiring: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.HAS_VEHICLE_CONTROL_WIRING\"\n      }),\n      isWeaponFocus: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.IS_WEAPON_FOCUS\"\n      }),\n      // Narrative effects\n      narrativeEffects: new fields.ArrayField(new fields.SchemaField({\n        text: new fields.StringField({\n          required: false,\n          initial: \"\"\n        }),\n        isNegative: new fields.BooleanField({\n          required: true,\n          initial: false\n        }),\n        value: new fields.NumberField({\n          required: true,\n          initial: -1,\n          min: -5,\n          max: -1,\n          integer: true\n        })\n      }), {\n        initial: [],\n        label: \"SRA2.FEATS.NARRATIVE_EFFECTS\"\n      }),\n      // Grants narration\n      grantsNarration: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.GRANTS_NARRATION\"\n      }),\n      narrationActions: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 1,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.NARRATION_ACTIONS\"\n      }),\n      // Additional sustained spells and summoned spirits\n      sustainedSpellCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 2,\n        integer: true,\n        label: \"SRA2.FEATS.SUSTAINED_SPELL_COUNT\"\n      }),\n      summonedSpiritCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 1,\n        integer: true,\n        label: \"SRA2.FEATS.SUMMONED_SPIRIT_COUNT\"\n      }),\n      // First feat flag\n      isFirstFeat: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.IS_FIRST_FEAT\"\n      }),\n      // Shamanic mask (for awakened feats)\n      shamanicMask: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.AWAKENED.SHAMANIC_MASK\"\n      }),\n      // Spell type (direct or indirect)\n      spellType: new fields.StringField({\n        required: true,\n        initial: \"direct\",\n        choices: {\n          \"direct\": \"SRA2.FEATS.SPELL.TYPE_DIRECT\",\n          \"indirect\": \"SRA2.FEATS.SPELL.TYPE_INDIRECT\"\n        },\n        label: \"SRA2.FEATS.SPELL.TYPE\"\n      }),\n      // Linked skills and specializations for weapons (for custom weapons)\n      linkedAttackSkill: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SKILL\"\n      }),\n      linkedAttackSpecialization: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.LINKED_ATTACK_SPECIALIZATION\"\n      }),\n      linkedDefenseSkill: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SKILL\"\n      }),\n      linkedDefenseSpecialization: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SPECIALIZATION\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Get common properties\n    const costType = (this as any).cost || 'free-equipment';\n    const featType = (this as any).featType || 'equipment';\n    const rating = (this as any).rating || 0;\n    \n    // Calculate cost based on cost type (for equipment and weapons)\n    let calculatedCost = 0;\n    \n    // Apply cost calculations for equipment, weapon, and weapons-spells types\n    if (featType === 'equipment' || featType === 'weapon' || featType === 'weapons-spells') {\n      switch (costType) {\n        case 'free-equipment':\n          calculatedCost = 0;\n          break;\n        case 'equipment':\n          calculatedCost = 2500;\n          break;\n        case 'advanced-equipment':\n          calculatedCost = 5000;\n          break;\n        // Legacy values (kept for migration compatibility)\n        case 'specialized-equipment':\n          calculatedCost = 5000;\n          break;\n        case 'feat':\n          calculatedCost = 0;\n          break;\n        default:\n          calculatedCost = 0;\n      }\n    }\n\n    calculatedCost += rating * 5000;\n    \n    (this as any).calculatedCost = calculatedCost;\n\n    // Calculate recommended attribute level\n    let recommendedLevel = 0;\n    const recommendedLevelBreakdown: Array<{ labelKey: string; labelParams?: string; value: number }> = [];\n    \n    const bonusLightDamage = (this as any).bonusLightDamage || 0;\n    const bonusSevereDamage = (this as any).bonusSevereDamage || 0;\n    const bonusPhysicalThreshold = (this as any).bonusPhysicalThreshold || 0;\n    const bonusMentalThreshold = (this as any).bonusMentalThreshold || 0;\n    const firewall = (this as any).firewall || 0;\n    const attack = (this as any).attack || 0;\n    const riggerConsoleCount = (this as any).riggerConsoleCount || 0;\n    const hasVehicleControlWiring = (this as any).hasVehicleControlWiring || false;\n    const isWeaponFocus = (this as any).isWeaponFocus || false;\n    const bonusAnarchy = (this as any).bonusAnarchy || 0;\n    const grantsNarration = (this as any).grantsNarration || false;\n    const narrativeEffects = (this as any).narrativeEffects || [];\n    const rrList = (this as any).rrList || [];\n    const isFirstFeat = (this as any).isFirstFeat || false;\n    \n    // Base cost for trait (not first feat): +3 levels\n    if (featType === 'trait' && !isFirstFeat) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.BASE_FEAT_COST', value: 3 });\n    }\n    \n    // Cyberware/bioware: 1 level\n    if (featType === 'cyberware') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CYBERWARE', value: 1 });\n    }\n    \n    // Adept power: 1 level\n    if (featType === 'adept-power') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT_POWER', value: 1 });\n    }\n    \n    // Spell: 1 level\n    if (featType === 'spell') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPELL', value: 1 });\n    }\n    \n    // Vehicle/Drone: 1 level\n    if (featType === 'vehicle') {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE', value: 1 });\n    }\n    \n    // Light wounds: +3 per wound\n    if (bonusLightDamage > 0) {\n      const value = bonusLightDamage * 3;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.LIGHT_WOUNDS', labelParams: `(${bonusLightDamage})`, value });\n    }\n    \n    // Heavy wounds: +6 per wound\n    if (bonusSevereDamage > 0) {\n      const value = bonusSevereDamage * 6;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SEVERE_WOUNDS', labelParams: `(${bonusSevereDamage})`, value });\n    }\n    \n    // Physical threshold bonus: +1 per point (positive or negative)\n    if (bonusPhysicalThreshold !== 0) {\n      const value = Math.abs(bonusPhysicalThreshold);\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.PHYSICAL_THRESHOLD', labelParams: `(${bonusPhysicalThreshold > 0 ? '+' : ''}${bonusPhysicalThreshold})`, value });\n    }\n    \n    // Mental threshold bonus: +1 per point (positive or negative)\n    if (bonusMentalThreshold !== 0) {\n      const value = Math.abs(bonusMentalThreshold);\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.MENTAL_THRESHOLD', labelParams: `(${bonusMentalThreshold > 0 ? '+' : ''}${bonusMentalThreshold})`, value });\n    }\n    \n    // Cyberdeck firewall: starts at 1, each level is +1\n    if (featType === 'cyberdeck' && firewall > 0) {\n      recommendedLevel += firewall;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.FIREWALL', labelParams: `(${firewall})`, value: firewall });\n    }\n    \n    // Attack: starts at 0, each level is +1\n    if (attack > 0) {\n      recommendedLevel += attack;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ATTACK', labelParams: `(${attack})`, value: attack });\n    }\n    \n    // Rigger console: +1 per drone controller\n    if (riggerConsoleCount > 0) {\n      recommendedLevel += riggerConsoleCount;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RIGGER_CONSOLE', labelParams: `(${riggerConsoleCount})`, value: riggerConsoleCount });\n    }\n    \n    // Vehicle control wiring: +2\n    if (hasVehicleControlWiring) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.VEHICLE_WIRING', value: 2 });\n    }\n    \n    // Weapon focus: +1\n    if (isWeaponFocus) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_FOCUS', value: 1 });\n    }\n    \n    // Damage value bonus: +1 per bonus\n    const damageValueBonus = (this as any).damageValueBonus || 0;\n    if (damageValueBonus > 0) {\n      recommendedLevel += damageValueBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.DAMAGE_VALUE_BONUS', labelParams: `(+${damageValueBonus})`, value: damageValueBonus });\n    }\n    \n    // Range improvements: +2 per improved range\n    const rangeImprovements = (this as any).rangeImprovements || {};\n    let rangeImprovementCount = 0;\n    if (rangeImprovements.melee) rangeImprovementCount++;\n    if (rangeImprovements.short) rangeImprovementCount++;\n    if (rangeImprovements.medium) rangeImprovementCount++;\n    if (rangeImprovements.long) rangeImprovementCount++;\n    if (rangeImprovementCount > 0) {\n      const value = rangeImprovementCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RANGE_IMPROVEMENTS', labelParams: `(${rangeImprovementCount})`, value });\n    }\n    \n    // Resource Reduction (RR) entries\n    for (const rr of rrList) {\n      const rrType = rr.rrType;\n      const rrValue = rr.rrValue || 0;\n      \n      if (rrValue > 0) {\n        if (rrType === 'specialization') {\n          // RR specialization: +2 levels per value\n          const value = rrValue * 2;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SPECIALIZATION', labelParams: `(${rrValue})`, value });\n        } else if (rrType === 'skill') {\n          // RR skill: +5 levels per value\n          const value = rrValue * 5;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_SKILL', labelParams: `(${rrValue})`, value });\n        } else if (rrType === 'attribute') {\n          // RR attribute: +10 levels per value\n          const value = rrValue * 10;\n          recommendedLevel += value;\n          recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.RR_ATTRIBUTE', labelParams: `(${rrValue})`, value });\n        }\n      }\n    }\n    \n    // Anarchy bonus: +2 per anarchy point\n    if (bonusAnarchy > 0) {\n      const value = bonusAnarchy * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ANARCHY_BONUS', labelParams: `(${bonusAnarchy})`, value });\n    }\n    \n    // Grants narration: +3 levels\n    if (grantsNarration) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.GRANTS_NARRATION', value: 3 });\n    }\n    \n    // Narrative effects: +1 level per positive effect, value per negative effect (count non-empty strings)\n    const positiveEffectsCount = narrativeEffects.filter((effect: any) => effect?.text && effect.text.trim() !== '' && !effect.isNegative).length;\n    const negativeEffects = narrativeEffects.filter((effect: any) => effect?.text && effect.text.trim() !== '' && effect.isNegative);\n    \n    if (positiveEffectsCount > 0) {\n      recommendedLevel += positiveEffectsCount;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_POSITIVE', labelParams: `(${positiveEffectsCount})`, value: positiveEffectsCount });\n    }\n    \n    if (negativeEffects.length > 0) {\n      const negativeEffectValue = negativeEffects.reduce((sum: number, effect: any) => sum + (effect.value || -1), 0);\n      recommendedLevel += negativeEffectValue; // Adding because value is already negative\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_NEGATIVE', labelParams: `(${negativeEffects.length})`, value: negativeEffectValue });\n    }\n    \n    // Additional sustained spells: +2 per spell (max 2)\n    const sustainedSpellCount = (this as any).sustainedSpellCount || 0;\n    if (sustainedSpellCount > 0) {\n      const value = sustainedSpellCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUSTAINED_SPELLS', labelParams: `(${sustainedSpellCount})`, value });\n    }\n    \n    // Additional summoned spirit: +3 (max 1)\n    const summonedSpiritCount = (this as any).summonedSpiritCount || 0;\n    if (summonedSpiritCount > 0) {\n      const value = summonedSpiritCount * 3;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SUMMONED_SPIRITS', labelParams: `(${summonedSpiritCount})`, value });\n    }\n    \n    // Awakened abilities\n    const astralPerception = (this as any).astralPerception || false;\n    const astralProjection = (this as any).astralProjection || false;\n    const sorcery = (this as any).sorcery || false;\n    const conjuration = (this as any).conjuration || false;\n    const adept = (this as any).adept || false;\n    \n    // Astral perception AND projection: +2\n    if (astralPerception && astralProjection) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION_PROJECTION', value: 2 });\n    }\n    \n    // Sorcery: +1\n    if (sorcery) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SORCERY', value: 1 });\n    }\n    \n    // Conjuration: +2\n    if (conjuration) {\n      recommendedLevel += 2;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.CONJURATION', value: 2 });\n    }\n    \n    // Adept: +1\n    if (adept) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADEPT', value: 1 });\n    }\n    \n    // Vehicle/Drone bonuses\n    const autopilotBonus = (this as any).autopilotBonus || 0;\n    const speedBonus = (this as any).speedBonus || 0;\n    const handlingBonus = (this as any).handlingBonus || 0;\n    const armorBonus = (this as any).armorBonus || 0;\n    const isFixed = (this as any).isFixed || false;\n    const isFlying = (this as any).isFlying || false;\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\n    \n    // Autopilot bonus: +1 per level\n    if (autopilotBonus > 0) {\n      recommendedLevel += autopilotBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_BONUS', labelParams: `(+${autopilotBonus})`, value: autopilotBonus });\n    }\n    \n    // Speed bonus: +1 per level\n    if (speedBonus > 0) {\n      recommendedLevel += speedBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SPEED_BONUS', labelParams: `(+${speedBonus})`, value: speedBonus });\n    }\n    \n    // Handling bonus: +1 per level\n    if (handlingBonus > 0) {\n      recommendedLevel += handlingBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.HANDLING_BONUS', labelParams: `(+${handlingBonus})`, value: handlingBonus });\n    }\n    \n    // Armor bonus: +1 per level\n    if (armorBonus > 0) {\n      recommendedLevel += armorBonus;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ARMOR_BONUS', labelParams: `(+${armorBonus})`, value: armorBonus });\n    }\n    \n    // Fixed (unable to move): -1\n    if (isFixed) {\n      recommendedLevel -= 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FIXED', value: -1 });\n    }\n    \n    // Flying: +1\n    if (isFlying) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.IS_FLYING', value: 1 });\n    }\n    \n    // Weapon mount improvement: +1\n    if (weaponMountImprovement) {\n      recommendedLevel += 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.WEAPON_MOUNT_IMPROVEMENT', value: 1 });\n    }\n    \n    // Autopilot unlocked: +3\n    if (autopilotUnlocked) {\n      recommendedLevel += 3;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.AUTOPILOT_UNLOCKED', value: 3 });\n    }\n    \n    // Additional drones: +2 per drone\n    if (additionalDroneCount > 0) {\n      const value = additionalDroneCount * 2;\n      recommendedLevel += value;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.ADDITIONAL_DRONES', labelParams: `(${additionalDroneCount})`, value });\n    }\n    \n    // Shamanic mask: -1 level (for awakened feats only)\n    const shamanicMask = (this as any).shamanicMask || false;\n    if (shamanicMask && featType === 'awakened') {\n      recommendedLevel -= 1;\n      recommendedLevelBreakdown.push({ labelKey: 'SRA2.FEATS.BREAKDOWN.SHAMANIC_MASK', value: -1 });\n    }\n    \n    (this as any).recommendedLevel = recommendedLevel;\n    (this as any).recommendedLevelBreakdown = recommendedLevelBreakdown;\n  }\n}\n\n","/**\n * Data model for Vehicle/Drone actors\n */\nimport { VEHICLE_TYPES, VehicleType } from './item-feat.js';\n\nexport class VehicleDataModel extends foundry.abstract.TypeDataModel<any, Actor> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    // Build vehicle type choices from VEHICLE_TYPES\n    const vehicleTypeChoices: Record<string, string> = {};\n    Object.keys(VEHICLE_TYPES).forEach((key) => {\n      vehicleTypeChoices[key] = key;\n    });\n    \n    return {\n      vehicleType: new fields.StringField({\n        required: false,\n        nullable: true,\n        choices: vehicleTypeChoices,\n        label: \"SRA2.VEHICLE.VEHICLE_TYPE\"\n      }),\n      // Vehicle bonuses\n      autopilotBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 6,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS\"\n      }),\n      speedBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.SPEED_BONUS\"\n      }),\n      handlingBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.HANDLING_BONUS\"\n      }),\n      armorBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ARMOR_BONUS\"\n      }),\n      isFixed: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FIXED\"\n      }),\n      isFlying: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.IS_FLYING\"\n      }),\n      weaponMountImprovement: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT\"\n      }),\n      autopilotUnlocked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED\"\n      }),\n      additionalDroneCount: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 3,\n        integer: true,\n        label: \"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT\"\n      }),\n      weaponMount: new fields.StringField({\n        required: true,\n        initial: \"none\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_MOUNT\"\n      }),\n      weaponInfo: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.FEATS.VEHICLE.WEAPON_INFO\"\n      }),\n      narrativeEffects: new fields.ArrayField(new fields.StringField({\n        required: false,\n        initial: \"\"\n      }), {\n        initial: [],\n        label: \"SRA2.VEHICLE.NARRATIVE_EFFECTS\"\n      }),\n      damage: new fields.SchemaField({\n        light: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false, false]\n        }),\n        severe: new fields.ArrayField(new fields.BooleanField({\n          required: true,\n          initial: false\n        }), {\n          required: true,\n          initial: [false]\n        }),\n        incapacitating: new fields.BooleanField({\n          required: true,\n          initial: false\n        })\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    const vehicleType = (this as any).vehicleType || \"\";\n    const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as VehicleType] \n      ? VEHICLE_TYPES[vehicleType as VehicleType] \n      : null;\n    \n    // Get base stats from vehicle type or defaults\n    const baseAutopilot = vehicleStats?.autopilot || 6;\n    const baseStructure = vehicleStats?.structure || 2;\n    const baseHandling = vehicleStats?.handling || 5;\n    const baseSpeed = vehicleStats?.speed || 3;\n    const baseFlyingSpeed = vehicleStats?.flyingSpeed || 0;\n    const baseArmor = vehicleStats?.armor || 0;\n    const baseWeaponMount = vehicleStats?.weaponMount || \"none\";\n    \n    // Get bonuses\n    const autopilotBonus = (this as any).autopilotBonus || 0;\n    const speedBonus = (this as any).speedBonus || 0;\n    const handlingBonus = (this as any).handlingBonus || 0;\n    const armorBonus = (this as any).armorBonus || 0;\n    const isFlying = (this as any).isFlying || false;\n    const isFixed = (this as any).isFixed || false;\n    const weaponMountImprovement = (this as any).weaponMountImprovement || false;\n    const autopilotUnlocked = (this as any).autopilotUnlocked || false;\n    const additionalDroneCount = (this as any).additionalDroneCount || 0;\n    \n    // Calculate final values (same logic as feat-sheet.ts)\n    const finalAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\n    const finalHandling = baseHandling + handlingBonus;\n    const finalSpeed = isFixed ? 0 : (baseSpeed + speedBonus);\n    const finalFlyingSpeed = isFlying ? (baseFlyingSpeed > 0 ? baseFlyingSpeed : 1) : 0;\n    const finalArmor = Math.min(baseStructure, baseArmor + armorBonus);\n    \n    // Calculate weapon mount (improved if option is checked)\n    let finalWeaponMount = baseWeaponMount;\n    if (weaponMountImprovement) {\n      if (baseWeaponMount === \"none\") {\n        finalWeaponMount = \"smg\";\n      } else if (baseWeaponMount === \"smg\") {\n        finalWeaponMount = \"rifle\";\n      }\n    }\n    \n    // Store calculated attributes (read-only in UI)\n    (this as any).attributes = {\n      autopilot: finalAutopilot,\n      structure: baseStructure,\n      handling: finalHandling,\n      speed: finalSpeed,\n      flyingSpeed: finalFlyingSpeed,\n      armor: finalArmor\n    };\n    \n    // Store base stats for reference\n    (this as any).baseAttributes = {\n      autopilot: baseAutopilot,\n      structure: baseStructure,\n      handling: baseHandling,\n      speed: baseSpeed,\n      flyingSpeed: baseFlyingSpeed,\n      armor: baseArmor\n    };\n    \n    // Store weapon mount info\n    (this as any).weaponMount = finalWeaponMount;\n    \n    // Calculate damage thresholds for vehicles\n    // Based on the formulas:\n    // - If VD > (3 × Structure) + Armor, incapacitating damage\n    // - If VD > (2 × Structure) + Armor, severe damage\n    // - If VD > Structure + Armor, light damage\n    // - If VD ≤ Structure + Armor, no damage\n    \n    (this as any).damageThresholds = {\n      light: baseStructure + finalArmor,\n      severe: (2 * baseStructure) + finalArmor,\n      incapacitating: (3 * baseStructure) + finalArmor\n    };\n    \n    // Ensure damage arrays are properly sized (preserve existing values)\n    const existingDamage = (this as any).damage || {};\n    \n    // Base: 2 light, 1 severe, 1 incapacitating\n    const totalLightBoxes = 2;\n    const totalSevereBoxes = 1;\n    \n    // Create a copy of damage to avoid mutating the original\n    const damage: any = {\n      light: Array.isArray(existingDamage.light) ? [...existingDamage.light] : [false, false],\n      severe: Array.isArray(existingDamage.severe) ? [...existingDamage.severe] : [false],\n      incapacitating: typeof existingDamage.incapacitating === 'boolean' ? existingDamage.incapacitating : false\n    };\n    \n    // Adjust light damage array (preserve existing values, only pad or trim)\n    while (damage.light.length < totalLightBoxes) {\n      damage.light.push(false);\n    }\n    while (damage.light.length > totalLightBoxes) {\n      damage.light.pop();\n    }\n    \n    // Adjust severe damage array (preserve existing values, only pad or trim)\n    while (damage.severe.length < totalSevereBoxes) {\n      damage.severe.push(false);\n    }\n    while (damage.severe.length > totalSevereBoxes) {\n      damage.severe.pop();\n    }\n    \n    // Reassign the damage object to ensure it's properly stored\n    (this as any).damage = damage;\n    \n    (this as any).totalLightBoxes = totalLightBoxes;\n    (this as any).totalSevereBoxes = totalSevereBoxes;\n    \n    // Calculate cost (same rules as vehicle feats: base 5000 + bonuses * 5000)\n    let calculatedCost = 5000; // Base cost for vehicle/drone\n    \n    // Add cost for bonuses (each bonus point costs 5000)\n    calculatedCost += autopilotBonus * 5000;\n    calculatedCost += speedBonus * 5000;\n    calculatedCost += handlingBonus * 5000;\n    calculatedCost += armorBonus * 5000;\n    \n    // Add cost for options\n    if (isFlying) {\n      calculatedCost += 5000; // +1 level = +5000\n    }\n    if (weaponMountImprovement) {\n      calculatedCost += 5000; // +1 level = +5000\n    }\n    if (autopilotUnlocked) {\n      calculatedCost += 15000; // +3 levels = +15000\n    }\n    if (additionalDroneCount > 0) {\n      calculatedCost += additionalDroneCount * 10000; // +2 levels per drone = +10000 per drone\n    }\n    if (isFixed) {\n      calculatedCost -= 5000; // -1 level = -5000\n    }\n    \n    // Add cost for narrative effects (5000 per effect)\n    const narrativeEffects = (this as any).narrativeEffects || [];\n    const narrativeEffectsCount = narrativeEffects.filter((effect: string) => effect && effect.trim() !== '').length;\n    calculatedCost += narrativeEffectsCount * 5000;\n    \n    // Add cost for weapons (get from actor items)\n    const actor = (this as any).parent;\n    if (actor && actor.items) {\n      const weapons = actor.items.filter((item: any) => {\n        const featType = item.system?.featType;\n        return featType === 'weapon' || featType === 'weapons-spells';\n      });\n      \n      weapons.forEach((weapon: any) => {\n        const weaponCost = weapon.system?.calculatedCost || 0;\n        calculatedCost += weaponCost;\n      });\n    }\n    \n    (this as any).calculatedCost = calculatedCost;\n  }\n}\n\n\n","/**\n * Data model for Skill items\n */\nexport class SkillDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      rating: new fields.NumberField({\n        required: true,\n        initial: 1,\n        min: 0,\n        max: 8,\n        integer: true,\n        label: \"SRA2.SKILLS.RATING\"\n      }),\n      linkedAttribute: new fields.StringField({\n        required: true,\n        initial: \"strength\",\n        choices: {\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\n        },\n        label: \"SRA2.SKILLS.LINKED_ATTRIBUTE\"\n      }),\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      bookmarked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.SKILLS.BOOKMARKED\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Calculate cost based on rating\n    // 2500 per rating up to 5, then 5000 per rating above 5\n    const rating = (this as any).rating || 0;\n    \n    let calculatedCost = 0;\n    if (rating <= 5) {\n      calculatedCost = rating * 2500;\n    } else {\n      // First 5 levels at 2500 each, remaining levels at 5000 each\n      calculatedCost = 5 * 2500 + (rating - 5) * 5000;\n    }\n    \n    (this as any).calculatedCost = calculatedCost;\n  }\n}\n\n","/**\n * Data model for Specialization items\n * A specialization is linked to a skill and costs 2500 yens\n */\nexport class SpecializationDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      linkedSkill: new fields.StringField({\n        required: true,\n        initial: \"\",\n        label: \"SRA2.SPECIALIZATIONS.LINKED_SKILL\"\n      }),\n      linkedAttribute: new fields.StringField({\n        required: true,\n        initial: \"strength\",\n        choices: {\n          strength: \"SRA2.ATTRIBUTES.STRENGTH\",\n          agility: \"SRA2.ATTRIBUTES.AGILITY\",\n          willpower: \"SRA2.ATTRIBUTES.WILLPOWER\",\n          logic: \"SRA2.ATTRIBUTES.LOGIC\",\n          charisma: \"SRA2.ATTRIBUTES.CHARISMA\"\n        },\n        label: \"SRA2.SPECIALIZATIONS.LINKED_ATTRIBUTE\"\n      }),\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      bookmarked: new fields.BooleanField({\n        required: true,\n        initial: false,\n        label: \"SRA2.BOOKMARKS.TOGGLE\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Specializations have a fixed cost of 2500 yens\n    (this as any).calculatedCost = 2500;\n  }\n}\n\n","/**\n * Data model for Metatype items\n * Metatypes define maximum values for character attributes\n */\nexport class MetatypeDataModel extends foundry.abstract.TypeDataModel<any, Item> {\n  static override defineSchema(): any {\n    const fields = foundry.data.fields;\n    \n    return {\n      description: new fields.HTMLField({\n        required: true,\n        initial: \"\"\n      }),\n      maxStrength: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_STRENGTH\"\n      }),\n      maxAgility: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_AGILITY\"\n      }),\n      maxWillpower: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_WILLPOWER\"\n      }),\n      maxLogic: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_LOGIC\"\n      }),\n      maxCharisma: new fields.NumberField({\n        required: true,\n        initial: 4,\n        min: 1,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.MAX_CHARISMA\"\n      }),\n      anarchyBonus: new fields.NumberField({\n        required: true,\n        initial: 0,\n        min: 0,\n        max: 10,\n        integer: true,\n        label: \"SRA2.METATYPES.ANARCHY_BONUS\"\n      })\n    };\n  }\n\n  override prepareDerivedData(): void {\n    // Metatypes don't have a cost, they're character features\n    // No derived data needed for now\n  }\n}\n\n","/**\n * Custom Actor document for SRA2\n */\nexport class SRA2Actor<SubType extends Actor.SubType = Actor.SubType> extends Actor<SubType> {\n  get feats(): Item[] {\n    return this.items.filter((item: Item) => item.type === 'feat');\n  }\n}","/**\n * Shared Dice Rolling Utilities for SRA2\n * This module contains common dice rolling functions used across character sheets, NPC sheets, and item sheets.\n */\n\n// Roll is available globally in FoundryVTT\ndeclare const Roll: any;\ndeclare const renderTemplate: any;\ndeclare const ChatMessage: any;\n\n/**\n * RR source information\n */\nexport interface RRSource {\n  featName: string;\n  rrValue: number;\n}\n\n/**\n * Risk reduction constants\n */\nexport const RISK_DICE_BY_RR = [2, 5, 8, 12];\n\nexport const RISK_THRESHOLDS = {\n  0: { normal: 2, fort: 4, extreme: 6 },\n  1: { normal: 5, fort: 7, extreme: 9 },\n  2: { normal: 8, fort: 11, extreme: 13 },\n  3: { normal: 12, fort: 15, extreme: 999 }\n};\n\n/**\n * Get risk dice count based on RR level\n */\nexport function getRiskDiceByRR(rr: number): number {\n  return RISK_DICE_BY_RR[Math.min(3, Math.max(0, rr))] || 2;\n}\n\n/**\n * Get RR sources from an actor for a specific item type and name\n * This is the main function used by most sheets for their own actor\n */\nexport function getRRSources(\n  actor: any,\n  itemType: 'skill' | 'specialization' | 'attribute',\n  itemName: string\n): RRSource[] {\n  const sources: RRSource[] = [];\n  \n  // Get all active feats from the actor\n  const feats = actor.items.filter((item: any) => \n    item.type === 'feat' && \n    item.system.active === true\n  );\n  \n  // Calculate RR from feats that target this item\n  for (const feat of feats) {\n    const featSystem = feat.system as any;\n    const rrList = featSystem.rrList || [];\n    \n    // Loop through all RR entries in this feat\n    for (const rrEntry of rrList) {\n      const rrType = rrEntry.rrType;\n      const rrValue = rrEntry.rrValue || 0;\n      const rrTarget = rrEntry.rrTarget || '';\n      \n      // Check if this RR entry provides RR for the given item\n      if (rrType === itemType && rrTarget === itemName && rrValue > 0) {\n        sources.push({\n          featName: feat.name,\n          rrValue: rrValue\n        });\n      }\n    }\n  }\n  \n  return sources;\n}\n\n/**\n * Get RR sources from any actor for a specific item type and name\n * This is useful for defense rolls where we need to check another actor's RR\n * (identical to getRRSources but kept separate for clarity in combat scenarios)\n */\nexport function getRRSourcesForActor(\n  actor: any,\n  itemType: 'skill' | 'specialization' | 'attribute',\n  itemName: string\n): RRSource[] {\n  return getRRSources(actor, itemType, itemName);\n}\n\n/**\n * Get success threshold based on roll mode\n */\nexport function getSuccessThreshold(mode: string): number {\n  switch (mode) {\n    case 'advantage': return 4;  // 4, 5, 6 = success\n    case 'disadvantage': return 6; // only 6 = success\n    default: return 5;  // 5, 6 = success\n  }\n}\n\n/**\n * Build RR sources HTML for dialog\n */\nexport function buildRRSourcesHtml(rrSources: RRSource[]): string {\n  if (rrSources.length === 0) return '';\n  \n  let html = '<div class=\"rr-sources\"><strong>Sources RR:</strong>';\n  rrSources.forEach((source) => {\n    html += `\n      <label class=\"rr-source-item\">\n        <input type=\"checkbox\" class=\"rr-source-checkbox\" data-rr-value=\"${source.rrValue}\" checked />\n        <span>${source.featName} (+${source.rrValue})</span>\n      </label>`;\n  });\n  html += '</div>';\n  \n  return html;\n}\n\n/**\n * Roll Request Data Interface\n * Contains all information needed for a roll request\n */\nexport interface RollRequestData {\n  // Item information\n  itemType?: string;\n  weaponType?: string;\n  itemName?: string;\n  itemId?: string;\n  itemRating?: number;\n  itemActive?: boolean;\n  \n  // Linked skills (merged from weapon types and custom fields)\n  linkedAttackSkill?: string;\n  linkedAttackSpecialization?: string;\n  linkedDefenseSkill?: string;\n  linkedDefenseSpecialization?: string;\n  linkedAttribute?: string;\n  \n  // Weapon properties\n  isWeaponFocus?: boolean;\n  damageValue?: string;  // FINAL damage value (base + bonus)\n  damageValueBonus?: number;  // Bonus from feat\n  meleeRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\n  shortRange?: string;  // \"none\" | \"ok\" | \"disadvantage\"\n  mediumRange?: string; // \"none\" | \"ok\" | \"disadvantage\"\n  longRange?: string;   // \"none\" | \"ok\" | \"disadvantage\"\n  \n  // Skill/Spec information (undefined if not found)\n  skillName?: string;\n  specName?: string;\n  skillLevel?: number;\n  specLevel?: number;\n  \n  // NPC threshold (when not rolling dice)\n  threshold?: number;\n  \n  // Actor information\n  actorId?: string;\n  actorUuid?: string;\n  actorName?: string;\n  \n  // Token information\n  attackerTokenUuid?: string;\n  defenderTokenUuid?: string;\n  \n  // RR List\n  rrList?: any[];\n  \n  // Risk dice count (number of risk dice selected)\n  riskDiceCount?: number;\n  \n  // Final calculated values\n  finalRR?: number;\n  dicePool?: number;\n  \n  // Roll mode\n  rollMode?: 'normal' | 'disadvantage' | 'advantage';\n  \n  // Defense/Counter-attack flags\n  isDefend?: boolean;\n  isCounterAttack?: boolean;\n  \n  // Attack roll data (for defense/counter-attack rolls)\n  attackRollResult?: RollResult;\n  attackRollData?: RollRequestData;\n  availableWeapons?: Array<{\n    id: string;\n    name: string;\n    linkedAttackSkill: string;\n    damageValue: string;\n    damageValueBonus: number;\n    weaponType?: string;\n    meleeRange?: string;\n  }>;\n  selectedWeaponId?: string; // ID of selected weapon for counter-attack\n}\n\n/**\n * Handle roll request - central function for all roll clicks\n * Displays a roll dialog with roll information\n */\nexport function handleRollRequest(data: RollRequestData): void {\n  console.log('=== ROLL REQUEST ===', {\n    itemType: data.itemType,\n    weaponType: data.weaponType,\n    linkedAttackSkill: data.linkedAttackSkill,\n    linkedAttackSpecialization: data.linkedAttackSpecialization,\n    linkedDefenseSkill: data.linkedDefenseSkill,\n    linkedDefenseSpecialization: data.linkedDefenseSpecialization,\n    linkedAttribute: data.linkedAttribute,\n    isWeaponFocus: data.isWeaponFocus,\n    damageValue: data.damageValue,\n    damageValueBonus: data.damageValueBonus,\n    meleeRange: data.meleeRange,\n    shortRange: data.shortRange,\n    mediumRange: data.mediumRange,\n    longRange: data.longRange,\n    skillName: data.skillName,\n    specName: data.specName,\n    itemName: data.itemName,\n    itemId: data.itemId,\n    threshold: data.threshold,\n    actorId: data.actorId,\n    actorUuid: data.actorUuid,\n    actorName: data.actorName,\n    specLevel: data.specLevel,\n    skillLevel: data.skillLevel,\n    itemRating: data.itemRating,\n    itemActive: data.itemActive,\n    rrList: data.rrList\n  });\n\n  // Import RollDialog dynamically to avoid circular dependencies\n  import('../applications/roll-dialog.js').then((module) => {\n    const dialog = new module.RollDialog(data);\n    dialog.render(true);\n  });\n}\n\n/**\n * Roll result interface\n */\nexport interface RollResult {\n  normalDice: number[];\n  riskDice: number[];\n  normalSuccesses: number;\n  riskSuccesses: number;\n  totalSuccesses: number;\n  criticalFailures: number;\n  finalRR: number;\n  remainingFailures: number;\n  complication: 'none' | 'minor' | 'critical' | 'disaster';\n}\n\n/**\n * Execute a dice roll with DiceSoNice support\n * Steps 2-5: Roll dice, calculate results, complications, and create chat message\n */\nexport async function executeRoll(\n  attacker: any,\n  defender: any,\n  attackerToken: any,\n  defenderToken: any,\n  rollData: RollRequestData\n): Promise<void> {\n  if (!attacker) {\n    console.error('No attacker provided for roll');\n    return;\n  }\n\n  // Log token information\n  console.log('=== EXECUTE ROLL ===');\n  console.log('Attacker:', attacker?.name || 'Unknown');\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\n  console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || rollData.attackerTokenUuid || 'Unknown');\n  if (attackerToken?.actor) {\n    console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\n  }\n  console.log('Defender:', defender?.name || 'None');\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\n  console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || rollData.defenderTokenUuid || 'Unknown');\n  if (defenderToken?.actor) {\n    console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\n  }\n  console.log('===================');\n\n  const dicePool = rollData.dicePool || 0;\n  const riskDiceCount = rollData.riskDiceCount || 0;\n  const normalDiceCount = Math.max(0, dicePool - riskDiceCount);\n  const rollMode = rollData.rollMode || 'normal';\n  const finalRR = Math.min(3, rollData.finalRR || 0);\n  const threshold = rollData.threshold;\n\n  // If threshold is defined, use it instead of rolling dice\n  let rollResult: RollResult;\n  if (threshold !== undefined) {\n    // Apply threshold: number of successes equals threshold\n    rollResult = {\n      normalDice: [],\n      riskDice: [],\n      normalSuccesses: threshold,\n      riskSuccesses: 0,\n      totalSuccesses: threshold,\n      criticalFailures: 0,\n      finalRR: finalRR,\n      remainingFailures: 0,\n      complication: 'none'\n    };\n  } else {\n  // Step 2: Create and roll dice\n  let normalRoll: any = null;\n  let riskRoll: any = null;\n\n  // Roll normal dice\n  if (normalDiceCount > 0) {\n    normalRoll = new Roll(`${normalDiceCount}d6`);\n    await normalRoll.evaluate();\n    \n    // Show DiceSoNice animation for normal dice\n    if ((game as any).dice3d && normalRoll) {\n      (game as any).dice3d.showForRoll(normalRoll, game.user, true, null, false);\n    }\n  }\n\n  // Roll risk dice with purple color\n  if (riskDiceCount > 0) {\n    riskRoll = new Roll(`${riskDiceCount}d6`);\n    await riskRoll.evaluate();\n    \n    // Show DiceSoNice animation for risk dice with purple color\n    if ((game as any).dice3d && riskRoll) {\n      const dice3dConfig = {\n        colorset: 'purple',\n        theme: 'default'\n      };\n      (game as any).dice3d.showForRoll(riskRoll, game.user, true, dice3dConfig, false);\n    }\n  }\n\n  // Step 3: Calculate results\n  const normalResults: number[] = normalRoll ? (normalRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\n  const riskResults: number[] = riskRoll ? (riskRoll.dice[0]?.results?.map((r: any) => r.result) || []) : [];\n  \n  // Calculate successes for normal dice\n  let normalSuccesses = 0;\n  for (const result of normalResults) {\n    if (rollMode === 'advantage' && result >= 4) {\n      normalSuccesses++;\n    } else if (rollMode === 'disadvantage' && result === 6) {\n      normalSuccesses++;\n    } else if (rollMode === 'normal' && result >= 5) {\n      normalSuccesses++;\n    }\n  }\n\n  // Calculate successes and critical failures for risk dice\n  let riskSuccesses = 0;\n  let criticalFailures = 0;\n  for (const result of riskResults) {\n    if (result === 1) {\n      criticalFailures++;\n    } else if (rollMode === 'advantage' && result >= 4) {\n      riskSuccesses++;\n    } else if (rollMode === 'disadvantage' && result === 6) {\n      riskSuccesses++;\n    } else if (rollMode === 'normal' && result >= 5) {\n      riskSuccesses++;\n    }\n  }\n\n  // Risk dice successes count double\n  const totalRiskSuccesses = riskSuccesses * 2;\n  const totalSuccesses = normalSuccesses + totalRiskSuccesses;\n\n  // Step 4: Calculate complications\n  const remainingFailures = Math.max(0, criticalFailures - finalRR);\n  \n  let complication: 'none' | 'minor' | 'critical' | 'disaster' = 'none';\n  if (remainingFailures === 1) {\n    complication = 'minor';\n  } else if (remainingFailures === 2) {\n    complication = 'critical';\n  } else if (remainingFailures >= 3) {\n    complication = 'disaster';\n  }\n\n    rollResult = {\n    normalDice: normalResults,\n    riskDice: riskResults,\n    normalSuccesses: normalSuccesses,\n    riskSuccesses: riskSuccesses,\n    totalSuccesses: totalSuccesses,\n    criticalFailures: criticalFailures,\n    finalRR: finalRR,\n    remainingFailures: remainingFailures,\n    complication: complication\n  };\n  }\n\n  // Step 5: Create chat message\n  await createRollChatMessage(attacker, defender, attackerToken, defenderToken, rollData, rollResult);\n}\n\n/**\n * Create chat message for roll result\n * Step 5: Display roll results in chat\n */\nasync function createRollChatMessage(\n  attacker: any,\n  defender: any,\n  attackerToken: any,\n  defenderToken: any,\n  rollData: RollRequestData,\n  rollResult: RollResult\n): Promise<void> {\n  // Determine if this is an attack\n  const isAttack = rollData.itemType === 'weapon' || \n                   rollData.weaponType !== undefined ||\n                   (rollData.meleeRange || rollData.shortRange || rollData.mediumRange || rollData.longRange);\n\n  // Log token information\n  console.log('=== CREATE ROLL CHAT MESSAGE ===');\n  console.log('Attacker:', attacker?.name || 'Unknown');\n  console.log('Attacker UUID:', attacker?.uuid || 'Unknown');\n  console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\n  \n  // Get attacker token UUID (priority: token > rollData)\n  let attackerTokenUuid: string | undefined = undefined;\n  if (attackerToken) {\n    attackerTokenUuid = attackerToken.uuid || attackerToken.document?.uuid || undefined;\n    console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\n    // If token exists, use token's actor UUID (for NPCs)\n    if (attackerToken.actor) {\n      console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\n    }\n  } else if (rollData.attackerTokenUuid) {\n    attackerTokenUuid = rollData.attackerTokenUuid;\n    console.log('Attacker Token UUID (from rollData):', attackerTokenUuid);\n  }\n  \n  // Determine final attacker UUID: if token exists, use token's actor UUID, otherwise use actor UUID\n  const finalAttackerUuid = attackerToken?.actor?.uuid || attacker?.uuid;\n  console.log('Final Attacker UUID (token actor or actor):', finalAttackerUuid || 'Unknown');\n  \n  console.log('Defender:', defender?.name || 'None');\n  console.log('Defender UUID:', defender?.uuid || 'Unknown');\n  console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\n  \n  // Get defender token UUID (priority: token > rollData)\n  let defenderTokenUuid: string | undefined = undefined;\n  if (defenderToken) {\n    defenderTokenUuid = defenderToken.uuid || defenderToken.document?.uuid || undefined;\n    console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\n    // If token exists, use token's actor UUID (for NPCs)\n    if (defenderToken.actor) {\n      console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\n    }\n  } else if (rollData.defenderTokenUuid) {\n    defenderTokenUuid = rollData.defenderTokenUuid;\n    console.log('Defender Token UUID (from rollData):', defenderTokenUuid);\n  }\n  \n  // Determine final defender UUID: if token exists, use token's actor UUID, otherwise use actor UUID\n  const finalDefenderUuid = defenderToken?.actor?.uuid || defender?.uuid;\n  console.log('Final Defender UUID (token actor or actor):', finalDefenderUuid || 'Unknown');\n  console.log('--- UUIDs to be stored in flags ---');\n  console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\n  console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\n  console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\n  console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\n  console.log('================================');\n\n  // Prepare defender data with token image if available\n  let defenderData: any = null;\n  if (defender) {\n    // Get token image - try different ways to access it depending on Foundry version\n    let tokenImg = defender.img; // fallback to actor image\n    if (defenderToken) {\n      // FoundryVTT v13: token.document.texture.src or token.document.img\n      tokenImg = (defenderToken as any).document?.texture?.src || \n                 (defenderToken as any).document?.img || \n                 (defenderToken as any).data?.img || \n                 (defenderToken as any).texture?.src ||\n                 defender.img;\n    }\n    \n    defenderData = {\n      ...defender,\n      img: tokenImg\n    };\n  }\n\n  // Handle defense/counter-attack rolls\n  let defenseResult: any = null;\n  let calculatedDamage: number | null = null;\n  let attackFailed: boolean = false;\n  \n  if (rollData.isDefend && rollData.attackRollResult && rollData.attackRollData) {\n    // Defense roll: compare with attack\n    // For defense: attacker = defender (one defending), defender = original attacker\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\n    const defenseSuccesses = rollResult.totalSuccesses;\n    \n    // Get actor names (use token name if available, otherwise actor name)\n    const originalAttackerName = defenderToken?.name || defender?.name || 'Inconnu';\n    const defenderName = attackerToken?.name || attacker?.name || 'Inconnu';\n    \n    if (attackSuccesses >= defenseSuccesses) {\n      // Attack succeeds, calculate damage\n      // damageValue already includes bonus (finalDamageValue)\n      let damageValue = 0;\n      const damageValueStr = rollData.attackRollData.damageValue || '0';\n      \n      // Handle \"FOR\" or \"FOR+X\" damage values\n      if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\n        // Get original attacker's strength (defender in defense context is the original attacker)\n        const attackerStrength = (defender?.system as any)?.attributes?.strength || 1;\n        if (damageValueStr === 'FOR') {\n          damageValue = attackerStrength;\n        } else if (damageValueStr.startsWith('FOR+')) {\n          const bonus = parseInt(damageValueStr.substring(4)) || 0;\n          damageValue = attackerStrength + bonus;\n        }\n      } else {\n        damageValue = parseInt(damageValueStr, 10) || 0;\n      }\n      \n      calculatedDamage = damageValue + attackSuccesses - defenseSuccesses;\n      attackFailed = false;\n    } else {\n      // Attack fails\n      attackFailed = true;\n      calculatedDamage = 0;\n    }\n    \n    // For defense: attacker = defender (one defending), defender = original attacker\n    // If attack succeeds, original attacker (defender in context) inflicts damage to defender (attacker in context)\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in defense context\n    const defenderUuid = finalAttackerUuid; // Defender is attacker in defense context\n    \n    console.log('Defense: Attack succeeds - original attacker inflicts damage to defender');\n    console.log('  Original attacker (inflicter):', originalAttackerName, '(', originalAttackerUuid, ')');\n    console.log('  Defender (receiver):', defenderName, '(', defenderUuid, ')');\n    \n    defenseResult = {\n      attackSuccesses: attackSuccesses,\n      defenseSuccesses: defenseSuccesses,\n      calculatedDamage: calculatedDamage,\n      attackFailed: attackFailed,\n      originalAttackerName: originalAttackerName,\n      defenderName: defenderName,\n      // UUIDs for applying damage\n      originalAttackerUuid: originalAttackerUuid, // Who inflicts damage if attack succeeds\n      defenderUuid: defenderUuid // Who receives damage if attack succeeds\n    };\n  } else if (rollData.isCounterAttack && rollData.attackRollResult && rollData.attackRollData) {\n    // Counter-attack: compare with original attack\n    // In counter-attack context:\n    // - attacker = original defender (the one doing counter-attack)\n    // - defender = original attacker (the one being counter-attacked)\n    \n    // Get actor names (use token name if available, otherwise actor name)\n    // For original attacker (defender in counter-attack context)\n    // Try: token.document.name, token.name, token.actor.name, actor.name\n    const originalAttackerName = defenderToken?.document?.name || \n                                  (defenderToken as any)?.name || \n                                  defenderToken?.actor?.name || \n                                  defender?.name || \n                                  'Inconnu';\n    // For original defender/counter-attacker (attacker in counter-attack context)\n    const originalDefenderName = attackerToken?.document?.name || \n                                  (attackerToken as any)?.name || \n                                  attackerToken?.actor?.name || \n                                  attacker?.name || \n                                  'Inconnu';\n    const attackSuccesses = rollData.attackRollResult.totalSuccesses;\n    const counterAttackSuccesses = rollResult.totalSuccesses;\n    \n    // Get damage values for the original attacker\n    // damageValue already includes bonus (finalDamageValue)\n    let attackDamageValue = 0;\n    const attackDamageValueStr = rollData.attackRollData.damageValue || '0';\n    \n    // Handle \"FOR\" or \"FOR+X\" damage values for the attacker (defender in counter-attack context)\n    if (attackDamageValueStr === 'FOR' || attackDamageValueStr.startsWith('FOR+')) {\n      const attackerStrength = (defender?.system as any)?.attributes?.strength || 1; // defender = original attacker\n      if (attackDamageValueStr === 'FOR') {\n        attackDamageValue = attackerStrength;\n      } else if (attackDamageValueStr.startsWith('FOR+')) {\n        const bonus = parseInt(attackDamageValueStr.substring(4)) || 0;\n        attackDamageValue = attackerStrength + bonus;\n      }\n    } else {\n      attackDamageValue = parseInt(attackDamageValueStr, 10) || 0;\n    }\n    \n    // Get counter-attack damage value from rollData\n    // rollData.damageValue should already be set from the selected weapon (includes bonus)\n    let counterAttackDamageValue = 0;\n    const damageValueStr = rollData.damageValue || '0';\n    \n    // Handle \"FOR\" or \"FOR+X\" damage values\n    if (damageValueStr === 'FOR' || damageValueStr.startsWith('FOR+')) {\n      const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\n      if (damageValueStr === 'FOR') {\n        counterAttackDamageValue = actorStrength;\n      } else if (damageValueStr.startsWith('FOR+')) {\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\n        counterAttackDamageValue = actorStrength + bonus;\n      }\n    } else {\n      counterAttackDamageValue = parseInt(damageValueStr, 10) || 0;\n    }\n    \n    // If still no damage value, try to find weapon (fallback)\n    if (!counterAttackDamageValue && attacker) {\n      // Find weapon matching the counter-attack skill/item\n      const selectedWeaponId = (rollData as any).selectedWeaponId;\n      if (selectedWeaponId) {\n          const weapon = attacker.items.find((item: any) => item.id === selectedWeaponId);\n          if (weapon) {\n            const weaponSystem = weapon.system as any;\n            // Calculate finalDamageValue from weapon (same logic as character-sheet.ts)\n            const baseDamageValue = weaponSystem.damageValue || '0';\n            const damageValueBonus = weaponSystem.damageValueBonus || 0;\n            let weaponDamageValueStr = baseDamageValue;\n            \n            if (damageValueBonus > 0 && baseDamageValue !== '0') {\n              if (baseDamageValue === 'FOR') {\n                weaponDamageValueStr = `FOR+${damageValueBonus}`;\n              } else if (baseDamageValue.startsWith('FOR+')) {\n                const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n                weaponDamageValueStr = `FOR+${baseModifier + damageValueBonus}`;\n              } else if (baseDamageValue !== 'toxin') {\n                const baseValue = parseInt(baseDamageValue) || 0;\n                weaponDamageValueStr = (baseValue + damageValueBonus).toString();\n              }\n            }\n            \n            if (weaponDamageValueStr === 'FOR' || weaponDamageValueStr.startsWith('FOR+')) {\n              const actorStrength = (attacker.system as any)?.attributes?.strength || 1;\n              if (weaponDamageValueStr === 'FOR') {\n                counterAttackDamageValue = actorStrength;\n              } else if (weaponDamageValueStr.startsWith('FOR+')) {\n                const bonus = parseInt(weaponDamageValueStr.substring(4)) || 0;\n                counterAttackDamageValue = actorStrength + bonus;\n              }\n            } else {\n              counterAttackDamageValue = parseInt(weaponDamageValueStr, 10) || 0;\n            }\n        }\n      }\n    }\n    \n    // Determine winner and calculate damage\n    let attackerDamage = 0;\n    let defenderDamage = 0;\n    let isTie = false;\n    let winner: 'attacker' | 'defender' | 'tie' = 'tie';\n    \n    if (attackSuccesses > counterAttackSuccesses) {\n      // Attacker wins\n      winner = 'attacker';\n      attackerDamage = attackDamageValue + attackSuccesses - counterAttackSuccesses;\n    } else if (counterAttackSuccesses > attackSuccesses) {\n      // Defender (counter-attacker) wins\n      winner = 'defender';\n      defenderDamage = counterAttackDamageValue + counterAttackSuccesses - attackSuccesses;\n    } else {\n      // Tie\n      isTie = true;\n      winner = 'tie';\n    }\n    \n    console.log('=== COUNTER-ATTACK RESULTS ===');\n    console.log('Attack Successes:', attackSuccesses);\n    console.log('Counter-Attack Successes:', counterAttackSuccesses);\n    console.log('Attack Damage Value:', attackDamageValue);\n    console.log('Counter-Attack Damage Value:', counterAttackDamageValue);\n    console.log('Winner:', winner);\n    console.log('Attacker Damage:', attackerDamage);\n    console.log('Defender Damage:', defenderDamage);\n    console.log('Original Attacker Name:', originalAttackerName);\n    console.log('Original Defender Name:', originalDefenderName);\n    console.log('--- Context ---');\n    console.log('Attacker param:', attacker?.name);\n    console.log('Defender param:', defender?.name);\n    console.log('AttackerToken object:', attackerToken ? 'Found' : 'Not found');\n    console.log('AttackerToken.name:', (attackerToken as any)?.name);\n    console.log('AttackerToken.document?.name:', attackerToken?.document?.name);\n    console.log('AttackerToken.actor?.name:', attackerToken?.actor?.name);\n    console.log('DefenderToken object:', defenderToken ? 'Found' : 'Not found');\n    console.log('DefenderToken.name:', (defenderToken as any)?.name);\n    console.log('DefenderToken.document?.name:', defenderToken?.document?.name);\n    console.log('DefenderToken.actor?.name:', defenderToken?.actor?.name);\n    console.log('--- UUIDs to be stored in flags ---');\n    console.log('attackerUuid (final):', finalAttackerUuid || 'Unknown');\n    console.log('attackerTokenUuid (final):', attackerTokenUuid || 'Unknown');\n    console.log('defenderUuid (final):', finalDefenderUuid || 'Unknown');\n    console.log('defenderTokenUuid (final):', defenderTokenUuid || 'Unknown');\n    console.log('==============================');\n    \n    // For counter-attack: attacker = counter-attacker (original defender), defender = original attacker\n    // Winner is determined by who has more successes\n    const originalAttackerUuid = finalDefenderUuid; // Original attacker is defender in counter-attack context\n    const originalDefenderUuid = finalAttackerUuid; // Original defender/counter-attacker is attacker in counter-attack context\n    \n    // Determine who inflicts damage based on winner\n    let damageInflicterUuid: string | undefined = undefined;\n    let damageReceiverUuid: string | undefined = undefined;\n    let damageInflicterName: string = '';\n    let damageReceiverName: string = '';\n    \n    if (winner === 'attacker') {\n      // Original attacker wins (attackSuccesses > counterAttackSuccesses)\n      // Original attacker inflicts damage to counter-attacker\n      damageInflicterUuid = originalAttackerUuid;\n      damageReceiverUuid = originalDefenderUuid;\n      damageInflicterName = originalAttackerName;\n      damageReceiverName = originalDefenderName;\n      console.log('Counter-attack: Original attacker wins - inflicts damage to counter-attacker');\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\n    } else if (winner === 'defender') {\n      // Counter-attacker wins (counterAttackSuccesses > attackSuccesses)\n      // Counter-attacker inflicts damage to original attacker\n      damageInflicterUuid = originalDefenderUuid;\n      damageReceiverUuid = originalAttackerUuid;\n      damageInflicterName = originalDefenderName;\n      damageReceiverName = originalAttackerName;\n      console.log('Counter-attack: Counter-attacker wins - inflicts damage to original attacker');\n      console.log('  Inflicter:', damageInflicterName, '(', damageInflicterUuid, ')');\n      console.log('  Receiver:', damageReceiverName, '(', damageReceiverUuid, ')');\n    }\n    \n    defenseResult = {\n      attackSuccesses: attackSuccesses,\n      counterAttackSuccesses: counterAttackSuccesses,\n      winner: winner,\n      attackerDamage: attackerDamage,\n      defenderDamage: defenderDamage,\n      isTie: isTie,\n      originalAttackerName: originalAttackerName,\n      originalDefenderName: originalDefenderName,\n      // UUIDs for applying damage\n      originalAttackerUuid: originalAttackerUuid,\n      originalDefenderUuid: originalDefenderUuid,\n      damageInflicterUuid: damageInflicterUuid,\n      damageReceiverUuid: damageReceiverUuid,\n      damageInflicterName: damageInflicterName,\n      damageReceiverName: damageReceiverName\n    };\n  }\n\n  // Prepare template data\n  // Create attacker and defender objects with correct UUIDs (token actor UUID for NPCs)\n  const attackerWithUuid = attacker ? {\n    ...attacker,\n    uuid: finalAttackerUuid || attacker.uuid // Use calculated UUID (token actor UUID for NPCs)\n  } : null;\n  \n  const defenderWithUuid = defenderData ? {\n    ...defenderData,\n    uuid: finalDefenderUuid || defenderData.uuid // Use calculated UUID (token actor UUID for NPCs)\n  } : null;\n  \n  const templateData: any = {\n    attacker: attackerWithUuid,\n    defender: defenderWithUuid,\n    rollData: rollData,\n    rollResult: rollResult,\n    isAttack: isAttack,\n    isDefend: rollData.isDefend || false,\n    isCounterAttack: rollData.isCounterAttack || false,\n    skillName: rollData.specName || rollData.skillName || rollData.linkedAttackSkill || 'Unknown',\n    itemName: rollData.itemName,\n    damageValue: rollData.damageValue,\n    defenseResult: defenseResult,\n    // Also pass UUIDs directly for template convenience\n    attackerUuid: finalAttackerUuid,\n    defenderUuid: finalDefenderUuid,\n    attackerTokenUuid: attackerTokenUuid,\n    defenderTokenUuid: defenderTokenUuid\n  };\n\n  // Render template\n  const html = await renderTemplate('systems/sra2/templates/roll-result.hbs', templateData);\n\n  // Create chat message\n  const messageData: any = {\n    user: game.user?.id,\n    speaker: {\n      actor: attacker?.id,\n      alias: attacker?.name\n    },\n    content: html,\n    type: CONST.CHAT_MESSAGE_TYPES.OTHER,\n    flags: {\n      sra2: {\n        rollType: isAttack ? 'attack' : 'skill',\n        attackerId: attacker?.id,\n        attackerUuid: finalAttackerUuid, // Use token's actor UUID if token exists, otherwise actor UUID\n        attackerTokenUuid: attackerTokenUuid, // Store token UUID\n        defenderId: defender?.id,\n        defenderUuid: finalDefenderUuid, // Use token's actor UUID if token exists, otherwise actor UUID\n        defenderTokenUuid: defenderTokenUuid, // Store token UUID\n        rollResult: rollResult,\n        rollData: rollData\n      }\n    }\n  };\n\n  await ChatMessage.create(messageData);\n}\n\n","/**\n * Shared Item Search Utilities for SRA2\n * This module contains common item search functions used across character sheets, NPC sheets, and item sheets.\n */\n\n/**\n * Normalize text for search: lowercase and remove accents/special characters\n */\nexport function normalizeSearchText(text: string): string {\n  return text\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, ''); // Remove diacritics\n}\n\n/**\n * Search result interface\n */\nexport interface SearchResult {\n  name: string;\n  uuid: string;\n  source: string;\n  type: string;\n  id?: string;\n  alreadyExists?: boolean;\n}\n\n/**\n * Search for items in world items\n */\nexport function searchItemsInWorld(\n  itemType: string,\n  searchTerm: string,\n  existingItemsCheck?: (itemName: string) => boolean\n): SearchResult[] {\n  const results: SearchResult[] = [];\n  \n  if (!game.items) return results;\n  \n  for (const item of game.items as any) {\n    if (item.type === itemType && normalizeSearchText(item.name).includes(searchTerm)) {\n      const alreadyExists = existingItemsCheck ? existingItemsCheck(item.name) : false;\n      \n      results.push({\n        name: item.name,\n        uuid: item.uuid,\n        id: item.id,\n        source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\n        type: itemType,\n        alreadyExists\n      });\n    }\n  }\n  \n  return results;\n}\n\n/**\n * Search for items in actor's items\n */\nexport function searchItemsOnActor(\n  actor: any,\n  itemType: string,\n  searchTerm: string\n): SearchResult[] {\n  const results: SearchResult[] = [];\n  \n  if (!actor) return results;\n  \n  for (const item of actor.items as any) {\n    if (item.type === itemType && normalizeSearchText(item.name).includes(searchTerm)) {\n      results.push({\n        name: item.name,\n        uuid: item.uuid,\n        id: item.id,\n        source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\n        type: itemType\n      });\n    }\n  }\n  \n  return results;\n}\n\n/**\n * Search for items in all compendiums\n */\nexport async function searchItemsInCompendiums(\n  itemType: string,\n  searchTerm: string,\n  existingItemsCheck?: (itemName: string) => boolean\n): Promise<SearchResult[]> {\n  const results: SearchResult[] = [];\n  const seenNames = new Set<string>();\n  \n  // Search in all compendiums\n  for (const pack of game.packs as any) {\n    // Only search in Item compendiums\n    if (pack.documentName !== 'Item') continue;\n    \n    // Get all documents from the pack\n    const documents = await pack.getDocuments();\n    \n    // Filter for items that match the search term and type\n    for (const doc of documents) {\n      if (doc.type === itemType && normalizeSearchText(doc.name).includes(searchTerm)) {\n        // Check if not already in results (by name)\n        if (seenNames.has(doc.name)) continue;\n        seenNames.add(doc.name);\n        \n        const alreadyExists = existingItemsCheck ? existingItemsCheck(doc.name) : false;\n        \n        results.push({\n          name: doc.name,\n          uuid: doc.uuid,\n          source: pack.title,\n          type: itemType,\n          alreadyExists\n        });\n      }\n    }\n  }\n  \n  return results;\n}\n\n/**\n * Perform a complete search across actor, world, and compendiums\n */\nexport async function searchItemsEverywhere(\n  itemType: string,\n  searchTerm: string,\n  actor?: any,\n  existingItemsCheck?: (itemName: string) => boolean\n): Promise<SearchResult[]> {\n  const results: SearchResult[] = [];\n  const seenNames = new Set<string>();\n  \n  // 1. Search in actor items if provided\n  if (actor) {\n    const actorResults = searchItemsOnActor(actor, itemType, searchTerm);\n    actorResults.forEach(result => {\n      results.push(result);\n      seenNames.add(result.name);\n    });\n  }\n  \n  // 2. Search in world items\n  const worldResults = searchItemsInWorld(itemType, searchTerm, existingItemsCheck);\n  worldResults.forEach(result => {\n    if (!seenNames.has(result.name)) {\n      results.push(result);\n      seenNames.add(result.name);\n    }\n  });\n  \n  // 3. Search in compendiums\n  const compendiumResults = await searchItemsInCompendiums(itemType, searchTerm, existingItemsCheck);\n  compendiumResults.forEach(result => {\n    if (!seenNames.has(result.name)) {\n      results.push(result);\n      seenNames.add(result.name);\n    }\n  });\n  \n  return results;\n}\n\n/**\n * Build HTML for search results display\n */\nexport interface DisplaySearchResultsOptions {\n  results: SearchResult[];\n  lastSearchTerm: string;\n  noResultsMessage: string;\n  typeLabel: string;\n  onAddCallback?: (result: SearchResult) => void;\n}\n\nexport function buildSearchResultsHtml(options: DisplaySearchResultsOptions): string {\n  const { results, lastSearchTerm, noResultsMessage, typeLabel } = options;\n  \n  // Check if there's a perfect match (case-insensitive and accent-insensitive)\n  const normalizedLastSearch = normalizeSearchText(lastSearchTerm);\n  const exactMatch = results.find(r => normalizeSearchText(r.name) === normalizedLastSearch);\n  \n  let html = '';\n  \n  if (results.length === 0) {\n    html = `\n      <div class=\"search-result-item no-results\">\n        <div class=\"no-results-text\">\n          ${noResultsMessage}\n        </div>\n      </div>\n    `;\n  } else {\n    // If we have an exact match, highlight it at the top\n    if (exactMatch) {\n      html += buildSingleResultHtml(exactMatch, typeLabel, true);\n    }\n    \n    // Display other search results\n    const otherResults = exactMatch \n      ? results.filter(r => r.name !== exactMatch.name)\n      : results;\n    \n    for (const result of otherResults) {\n      html += buildSingleResultHtml(result, typeLabel, false);\n    }\n  }\n  \n  return html;\n}\n\n/**\n * Build HTML for a single search result\n */\nfunction buildSingleResultHtml(result: SearchResult, typeLabel: string, isExactMatch: boolean): string {\n  const alreadyExistsClass = result.alreadyExists ? 'already-exists' : '';\n  const exactMatchClass = isExactMatch ? 'exact-match' : '';\n  \n  let html = `\n    <div class=\"search-result-item ${alreadyExistsClass} ${exactMatchClass}\" \n         data-result-name=\"${result.name}\" \n         data-result-uuid=\"${result.uuid}\">\n      <div class=\"result-info\">\n        <span class=\"result-name\">${result.name}</span>\n        <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\n      </div>\n  `;\n  \n  if (result.alreadyExists) {\n    html += `\n      <span class=\"already-exists-label\">\n        ${game.i18n!.localize('SRA2.SKILLS.ALREADY_EXISTS')}\n      </span>\n    `;\n  } else {\n    html += `\n      <button class=\"add-item-btn\" \n              data-item-name=\"${result.name}\" \n              data-item-uuid=\"${result.uuid}\">\n        ${game.i18n!.localize('SRA2.SKILLS.ADD')}\n      </button>\n    `;\n  }\n  \n  html += `</div>`;\n  \n  return html;\n}\n\n/**\n * Create a debounced search function\n */\nexport function createDebouncedSearch(\n  searchFunction: (searchTerm: string) => Promise<void>,\n  delay: number = 300\n): (searchTerm: string) => void {\n  let timeoutId: any = null;\n  \n  return (searchTerm: string) => {\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n    }\n    \n    timeoutId = setTimeout(async () => {\n      await searchFunction(searchTerm);\n    }, delay);\n  };\n}\n\n/**\n * Show or hide search results container\n */\nexport function toggleSearchResults(resultsDiv: HTMLElement, show: boolean): void {\n  if (show) {\n    resultsDiv.style.display = 'block';\n  } else {\n    resultsDiv.style.display = 'none';\n  }\n}\n\n/**\n * Check if an item already exists on an actor\n */\nexport function itemExistsOnActor(actor: any, itemType: string, itemName: string): boolean {\n  if (!actor) return false;\n  \n  return actor.items.some((item: any) => \n    item.type === itemType && item.name === itemName\n  );\n}\n\n/**\n * Add an item to an actor from UUID\n */\nexport async function addItemToActorFromUuid(actor: any, itemUuid: string): Promise<boolean> {\n  try {\n    const item = await fromUuid(itemUuid as any);\n    if (!item) {\n      ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ITEM_NOT_FOUND'));\n      return false;\n    }\n    \n    // Check if item already exists\n    if (itemExistsOnActor(actor, (item as any).type, (item as any).name)) {\n      ui.notifications?.warn(game.i18n!.format('SRA2.ALREADY_EXISTS', { name: (item as any).name }));\n      return false;\n    }\n    \n    // Add the item to the actor\n    await actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\n    ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.ADDED', { name: (item as any).name }));\n    \n    return true;\n  } catch (error) {\n    console.error('SRA2 | Error adding item to actor:', error);\n    ui.notifications?.error(game.i18n!.localize('SRA2.SKILLS.ERROR_ADDING'));\n    return false;\n  }\n}\n\n","/**\n * Shared Sheet Helpers for SRA2\n * Common functions used by both CharacterSheet and NpcSheet\n */\n\nimport * as ItemSearch from './item-search.js';\n\n/**\n * Handle form submission with proper damage checkbox handling\n */\nexport function handleSheetUpdate(actor: any, formData: any): any {\n  // Expand the form data first to handle nested properties properly\n  const expandedData = foundry.utils.expandObject(formData) as any;\n  \n  // Ensure damage structure exists and handle unchecked checkboxes\n  if (expandedData.system) {\n    const currentDamage = (actor.system as any).damage || {};\n    \n    // Initialize damage object if not present\n    if (!expandedData.system.damage) {\n      expandedData.system.damage = {};\n    }\n    \n    // Handle light damage checkboxes - if array not in formData, it means all are unchecked\n    if (currentDamage.light && !expandedData.system.damage.light) {\n      expandedData.system.damage.light = currentDamage.light.map(() => false);\n    } else if (expandedData.system.damage.light && currentDamage.light) {\n      // Fill missing indices with false\n      for (let i = 0; i < currentDamage.light.length; i++) {\n        if (expandedData.system.damage.light[i] === undefined) {\n          expandedData.system.damage.light[i] = false;\n        }\n      }\n    }\n    \n    // Handle severe damage checkboxes\n    if (currentDamage.severe && !expandedData.system.damage.severe) {\n      expandedData.system.damage.severe = currentDamage.severe.map(() => false);\n    } else if (expandedData.system.damage.severe && currentDamage.severe) {\n      for (let i = 0; i < currentDamage.severe.length; i++) {\n        if (expandedData.system.damage.severe[i] === undefined) {\n          expandedData.system.damage.severe[i] = false;\n        }\n      }\n    }\n    \n    // Handle incapacitating - if not in formData, set to false\n    if (expandedData.system.damage.incapacitating === undefined) {\n      expandedData.system.damage.incapacitating = false;\n    }\n  }\n  \n  return expandedData;\n}\n\n/**\n * Calculate final damage value for weapon/spell display\n */\nexport function calculateFinalDamageValue(damageValue: string, damageValueBonus: number, strength: number): string {\n  if (damageValue === \"FOR\") {\n    const total = strength + damageValueBonus;\n    return damageValueBonus > 0 ? `${total} (FOR+${damageValueBonus})` : `${total} (FOR)`;\n  } else if (damageValue.startsWith(\"FOR+\")) {\n    const modifier = parseInt(damageValue.substring(4)) || 0;\n    const total = strength + modifier + damageValueBonus;\n    return damageValueBonus > 0 ? `${total} (FOR+${modifier}+${damageValueBonus})` : `${total} (FOR+${modifier})`;\n  } else if (damageValue === \"toxin\") {\n    return \"selon toxine\";\n  } else {\n    const base = parseInt(damageValue) || 0;\n    const total = base + damageValueBonus;\n    return damageValueBonus > 0 ? `${total} (${base}+${damageValueBonus})` : total.toString();\n  }\n}\n\n/**\n * Organize specializations by linked skill\n */\nexport function organizeSpecializationsBySkill(\n  allSpecializations: any[],\n  actorItems: any[]\n): { bySkill: Map<string, any[]>; unlinked: any[] } {\n  const specializationsBySkill = new Map<string, any[]>();\n  const unlinkedSpecializations: any[] = [];\n  \n  allSpecializations.forEach((spec: any) => {\n    const linkedSkillName = spec.system.linkedSkill;\n    if (linkedSkillName) {\n      // linkedSkill is stored as a name, find the skill by name\n      const linkedSkill = actorItems.find((i: any) => \n        i.type === 'skill' && i.name === linkedSkillName\n      );\n      \n      if (linkedSkill && linkedSkill.id) {\n        // Valid linked skill found\n        const skillId = linkedSkill.id;\n        if (!specializationsBySkill.has(skillId)) {\n          specializationsBySkill.set(skillId, []);\n        }\n        specializationsBySkill.get(skillId)!.push(spec);\n      } else {\n        // Linked skill doesn't exist, mark as unlinked\n        unlinkedSpecializations.push(spec);\n      }\n    } else {\n      // No linked skill specified\n      unlinkedSpecializations.push(spec);\n    }\n  });\n  \n  return { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations };\n}\n\n/**\n * Handle item drop on actor sheet (feats, skills, specializations, metatypes)\n */\nexport async function handleItemDrop(\n  event: DragEvent,\n  actor: any,\n  allowedTypes: string[] = ['feat', 'skill', 'specialization', 'metatype']\n): Promise<boolean> {\n  const data = TextEditor.getDragEventData(event) as any;\n  \n  // Handle Item drops\n  if (data && data.type === 'Item') {\n    const item = await Item.implementation.fromDropData(data) as any;\n    \n    if (!item) return false;\n    \n    // Check if the item is from a compendium or another actor (not already on this actor)\n    if (item.actor && item.actor.id === actor.id) {\n      // Item already belongs to this actor, ignore\n      return false;\n    }\n    \n    // Check if type is allowed\n    if (!allowedTypes.includes(item.type)) {\n      return false;\n    }\n    \n    // Handle metatype\n    if (item.type === 'metatype') {\n      const existingMetatype = actor.items.find((i: any) => i.type === 'metatype');\n      if (existingMetatype) {\n        ui.notifications?.warn(game.i18n!.localize('SRA2.METATYPES.ONLY_ONE_METATYPE'));\n        return false;\n      }\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\n      return true;\n    }\n    \n    // Handle feat\n    if (item.type === 'feat') {\n      const existingFeat = actor.items.find((i: any) => \n        i.type === 'feat' && i.name === item.name\n      );\n      if (existingFeat) {\n        ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: item.name }));\n        return false;\n      }\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\n      return true;\n    }\n    \n    // Handle skill\n    if (item.type === 'skill') {\n      const existingSkill = actor.items.find((i: any) => \n        i.type === 'skill' && i.name === item.name\n      );\n      if (existingSkill) {\n        ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: item.name }));\n        return false;\n      }\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\n      return true;\n    }\n    \n    // Handle specialization\n    if (item.type === 'specialization') {\n      const existingSpec = actor.items.find((i: any) => \n        i.type === 'specialization' && i.name === item.name\n      );\n      if (existingSpec) {\n        ui.notifications?.warn(game.i18n!.format('SRA2.SPECIALIZATIONS.ALREADY_EXISTS', { name: item.name }));\n        return false;\n      }\n      await actor.createEmbeddedDocuments('Item', [item.toObject()]);\n      return true;\n    }\n  }\n  \n  return false;\n}\n\n/**\n * Get RR for a specific item type and name (wrapper for DiceRoller)\n */\nexport function getRRSources(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\n  const sources: Array<{featName: string, rrValue: number}> = [];\n  \n  const feats = actor.items.filter((item: any) => \n    item.type === 'feat' && \n    item.system.active === true\n  );\n  \n  // Normalize the search name for comparison (case-insensitive, accent-insensitive)\n  const normalizedItemName = ItemSearch.normalizeSearchText(itemName);\n  \n  for (const feat of feats) {\n    const featSystem = feat.system as any;\n    const rrList = featSystem.rrList || [];\n    \n    for (const rrEntry of rrList) {\n      const rrType = rrEntry.rrType;\n      const rrValue = rrEntry.rrValue || 0;\n      const rrTarget = rrEntry.rrTarget || '';\n      \n      // Normalize the RR target for comparison\n      const normalizedRRTarget = ItemSearch.normalizeSearchText(rrTarget);\n      \n      // Compare normalized names for better matching (handles custom skills/specs with variations)\n      if (rrType === itemType && normalizedRRTarget === normalizedItemName && rrValue > 0) {\n        sources.push({\n          featName: feat.name,\n          rrValue: rrValue\n        });\n      }\n    }\n  }\n  \n  return sources;\n}\n\n/**\n * Calculate Risk Reduction for a given skill, specialization, or attribute\n */\nexport function calculateRR(actor: any, itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\n  const sources = getRRSources(actor, itemType, itemName);\n  return sources.reduce((total, source) => total + source.rrValue, 0);\n}\n\n/**\n * Generic handler to edit an item from an actor\n */\nexport async function handleEditItem(event: Event, actor: any): Promise<void> {\n  event.preventDefault();\n  const element = event.currentTarget as HTMLElement;\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\n  \n  if (!itemId) return;\n\n  const item = actor.items.get(itemId);\n  if (item) {\n    item.sheet?.render(true);\n  }\n}\n\n/**\n * Generic handler to delete an item from an actor\n */\nexport async function handleDeleteItem(event: Event, actor: any, sheetRender?: (refresh: boolean) => void): Promise<void> {\n  event.preventDefault();\n  const element = event.currentTarget as HTMLElement;\n  const itemId = element.dataset.itemId || (element.closest('.metatype-item') as HTMLElement)?.getAttribute('data-item-id');\n  \n  if (!itemId) return;\n\n  const item = actor.items.get(itemId);\n  if (item) {\n    await item.delete();\n    if (sheetRender) {\n      sheetRender(false);\n    }\n  }\n}\n\n/**\n * Enrich feats with RR entries and final damage values\n */\nexport function enrichFeats(feats: any[], actorStrength: number, calculateFinalDamageValueFn: (dv: string, bonus: number, str: number) => string, actor?: any): any[] {\n  return feats.map((feat: any) => {\n    // Add translated labels for attribute targets in RR entries\n    feat.rrEntries = [];\n    const itemRRList = feat.system.rrList || [];\n    \n    // For weapons and spells, also include RR from linked skills/specs/attributes\n    let allRRList = [...itemRRList];\n    \n    if (actor && (feat.system.featType === 'weapon' || feat.system.featType === 'spell' || feat.system.featType === 'weapons-spells')) {\n      const { normalizeSearchText } = ItemSearch;\n      \n      // Get linked skill and specialization from weapon\n      const linkedAttackSkill = feat.system.linkedAttackSkill || '';\n      const linkedAttackSpec = feat.system.linkedAttackSpecialization || '';\n      \n      let attackSpecName: string | undefined = undefined;\n      let attackSkillName: string | undefined = undefined;\n      let attackLinkedAttribute: string | undefined = undefined;\n      \n      // Try to find the linked attack specialization first\n      if (linkedAttackSpec) {\n        const foundSpec = actor.items.find((i: any) => \n          i.type === 'specialization' && \n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSpec)\n        );\n        \n        if (foundSpec) {\n          const specSystem = foundSpec.system as any;\n          attackSpecName = foundSpec.name;\n          attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n          \n          // Get parent skill for specialization\n          const linkedSkillName = specSystem.linkedSkill;\n          if (linkedSkillName) {\n            const parentSkill = actor.items.find((i: any) => \n              i.type === 'skill' && i.name === linkedSkillName\n            );\n            if (parentSkill) {\n              attackSkillName = parentSkill.name;\n            }\n          }\n        }\n      }\n      \n      // If no specialization found, try to find the linked attack skill\n      if (!attackSpecName && linkedAttackSkill) {\n        const foundSkill = actor.items.find((i: any) => \n          i.type === 'skill' && \n          normalizeSearchText(i.name) === normalizeSearchText(linkedAttackSkill)\n        );\n        \n        if (foundSkill) {\n          attackSkillName = foundSkill.name;\n          attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        }\n      }\n      \n      // Get RR sources from skill/specialization/attribute\n      if (attackSpecName) {\n        const specRRSources = getRRSources(actor, 'specialization', attackSpecName);\n        allRRList = [...allRRList, ...specRRSources.map(rr => ({\n          rrType: 'specialization',\n          rrValue: rr.rrValue,\n          rrTarget: attackSpecName\n        }))];\n      }\n      if (attackSkillName) {\n        const skillRRSources = getRRSources(actor, 'skill', attackSkillName);\n        allRRList = [...allRRList, ...skillRRSources.map(rr => ({\n          rrType: 'skill',\n          rrValue: rr.rrValue,\n          rrTarget: attackSkillName\n        }))];\n      }\n      if (attackLinkedAttribute) {\n        const attributeRRSources = getRRSources(actor, 'attribute', attackLinkedAttribute);\n        allRRList = [...allRRList, ...attributeRRSources.map(rr => ({\n          rrType: 'attribute',\n          rrValue: rr.rrValue,\n          rrTarget: attackLinkedAttribute\n        }))];\n      }\n    }\n    \n    // Process all RR entries (item RR + skill/spec/attribute RR)\n    for (let i = 0; i < allRRList.length; i++) {\n      const rrEntry = allRRList[i];\n      const rrType = rrEntry.rrType;\n      const rrValue = rrEntry.rrValue || 0;\n      const rrTarget = rrEntry.rrTarget || '';\n      \n      if (rrValue > 0) {\n      const entry: any = { rrType, rrValue, rrTarget };\n      \n      if (rrType === 'attribute' && rrTarget) {\n        entry.rrTargetLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${rrTarget.toUpperCase()}`);\n      }\n      \n      feat.rrEntries.push(entry);\n      }\n    }\n    \n    // Calculate final damage value for weapons and spells\n    if (feat.system.featType === 'weapon' || feat.system.featType === 'spell' || feat.system.featType === 'weapons-spells') {\n      const damageValue = feat.system.damageValue || '0';\n      const damageValueBonus = feat.system.damageValueBonus || 0;\n      \n      feat.finalDamageValue = calculateFinalDamageValueFn(damageValue, damageValueBonus, actorStrength);\n    }\n    \n    return feat;\n  });\n}\n\n","/**\n * Combat Helpers for SRA2\n * Shared functions for combat, defense, and attack calculations\n */\n\nimport * as ItemSearch from './item-search.js';\nimport { VEHICLE_TYPES } from '../models/item-feat.js';\n\n/**\n * Calculate NPC threshold for a skill or specialization\n */\nexport function calculateNPCThreshold(\n  actor: any,\n  item: any,\n  dicePool: number,\n  itemType: 'skill' | 'specialization',\n  parentSkill?: any\n): { threshold: number; totalRR: number } {\n  let totalRR = 0;\n  \n  // Get all active feats\n  const activeFeats = actor.items.filter((i: any) => \n    i.type === 'feat' && i.system.active === true\n  );\n  \n  // Get linked attribute for this item\n  const linkedAttribute = item.system.linkedAttribute;\n  \n  // Check each feat for RR that applies\n  activeFeats.forEach((feat: any) => {\n    const rrList = feat.system.rrList || [];\n    rrList.forEach((rrEntry: any) => {\n      // Check if RR applies to this item\n      if (itemType === 'skill' && rrEntry.rrType === 'skill' && rrEntry.rrTarget === item.name) {\n        totalRR += rrEntry.rrValue || 0;\n      } else if (itemType === 'specialization') {\n        // For specializations, check spec RR and also inherit skill RR\n        if (rrEntry.rrType === 'specialization' && rrEntry.rrTarget === item.name) {\n          totalRR += rrEntry.rrValue || 0;\n        } else if (parentSkill && rrEntry.rrType === 'skill' && rrEntry.rrTarget === parentSkill.name) {\n          totalRR += rrEntry.rrValue || 0;\n        }\n      }\n      \n      // Also check for attribute RR\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\n        totalRR += rrEntry.rrValue || 0;\n      }\n    });\n  });\n  \n  // Calculate NPC threshold: round(dice pool / 3) + RR + 1\n  const threshold = Math.round(dicePool / 3) + totalRR + 1;\n  \n  return { threshold, totalRR };\n}\n\n/**\n * Build skill and specialization options HTML for defense dialog\n */\nexport interface BuildSkillOptionsParams {\n  defenderActor: any;\n  skills: any[];\n  allSpecializations: any[];\n  defaultSelection: string;\n  includeThreshold?: boolean; // Whether to show NPC threshold\n}\n\nexport function buildSkillOptionsHtml(params: BuildSkillOptionsParams): string {\n  const { defenderActor, skills, allSpecializations, defaultSelection, includeThreshold = false } = params;\n  \n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.COMBAT.SELECT_DEFENSE_SKILL') + ' --</option>';\n  \n  // Sort skills alphabetically by name\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\n  \n  sortedSkills.forEach((skill: any) => {\n    const skillSystem = skill.system as any;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    const attributeValue = (defenderActor.system as any).attributes?.[linkedAttribute] || 0;\n    const skillRating = skillSystem.rating || 0;\n    const totalDicePool = attributeValue + skillRating;\n    \n    let optionText = `${skill.name} (${totalDicePool} dés)`;\n    let dataAttrs = `data-dice-pool=\"${totalDicePool}\"`;\n    \n    // Calculate threshold if requested\n    if (includeThreshold) {\n      const { threshold } = calculateNPCThreshold(defenderActor, skill, totalDicePool, 'skill');\n      optionText = `${skill.name} (${game.i18n!.localize('SRA2.NPC.THRESHOLD')}: ${threshold} / ${totalDicePool} dés)`;\n      dataAttrs += ` data-threshold=\"${threshold}\"`;\n    }\n    \n    // Check if this skill should be selected by default\n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\n    \n    html += `<option value=\"skill-${skill.id}\" ${dataAttrs}${selected}>${optionText}</option>`;\n    \n    // Add specializations for this skill\n    const specs = allSpecializations.filter((spec: any) => {\n      const linkedSkillName = spec.system.linkedSkill;\n      return ItemSearch.normalizeSearchText(linkedSkillName) === ItemSearch.normalizeSearchText(skill.name);\n    });\n    \n    specs.forEach((spec: any) => {\n      const specSystem = spec.system as any;\n      const specLinkedAttribute = specSystem.linkedAttribute || 'strength';\n      const specAttributeValue = (defenderActor.system as any).attributes?.[specLinkedAttribute] || 0;\n      const parentRating = skillRating;\n      const effectiveRating = parentRating + 2;\n      const specTotalDicePool = specAttributeValue + effectiveRating;\n      \n      let specOptionText = `  → ${spec.name} (${specTotalDicePool} dés)`;\n      let specDataAttrs = `data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"`;\n      \n      // Calculate threshold if requested\n      if (includeThreshold) {\n        const { threshold: specThreshold } = calculateNPCThreshold(defenderActor, spec, specTotalDicePool, 'specialization', skill);\n        specOptionText = `  → ${spec.name} (${game.i18n!.localize('SRA2.NPC.THRESHOLD')}: ${specThreshold} / ${specTotalDicePool} dés)`;\n        specDataAttrs += ` data-threshold=\"${specThreshold}\"`;\n      }\n      \n      // Check if this specialization should be selected by default\n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\n      \n      html += `<option value=\"spec-${spec.id}\" ${specDataAttrs}${specSelected}>${specOptionText}</option>`;\n    });\n  });\n  \n  return html;\n}\n\n/**\n * REMOVED: Defense dice roll function\n */\n\n/**\n * REMOVED: Dice results HTML building\n */\n\n/**\n * Parse weapon damage value and calculate base VD\n * Includes damageValueBonus from weapon feat\n */\nexport function parseWeaponDamageValue(\n  weaponDamageValue: string | number,\n  actorStrength: number,\n  damageValueBonus: number = 0\n): { baseVD: number; vdDisplay: string } {\n  // Ensure weaponDamageValue is a string\n  const vdString = String(weaponDamageValue);\n  \n  let baseVD = 0;\n  let vdDisplay = vdString;\n  \n  if (vdString === 'FOR') {\n    baseVD = actorStrength + damageValueBonus;\n    if (damageValueBonus > 0) {\n      vdDisplay = `FOR+${damageValueBonus} (${baseVD})`;\n    } else {\n      vdDisplay = `FOR (${actorStrength})`;\n    }\n  } else if (vdString.startsWith('FOR+')) {\n    const modifier = parseInt(vdString.substring(4)) || 0;\n    baseVD = actorStrength + modifier + damageValueBonus;\n    if (damageValueBonus > 0) {\n      vdDisplay = `FOR+${modifier}+${damageValueBonus} (${baseVD})`;\n    } else {\n      vdDisplay = `FOR+${modifier} (${baseVD})`;\n    }\n  } else if (vdString === 'toxin') {\n    vdDisplay = 'selon toxine';\n    baseVD = -1; // Special case\n  } else {\n    const base = parseInt(vdString) || 0;\n    baseVD = base + damageValueBonus;\n    if (damageValueBonus > 0) {\n      vdDisplay = `${baseVD} (${base}+${damageValueBonus})`;\n    } else {\n      vdDisplay = `${baseVD}`;\n    }\n  }\n  \n  return { baseVD, vdDisplay };\n}\n\n/**\n * REMOVED: NPC attack HTML building\n */\n\n/**\n * REMOVED: Threshold defense result creation\n */\n\n/**\n * Build skill selection options for weapon/spell attack\n * Similar to buildSkillOptionsHtml but without threshold calculation\n */\nexport function buildAttackSkillOptionsHtml(\n  actor: any,\n  skills: any[],\n  allSpecializations: any[],\n  defaultSelection: string\n): string {\n  let html = '<option value=\"\">-- ' + game.i18n!.localize('SRA2.FEATS.WEAPON.SELECT_SKILL') + ' --</option>';\n  \n  // Sort skills alphabetically by name\n  const sortedSkills = [...skills].sort((a: any, b: any) => a.name.localeCompare(b.name));\n  \n  sortedSkills.forEach((skill: any) => {\n    const skillSystem = skill.system as any;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    const attributeValue = (actor.system as any).attributes?.[linkedAttribute] || 0;\n    const skillRating = skillSystem.rating || 0;\n    const totalDicePool = attributeValue + skillRating;\n    \n    const selected = defaultSelection === `skill-${skill.id}` ? ' selected' : '';\n    html += `<option value=\"skill-${skill.id}\" data-dice-pool=\"${totalDicePool}\"${selected}>${skill.name} (${totalDicePool} dés)</option>`;\n    \n    // Add specializations for this skill\n    const specs = allSpecializations.filter((spec: any) => {\n      const linkedSkillName = spec.system.linkedSkill;\n      return ItemSearch.normalizeSearchText(linkedSkillName) === ItemSearch.normalizeSearchText(skill.name);\n    });\n    \n    specs.forEach((spec: any) => {\n      const specSystem = spec.system as any;\n      const specLinkedAttribute = specSystem.linkedAttribute || 'strength';\n      const specAttributeValue = (actor.system as any).attributes?.[specLinkedAttribute] || 0;\n      const parentRating = skillRating;\n      const effectiveRating = parentRating + 2;\n      const specTotalDicePool = specAttributeValue + effectiveRating;\n      \n      const specSelected = defaultSelection === `spec-${spec.id}` ? ' selected' : '';\n      html += `<option value=\"spec-${spec.id}\" data-dice-pool=\"${specTotalDicePool}\" data-effective-rating=\"${effectiveRating}\"${specSelected}>  → ${spec.name} (${specTotalDicePool} dés)</option>`;\n    });\n  });\n  \n  return html;\n}\n\n/**\n * REMOVED: Weapon/spell dialog content creation\n */\n\n/**\n * REMOVED: Attack result display and chat message creation\n */\n\n/**\n * Prepare vehicle/drone weapon attack data for dice rolling\n * Vehicles use autopilot as dice pool instead of skills\n */\nexport function prepareVehicleWeaponAttack(\n  vehicleActor: any,\n  weapon: any\n): {\n  dicePool: number;\n  rrList: Array<{ featName: string; rrValue: number }>;\n  damageValue: string;\n} {\n  const vehicleSystem = vehicleActor.system as any;\n  const weaponSystem = weapon.system as any;\n  \n  // Get autopilot as base dice pool (with bonus included)\n  // attributes.autopilot should already contain finalAutopilot = baseAutopilot + autopilotBonus (max 12)\n  // But to ensure bonus is always included, we recalculate it if needed\n  let autopilot = vehicleSystem.attributes?.autopilot;\n  \n  // Always recalculate to ensure autopilotBonus is included (in case prepareDerivedData wasn't called)\n  const vehicleType = vehicleSystem.vehicleType || \"\";\n  const vehicleStats = vehicleType && VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \n    ? VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES] \n    : null;\n  const baseAutopilot = vehicleStats?.autopilot || 6;\n  const autopilotBonus = vehicleSystem.autopilotBonus || 0;\n  const calculatedAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\n  \n  // Use calculated value to ensure bonus is always included\n  autopilot = calculatedAutopilot;\n  const dicePool = autopilot;\n  \n  // Get all active feats for RR calculation\n  const activeFeats = vehicleActor.items.filter((item: any) => \n    item.type === 'feat' && item.system.active === true\n  );\n  \n  // Calculate RR from active feats (only autopilot attribute RR applies)\n  const rrList: Array<{ featName: string; rrValue: number }> = [];\n  activeFeats.forEach((feat: any) => {\n    const featRRList = feat.system.rrList || [];\n    featRRList.forEach((rrEntry: any) => {\n      if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\n        rrList.push({\n          featName: feat.name,\n          rrValue: rrEntry.rrValue || 0\n        });\n      }\n    });\n  });\n  \n  // Also check weapon's own RR list and enrich with featName\n  const weaponRRList = weaponSystem.rrList || [];\n  weaponRRList.forEach((rrEntry: any) => {\n    if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\n      rrList.push({\n        featName: weapon.name,\n        rrValue: rrEntry.rrValue || 0\n      });\n    }\n  });\n  \n  // Calculate final damage value (base + bonus) - same logic as character-sheet.ts\n  const baseDamageValue = parseInt(weaponSystem.damageValue || '0') || 0;\n  const damageValueBonus = parseInt(weaponSystem.damageValueBonus || '0') || 0;\n  \n  let finalDamageValue = baseDamageValue + damageValueBonus;\n  \n  return {\n    dicePool,\n    rrList,\n    damageValue: finalDamageValue.toString()\n  };\n}\n\n/**\n * Prepare complete vehicle/drone weapon roll request data for DiceRoller\n * Uses prepareVehicleWeaponAttack and adds weapon type links\n */\nexport function prepareVehicleWeaponRollRequest(\n  vehicleActor: any,\n  weapon: any,\n  WEAPON_TYPES: any\n): any {\n  const weaponSystem = weapon.system as any;\n  const weaponType = weaponSystem.weaponType || 'custom-weapon';\n  \n  // Get weapon attack data using existing helper\n  const attackData = prepareVehicleWeaponAttack(vehicleActor, weapon);\n  \n  // Get weapon type links for defense skills\n  let weaponLinkedDefenseSkill = '';\n  let weaponLinkedDefenseSpecialization = '';\n  \n  if (weaponType && weaponType !== 'custom-weapon') {\n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n    if (weaponStats) {\n      weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n      weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n    }\n  }\n  \n  // Merge with custom fields (weapon type has priority)\n  const finalDefenseSkill = weaponLinkedDefenseSkill || weaponSystem.linkedDefenseSkill || '';\n  const finalDefenseSpec = weaponLinkedDefenseSpecialization || weaponSystem.linkedDefenseSpecialization || '';\n  \n  // Return complete roll request data\n  return {\n    itemType: 'weapon',\n    weaponType: weaponType,\n    itemName: weapon.name,\n    itemId: weapon.id,\n    itemRating: weaponSystem.rating || 0,\n    itemActive: weaponSystem.active,\n    \n    // No linked attack skill/spec for vehicles (uses autopilot directly)\n    linkedAttackSkill: '',\n    linkedAttackSpecialization: '',\n    linkedDefenseSkill: finalDefenseSkill,\n    linkedDefenseSpecialization: finalDefenseSpec,\n    linkedAttribute: 'autopilot', // Vehicles use autopilot attribute\n    \n    // Weapon properties\n    isWeaponFocus: weaponSystem.isWeaponFocus || false,\n    damageValue: attackData.damageValue, // Already includes bonus\n    meleeRange: weaponSystem.meleeRange,\n    shortRange: weaponSystem.shortRange,\n    mediumRange: weaponSystem.mediumRange,\n    longRange: weaponSystem.longRange,\n    \n    // Attack skill/spec (empty for vehicles, dice pool comes from autopilot)\n    skillName: undefined,\n    skillLevel: attackData.dicePool, // Use autopilot as skill level for dice pool\n    specName: undefined,\n    specLevel: undefined,\n    \n    // Actor information\n    actorId: vehicleActor.id,\n    actorUuid: vehicleActor.uuid,\n    actorName: vehicleActor.name || '',\n    \n    // RR List\n    rrList: attackData.rrList\n  };\n}\n\n/**\n * Apply damage to a defender (character, NPC, or vehicle/drone)\n * Handles different damage thresholds for vehicles vs characters\n */\nexport async function applyDamage(defenderUuid: string, damageValue: number, defenderName: string): Promise<void> {\n  // Use fromUuid to get the token's actor if it's a token UUID, or the actor if it's an actor UUID\n  const defender = await fromUuid(defenderUuid as any) as any;\n  \n  if (!defender) {\n    ui.notifications?.error(`Cannot find defender: ${defenderName}`);\n    return;\n  }\n  \n  // If this is a token, get its actor\n  const defenderActor = defender.actor || defender;\n  \n  const defenderSystem = defenderActor.system as any;\n  const isVehicle = defenderActor.type === 'vehicle';\n  \n  // Get damage thresholds based on actor type\n  let damageThresholds: { light: number; moderate?: number; severe: number; incapacitating?: number };\n  if (isVehicle) {\n    // For vehicles/drones, thresholds are directly in damageThresholds\n    damageThresholds = defenderSystem.damageThresholds || {\n      light: 1,\n      severe: 4,\n      incapacitating: 7\n    };\n  } else {\n    // For characters, thresholds are in damageThresholds.withArmor\n    damageThresholds = defenderSystem.damageThresholds?.withArmor || {\n      light: 1,\n      moderate: 4,\n      severe: 7\n    };\n  }\n  \n  // Deep copy of damage object with arrays\n  let damage = {\n    light: [...(defenderSystem.damage?.light || [])],\n    severe: [...(defenderSystem.damage?.severe || [])],\n    incapacitating: defenderSystem.damage?.incapacitating || false\n  };\n  let damageType = '';\n  let overflow = false;\n  \n  // Determine damage type based on thresholds\n  // For vehicles: light = Structure + Armor, severe = (2 × Structure) + Armor, incapacitating = (3 × Structure) + Armor\n  // For characters: light, moderate, severe from withArmor thresholds\n  \n  if (isVehicle) {\n    // Vehicle/drone damage thresholds\n    if (damageThresholds.incapacitating && damageValue > damageThresholds.incapacitating) {\n      // Incapacitating wound: VD > (3 × Structure) + Blindage\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\n      damage.incapacitating = true;\n    } else if (damageValue > damageThresholds.severe) {\n      // Severe wound: VD > (2 × Structure) + Blindage\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\n      \n      // Find first empty severe box\n      let applied = false;\n      for (let i = 0; i < damage.severe.length; i++) {\n        if (!damage.severe[i]) {\n          damage.severe[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in severe, overflow to incapacitating\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n        damage.incapacitating = true;\n        overflow = true;\n      }\n    } else if (damageValue > damageThresholds.light) {\n      // Light wound: VD > Structure + Blindage\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\n      \n      // Find first empty light box\n      let applied = false;\n      for (let i = 0; i < damage.light.length; i++) {\n        if (!damage.light[i]) {\n          damage.light[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in light, overflow to severe\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\n        \n        // Try to apply to severe\n        let severeApplied = false;\n        for (let i = 0; i < damage.severe.length; i++) {\n          if (!damage.severe[i]) {\n            damage.severe[i] = true;\n            severeApplied = true;\n            break;\n          }\n        }\n        \n        // If no space in severe either, overflow to incapacitating\n        if (!severeApplied) {\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n          damage.incapacitating = true;\n        }\n        overflow = true;\n      }\n    } else {\n      // Damage below light threshold, no wound: VD ≤ Structure + Blindage\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \n        damage: `${damageValue} (en dessous du seuil)`,\n        target: defenderName \n      }));\n      return;\n    }\n  } else {\n    // Character damage thresholds\n    if (damageValue > damageThresholds.severe) {\n      // Incapacitating wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_INCAPACITATING');\n      damage.incapacitating = true;\n    } else if (damageThresholds.moderate && damageValue > damageThresholds.moderate) {\n      // Severe wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_SEVERE');\n      \n      // Find first empty severe box\n      let applied = false;\n      for (let i = 0; i < damage.severe.length; i++) {\n        if (!damage.severe[i]) {\n          damage.severe[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in severe, overflow to incapacitating\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n        damage.incapacitating = true;\n        overflow = true;\n      }\n    } else if (damageValue > damageThresholds.light) {\n      // Light wound\n      damageType = game.i18n!.localize('SRA2.COMBAT.DAMAGE_LIGHT');\n      \n      // Find first empty light box\n      let applied = false;\n      for (let i = 0; i < damage.light.length; i++) {\n        if (!damage.light[i]) {\n          damage.light[i] = true;\n          applied = true;\n          break;\n        }\n      }\n      \n      // If no space in light, overflow to severe\n      if (!applied) {\n        ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT'));\n        \n        // Try to apply to severe\n        let severeApplied = false;\n        for (let i = 0; i < damage.severe.length; i++) {\n          if (!damage.severe[i]) {\n            damage.severe[i] = true;\n            severeApplied = true;\n            break;\n          }\n        }\n        \n        // If no space in severe either, overflow to incapacitating\n        if (!severeApplied) {\n          ui.notifications?.info(game.i18n!.localize('SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE'));\n          damage.incapacitating = true;\n        }\n        overflow = true;\n      }\n    } else {\n      // Damage below light threshold, no wound\n      ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \n        damage: `${damageValue} (en dessous du seuil)`,\n        target: defenderName \n      }));\n      return;\n    }\n  }\n  \n  // Update the actor's damage (use defenderActor to update the token's actor data)\n  // The prepareDerivedData() method now preserves existing damage values, so normal update should work\n  await defenderActor.update({ 'system.damage': damage });\n  \n  // Check if now incapacitated\n  if (damage.incapacitating === true) {\n    ui.notifications?.error(game.i18n!.format('SRA2.COMBAT.NOW_INCAPACITATED', { target: defenderName }));\n  } else {\n    ui.notifications?.info(game.i18n!.format('SRA2.COMBAT.DAMAGE_APPLIED', { \n      damage: overflow ? `${damageType} (débordement)` : damageType,\n      target: defenderName \n    }));\n  }\n}\n\n","import * as DiceRoller from '../helpers/dice-roller.js';\nimport * as ItemSearch from '../helpers/item-search.js';\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\nimport { WEAPON_TYPES } from '../models/item-feat.js';\n\n/**\n * Character Sheet Application\n */\nexport class CharacterSheet extends ActorSheet {\n  /** Active section for tabbed navigation */\n  private _activeSection: string = 'identity';\n\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'actor', 'character'],\n      template: 'systems/sra2/templates/actor-character-sheet.hbs',\n      width: 900,\n      height: 700,\n      tabs: [],\n      dragDrop: [\n        { dragSelector: '.metatype-item', dropSelector: null },\n        { dragSelector: '.feat-item', dropSelector: null },\n        { dragSelector: '.skill-item', dropSelector: null },\n        { dragSelector: '.specialization-item', dropSelector: null }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n\n    // Ensure system data is available\n    context.system = this.actor.system;\n    \n    // Ensure damage arrays are properly initialized\n    const systemData = context.system as any;\n    if (!systemData.damage) {\n      systemData.damage = {\n        light: [false, false],\n        severe: [false],\n        incapacitating: false\n      };\n    } else {\n      // Ensure arrays exist and have at least the minimum length\n      if (!Array.isArray(systemData.damage.light)) {\n        systemData.damage.light = [false, false];\n      } else if (systemData.damage.light.length < 2) {\n        while (systemData.damage.light.length < 2) {\n          systemData.damage.light.push(false);\n        }\n      }\n      \n      if (!Array.isArray(systemData.damage.severe)) {\n        systemData.damage.severe = [false];\n      }\n      \n      if (typeof systemData.damage.incapacitating !== 'boolean') {\n        systemData.damage.incapacitating = false;\n      }\n    }\n    \n    // Ensure anarchySpent array is properly initialized\n    if (!Array.isArray(systemData.anarchySpent)) {\n      systemData.anarchySpent = [false, false, false];\n    } else if (systemData.anarchySpent.length < 3) {\n      while (systemData.anarchySpent.length < 3) {\n        systemData.anarchySpent.push(false);\n      }\n    }\n\n    // Get metatype (there should be only one)\n    const metatypes = this.actor.items.filter((item: any) => item.type === 'metatype');\n    context.metatype = metatypes.length > 0 ? metatypes[0] : null;\n\n    // Get actor's strength for damage value calculations\n    const actorStrength = (this.actor.system as any).attributes?.strength || 0;\n    \n    // Get feats and enrich with RR target labels and calculated damage values\n    const rawFeats = this.actor.items.filter((item: any) => item.type === 'feat');\n    const allFeats = SheetHelpers.enrichFeats(rawFeats, actorStrength, SheetHelpers.calculateFinalDamageValue, this.actor);\n    \n    // Group feats by type\n    context.featsByType = {\n      trait: allFeats.filter((feat: any) => feat.system.featType === 'trait'),\n      contact: allFeats.filter((feat: any) => feat.system.featType === 'contact'),\n      awakened: allFeats.filter((feat: any) => feat.system.featType === 'awakened'),\n      adeptPower: allFeats.filter((feat: any) => feat.system.featType === 'adept-power'),\n      equipment: allFeats.filter((feat: any) => feat.system.featType === 'equipment'),\n      cyberware: allFeats.filter((feat: any) => feat.system.featType === 'cyberware'),\n      cyberdeck: allFeats.filter((feat: any) => feat.system.featType === 'cyberdeck'),\n      vehicle: allFeats.filter((feat: any) => feat.system.featType === 'vehicle'),\n      weaponsSpells: allFeats.filter((feat: any) => feat.system.featType === 'weapons-spells'),\n      weapon: allFeats.filter((feat: any) => feat.system.featType === 'weapon'),\n      spell: allFeats.filter((feat: any) => feat.system.featType === 'spell')\n    };\n    \n    // Keep the feats array for backwards compatibility\n    context.feats = allFeats;\n    \n    // Get bookmarked items (skills, specializations, weapons, spells)\n    const bookmarkedItems = this.actor.items.filter((item: any) => \n      (item.type === 'skill' || item.type === 'specialization' || item.type === 'feat') && \n      item.system.bookmarked === true\n    );\n    context.bookmarkedItems = bookmarkedItems;\n    \n    // Get skills (sorted alphabetically)\n    const skills = this.actor.items\n      .filter((item: any) => item.type === 'skill')\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\n    \n    // Get all specializations (sorted alphabetically)\n    const allSpecializations = this.actor.items\n      .filter((item: any) => item.type === 'specialization')\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\n    \n    // Organize specializations by linked skill using helper\n    const { bySkill: specializationsBySkill, unlinked: unlinkedSpecializations } = \n      SheetHelpers.organizeSpecializationsBySkill(allSpecializations, this.actor.items.contents);\n    \n    // Calculate RR for attributes first (needed for skills and specializations)\n    const attributesRR = {\n      strength: Math.min(3, this.calculateRR('attribute', 'strength')),\n      agility: Math.min(3, this.calculateRR('attribute', 'agility')),\n      willpower: Math.min(3, this.calculateRR('attribute', 'willpower')),\n      logic: Math.min(3, this.calculateRR('attribute', 'logic')),\n      charisma: Math.min(3, this.calculateRR('attribute', 'charisma'))\n    };\n    \n    // Add specializations to each skill and calculate RR\n    context.skills = skills.map((skill: any) => {\n      // Get linked attribute label for the skill\n      const linkedAttribute = skill.system?.linkedAttribute || 'strength';\n      skill.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n      \n      // Calculate RR for this skill (skill RR + attribute RR, max 3)\n      const skillRR = this.calculateRR('skill', skill.name);\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\n      skill.rr = Math.min(3, skillRR + attributeRR);\n      \n      // Calculate total dice pool (attribute + skill rating)\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\n      const skillRating = skill.system?.rating || 0;\n      skill.totalDicePool = attributeValue + skillRating;\n      \n      // Get specializations for this skill and add calculated ratings (sorted alphabetically)\n      const specs = (specializationsBySkill.get(skill.id) || []).sort((a: any, b: any) => a.name.localeCompare(b.name));\n      skill.specializations = specs.map((spec: any) => {\n        const parentRating = skill.system?.rating || 0;\n        // Add properties directly to the spec object instead of creating a new one\n        spec.parentRating = parentRating;\n        spec.effectiveRating = parentRating + 2;  // Specialization adds +2 to skill rating\n        spec.parentSkillName = skill.name;\n        \n        // Get linked attribute label for the specialization\n        const specLinkedAttribute = spec.system?.linkedAttribute || 'strength';\n        spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${specLinkedAttribute.toUpperCase()}`);\n        \n        // Calculate RR for this specialization (attribute RR + skill RR + spec RR, max 3)\n        const specRR = this.calculateRR('specialization', spec.name);\n        const specAttributeRR = (attributesRR as any)[specLinkedAttribute] || 0;\n        const parentSkillRR = skillRR; // RR of the parent skill\n        spec.rr = Math.min(3, specAttributeRR + parentSkillRR + specRR);\n        \n        // Calculate total dice pool (attribute + effective rating)\n        const specAttributeValue = (this.actor.system as any).attributes[specLinkedAttribute] || 0;\n        spec.totalDicePool = specAttributeValue + spec.effectiveRating;\n        \n        return spec;\n      });\n      return skill;\n    });\n    \n    // Add unlinked specializations with attribute labels and RR (sorted alphabetically)\n    context.unlinkedSpecializations = unlinkedSpecializations\n      .sort((a: any, b: any) => a.name.localeCompare(b.name))\n      .map((spec: any) => {\n      const linkedAttribute = spec.system?.linkedAttribute || 'strength';\n      spec.linkedAttributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${linkedAttribute.toUpperCase()}`);\n      \n      // Calculate RR for this specialization (spec RR + attribute RR, max 3)\n      // Note: unlinked specializations don't have a parent skill, so only attribute + spec RR\n      const specRR = this.calculateRR('specialization', spec.name);\n      const attributeRR = (attributesRR as any)[linkedAttribute] || 0;\n      spec.rr = Math.min(3, specRR + attributeRR);\n      \n      // Calculate total dice pool (attribute only, since no skill linked)\n      const attributeValue = (this.actor.system as any).attributes[linkedAttribute] || 0;\n      spec.totalDicePool = attributeValue;\n      \n      return spec;\n    });\n    \n    // Store attributesRR in context\n    context.attributesRR = attributesRR;\n\n    // Add active section for navigation\n    context.activeSection = this._activeSection;\n\n    return context;\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.skill-search');\n    $(document).off('click.feat-search');\n    return super.close(options);\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Section navigation\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\n\n    // Edit metatype\n    html.find('[data-action=\"edit-metatype\"]').on('click', this._onEditMetatype.bind(this));\n    \n    // Delete metatype\n    html.find('[data-action=\"delete-metatype\"]').on('click', this._onDeleteMetatype.bind(this));\n\n    // Edit feat\n    html.find('[data-action=\"edit-feat\"]').on('click', this._onEditFeat.bind(this));\n\n    // Delete feat\n    html.find('[data-action=\"delete-feat\"]').on('click', this._onDeleteFeat.bind(this));\n\n    // Edit skill\n    html.find('[data-action=\"edit-skill\"]').on('click', this._onEditSkill.bind(this));\n\n    // Delete skill\n    html.find('[data-action=\"delete-skill\"]').on('click', this._onDeleteSkill.bind(this));\n\n    // Edit specialization\n    html.find('[data-action=\"edit-specialization\"]').on('click', this._onEditSpecialization.bind(this));\n\n    // Delete specialization\n    html.find('[data-action=\"delete-specialization\"]').on('click', this._onDeleteSpecialization.bind(this));\n\n    // Roll attribute\n    html.find('[data-action=\"roll-attribute\"]').on('click', this._onRollAttribute.bind(this));\n\n    // Roll skill\n    html.find('[data-action=\"roll-skill\"]').on('click', this._onRollSkill.bind(this));\n\n    // Quick roll skill (from dice badge)\n    html.find('[data-action=\"quick-roll-skill\"]').on('click', this._onQuickRollSkill.bind(this));\n\n    // Roll specialization\n    html.find('[data-action=\"roll-specialization\"]').on('click', this._onRollSpecialization.bind(this));\n\n    // Quick roll specialization (from dice badge)\n    html.find('[data-action=\"quick-roll-specialization\"]').on('click', this._onQuickRollSpecialization.bind(this));\n\n    // Send catchphrase to chat\n    html.find('[data-action=\"send-catchphrase\"]').on('click', this._onSendCatchphrase.bind(this));\n    \n    // Toggle bookmark - use event delegation to work with dynamically rendered items\n    html.on('click', '[data-action=\"toggle-bookmark\"]', this._onToggleBookmark.bind(this));\n    \n    // Click on bookmarked item in header\n    html.find('.bookmark-item').on('click', this._onBookmarkItemClick.bind(this));\n    \n    // Handle damage tracker checkboxes - explicit handler to ensure data is saved\n    html.find('input[name^=\"system.damage\"]').on('change', this._onDamageChange.bind(this));\n    html.find('input[name^=\"system.anarchySpent\"]').on('change', this._onAnarchyChange.bind(this));\n\n    // Roll weapon\n    html.find('[data-action=\"roll-weapon\"]').on('click', this._onRollWeapon.bind(this));\n\n    // Roll spell\n    html.find('[data-action=\"roll-spell\"]').on('click', this._onRollSpell.bind(this));\n\n    // Roll weapon/spell (old type)\n    html.find('[data-action=\"roll-weapon-spell\"]').on('click', this._onRollWeaponSpell.bind(this));\n\n    // Handle rating changes\n    html.find('.rating-input').on('change', this._onRatingChange.bind(this));\n\n    // Skill search\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\n    \n    // Close skill search results when clicking outside\n    $(document).on('click.skill-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\n        html.find('.skill-search-results').hide();\n      }\n    });\n\n    // Feat search\n    html.find('.feat-search-input').on('input', this._onFeatSearch.bind(this));\n    html.find('.feat-search-input').on('focus', this._onFeatSearchFocus.bind(this));\n    html.find('.feat-search-input').on('blur', this._onFeatSearchBlur.bind(this));\n    \n    // Close feat search results when clicking outside\n    $(document).on('click.feat-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const featSearchContainer = html.find('.feat-search-container')[0] as HTMLElement;\n      if (featSearchContainer && !featSearchContainer.contains(target)) {\n        html.find('.feat-search-results').hide();\n      }\n    });\n\n    // Make feat items draggable\n    html.find('.feat-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n\n    // Make skill items draggable\n    html.find('.skill-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n\n    // Make specialization items draggable\n    html.find('.specialization-item').each((_index, item) => {\n      item.setAttribute('draggable', 'true');\n      item.addEventListener('dragstart', this._onDragStart.bind(this));\n    });\n  }\n\n  /**\n   * Handle form submission to update actor data\n   */\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\n    return this.actor.update(expandedData);\n  }\n\n  /**\n   * Handle section navigation\n   */\n  private _onSectionNavigation(event: Event): void {\n    event.preventDefault();\n    const button = event.currentTarget as HTMLElement;\n    const section = button.dataset.section;\n    \n    if (!section) return;\n    \n    // Update active section\n    this._activeSection = section;\n    \n    // Update UI\n    const form = $(this.form);\n    form.find('.section-nav .nav-item').removeClass('active');\n    button.classList.add('active');\n    \n    form.find('.content-section').removeClass('active');\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\n  }\n\n  // Generic item handlers using SheetHelpers\n  private async _onEditMetatype(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\n  private async _onDeleteMetatype(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor, this.render.bind(this)); }\n  private async _onEditFeat(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\n  private async _onDeleteFeat(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\n  private async _onEditSkill(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\n  private async _onDeleteSkill(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\n  private async _onEditSpecialization(event: Event): Promise<void> { return SheetHelpers.handleEditItem(event, this.actor); }\n  private async _onDeleteSpecialization(event: Event): Promise<void> { return SheetHelpers.handleDeleteItem(event, this.actor); }\n\n  /**\n   * Get detailed RR sources for a given skill, specialization, or attribute\n   */\n  private getRRSources(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{featName: string, rrValue: number}> {\n    return SheetHelpers.getRRSources(this.actor, itemType, itemName);\n  }\n\n  /**\n   * Calculate Risk Reduction (RR) from active feats for a given skill, specialization, or attribute\n   */\n  private calculateRR(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): number {\n    return SheetHelpers.calculateRR(this.actor, itemType, itemName);\n  }\n\n  /**\n   * Handle rating changes for items\n   */\n  private async _onRatingChange(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLInputElement;\n    const itemId = element.dataset.itemId;\n    const newRating = parseInt(element.value);\n    \n    if (!itemId || isNaN(newRating)) return;\n\n    const item = this.actor.items.get(itemId);\n    if (item) {\n      await item.update({ system: { rating: newRating } } as any);\n    }\n  }\n\n  /**\n   * Handle rolling a specialization\n   */\n  private async _onRollSpecialization(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    const effectiveRating = parseInt(element.dataset.effectiveRating || '0');\n    \n    if (!itemId) return;\n\n    const specialization = this.actor.items.get(itemId);\n    if (!specialization || specialization.type !== 'specialization') return;\n\n    const specSystem = specialization.system as any;\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\n    const linkedSkillName = specSystem.linkedSkill;\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    \n    // Get the linked skill to get its rating\n    const linkedSkill = linkedSkillName ? this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName) : null;\n    const skillRating = linkedSkill ? (linkedSkill.system as any).rating || 0 : 0;\n    \n    // Get RR sources\n    const specRRSources = this.getRRSources('specialization', specialization.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\n    const allRRSources = [...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'specialization',\n      itemName: specialization.name,\n      itemId: specialization.id,\n      specName: specialization.name,\n      specLevel: attributeValue + effectiveRating,  // Total dice pool (attribute + effectiveRating)\n      skillName: linkedSkillName,\n      skillLevel: skillRating,  // Just the skill rating (without attribute)\n      linkedAttribute: linkedAttribute,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle quick rolling a skill (from dice badge click) - opens dialog\n   */\n  private async _onQuickRollSkill(event: Event): Promise<void> {\n    // Simply call the regular roll skill function which opens the dialog\n    return this._onRollSkill(event);\n  }\n\n  /**\n   * Handle quick rolling a specialization (from dice badge click) - opens dialog\n   */\n  private async _onQuickRollSpecialization(event: Event): Promise<void> {\n    // Simply call the regular roll specialization function which opens the dialog\n    return this._onRollSpecialization(event);\n  }\n\n\n  /**\n   * Handle rolling an attribute\n   */\n  private async _onRollAttribute(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const attributeName = element.dataset.attribute;\n    \n    if (!attributeName) return;\n\n    const attributeValue = (this.actor.system as any).attributes?.[attributeName] || 0;\n    const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${attributeName.toUpperCase()}`);\n\n    // Get RR sources for this attribute\n    const rrSources = this.getRRSources('attribute', attributeName);\n\n    DiceRoller.handleRollRequest({\n      itemType: 'attribute',\n      itemName: attributeLabel,\n      skillName: attributeLabel,\n      skillLevel: attributeValue,\n      linkedAttribute: attributeName,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: rrSources\n    });\n  }\n\n  /**\n   * Handle rolling a skill\n   */\n  private async _onRollSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) return;\n\n    const skill = this.actor.items.get(itemId);\n    if (!skill || skill.type !== 'skill') return;\n\n    const skillSystem = skill.system as any;\n    const rating = skillSystem.rating || 0;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n\n    // Get RR sources for skill and attribute\n    const skillRRSources = this.getRRSources('skill', skill.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const allRRSources = [...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'skill',\n      itemName: skill.name,\n      itemId: skill.id,\n      itemRating: rating,\n      skillName: skill.name,\n      skillLevel: attributeValue + rating,  // Total dice pool (attribute + rating)\n      linkedAttribute: linkedAttribute,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Apply damage to a defender\n   * Delegates to CombatHelpers.applyDamage\n   */\n  static async applyDamage(defenderUuid: string, damageValue: number, defenderName: string): Promise<void> {\n    return CombatHelpers.applyDamage(defenderUuid, damageValue, defenderName);\n  }\n\n  /**\n   * Handle drag start for feat items\n   */\n  protected override _onDragStart(event: DragEvent): void {\n    const itemId = (event.currentTarget as HTMLElement).dataset.itemId;\n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n\n    const dragData = {\n      type: 'Item',\n      uuid: item.uuid,\n    };\n\n    event.dataTransfer?.setData('text/plain', JSON.stringify(dragData));\n  }\n\n  /**\n   * Override to handle dropping feats and skills anywhere on the sheet\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const handled = await SheetHelpers.handleItemDrop(event, this.actor);\n    return handled ? undefined : super._onDrop(event);\n  }\n\n  /**\n   * Handle skill search input\n   */\n  private searchTimeout: any = null;\n  \n  private async _onSkillSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.searchTimeout) {\n      clearTimeout(this.searchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.searchTimeout = setTimeout(async () => {\n      await this._performSkillSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual skill search in compendiums and world items\n   */\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    // Store search term for potential creation\n    this.lastSearchTerm = searchTerm;\n    \n    // Use the helper function to search everywhere\n    const existingItemsCheck = (itemName: string) => \n      ItemSearch.itemExistsOnActor(this.actor, 'skill', itemName);\n    \n    const results = await ItemSearch.searchItemsEverywhere(\n      'skill',\n      searchTerm,\n      undefined,\n      existingItemsCheck\n    );\n    \n    // Display results\n    this._displaySkillSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display skill search results\n   */\n  private lastSearchTerm: string = '';\n  \n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): void {\n    // Check if exact match exists on the actor\n    const formattedSearchTerm = this.lastSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatchOnActor = this.actor.items.find((i: any) => \n      i.type === 'skill' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastSearchTerm)\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\n          </div>\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SKILLS.CREATE_SKILL')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const disabledClass = result.alreadyExists ? 'disabled' : '';\n        const buttonText = result.alreadyExists ? '✓' : game.i18n!.localize('SRA2.SKILLS.ADD_SKILL');\n        \n        html += `\n          <div class=\"search-result-item ${disabledClass}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.source}</span>\n            </div>\n            <button class=\"add-skill-btn\" data-uuid=\"${result.uuid}\" ${result.alreadyExists ? 'disabled' : ''}>\n              ${buttonText}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist on actor\n      if (!exactMatchOnActor) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SKILLS.CREATE_NEW')}</span>\n            </div>\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSearchTerm}\">\n              ${game.i18n!.localize('SRA2.SKILLS.CREATE')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers to buttons\n    $(resultsDiv).find('.add-skill-btn').on('click', this._onAddSkillFromSearch.bind(this));\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\n    \n    // Make entire result items clickable (except disabled ones and create button)\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-skill-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-skill-btn')[0] as HTMLButtonElement;\n      if (button && !button.disabled) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n  }\n\n  /**\n   * Handle adding a skill from search results\n   */\n  private async _onAddSkillFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const uuid = button.dataset.uuid;\n    \n    if (!uuid) return;\n    \n    // Get the skill from the compendium\n    const skill = await fromUuid(uuid as any) as any;\n    \n    if (!skill) {\n      ui.notifications?.error('Skill not found');\n      return;\n    }\n    \n    // Check if skill already exists\n    const existingSkill = this.actor.items.find((i: any) => \n      i.type === 'skill' && i.name === skill.name\n    );\n    \n    if (existingSkill) {\n      ui.notifications?.warn(game.i18n!.format('SRA2.SKILLS.ALREADY_EXISTS', { name: skill.name }));\n      return;\n    }\n    \n    // Add the skill to the actor\n    await this.actor.createEmbeddedDocuments('Item', [skill.toObject()]);\n    \n    // Mark button as added\n    button.textContent = '✓';\n    button.disabled = true;\n    button.closest('.search-result-item')?.classList.add('disabled');\n    \n    ui.notifications?.info(`${skill.name} ${game.i18n!.localize('SRA2.SKILLS.ADD_SKILL')}`);\n  }\n\n  /**\n   * Handle skill search focus\n   */\n  private _onSkillSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle skill search blur\n   */\n  private _onSkillSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle creating a new skill from search\n   */\n  private async _onCreateNewSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Capitalize first letter of each word\n    const formattedName = skillName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new skill with default values\n    const skillData = {\n      name: formattedName,\n      type: 'skill',\n      system: {\n        rating: 1,\n        linkedAttribute: 'strength',\n        description: ''\n      }\n    } as any;\n    \n    // Add the skill to the actor\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [skillData]) as any;\n    \n    if (createdItems && createdItems.length > 0) {\n      const newSkill = createdItems[0] as any;\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      // Open the skill sheet for editing\n      if (newSkill && newSkill.sheet) {\n        setTimeout(() => {\n          newSkill.sheet.render(true);\n        }, 100);\n      }\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.SKILLS.SKILL_CREATED', { name: formattedName }));\n    }\n  }\n\n  /**\n   * FEAT SEARCH FUNCTIONS\n   */\n  \n  private featSearchTimeout: any = null;\n  private lastFeatSearchTerm: string = '';\n  \n  /**\n   * Handle feat search input\n   */\n  private async _onFeatSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\n    const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.featSearchTimeout) {\n      clearTimeout(this.featSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.featSearchTimeout = setTimeout(async () => {\n      await this._performFeatSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual feat search in compendiums and world items\n   */\n  private async _performFeatSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    \n    // Store search term for potential creation\n    this.lastFeatSearchTerm = searchTerm;\n    \n    // Search in world items first\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === 'feat' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\n          // Check if feat already exists on actor\n          const existingFeat = this.actor.items.find((i: any) => \n            i.type === 'feat' && i.name === item.name\n          );\n          \n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            pack: game.i18n!.localize('SRA2.FEATS.WORLD_ITEMS'),\n            featType: item.system.featType,\n            exists: !!existingFeat\n          });\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for feats that match the search term\n      for (const doc of documents) {\n        if (doc.type === 'feat' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\n          // Check if feat already exists on actor\n          const existingFeat = this.actor.items.find((i: any) => \n            i.type === 'feat' && i.name === doc.name\n          );\n          \n          results.push({\n            name: doc.name,\n            uuid: doc.uuid,\n            pack: pack.title,\n            featType: doc.system.featType,\n            exists: !!existingFeat\n          });\n        }\n      }\n    }\n    \n    // Display results\n    this._displayFeatSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display feat search results\n   */\n  private _displayFeatSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\n    // Check if exact match exists on the actor\n    const formattedSearchTerm = this.lastFeatSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatchOnActor = this.actor.items.find((i: any) => \n      i.type === 'feat' && ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(this.lastFeatSearchTerm)\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message and type selector\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.FEATS.SEARCH_NO_RESULTS')}\n          </div>\n          <select class=\"feat-type-selector\">\n            <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\n            <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\n            <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\n            <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\n            <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\n            <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\n            <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\n            <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\n            <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\n            <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\n            <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\n          </select>\n          <button class=\"create-feat-btn\" data-feat-name=\"${this.lastFeatSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.FEATS.CREATE')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const disabledClass = result.exists ? 'disabled' : '';\n        const buttonText = result.exists ? '✓' : game.i18n!.localize('SRA2.FEATS.ADD_FEAT');\n        const featTypeLabel = game.i18n!.localize(`SRA2.FEATS.FEAT_TYPE.${result.featType.toUpperCase().replace('-', '_')}`);\n        \n        html += `\n          <div class=\"search-result-item ${disabledClass}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.pack} - ${featTypeLabel}</span>\n            </div>\n            <button class=\"add-feat-btn\" data-uuid=\"${result.uuid}\" ${result.exists ? 'disabled' : ''}>\n              ${buttonText}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist on actor\n      if (!exactMatchOnActor) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.FEATS.CREATE_NEW')}</span>\n            </div>\n            <select class=\"feat-type-selector-inline\">\n              <option value=\"equipment\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.EQUIPMENT')}</option>\n              <option value=\"trait\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.TRAIT')}</option>\n              <option value=\"contact\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CONTACT')}</option>\n              <option value=\"awakened\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.AWAKENED')}</option>\n              <option value=\"adept-power\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.ADEPT_POWER')}</option>\n              <option value=\"cyberware\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERWARE')}</option>\n              <option value=\"cyberdeck\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.CYBERDECK')}</option>\n              <option value=\"vehicle\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.VEHICLE')}</option>\n              <option value=\"weapons-spells\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS')}</option>\n              <option value=\"weapon\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.WEAPON')}</option>\n              <option value=\"spell\">${game.i18n!.localize('SRA2.FEATS.FEAT_TYPE.SPELL')}</option>\n            </select>\n            <button class=\"create-feat-btn-inline\" data-feat-name=\"${this.lastFeatSearchTerm}\">\n              ${game.i18n!.localize('SRA2.FEATS.CREATE')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers\n    $(resultsDiv).find('.add-feat-btn').on('click', this._onAddFeatFromSearch.bind(this));\n    $(resultsDiv).find('.create-feat-btn, .create-feat-btn-inline').on('click', this._onCreateNewFeat.bind(this));\n    \n    // Make entire result items clickable (except disabled ones and create button)\n    $(resultsDiv).find('.search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-feat-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-feat-btn')[0] as HTMLButtonElement;\n      if (button && !button.disabled) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button or select\n      if ($(event.target).closest('.create-feat-btn-inline, .feat-type-selector-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-feat-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle adding a feat from search results\n   */\n  private async _onAddFeatFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const uuid = button.dataset.uuid;\n    \n    if (!uuid) return;\n    \n    // Get the feat from the compendium\n    const feat = await fromUuid(uuid as any) as any;\n    \n    if (!feat) {\n      ui.notifications?.error('Feat not found');\n      return;\n    }\n    \n    // Check if feat already exists\n    const existingFeat = this.actor.items.find((i: any) => \n      i.type === 'feat' && i.name === feat.name\n    );\n    \n    if (existingFeat) {\n      ui.notifications?.warn(game.i18n!.format('SRA2.FEATS.ALREADY_EXISTS', { name: feat.name }));\n      return;\n    }\n    \n    // Add the feat to the actor\n    await this.actor.createEmbeddedDocuments('Item', [feat.toObject()]);\n    \n    // Mark button as added\n    button.textContent = '✓';\n    button.disabled = true;\n    button.closest('.search-result-item')?.classList.add('disabled');\n    \n    ui.notifications?.info(`${feat.name} ${game.i18n!.localize('SRA2.FEATS.ADD_FEAT')}`);\n  }\n\n  /**\n   * Handle feat search focus\n   */\n  private _onFeatSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle feat search blur\n   */\n  private _onFeatSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any select element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if a select or other element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle sending a catchphrase to chat\n   */\n  private async _onSendCatchphrase(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const catchphrase = element.dataset.catchphrase;\n    \n    if (!catchphrase) return;\n\n    // Create the chat message\n    const messageData = {\n      speaker: ChatMessage.getSpeaker({ actor: this.actor }),\n      content: `<div class=\"sra2-catchphrase\">${catchphrase}</div>`\n    };\n    \n    await ChatMessage.create(messageData as any);\n  }\n  \n  /**\n   * Handle damage tracker checkbox changes\n   */\n  private async _onDamageChange(event: Event): Promise<void> {\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\n    \n    const input = event.currentTarget as HTMLInputElement;\n    const name = input.name;\n    const checked = input.checked;\n    \n    // Parse the name to extract the path\n    // Expected format: system.damage.light.0, system.damage.severe.0, or system.damage.incapacitating\n    const match = name.match(/^system\\.damage\\.(light|severe|incapacitating)(?:\\.(\\d+))?$/);\n    if (!match) return;\n    \n    const damageType = match[1];\n    const index = match[2] ? parseInt(match[2], 10) : null;\n    \n    // Ensure damage structure exists\n    const currentDamage = (this.actor.system as any).damage || {\n      light: [false, false],\n      severe: [false],\n      incapacitating: false\n    };\n    \n    // Create a deep copy to avoid mutating directly\n    const updateData: any = {\n      'system.damage': {\n        light: [...(currentDamage.light || [false, false])],\n        severe: [...(currentDamage.severe || [false])],\n        incapacitating: currentDamage.incapacitating !== undefined ? currentDamage.incapacitating : false\n      }\n    };\n    \n    // Ensure arrays have minimum length\n    while (updateData['system.damage'].light.length < 2) {\n      updateData['system.damage'].light.push(false);\n    }\n    while (updateData['system.damage'].severe.length < 1) {\n      updateData['system.damage'].severe.push(false);\n    }\n    \n    // Update the appropriate field\n    if (damageType === 'incapacitating') {\n      updateData['system.damage'].incapacitating = checked;\n    } else if (damageType === 'light' && index !== null && index < updateData['system.damage'].light.length) {\n      updateData['system.damage'].light[index] = checked;\n    } else if (damageType === 'severe' && index !== null && index < updateData['system.damage'].severe.length) {\n      updateData['system.damage'].severe[index] = checked;\n    } else {\n      return; // Invalid index or type\n    }\n    \n    // Update the actor\n    await this.actor.update(updateData);\n  }\n  \n  /**\n   * Handle anarchy tracker checkbox changes\n   */\n  private async _onAnarchyChange(event: Event): Promise<void> {\n    event.stopPropagation(); // Prevent form auto-submit to avoid double update\n    \n    const input = event.currentTarget as HTMLInputElement;\n    const name = input.name;\n    const checked = input.checked;\n    \n    // Parse the name to extract the index\n    // Expected format: system.anarchySpent.0, system.anarchySpent.1, etc.\n    const match = name.match(/^system\\.anarchySpent\\.(\\d+)$/);\n    if (!match || !match[1]) return;\n    \n    const index = parseInt(match[1], 10);\n    \n    // Ensure anarchySpent array exists\n    const currentAnarchySpent = (this.actor.system as any).anarchySpent || [false, false, false];\n    const anarchySpent = [...currentAnarchySpent];\n    \n    // Ensure array has minimum length\n    while (anarchySpent.length < 3) {\n      anarchySpent.push(false);\n    }\n    \n    // Update the appropriate index\n    if (index >= 0 && index < anarchySpent.length) {\n      anarchySpent[index] = checked;\n      \n      // Update the actor\n      await (this.actor as any).update({ 'system.anarchySpent': anarchySpent });\n    }\n  }\n  \n  /**\n   * Handle toggling bookmark on an item\n   */\n  private async _onToggleBookmark(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    event.stopImmediatePropagation();\n    \n    // With event delegation, find the closest element with data-action=\"toggle-bookmark\"\n    const target = event.target as HTMLElement;\n    let element = target.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\n    \n    // If target is the icon itself, get the parent link\n    if (!element && target.tagName === 'I' && target.parentElement) {\n      element = target.parentElement as HTMLElement;\n      if (!element.hasAttribute('data-action')) {\n        element = element.closest('[data-action=\"toggle-bookmark\"]') as HTMLElement;\n      }\n    }\n    \n    if (!element) return;\n    \n    const itemId = element.dataset.itemId;\n    if (!itemId) return;\n    \n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n    \n    const currentBookmarkState = (item.system as any).bookmarked || false;\n    \n    try {\n      await (item as any).update({ 'system.bookmarked': !currentBookmarkState });\n      // Re-render to update UI\n      this.render(false);\n    } catch (error) {\n      console.error('Error toggling bookmark:', error);\n      ui.notifications?.error(game.i18n?.localize('SRA2.BOOKMARKS.ERROR') || 'Erreur lors de la mise à jour du bookmark');\n    }\n  }\n  \n  /**\n   * Handle clicking on a bookmarked item in the header\n   */\n  private async _onBookmarkItemClick(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    const itemType = element.dataset.itemType;\n    \n    if (!itemId) return;\n    \n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n    \n    // Roll the item based on its type\n    if (itemType === 'skill') {\n      // Call _onRollSkill with a fake event containing the item ID\n      const fakeEvent = { \n        preventDefault: () => {}, \n        currentTarget: { dataset: { itemId: itemId } } \n      } as any;\n      await this._onRollSkill(fakeEvent);\n    } else if (itemType === 'specialization') {\n      // Find the effective rating for this specialization\n      const specSystem = item.system as any;\n      const linkedSkillName = specSystem.linkedSkill;\n      const parentSkill = this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName);\n      const effectiveRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\n      \n      const fakeEvent = { \n        preventDefault: () => {}, \n        currentTarget: { \n          dataset: { \n            itemId: itemId,\n            effectiveRating: effectiveRating.toString()\n          } \n        } \n      } as any;\n      await this._onRollSpecialization(fakeEvent);\n    } else if (itemType === 'feat') {\n      const featType = (item.system as any).featType;\n      if (featType === 'weapon') {\n        const fakeEvent = { \n          preventDefault: () => {}, \n          currentTarget: { dataset: { itemId: itemId } } \n        } as any;\n        await this._onRollWeapon(fakeEvent);\n      } else if (featType === 'spell') {\n        const fakeEvent = { \n          preventDefault: () => {}, \n          currentTarget: { dataset: { itemId: itemId } } \n        } as any;\n        await this._onRollSpell(fakeEvent);\n      } else if (featType === 'weapons-spells') {\n        const fakeEvent = { \n          preventDefault: () => {}, \n          currentTarget: { dataset: { itemId: itemId } } \n        } as any;\n        await this._onRollWeaponSpell(fakeEvent);\n      }\n    }\n  }\n\n  /**\n   * Handle rolling a weapon\n   */\n  private async _onRollWeapon(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No weapon ID found\");\n      return;\n    }\n\n    const weapon = this.actor.items.get(itemId);\n    if (!weapon || weapon.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(weapon, 'weapon');\n  }\n\n  /**\n   * Handle rolling a spell\n   */\n  private async _onRollSpell(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No spell ID found\");\n      return;\n    }\n\n    const spell = this.actor.items.get(itemId);\n    if (!spell || spell.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(spell, 'spell');\n  }\n\n  /**\n   * Handle rolling a weapon/spell (old type)\n   */\n  private async _onRollWeaponSpell(event: Event): Promise<void> {\n    event.preventDefault();\n    const element = event.currentTarget as HTMLElement;\n    const itemId = element.dataset.itemId;\n    \n    if (!itemId) {\n      console.error(\"SRA2 | No weapon/spell ID found\");\n      return;\n    }\n\n    const item = this.actor.items.get(itemId);\n    if (!item || item.type !== 'feat') return;\n\n    await this._rollWeaponOrSpell(item, 'weapon-spell');\n  }\n\n\n  /**\n   * Handle rolling a weapon or spell\n   */\n  private async _rollWeaponOrSpell(item: any, type: 'weapon' | 'spell' | 'weapon-spell'): Promise<void> {\n    const itemSystem = item.system as any;\n    \n    // Get weapon type and linked skills\n    const weaponType = itemSystem.weaponType;\n    let weaponLinkedSkill = '';\n    let weaponLinkedSpecialization = '';\n    let weaponLinkedDefenseSkill = '';\n    let weaponLinkedDefenseSpecialization = '';\n    \n    if (weaponType && weaponType !== 'custom-weapon') {\n      // Pre-defined weapon: get from WEAPON_TYPES\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n      if (weaponStats) {\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n      }\n    }\n\n    // Get all RR sources for the item and enrich with featName\n    const rawItemRRList = itemSystem.rrList || [];\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: item.name  // Add featName (the item name itself)\n    }));\n\n    // Merge weapon type links with custom fields (weapon type has priority)\n    const finalAttackSkill = weaponLinkedSkill || itemSystem.linkedAttackSkill || '';\n    const finalAttackSpec = weaponLinkedSpecialization || itemSystem.linkedAttackSpecialization || '';\n    const finalDefenseSkill = weaponLinkedDefenseSkill || itemSystem.linkedDefenseSkill || '';\n    const finalDefenseSpec = weaponLinkedDefenseSpecialization || itemSystem.linkedDefenseSpecialization || '';\n\n    // Find actor's skill and specialization based on weapon links\n    let attackSkillName: string | undefined = undefined;\n    let attackSkillLevel: number | undefined = undefined;\n    let attackSpecName: string | undefined = undefined;\n    let attackSpecLevel: number | undefined = undefined;\n    let attackLinkedAttribute: string | undefined = undefined;\n    \n    // Try to find the linked attack specialization first\n    if (finalAttackSpec) {\n      const foundSpec = this.actor.items.find((i: any) => \n        i.type === 'specialization' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSpec)\n      );\n      \n      if (foundSpec) {\n        const specSystem = foundSpec.system as any;\n        attackSpecName = foundSpec.name;\n        attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        \n        // Get parent skill for specialization\n        const linkedSkillName = specSystem.linkedSkill;\n        if (linkedSkillName) {\n          const parentSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          if (parentSkill && attackLinkedAttribute) {\n            attackSkillName = parentSkill.name;\n            const skillLevel = ((parentSkill.system as any).rating + (this.actor.system as any).attributes?.[attackLinkedAttribute]) || 0;\n            attackSkillLevel = skillLevel;\n            attackSpecLevel = skillLevel + 2; // Specialization adds +2\n          }\n        }\n      }\n    }\n    \n    // If no specialization found, try to find the linked attack skill\n    if (!attackSpecName && finalAttackSkill) {\n      const foundSkill = this.actor.items.find((i: any) => \n        i.type === 'skill' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\n      );\n      \n      if (foundSkill) {\n        attackSkillName = foundSkill.name;\n        const foundLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        attackLinkedAttribute = foundLinkedAttribute;\n        attackSkillLevel = ((foundSkill.system as any).rating || 0) + ((this.actor.system as any).attributes?.[foundLinkedAttribute] || 0);\n      }\n    }\n\n    // Calculate final damage value (base + bonus)\n    const baseDamageValue = itemSystem.damageValue || '0';\n    const damageValueBonus = itemSystem.damageValueBonus || 0;\n    \n    let finalDamageValue = baseDamageValue;\n    if (damageValueBonus > 0 && baseDamageValue !== '0') {\n      if (baseDamageValue === 'FOR') {\n        finalDamageValue = `FOR+${damageValueBonus}`;\n      } else if (baseDamageValue.startsWith('FOR+')) {\n        const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n        finalDamageValue = `FOR+${baseModifier + damageValueBonus}`;\n      } else if (baseDamageValue !== 'toxin') {\n        const baseValue = parseInt(baseDamageValue) || 0;\n        finalDamageValue = (baseValue + damageValueBonus).toString();\n      }\n    }\n\n    // Get RR sources from skill/specialization/attribute (same as NPCs)\n    let skillRRSources: Array<{featName: string, rrValue: number}> = [];\n    let specRRSources: Array<{featName: string, rrValue: number}> = [];\n    let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\n    \n    if (attackSpecName) {\n      specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', attackSpecName);\n    }\n    if (attackSkillName) {\n      skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', attackSkillName);\n    }\n    if (attackLinkedAttribute) {\n      attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', attackLinkedAttribute);\n    }\n    \n    // Merge all RR sources (item RR + skill/spec/attribute RR)\n    const allRRSources = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: type,\n      weaponType: weaponType,\n      itemName: item.name,\n      itemId: item.id,\n      itemRating: itemSystem.rating || 0,\n      itemActive: itemSystem.active,\n      \n      // Merged linked skills\n      linkedAttackSkill: finalAttackSkill,\n      linkedAttackSpecialization: finalAttackSpec,\n      linkedDefenseSkill: finalDefenseSkill,\n      linkedDefenseSpecialization: finalDefenseSpec,\n      linkedAttribute: attackLinkedAttribute,\n      \n      // Weapon properties\n      isWeaponFocus: itemSystem.isWeaponFocus || false,\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus)\n      meleeRange: itemSystem.meleeRange,\n      shortRange: itemSystem.shortRange,\n      mediumRange: itemSystem.mediumRange,\n      longRange: itemSystem.longRange,\n      \n      // Attack skill/spec from actor (based on weapon links)\n      skillName: attackSkillName,\n      skillLevel: attackSkillLevel,\n      specName: attackSpecName,\n      specLevel: attackSpecLevel,\n      \n      // Actor information\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name || '',\n      \n      // RR List (merged: item RR + skill/spec/attribute RR)\n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * REMOVED: Skill with weapon roll - dialog creation disabled\n   */\n  private async _rollSkillWithWeapon(skill: any, weaponName: string, _skillType: 'skill', weaponDamageValue?: string, weapon?: any): Promise<void> {\n    console.log('Skill with weapon roll disabled', { skill: skill.name, weaponName });\n  }\n\n  /**\n   * REMOVED: Specialization with weapon roll - dialog creation disabled\n   */\n  private async _rollSpecializationWithWeapon(specialization: any, weaponName: string, effectiveRating: number, weaponDamageValue?: string, weapon?: any): Promise<void> {\n    console.log('Specialization with weapon roll disabled', { specialization: specialization.name, weaponName });\n  }\n\n\n  /**\n   * Handle creating a new feat from search\n   */\n  private async _onCreateNewFeat(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const featName = button.dataset.featName;\n    \n    if (!featName) return;\n    \n    // Get the feat type from the selector\n    const selector = $(button).siblings('.feat-type-selector, .feat-type-selector-inline')[0] as HTMLSelectElement;\n    const featType = selector ? selector.value : 'equipment';\n    \n    // Capitalize first letter of each word\n    const formattedName = featName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new feat with default values\n    const featData = {\n      name: formattedName,\n      type: 'feat',\n      system: {\n        description: '',\n        rating: 0,\n        cost: 'free-equipment',\n        active: true,\n        featType: featType,\n        rrType: [],\n        rrValue: [],\n        rrTarget: [],\n        bonusLightDamage: 0,\n        bonusSevereDamage: 0,\n        bonusPhysicalThreshold: 0,\n        bonusMentalThreshold: 0,\n        bonusAnarchy: 0,\n        essenceCost: 0\n      }\n    } as any;\n    \n    // Add the feat to the actor\n    const createdItems = await this.actor.createEmbeddedDocuments('Item', [featData]) as any;\n    \n    if (createdItems && createdItems.length > 0) {\n      const newFeat = createdItems[0] as any;\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.feat-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.feat-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      // Open the feat sheet for editing\n      if (newFeat && newFeat.sheet) {\n        setTimeout(() => {\n          newFeat.sheet.render(true);\n        }, 100);\n      }\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.FEATS.FEAT_CREATED', { name: formattedName }));\n    }\n  }\n}\n\n","import * as DiceRoller from '../helpers/dice-roller.js';\nimport * as ItemSearch from '../helpers/item-search.js';\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\nimport { WEAPON_TYPES } from '../models/item-feat.js';\n\n/**\n * NPC Sheet Application\n * NPCs don't roll dice - they use predefined thresholds\n * Threshold = round(dice pool / 3) + RR level + 1\n */\nexport class NpcSheet extends ActorSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'actor', 'npc'],\n      template: 'systems/sra2/templates/actor-npc-sheet.hbs',\n      width: 800,\n      height: 700,\n      tabs: [],\n      dragDrop: [\n        { dragSelector: '.skill-item', dropSelector: null },\n        { dragSelector: '.feat-item', dropSelector: null },\n        { dragSelector: '.specialization-item', dropSelector: null }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  /**\n   * Handle form submission to update actor data\n   */\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\n    return this.actor.update(expandedData);\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n\n    // Ensure system data is available\n    context.system = this.actor.system;\n\n    // Get feats\n    const allFeats = this.actor.items.filter((item: any) => item.type === 'feat');\n    \n    // Get all active feats for RR calculation\n    const activeFeats = allFeats.filter((feat: any) => feat.system.active === true);\n    \n    // Get actor's strength for damage value calculations\n    const actorStrength = (this.actor.system as any).attributes?.strength || 0;\n    \n    // Get all specializations early (needed for weapon/spell calculations)\n    let allSpecializations = this.actor.items.filter((i: any) => i.type === 'specialization');\n    \n    // Helper function to calculate weapon/spell stats\n    const calculateWeaponSpellStats = (item: any) => {\n      const itemData = {\n        ...item,\n        _id: item.id || item._id,\n        id: item.id || item._id\n      };\n      \n      // Get linked skill name and specialization from WEAPON_TYPES or custom fields\n      let linkedSkillName = '';\n      let linkedSpecializationName = '';\n      const weaponType = item.system.weaponType;\n      \n      if (weaponType && weaponType !== 'custom-weapon') {\n        // Arme pré-définie : récupérer depuis WEAPON_TYPES\n        const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n        if (weaponStats) {\n          linkedSkillName = weaponStats.linkedSkill || '';\n          linkedSpecializationName = weaponStats.linkedSpecialization || '';\n        }\n      } else if (weaponType === 'custom-weapon') {\n        // Arme custom : récupérer depuis les champs du système\n        linkedSkillName = item.system.linkedAttackSkill || '';\n        // Pour les armes custom, pas de spécialisation par défaut\n        linkedSpecializationName = '';\n      }\n      \n      // Try to find the linked skill\n      let totalDicePool = 0;\n      let totalRR = 0;\n      let linkedAttribute = '';\n      \n      if (linkedSkillName) {\n        const linkedSkill = this.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === linkedSkillName\n        );\n        \n        if (linkedSkill) {\n          const skillRating = (linkedSkill.system as any).rating || 0;\n          \n          // Check if there's a specialization for this weapon/spell\n          let matchingSpec = null;\n          \n          if (linkedSpecializationName) {\n            // Look for the specific specialization by name\n            matchingSpec = allSpecializations.find((spec: any) => \n              spec.name === linkedSpecializationName && spec.system.linkedSkill === linkedSkillName\n            );\n          }\n          \n          if (matchingSpec) {\n            // Use specialization: skill rating + spec's attribute + 2\n            linkedAttribute = matchingSpec.system.linkedAttribute || (linkedSkill.system as any).linkedAttribute || 'strength';\n            const attributeValue = this.actor.system.attributes?.[linkedAttribute] || 0;\n            totalDicePool = skillRating + attributeValue + 2;\n            \n            // Calculate RR for specialization\n            activeFeats.forEach((feat: any) => {\n              const rrList = feat.system.rrList || [];\n              rrList.forEach((rrEntry: any) => {\n                if (rrEntry.rrType === 'skill' && rrEntry.rrTarget === linkedSkillName) {\n                  totalRR += rrEntry.rrValue || 0;\n                }\n                if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\n                  totalRR += rrEntry.rrValue || 0;\n                }\n                if (rrEntry.rrType === 'specialization' && rrEntry.rrTarget === matchingSpec.name) {\n                  totalRR += rrEntry.rrValue || 0;\n                }\n              });\n            });\n          } else {\n            // Use skill only\n            linkedAttribute = (linkedSkill.system as any).linkedAttribute || 'strength';\n            const attributeValue = this.actor.system.attributes?.[linkedAttribute] || 0;\n            totalDicePool = attributeValue + skillRating;\n            \n            // Calculate RR\n            activeFeats.forEach((feat: any) => {\n              const rrList = feat.system.rrList || [];\n              rrList.forEach((rrEntry: any) => {\n                if (rrEntry.rrType === 'skill' && rrEntry.rrTarget === linkedSkillName) {\n                  totalRR += rrEntry.rrValue || 0;\n                }\n                if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\n                  totalRR += rrEntry.rrValue || 0;\n                }\n              });\n            });\n          }\n        }\n      }\n      \n      // If no linked skill found, use a default attribute (usually strength for weapons)\n      if (totalDicePool === 0) {\n        linkedAttribute = 'strength'; // Default for weapons/spells\n        const attributeValue = this.actor.system.attributes?.[linkedAttribute] || 0;\n        totalDicePool = attributeValue;\n        \n        // Calculate RR for attribute only\n        activeFeats.forEach((feat: any) => {\n          const rrList = feat.system.rrList || [];\n          rrList.forEach((rrEntry: any) => {\n            if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\n              totalRR += rrEntry.rrValue || 0;\n            }\n          });\n        });\n      }\n      \n      const npcThreshold = Math.round(totalDicePool / 3) + totalRR + 1;\n      \n      itemData.totalDicePool = totalDicePool;\n      itemData.totalRR = totalRR;\n      itemData.npcThreshold = npcThreshold;\n      \n      // Calculate final damage value with bonus\n      const damageValue = item.system.damageValue || '0';\n      const damageValueBonus = item.system.damageValueBonus || 0;\n      itemData.finalDamageValue = SheetHelpers.calculateFinalDamageValue(damageValue, damageValueBonus, actorStrength);\n      \n      return itemData;\n    };\n    \n    // Separate and process weapons, spells, and other feats\n    const rawWeapons = allFeats.filter((feat: any) => \n      feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells'\n    );\n    const rawSpells = allFeats.filter((feat: any) => \n      feat.system.featType === 'spell'\n    );\n    const otherFeats = allFeats.filter((feat: any) => \n      feat.system.featType !== 'weapon' && \n      feat.system.featType !== 'spell' && \n      feat.system.featType !== 'weapons-spells'\n    );\n    \n    // Calculate stats for weapons and spells using linked skills from WEAPON_TYPES\n    const weapons = rawWeapons.map((weapon: any) => calculateWeaponSpellStats(weapon));\n    const spells = rawSpells.map((spell: any) => calculateWeaponSpellStats(spell));\n    \n    context.weapons = weapons;\n    context.spells = spells;\n    context.feats = otherFeats;\n\n    // Get skills with NPC threshold calculations (sorted alphabetically)\n    const skills = this.actor.items\n      .filter((item: any) => item.type === 'skill')\n      .sort((a: any, b: any) => a.name.localeCompare(b.name));\n    \n    // Sort all specializations alphabetically (already defined above)\n    allSpecializations = allSpecializations.sort((a: any, b: any) => a.name.localeCompare(b.name));\n    \n    // Organize specializations by linked skill\n    const specializationsBySkill = new Map<string, any[]>();\n    \n    allSpecializations.forEach((spec: any) => {\n      const linkedSkillName = spec.system.linkedSkill;\n      if (linkedSkillName) {\n        const linkedSkill = this.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === linkedSkillName\n        );\n        \n        if (linkedSkill && linkedSkill.id) {\n          const skillId = linkedSkill.id;\n          if (!specializationsBySkill.has(skillId)) {\n            specializationsBySkill.set(skillId, []);\n          }\n          specializationsBySkill.get(skillId)!.push(spec);\n        }\n      }\n    });\n\n    // Calculate NPC thresholds for skills\n    const skillsWithThresholds = skills.map((skill: any) => {\n      const skillData = {\n        ...skill,\n        _id: skill.id || skill._id, // Ensure ID is present\n        id: skill.id || skill._id\n      };\n      \n      // Get attribute value\n      const linkedAttribute = skill.system.linkedAttribute;\n      let attributeValue = 0;\n      if (linkedAttribute && this.actor.system.attributes) {\n        attributeValue = this.actor.system.attributes[linkedAttribute] || 0;\n      }\n      \n      // Calculate total dice pool (attribute + skill rating)\n      const skillRating = skill.system.rating || 0;\n      const totalDicePool = attributeValue + skillRating;\n      \n      // Calculate total RR for this skill\n      let totalRR = 0;\n      \n      // Get all active feats\n      const activeFeats = this.actor.items.filter((item: any) => \n        item.type === 'feat' && item.system.active === true\n      );\n      \n      // Check each feat for RR that applies to this skill\n      activeFeats.forEach((feat: any) => {\n        const rrList = feat.system.rrList || [];\n        rrList.forEach((rrEntry: any) => {\n          if (rrEntry.rrType === 'skill' && rrEntry.rrTarget === skill.name) {\n            totalRR += rrEntry.rrValue || 0;\n          }\n          // Also check for attribute RR\n          if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === linkedAttribute) {\n            totalRR += rrEntry.rrValue || 0;\n          }\n        });\n      });\n      \n      // Calculate NPC threshold: round(dice pool / 3) + RR + 1\n      const npcThreshold = Math.round(totalDicePool / 3) + totalRR + 1;\n      \n      skillData.totalDicePool = totalDicePool;\n      skillData.totalRR = totalRR;\n      skillData.npcThreshold = npcThreshold;\n      \n      // Attach specializations for this skill with their thresholds (sorted alphabetically)\n      const specs = (specializationsBySkill.get(skill.id) || []).sort((a: any, b: any) => a.name.localeCompare(b.name));\n      skillData.specializations = specs.map((spec: any) => {\n        const specData = {\n          ...spec,\n          _id: spec.id || spec._id, // Ensure ID is present\n          id: spec.id || spec._id\n        };\n        \n        // Get specialization's linked attribute (can be different from skill's attribute)\n        const specLinkedAttribute = spec.system.linkedAttribute || linkedAttribute;\n        const specAttributeValue = this.actor.system.attributes?.[specLinkedAttribute] || 0;\n        \n        // Specialization: skill rating + spec's attribute + 2\n        const specDicePool = skillRating + specAttributeValue + 2;\n        \n        // Calculate total RR for specialization\n        let specTotalRR = 0;\n        \n        // Check for skill RR\n        activeFeats.forEach((feat: any) => {\n          const rrList = feat.system.rrList || [];\n          rrList.forEach((rrEntry: any) => {\n            if (rrEntry.rrType === 'skill' && rrEntry.rrTarget === skill.name) {\n              specTotalRR += rrEntry.rrValue || 0;\n            }\n          });\n        });\n        \n        // Check for attribute RR (using spec's attribute)\n        activeFeats.forEach((feat: any) => {\n          const rrList = feat.system.rrList || [];\n          rrList.forEach((rrEntry: any) => {\n            if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === specLinkedAttribute) {\n              specTotalRR += rrEntry.rrValue || 0;\n            }\n          });\n        });\n        \n        // Check for specialization-specific RR\n        activeFeats.forEach((feat: any) => {\n          const rrList = feat.system.rrList || [];\n          rrList.forEach((rrEntry: any) => {\n            if (rrEntry.rrType === 'specialization' && rrEntry.rrTarget === spec.name) {\n              specTotalRR += rrEntry.rrValue || 0;\n            }\n          });\n        });\n        \n        // Calculate specialization threshold\n        const specThreshold = Math.round(specDicePool / 3) + specTotalRR + 1;\n        \n        specData.totalDicePool = specDicePool;\n        specData.totalRR = specTotalRR;\n        specData.npcThreshold = specThreshold;\n        \n        return specData;\n      });\n      \n      return skillData;\n    });\n\n    context.skills = skillsWithThresholds;\n\n    return context;\n  }\n\n  override activateListeners(html: JQuery<HTMLElement>): void {\n    super.activateListeners(html);\n\n    // Roll skill\n    html.find('[data-action=\"roll-skill\"]').on('click', this._onRollSkill.bind(this));\n\n    // Roll specialization\n    html.find('[data-action=\"roll-specialization\"]').on('click', this._onRollSpecialization.bind(this));\n\n    // Attack with threshold\n    html.find('[data-action=\"attack-threshold\"]').on('click', this._onAttackThreshold.bind(this));\n\n    // Attack with threshold (weapon)\n    html.find('[data-action=\"attack-threshold-weapon\"]').on('click', this._onAttackThresholdWeapon.bind(this));\n\n    // Attack with threshold (spell)\n    html.find('[data-action=\"attack-threshold-spell\"]').on('click', this._onAttackThresholdSpell.bind(this));\n\n    // Roll NPC weapon with dice\n    html.find('[data-action=\"roll-npc-weapon-dice\"]').on('click', this._onRollNPCWeaponDice.bind(this));\n\n    // Roll NPC spell with dice\n    html.find('[data-action=\"roll-npc-spell-dice\"]').on('click', this._onRollNPCSpellDice.bind(this));\n\n    // Edit skill\n    html.find('[data-action=\"edit-skill\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        item.sheet?.render(true);\n      }\n    });\n\n    // Delete skill\n    html.find('[data-action=\"delete-skill\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        const confirmed = await Dialog.confirm({\n          title: game.i18n!.localize('SRA2.SKILLS.DELETE'),\n          content: `<p>${game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name })}</p>`,\n        });\n        if (confirmed) {\n          await item.delete();\n        }\n      }\n    });\n\n    // Edit specialization\n    html.find('[data-action=\"edit-specialization\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        item.sheet?.render(true);\n      }\n    });\n\n    // Delete specialization\n    html.find('[data-action=\"delete-specialization\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        const confirmed = await Dialog.confirm({\n          title: game.i18n!.localize('SRA2.SPECIALIZATIONS.DELETE'),\n          content: `<p>${game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name })}</p>`,\n        });\n        if (confirmed) {\n          await item.delete();\n        }\n      }\n    });\n\n    // Edit feat\n    html.find('[data-action=\"edit-feat\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        item.sheet?.render(true);\n      }\n    });\n\n    // Delete feat\n    html.find('[data-action=\"delete-feat\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        const confirmed = await Dialog.confirm({\n          title: game.i18n!.localize('SRA2.FEATS.DELETE'),\n          content: `<p>${game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name })}</p>`,\n        });\n        if (confirmed) {\n          await item.delete();\n        }\n      }\n    });\n\n    // Add world skill button\n    html.find('[data-action=\"add-world-skill\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      this._showItemBrowser('skill');\n    });\n\n    // Add world feat button\n    html.find('[data-action=\"add-world-feat\"]').on('click', async (event: JQuery.ClickEvent) => {\n      event.preventDefault();\n      this._showItemBrowser('feat');\n    });\n  }\n\n  /**\n   * Handle rolling a skill (NPC)\n   */\n  private async _onRollSkill(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n\n    if (!itemId) return;\n\n    const skill = this.actor.items.get(itemId);\n    if (!skill || skill.type !== 'skill') return;\n\n    const skillSystem = skill.system as any;\n    const rating = skillSystem.rating || 0;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    \n    // Get RR sources for skill and attribute\n    const skillRRSources = this.getRRSources('skill', skill.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const allRRSources = [...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'skill',\n      itemName: skill.name,\n      itemId: skill.id,\n      itemRating: rating,\n      skillName: skill.name,\n      skillLevel: attributeValue + rating,  // Total dice pool (attribute + rating)\n      linkedAttribute: linkedAttribute,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle rolling a specialization (NPC)\n   */\n  private async _onRollSpecialization(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    \n    if (!itemId) return;\n\n    const specialization = this.actor.items.get(itemId);\n    if (!specialization || specialization.type !== 'specialization') return;\n\n    const specSystem = specialization.system as any;\n    const linkedAttribute = specSystem.linkedAttribute || 'strength';\n    const linkedSkillName = specSystem.linkedSkill;\n    const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n    \n    // Get the linked skill to calculate effective rating\n    const linkedSkill = this.actor.items.find((i: any) => i.type === 'skill' && i.name === linkedSkillName);\n    const skillRating = linkedSkill ? (linkedSkill.system as any).rating || 0 : 0;\n    const effectiveRating = skillRating + 2; // +2 from specialization\n    \n    // Get RR sources\n    const specRRSources = this.getRRSources('specialization', specialization.name);\n    const attributeRRSources = this.getRRSources('attribute', linkedAttribute);\n    const skillRRSources = linkedSkillName ? this.getRRSources('skill', linkedSkillName) : [];\n    const allRRSources = [...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'specialization',\n      itemName: specialization.name,\n      itemId: specialization.id,\n      specName: specialization.name,\n      specLevel: attributeValue + effectiveRating,  // Total dice pool (attribute + effectiveRating)\n      skillName: linkedSkillName,\n      skillLevel: skillRating,  // Just the skill rating (without attribute)\n      linkedAttribute: linkedAttribute,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle attack with threshold (NPC skill/spec without weapon)\n   */\n  private async _onAttackThreshold(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    const threshold = element.data('threshold') || element.attr('data-threshold');\n    const itemName = element.data('item-name') || element.attr('data-item-name');\n\n    if (!itemId) return;\n\n    const item = this.actor.items.get(itemId);\n    if (!item) return;\n\n    const itemSystem = item.system as any;\n    const itemType = item.type;\n    const linkedAttribute = itemSystem.linkedAttribute || 'strength';\n    \n    // Get RR sources\n    const rrSources = this.getRRSources(itemType as any, item.name);\n\n    DiceRoller.handleRollRequest({\n      itemType: itemType,\n      itemName: itemName || item.name,\n      itemId: itemId,\n      itemRating: itemSystem.rating || 0,\n      skillName: itemType === 'skill' ? item.name : undefined,\n      specName: itemType === 'specialization' ? item.name : undefined,\n      linkedAttribute: linkedAttribute,\n      threshold: threshold ? parseInt(threshold) : undefined,\n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      rrList: rrSources\n    });\n  }\n\n  /**\n   * REMOVED: Defense roll prompt for NPC attack\n   */\n  private async _promptDefenseRollForNPC(defenderActor: any, attackThreshold: number, attackName: string, defenderToken?: any): Promise<void> {\n    console.log('NPC defense prompt disabled', { defenderActor: defenderActor.name, attackThreshold, attackName });\n  }\n\n  /**\n   * REMOVED: Defense roll against NPC attack\n   */\n  private async _rollDefenseAgainstNPC(defenseItem: any, itemType: 'skill' | 'spec', attackName: string, attackThreshold: number, defenderActor: any, defenderToken?: any): Promise<void> {\n    console.log('NPC defense roll disabled', { defenseItem: defenseItem.name, itemType, attackName, attackThreshold });\n  }\n\n\n  /**\n   * REMOVED: NPC attack result display\n   */\n  private async _displayNPCAttackResult(attackName: string, attackThreshold: number, defenseResult: any | null, defenderActor: any, defenderToken?: any): Promise<void> {\n    console.log('NPC attack result display disabled', { attackName, attackThreshold, defenderActor: defenderActor.name });\n  }\n\n\n\n\n  /**\n   * Handle attacking with threshold (weapon)\n   */\n  private async _onAttackThresholdWeapon(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    const threshold = element.data('threshold') || element.attr('data-threshold');\n    const itemName = element.data('item-name') || element.attr('data-item-name');\n    const weaponVD = element.data('weapon-vd') || element.attr('data-weapon-vd') || '0';\n\n    if (!itemId) return;\n\n    const weapon = this.actor.items.get(itemId);\n    if (!weapon || weapon.type !== 'feat') return;\n\n    const weaponSystem = weapon.system as any;\n    const weaponType = weaponSystem.weaponType;\n    \n    let weaponLinkedSkill = '';\n    let weaponLinkedSpecialization = '';\n    let weaponLinkedDefenseSkill = '';\n    let weaponLinkedDefenseSpecialization = '';\n    \n    if (weaponType && weaponType !== 'custom-weapon') {\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n      if (weaponStats) {\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n      }\n    }\n\n    // Enrich RR list with featName\n    const rawItemRRList = weaponSystem.rrList || [];\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: weapon.name  // Add featName (the weapon name itself)\n    }));\n\n    // Merge weapon type links with custom fields (weapon type has priority)\n    const finalAttackSkill = weaponLinkedSkill || weaponSystem.linkedAttackSkill || '';\n    const finalAttackSpec = weaponLinkedSpecialization || weaponSystem.linkedAttackSpecialization || '';\n    const finalDefenseSkill = weaponLinkedDefenseSkill || weaponSystem.linkedDefenseSkill || '';\n    const finalDefenseSpec = weaponLinkedDefenseSpecialization || weaponSystem.linkedDefenseSpecialization || '';\n\n    // Find actor's skill and specialization based on weapon links\n    let attackSkillName: string | undefined = undefined;\n    let attackSkillLevel: number | undefined = undefined;\n    let attackSpecName: string | undefined = undefined;\n    let attackSpecLevel: number | undefined = undefined;\n    let attackLinkedAttribute: string | undefined = undefined;\n    \n    // Try to find the linked attack specialization first\n    if (finalAttackSpec) {\n      const foundSpec = this.actor.items.find((i: any) => \n        i.type === 'specialization' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSpec)\n      );\n      \n      if (foundSpec) {\n        const specSystem = foundSpec.system as any;\n        attackSpecName = foundSpec.name;\n        attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        \n        // Get parent skill for specialization\n        const linkedSkillName = specSystem.linkedSkill;\n        if (linkedSkillName) {\n          const parentSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          if (parentSkill) {\n            attackSkillName = parentSkill.name;\n            const skillRating = (parentSkill.system as any).rating || 0;\n            attackSkillLevel = skillRating;  // Just the skill rating (without attribute)\n            attackSpecLevel = attributeValue + skillRating + 2; // Total dice pool (attribute + rating + 2)\n          }\n        }\n      }\n    }\n    \n    // If no specialization found, try to find the linked attack skill\n    if (!attackSpecName && finalAttackSkill) {\n      const foundSkill = this.actor.items.find((i: any) => \n        i.type === 'skill' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\n      );\n      \n      if (foundSkill) {\n        attackSkillName = foundSkill.name;\n        attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        const skillRating = (foundSkill.system as any).rating || 0;\n        attackSkillLevel = attributeValue + skillRating; // Total dice pool (attribute + rating)\n      }\n    }\n\n    // Calculate final damage value (base + bonus)\n    const baseDamageValue = weaponSystem.damageValue || '0';\n    const damageValueBonus = weaponSystem.damageValueBonus || 0;\n    \n    let finalDamageValue = baseDamageValue;\n    if (damageValueBonus > 0 && baseDamageValue !== '0') {\n      if (baseDamageValue === 'FOR') {\n        finalDamageValue = `FOR+${damageValueBonus}`;\n      } else if (baseDamageValue.startsWith('FOR+')) {\n        const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n        finalDamageValue = `FOR+${baseModifier + damageValueBonus}`;\n      } else if (baseDamageValue !== 'toxin') {\n        const baseValue = parseInt(baseDamageValue) || 0;\n        finalDamageValue = (baseValue + damageValueBonus).toString();\n      }\n    }\n\n    // Get RR sources from skill/specialization/attribute\n    const { getRRSources } = SheetHelpers;\n    let skillRRSources: Array<{featName: string, rrValue: number}> = [];\n    let specRRSources: Array<{featName: string, rrValue: number}> = [];\n    let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\n    \n    if (attackSpecName) {\n      specRRSources = getRRSources(this.actor, 'specialization', attackSpecName);\n    }\n    if (attackSkillName) {\n      skillRRSources = getRRSources(this.actor, 'skill', attackSkillName);\n    }\n    if (attackLinkedAttribute) {\n      attributeRRSources = getRRSources(this.actor, 'attribute', attackLinkedAttribute);\n    }\n    \n    // Merge all RR sources\n    const allRRSources = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'weapon',\n      weaponType: weaponType,\n      itemName: itemName || weapon.name,\n      itemId: itemId,\n      itemRating: weaponSystem.rating || 0,\n      itemActive: weaponSystem.active,\n      \n      linkedAttackSkill: finalAttackSkill,\n      linkedAttackSpecialization: finalAttackSpec,\n      linkedDefenseSkill: finalDefenseSkill,\n      linkedDefenseSpecialization: finalDefenseSpec,\n      linkedAttribute: attackLinkedAttribute,\n      \n      isWeaponFocus: weaponSystem.isWeaponFocus || false,\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus)\n      meleeRange: weaponSystem.meleeRange,\n      shortRange: weaponSystem.shortRange,\n      mediumRange: weaponSystem.mediumRange,\n      longRange: weaponSystem.longRange,\n      \n      // Attack skill/spec from actor (based on weapon links)\n      skillName: attackSkillName,\n      skillLevel: attackSkillLevel,\n      specName: attackSpecName,\n      specLevel: attackSpecLevel,\n      \n      threshold: threshold ? parseInt(threshold) : undefined,\n      \n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      \n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle attacking with threshold (spell)\n   */\n  private async _onAttackThresholdSpell(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    const threshold = element.data('threshold') || element.attr('data-threshold');\n    const itemName = element.data('item-name') || element.attr('data-item-name');\n    const spellVD = element.data('spell-vd') || element.attr('data-spell-vd') || '0';\n\n    if (!itemId) return;\n\n    const spell = this.actor.items.get(itemId);\n    if (!spell || spell.type !== 'feat') return;\n\n    const spellSystem = spell.system as any;\n    const weaponType = spellSystem.weaponType;\n    \n    let weaponLinkedSkill = '';\n    let weaponLinkedSpecialization = '';\n    let weaponLinkedDefenseSkill = '';\n    let weaponLinkedDefenseSpecialization = '';\n    \n    if (weaponType && weaponType !== 'custom-weapon') {\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n      if (weaponStats) {\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n      }\n    }\n\n    // Enrich RR list with featName\n    const rawItemRRList = spellSystem.rrList || [];\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: spell.name  // Add featName (the spell name itself)\n    }));\n\n    // Merge weapon type links with custom fields (weapon type has priority)\n    const finalAttackSkill = weaponLinkedSkill || spellSystem.linkedAttackSkill || '';\n    const finalAttackSpec = weaponLinkedSpecialization || spellSystem.linkedAttackSpecialization || '';\n    const finalDefenseSkill = weaponLinkedDefenseSkill || spellSystem.linkedDefenseSkill || '';\n    const finalDefenseSpec = weaponLinkedDefenseSpecialization || spellSystem.linkedDefenseSpecialization || '';\n\n    // Find actor's skill and specialization based on spell links\n    let attackSkillName = '';\n    let attackSkillLevel = 0;\n    let attackSpecName = '';\n    let attackSpecLevel = 0;\n    let attackLinkedAttribute = '';\n    \n    // Try to find the linked attack specialization first\n    if (finalAttackSpec) {\n      const foundSpec = this.actor.items.find((i: any) => \n        i.type === 'specialization' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSpec)\n      );\n      \n      if (foundSpec) {\n        const specSystem = foundSpec.system as any;\n        attackSpecName = foundSpec.name;\n        attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        \n        // Get parent skill for specialization\n        const linkedSkillName = specSystem.linkedSkill;\n        if (linkedSkillName) {\n          const parentSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          if (parentSkill) {\n            attackSkillName = parentSkill.name;\n            const skillRating = (parentSkill.system as any).rating || 0;\n            attackSkillLevel = skillRating;  // Just the skill rating (without attribute)\n            attackSpecLevel = attributeValue + skillRating + 2; // Total dice pool (attribute + rating + 2)\n          }\n        }\n      }\n    }\n    \n    // If no specialization found, try to find the linked attack skill\n    if (!attackSpecName && finalAttackSkill) {\n      const foundSkill = this.actor.items.find((i: any) => \n        i.type === 'skill' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\n      );\n      \n      if (foundSkill) {\n        attackSkillName = foundSkill.name;\n        attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        const skillRating = (foundSkill.system as any).rating || 0;\n        attackSkillLevel = attributeValue + skillRating; // Total dice pool (attribute + rating)\n      }\n    }\n\n    // Calculate final damage value (base + bonus)\n    const baseDamageValue = spellSystem.damageValue || '0';\n    const damageValueBonus = spellSystem.damageValueBonus || 0;\n    \n    let finalDamageValue = baseDamageValue;\n    if (damageValueBonus > 0 && baseDamageValue !== '0') {\n      if (baseDamageValue === 'FOR') {\n        finalDamageValue = `FOR+${damageValueBonus}`;\n      } else if (baseDamageValue.startsWith('FOR+')) {\n        const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n        finalDamageValue = `FOR+${baseModifier + damageValueBonus}`;\n      } else if (baseDamageValue !== 'toxin') {\n        const baseValue = parseInt(baseDamageValue) || 0;\n        finalDamageValue = (baseValue + damageValueBonus).toString();\n      }\n    }\n\n    // Get RR sources from skill/specialization/attribute\n    const { getRRSources } = SheetHelpers;\n    let skillRRSources: Array<{featName: string, rrValue: number}> = [];\n    let specRRSources: Array<{featName: string, rrValue: number}> = [];\n    let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\n    \n    if (attackSpecName) {\n      specRRSources = getRRSources(this.actor, 'specialization', attackSpecName);\n    }\n    if (attackSkillName) {\n      skillRRSources = getRRSources(this.actor, 'skill', attackSkillName);\n    }\n    if (attackLinkedAttribute) {\n      attributeRRSources = getRRSources(this.actor, 'attribute', attackLinkedAttribute);\n    }\n    \n    // Merge all RR sources\n    const allRRSources = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'spell',\n      weaponType: weaponType,\n      itemName: itemName || spell.name,\n      itemId: itemId,\n      itemRating: spellSystem.rating || 0,\n      itemActive: spellSystem.active,\n      \n      linkedAttackSkill: finalAttackSkill,\n      linkedAttackSpecialization: finalAttackSpec,\n      linkedDefenseSkill: finalDefenseSkill,\n      linkedDefenseSpecialization: finalDefenseSpec,\n      linkedAttribute: attackLinkedAttribute,\n      \n      isWeaponFocus: spellSystem.isWeaponFocus || false,\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus)\n      meleeRange: spellSystem.meleeRange,\n      shortRange: spellSystem.shortRange,\n      mediumRange: spellSystem.mediumRange,\n      longRange: spellSystem.longRange,\n      \n      // Attack skill/spec from actor (based on spell links)\n      skillName: attackSkillName,\n      skillLevel: attackSkillLevel,\n      specName: attackSpecName,\n      specLevel: attackSpecLevel,\n      \n      threshold: threshold ? parseInt(threshold) : undefined,\n      \n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      \n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle rolling NPC weapon with dice\n   */\n  private async _onRollNPCWeaponDice(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    const weaponVD = element.data('weapon-vd') || element.attr('data-weapon-vd') || '0';\n\n    if (!itemId) return;\n\n    const weapon = this.actor.items.get(itemId);\n    if (!weapon || weapon.type !== 'feat') return;\n\n    const weaponSystem = weapon.system as any;\n    const weaponType = weaponSystem.weaponType;\n    \n    let weaponLinkedSkill = '';\n    let weaponLinkedSpecialization = '';\n    let weaponLinkedDefenseSkill = '';\n    let weaponLinkedDefenseSpecialization = '';\n    \n    if (weaponType && weaponType !== 'custom-weapon') {\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n      if (weaponStats) {\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n      }\n    }\n\n    // Enrich RR list with featName\n    const rawItemRRList = weaponSystem.rrList || [];\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: weapon.name  // Add featName (the weapon name itself)\n    }));\n\n    // Merge weapon type links with custom fields (weapon type has priority)\n    const finalAttackSkill = weaponLinkedSkill || weaponSystem.linkedAttackSkill || '';\n    const finalAttackSpec = weaponLinkedSpecialization || weaponSystem.linkedAttackSpecialization || '';\n    const finalDefenseSkill = weaponLinkedDefenseSkill || weaponSystem.linkedDefenseSkill || '';\n    const finalDefenseSpec = weaponLinkedDefenseSpecialization || weaponSystem.linkedDefenseSpecialization || '';\n\n    // Find actor's skill and specialization based on weapon links\n    let attackSkillName: string | undefined = undefined;\n    let attackSkillLevel: number | undefined = undefined;\n    let attackSpecName: string | undefined = undefined;\n    let attackSpecLevel: number | undefined = undefined;\n    let attackLinkedAttribute: string | undefined = undefined;\n    \n    // Try to find the linked attack specialization first\n    if (finalAttackSpec) {\n      const foundSpec = this.actor.items.find((i: any) => \n        i.type === 'specialization' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSpec)\n      );\n      \n      if (foundSpec) {\n        const specSystem = foundSpec.system as any;\n        attackSpecName = foundSpec.name;\n        attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        \n        // Get parent skill for specialization\n        const linkedSkillName = specSystem.linkedSkill;\n        if (linkedSkillName) {\n          const parentSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          if (parentSkill) {\n            attackSkillName = parentSkill.name;\n            const skillRating = (parentSkill.system as any).rating || 0;\n            attackSkillLevel = skillRating;  // Just the skill rating (without attribute)\n            attackSpecLevel = attributeValue + skillRating + 2; // Total dice pool (attribute + rating + 2)\n          }\n        }\n      }\n    }\n    \n    // If no specialization found, try to find the linked attack skill\n    if (!attackSpecName && finalAttackSkill) {\n      const foundSkill = this.actor.items.find((i: any) => \n        i.type === 'skill' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\n      );\n      \n      if (foundSkill) {\n        attackSkillName = foundSkill.name;\n        attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        const skillRating = (foundSkill.system as any).rating || 0;\n        attackSkillLevel = attributeValue + skillRating; // Total dice pool (attribute + rating)\n      }\n    }\n\n    // Calculate final damage value (base + bonus)\n    const baseDamageValue = weaponSystem.damageValue || '0';\n    const damageValueBonus = weaponSystem.damageValueBonus || 0;\n    \n    let finalDamageValue = baseDamageValue;\n    if (damageValueBonus > 0 && baseDamageValue !== '0') {\n      if (baseDamageValue === 'FOR') {\n        finalDamageValue = `FOR+${damageValueBonus}`;\n      } else if (baseDamageValue.startsWith('FOR+')) {\n        const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n        finalDamageValue = `FOR+${baseModifier + damageValueBonus}`;\n      } else if (baseDamageValue !== 'toxin') {\n        const baseValue = parseInt(baseDamageValue) || 0;\n        finalDamageValue = (baseValue + damageValueBonus).toString();\n      }\n    }\n\n    // Get RR sources from skill/specialization/attribute\n    const { getRRSources } = SheetHelpers;\n    let skillRRSources: Array<{featName: string, rrValue: number}> = [];\n    let specRRSources: Array<{featName: string, rrValue: number}> = [];\n    let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\n    \n    if (attackSpecName) {\n      specRRSources = getRRSources(this.actor, 'specialization', attackSpecName);\n    }\n    if (attackSkillName) {\n      skillRRSources = getRRSources(this.actor, 'skill', attackSkillName);\n    }\n    if (attackLinkedAttribute) {\n      attributeRRSources = getRRSources(this.actor, 'attribute', attackLinkedAttribute);\n    }\n    \n    // Merge all RR sources\n    const allRRSources = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'weapon',\n      weaponType: weaponType,\n      itemName: weapon.name,\n      itemId: itemId,\n      itemRating: weaponSystem.rating || 0,\n      itemActive: weaponSystem.active,\n      \n      linkedAttackSkill: finalAttackSkill,\n      linkedAttackSpecialization: finalAttackSpec,\n      linkedDefenseSkill: finalDefenseSkill,\n      linkedDefenseSpecialization: finalDefenseSpec,\n      linkedAttribute: attackLinkedAttribute,\n      \n      isWeaponFocus: weaponSystem.isWeaponFocus || false,\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus)\n      meleeRange: weaponSystem.meleeRange,\n      shortRange: weaponSystem.shortRange,\n      mediumRange: weaponSystem.mediumRange,\n      longRange: weaponSystem.longRange,\n      \n      // Attack skill/spec from actor (based on weapon links)\n      skillName: attackSkillName,\n      skillLevel: attackSkillLevel,\n      specName: attackSpecName,\n      specLevel: attackSpecLevel,\n      \n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      \n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Handle rolling NPC spell with dice\n   */\n  private async _onRollNPCSpellDice(event: JQuery.ClickEvent): Promise<void> {\n    event.preventDefault();\n    const element = $(event.currentTarget);\n    const itemId = element.data('item-id') || element.attr('data-item-id');\n    const spellVD = element.data('spell-vd') || element.attr('data-spell-vd') || '0';\n\n    if (!itemId) return;\n\n    const spell = this.actor.items.get(itemId);\n    if (!spell || spell.type !== 'feat') return;\n\n    const spellSystem = spell.system as any;\n    const weaponType = spellSystem.weaponType;\n    \n    let weaponLinkedSkill = '';\n    let weaponLinkedSpecialization = '';\n    let weaponLinkedDefenseSkill = '';\n    let weaponLinkedDefenseSpecialization = '';\n    \n    if (weaponType && weaponType !== 'custom-weapon') {\n      const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n      if (weaponStats) {\n        weaponLinkedSkill = weaponStats.linkedSkill || '';\n        weaponLinkedSpecialization = weaponStats.linkedSpecialization || '';\n        weaponLinkedDefenseSkill = weaponStats.linkedDefenseSkill || '';\n        weaponLinkedDefenseSpecialization = weaponStats.linkedDefenseSpecialization || '';\n      }\n    }\n\n    // Enrich RR list with featName\n    const rawItemRRList = spellSystem.rrList || [];\n    const itemRRList = rawItemRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: spell.name  // Add featName (the spell name itself)\n    }));\n\n    // Merge weapon type links with custom fields (weapon type has priority)\n    const finalAttackSkill = weaponLinkedSkill || spellSystem.linkedAttackSkill || '';\n    const finalAttackSpec = weaponLinkedSpecialization || spellSystem.linkedAttackSpecialization || '';\n    const finalDefenseSkill = weaponLinkedDefenseSkill || spellSystem.linkedDefenseSkill || '';\n    const finalDefenseSpec = weaponLinkedDefenseSpecialization || spellSystem.linkedDefenseSpecialization || '';\n\n    // Find actor's skill and specialization based on spell links\n    let attackSkillName = '';\n    let attackSkillLevel = 0;\n    let attackSpecName = '';\n    let attackSpecLevel = 0;\n    let attackLinkedAttribute = '';\n    \n    // Try to find the linked attack specialization first\n    if (finalAttackSpec) {\n      const foundSpec = this.actor.items.find((i: any) => \n        i.type === 'specialization' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSpec)\n      );\n      \n      if (foundSpec) {\n        const specSystem = foundSpec.system as any;\n        attackSpecName = foundSpec.name;\n        attackLinkedAttribute = specSystem.linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        \n        // Get parent skill for specialization\n        const linkedSkillName = specSystem.linkedSkill;\n        if (linkedSkillName) {\n          const parentSkill = this.actor.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          if (parentSkill) {\n            attackSkillName = parentSkill.name;\n            const skillRating = (parentSkill.system as any).rating || 0;\n            attackSkillLevel = skillRating;  // Just the skill rating (without attribute)\n            attackSpecLevel = attributeValue + skillRating + 2; // Total dice pool (attribute + rating + 2)\n          }\n        }\n      }\n    }\n    \n    // If no specialization found, try to find the linked attack skill\n    if (!attackSpecName && finalAttackSkill) {\n      const foundSkill = this.actor.items.find((i: any) => \n        i.type === 'skill' && \n        ItemSearch.normalizeSearchText(i.name) === ItemSearch.normalizeSearchText(finalAttackSkill)\n      );\n      \n      if (foundSkill) {\n        attackSkillName = foundSkill.name;\n        attackLinkedAttribute = (foundSkill.system as any).linkedAttribute || 'strength';\n        const attributeValue = attackLinkedAttribute ? ((this.actor.system as any).attributes?.[attackLinkedAttribute] || 0) : 0;\n        const skillRating = (foundSkill.system as any).rating || 0;\n        attackSkillLevel = attributeValue + skillRating; // Total dice pool (attribute + rating)\n      }\n    }\n\n    // Calculate final damage value (base + bonus)\n    const baseDamageValue = spellSystem.damageValue || '0';\n    const damageValueBonus = spellSystem.damageValueBonus || 0;\n    \n    let finalDamageValue = baseDamageValue;\n    if (damageValueBonus > 0 && baseDamageValue !== '0') {\n      if (baseDamageValue === 'FOR') {\n        finalDamageValue = `FOR+${damageValueBonus}`;\n      } else if (baseDamageValue.startsWith('FOR+')) {\n        const baseModifier = parseInt(baseDamageValue.substring(4)) || 0;\n        finalDamageValue = `FOR+${baseModifier + damageValueBonus}`;\n      } else if (baseDamageValue !== 'toxin') {\n        const baseValue = parseInt(baseDamageValue) || 0;\n        finalDamageValue = (baseValue + damageValueBonus).toString();\n      }\n    }\n\n    // Get RR sources from skill/specialization/attribute\n    const { getRRSources } = SheetHelpers;\n    let skillRRSources: Array<{featName: string, rrValue: number}> = [];\n    let specRRSources: Array<{featName: string, rrValue: number}> = [];\n    let attributeRRSources: Array<{featName: string, rrValue: number}> = [];\n    \n    if (attackSpecName) {\n      specRRSources = getRRSources(this.actor, 'specialization', attackSpecName);\n    }\n    if (attackSkillName) {\n      skillRRSources = getRRSources(this.actor, 'skill', attackSkillName);\n    }\n    if (attackLinkedAttribute) {\n      attributeRRSources = getRRSources(this.actor, 'attribute', attackLinkedAttribute);\n    }\n    \n    // Merge all RR sources\n    const allRRSources = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n\n    DiceRoller.handleRollRequest({\n      itemType: 'spell',\n      weaponType: weaponType,\n      itemName: spell.name,\n      itemId: itemId,\n      itemRating: spellSystem.rating || 0,\n      itemActive: spellSystem.active,\n      \n      linkedAttackSkill: finalAttackSkill,\n      linkedAttackSpecialization: finalAttackSpec,\n      linkedDefenseSkill: finalDefenseSkill,\n      linkedDefenseSpecialization: finalDefenseSpec,\n      linkedAttribute: attackLinkedAttribute,\n      \n      isWeaponFocus: spellSystem.isWeaponFocus || false,\n      damageValue: finalDamageValue,  // FINAL damage value (base + bonus)\n      meleeRange: spellSystem.meleeRange,\n      shortRange: spellSystem.shortRange,\n      mediumRange: spellSystem.mediumRange,\n      longRange: spellSystem.longRange,\n      \n      // Attack skill/spec from actor (based on spell links)\n      skillName: attackSkillName,\n      skillLevel: attackSkillLevel,\n      specName: attackSpecName,\n      specLevel: attackSpecLevel,\n      \n      actorId: this.actor.id,\n      actorUuid: this.actor.uuid,\n      actorName: this.actor.name,\n      \n      rrList: allRRSources\n    });\n  }\n\n  /**\n   * Get RR sources from active feats\n   */\n  private getRRSources(itemType: 'skill' | 'specialization' | 'attribute', itemName: string): Array<{ featName: string, rrValue: number }> {\n    return SheetHelpers.getRRSources(this.actor, itemType, itemName);\n  }\n\n  /**\n   * REMOVED: Skill dice rolling logic\n   */\n  private async _rollSkillDice(skillName: string, dicePool: number, riskDice: number = 0, riskReduction: number = 0, rollMode: string = 'normal'): Promise<void> {\n    console.log('NPC dice roll disabled', { skillName, dicePool, riskDice, riskReduction, rollMode });\n  }\n\n\n  /**\n   * Show item browser dialog\n   */\n  private async _showItemBrowser(itemType: string): Promise<void> {\n    const items = game.items!.filter((item: any) => item.type === itemType);\n    \n    const itemOptions = items.map((item: any) => {\n      return `<option value=\"${item.id}\">${item.name}</option>`;\n    }).join('');\n\n    const content = `\n      <div class=\"form-group\">\n        <label>${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.WORLD_ITEMS`)}</label>\n        <select id=\"item-select\" style=\"width: 100%;\">\n          <option value=\"\">${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.SEARCH_PLACEHOLDER`)}</option>\n          ${itemOptions}\n        </select>\n      </div>\n    `;\n\n    new Dialog({\n      title: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\n      content,\n      buttons: {\n        add: {\n          icon: '<i class=\"fas fa-plus\"></i>',\n          label: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\n          callback: async (html: JQuery) => {\n            const itemId = html.find('#item-select').val() as string;\n            if (itemId) {\n              const item = game.items!.get(itemId);\n              if (item) {\n                await this.actor.createEmbeddedDocuments('Item', [item.toObject()]);\n              }\n            }\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'add'\n    }).render(true);\n  }\n\n  protected override async _onDropItem(_event: DragEvent, data: ActorSheet.DropData.Item): Promise<unknown> {\n    if (!this.actor.isOwner) return false;\n    const item = await Item.implementation.fromDropData(data);\n    if (!item) return false;\n\n    // Check if item already exists on the actor\n    const existingItem = this.actor.items.find((i: any) => i.name === item.name && i.type === item.type);\n    if (existingItem) {\n      ui.notifications!.warn(game.i18n!.format('SRA2.ALREADY_EXISTS', { name: item.name }));\n      return false;\n    }\n\n    // Create the item on the actor\n    return await this.actor.createEmbeddedDocuments('Item', [item.toObject()]);\n  }\n}\n\n","import * as SheetHelpers from '../helpers/sheet-helpers.js';\nimport * as CombatHelpers from '../helpers/combat-helpers.js';\nimport * as DiceRoller from '../helpers/dice-roller.js';\nimport { VEHICLE_TYPES, WEAPON_TYPES } from '../models/item-feat.js';\n\n/**\n * Vehicle/Drone Sheet Application\n */\nexport class VehicleSheet extends ActorSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Actor> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'actor', 'vehicle'],\n      template: 'systems/sra2/templates/actor-vehicle-sheet.hbs',\n      width: 800,\n      height: 700,\n      tabs: [],\n      dragDrop: [\n        { dragSelector: '.item', dropSelector: '.sheet-body' }\n      ],\n      submitOnChange: false,\n    });\n  }\n\n  /**\n   * Handle form submission to update actor data\n   */\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = SheetHelpers.handleSheetUpdate(this.actor, formData);\n    return this.actor.update(expandedData);\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n\n    // Ensure system data is available\n    context.system = this.actor.system;\n\n    // Ensure damage arrays are properly initialized\n    const systemData = context.system as any;\n    if (!systemData.damage) {\n      systemData.damage = {\n        light: [false, false],\n        severe: [false],\n        incapacitating: false\n      };\n    } else {\n      // Ensure arrays are properly sized\n      if (!Array.isArray(systemData.damage.light)) {\n        systemData.damage.light = [false, false];\n      }\n      while (systemData.damage.light.length < 2) {\n        systemData.damage.light.push(false);\n      }\n      while (systemData.damage.light.length > 2) {\n        systemData.damage.light.pop();\n      }\n      \n      if (!Array.isArray(systemData.damage.severe)) {\n        systemData.damage.severe = [false];\n      }\n      while (systemData.damage.severe.length < 1) {\n        systemData.damage.severe.push(false);\n      }\n      while (systemData.damage.severe.length > 1) {\n        systemData.damage.severe.pop();\n      }\n      \n      if (typeof systemData.damage.incapacitating !== 'boolean') {\n        systemData.damage.incapacitating = false;\n      }\n    }\n\n    // Add vehicle types for selection\n    context.vehicleTypes = VEHICLE_TYPES;\n\n    // Get feats (weapons only for vehicles)\n    const allFeats = this.actor.items.filter((item: any) => item.type === 'feat');\n    \n    // Get all active feats for RR calculation\n    const activeFeats = allFeats.filter((feat: any) => feat.system.active === true);\n    \n    // Get vehicle's structure for damage value calculations (similar to strength for characters)\n    const vehicleStructure = (this.actor.system as any).attributes?.structure || 0;\n    \n    // Helper function to calculate weapon stats\n    const calculateWeaponStats = (item: any) => {\n      const itemData = {\n        ...item,\n        _id: item.id || item._id,\n        id: item.id || item._id\n      };\n      \n      // For vehicles, weapons use Autopilot attribute when autonomous\n      // Otherwise, they would use the pilot's skills (handled externally)\n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\n      let totalDicePool = autopilot; // Base dice pool from autopilot\n      let totalRR = 0;\n      \n      // Calculate RR from active feats\n      activeFeats.forEach((feat: any) => {\n        const rrList = feat.system.rrList || [];\n        rrList.forEach((rrEntry: any) => {\n          if (rrEntry.rrType === 'attribute' && rrEntry.rrTarget === 'autopilot') {\n            totalRR += rrEntry.rrValue || 0;\n          }\n        });\n      });\n      \n      itemData.totalDicePool = totalDicePool;\n      itemData.totalRR = totalRR;\n      \n      // Calculate final damage value with bonus\n      const damageValue = item.system.damageValue || '0';\n      const damageValueBonus = item.system.damageValueBonus || 0;\n      itemData.finalDamageValue = SheetHelpers.calculateFinalDamageValue(damageValue, damageValueBonus, vehicleStructure);\n      \n      return itemData;\n    };\n    \n    // Filter and process weapons (only weapons allowed for vehicles)\n    const rawWeapons = allFeats.filter((feat: any) => \n      feat.system.featType === 'weapon' || feat.system.featType === 'weapons-spells'\n    );\n    const weapons = rawWeapons.map((weapon: any) => calculateWeaponStats(weapon));\n    \n    context.weapons = weapons;\n\n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n\n    // Section navigation\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\n\n    // Edit feat/weapon\n    html.find('.feat-edit, .weapon-edit').on('click', (event) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        item.sheet?.render(true);\n      }\n    });\n\n    // Delete feat/weapon\n    html.find('.feat-delete, .weapon-delete').on('click', async (event) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (item) {\n        const confirmed = await Dialog.confirm({\n          title: game.i18n!.format('SRA2.CONFIRM_DELETE', { name: item.name }),\n          content: '',\n          yes: () => true,\n          no: () => false,\n          defaultYes: false\n        });\n        if (confirmed) {\n          await item.delete();\n        }\n      }\n    });\n\n    // Add world weapon (only weapons allowed)\n    html.find('.add-world-weapon-button').on('click', async (event) => {\n      event.preventDefault();\n      this._showItemBrowser('feat', true); // true = weapons only\n    });\n\n    // Roll weapon dice (using autopilot)\n    html.find('.weapon-dice-pool').on('click', async (event) => {\n      event.preventDefault();\n      const itemId = $(event.currentTarget).data('item-id');\n      const item = this.actor.items.get(itemId);\n      if (!item) return;\n      \n      const autopilot = (this.actor.system as any).attributes?.autopilot || 0;\n      if (autopilot <= 0) {\n        ui.notifications?.warn(game.i18n!.localize('SRA2.ATTRIBUTES.NO_DICE'));\n        return;\n      }\n      \n      // Prepare complete weapon roll request data using combat-helpers\n      const rollRequestData = CombatHelpers.prepareVehicleWeaponRollRequest(\n        this.actor,\n        item,\n        WEAPON_TYPES\n      );\n      \n      // Call dice roller with prepared data\n      DiceRoller.handleRollRequest(rollRequestData);\n    });\n\n    // Handle vehicle type change\n    html.find('.vehicle-type-select').on('change', this._onVehicleTypeChange.bind(this));\n\n    // Add narrative effect\n    html.find('.add-narrative-effect-button').on('click', async (event) => {\n      event.preventDefault();\n      const narrativeEffects = [...((this.actor.system as any).narrativeEffects || [])];\n      narrativeEffects.push('');\n      await this.actor.update({\n        'system.narrativeEffects': narrativeEffects\n      } as any);\n    });\n\n    // Remove narrative effect\n    html.find('.remove-narrative-effect').on('click', async (event) => {\n      event.preventDefault();\n      const index = parseInt($(event.currentTarget).data('index') || '0');\n      const narrativeEffects = [...((this.actor.system as any).narrativeEffects || [])];\n      narrativeEffects.splice(index, 1);\n      await this.actor.update({\n        'system.narrativeEffects': narrativeEffects\n      } as any);\n    });\n\n    // Handle damage checkbox changes (both in header and combat section)\n    html.find('input[name^=\"system.damage.\"]').on('change', async (event) => {\n      const input = event.currentTarget as HTMLInputElement;\n      const name = input.name;\n      const checked = input.checked;\n      \n      // Save current active section before update\n      const activeNavItem = html.find('.section-nav .nav-item.active');\n      const activeSection = activeNavItem.length > 0 ? activeNavItem.data('section') : null;\n      \n      // Parse the name to get the path (e.g., \"system.damage.light.0\" -> [\"damage\", \"light\", \"0\"])\n      const pathParts = name.split('.').slice(1); // Remove \"system\"\n      \n      if (pathParts.length >= 2 && pathParts[0] === 'damage') {\n        const damageType = pathParts[1]; // \"light\", \"severe\", or \"incapacitating\"\n        \n        // Update data without triggering full render\n        if (damageType === 'incapacitating') {\n          // For incapacitating, it's a boolean, not an array\n          await this.actor.updateSource({\n            'system.damage.incapacitating': checked\n          } as any);\n        } else if (damageType === 'light' || damageType === 'severe') {\n          // For light and severe, it's an array\n          if (pathParts.length >= 3 && pathParts[2]) {\n            const index = parseInt(pathParts[2]);\n            const damage = (this.actor.system as any).damage || {};\n            const damageArray = [...(damage[damageType] || [])];\n            \n            // Ensure array is long enough\n            while (damageArray.length <= index) {\n              damageArray.push(false);\n            }\n            \n            damageArray[index] = checked;\n            \n            await this.actor.updateSource({\n              [`system.damage.${damageType}`]: damageArray\n            } as any);\n          }\n        }\n        \n        // Update the actor to persist changes, but don't re-render\n        await this.actor.update({}, { render: false });\n        \n        // Synchronize all checkboxes with the same name\n        html.find(`input[name=\"${name}\"]`).prop('checked', checked);\n        \n        // Update visual state for track-boxes in header\n        if (damageType === 'incapacitating') {\n          html.find(`label.track-box input[name=\"system.damage.incapacitating\"]`).prop('checked', checked);\n          html.find(`label.track-box input[name=\"system.damage.incapacitating\"]`).closest('label.track-box')\n            .toggleClass('checked', checked);\n        } else {\n          html.find(`input[name=\"${name}\"]`).each((_, checkbox) => {\n            const $checkbox = $(checkbox);\n            $checkbox.prop('checked', checked);\n            $checkbox.closest('label.track-box').toggleClass('checked', checked);\n          });\n        }\n        \n        // Restore active section after update\n        if (activeSection) {\n          setTimeout(() => {\n            const currentHtml = $(this.element);\n            const form = currentHtml.closest('form')[0];\n            if (form) {\n              const navButton = form.querySelector(`[data-section=\"${activeSection}\"]`);\n              if (navButton) {\n                // Manually set active section without triggering navigation\n                form.querySelectorAll('.section-nav .nav-item').forEach((item) => item.classList.remove('active'));\n                navButton.classList.add('active');\n                \n                form.querySelectorAll('.content-section').forEach((section) => section.classList.remove('active'));\n                const targetSection = form.querySelector(`[data-section-content=\"${activeSection}\"]`);\n                if (targetSection) {\n                  targetSection.classList.add('active');\n                }\n              }\n            }\n          }, 10);\n        }\n      }\n    });\n  }\n\n  /**\n   * Handle section navigation\n   */\n  private _onSectionNavigation(event: Event): void {\n    event.preventDefault();\n    const button = event.currentTarget as HTMLElement;\n    const section = button.dataset.section;\n    if (!section) return;\n\n    const form = button.closest('form');\n    if (!form) return;\n\n    form.querySelectorAll('.section-nav .nav-item').forEach((item) => item.classList.remove('active'));\n    button.classList.add('active');\n\n    form.querySelectorAll('.content-section').forEach((section) => section.classList.remove('active'));\n    const targetSection = form.querySelector(`[data-section-content=\"${section}\"]`);\n    if (targetSection) {\n      targetSection.classList.add('active');\n    }\n  }\n\n  /**\n   * Handle vehicle type selection change\n   */\n  private async _onVehicleTypeChange(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const vehicleType = (event.currentTarget as HTMLSelectElement).value;\n    \n    if (!vehicleType || !VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES]) {\n      return;\n    }\n    \n    // Update vehicle type - the prepareDerivedData will calculate the attributes\n    await this.actor.update({\n      'system.vehicleType': vehicleType\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Show item browser dialog\n   */\n  private async _showItemBrowser(itemType: string, weaponsOnly: boolean = false): Promise<void> {\n    let items = game.items!.filter((item: any) => item.type === itemType);\n    \n    // Filter to only weapons if requested\n    if (weaponsOnly) {\n      items = items.filter((item: any) => {\n        const featType = item.system?.featType;\n        return featType === 'weapon' || featType === 'weapons-spells';\n      });\n    }\n    \n    const itemOptions = items.map((item: any) => {\n      return `<option value=\"${item.id}\">${item.name}</option>`;\n    }).join('');\n\n    const content = `\n      <div class=\"form-group\">\n        <label>${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.WORLD_ITEMS`)}</label>\n        <select id=\"item-select\" style=\"width: 100%;\">\n          <option value=\"\">${game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.SEARCH_PLACEHOLDER`)}</option>\n          ${itemOptions}\n        </select>\n      </div>\n    `;\n\n    new Dialog({\n      title: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\n      content,\n      buttons: {\n        add: {\n          icon: '<i class=\"fas fa-plus\"></i>',\n          label: game.i18n!.localize(`SRA2.${itemType.toUpperCase()}S.ADD_${itemType.toUpperCase()}`),\n          callback: async (html: JQuery) => {\n            const itemId = html.find('#item-select').val() as string;\n            if (itemId) {\n              const item = game.items!.get(itemId);\n              if (item) {\n                await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\n              }\n            }\n          }\n        },\n        cancel: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Cancel')\n        }\n      },\n      default: 'add'\n    }).render(true);\n  }\n\n  /**\n   * Handle dropping items onto the sheet\n   */\n  protected override async _onDrop(event: DragEvent): Promise<boolean | void> {\n    // Get the dropped data\n    let data;\n    try {\n      data = JSON.parse(event.dataTransfer?.getData('text/plain') || '{}');\n    } catch (err) {\n      return super._onDrop(event);\n    }\n    \n    // Only allow weapons (feats of type weapon or weapons-spells)\n    if (data.type === 'Item') {\n      const item = await Item.fromDropData(data);\n      if (item && item.type === 'feat') {\n        const featType = (item.system as any).featType;\n        if (featType === 'weapon' || featType === 'weapons-spells') {\n          // Create the item on the actor\n          await this.actor.createEmbeddedDocuments('Item', [(item as any).toObject()]);\n          return false; // Prevent default behavior and refresh\n        } else {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.VEHICLE.ONLY_WEAPONS_ALLOWED'));\n          return false; // Prevent default behavior\n        }\n      }\n    }\n    \n    // Fall back to default behavior for other item types\n    return super._onDrop(event);\n  }\n}\n\n","import { WEAPON_TYPES, VEHICLE_TYPES } from '../models/item-feat.js';\nimport * as ItemSearch from '../helpers/item-search.js';\n\n/**\n * Feat Sheet Application\n */\nexport class FeatSheet extends ItemSheet {\n  /** Track the currently active section */\n  private _activeSection: string = 'general';\n  \n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'feat'],\n      template: 'systems/sra2/templates/item-feat-sheet.hbs',\n      width: 720,\n      height: 680,\n      tabs: [],\n      dragDrop: [\n        { dropSelector: '.rr-target-drop-zone' }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    \n    // Ensure prepareDerivedData is called to calculate recommendedLevel\n    this.item.prepareData();\n    \n    context.system = this.item.system;\n    \n    // Pass the active section to the template\n    context.activeSection = this._activeSection;\n    \n    // Calculate final damage value\n    context.finalDamageValue = this._calculateFinalDamageValue();\n    \n    // Calculate final vehicle stats\n    context.finalVehicleStats = this._calculateFinalVehicleStats();\n    \n    // Build RR entries array from rrList\n    context.rrEntries = [];\n    const rrList = context.system.rrList || [];\n    \n    for (let i = 0; i < rrList.length; i++) {\n      const rrEntry = rrList[i];\n      const rrType = rrEntry.rrType;\n      const rrValue = rrEntry.rrValue || 0;\n      const rrTarget = rrEntry.rrTarget || '';\n      \n      const entry: any = {\n        index: i,\n        rrType,\n        rrValue,\n        rrTarget,\n        rrTargetName: rrTarget\n      };\n      \n      if (rrType === 'skill' || rrType === 'specialization') {\n        entry.rrTargetType = rrType === 'skill' \n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\n        \n        // If the feat is on an actor, check if the target exists\n        if (this.item.actor && rrTarget) {\n          const targetItem = this.item.actor.items.find((i: any) => \n            i.type === rrType && i.name === rrTarget\n          );\n          \n          if (!targetItem) {\n            entry.rrTargetNotFound = true;\n          }\n        }\n      }\n      \n      context.rrEntries.push(entry);\n    }\n    \n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    \n    // Add RR entry button\n    html.find('[data-action=\"add-rr-entry\"]').on('click', this._onAddRREntry.bind(this));\n    \n    // Remove RR entry button\n    html.find('[data-action=\"remove-rr-entry\"]').on('click', this._onRemoveRREntry.bind(this));\n    \n    // Clear RR target button\n    html.find('[data-action=\"clear-rr-target\"]').on('click', this._onClearRRTarget.bind(this));\n    \n    // Add narrative effect button\n    html.find('[data-action=\"add-narrative-effect\"]').on('click', this._onAddNarrativeEffect.bind(this));\n    \n    // Remove narrative effect button\n    html.find('[data-action=\"remove-narrative-effect\"]').on('click', this._onRemoveNarrativeEffect.bind(this));\n    \n    // Weapon type selection\n    html.find('[data-action=\"select-weapon-type\"]').on('change', this._onWeaponTypeChange.bind(this));\n    \n    // Vehicle type selection\n    html.find('[data-action=\"select-vehicle-type\"]').on('change', this._onVehicleTypeChange.bind(this));\n    \n    // Damage value bonus checkboxes\n    html.find('.damage-bonus-checkbox').on('change', this._onDamageValueBonusChange.bind(this));\n    \n    // Sustained spell checkboxes\n    html.find('.sustained-spell-checkbox').on('change', this._onSustainedSpellChange.bind(this));\n    \n    // Summoned spirit checkbox\n    html.find('.summoned-spirit-checkbox').on('change', this._onSummonedSpiritChange.bind(this));\n    \n    // Range improvement checkboxes\n    html.find('.range-improvement-checkbox input[type=\"checkbox\"]').on('change', this._onRangeImprovementChange.bind(this));\n    \n    // Section navigation\n    html.find('.section-nav .nav-item').on('click', this._onSectionNavigation.bind(this));\n    \n    // RR target search\n    html.find('.rr-target-search-input').on('input', this._onRRTargetSearch.bind(this));\n    html.find('.rr-target-search-input').on('focus', this._onRRTargetSearchFocus.bind(this));\n    html.find('.rr-target-search-input').on('blur', this._onRRTargetSearchBlur.bind(this));\n    \n    // Close RR target search results when clicking outside\n    $(document).on('click.rr-target-search', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const searchContainers = html.find('.rr-target-search-container');\n      searchContainers.each((_, container) => {\n        if (!container.contains(target)) {\n          $(container).find('.rr-target-search-results').hide();\n        }\n      });\n    });\n  }\n  \n  /**\n   * Handle section navigation\n   */\n  private _onSectionNavigation(event: Event): void {\n    event.preventDefault();\n    \n    const button = event.currentTarget as HTMLElement;\n    const section = button.dataset.section;\n    \n    if (!section) return;\n    \n    // Save the active section\n    this._activeSection = section;\n    \n    // Find the form element\n    if (!this.form) return;\n    const form = $(this.form);\n    \n    // Update navigation buttons\n    form.find('.section-nav .nav-item').removeClass('active');\n    button.classList.add('active');\n    \n    // Update content sections\n    form.find('.content-section').removeClass('active');\n    form.find(`[data-section-content=\"${section}\"]`).addClass('active');\n  }\n\n  /**\n   * Handle adding a new RR entry\n   */\n  private async _onAddRREntry(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    rrList.push({\n      rrType: 'skill',\n      rrValue: 0,\n      rrTarget: ''\n    });\n    \n    await this.item.update({\n      'system.rrList': rrList\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle removing an RR entry\n   */\n  private async _onRemoveRREntry(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    rrList.splice(index, 1);\n    \n    await this.item.update({\n      'system.rrList': rrList\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle clearing the RR target for a specific entry\n   */\n  private async _onClearRRTarget(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    if (rrList[index]) {\n      rrList[index] = { ...rrList[index], rrTarget: '' };\n    }\n    \n    await this.item.update({ 'system.rrList': rrList } as any);\n    this.render(false);\n  }\n\n  /**\n   * Handle dropping a skill or specialization onto the RR target field\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const data = TextEditor.getDragEventData(event) as any;\n    \n    // Handle Item drops\n    if (data && data.type === 'Item') {\n      const item = await Item.implementation.fromDropData(data) as any;\n      \n      if (!item) return super._onDrop(event);\n      \n      // Find the drop zone and get the index\n      const dropZone = (event.target as HTMLElement).closest('[data-rr-index]');\n      if (!dropZone) return super._onDrop(event);\n      \n      const index = parseInt((dropZone as HTMLElement).dataset.rrIndex || '0');\n      const rrList = [...((this.item.system as any).rrList || [])];\n      const rrType = rrList[index]?.rrType;\n      \n      // Check if it's a skill or specialization matching the RR type\n      if (item.type === 'skill' && rrType === 'skill') {\n        // Store the skill name (not ID) so the feat can be prepared in advance\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\n        await this.item.update({ 'system.rrList': rrList } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\n        return;\n      } else if (item.type === 'specialization' && rrType === 'specialization') {\n        // Store the specialization name (not ID) so the feat can be prepared in advance\n        rrList[index] = { ...rrList[index], rrTarget: item.name };\n        await this.item.update({ 'system.rrList': rrList } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: item.name }));\n        return;\n      } else if (rrType === 'skill' || rrType === 'specialization') {\n        // Wrong type of item\n        ui.notifications?.warn(game.i18n!.localize('SRA2.FEATS.WRONG_TARGET_TYPE'));\n        return;\n      }\n    }\n\n    return super._onDrop(event);\n  }\n\n  /**\n   * Handle adding a new narrative effect\n   */\n  private async _onAddNarrativeEffect(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\n    \n    narrativeEffects.push({\n      text: \"\",\n      isNegative: false\n    });\n    \n    await this.item.update({\n      'system.narrativeEffects': narrativeEffects\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle removing a narrative effect\n   */\n  private async _onRemoveNarrativeEffect(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const index = parseInt((event.currentTarget as HTMLElement).dataset.index || '0');\n    \n    const narrativeEffects = [...((this.item.system as any).narrativeEffects || [])];\n    \n    narrativeEffects.splice(index, 1);\n    \n    await this.item.update({\n      'system.narrativeEffects': narrativeEffects\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Calculate the final damage value taking into account STRENGTH attribute\n   */\n  private _calculateFinalDamageValue(): string {\n    const damageValue = (this.item.system as any).damageValue || \"0\";\n    const damageValueBonus = (this.item.system as any).damageValueBonus || 0;\n    \n    // Get the actor's strength if available\n    const strength = this.item.actor ? ((this.item.actor.system as any)?.attributes?.strength || 0) : 0;\n    \n    // Parse the damage value\n    if (damageValue === \"FOR\") {\n      // Pure STRENGTH\n      const total = strength + damageValueBonus;\n      if (!this.item.actor) {\n        return damageValueBonus > 0 ? `FOR+${damageValueBonus}` : \"FOR\";\n      }\n      return `${total} (FOR${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\n    } else if (damageValue.startsWith(\"FOR+\")) {\n      // STRENGTH + modifier\n      const modifier = parseInt(damageValue.substring(4)) || 0;\n      const total = strength + modifier + damageValueBonus;\n      if (!this.item.actor) {\n        return damageValueBonus > 0 ? `FOR+${modifier}+${damageValueBonus}` : `FOR+${modifier}`;\n      }\n      return `${total} (FOR+${modifier}${damageValueBonus > 0 ? `+${damageValueBonus}` : ''})`;\n    } else if (damageValue === \"toxin\") {\n      // Special case for gas grenades\n      return \"selon toxine\";\n    } else {\n      // Numeric value\n      const base = parseInt(damageValue) || 0;\n      const total = base + damageValueBonus;\n      if (damageValueBonus > 0) {\n        return `${total} (${base}+${damageValueBonus})`;\n      }\n      return total.toString();\n    }\n  }\n\n  /**\n   * Handle weapon type selection change\n   */\n  private async _onWeaponTypeChange(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const weaponType = (event.currentTarget as HTMLSelectElement).value;\n    \n    if (!weaponType || !WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES]) {\n      return;\n    }\n    \n    const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n    \n    // Convert damage value to string\n    const damageValue = typeof weaponStats.vd === 'number' ? weaponStats.vd.toString() : weaponStats.vd;\n    \n    await this.item.update({\n      'system.weaponType': weaponType,\n      'system.damageValue': damageValue,\n      'system.meleeRange': weaponStats.melee,\n      'system.shortRange': weaponStats.short,\n      'system.mediumRange': weaponStats.medium,\n      'system.longRange': weaponStats.long\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Handle vehicle type selection change\n   */\n  private async _onVehicleTypeChange(event: Event): Promise<void> {\n    event.preventDefault();\n    \n    const vehicleType = (event.currentTarget as HTMLSelectElement).value;\n    \n    if (!vehicleType || !VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES]) {\n      return;\n    }\n    \n    const vehicleStats = VEHICLE_TYPES[vehicleType as keyof typeof VEHICLE_TYPES];\n    \n    await this.item.update({\n      'system.vehicleType': vehicleType,\n      'system.autopilot': vehicleStats.autopilot,\n      'system.structure': vehicleStats.structure,\n      'system.handling': vehicleStats.handling,\n      'system.speed': vehicleStats.speed,\n      'system.flyingSpeed': vehicleStats.flyingSpeed,\n      'system.armor': vehicleStats.armor,\n      'system.weaponMount': vehicleStats.weaponMount\n    } as any);\n    \n    this.render(false);\n  }\n\n  /**\n   * Calculate the final vehicle stats taking into account bonuses\n   */\n  private _calculateFinalVehicleStats(): any {\n    const baseAutopilot = (this.item.system as any).autopilot || 6;\n    const baseStructure = (this.item.system as any).structure || 2;\n    const baseHandling = (this.item.system as any).handling || 5;\n    const baseSpeed = (this.item.system as any).speed || 3;\n    const baseFlyingSpeed = (this.item.system as any).flyingSpeed || 0;\n    const baseArmor = (this.item.system as any).armor || 0;\n    \n    const autopilotBonus = (this.item.system as any).autopilotBonus || 0;\n    const speedBonus = (this.item.system as any).speedBonus || 0;\n    const handlingBonus = (this.item.system as any).handlingBonus || 0;\n    const armorBonus = (this.item.system as any).armorBonus || 0;\n    const isFlying = (this.item.system as any).isFlying || false;\n    const isFixed = (this.item.system as any).isFixed || false;\n    \n    // Calculate final values\n    const finalAutopilot = Math.min(12, baseAutopilot + autopilotBonus);\n    const finalHandling = baseHandling + handlingBonus;\n    const finalSpeed = isFixed ? 0 : (baseSpeed + speedBonus);\n    const finalFlyingSpeed = isFlying ? (baseFlyingSpeed > 0 ? baseFlyingSpeed : 1) : 0;\n    const finalArmor = Math.min(baseStructure, baseArmor + armorBonus);\n    \n    return {\n      autopilot: finalAutopilot,\n      structure: baseStructure,\n      handling: finalHandling,\n      speed: finalSpeed,\n      flyingSpeed: finalFlyingSpeed,\n      armor: finalArmor\n    };\n  }\n\n\n  /**\n   * Handle damage value bonus checkbox changes\n   */\n  private _onDamageValueBonusChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const value = parseInt(checkbox.dataset.bonusValue || '0');\n    const currentBonus = (this.item.system as any).damageValueBonus || 0;\n    \n    let newBonus: number;\n    \n    if (checkbox.checked) {\n      // If checking, set to the checkbox value\n      newBonus = value;\n    } else {\n      // If unchecking, decrease appropriately\n      if (value === 2 && currentBonus === 2) {\n        newBonus = 1;\n      } else if (value === 1 && currentBonus >= 1) {\n        newBonus = 0;\n      } else {\n        newBonus = currentBonus;\n      }\n    }\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.damageValueBonus\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newBonus.toString();\n    }\n    \n    // Update the checkboxes state\n    const checkboxes = this.element.find('.damage-bonus-checkbox');\n    checkboxes.each((_, cb) => {\n      const cbElement = cb as HTMLInputElement;\n      const cbValue = parseInt(cbElement.dataset.bonusValue || '0');\n      if (cbValue === 1) {\n        cbElement.checked = newBonus >= 1;\n      } else if (cbValue === 2) {\n        cbElement.checked = newBonus === 2;\n      }\n    });\n  }\n\n  /**\n   * Handle sustained spell checkbox changes\n   */\n  private _onSustainedSpellChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const value = parseInt(checkbox.dataset.spellValue || '0');\n    const currentCount = (this.item.system as any).sustainedSpellCount || 0;\n    \n    let newCount: number;\n    \n    if (checkbox.checked) {\n      // If checking, set to the checkbox value\n      newCount = value;\n    } else {\n      // If unchecking, decrease appropriately\n      if (value === 2 && currentCount === 2) {\n        newCount = 1;\n      } else if (value === 1 && currentCount >= 1) {\n        newCount = 0;\n      } else {\n        newCount = currentCount;\n      }\n    }\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.sustainedSpellCount\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newCount.toString();\n    }\n    \n    // Update the checkboxes state\n    const checkboxes = this.element.find('.sustained-spell-checkbox');\n    checkboxes.each((_, cb) => {\n      const cbElement = cb as HTMLInputElement;\n      const cbValue = parseInt(cbElement.dataset.spellValue || '0');\n      if (cbValue === 1) {\n        cbElement.checked = newCount >= 1;\n      } else if (cbValue === 2) {\n        cbElement.checked = newCount === 2;\n      }\n    });\n  }\n\n  /**\n   * Handle summoned spirit checkbox change\n   */\n  private _onSummonedSpiritChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const newCount = checkbox.checked ? 1 : 0;\n    \n    // Update the hidden input field\n    const hiddenInput = this.element.find('input[name=\"system.summonedSpiritCount\"]')[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newCount.toString();\n    }\n  }\n\n  /**\n   * Handle range improvement checkbox change\n   * When checked, automatically improves the range: none -> disadvantage, disadvantage -> ok\n   * When unchecked, automatically downgrades the range: ok -> disadvantage, disadvantage -> none\n   */\n  private _onRangeImprovementChange(event: Event): void {\n    event.preventDefault();\n    \n    const checkbox = event.currentTarget as HTMLInputElement;\n    const isChecked = checkbox.checked;\n    \n    // Find which range this checkbox is for\n    const rangeRow = checkbox.closest('.range-row');\n    if (!rangeRow) return;\n    \n    const select = rangeRow.querySelector('select') as HTMLSelectElement;\n    if (!select) return;\n    \n    // Determine which range field we're dealing with\n    const rangeLabel = rangeRow.querySelector('.range-label')?.textContent || '';\n    let fieldName = '';\n    if (rangeLabel.includes('Contact') || rangeLabel.includes('Melee') || rangeLabel.includes('Mêlée')) {\n      fieldName = 'system.meleeRange';\n    } else if (rangeLabel.includes('Courte') || rangeLabel.includes('Short')) {\n      fieldName = 'system.shortRange';\n    } else if (rangeLabel.includes('Moyenne') || rangeLabel.includes('Medium')) {\n      fieldName = 'system.mediumRange';\n    } else if (rangeLabel.includes('Longue') || rangeLabel.includes('Long')) {\n      fieldName = 'system.longRange';\n    }\n    \n    const currentValue = select.value;\n    let newValue = currentValue;\n    \n    if (isChecked) {\n      // Improve the range: none -> disadvantage, disadvantage -> ok\n      if (currentValue === 'none') {\n        newValue = 'disadvantage';\n      } else if (currentValue === 'disadvantage') {\n        newValue = 'ok';\n      }\n      // If already 'ok', keep it at 'ok'\n    } else {\n      // Downgrade the range: ok -> disadvantage, disadvantage -> none\n      if (currentValue === 'ok') {\n        newValue = 'disadvantage';\n      } else if (currentValue === 'disadvantage') {\n        newValue = 'none';\n      }\n      // If already 'none', keep it at 'none'\n    }\n    \n    // Update the disabled select for visual display\n    select.value = newValue;\n    \n    // Update the hidden input that holds the actual value\n    const hiddenInput = this.element.find(`input[name=\"${fieldName}\"]`)[0] as HTMLInputElement;\n    if (hiddenInput) {\n      hiddenInput.value = newValue;\n    }\n  }\n\n  /**\n   * Handle RR target search input\n   */\n  private rrTargetSearchTimeout: any = null;\n  \n  private async _onRRTargetSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\n    const rrIndex = parseInt(input.dataset.rrIndex || '0');\n    const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.rrTargetSearchTimeout) {\n      clearTimeout(this.rrTargetSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.rrTargetSearchTimeout = setTimeout(async () => {\n      await this._performRRTargetSearch(searchTerm, rrIndex, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual RR target search in actor items and compendiums\n   */\n  private async _performRRTargetSearch(searchTerm: string, rrIndex: number, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    const rrList = (this.item.system as any).rrList || [];\n    const rrType = rrList[rrIndex]?.rrType;\n    \n    if (!rrType || rrType === 'attribute') {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Search in actor items if this feat is on an actor\n    if (this.item.actor) {\n      for (const item of this.item.actor.items as any) {\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            source: game.i18n!.localize('SRA2.FEATS.FROM_ACTOR'),\n            type: rrType\n          });\n        }\n      }\n    }\n    \n    // Search in world items\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === rrType && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\n          // Check if not already in results\n          const exists = results.some(r => r.name === item.name);\n          if (!exists) {\n            results.push({\n              name: item.name,\n              uuid: item.uuid,\n              source: game.i18n!.localize('SRA2.SKILLS.WORLD_ITEMS'),\n              type: rrType\n            });\n          }\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for items that match the search term and type\n      for (const doc of documents) {\n        if (doc.type === rrType && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\n          // Check if not already in results\n          const exists = results.some(r => r.name === doc.name);\n          if (!exists) {\n            results.push({\n              name: doc.name,\n              uuid: doc.uuid,\n              source: pack.title,\n              type: rrType\n            });\n          }\n        }\n      }\n    }\n    \n    // Display results\n    this._displayRRTargetSearchResults(results, rrIndex, resultsDiv);\n  }\n\n  /**\n   * Display RR target search results\n   */\n  private _displayRRTargetSearchResults(results: any[], rrIndex: number, resultsDiv: HTMLElement): void {\n    let html = '';\n    \n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SKILLS.SEARCH_NO_RESULTS')}\n          </div>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const typeLabel = result.type === 'skill' \n          ? game.i18n!.localize('SRA2.FEATS.RR_TYPE.SKILL')\n          : game.i18n!.localize('SRA2.FEATS.RR_TYPE.SPECIALIZATION');\n        \n        html += `\n          <div class=\"search-result-item\" data-result-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.source} - ${typeLabel}</span>\n            </div>\n            <button class=\"add-rr-target-btn\" data-target-name=\"${result.name}\" data-rr-index=\"${rrIndex}\">\n              ${game.i18n!.localize('SRA2.FEATS.SELECT')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers to buttons\n    $(resultsDiv).find('.add-rr-target-btn').on('click', this._onSelectRRTarget.bind(this));\n    \n    // Make entire result items clickable\n    $(resultsDiv).find('.search-result-item:not(.no-results)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.add-rr-target-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.add-rr-target-btn')[0] as HTMLButtonElement;\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n  }\n\n  /**\n   * Handle selecting an RR target from search results\n   */\n  private async _onSelectRRTarget(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const targetName = button.dataset.targetName;\n    const rrIndex = parseInt(button.dataset.rrIndex || '0');\n    \n    if (!targetName) return;\n    \n    const rrList = [...((this.item.system as any).rrList || [])];\n    \n    if (rrList[rrIndex]) {\n      rrList[rrIndex] = { ...rrList[rrIndex], rrTarget: targetName };\n    }\n    \n    await this.item.update({ 'system.rrList': rrList } as any);\n    this.render(false);\n    \n    ui.notifications?.info(game.i18n!.format('SRA2.FEATS.LINKED_TO_TARGET', { name: targetName }));\n  }\n\n  /**\n   * Handle RR target search focus\n   */\n  private _onRRTargetSearchFocus(event: Event): void {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n  }\n\n  /**\n   * Handle RR target search blur\n   */\n  private _onRRTargetSearchBlur(event: Event): void {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.rr-target-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.rr-target-search');\n    return super.close(options);\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData) as any;\n    \n    // Check if isFirstFeat is being set to true for a trait\n    if (expandedData.system?.isFirstFeat === true && \n        expandedData.system?.featType === 'trait' && \n        this.item.actor) {\n      \n      // Find all other traits on the same actor that have isFirstFeat = true\n      const otherFirstFeats = this.item.actor.items.filter((item: any) => \n        item.type === 'feat' &&\n        item.id !== this.item.id &&\n        item.system?.featType === 'trait' &&\n        item.system?.isFirstFeat === true\n      );\n      \n      // If there are other traits with isFirstFeat, uncheck them\n      if (otherFirstFeats.length > 0) {\n        for (const otherFeat of otherFirstFeats) {\n          await otherFeat.update({\n            'system.isFirstFeat': false\n          } as any);\n        }\n        \n        ui.notifications?.info(\n          game.i18n!.localize('SRA2.FEATS.FIRST_FEAT_TRANSFERRED') || \n          'The \"first trait\" flag has been moved from the other trait(s) to this one.'\n        );\n      }\n    }\n    \n    // Update the item first to recalculate recommendedLevel\n    await this.item.update(expandedData);\n    \n    // Recalculate derived data to get the new recommendedLevel\n    this.item.prepareData();\n    \n    // Sync rating with recommendedLevel\n    const recommendedLevel = (this.item.system as any).recommendedLevel || 0;\n    const currentRating = (this.item.system as any).rating || 0;\n    \n    // Only update rating if it's different from recommendedLevel\n    if (currentRating !== recommendedLevel) {\n      await this.item.update({\n        'system.rating': recommendedLevel\n      } as any);\n    }\n    \n    return this.item;\n  }\n}\n\n","/**\n * Skill Sheet Application\n */\nexport class SkillSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'skill'],\n      template: 'systems/sra2/templates/item-skill-sheet.hbs',\n      width: 520,\n      height: 480,\n      tabs: [],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    return context;\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n}\n\n","import * as ItemSearch from '../helpers/item-search.js';\n\n/**\n * Specialization Sheet Application\n */\nexport class SpecializationSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'specialization'],\n      template: 'systems/sra2/templates/item-specialization-sheet.hbs',\n      width: 520,\n      height: 480,\n      tabs: [],\n      dragDrop: [\n        { dropSelector: '.linked-skill-drop-zone' }\n      ],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    \n    // Get linked skill info if exists\n    if (context.system.linkedSkill) {\n      // linkedSkill is stored as a name, so we display it directly\n      context.linkedSkillName = context.system.linkedSkill;\n      \n      // If the specialization is on an actor, check if the skill exists\n      if (this.item.actor) {\n        const linkedSkill = this.item.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === context.system.linkedSkill\n        );\n        \n        if (!linkedSkill) {\n          // Mark as warning if skill doesn't exist on this actor\n          context.linkedSkillNotFound = true;\n        }\n      }\n    }\n    \n    // Get list of skills from the actor if this item is owned (for dropdown)\n    if (this.item.actor) {\n      const skills = this.item.actor.items.filter((i: any) => i.type === 'skill');\n      context.skills = skills.map((s: any) => ({\n        name: s.name\n      }));\n    } else {\n      context.skills = [];\n    }\n    \n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    \n    // Clear linked skill button\n    html.find('[data-action=\"clear-linked-skill\"]').on('click', this._onClearLinkedSkill.bind(this));\n    \n    // Skill search\n    html.find('.skill-search-input').on('input', this._onSkillSearch.bind(this));\n    html.find('.skill-search-input').on('focus', this._onSkillSearchFocus.bind(this));\n    html.find('.skill-search-input').on('blur', this._onSkillSearchBlur.bind(this));\n    \n    // Close skill search results when clicking outside\n    $(document).on('click.skill-search-spec', (event) => {\n      const target = event.target as unknown as HTMLElement;\n      const skillSearchContainer = html.find('.skill-search-container')[0] as HTMLElement;\n      if (skillSearchContainer && !skillSearchContainer.contains(target)) {\n        html.find('.skill-search-results').hide();\n      }\n    });\n  }\n\n  override async close(options?: Application.CloseOptions): Promise<void> {\n    // Clean up document-level event listeners\n    $(document).off('click.skill-search-spec');\n    return super.close(options);\n  }\n\n  /**\n   * Handle clearing the linked skill\n   */\n  private async _onClearLinkedSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    await this.item.update({ 'system.linkedSkill': '' } as any);\n    this.render(false);\n  }\n\n  /**\n   * Handle dropping a skill onto the linked skill field\n   */\n  protected override async _onDrop(event: DragEvent): Promise<any> {\n    const data = TextEditor.getDragEventData(event) as any;\n    \n    // Handle Item drops\n    if (data && data.type === 'Item') {\n      const item = await Item.implementation.fromDropData(data) as any;\n      \n      if (!item) return super._onDrop(event);\n      \n      // Check if it's a skill\n      if (item.type === 'skill') {\n        // Store the skill name (not ID) so the specialization can be prepared in advance\n        await this.item.update({ 'system.linkedSkill': item.name } as any);\n        this.render(false);\n        ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.LINKED_TO_SKILL', { name: item.name }));\n        return;\n      } else {\n        ui.notifications?.warn(game.i18n!.localize('SRA2.SPECIALIZATIONS.ONLY_SKILLS_CAN_BE_LINKED'));\n        return;\n      }\n    }\n\n    return super._onDrop(event);\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n\n  /**\n   * SKILL SEARCH FUNCTIONS\n   */\n  \n  private skillSearchTimeout: any = null;\n  private lastSkillSearchTerm: string = '';\n  \n  /**\n   * Handle skill search input\n   */\n  private async _onSkillSearch(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const searchTerm = ItemSearch.normalizeSearchText(input.value.trim());\n    const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n    \n    // Clear previous timeout\n    if (this.skillSearchTimeout) {\n      clearTimeout(this.skillSearchTimeout);\n    }\n    \n    // If search term is empty, hide results\n    if (searchTerm.length === 0) {\n      resultsDiv.style.display = 'none';\n      return;\n    }\n    \n    // Debounce search\n    this.skillSearchTimeout = setTimeout(async () => {\n      await this._performSkillSearch(searchTerm, resultsDiv);\n    }, 300);\n  }\n\n  /**\n   * Perform the actual skill search in compendiums and world items\n   */\n  private async _performSkillSearch(searchTerm: string, resultsDiv: HTMLElement): Promise<void> {\n    const results: any[] = [];\n    \n    // Store search term for potential creation\n    this.lastSkillSearchTerm = searchTerm;\n    \n    // Search in world items first\n    if (game.items) {\n      for (const item of game.items as any) {\n        if (item.type === 'skill' && ItemSearch.normalizeSearchText(item.name).includes(searchTerm)) {\n          results.push({\n            name: item.name,\n            uuid: item.uuid,\n            pack: game.i18n!.localize('SRA2.SPECIALIZATIONS.WORLD_ITEMS'),\n            linkedAttribute: item.system.linkedAttribute,\n            isWorldItem: true\n          });\n        }\n      }\n    }\n    \n    // Search in all compendiums\n    for (const pack of game.packs as any) {\n      // Only search in Item compendiums\n      if (pack.documentName !== 'Item') continue;\n      \n      // Get all documents from the pack\n      const documents = await pack.getDocuments();\n      \n      // Filter for skills that match the search term\n      for (const doc of documents) {\n        if (doc.type === 'skill' && ItemSearch.normalizeSearchText(doc.name).includes(searchTerm)) {\n          results.push({\n            name: doc.name,\n            uuid: doc.uuid,\n            pack: pack.title,\n            linkedAttribute: doc.system.linkedAttribute,\n            isWorldItem: false\n          });\n        }\n      }\n    }\n    \n    // Display results\n    this._displaySkillSearchResults(results, resultsDiv);\n  }\n\n  /**\n   * Display skill search results\n   */\n  private _displaySkillSearchResults(results: any[], resultsDiv: HTMLElement): Promise<void> {\n    // Check if exact match exists\n    const formattedSearchTerm = this.lastSkillSearchTerm\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    const exactMatch = results.find((r: any) => \n      ItemSearch.normalizeSearchText(r.name) === ItemSearch.normalizeSearchText(this.lastSkillSearchTerm)\n    );\n    \n    let html = '';\n    \n    // If no results at all, show only the create button with message\n    if (results.length === 0) {\n      html = `\n        <div class=\"search-result-item no-results-create\">\n          <div class=\"no-results-text\">\n            ${game.i18n!.localize('SRA2.SPECIALIZATIONS.SEARCH_NO_RESULTS')}\n          </div>\n          <button class=\"create-skill-btn\" data-skill-name=\"${this.lastSkillSearchTerm}\">\n            <i class=\"fas fa-plus\"></i> ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\n          </button>\n        </div>\n      `;\n    } else {\n      // Display search results\n      for (const result of results) {\n        const attributeLabel = game.i18n!.localize(`SRA2.ATTRIBUTES.${result.linkedAttribute.toUpperCase()}`);\n        \n        html += `\n          <div class=\"search-result-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\">${result.name}</span>\n              <span class=\"result-pack\">${result.pack} - ${attributeLabel}</span>\n            </div>\n            <button class=\"link-skill-btn\" data-skill-name=\"${result.name}\">\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.LINK_SKILL')}\n            </button>\n          </div>\n        `;\n      }\n      \n      // Add create button if exact match doesn't exist\n      if (!exactMatch) {\n        html += `\n          <div class=\"search-result-item create-new-item\">\n            <div class=\"result-info\">\n              <span class=\"result-name\"><i class=\"fas fa-plus-circle\"></i> ${formattedSearchTerm}</span>\n              <span class=\"result-pack\">${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_NEW_SKILL')}</span>\n            </div>\n            <button class=\"create-skill-btn-inline\" data-skill-name=\"${this.lastSkillSearchTerm}\">\n              ${game.i18n!.localize('SRA2.SPECIALIZATIONS.CREATE_SKILL')}\n            </button>\n          </div>\n        `;\n      }\n    }\n    \n    resultsDiv.innerHTML = html;\n    resultsDiv.style.display = 'block';\n    \n    // Attach click handlers\n    $(resultsDiv).find('.link-skill-btn').on('click', this._onLinkSkillFromSearch.bind(this));\n    $(resultsDiv).find('.create-skill-btn, .create-skill-btn-inline').on('click', this._onCreateNewSkill.bind(this));\n    \n    // Make entire result items clickable (except create button)\n    $(resultsDiv).find('.search-result-item:not(.no-results-create):not(.create-new-item)').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.link-skill-btn').length > 0) return;\n      \n      // Find the button in this item and trigger its click\n      const button = $(event.currentTarget).find('.link-skill-btn')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    // Make create items clickable on the entire row\n    $(resultsDiv).find('.search-result-item.create-new-item').on('click', (event) => {\n      // Don't trigger if clicking directly on the button\n      if ($(event.target).closest('.create-skill-btn-inline').length > 0) return;\n      \n      // Find the button and trigger its click\n      const button = $(event.currentTarget).find('.create-skill-btn-inline')[0];\n      if (button) {\n        $(button).trigger('click');\n      }\n    });\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle linking a skill from search results\n   */\n  private async _onLinkSkillFromSearch(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Link the skill to the specialization\n    await this.item.update({ 'system.linkedSkill': skillName } as any);\n    \n    // Clear the search input and hide results\n    const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n    if (searchInput) {\n      searchInput.value = '';\n    }\n    \n    const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n    if (resultsDiv) {\n      resultsDiv.style.display = 'none';\n    }\n    \n    this.render(false);\n    ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_LINKED', { name: skillName }));\n  }\n\n  /**\n   * Handle skill search focus\n   */\n  private _onSkillSearchFocus(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    \n    // If there's already content and results, show them\n    if (input.value.trim().length > 0) {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv && resultsDiv.innerHTML.trim().length > 0) {\n        resultsDiv.style.display = 'block';\n      }\n    }\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle skill search blur\n   */\n  private _onSkillSearchBlur(event: Event): Promise<void> {\n    const input = event.currentTarget as HTMLInputElement;\n    const blurEvent = event as FocusEvent;\n    \n    // Check if the new focus target is within the results div\n    setTimeout(() => {\n      const resultsDiv = $(input).siblings('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        // Check if the related target (where focus is going) is inside the results div\n        const relatedTarget = blurEvent.relatedTarget as HTMLElement;\n        if (relatedTarget && resultsDiv.contains(relatedTarget)) {\n          // Don't hide if focus is moving to an element within the results\n          return;\n        }\n        \n        // Also check if any element in the results is focused\n        const activeElement = document.activeElement as HTMLElement;\n        if (activeElement && resultsDiv.contains(activeElement)) {\n          // Don't hide if an element in results is active\n          return;\n        }\n        \n        resultsDiv.style.display = 'none';\n      }\n    }, 200);\n    \n    return Promise.resolve();\n  }\n\n  /**\n   * Handle creating a new skill from search and linking it\n   */\n  private async _onCreateNewSkill(event: Event): Promise<void> {\n    event.preventDefault();\n    event.stopPropagation();\n    \n    const button = event.currentTarget as HTMLButtonElement;\n    const skillName = button.dataset.skillName;\n    \n    if (!skillName) return;\n    \n    // Capitalize first letter of each word\n    const formattedName = skillName\n      .split(' ')\n      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n      .join(' ');\n    \n    // Create the new skill as a world item with default values\n    const skillData = {\n      name: formattedName,\n      type: 'skill',\n      system: {\n        rating: 1,\n        linkedAttribute: 'strength',\n        description: ''\n      }\n    } as any;\n    \n    // Create as a world item\n    const createdItems = await Item.create(skillData) as any;\n    \n    if (createdItems) {\n      // Link the skill to the specialization\n      await this.item.update({ 'system.linkedSkill': formattedName } as any);\n      \n      // Clear the search input and hide results\n      const searchInput = this.element.find('.skill-search-input')[0] as HTMLInputElement;\n      if (searchInput) {\n        searchInput.value = '';\n      }\n      \n      const resultsDiv = this.element.find('.skill-search-results')[0] as HTMLElement;\n      if (resultsDiv) {\n        resultsDiv.style.display = 'none';\n      }\n      \n      this.render(false);\n      \n      // Open the skill sheet for editing\n      setTimeout(() => {\n        if (createdItems.sheet) {\n          createdItems.sheet.render(true);\n        }\n      }, 100);\n      \n      ui.notifications?.info(game.i18n!.format('SRA2.SPECIALIZATIONS.SKILL_CREATED_AND_LINKED', { name: formattedName }));\n    }\n  }\n}\n\n","/**\n * Metatype Sheet Application\n */\nexport class MetatypeSheet extends ItemSheet {\n  static override get defaultOptions(): DocumentSheet.Options<Item> {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'sheet', 'item', 'metatype'],\n      template: 'systems/sra2/templates/item-metatype-sheet.hbs',\n      width: 520,\n      height: 580,\n      tabs: [],\n      submitOnChange: true,\n    });\n  }\n\n  override getData(): any {\n    const context = super.getData() as any;\n    context.system = this.item.system;\n    return context;\n  }\n\n  protected override async _updateObject(_event: Event, formData: any): Promise<any> {\n    const expandedData = foundry.utils.expandObject(formData);\n    return this.item.update(expandedData);\n  }\n}\n\n","import { RollRequestData } from '../helpers/dice-roller.js';\nimport * as SheetHelpers from '../helpers/sheet-helpers.js';\nimport { WEAPON_TYPES } from '../models/item-feat.js';\n\n/**\n * Roll Dialog Application\n * Displays roll information in a popup dialog\n */\nexport class RollDialog extends Application {\n  private rollData: RollRequestData;\n  private actor: any = null;\n  private attackerToken: any = null;\n  private targetToken: any = null;\n  private rrEnabled: Map<string, boolean> = new Map(); // Track which RR sources are enabled\n  private riskDiceCount: number = 2; // Number of risk dice selected (default: 2)\n  private selectedRange: string | null = null; // Selected range: 'melee', 'short', 'medium', 'long'\n  private rollMode: 'normal' | 'disadvantage' | 'advantage' = 'normal'; // Roll mode\n\n  constructor(rollData: RollRequestData) {\n    super();\n    this.rollData = rollData;\n    \n    // Get actor from roll data\n    if (rollData.actorUuid) {\n      this.actor = (fromUuidSync as any)(rollData.actorUuid);\n    } else if (rollData.actorId) {\n      this.actor = game.actors?.get(rollData.actorId) || null;\n    }\n    \n    // Get attacker token (priority: rollData.attackerTokenUuid > canvas search)\n    if (rollData.attackerTokenUuid) {\n      try {\n        this.attackerToken = (foundry.utils as any)?.fromUuidSync?.(rollData.attackerTokenUuid) || null;\n        console.log('RollDialog: Attacker token loaded from UUID:', rollData.attackerTokenUuid);\n      } catch (e) {\n        console.warn('RollDialog: Failed to load attacker token from UUID:', e);\n      }\n    }\n    \n    // If no attacker token from UUID, try to find it on canvas\n    if (!this.attackerToken && this.actor) {\n      this.attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\n      }) || null;\n      if (this.attackerToken) {\n        console.log('RollDialog: Attacker token found on canvas');\n      }\n    }\n    \n    // Get target token (first targeted token)\n    const targets = Array.from(game.user?.targets || []);\n    if (targets.length > 0) {\n      this.targetToken = targets[0] || null;\n    }\n    \n    // Also try to get defender token from rollData.defenderTokenUuid if available\n    // Priority: rollData.defenderTokenUuid > selected targets\n    if (rollData.defenderTokenUuid) {\n      try {\n        const defenderTokenFromUuid = (foundry.utils as any)?.fromUuidSync?.(rollData.defenderTokenUuid) || null;\n        if (defenderTokenFromUuid) {\n          this.targetToken = defenderTokenFromUuid;\n          console.log('RollDialog: Defender token loaded from UUID:', rollData.defenderTokenUuid);\n          console.log('RollDialog: Defender token name:', (defenderTokenFromUuid as any)?.name || (defenderTokenFromUuid as any)?.document?.name || (defenderTokenFromUuid as any)?.actor?.name);\n        }\n      } catch (e) {\n        console.warn('RollDialog: Failed to load defender token from UUID:', e);\n      }\n    }\n    \n    // If still no target token, try to find it on canvas based on defender info\n    if (!this.targetToken && rollData.defenderTokenUuid) {\n      // Try to find on canvas as fallback\n      this.targetToken = canvas?.tokens?.placeables?.find((token: any) => {\n        return token.uuid === rollData.defenderTokenUuid || \n               token.document?.uuid === rollData.defenderTokenUuid;\n      }) || null;\n    }\n    \n    // Auto-select best weapon for counter-attack\n    if (rollData.isCounterAttack && rollData.availableWeapons && rollData.availableWeapons.length > 0 && this.actor) {\n      this.autoSelectWeaponForCounterAttack();\n    }\n  }\n\n  /**\n   * Auto-select the best weapon for counter-attack\n   * Priority: 1) Weapon with highest damage value, 2) Combat rapproché skill\n   */\n  private autoSelectWeaponForCounterAttack(): void {\n    if (!this.rollData.availableWeapons || !this.actor) return;\n    \n    // Find weapon with highest damage value\n    let bestWeapon: any = null;\n    let highestDamage = -1;\n    \n    for (const weapon of this.rollData.availableWeapons) {\n      const damageValueStr = weapon.damageValue || '0';\n      let damageValue = 0;\n      \n      // Parse damage value (handle FOR, FOR+X, or numeric)\n      if (damageValueStr === 'FOR') {\n        damageValue = (this.actor.system as any)?.attributes?.strength || 1;\n      } else if (damageValueStr.startsWith('FOR+')) {\n        const bonus = parseInt(damageValueStr.substring(4)) || 0;\n        damageValue = ((this.actor.system as any)?.attributes?.strength || 1) + bonus;\n      } else {\n        damageValue = parseInt(damageValueStr, 10) || 0;\n      }\n      \n      // Add bonus\n      damageValue += weapon.damageValueBonus || 0;\n      \n      if (damageValue > highestDamage) {\n        highestDamage = damageValue;\n        bestWeapon = weapon;\n      }\n    }\n    \n    // If we found a weapon with damage, select it\n    if (bestWeapon && highestDamage > 0) {\n      this.selectWeaponForCounterAttack(bestWeapon.id);\n    } else {\n      // Otherwise, select \"Combat rapproché\" skill\n      this.selectCombatRapprocheSkill();\n    }\n  }\n  \n  /**\n   * Select a specific weapon for counter-attack\n   */\n  private selectWeaponForCounterAttack(weaponId: string): void {\n    if (!this.rollData.availableWeapons || !this.actor) return;\n    \n    const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\n    if (!selectedWeapon) return;\n    \n    // Get the actual weapon item\n    const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\n    const weaponSystem = actualWeapon?.system as any;\n    \n    // Get weapon type data from WEAPON_TYPES if available\n    const wepTypeName = weaponSystem?.weaponType;\n    const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\n    \n    // Get linkedAttackSkill and linkedAttackSpecialization\n    let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\n    const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\n    \n    const damageValue = selectedWeapon.damageValue;\n    const damageValueBonus = selectedWeapon.damageValueBonus || 0;\n    \n    // Default to \"Combat rapproché\" if no skill found\n    if (!baseSkillName) {\n      baseSkillName = 'Combat rapproché';\n    }\n    \n    // Find the linked skill in actor's items\n    const linkedSkillItem = this.actor.items.find((item: any) => \n      item.type === 'skill' && item.name === baseSkillName\n    );\n    \n    // Find specializations for the linked skill\n    const linkedSpecs = this.actor.items.filter((item: any) => \n      item.type === 'specialization' && \n      item.system.linkedSkill === baseSkillName\n    );\n    \n    // Check if weapon has a specialization and if actor has that specialization\n    let preferredSpecName: string | undefined = undefined;\n    if (weaponLinkedSpecialization) {\n      const specExists = linkedSpecs.find((spec: any) => \n        spec.name === weaponLinkedSpecialization\n      );\n      if (specExists) {\n        preferredSpecName = weaponLinkedSpecialization;\n      }\n    }\n    \n    // Calculate skill level and linked attribute\n    let skillLevel: number | undefined = undefined;\n    let specLevel: number | undefined = undefined;\n    let linkedAttribute: string | undefined = undefined;\n    let skillName: string | undefined = baseSkillName;\n    let specName: string | undefined = undefined;\n    \n    if (linkedSkillItem) {\n      const skillSystem = linkedSkillItem.system as any;\n      const skillRating = skillSystem.rating || 0;\n      linkedAttribute = skillSystem.linkedAttribute || 'strength';\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\n      \n      skillLevel = attributeValue + skillRating;\n    }\n    \n    // Get RR sources\n    let rrList: any[] = [];\n    \n    // Get RR from weapon itself\n    const weaponRRList = weaponSystem?.rrList || [];\n    const itemRRList = weaponRRList.map((rrEntry: any) => ({\n      ...rrEntry,\n      featName: selectedWeapon.name\n    }));\n    \n    let skillSpecRRList: any[] = [];\n    \n    if (preferredSpecName) {\n      // Use specialization\n      specName = preferredSpecName;\n      const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\n      const parentSkill = linkedSkillItem;\n      const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\n      specLevel = attributeValue + skillRating + 2;\n      \n      const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\n      const skillRRSources = linkedSkillItem ? SheetHelpers.getRRSources(this.actor, 'skill', baseSkillName) : [];\n      const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\n      \n      skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\n    } else {\n      // Use skill\n      if (skillName) {\n        const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\n        const attributeRRSources = linkedAttribute ? SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute) : [];\n        \n        skillSpecRRList = [...skillRRSources, ...attributeRRSources];\n      }\n    }\n    \n    // Merge weapon RR with skill/spec/attribute RR\n    rrList = [...itemRRList, ...skillSpecRRList];\n    \n    // Get weapon ranges\n    const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\n    const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\n    const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\n    const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\n    \n    // Update roll data\n    this.rollData.skillName = skillName;\n    this.rollData.specName = specName;\n    this.rollData.linkedAttackSkill = baseSkillName;\n    this.rollData.linkedAttribute = linkedAttribute;\n    this.rollData.skillLevel = skillLevel;\n    this.rollData.specLevel = specLevel;\n    this.rollData.itemName = selectedWeapon.name;\n    this.rollData.itemType = 'weapon';\n    this.rollData.damageValue = damageValue;\n    this.rollData.damageValueBonus = damageValueBonus;\n    this.rollData.rrList = rrList;\n    this.rollData.selectedWeaponId = weaponId;\n    this.rollData.meleeRange = meleeRange;\n    this.rollData.shortRange = shortRange;\n    this.rollData.mediumRange = mediumRange;\n    this.rollData.longRange = longRange;\n    this.rollData.weaponType = wepTypeName;\n  }\n  \n  /**\n   * Select Combat rapproché skill for counter-attack\n   */\n  private selectCombatRapprocheSkill(): void {\n    if (!this.actor) return;\n    \n    const combatRapprocheSkill = this.actor.items.find((item: any) => \n      item.type === 'skill' && item.name === 'Combat rapproché'\n    );\n    \n    if (!combatRapprocheSkill) return;\n    \n    const skillSystem = combatRapprocheSkill.system as any;\n    const skillRating = skillSystem.rating || 0;\n    const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n    const attributeValue = (this.actor.system as any)?.attributes?.[linkedAttribute] || 0;\n    const skillLevel = attributeValue + skillRating;\n    \n    // Get RR sources\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', 'Combat rapproché');\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\n    const rrList = [...skillRRSources, ...attributeRRSources];\n    \n    // Update roll data\n    this.rollData.skillName = 'Combat rapproché';\n    this.rollData.specName = undefined;\n    this.rollData.linkedAttackSkill = 'Combat rapproché';\n    this.rollData.linkedAttribute = linkedAttribute;\n    this.rollData.skillLevel = skillLevel;\n    this.rollData.specLevel = undefined;\n    this.rollData.itemName = undefined;\n    this.rollData.itemType = undefined;\n    this.rollData.damageValue = 'FOR'; // Bare hands damage\n    this.rollData.damageValueBonus = 0;\n    this.rollData.rrList = rrList;\n    this.rollData.selectedWeaponId = undefined;\n  }\n\n  static override get defaultOptions(): any {\n    return foundry.utils.mergeObject(super.defaultOptions, {\n      classes: ['sra2', 'roll-dialog'],\n      template: 'systems/sra2/templates/roll-dialog.hbs',\n      width: 760,\n      height: 575,\n      resizable: true,\n      minimizable: false,\n      title: 'Jet de Dés'\n    });\n  }\n\n  override getData(): any {\n    const context: any = {\n      rollData: this.rollData,\n      actor: this.actor,\n      targetToken: this.targetToken\n    };\n\n    // Calculate distance between protagonist and target\n    let distance: number | null = null;\n    let distanceText: string = '';\n    \n    if (this.actor && this.targetToken && canvas?.grid) {\n      // Get protagonist token\n      const protagonistToken = canvas?.tokens?.placeables?.find((token: any) => {\n        return token.actor?.id === this.actor.id || token.actor?.uuid === this.actor.uuid;\n      });\n      \n      if (protagonistToken && this.targetToken) {\n        try {\n          // Calculate distance using Foundry's grid measurement\n          const grid = canvas.grid as any;\n          const distancePixels = grid.measureDistance(\n            { x: protagonistToken.x, y: protagonistToken.y },\n            { x: this.targetToken.x, y: this.targetToken.y },\n            { gridSpaces: true }\n          );\n          \n          if (typeof distancePixels === 'number' && !isNaN(distancePixels)) {\n            distance = Math.round(distancePixels * 10) / 10; // Round to 1 decimal\n            \n            // Get grid units from scene\n            const scene = canvas?.scene;\n            const gridUnits = (scene?.grid as any)?.units || 'm';\n            distanceText = `${distance} ${gridUnits}`;\n          }\n        } catch (e) {\n          // Fallback: calculate euclidean distance\n          const dx = this.targetToken.x - protagonistToken.x;\n          const dy = this.targetToken.y - protagonistToken.y;\n          const pixelDistance = Math.sqrt(dx * dx + dy * dy);\n          const gridSize = (canvas.grid as any)?.size || 1;\n          const gridDistance = pixelDistance / gridSize;\n          distance = Math.round(gridDistance * 10) / 10;\n          \n          const scene = canvas?.scene;\n          const gridUnits = (scene?.grid as any)?.units || 'm';\n          distanceText = `${distance} ${gridUnits}`;\n        }\n      }\n    }\n    \n    context.distance = distance;\n    context.distanceText = distanceText;\n\n    // Calculate range based on distance for default selection (only if not already selected by user)\n    let calculatedRange: string | null = null;\n    \n    // Calculate what range should be based on distance (for display purposes)\n    if (distance !== null) {\n      if (distance < 3) {\n        calculatedRange = 'melee';\n      } else if (distance >= 3 && distance <= 15) {\n        calculatedRange = 'short';\n      } else if (distance > 15 && distance <= 60) {\n        calculatedRange = 'medium';\n      } else if (distance > 60) {\n        calculatedRange = 'long';\n      }\n    }\n\n    // Only set default range if user hasn't selected one yet\n    if (this.selectedRange === null) {\n      // For counter-attacks, always default to melee range\n      if (this.rollData.isCounterAttack) {\n        this.selectedRange = 'melee';\n      } else if (calculatedRange !== null) {\n        // For other cases, use calculated range based on distance\n      this.selectedRange = calculatedRange;\n    }\n    }\n    // If selectedRange is already set, don't change it (user selection is preserved)\n\n    // Get weapon range properties\n    const meleeRange = this.rollData.meleeRange || 'none';\n    const shortRange = this.rollData.shortRange || 'none';\n    const mediumRange = this.rollData.mediumRange || 'none';\n    const longRange = this.rollData.longRange || 'none';\n\n    // Check if this is a weapon roll (has range properties)\n    const isWeaponRoll = this.rollData.itemType === 'weapon' || \n                         this.rollData.weaponType !== undefined ||\n                         (meleeRange !== 'none' || shortRange !== 'none' || mediumRange !== 'none' || longRange !== 'none');\n\n    // Get range value for selected range\n    let selectedRangeValue: string | null = null;\n    if (this.selectedRange === 'melee') {\n      selectedRangeValue = meleeRange;\n    } else if (this.selectedRange === 'short') {\n      selectedRangeValue = shortRange;\n    } else if (this.selectedRange === 'medium') {\n      selectedRangeValue = mediumRange;\n    } else if (this.selectedRange === 'long') {\n      selectedRangeValue = longRange;\n    }\n\n    // Determine roll mode based on range value (but allow user to override)\n    if (selectedRangeValue === 'disadvantage') {\n      this.rollMode = 'disadvantage';\n    } else if (selectedRangeValue === 'ok') {\n      this.rollMode = 'normal';\n    }\n    // Allow selection even if range is 'none' - user can still roll\n\n    // Check if actor has severe wound - force disadvantage mode\n    let hasSevereWound = false;\n    if (this.actor) {\n      const actorSystem = this.actor.system as any;\n      if (actorSystem.damage && actorSystem.damage.severe) {\n        // Check if at least one severe wound is marked (true)\n        hasSevereWound = Array.isArray(actorSystem.damage.severe) && \n                         actorSystem.damage.severe.some((wound: boolean) => wound === true);\n      }\n    }\n    \n    // Force disadvantage mode if actor has severe wound\n    if (hasSevereWound) {\n      this.rollMode = 'disadvantage';\n    }\n\n    context.isWeaponRoll = isWeaponRoll;\n    context.calculatedRange = calculatedRange;\n    context.selectedRange = this.selectedRange;\n    context.selectedRangeValue = selectedRangeValue;\n    context.rollMode = this.rollMode;\n    context.hasSevereWound = hasSevereWound; // Pass to template to disable mode selection\n    context.rangeOptions = {\n      melee: { label: 'Mêlée (< 3m)', value: meleeRange },\n      short: { label: 'Portée courte (3-15m)', value: shortRange },\n      medium: { label: 'Portée moyenne (15-60m)', value: mediumRange },\n      long: { label: 'Portée longue (> 60m)', value: longRange }\n    };\n\n    // Calculate dice pool\n    let dicePool = 0;\n    if (this.rollData.specLevel !== undefined) {\n      dicePool = this.rollData.specLevel;\n    } else if (this.rollData.skillLevel !== undefined) {\n      dicePool = this.rollData.skillLevel;\n    } else if (this.rollData.linkedAttribute) {\n      const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\n      dicePool = attributeValue;\n    }\n    context.dicePool = dicePool;\n\n    let threshold = this.rollData.threshold;\n    context.threshold = threshold;\n    context.hasThreshold = threshold !== undefined;\n\n    // Get skill/spec name\n    context.skillDisplayName = this.rollData.specName || this.rollData.skillName || this.rollData.linkedAttackSkill || 'Aucune';\n\n    // Calculate total RR and get RR sources\n    // For defense rolls, always recalculate rrList from defender's skill/spec to ensure we use the correct actor\n    // For attack rolls, use rollData.rrList as passed from character-sheet/npc-sheet (already merged: item RR + skill/spec/attribute RR)\n    // rrList already contains RRSource objects with featName and rrValue (enriched before passing to handleRollRequest)\n    \n    // For defense rolls, always recalculate rrList from this.actor (the defender) to ensure correctness\n    if (this.rollData.isDefend && this.actor) {\n      const { getRRSources } = SheetHelpers;\n      let defenseRRList: any[] = [];\n      \n      if (this.rollData.specName) {\n        const rrSources = getRRSources(this.actor, 'specialization', this.rollData.specName);\n        defenseRRList = rrSources.map((rr: any) => ({\n          ...rr,\n          featName: rr.featName\n        }));\n      } else if (this.rollData.skillName) {\n        const rrSources = getRRSources(this.actor, 'skill', this.rollData.skillName);\n        defenseRRList = rrSources.map((rr: any) => ({\n          ...rr,\n          featName: rr.featName\n        }));\n      }\n      \n      // Also add attribute RR if linkedAttribute is set\n      if (this.rollData.linkedAttribute) {\n        const attributeRRSources = getRRSources(this.actor, 'attribute', this.rollData.linkedAttribute);\n        const attributeRRList = attributeRRSources.map((rr: any) => ({\n          ...rr,\n          featName: rr.featName\n        }));\n        defenseRRList = [...defenseRRList, ...attributeRRList];\n      }\n      \n      // Always update rollData with correct rrList from defender\n      this.rollData.rrList = defenseRRList;\n    }\n    // For attack rolls (not defense), use rollData.rrList as is (already merged in character-sheet.ts/npc-sheet.ts)\n    // The rrList should already contain: item RR + skill/spec/attribute RR\n    // No need to recalculate here, it's already correct from the sheet\n    \n    let totalRR = 0;\n    const rrSources: any[] = [];\n    if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\n      for (const rrSource of this.rollData.rrList) {\n        if (rrSource && typeof rrSource === 'object') {\n          const rrValue = rrSource.rrValue || 0;\n          if (rrValue > 0) {\n            // featName is now always present in rrList (enriched in character-sheet.ts and npc-sheet.ts)\n            const featName = rrSource.featName || 'Inconnu';\n            const rrId = `${featName}-${rrValue}`;\n            \n            // Initialize as enabled if not already set\n            if (!this.rrEnabled.has(rrId)) {\n              this.rrEnabled.set(rrId, true);\n            }\n            \n            const isEnabled = this.rrEnabled.get(rrId) || false;\n            \n            rrSources.push({\n              id: rrId,\n              featName: featName,\n              rrValue: rrValue,\n              enabled: isEnabled\n            });\n            \n            if (isEnabled) {\n              totalRR += rrValue;\n            }\n          }\n        }\n      }\n    }\n    context.totalRR = Math.min(3, totalRR); // RR is capped at 3\n    context.rrSources = rrSources;\n\n    // Get VD (Valeur de Défense) - this would be from the target or weapon\n    // For now, we'll show weapon VD if available\n    context.vd = this.rollData.damageValue || 0;\n\n    // Function to determine dice color based on RR and position\n    const getDiceColor = (dicePosition: number, rr: number): string => {\n      // dicePosition is 1-indexed (first die is position 1)\n      if (rr === 0) {\n        if (dicePosition === 1) return 'green';\n        if (dicePosition >= 2 && dicePosition <= 3) return 'yellow';\n        if (dicePosition >= 4 && dicePosition <= 5) return 'orange';\n        return 'red';\n      } else if (rr === 1) {\n        if (dicePosition >= 1 && dicePosition <= 4) return 'green';\n        if (dicePosition >= 5 && dicePosition <= 6) return 'yellow';\n        if (dicePosition >= 7 && dicePosition <= 9) return 'orange';\n        return 'red';\n      } else if (rr === 2) {\n        if (dicePosition >= 1 && dicePosition <= 7) return 'green';\n        if (dicePosition >= 8 && dicePosition <= 9) return 'yellow';\n        if (dicePosition >= 10 && dicePosition <= 12) return 'orange';\n        return 'red';\n      } else if (rr === 3) {\n        if (dicePosition >= 1 && dicePosition <= 10) return 'green';\n        if (dicePosition >= 11 && dicePosition <= 12) return 'yellow';\n        if (dicePosition >= 13 && dicePosition <= 16) return 'orange';\n        return 'red';\n      }\n      // Default to green if RR is invalid\n      return 'green';\n    };\n    \n    // Generate dice list for visual display with selection state and risk color\n    context.diceList = [];\n    const currentRR = Math.min(3, totalRR); // Use the calculated RR\n    for (let i = 0; i < dicePool; i++) {\n      const dicePosition = i + 1; // 1-indexed position\n      const riskColor = getDiceColor(dicePosition, currentRR);\n      context.diceList.push({ \n        index: i,\n        isRiskDice: i < this.riskDiceCount,  // First N dice are risk dice\n        riskColor: riskColor  // Color based on RR and position\n      });\n    }\n    context.riskDiceCount = this.riskDiceCount;\n\n    // Get all skills and specializations from actor, organized hierarchically\n    if (this.actor) {\n      const skills = this.actor.items\n        .filter((item: any) => item.type === 'skill')\n        .map((skill: any) => {\n          const linkedAttribute = skill.system?.linkedAttribute || 'strength';\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\n          const skillRating = skill.system?.rating || 0;\n          return {\n            id: skill.id,\n            name: skill.name,\n            rating: skillRating,\n            linkedAttribute: linkedAttribute,\n            dicePool: attributeValue + skillRating,\n            type: 'skill',\n            specializations: [] as any[]\n          };\n        })\n        .sort((a: any, b: any) => a.name.localeCompare(b.name));\n\n      // Get all specializations and group them under their parent skills\n      const allSpecializations = this.actor.items\n        .filter((item: any) => item.type === 'specialization')\n        .map((spec: any) => {\n          const linkedAttribute = spec.system?.linkedAttribute || 'strength';\n          const linkedSkillName = spec.system?.linkedSkill;\n          const attributeValue = (this.actor?.system as any)?.attributes?.[linkedAttribute] || 0;\n          \n          // Find parent skill\n          const parentSkill = this.actor!.items.find((i: any) => \n            i.type === 'skill' && i.name === linkedSkillName\n          );\n          const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\n          const effectiveRating = skillRating + 2; // +2 from specialization\n          \n          return {\n            id: spec.id,\n            name: spec.name,\n            rating: effectiveRating,\n            linkedAttribute: linkedAttribute,\n            dicePool: attributeValue + effectiveRating,\n            type: 'specialization',\n            linkedSkillName: linkedSkillName\n          };\n        });\n\n      // Group specializations under their parent skills\n      for (const spec of allSpecializations) {\n        const parentSkill = skills.find((s: any) => s.name === spec.linkedSkillName);\n        if (parentSkill) {\n          parentSkill.specializations.push(spec);\n        }\n      }\n\n      // Sort specializations within each skill\n      for (const skill of skills) {\n        skill.specializations.sort((a: any, b: any) => a.name.localeCompare(b.name));\n      }\n\n      // Create flat list for dropdown (skill first, then its specializations)\n      const dropdownOptions: any[] = [];\n      for (const skill of skills) {\n        // Add skill option\n        const skillSelected = skill.name === this.rollData.skillName || \n                             (this.rollData.linkedAttackSkill && skill.name === this.rollData.linkedAttackSkill);\n        dropdownOptions.push({\n          value: `skill:${skill.id}`,\n          label: `${skill.name} (${skill.dicePool} dés)`,\n          type: 'skill',\n          id: skill.id,\n          name: skill.name,\n          dicePool: skill.dicePool,\n          linkedAttribute: skill.linkedAttribute,\n          rating: skill.rating,\n          isSelected: skillSelected && !this.rollData.specName\n        });\n\n        // Add specializations under this skill\n        for (const spec of skill.specializations) {\n          const specSelected = spec.name === this.rollData.specName ||\n                              (this.rollData.linkedAttackSpecialization && spec.name === this.rollData.linkedAttackSpecialization);\n          dropdownOptions.push({\n            value: `spec:${spec.id}`,\n            label: `  └ ${spec.name} (${spec.dicePool} dés)`,\n            type: 'specialization',\n            id: spec.id,\n            name: spec.name,\n            dicePool: spec.dicePool,\n            linkedAttribute: spec.linkedAttribute,\n            linkedSkillName: spec.linkedSkillName,\n            rating: spec.rating,\n            isSelected: specSelected\n          });\n        }\n      }\n\n      context.skillsWithSpecs = skills;\n      context.dropdownOptions = dropdownOptions;\n      \n      // Determine selected value for dropdown\n      if (this.rollData.specName) {\n        const selectedSpec = dropdownOptions.find((opt: any) => opt.type === 'specialization' && opt.name === this.rollData.specName);\n        context.selectedValue = selectedSpec ? selectedSpec.value : '';\n      } else if (this.rollData.skillName) {\n        const selectedSkill = dropdownOptions.find((opt: any) => opt.type === 'skill' && opt.name === this.rollData.skillName);\n        context.selectedValue = selectedSkill ? selectedSkill.value : '';\n      } else {\n        context.selectedValue = '';\n      }\n    }\n\n    return context;\n  }\n\n  override activateListeners(html: JQuery): void {\n    super.activateListeners(html);\n    \n    // Close button\n    html.find('.close-button').on('click', () => {\n      this.close();\n    });\n\n    // Weapon selection for counter-attack\n    html.find('.weapon-select').on('change', async (event) => {\n      const select = event.currentTarget as HTMLSelectElement;\n      const weaponId = select.value;\n      \n      if (!weaponId || !this.rollData.availableWeapons || !this.actor) return;\n      \n      const selectedWeapon = this.rollData.availableWeapons.find((w: any) => w.id === weaponId);\n      if (!selectedWeapon) return;\n\n      // Get the actual weapon item to check its linkedAttackSkill and linkedAttackSpecialization\n      const actualWeapon = this.actor.items.find((item: any) => item.id === weaponId);\n      const weaponSystem = actualWeapon?.system as any;\n      \n      // Get weapon type data from WEAPON_TYPES if available\n      const wepTypeName = weaponSystem?.weaponType;\n      const wepTypeData = wepTypeName ? WEAPON_TYPES[wepTypeName as keyof typeof WEAPON_TYPES] : undefined;\n      \n      // Get linkedAttackSkill and linkedAttackSpecialization from weapon, fallback to weapon type\n      let baseSkillName = weaponSystem?.linkedAttackSkill || wepTypeData?.linkedSkill || selectedWeapon.linkedAttackSkill;\n      const weaponLinkedSpecialization = weaponSystem?.linkedAttackSpecialization || wepTypeData?.linkedSpecialization;\n      \n      const damageValue = selectedWeapon.damageValue;\n      const damageValueBonus = selectedWeapon.damageValueBonus || 0;\n\n      // Default to \"Combat rapproché\" if no skill found\n      if (!baseSkillName) {\n        baseSkillName = 'Combat rapproché';\n      }\n\n      // Find the linked skill in actor's items\n      const linkedSkillItem = this.actor.items.find((item: any) => \n        item.type === 'skill' && item.name === baseSkillName\n      );\n\n      // Find specializations for the linked skill\n      const linkedSpecs = this.actor.items.filter((item: any) => \n        item.type === 'specialization' && \n        item.system.linkedSkill === baseSkillName\n      );\n      \n      // Check if weapon has a specialization and if actor has that specialization\n      let preferredSpecName: string | undefined = undefined;\n      if (weaponLinkedSpecialization) {\n        const specExists = linkedSpecs.find((spec: any) => \n          spec.name === weaponLinkedSpecialization\n        );\n        if (specExists) {\n          preferredSpecName = weaponLinkedSpecialization;\n        }\n      }\n\n      // Calculate skill level and linked attribute\n      let skillLevel: number | undefined = undefined;\n      let specLevel: number | undefined = undefined;\n      let linkedAttribute: string | undefined = undefined;\n      let skillName: string | undefined = baseSkillName;\n      let specName: string | undefined = undefined;\n\n      if (linkedSkillItem) {\n        const skillSystem = linkedSkillItem.system as any;\n        const skillRating = skillSystem.rating || 0;\n        linkedAttribute = skillSystem.linkedAttribute || 'strength';\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\n        \n        skillLevel = attributeValue + skillRating;\n      }\n\n      // Get RR sources (weapon RR + skill/spec/attribute RR)\n      const { getRRSources } = await import('../helpers/sheet-helpers.js');\n      \n      // Get RR from weapon itself\n      const weaponRRList = weaponSystem?.rrList || [];\n      const itemRRList = weaponRRList.map((rrEntry: any) => ({\n        ...rrEntry,\n        featName: selectedWeapon.name\n      }));\n      \n      let skillSpecRRList: any[] = [];\n      \n      // Simple logic: if weapon has a specialization and actor has it, use it\n      // Otherwise, use the skill\n      if (preferredSpecName) {\n        // Weapon has a specialization and actor has it - use the specialization\n        specName = preferredSpecName;\n        const attributeValue = linkedAttribute ? ((this.actor.system as any)?.attributes?.[linkedAttribute] || 0) : 0;\n        const parentSkill = linkedSkillItem;\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\n        specLevel = attributeValue + skillRating + 2;\n        \n        const specRRSources = getRRSources(this.actor, 'specialization', specName);\n        const skillRRSources = linkedSkillItem ? getRRSources(this.actor, 'skill', baseSkillName) : [];\n        const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\n        \n        skillSpecRRList = [...specRRSources, ...skillRRSources, ...attributeRRSources];\n      } else {\n        // Use skill (no specialization or actor doesn't have the specialization)\n        if (skillName) {\n          const skillRRSources = getRRSources(this.actor, 'skill', skillName);\n          const attributeRRSources = linkedAttribute ? getRRSources(this.actor, 'attribute', linkedAttribute) : [];\n          \n          skillSpecRRList = [...skillRRSources, ...attributeRRSources];\n        }\n      }\n      \n      // Merge weapon RR with skill/spec/attribute RR\n      const rrList = [...itemRRList, ...skillSpecRRList];\n\n      // Get weapon ranges from selected weapon or weapon type\n      // Use the same wepTypeName and wepTypeData from above\n      const meleeRange = (selectedWeapon as any).meleeRange || weaponSystem?.meleeRange || wepTypeData?.melee || 'none';\n      const shortRange = (selectedWeapon as any).shortRange || weaponSystem?.shortRange || wepTypeData?.short || 'none';\n      const mediumRange = (selectedWeapon as any).mediumRange || weaponSystem?.mediumRange || wepTypeData?.medium || 'none';\n      const longRange = (selectedWeapon as any).longRange || weaponSystem?.longRange || wepTypeData?.long || 'none';\n      \n      // Update roll data with weapon information\n      this.rollData.skillName = skillName;\n      this.rollData.specName = specName;\n      this.rollData.linkedAttackSkill = baseSkillName;\n      this.rollData.linkedAttribute = linkedAttribute;\n      this.rollData.skillLevel = skillLevel;\n      this.rollData.specLevel = specLevel;\n      this.rollData.itemName = selectedWeapon.name;\n      this.rollData.itemType = 'weapon';\n      this.rollData.damageValue = damageValue;\n      this.rollData.damageValueBonus = damageValueBonus;\n      this.rollData.rrList = rrList;\n      this.rollData.selectedWeaponId = weaponId; // Store selected weapon ID for template\n      \n      // Update weapon ranges\n      this.rollData.meleeRange = meleeRange;\n      this.rollData.shortRange = shortRange;\n      this.rollData.mediumRange = mediumRange;\n      this.rollData.longRange = longRange;\n      this.rollData.weaponType = wepTypeName;\n\n      // Re-render to update the UI\n      this.render();\n    });\n\n    // Skill/Spec selection dropdown (only if no threshold)\n    html.find('.skill-dropdown').on('change', (event) => {\n      const select = event.currentTarget as HTMLSelectElement;\n      \n      // Don't allow changes if threshold is set\n      if (this.rollData.threshold !== undefined) {\n        return;\n      }\n      \n      const value = select.value;\n      \n      if (!value || !this.actor) return;\n\n      const [type, id] = value.split(':');\n      if (!type || !id) return;\n\n      const item = this.actor.items.get(id);\n      if (!item) return;\n\n      if (type === 'skill') {\n        const skillSystem = item.system as any;\n        const linkedAttribute = skillSystem.linkedAttribute || 'strength';\n        const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n        const skillRating = skillSystem.rating || 0;\n        const dicePool = attributeValue + skillRating;\n        \n        // Update roll data\n        this.rollData.skillName = item.name;\n        this.rollData.specName = undefined;\n        this.rollData.skillLevel = dicePool;\n        this.rollData.specLevel = undefined;\n        this.rollData.linkedAttribute = linkedAttribute;\n        \n        // Recalculate RR and threshold (synchronously)\n        this.updateRRForSkill(item.name, linkedAttribute, dicePool);\n        \n        // Re-render after RR is updated\n        this.render();\n      } else if (type === 'spec') {\n        const specSystem = item.system as any;\n        const linkedAttribute = specSystem.linkedAttribute || 'strength';\n        const linkedSkillName = specSystem.linkedSkill;\n        const attributeValue = (this.actor.system as any).attributes?.[linkedAttribute] || 0;\n        \n        // Find parent skill\n        const parentSkill = this.actor.items.find((i: any) => \n          i.type === 'skill' && i.name === linkedSkillName\n        );\n        const skillRating = parentSkill ? (parentSkill.system as any).rating || 0 : 0;\n        const effectiveRating = skillRating + 2;\n        const dicePool = attributeValue + effectiveRating;\n        \n        // Update roll data\n        this.rollData.specName = item.name;\n        this.rollData.skillName = linkedSkillName;\n        this.rollData.skillLevel = skillRating;\n        this.rollData.specLevel = dicePool;\n        this.rollData.linkedAttribute = linkedAttribute;\n        \n        // Recalculate RR and threshold (synchronously)\n        this.updateRRForSpec(item.name, linkedSkillName, linkedAttribute, dicePool);\n        \n        // Re-render after RR is updated\n        this.render();\n      }\n    });\n\n    // RR checkbox toggles\n    html.find('.rr-checkbox').on('change', (event) => {\n      const checkbox = event.currentTarget as HTMLInputElement;\n      const rrId = checkbox.dataset.rrId;\n      const enabled = checkbox.checked;\n      \n      if (rrId) {\n        this.rrEnabled.set(rrId, enabled);\n        // Re-render to update total RR\n        this.render();\n      }\n    });\n\n    // Range selection\n    html.find('.range-dropdown').on('change', (event) => {\n      const select = event.currentTarget as HTMLSelectElement;\n      const rangeValue = select.value;\n      \n      this.selectedRange = rangeValue || null;\n      \n      // Update roll mode based on range value\n      if (this.selectedRange) {\n        const meleeRange = this.rollData.meleeRange || 'none';\n        const shortRange = this.rollData.shortRange || 'none';\n        const mediumRange = this.rollData.mediumRange || 'none';\n        const longRange = this.rollData.longRange || 'none';\n        \n        let rangeValueForSelected: string = 'none';\n        if (this.selectedRange === 'melee') {\n          rangeValueForSelected = meleeRange;\n        } else if (this.selectedRange === 'short') {\n          rangeValueForSelected = shortRange;\n        } else if (this.selectedRange === 'medium') {\n          rangeValueForSelected = mediumRange;\n        } else if (this.selectedRange === 'long') {\n          rangeValueForSelected = longRange;\n        }\n        \n        // Check if actor has severe wound - if so, always force disadvantage\n        let hasSevereWound = false;\n        if (this.actor) {\n          const actorSystem = this.actor.system as any;\n          if (actorSystem.damage && actorSystem.damage.severe) {\n            hasSevereWound = Array.isArray(actorSystem.damage.severe) && \n                             actorSystem.damage.severe.some((wound: boolean) => wound === true);\n          }\n        }\n        \n        // Auto-set roll mode based on range value (can be overridden by user)\n        // But if actor has severe wound, always force disadvantage\n        if (hasSevereWound) {\n          this.rollMode = 'disadvantage';\n        } else {\n          if (rangeValueForSelected === 'disadvantage') {\n            this.rollMode = 'disadvantage';\n          } else if (rangeValueForSelected === 'ok') {\n            this.rollMode = 'normal';\n          }\n        }\n      }\n      \n      // Re-render to update UI\n      this.render();\n    });\n\n    // Roll mode selection\n    html.find('input[name=\"roll-mode\"]').on('change', (event) => {\n      // Check if actor has severe wound - prevent changing mode\n      let hasSevereWound = false;\n      if (this.actor) {\n        const actorSystem = this.actor.system as any;\n        if (actorSystem.damage && actorSystem.damage.severe) {\n          hasSevereWound = Array.isArray(actorSystem.damage.severe) && \n                           actorSystem.damage.severe.some((wound: boolean) => wound === true);\n        }\n      }\n      \n      // If actor has severe wound, force disadvantage and prevent change\n      if (hasSevereWound) {\n        this.rollMode = 'disadvantage';\n        // Re-render to reset the selection\n        this.render();\n        return;\n      }\n      \n      const radio = event.currentTarget as HTMLInputElement;\n      const modeValue = radio.value;\n      \n      if (modeValue === 'normal' || modeValue === 'disadvantage' || modeValue === 'advantage') {\n        this.rollMode = modeValue as 'normal' | 'disadvantage' | 'advantage';\n      }\n    });\n\n    // Risk dice selection\n    html.find('.dice-icon').on('click', (event) => {\n      const diceIcon = $(event.currentTarget);\n      const diceIndex = parseInt(diceIcon.data('dice-index') || '0');\n      const isCurrentlySelected = diceIcon.hasClass('risk-dice');\n      \n      // If clicking on the last selected dice, deselect all\n      if (isCurrentlySelected && diceIndex === this.riskDiceCount - 1) {\n        this.riskDiceCount = 0;\n      } else {\n        // Otherwise, select all dice up to and including the clicked one\n        this.riskDiceCount = diceIndex + 1;\n      }\n      \n      // Re-render to update dice selection\n      this.render();\n    });\n\n    // Roll Dice button\n    html.find('.roll-dice-button').on('click', async () => {\n      // Calculate final RR based on enabled checkboxes\n      let finalRR = 0;\n      if (this.rollData.rrList && Array.isArray(this.rollData.rrList)) {\n        for (const rrSource of this.rollData.rrList) {\n          if (rrSource && typeof rrSource === 'object') {\n            const rrValue = rrSource.rrValue || 0;\n            const featName = rrSource.featName || 'Inconnu';\n            const rrId = `${featName}-${rrValue}`;\n            \n            if (this.rrEnabled.get(rrId)) {\n              finalRR += rrValue;\n            }\n          }\n        }\n      }\n      \n      // Update roll data with final RR\n      const finalRRList = this.rollData.rrList?.filter((rr: any) => {\n        const rrId = `${rr.featName || 'Inconnu'}-${rr.rrValue || 0}`;\n        return this.rrEnabled.get(rrId);\n      }) || [];\n      \n      // Calculate dice pool\n      let dicePool = 0;\n      if (this.rollData.specLevel !== undefined) {\n        dicePool = this.rollData.specLevel;\n      } else if (this.rollData.skillLevel !== undefined) {\n        dicePool = this.rollData.skillLevel;\n      } else if (this.rollData.linkedAttribute) {\n        const attributeValue = (this.actor?.system as any)?.attributes?.[this.rollData.linkedAttribute] || 0;\n        dicePool = attributeValue;\n      }\n      \n      // Block defense roll if no skill/spec is selected (unless using threshold for NPCs)\n      if (this.rollData.isDefend && !this.rollData.threshold) {\n        if (!this.rollData.skillName && !this.rollData.specName && dicePool === 0) {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.NO_SKILL_SELECTED') || 'Veuillez sélectionner une compétence pour la défense');\n          return;\n        }\n      }\n      \n      // Block counter-attack roll if no weapon or skill is selected\n      if (this.rollData.isCounterAttack && !this.rollData.threshold) {\n        if (!this.rollData.selectedWeaponId && !this.rollData.skillName && !this.rollData.specName) {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPON_SELECTED') || 'Veuillez sélectionner une arme pour la contre-attaque');\n          return;\n        }\n        if (dicePool === 0) {\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_DICE_POOL') || 'La réserve de dés pour la contre-attaque est de 0. Veuillez sélectionner une arme valide.');\n          return;\n        }\n      }\n      \n      // Block roll if selected range is \"none\" (for weapon rolls, not defense)\n      if (this.rollData.itemType === 'weapon' || this.rollData.itemType === 'spell' || this.rollData.itemType === 'weapons-spells') {\n        if (!this.rollData.isDefend && this.selectedRange) {\n          // Get the current range value\n          let selectedRangeValue: string | null = null;\n          const meleeRange = this.rollData.meleeRange || 'none';\n          const shortRange = this.rollData.shortRange || 'none';\n          const mediumRange = this.rollData.mediumRange || 'none';\n          const longRange = this.rollData.longRange || 'none';\n          \n          if (this.selectedRange === 'melee') {\n            selectedRangeValue = meleeRange;\n          } else if (this.selectedRange === 'short') {\n            selectedRangeValue = shortRange;\n          } else if (this.selectedRange === 'medium') {\n            selectedRangeValue = mediumRange;\n          } else if (this.selectedRange === 'long') {\n            selectedRangeValue = longRange;\n          }\n          \n          // Block if range value is \"none\"\n          if (selectedRangeValue === 'none') {\n            ui.notifications?.warn(game.i18n!.localize('SRA2.ROLL_DIALOG.INVALID_RANGE') || 'La portée sélectionnée n\\'est pas disponible pour cette arme. Veuillez sélectionner une portée valide.');\n            return;\n          }\n        }\n      }\n      \n      // Get attacker and defender\n      const attacker = this.actor;\n      const attackerToken = this.attackerToken || null;\n      const defender = this.targetToken?.actor || null;\n      const defenderToken = this.targetToken || null;\n      \n      // Get token UUIDs\n      const attackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\n      const defenderTokenUuid = defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\n      \n      // Log token information\n      console.log('=== ROLL DICE BUTTON ===');\n      console.log('Attacker:', attacker?.name || 'Unknown');\n      console.log('Attacker Token:', attackerToken ? 'Found' : 'Not found');\n      console.log('Attacker Token UUID:', attackerTokenUuid || 'Unknown');\n      if (attackerToken?.actor) {\n        console.log('Attacker Token Actor UUID:', attackerToken.actor.uuid || 'Unknown');\n      }\n      console.log('Defender:', defender?.name || 'None');\n      console.log('Defender Token:', defenderToken ? 'Found' : 'Not found');\n      console.log('Defender Token UUID:', defenderTokenUuid || 'Unknown');\n      if (defenderToken?.actor) {\n        console.log('Defender Token Actor UUID:', defenderToken.actor.uuid || 'Unknown');\n      }\n      console.log('========================');\n      \n      // Prepare roll data\n      const updatedRollData = {\n        ...this.rollData,\n        rrList: finalRRList,\n        riskDiceCount: this.riskDiceCount,  // Add risk dice count to roll data\n        selectedRange: this.selectedRange,  // Add selected range\n        rollMode: this.rollMode,  // Add roll mode (normal/disadvantage/advantage)\n        finalRR: Math.min(3, finalRR),  // Final RR (capped at 3)\n        dicePool: dicePool,\n        attackerTokenUuid: attackerTokenUuid,  // Add attacker token UUID\n        defenderTokenUuid: defenderTokenUuid   // Add defender token UUID\n      };\n      \n      // Import and execute roll\n      const { executeRoll } = await import('../helpers/dice-roller.js');\n      await executeRoll(attacker, defender, attackerToken, defenderToken, updatedRollData);\n      \n      // Close the dialog\n      this.close();\n    });\n  }\n\n  private updateRRForSkill(skillName: string, linkedAttribute: string, dicePool: number): void {\n    // For defense, always use this.actor (the defender)\n    // For other rolls, also use this.actor (the one making the roll)\n    if (!this.actor) return;\n    \n    // Get RR sources synchronously (already imported at top)\n    // Always use this.actor which is correctly set to the defender for defense rolls\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\n    \n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with skill/attribute RR\n    // For non-weapon rolls, use only skill/attribute RR\n    let itemRRList: any[] = [];\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\n      // Get the weapon item to extract its rrList\n      const weapon = this.actor.items.get(this.rollData.itemId);\n      if (weapon) {\n        const weaponSystem = weapon.system as any;\n        const rawItemRRList = weaponSystem.rrList || [];\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\n          ...rrEntry,\n          featName: weapon.name  // Add featName (the weapon name itself)\n        }));\n      }\n    }\n    \n    // Merge item RR (if weapon) + skill RR + attribute RR\n    this.rollData.rrList = [...itemRRList, ...skillRRSources, ...attributeRRSources];\n    \n    // Reset RR enabled state for new sources\n    this.rrEnabled.clear();\n    for (const rrSource of this.rollData.rrList) {\n      if (rrSource && typeof rrSource === 'object') {\n        const rrValue = rrSource.rrValue || 0;\n        const featName = rrSource.featName || 'Inconnu';\n        if (rrValue > 0) {\n          const rrId = `${featName}-${rrValue}`;\n          this.rrEnabled.set(rrId, true);\n        }\n      }\n    }\n    \n    // Recalculate threshold if it was set\n    if (this.rollData.threshold !== undefined) {\n      const totalRR = Math.min(3, skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\n    }\n  }\n\n  private updateRRForSpec(specName: string, skillName: string, linkedAttribute: string, dicePool: number): void {\n    // For defense, always use this.actor (the defender)\n    // For other rolls, also use this.actor (the one making the roll)\n    if (!this.actor) return;\n    \n    // Get RR sources synchronously (already imported at top)\n    // Always use this.actor which is correctly set to the defender for defense rolls\n    const specRRSources = SheetHelpers.getRRSources(this.actor, 'specialization', specName);\n    const skillRRSources = SheetHelpers.getRRSources(this.actor, 'skill', skillName);\n    const attributeRRSources = SheetHelpers.getRRSources(this.actor, 'attribute', linkedAttribute);\n    \n    // For weapon rolls, preserve the weapon's rrList (from item) and merge with spec/skill/attribute RR\n    // For non-weapon rolls, use only spec/skill/attribute RR\n    let itemRRList: any[] = [];\n    if (this.rollData.itemId && this.rollData.itemType === 'weapon') {\n      // Get the weapon item to extract its rrList\n      const weapon = this.actor.items.get(this.rollData.itemId);\n      if (weapon) {\n        const weaponSystem = weapon.system as any;\n        const rawItemRRList = weaponSystem.rrList || [];\n        itemRRList = rawItemRRList.map((rrEntry: any) => ({\n          ...rrEntry,\n          featName: weapon.name  // Add featName (the weapon name itself)\n        }));\n      }\n    }\n    \n    // Merge item RR (if weapon) + spec RR + skill RR + attribute RR\n    this.rollData.rrList = [...itemRRList, ...specRRSources, ...skillRRSources, ...attributeRRSources];\n    \n    // Reset RR enabled state for new sources\n    this.rrEnabled.clear();\n    for (const rrSource of this.rollData.rrList) {\n      if (rrSource && typeof rrSource === 'object') {\n        const rrValue = rrSource.rrValue || 0;\n        const featName = rrSource.featName || 'Inconnu';\n        if (rrValue > 0) {\n          const rrId = `${featName}-${rrValue}`;\n          this.rrEnabled.set(rrId, true);\n        }\n      }\n    }\n    \n    // Recalculate threshold if it was set\n    if (this.rollData.threshold !== undefined) {\n      const totalRR = Math.min(3, specRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \n                                skillRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0) + \n                                attributeRRSources.reduce((sum: number, r: any) => sum + (r.rrValue || 0), 0));\n      this.rollData.threshold = Math.round(dicePool / 3) + totalRR + 1;\n    }\n  }\n}\n\n","export const HOOKS = {\n  MIGRATIONS: 'sra2-declareMigration',\n}","import { HOOKS } from \"../hooks.mjs\"\n\nconst CURRENT_SYSTEM_VERSION = \"currentSystemVersion\";\n\nexport class Migration {\n  get code() { return \"sample\"; }\n\n  get version() { return \"0.0.0\"; }\n\n  async migrate() { return () => { } };\n\n  async applyItemsUpdates(computeUpdates = (items) => []) {\n    await game.actors.forEach(async (actor) => {\n      const actorItemUpdates = computeUpdates(actor.items);\n      if (actorItemUpdates.length > 0) {\n        const message = game.i18n.format('SRA2.MIGRATION.APPLYING_ACTOR_ITEMS', { name: actor.name });\n        console.log(SYSTEM.LOG.HEAD, this.code, message, actorItemUpdates);\n        await actor.updateEmbeddedDocuments('Item', actorItemUpdates);\n      }\n    })\n\n    const itemUpdates = computeUpdates(game.items);\n    if (itemUpdates.length > 0) {\n      const message = game.i18n.localize('SRA2.MIGRATION.APPLYING_ITEMS');\n      console.log(SYSTEM.LOG.HEAD, this.code, message, itemUpdates);\n      await Item.updateDocuments(itemUpdates);\n    }\n  }\n}\n\nexport class Migrations {\n  constructor() {\n    // Hooks.once(HOOKS.MIGRATIONS, declareMigrations => declareMigrations(\n    //   /* add system migrations here, can declared anywhere */\n    // ))\n\n    game.settings.register(SYSTEM.id, CURRENT_SYSTEM_VERSION, {\n      name: \"SRA2.MIGRATION.SETTING_NAME\",\n      scope: \"world\",\n      config: false,\n      type: String,\n      default: \"0.0.0\"\n    })\n  }\n\n  migrate() {\n    const currentVersion = game.settings.get(SYSTEM.id, CURRENT_SYSTEM_VERSION)\n    if (foundry.utils.isNewerVersion(game.system.version, currentVersion)) {\n      //if (true) {\n      let migrations = []\n      Hooks.callAll(HOOKS.MIGRATIONS, (...list) =>\n        migrations = migrations.concat(list.filter(m => foundry.utils.isNewerVersion(m.version, currentVersion)))\n      )\n      Hooks.off(HOOKS.MIGRATIONS, () => { })\n\n      if (migrations.length > 0) {\n        migrations.sort((a, b) => foundry.utils.isNewerVersion(a.version, b.version) ? 1 : foundry.utils.isNewerVersion(b.version, a.version) ? -1 : 0)\n        migrations.forEach(async m => {\n          const message = game.i18n.format('SRA2.MIGRATION.EXECUTING', { code: m.code, currentVersion: currentVersion, targetVersion: m.version });\n          this.$notify(message);\n          await m.migrate()\n        })\n        const message = game.i18n.format('SRA2.MIGRATION.DONE', { version: game.system.version });\n        this.$notify(message)\n      }\n      else {\n        const message = game.i18n.format('SRA2.MIGRATION.NOT_NEEDED', { version: game.system.version });\n        console.log(SYSTEM.LOG.HEAD + message)\n      }\n      game.settings.set(SYSTEM.id, CURRENT_SYSTEM_VERSION, game.system.version)\n    }\n    else {\n      const message = game.i18n.localize('SRA2.MIGRATION.VERSION_UNCHANGED');\n      console.log(SYSTEM.LOG.HEAD + message)\n    }\n  }\n\n\n  $notify(message) {\n    ui.notifications.info(message);\n    console.log(SYSTEM.LOG.HEAD + message);\n  }\n}\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.3: Convert rrType, rrValue, rrTarget arrays to rrList\n * This migration transforms the three separate arrays into a single array of objects\n * where each object contains {rrType, rrValue, rrTarget}\n */\nexport class Migration_13_0_3 extends Migration {\n  get code() { \n    return \"migration-13.0.3\"; \n  }\n\n  get version() { \n    return \"13.0.3\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.3: Converting rrType/rrValue/rrTarget to rrList\");\n    \n    let totalMigrated = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the raw source data which contains fields even if they're not in the schema\n        const sourceSystem = item._source?.system || item.system;\n        const system = item.system;\n        \n        // Check for old format in the source data (raw data from database)\n        const hasOldFormat = (\n          (sourceSystem.rrType !== undefined && Array.isArray(sourceSystem.rrType)) ||\n          (sourceSystem.rrValue !== undefined && Array.isArray(sourceSystem.rrValue)) ||\n          (sourceSystem.rrTarget !== undefined && Array.isArray(sourceSystem.rrTarget))\n        );\n        \n        // Check if rrList already exists with content in source\n        const hasNewFormatInSource = (\n          sourceSystem.rrList !== undefined && \n          Array.isArray(sourceSystem.rrList)\n        );\n        \n        // Skip if already migrated (has new format in source AND no old format)\n        if (hasNewFormatInSource && !hasOldFormat) {\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - already has rrList in source (${sourceSystem.rrList.length} entries), no old data`);\n          totalSkipped++;\n          continue;\n        }\n        \n        // Skip if no old format to migrate\n        if (!hasOldFormat) {\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Skipping \"${item.name}\" - no old format fields found`);\n          totalSkipped++;\n          continue;\n        }\n        \n        // Get the arrays from source data\n        const rrType = Array.isArray(sourceSystem.rrType) ? sourceSystem.rrType : [];\n        const rrValue = Array.isArray(sourceSystem.rrValue) ? sourceSystem.rrValue : [];\n        const rrTarget = Array.isArray(sourceSystem.rrTarget) ? sourceSystem.rrTarget : [];\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Found \"${item.name}\" with old format:`, {\n          rrType: rrType,\n          rrValue: rrValue,\n          rrTarget: rrTarget\n        });\n        \n        // Convert the three arrays into a single rrList array\n        const rrList = [];\n        const maxLength = Math.max(rrType.length, rrValue.length, rrTarget.length);\n        \n        for (let i = 0; i < maxLength; i++) {\n          // Only add entries where rrType exists and is not \"none\"\n          const type = rrType[i];\n          if (type && type !== 'none') {\n            rrList.push({\n              rrType: type,\n              rrValue: rrValue[i] !== undefined ? rrValue[i] : 0,\n              rrTarget: rrTarget[i] !== undefined ? rrTarget[i] : ''\n            });\n          }\n        }\n        \n        // Create the update object\n        const update = {\n          _id: item.id,\n          'system.rrList': rrList,\n          // Store backup of old data before deletion\n          'system._rrTypeBackup': rrType,\n          'system._rrValueBackup': rrValue,\n          'system._rrTargetBackup': rrTarget,\n          // Remove old fields by setting them to null (Foundry will delete them)\n          'system.rrType': null,\n          'system.rrValue': null,\n          'system.rrTarget': null\n        };\n        \n        updates.push(update);\n        totalMigrated++;\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.3: Converting feat \"${item.name}\":`);\n        console.log(SYSTEM.LOG.HEAD + `  Old data (will be deleted, backed up as _rrTypeBackup/_rrValueBackup/_rrTargetBackup):`, { rrType, rrValue, rrTarget });\n        console.log(SYSTEM.LOG.HEAD + `  New rrList (${rrList.length} entries):`, rrList);\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.3 completed - Migrated: ${totalMigrated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalMigrated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_3_INFO') :\n        'Migration 13.0.3: Risk Reduction data converted. Check console for details.';\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.4: Clean up old RR fields and backups\n * This migration removes the old rrType/rrValue/rrTarget fields and their backups\n * after confirming that rrList is working properly\n */\nexport class Migration_13_0_4 extends Migration {\n  get code() { \n    return \"migration-13.0.4\"; \n  }\n\n  get version() { \n    return \"13.0.4\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.4: Cleaning up old RR fields and backups\");\n    \n    let totalCleaned = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the raw source data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Check if there are any old fields or backups to clean\n        const hasOldFields = (\n          sourceSystem.rrType !== undefined ||\n          sourceSystem.rrValue !== undefined ||\n          sourceSystem.rrTarget !== undefined\n        );\n        \n        const hasBackups = (\n          sourceSystem._rrTypeBackup !== undefined ||\n          sourceSystem._rrValueBackup !== undefined ||\n          sourceSystem._rrTargetBackup !== undefined\n        );\n        \n        // Skip if nothing to clean\n        if (!hasOldFields && !hasBackups) {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Check that rrList exists (safety check)\n        const hasRrList = sourceSystem.rrList !== undefined && Array.isArray(sourceSystem.rrList);\n        \n        if (!hasRrList) {\n          console.warn(SYSTEM.LOG.HEAD + `Migration 13.0.4: Skipping \"${item.name}\" - no rrList found! This item may need manual review.`);\n          totalSkipped++;\n          continue;\n        }\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.4: Cleaning up feat \"${item.name}\":`);\n        if (hasOldFields) {\n          console.log(SYSTEM.LOG.HEAD + `  Removing old fields: rrType, rrValue, rrTarget`);\n        }\n        if (hasBackups) {\n          console.log(SYSTEM.LOG.HEAD + `  Removing backups: _rrTypeBackup, _rrValueBackup, _rrTargetBackup`);\n        }\n        console.log(SYSTEM.LOG.HEAD + `  Keeping rrList with ${sourceSystem.rrList.length} entries`);\n        \n        // Create the update object to remove all old fields\n        const update = {\n          _id: item.id,\n          // Remove old fields\n          'system.rrType': null,\n          'system.rrValue': null,\n          'system.rrTarget': null,\n          // Remove backup fields\n          'system._rrTypeBackup': null,\n          'system._rrValueBackup': null,\n          'system._rrTargetBackup': null\n        };\n        \n        updates.push(update);\n        totalCleaned++;\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.4 completed - Cleaned: ${totalCleaned}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalCleaned > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_4_INFO') :\n        'Migration 13.0.4: Old RR fields cleaned up. Data migration complete.';\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.5: Separate weapons and spells feat types\n * This migration converts \"weapons-spells\" feat type to separate \"weapon\" and \"spell\" types\n * By default, all \"weapons-spells\" are converted to \"weapon\" type\n */\nexport class Migration_13_0_5 extends Migration {\n  get code() { \n    return \"migration-13.0.5\"; \n  }\n\n  get version() { \n    return \"13.0.5\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.5: Separating weapons and spells feat types\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Check if this is a \"weapons-spells\" feat type\n        if (sourceSystem.featType !== 'weapons-spells') {\n          totalSkipped++;\n          continue;\n        }\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.5: Converting feat \"${item.name}\" from \"weapons-spells\" to \"weapon\"`);\n        \n        // Convert to \"weapon\" type by default\n        // Users can manually change specific items to \"spell\" if needed\n        const update = {\n          _id: item.id,\n          'system.featType': 'weapon'\n        };\n        \n        updates.push(update);\n        totalConverted++;\n      }\n      \n      return updates;\n    });\n    \n    const summaryMessage = `Migration 13.0.5 completed - Converted: ${totalConverted} weapons-spells to weapon, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalConverted > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.localize('SRA2.MIGRATION.13_0_5_INFO') :\n        `Migration 13.0.5: Converted ${totalConverted} \"weapons-spells\" feats to \"weapon\" type. You can manually change specific items to \"spell\" type if needed.`;\n      ui.notifications?.info(userMessage, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.6: Rollback migration 13.0.5\n * This migration does NOT convert anything - keeps weapons-spells as valid type\n * Only marks that this version has been applied\n */\nexport class Migration_13_0_6 extends Migration {\n  get code() { \n    return \"migration-13.0.6\"; \n  }\n\n  get version() { \n    return \"13.0.6\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Migration 13.0.6: Rollback - keeping old weapons-spells type valid\");\n    console.log(SYSTEM.LOG.HEAD + \"No conversion needed. weapons-spells, weapon, and spell types are all valid.\");\n    \n    // This migration does nothing, just marks the version as applied\n    // Old items with \"weapons-spells\" will continue to work\n    // New items can use \"weapon\" or \"spell\" as separate types\n    \n    const message = \"Migration 13.0.6: All feat types (weapons-spells, weapon, spell) are now valid. No data conversion performed.\";\n    console.log(SYSTEM.LOG.HEAD + message);\n    \n    if (ui.notifications) {\n      ui.notifications.info(message, {permanent: false});\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.7: Convert weapons-spells to weapon (with backup)\n * This migration safely converts all \"weapons-spells\" feat types to \"weapon\"\n * Creates a backup of the old value before conversion\n */\nexport class Migration_13_0_7 extends Migration {\n  get code() { \n    return \"migration-13.0.7\"; \n  }\n\n  get version() { \n    return \"13.0.7\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.7: Converting weapons-spells to weapon (with backup)\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    let conversionDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Skip if not weapons-spells type\n        if (sourceSystem.featType !== 'weapons-spells') {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Log what we're converting\n        const itemInfo = {\n          name: item.name,\n          id: item.id,\n          oldType: 'weapons-spells',\n          newType: 'weapon',\n          hasWeaponFocus: sourceSystem.isWeaponFocus || false,\n          hasDamageValue: (sourceSystem.damageValue || 0) > 0,\n          hasRanges: (\n            sourceSystem.meleeRange !== 'none' ||\n            sourceSystem.shortRange !== 'none' ||\n            sourceSystem.mediumRange !== 'none' ||\n            sourceSystem.longRange !== 'none'\n          )\n        };\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.7: Converting \"${item.name}\" (ID: ${item.id})`);\n        console.log(SYSTEM.LOG.HEAD + `  - Old type: weapons-spells`);\n        console.log(SYSTEM.LOG.HEAD + `  - New type: weapon`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has weapon focus: ${itemInfo.hasWeaponFocus}`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has damage value: ${itemInfo.hasDamageValue}`);\n        console.log(SYSTEM.LOG.HEAD + `  - Has ranges: ${itemInfo.hasRanges}`);\n        \n        conversionDetails.push(itemInfo);\n        \n        // Create the update object\n        const update = {\n          _id: item.id,\n          // Change the type\n          'system.featType': 'weapon',\n          // Create a backup of the old type for safety\n          'system._oldFeatTypeBackup': 'weapons-spells',\n          // Add a migration timestamp\n          'system._migratedAt': new Date().toISOString(),\n          'system._migrationVersion': '13.0.7'\n        };\n        \n        updates.push(update);\n        totalConverted++;\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.7 completed - Converted: ${totalConverted}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (conversionDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\n      \n      const withWeaponFocus = conversionDetails.filter(d => d.hasWeaponFocus).length;\n      const withDamage = conversionDetails.filter(d => d.hasDamageValue).length;\n      const withRanges = conversionDetails.filter(d => d.hasRanges).length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Items with weapon focus: ${withWeaponFocus}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Items with damage value: ${withDamage}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Items with ranges: ${withRanges}`);\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\n      \n      // List all converted items\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\n      conversionDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id})`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalConverted > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_7_INFO', { count: totalConverted }) :\n        `Migration 13.0.7: Converted ${totalConverted} \"weapons-spells\" items to \"weapon\" type. All data preserved with backup.`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete. All items have been backed up.\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ Old type saved in system._oldFeatTypeBackup\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to convert - all items already migrated or are other types\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.8: Convert narrativeEffects from string array to object array\n * This migration safely converts all narrativeEffects from simple strings\n * to objects with { text: string, isNegative: boolean } structure\n */\nexport class Migration_13_0_8 extends Migration {\n  get code() { \n    return \"migration-13.0.8\"; \n  }\n\n  get version() { \n    return \"13.0.8\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.8: Converting narrativeEffects to new format and fixing damageValueBonus\");\n    \n    let totalConverted = 0;\n    let totalSkipped = 0;\n    let totalFixed = 0;\n    let conversionDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        // Check and fix narrativeEffects\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\n          // Check if it's already in the new format (first element is an object with 'text' property)\n          const firstEffect = sourceSystem.narrativeEffects[0];\n          if (!(typeof firstEffect === 'object' && firstEffect !== null && 'text' in firstEffect)) {\n            // Convert string array to object array\n            const convertedEffects = sourceSystem.narrativeEffects.map(effect => {\n              if (typeof effect === 'string') {\n                return {\n                  text: effect,\n                  isNegative: false\n                };\n              }\n              // If it's already an object but missing properties, normalize it\n              return {\n                text: effect?.text || effect?.toString() || \"\",\n                isNegative: effect?.isNegative || false\n              };\n            });\n            \n            update['system.narrativeEffects'] = convertedEffects;\n            update['system._migratedNarrativeEffectsAt'] = new Date().toISOString();\n            update['system._narrativeEffectsMigrationVersion'] = '13.0.8';\n            needsUpdate = true;\n            \n            // Log what we're converting\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Converting narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${sourceSystem.narrativeEffects.length}`);\n            \n            conversionDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: sourceSystem.narrativeEffects.length\n            });\n            totalConverted++;\n          }\n        }\n        \n        // Fix missing or invalid damageValueBonus values for ALL feat items\n        if (sourceSystem.damageValueBonus === null || \n            sourceSystem.damageValueBonus === undefined || \n            typeof sourceSystem.damageValueBonus !== 'number' ||\n            !Number.isInteger(sourceSystem.damageValueBonus)) {\n          update['system.damageValueBonus'] = 0;\n          needsUpdate = true;\n          totalFixed++;\n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.8: Fixing damageValueBonus for \"${item.name}\" (ID: ${item.id})`);\n        }\n        \n        if (needsUpdate) {\n          updates.push(update);\n        } else {\n          totalSkipped++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.8 completed - NarrativeEffects converted: ${totalConverted}, DamageValueBonus fixed: ${totalFixed}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (conversionDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== CONVERSION DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items converted: ${conversionDetails.length}`);\n      \n      const totalEffects = conversionDetails.reduce((sum, d) => sum + d.effectCount, 0);\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects migrated: ${totalEffects}`);\n      console.log(SYSTEM.LOG.HEAD + \"=========================\");\n      \n      // List all converted items\n      console.log(SYSTEM.LOG.HEAD + \"Converted items:\");\n      conversionDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${detail.effectCount} effect(s)`);\n      });\n    }\n    \n    if (totalFixed > 0) {\n      console.log(SYSTEM.LOG.HEAD + `Fixed damageValueBonus on ${totalFixed} item(s)`);\n    }\n    \n    // Show user-friendly notification\n    if (totalConverted > 0 || totalFixed > 0) {\n      let userMessage = \"\";\n      if (totalConverted > 0 && totalFixed > 0) {\n        userMessage = game.i18n ? \n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted, fixed: totalFixed }) :\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) and fixed damageValueBonus on ${totalFixed} feat(s).`;\n      } else if (totalConverted > 0) {\n        userMessage = game.i18n ? \n          game.i18n.format('SRA2.MIGRATION.13_0_8_INFO', { count: totalConverted }) :\n          `Migration 13.0.8: Converted narrative effects on ${totalConverted} feat(s) to new format.`;\n      } else if (totalFixed > 0) {\n        userMessage = `Migration 13.0.8: Fixed damageValueBonus on ${totalFixed} feat(s).`;\n      }\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\n      if (totalConverted > 0) {\n        console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects converted to new format.\");\n        console.log(SYSTEM.LOG.HEAD + \"✓ All effects default to positive (isNegative: false)\");\n      }\n      if (totalFixed > 0) {\n        console.log(SYSTEM.LOG.HEAD + \"✓ All damageValueBonus fields set to valid integer values.\");\n      }\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the conversion\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.9: Add value field to narrativeEffects and isFirstFeat field\n * This migration adds a 'value' field to all narrative effects\n * with a default of -1 for consistency with the new schema,\n * and adds an 'isFirstFeat' boolean field with default false\n */\nexport class Migration_13_0_9 extends Migration {\n  get code() { \n    return \"migration-13.0.9\"; \n  }\n\n  get version() { \n    return \"13.0.9\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.9: Adding value field to narrativeEffects and isFirstFeat field\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    let totalFirstFeatAdded = 0;\n    let updateDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        // Check if item has narrativeEffects that need updating\n        if (sourceSystem.narrativeEffects && sourceSystem.narrativeEffects.length > 0) {\n          const updatedEffects = sourceSystem.narrativeEffects.map(effect => {\n            // Check if effect already has a value field\n            if (typeof effect === 'object' && effect !== null && !('value' in effect)) {\n              needsUpdate = true;\n              return {\n                ...effect,\n                value: -1  // Default value for all effects\n              };\n            }\n            return effect;\n          });\n          \n          if (needsUpdate) {\n            update['system.narrativeEffects'] = updatedEffects;\n            update['system._migratedNarrativeEffectsValueAt'] = new Date().toISOString();\n            \n            // Log what we're converting\n            console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding value field to narrativeEffects for \"${item.name}\" (ID: ${item.id})`);\n            console.log(SYSTEM.LOG.HEAD + `  - Effect count: ${updatedEffects.length}`);\n            \n            updateDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: updatedEffects.length,\n              hasFirstFeat: false\n            });\n          }\n        }\n        \n        // Check if item needs isFirstFeat field (add to all feats that don't have it)\n        if (sourceSystem.isFirstFeat === undefined || sourceSystem.isFirstFeat === null) {\n          update['system.isFirstFeat'] = false;\n          needsUpdate = true;\n          totalFirstFeatAdded++;\n          \n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.9: Adding isFirstFeat field to \"${item.name}\" (ID: ${item.id})`);\n          \n          // Update details if not already added\n          const existingDetail = updateDetails.find(d => d.id === item.id);\n          if (existingDetail) {\n            existingDetail.hasFirstFeat = true;\n          } else {\n            updateDetails.push({\n              name: item.name,\n              id: item.id,\n              effectCount: 0,\n              hasFirstFeat: true\n            });\n          }\n        }\n        \n        if (needsUpdate) {\n          update['system._narrativeEffectsValueMigrationVersion'] = '13.0.9';\n          updates.push(update);\n          totalUpdated++;\n        } else {\n          totalSkipped++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.9 completed - Items updated: ${totalUpdated}, isFirstFeat added: ${totalFirstFeatAdded}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (updateDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\n      \n      const totalEffects = updateDetails.reduce((sum, d) => sum + d.effectCount, 0);\n      const totalWithFirstFeat = updateDetails.filter(d => d.hasFirstFeat).length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - Total narrative effects updated: ${totalEffects}`);\n      console.log(SYSTEM.LOG.HEAD + `  - Total items with isFirstFeat added: ${totalWithFirstFeat}`);\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\n      \n      // List all updated items\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\n      updateDetails.forEach((detail, index) => {\n        const updates = [];\n        if (detail.effectCount > 0) updates.push(`${detail.effectCount} effect(s)`);\n        if (detail.hasFirstFeat) updates.push('isFirstFeat added');\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (ID: ${detail.id}) - ${updates.join(', ')}`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_9_INFO', { count: totalUpdated, firstFeatCount: totalFirstFeatAdded }) :\n        `Migration 13.0.9: Updated ${totalUpdated} feat(s) - added value field to narrative effects and isFirstFeat field to ${totalFirstFeatAdded} feat(s).`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ All narrative effects now have a value field (default: -1)\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ All feats now have isFirstFeat field (default: false)\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.10: Update cost field values\n * This migration updates the cost field to use the new simplified system:\n * - 'specialized-equipment' -> 'advanced-equipment'\n * - 'feat' -> removed (defaults to 0 cost for non-equipment items)\n * - Cost field only applies to equipment and weapon types\n */\nexport class Migration_13_0_10 extends Migration {\n  get code() { \n    return \"migration-13.0.10\"; \n  }\n\n  get version() { \n    return \"13.0.10\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.10: Updating cost field values\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    let updateDetails = [];\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      // Log all feat items for debugging\n      const featItems = items.filter(item => item.type === 'feat');\n      console.log(SYSTEM.LOG.HEAD + `Found ${featItems.length} feat items to check`);\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Skip if already migrated\n        if (sourceSystem._costMigrationVersion === '13.0.10') {\n          totalSkipped++;\n          continue;\n        }\n        \n        let needsUpdate = false;\n        const update = {\n          _id: item.id\n        };\n        \n        const currentCost = sourceSystem.cost || 'free-equipment';\n        const featType = sourceSystem.featType || 'equipment';\n        let newCost = currentCost;\n        let reason = '';\n        \n        // Log current state for debugging\n        console.log(SYSTEM.LOG.HEAD + `Checking \"${item.name}\" - cost: \"${currentCost}\", type: \"${featType}\"`);\n        \n        // Convert specialized-equipment to advanced-equipment\n        if (currentCost === 'specialized-equipment') {\n          newCost = 'advanced-equipment';\n          needsUpdate = true;\n          reason = 'specialized-equipment → advanced-equipment';\n        }\n        // Convert old 'feat' cost type to appropriate value\n        else if (currentCost === 'feat') {\n          // For equipment and weapons, set to free-equipment (0 cost)\n          // For other types, the cost doesn't apply anyway but we set it to free-equipment for consistency\n          newCost = 'free-equipment';\n          needsUpdate = true;\n          reason = 'feat → free-equipment (cost = 0 for non-equipment types)';\n        }\n        // Ensure all items have a valid cost value\n        else if (!currentCost || !['free-equipment', 'equipment', 'advanced-equipment'].includes(currentCost)) {\n          newCost = 'free-equipment';\n          needsUpdate = true;\n          reason = `invalid or missing cost (${currentCost}) → free-equipment`;\n        }\n        \n        if (needsUpdate) {\n          update['system.cost'] = newCost;\n          update['system._costMigrationVersion'] = '13.0.10';\n          \n          console.log(SYSTEM.LOG.HEAD + `Migration 13.0.10: Updating cost for \"${item.name}\" (ID: ${item.id})`);\n          console.log(SYSTEM.LOG.HEAD + `  - Type: ${featType}`);\n          console.log(SYSTEM.LOG.HEAD + `  - Old cost: ${currentCost}`);\n          console.log(SYSTEM.LOG.HEAD + `  - New cost: ${newCost}`);\n          console.log(SYSTEM.LOG.HEAD + `  - Reason: ${reason}`);\n          \n          updateDetails.push({\n            name: item.name,\n            id: item.id,\n            featType: featType,\n            oldCost: currentCost,\n            newCost: newCost,\n            reason: reason\n          });\n          \n          updates.push(update);\n          totalUpdated++;\n        }\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.10 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Detailed summary\n    if (updateDetails.length > 0) {\n      console.log(SYSTEM.LOG.HEAD + \"=== UPDATE DETAILS ===\");\n      console.log(SYSTEM.LOG.HEAD + `Total items updated: ${updateDetails.length}`);\n      \n      const specializedToAdvanced = updateDetails.filter(d => d.oldCost === 'specialized-equipment').length;\n      const featToFree = updateDetails.filter(d => d.oldCost === 'feat').length;\n      \n      console.log(SYSTEM.LOG.HEAD + `  - specialized-equipment → advanced-equipment: ${specializedToAdvanced}`);\n      console.log(SYSTEM.LOG.HEAD + `  - feat → free-equipment: ${featToFree}`);\n      console.log(SYSTEM.LOG.HEAD + \"======================\");\n      \n      // List all updated items\n      console.log(SYSTEM.LOG.HEAD + \"Updated items:\");\n      updateDetails.forEach((detail, index) => {\n        console.log(SYSTEM.LOG.HEAD + `  ${index + 1}. \"${detail.name}\" (${detail.featType}): ${detail.oldCost} → ${detail.newCost}`);\n      });\n    }\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_10_INFO', { \n          count: totalUpdated,\n          specializedCount: updateDetails.filter(d => d.oldCost === 'specialized-equipment').length,\n          featCount: updateDetails.filter(d => d.oldCost === 'feat').length\n        }) :\n        `Migration 13.0.10: Updated ${totalUpdated} feat(s) cost values.`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost system simplified: free (0¥), equipment (2500¥), advanced (5000¥)\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ Cost now only applies to equipment and weapon types\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ No data was lost in the migration\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.11: Add linked specializations fields to weapons\n * This migration adds the new linkedAttackSpecialization and linkedDefenseSpecialization fields\n * to all weapon and weapons-spells type feats\n */\nexport class Migration_13_0_11 extends Migration {\n  get code() { \n    return \"migration-13.0.11\"; \n  }\n\n  get version() { \n    return \"13.0.11\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.11: Adding linked specializations fields to weapons\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items of type weapon or weapons-spells\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        const featType = sourceSystem.featType || 'equipment';\n        \n        // Only process weapon and weapons-spells types\n        if (featType !== 'weapon' && featType !== 'weapons-spells') {\n          continue;\n        }\n        \n        // Skip if already migrated\n        if (sourceSystem._specializationLinkMigrationVersion === '13.0.11') {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Check if the fields already exist\n        const hasAttackSpec = sourceSystem.hasOwnProperty('linkedAttackSpecialization');\n        const hasDefenseSpec = sourceSystem.hasOwnProperty('linkedDefenseSpecialization');\n        \n        if (hasAttackSpec && hasDefenseSpec) {\n          // Fields already exist, just mark as migrated\n          const update = {\n            _id: item.id,\n            'system._specializationLinkMigrationVersion': '13.0.11'\n          };\n          updates.push(update);\n          totalSkipped++;\n          continue;\n        }\n        \n        // Add the new fields\n        const update = {\n          _id: item.id,\n          'system.linkedAttackSpecialization': sourceSystem.linkedAttackSpecialization || '',\n          'system.linkedDefenseSpecialization': sourceSystem.linkedDefenseSpecialization || '',\n          'system._specializationLinkMigrationVersion': '13.0.11'\n        };\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.11: Adding specialization link fields to weapon \"${item.name}\" (ID: ${item.id})`);\n        \n        updates.push(update);\n        totalUpdated++;\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.11 completed - Weapons updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_11_INFO', { count: totalUpdated }) :\n        `Migration 13.0.11: Added specialization link fields to ${totalUpdated} weapon(s).`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ Weapons can now be linked to attack and defense specializations\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n\n","import { Migration } from \"./migration.mjs\";\n\n/**\n * Migration 13.0.12: Convert \"dice\" to \"disadvantage\" in weapon ranges\n * This migration updates all weapon/spell range values from \"dice\" to \"disadvantage\"\n * for meleeRange, shortRange, mediumRange, and longRange fields\n */\nexport class Migration_13_0_12 extends Migration {\n  get code() { \n    return \"migration-13.0.12\"; \n  }\n\n  get version() { \n    return \"13.0.12\"; \n  }\n\n  async migrate() {\n    console.log(SYSTEM.LOG.HEAD + \"Starting migration 13.0.12: Converting 'dice' to 'disadvantage' in weapon ranges\");\n    \n    let totalUpdated = 0;\n    let totalSkipped = 0;\n    \n    await this.applyItemsUpdates((items) => {\n      const updates = [];\n      \n      for (const item of items) {\n        // Only process feat items\n        if (item.type !== 'feat') {\n          continue;\n        }\n        \n        // Access the system data\n        const sourceSystem = item._source?.system || item.system;\n        \n        // Skip if already migrated\n        if (sourceSystem._rangeDiceToDisadvantageMigrationVersion === '13.0.12') {\n          totalSkipped++;\n          continue;\n        }\n        \n        // Check if any range has \"dice\" value\n        const hasDiceValue = \n          sourceSystem.meleeRange === 'dice' ||\n          sourceSystem.shortRange === 'dice' ||\n          sourceSystem.mediumRange === 'dice' ||\n          sourceSystem.longRange === 'dice';\n        \n        if (!hasDiceValue) {\n          // No \"dice\" values found, skip (don't mark as migrated to allow re-running)\n          totalSkipped++;\n          continue;\n        }\n        \n        // Build update object with converted values\n        const update = {\n          _id: item.id,\n          'system._rangeDiceToDisadvantageMigrationVersion': '13.0.12'\n        };\n        \n        if (sourceSystem.meleeRange === 'dice') {\n          update['system.meleeRange'] = 'disadvantage';\n        }\n        if (sourceSystem.shortRange === 'dice') {\n          update['system.shortRange'] = 'disadvantage';\n        }\n        if (sourceSystem.mediumRange === 'dice') {\n          update['system.mediumRange'] = 'disadvantage';\n        }\n        if (sourceSystem.longRange === 'dice') {\n          update['system.longRange'] = 'disadvantage';\n        }\n        \n        console.log(SYSTEM.LOG.HEAD + `Migration 13.0.12: Converting ranges for \"${item.name}\" (ID: ${item.id})`);\n        \n        updates.push(update);\n        totalUpdated++;\n      }\n      \n      return updates;\n    });\n    \n    // Summary message\n    const summaryMessage = `Migration 13.0.12 completed - Items updated: ${totalUpdated}, Skipped: ${totalSkipped}`;\n    console.log(SYSTEM.LOG.HEAD + summaryMessage);\n    \n    // Show user-friendly notification\n    if (totalUpdated > 0) {\n      const userMessage = game.i18n ? \n        game.i18n.format('SRA2.MIGRATION.13_0_12_INFO', { count: totalUpdated }) :\n        `Migration 13.0.12: Converted weapon ranges from \"dice\" to \"disadvantage\" for ${totalUpdated} item(s).`;\n      \n      ui.notifications?.info(userMessage, {permanent: false});\n      \n      console.log(SYSTEM.LOG.HEAD + \"✓ Migration complete.\");\n      console.log(SYSTEM.LOG.HEAD + \"✓ All weapon ranges now use 'disadvantage' instead of 'dice'\");\n    } else {\n      console.log(SYSTEM.LOG.HEAD + \"No items to migrate - all items already up to date\");\n    }\n  }\n}\n\n","import { SYSTEM } from \"./config/system.ts\";\nimport { setSidebarIcons, setControlIcons, setCompendiumBanners } from \"./config/ui-config.ts\";\n\n// Expose the SYSTEM object to the global scope\nglobalThis.SYSTEM = SYSTEM;\n\nimport * as models from \"./models/_module.ts\";\nimport * as documents from \"./documents/_module.ts\";\nimport * as applications from \"./applications/_module.ts\";\nimport * as CombatHelpers from \"./helpers/combat-helpers.ts\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migrations } from \"./migration/migration.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_3 } from \"./migration/migration-13.0.3.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_4 } from \"./migration/migration-13.0.4.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_5 } from \"./migration/migration-13.0.5.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_6 } from \"./migration/migration-13.0.6.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_7 } from \"./migration/migration-13.0.7.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_8 } from \"./migration/migration-13.0.8.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_9 } from \"./migration/migration-13.0.9.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_10 } from \"./migration/migration-13.0.10.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_11 } from \"./migration/migration-13.0.11.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { Migration_13_0_12 } from \"./migration/migration-13.0.12.mjs\";\n// @ts-ignore - JavaScript module without type declarations\nimport { HOOKS } from \"./hooks.mjs\";\n\nexport class SRA2System {\n  static start(): void {\n    new SRA2System();\n  }\n\n  constructor() {\n    if (game.system) {\n      game.system.sra2 = this;\n    }\n    Hooks.once('init', () => this.onInit());\n  }\n  \n  onInit(): void {\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onInit');\n    if (game.system) {\n      game.system.api = {\n        applications,\n        models,\n        documents,\n      };\n    }\n    \n    // Register theme setting\n    this.registerThemeSetting();\n    \n    // Configure UI elements (icons, banners)\n    setSidebarIcons();\n    setControlIcons();\n    setCompendiumBanners();\n    \n    // Register migrations\n    new Migrations();\n    Hooks.on(HOOKS.MIGRATIONS, (declareMigration: any) => {\n      declareMigration(new Migration_13_0_3());\n      declareMigration(new Migration_13_0_4());\n      declareMigration(new Migration_13_0_5());\n      declareMigration(new Migration_13_0_6());\n      declareMigration(new Migration_13_0_7());\n      declareMigration(new Migration_13_0_8());\n      declareMigration(new Migration_13_0_9());\n      declareMigration(new Migration_13_0_10());\n      declareMigration(new Migration_13_0_11());\n      declareMigration(new Migration_13_0_12());\n    });\n    \n    // Register custom Actor document class\n    CONFIG.Actor.documentClass = documents.SRA2Actor;\n    \n    // Register Actor data models\n    CONFIG.Actor.dataModels = {\n      character: models.CharacterDataModel,\n      vehicle: models.VehicleDataModel,\n    };\n    \n    // Register Item data models\n    CONFIG.Item.dataModels = {\n      skill: models.SkillDataModel,\n      feat: models.FeatDataModel,\n      specialization: models.SpecializationDataModel,\n      metatype: models.MetatypeDataModel,\n    };\n    \n    // Register character sheet (PC view - default)\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.CharacterSheet, {\n      types: [\"character\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.CHARACTER\"\n    });\n    \n    // Register NPC sheet (simplified view for same character type)\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.NpcSheet, {\n      types: [\"character\"],\n      makeDefault: false,\n      label: \"SRA2.SHEET.NPC\"\n    });\n    \n    // Register vehicle sheet\n    DocumentSheetConfig.registerSheet(Actor, \"sra2\", applications.VehicleSheet, {\n      types: [\"vehicle\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.VEHICLE\"\n    });\n    \n    // Register feat sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.FeatSheet, {\n      types: [\"feat\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.FEAT\"\n    });\n    \n    // Register skill sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SkillSheet, {\n      types: [\"skill\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.SKILL\"\n    });\n    \n    // Register specialization sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.SpecializationSheet, {\n      types: [\"specialization\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.SPECIALIZATION\"\n    });\n    \n    // Register metatype sheet\n    DocumentSheetConfig.registerSheet(Item, \"sra2\", applications.MetatypeSheet, {\n      types: [\"metatype\"],\n      makeDefault: true,\n      label: \"SRA2.SHEET.METATYPE\"\n    });\n    \n    // Register Handlebars helpers\n    Handlebars.registerHelper('add', function(a: number, b: number) {\n      return a + b;\n    });\n    \n    Handlebars.registerHelper('eq', function(a: any, b: any) {\n      return a === b;\n    });\n    \n    Handlebars.registerHelper('gt', function(a: any, b: any) {\n      return a > b;\n    });\n    \n    Handlebars.registerHelper('gte', function(a: any, b: any) {\n      return a >= b;\n    });\n    \n    Handlebars.registerHelper('concat', function(...args: any[]) {\n      // Remove the last argument which is the Handlebars options object\n      const values = args.slice(0, -1);\n      return values.join('');\n    });\n    \n    Handlebars.registerHelper('uppercase', function(str: string) {\n      return str ? str.toUpperCase() : '';\n    });\n    \n    // Helper to check if a dice result is a success based on roll mode\n    Handlebars.registerHelper('isSuccess', function(result: number, rollMode: string) {\n      if (rollMode === 'advantage') {\n        return result >= 4;\n      } else if (rollMode === 'disadvantage') {\n        return result === 6;\n      } else {\n        return result >= 5;\n      }\n    });\n    \n    // Helper to multiply two numbers\n    Handlebars.registerHelper('multiply', function(a: number, b: number) {\n      return a * b;\n    });\n    \n    // Helper to check if two values are not equal\n    Handlebars.registerHelper('ne', function(a: any, b: any) {\n      return a !== b;\n    });\n    \n    // Helper to stringify JSON\n    Handlebars.registerHelper('json', function(context: any) {\n      return JSON.stringify(context);\n    });\n    \n    // Register chat message hook for apply damage buttons\n    Hooks.on('renderChatMessage', (message: any, html: any) => {\n      // Remove existing handlers first to prevent duplicates\n      html.find('.apply-damage-button').off('click');\n      \n      html.find('.apply-damage-button').on('click', async (event: any) => {\n        event.preventDefault();\n        event.stopImmediatePropagation(); // Prevent other handlers from executing\n        \n        const button = $(event.currentTarget);\n        \n        // Check if button is already disabled to prevent double-clicks\n        if (button.prop('disabled')) {\n          return;\n        }\n        \n        // Template uses data-target-uuid, not data-defender-uuid\n        const targetUuid = button.data('target-uuid') || button.data('defender-uuid');\n        const damage = parseInt(button.data('damage')) || 0;\n        const targetName = button.data('target-name') || button.data('defender-name');\n        \n        if (!targetUuid) {\n          console.error('Apply damage button: No target UUID found in button data attributes');\n          ui.notifications?.error('Impossible de trouver la cible pour appliquer les dégâts');\n          return;\n        }\n        \n        if (damage <= 0) {\n          ui.notifications?.info('Aucun dégât à appliquer');\n          return;\n        }\n        \n        // Disable button to prevent double-click\n        button.prop('disabled', true);\n        \n        console.log('Apply damage button clicked:', { targetUuid, targetName, damage });\n        \n        try {\n          await CombatHelpers.applyDamage(targetUuid, damage, targetName);\n        } catch (error) {\n          console.error('Error applying damage:', error);\n          ui.notifications?.error('Erreur lors de l\\'application des dégâts');\n        } finally {\n          // Re-enable button after a short delay\n          setTimeout(() => button.prop('disabled', false), 1000);\n        }\n      });\n\n      // Defense button handler - remove existing handlers first to prevent duplicates\n      html.find('.defend-button').off('click');\n      \n      html.find('.defend-button').on('click', async (event: any) => {\n        event.preventDefault();\n        \n        // Get data from message flags (more reliable)\n        const messageFlags = message.flags?.sra2;\n        if (!messageFlags) {\n          console.error('Missing message flags');\n          return;\n        }\n\n        const rollResult = messageFlags.rollResult;\n        const rollData = messageFlags.rollData;\n        \n        if (!rollResult || !rollData) {\n          console.error('Missing roll data in message flags');\n          return;\n        }\n\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\n        let attackerToken: any = null;\n        let defenderToken: any = null;\n        let attacker: any = null;\n        let defender: any = null;\n        \n        // Log all flags for debugging\n        console.log('=== DEFENSE BUTTON - MESSAGE FLAGS ===');\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\n        console.log('======================================');\n        \n        // Use attacker UUID directly from flags (already correctly calculated)\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\n        if (messageFlags.attackerUuid) {\n          try {\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\n            if (attacker) {\n              console.log('Defense button: Attacker loaded directly from attackerUuid flag:', messageFlags.attackerUuid);\n            }\n          } catch (e) {\n            console.warn('Defense button: Failed to load attacker from attackerUuid flag:', e);\n          }\n        }\n        \n        // Get attacker token from UUID if available (priority: flag > canvas search)\n        if (messageFlags.attackerTokenUuid) {\n          try {\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\n            if (attackerToken?.actor && !attacker) {\n              // Use token's actor if attacker not loaded yet\n              attacker = attackerToken.actor;\n              console.log('Defense button: Attacker loaded from attackerTokenUuid flag, using token actor');\n            }\n          } catch (e) {\n            console.warn('Defense button: Failed to load attacker token from attackerTokenUuid flag:', e);\n          }\n        }\n        \n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\n        if (!attacker) {\n          if (messageFlags.attackerId) {\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\n          }\n          \n          if (attacker && !attackerToken) {\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\n            }) || null;\n          }\n        }\n        \n        // Use defender UUID directly from flags (already correctly calculated)\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\n        if (messageFlags.defenderUuid) {\n          try {\n            defender = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\n            if (defender) {\n              console.log('Defense button: Defender loaded directly from defenderUuid flag');\n            }\n          } catch (e) {\n            console.warn('Defense button: Failed to load defender from defenderUuid flag:', e);\n          }\n        }\n        \n        // Get defender token from UUID if available (priority: flag > canvas search)\n        if (messageFlags.defenderTokenUuid) {\n          try {\n            defenderToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\n            if (defenderToken?.actor && !defender) {\n              // Use token's actor if defender not loaded yet\n              defender = defenderToken.actor;\n              console.log('Defense button: Defender loaded from defenderTokenUuid flag, using token actor');\n            }\n          } catch (e) {\n            console.warn('Defense button: Failed to load defender token from defenderTokenUuid flag:', e);\n          }\n        }\n        \n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\n        if (!defender) {\n          if (messageFlags.defenderId) {\n            defender = game.actors?.get(messageFlags.defenderId) || null;\n          }\n          \n          if (defender && !defenderToken) {\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\n            }) || null;\n          }\n        }\n\n        // Extract information - use UUIDs directly from flags as they are already correctly calculated\n        const success = rollResult.totalSuccesses || 0;\n        const damage = rollData.damageValue || 0;\n        const attackerName = attacker?.name || 'Unknown';\n        const attackerId = attacker?.id || messageFlags.attackerId || 'Unknown';\n        const attackerUuid = messageFlags.attackerUuid || attacker?.uuid || 'Unknown'; // Use flag UUID first (already calculated correctly)\n        const defenderName = defender?.name || 'Unknown';\n        const defenderId = defender?.id || messageFlags.defenderId || 'Unknown';\n        const defenderUuid = messageFlags.defenderUuid || defender?.uuid || 'Unknown'; // Use flag UUID first (already calculated correctly)\n        \n        // Log the UUIDs that will be used\n        console.log('--- UUIDs being used from flags ---');\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\n        const defenseSkill = rollData.linkedDefenseSkill || null;\n        const defenseSpec = rollData.linkedDefenseSpecialization || null;\n        const attackSkill = rollData.linkedAttackSkill || rollData.skillName || null;\n        const attackSpec = rollData.linkedAttackSpecialization || rollData.specName || null;\n\n        // Console log all information\n        console.log('=== DEFENSE CLICK ===');\n        console.log('Success:', success);\n        console.log('Damage:', damage);\n        console.log('Attacker:', attackerName);\n        console.log('Attacker ID:', attackerId);\n        console.log('Attacker UUID:', attackerUuid);\n        console.log('Attacker Token UUID:', attackerToken?.uuid || attackerToken?.document?.uuid || 'Unknown');\n        console.log('Defender:', defenderName);\n        console.log('Defender ID:', defenderId);\n        console.log('Defender UUID:', defenderUuid);\n        console.log('Defender Token UUID:', defenderToken?.uuid || defenderToken?.document?.uuid || 'Unknown');\n        console.log('Skill de defense:', defenseSkill);\n        console.log('Spe de defense:', defenseSpec);\n        console.log('Skill d\\'attaque:', attackSkill);\n        console.log('Spe d\\'attaque:', attackSpec);\n        console.log('===================');\n\n        // Open defense roll dialog\n        if (!defender || !defenseSkill) {\n          console.error('Missing defender or defense skill');\n          return;\n        }\n\n        // Get defender token from UUID (for NPCs, we need the token instance)\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\n        let defenderTokenForRoll: any = null;\n        let defenderActorForRoll: any = defender; // Default to defender actor\n        \n        const defenderTokenUuidFromFlags = messageFlags.defenderTokenUuid;\n        if (defenderTokenUuidFromFlags) {\n          try {\n            defenderTokenForRoll = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidFromFlags) || null;\n            // For NPCs, use the token's actor (which may be different from the base actor)\n            if (defenderTokenForRoll?.actor) {\n              defenderActorForRoll = defenderTokenForRoll.actor;\n            }\n          } catch (e) {\n            // Fallback to finding token on canvas\n            defenderTokenForRoll = defenderToken;\n            if (defenderToken?.actor) {\n              defenderActorForRoll = defenderToken.actor;\n            }\n          }\n        } else {\n          defenderTokenForRoll = defenderToken;\n          if (defenderToken?.actor) {\n            defenderActorForRoll = defenderToken.actor;\n          }\n        }\n\n        // Determine which skill/spec to use for defense\n        // Priority: 1) attack spec from weapon (if using weapon for defense), 2) defenseSpec if found, 3) defenseSkill if found, 4) fallback based on attack type\n        let finalDefenseSkill: string | null = null;\n        let finalDefenseSpec: string | null = null;\n        \n        // First, try to use the attack specialization from the weapon (if defending with a weapon)\n        // This allows using \"Lames\" specialization when defending with a short weapon\n        // Priority: use attack spec over defense spec when defending with a weapon\n        if (attackSpec) {\n          // Check if this attack spec exists in the defender's items and is linked to \"Combat rapproché\"\n          const spec = defenderActorForRoll.items.find((item: any) => {\n            if (item.type !== 'specialization') return false;\n            const specSystem = item.system as any;\n            return item.name === attackSpec && specSystem.linkedSkill === 'Combat rapproché';\n          });\n          if (spec) {\n            finalDefenseSpec = spec.name;\n            const specSystem = spec.system as any;\n            finalDefenseSkill = specSystem.linkedSkill;\n          }\n        }\n        \n        // Try to find the defense spec (from weapon's linkedDefenseSpecialization)\n        if (!finalDefenseSpec && defenseSpec) {\n          const spec = defenderActorForRoll.items.find((item: any) => \n            item.type === 'specialization' && item.name === defenseSpec\n          );\n          if (spec) {\n            finalDefenseSpec = defenseSpec;\n            const specSystem = spec.system as any;\n            const linkedSkillName = specSystem.linkedSkill;\n            finalDefenseSkill = linkedSkillName;\n          }\n        }\n        \n        // If spec not found, try to find the defense skill\n        if (!finalDefenseSpec && defenseSkill) {\n          const skill = defenderActorForRoll.items.find((item: any) => \n            item.type === 'skill' && item.name === defenseSkill\n          );\n          if (skill) {\n            finalDefenseSkill = defenseSkill;\n          }\n        }\n        \n        // Fallback: determine based on attack type (melee or ranged)\n        if (!finalDefenseSkill) {\n          // Check if it's a melee attack (check meleeRange in rollData)\n          const isMeleeAttack = rollData.meleeRange && rollData.meleeRange !== 'none';\n          if (isMeleeAttack) {\n            finalDefenseSkill = 'Combat rapproché';\n          } else {\n            finalDefenseSkill = 'Athlétisme';\n          }\n        }\n\n        // Calculate skill/spec levels for defender (use token's actor for NPCs)\n        let defenseSkillLevel: number | undefined = undefined;\n        let defenseSpecLevel: number | undefined = undefined;\n        let defenseLinkedAttribute: string | undefined = undefined;\n\n        if (finalDefenseSpec) {\n          const spec = defenderActorForRoll.items.find((item: any) => \n            item.type === 'specialization' && item.name === finalDefenseSpec\n          );\n          if (spec) {\n            const specSystem = spec.system as any;\n            const linkedSkillName = specSystem.linkedSkill;\n            const linkedSkill = defenderActorForRoll.items.find((item: any) => \n              item.type === 'skill' && item.name === linkedSkillName\n            );\n            if (linkedSkill) {\n              const skillRating = (linkedSkill.system as any).rating || 0;\n              const specRating = specSystem.rating || 0;\n              defenseLinkedAttribute = specSystem.linkedAttribute || (linkedSkill.system as any).linkedAttribute || 'strength';\n              const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\n              \n              defenseSkillLevel = attributeValue + skillRating;\n              defenseSpecLevel = defenseSkillLevel + specRating;\n            }\n          }\n        } else if (finalDefenseSkill) {\n          const skill = defenderActorForRoll.items.find((item: any) => \n            item.type === 'skill' && item.name === finalDefenseSkill\n          );\n          if (skill) {\n            const skillSystem = skill.system as any;\n            const skillRating = skillSystem.rating || 0;\n            defenseLinkedAttribute = skillSystem.linkedAttribute || 'strength';\n            const attributeValue = defenseLinkedAttribute ? ((defenderActorForRoll.system as any)?.attributes?.[defenseLinkedAttribute] || 0) : 0;\n            \n            defenseSkillLevel = attributeValue + skillRating;\n          }\n        }\n\n        // Get RR sources for defense skill/spec (use token's actor for NPCs)\n        const { getRRSources } = await import('./helpers/sheet-helpers.js');\n        let defenseRRList: any[] = [];\n        if (finalDefenseSpec) {\n          const rrSources = getRRSources(defenderActorForRoll, 'specialization', finalDefenseSpec);\n          defenseRRList = rrSources.map((rr: any) => ({\n            ...rr,\n            featName: rr.featName\n          }));\n        } else if (finalDefenseSkill) {\n          const rrSources = getRRSources(defenderActorForRoll, 'skill', finalDefenseSkill);\n          defenseRRList = rrSources.map((rr: any) => ({\n            ...rr,\n            featName: rr.featName\n          }));\n        }\n\n        // Get token UUIDs\n        // For defense: attacker = defender (one defending), defender = original attacker\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || messageFlags.attackerTokenUuid || undefined;\n        const defenderTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || messageFlags.defenderTokenUuid || undefined;\n        \n        // Prepare defense roll data\n        // In defense context:\n        // - attacker = defender (one defending) -> attackerTokenUuid should be defender's token\n        // - defender = original attacker -> defenderTokenUuid should be original attacker's token\n        const defenseRollData: any = {\n          // Use final defense skill/spec (with fallback)\n          skillName: finalDefenseSkill,\n          specName: finalDefenseSpec,\n          linkedAttribute: defenseLinkedAttribute,\n          skillLevel: defenseSkillLevel,\n          specLevel: defenseSpecLevel,\n          \n          // Actor is the defender - use UUID directly from flags (already correctly calculated)\n          actorId: defenderActorForRoll.id,\n          actorUuid: messageFlags.defenderUuid || defenderActorForRoll.uuid, // Use flag UUID first\n          \n          // Token UUIDs - for defense, attackerToken is the defender's token, defenderToken is the original attacker's token\n          attackerTokenUuid: defenderTokenUuid, // Defender's token (one defending) - this is what will be attacker in RollDialog\n          defenderTokenUuid: originalAttackerTokenUuid, // Original attacker's token (target) - this is what will be target/defender in RollDialog\n          \n          // RR List\n          rrList: defenseRRList,\n          \n          // Defense flags\n          isDefend: true,\n          isCounterAttack: false,\n          \n          // Store original attack roll data for comparison\n          attackRollResult: rollResult,\n          attackRollData: rollData\n        };\n\n        // Import and open RollDialog\n        const { RollDialog } = await import('./applications/roll-dialog.js');\n        const dialog = new RollDialog(defenseRollData);\n        \n        // Set target token to original attacker's token (in defense context, target = original attacker)\n        if (attackerToken) {\n          (dialog as any).targetToken = attackerToken;\n        }\n        \n        dialog.render(true);\n      });\n\n      // Counter-attack button handler - remove existing handlers first to prevent duplicates\n      html.find('.counter-attack-button').off('click');\n      \n      html.find('.counter-attack-button').on('click', async (event: any) => {\n        event.preventDefault();\n        \n        // Get data from message flags (more reliable)\n        const messageFlags = message.flags?.sra2;\n        if (!messageFlags) {\n          console.error('Missing message flags');\n          return;\n        }\n\n        const rollResult = messageFlags.rollResult;\n        const rollData = messageFlags.rollData;\n        \n        if (!rollResult || !rollData) {\n          console.error('Missing roll data in message flags');\n          return;\n        }\n\n        // Get tokens from flags (priority: token UUID > actor UUID > actor ID)\n        let attackerToken: any = null;\n        let defenderToken: any = null;\n        let attacker: any = null;\n        let defender: any = null;\n        \n        // Log all flags for debugging\n        console.log('=== COUNTER-ATTACK BUTTON - MESSAGE FLAGS ===');\n        console.log('attackerUuid flag:', messageFlags.attackerUuid || 'Not set');\n        console.log('attackerTokenUuid flag:', messageFlags.attackerTokenUuid || 'Not set');\n        console.log('attackerId flag:', messageFlags.attackerId || 'Not set');\n        console.log('defenderUuid flag:', messageFlags.defenderUuid || 'Not set');\n        console.log('defenderTokenUuid flag:', messageFlags.defenderTokenUuid || 'Not set');\n        console.log('defenderId flag:', messageFlags.defenderId || 'Not set');\n        console.log('==============================================');\n        \n        // Use attacker UUID directly from flags (already correctly calculated)\n        // Priority: 1) attackerUuid from flags (already calculated correctly), 2) attackerTokenUuid from flags\n        if (messageFlags.attackerUuid) {\n          try {\n            attacker = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerUuid) || null;\n            if (attacker) {\n              console.log('Counter-attack button: Attacker loaded directly from attackerUuid flag');\n            }\n          } catch (e) {\n            console.warn('Counter-attack button: Failed to load attacker from attackerUuid flag:', e);\n          }\n        }\n        \n        // Get attacker token from UUID if available (priority: flag > canvas search)\n        if (messageFlags.attackerTokenUuid) {\n          try {\n            attackerToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.attackerTokenUuid) || null;\n            if (attackerToken?.actor && !attacker) {\n              // Use token's actor if attacker not loaded yet\n              attacker = attackerToken.actor;\n              console.log('Counter-attack button: Attacker loaded from attackerTokenUuid flag, using token actor');\n            }\n          } catch (e) {\n            console.warn('Counter-attack button: Failed to load attacker token from attackerTokenUuid flag:', e);\n          }\n        }\n        \n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\n        if (!attacker) {\n          if (messageFlags.attackerId) {\n            attacker = game.actors?.get(messageFlags.attackerId) || null;\n          }\n          \n          if (attacker && !attackerToken) {\n            attackerToken = canvas?.tokens?.placeables?.find((token: any) => {\n              return token.actor?.id === attacker.id || token.actor?.uuid === attacker.uuid;\n            }) || null;\n          }\n        }\n        \n        // Use defender UUID directly from flags (already correctly calculated)\n        // Priority: 1) defenderUuid from flags (already calculated correctly), 2) defenderTokenUuid from flags\n        if (messageFlags.defenderUuid) {\n          try {\n            defender = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderUuid) || null;\n            if (defender) {\n              console.log('Counter-attack button: Defender loaded directly from defenderUuid flag');\n            }\n          } catch (e) {\n            console.warn('Counter-attack button: Failed to load defender from defenderUuid flag:', e);\n          }\n        }\n        \n        // Get defender token from UUID if available (priority: flag > canvas search)\n        if (messageFlags.defenderTokenUuid) {\n          try {\n            defenderToken = (foundry.utils as any)?.fromUuidSync?.(messageFlags.defenderTokenUuid) || null;\n            if (defenderToken?.actor && !defender) {\n              // Use token's actor if defender not loaded yet\n              defender = defenderToken.actor;\n              console.log('Counter-attack button: Defender loaded from defenderTokenUuid flag, using token actor');\n            }\n          } catch (e) {\n            console.warn('Counter-attack button: Failed to load defender token from defenderTokenUuid flag:', e);\n          }\n        }\n        \n        // Fallback: try to get actor and find token on canvas (only if flags didn't work)\n        if (!defender) {\n          if (messageFlags.defenderId) {\n            defender = game.actors?.get(messageFlags.defenderId) || null;\n          }\n          \n          if (defender && !defenderToken) {\n            defenderToken = canvas?.tokens?.placeables?.find((token: any) => {\n              return token.actor?.id === defender.id || token.actor?.uuid === defender.uuid;\n            }) || null;\n          }\n        }\n\n        // Log the UUIDs that will be used\n        console.log('--- UUIDs being used from flags (counter-attack) ---');\n        console.log('attackerUuid (from flag):', messageFlags.attackerUuid || 'Not in flag, using:', attacker?.uuid || 'Unknown');\n        console.log('defenderUuid (from flag):', messageFlags.defenderUuid || 'Not in flag, using:', defender?.uuid || 'Unknown');\n        console.log('attackerTokenUuid (from flag):', messageFlags.attackerTokenUuid || 'Not in flag');\n        console.log('defenderTokenUuid (from flag):', messageFlags.defenderTokenUuid || 'Not in flag');\n        console.log('attacker loaded:', attacker ? `${attacker.name} (${attacker.uuid})` : 'Not loaded');\n        console.log('defender loaded:', defender ? `${defender.name} (${defender.uuid})` : 'Not loaded');\n        console.log('attackerToken loaded:', attackerToken ? `Found (${attackerToken.uuid || attackerToken.document?.uuid})` : 'Not loaded');\n        console.log('defenderToken loaded:', defenderToken ? `Found (${defenderToken.uuid || defenderToken.document?.uuid})` : 'Not loaded');\n        \n        // Open counter-attack roll dialog\n        if (!defender) {\n          console.error('Missing defender');\n          return;\n        }\n\n        // Get defender token from UUID (for NPCs, we need the token instance)\n        // For NPCs, the actor is linked to the token, so we need to use the token's actor\n        // Use defenderTokenUuid directly from flags (already correctly calculated)\n        let defenderTokenForRoll: any = null;\n        let defenderActorForRoll: any = defender; // Default to defender actor\n        \n        const defenderTokenUuidForCounter = messageFlags.defenderTokenUuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\n        if (defenderTokenUuidForCounter) {\n          try {\n            defenderTokenForRoll = (foundry.utils as any)?.fromUuidSync?.(defenderTokenUuidForCounter) || null;\n            // For NPCs, use the token's actor (which may be different from the base actor)\n            if (defenderTokenForRoll?.actor) {\n              defenderActorForRoll = defenderTokenForRoll.actor;\n            }\n          } catch (e) {\n            // Fallback to finding token on canvas\n            defenderTokenForRoll = defenderToken;\n            if (defenderToken?.actor) {\n              defenderActorForRoll = defenderToken.actor;\n            }\n          }\n        } else {\n          defenderTokenForRoll = defenderToken;\n          if (defenderToken?.actor) {\n            defenderActorForRoll = defenderToken.actor;\n          }\n        }\n\n        // Get all weapons from defender's items for counter-attack\n        // Get all items of type 'feat' with featType 'weapon' or 'weapons-spells'\n        const allWeapons = defenderActorForRoll.items.filter((item: any) => {\n          const isFeat = item.type === 'feat';\n          const isWeapon = item.system?.featType === 'weapon' || item.system?.featType === 'weapons-spells';\n          return isFeat && isWeapon;\n        });\n\n        // Import WEAPON_TYPES to check melee capability\n        const { WEAPON_TYPES } = await import('./models/item-feat.js');\n        \n        // Filter weapons that:\n        // 1. Have melee \"ok\" or \"disadvantage\"\n        // 2. Are linked to \"Combat rapproché\" skill or a specialization of \"Combat rapproché\"\n        const defenderWeapons = allWeapons.filter((weapon: any) => {\n          const weaponSystem = weapon.system as any;\n          const weaponType = weaponSystem.weaponType;\n          \n          // Check meleeRange in weapon system\n          const meleeRange = weaponSystem.meleeRange || 'none';\n          const hasMeleeInSystem = meleeRange === 'ok' || meleeRange === 'disadvantage';\n          \n          // Check melee in weapon type\n          let hasMeleeInType = false;\n          if (weaponType && weaponType !== 'custom-weapon') {\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n            if (weaponStats && weaponStats.melee) {\n              hasMeleeInType = weaponStats.melee === 'ok' || weaponStats.melee === 'disadvantage';\n            }\n          }\n          \n          // Must have melee capability\n          if (!hasMeleeInSystem && !hasMeleeInType) {\n            return false;\n          }\n          \n          // Get linked attack skill\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\n\n          // If no linkedAttackSkill, try to get it from weapon type\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n            if (weaponStats) {\n              linkedAttackSkill = weaponStats.linkedSkill;\n            }\n          }\n          \n          // Must be linked to \"Combat rapproché\" skill\n          if (linkedAttackSkill === 'Combat rapproché') {\n            return true;\n          }\n          \n          // Check if weapon has a specialization linked to \"Combat rapproché\"\n          // Look for specializations linked to \"Combat rapproché\" in the actor's items\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \n            item.type === 'specialization' && \n            item.system.linkedSkill === 'Combat rapproché'\n          );\n          \n          // Check if weapon's linkedAttackSkill matches any specialization name\n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \n              spec.name === linkedAttackSkill\n            );\n            if (hasCombatRapprocheSpec) {\n              return true;\n            }\n          }\n          \n          // Also check weapon's linkedAttackSpecialization\n          const linkedAttackSpecialization = weaponSystem.linkedAttackSpecialization;\n          if (linkedAttackSpecialization) {\n            const hasCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \n              spec.name === linkedAttackSpecialization\n            );\n            if (hasCombatRapprocheSpec) {\n              return true;\n            }\n          }\n          \n          return false;\n        });\n\n        console.log('Counter-attack: Filtered weapons with melee capability:', defenderWeapons.length, defenderWeapons.map((w: any) => ({\n          name: w.name,\n          meleeRange: w.system?.meleeRange,\n          weaponType: w.system?.weaponType,\n          meleeInType: w.system?.weaponType ? WEAPON_TYPES[w.system.weaponType as keyof typeof WEAPON_TYPES]?.melee : null\n        })));\n\n        if (defenderWeapons.length === 0) {\n          console.error('Counter-attack: No weapons with melee capability. All items:', defenderActorForRoll.items.map((i: any) => ({\n            name: i.name,\n            type: i.type,\n            featType: i.system?.featType,\n            meleeRange: i.system?.meleeRange,\n            weaponType: i.system?.weaponType\n          })));\n          ui.notifications?.warn(game.i18n!.localize('SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPONS') || 'Aucune arme disponible pour la contre-attaque');\n          return;\n        }\n\n        // Prepare available weapons data for RollDialog\n        const availableWeapons = defenderWeapons.map((weapon: any) => {\n          const weaponSystem = weapon.system as any;\n          const weaponType = weaponSystem.weaponType;\n          let linkedAttackSkill = weaponSystem.linkedAttackSkill;\n          \n          // If no linkedAttackSkill, try to get it from weapon type\n          if (!linkedAttackSkill && weaponType && weaponType !== 'custom-weapon') {\n            const weaponStats = WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES];\n            if (weaponStats) {\n              linkedAttackSkill = weaponStats.linkedSkill;\n            }\n        }\n\n          // Check if linkedAttackSkill is a specialization of \"Combat rapproché\"\n          const combatRapprocheSpecs = defenderActorForRoll.items.filter((item: any) => \n            item.type === 'specialization' && \n            item.system.linkedSkill === 'Combat rapproché'\n          );\n          \n          if (linkedAttackSkill && combatRapprocheSpecs.length > 0) {\n            const isCombatRapprocheSpec = combatRapprocheSpecs.some((spec: any) => \n              spec.name === linkedAttackSkill\n            );\n            if (isCombatRapprocheSpec) {\n              // Keep the specialization name, but the skill is \"Combat rapproché\"\n              // We'll use this in the weapon selection to show both\n            } else if (linkedAttackSkill !== 'Combat rapproché') {\n              // Not a specialization of Combat rapproché, use \"Combat rapproché\" as base skill\n              linkedAttackSkill = 'Combat rapproché';\n            }\n          } else {\n            // Default to \"Combat rapproché\" if still no skill\n            linkedAttackSkill = 'Combat rapproché';\n          }\n          \n          // Get weapon stats from WEAPON_TYPES if weapon type exists\n          const weaponStats = weaponType && weaponType !== 'custom-weapon' \n            ? WEAPON_TYPES[weaponType as keyof typeof WEAPON_TYPES] \n            : undefined;\n          \n          return {\n            id: weapon.id,\n            name: weapon.name,\n            linkedAttackSkill: linkedAttackSkill,\n            damageValue: weaponSystem.damageValue || '0',\n            damageValueBonus: weaponSystem.damageValueBonus || 0,\n            weaponType: weaponType,\n            meleeRange: weaponSystem.meleeRange || weaponStats?.melee || 'none',\n            shortRange: weaponSystem.shortRange || weaponStats?.short || 'none',\n            mediumRange: weaponSystem.mediumRange || weaponStats?.medium || 'none',\n            longRange: weaponSystem.longRange || weaponStats?.long || 'none'\n          };\n        });\n\n        // Get token UUIDs\n        const counterAttackerTokenUuid = defenderTokenForRoll?.uuid || defenderTokenForRoll?.document?.uuid || defenderToken?.uuid || defenderToken?.document?.uuid || undefined;\n        const originalAttackerTokenUuid = attackerToken?.uuid || attackerToken?.document?.uuid || undefined;\n        \n        // Prepare counter-attack roll data with available weapons\n        // Use UUIDs directly from flags (already correctly calculated)\n        const counterAttackRollData: any = {\n          // Actor is the defender - use UUID directly from flags (already correctly calculated)\n          actorId: defenderActorForRoll.id,\n          actorUuid: messageFlags.defenderUuid || defenderActorForRoll.uuid, // Use flag UUID first\n          \n          // Token UUIDs - for counter-attack, the defender becomes the attacker\n          // Use UUIDs directly from flags (already correctly calculated)\n          attackerTokenUuid: messageFlags.defenderTokenUuid || counterAttackerTokenUuid, // Token of the defender (who is counter-attacking)\n          defenderTokenUuid: messageFlags.attackerTokenUuid || originalAttackerTokenUuid, // Token of the original attacker\n          \n          // Available weapons for selection\n          availableWeapons: availableWeapons,\n          \n          // Counter-attack flags\n          isDefend: false,\n          isCounterAttack: true,\n          \n          // Store original attack roll data for comparison\n          attackRollResult: rollResult,\n          attackRollData: rollData\n        };\n\n        // Import and open RollDialog\n        const { RollDialog } = await import('./applications/roll-dialog.js');\n        const dialog = new RollDialog(counterAttackRollData);\n        \n        // Note: targetToken should already be loaded from defenderTokenUuid in RollDialog constructor\n        // Only set it manually if it wasn't loaded from UUID (fallback)\n        if (attackerToken && !(dialog as any).targetToken) {\n          (dialog as any).targetToken = attackerToken;\n        }\n        \n        dialog.render(true);\n      });\n    });\n    \n    // Register token context menu hook for bookmarks/favorites\n    (Hooks as any).on('getTokenHUDOptions', (_hud: any, buttons: any[], token: any) => {\n      const actor = token.actor;\n      if (!actor) return;\n      \n      // Get bookmarked items\n      const bookmarkedItems = actor.items.filter((i: any) => \n        (i.type === 'skill' || i.type === 'feat') && i.system.bookmarked\n      );\n      \n      if (bookmarkedItems.length > 0) {\n        buttons.unshift({\n          name: 'SRA2_BOOKMARKS',\n          title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE'),\n          icon: 'fa-solid fa-star',\n          button: true,\n          onclick: () => {\n            // Show bookmarks dialog\n            this.showBookmarksDialog(actor);\n          }\n        });\n      }\n    });\n    \n    Hooks.once(\"ready\", () => this.onReady());\n  }\n  \n  /**\n   * Show bookmarks/favorites dialog for quick actions\n   */\n  showBookmarksDialog(actor: any): void {\n    const bookmarkedSkills = actor.items.filter((i: any) => i.type === 'skill' && i.system.bookmarked);\n    const bookmarkedFeats = actor.items.filter((i: any) => i.type === 'feat' && i.system.bookmarked);\n    \n    let content = '<div class=\"sra2-bookmark-menu\">';\n    \n    if (bookmarkedSkills.length > 0) {\n      content += '<h3>' + game.i18n!.localize('SRA2.SKILLS.LABEL') + '</h3>';\n      content += '<div class=\"bookmark-list\">';\n      bookmarkedSkills.forEach((skill: any) => {\n        content += `<button class=\"bookmark-item\" data-item-id=\"${skill.id}\" data-item-type=\"skill\">\n          <i class=\"fas fa-dice-d6\"></i> ${skill.name}\n        </button>`;\n      });\n      content += '</div>';\n    }\n    \n    if (bookmarkedFeats.length > 0) {\n      content += '<h3>' + game.i18n!.localize('SRA2.FEATS.LABEL') + '</h3>';\n      content += '<div class=\"bookmark-list\">';\n      bookmarkedFeats.forEach((feat: any) => {\n        content += `<button class=\"bookmark-item\" data-item-id=\"${feat.id}\" data-item-type=\"feat\">\n          <i class=\"fas fa-scroll\"></i> ${feat.name}\n        </button>`;\n      });\n      content += '</div>';\n    }\n    \n    content += '</div>';\n    \n    new Dialog({\n      title: game.i18n!.localize('SRA2.BOOKMARKS.TITLE') + ' - ' + actor.name,\n      content,\n      buttons: {\n        close: {\n          icon: '<i class=\"fas fa-times\"></i>',\n          label: game.i18n!.localize('Close')\n        }\n      },\n      render: (html: any) => {\n        html.find('.bookmark-item').on('click', async (event: any) => {\n          const itemId = $(event.currentTarget).data('item-id');\n          const item = actor.items.get(itemId);\n          if (!item) return;\n          \n          // Open item sheet\n          item.sheet?.render(true);\n        });\n      }\n    }, { width: 350 }).render(true);\n  }\n\n  /**\n   * Register the UI theme setting\n   */\n  registerThemeSetting(): void {\n    game.settings.register(SYSTEM.id, 'uiTheme', {\n      name: 'SRA2.SETTINGS.THEME.TITLE',\n      hint: 'SRA2.SETTINGS.THEME.DESC',\n      scope: 'client',\n      config: true,\n      type: String,\n      choices: () => {\n        return {\n          'sra2': game.i18n.localize('SRA2.SETTINGS.THEME.SRA2'),\n        };\n      },\n      default: 'sra2',\n      onChange: (value: string) => {\n        this.applyTheme(value);\n      }\n    });\n  }\n\n  /**\n   * Apply the selected theme to the body element\n   */\n  applyTheme(theme?: string): void {\n    if (!document.body) {\n      console.warn(SYSTEM.LOG.HEAD + 'Cannot apply theme: document.body is not available');\n      return;\n    }\n\n    // Get theme from setting if not provided\n    if (!theme) {\n      theme = game.settings.get(SYSTEM.id, 'uiTheme') as string || 'sra2';\n    }\n\n    // List of all possible theme classes\n    const themeClasses = ['sr-theme-sra2', 'sr-theme-sr6', 'sr-theme-sr5'];\n\n    // Remove all theme classes\n    document.body.classList.remove(...themeClasses);\n\n    // Add the selected theme class\n    const themeClass = `sr-theme-${theme}`;\n    document.body.classList.add(themeClass);\n\n    console.log(SYSTEM.LOG.HEAD + `Applied theme: ${themeClass}`);\n  }\n\n  async onReady(): Promise<void> {\n    console.log(SYSTEM.LOG.HEAD + 'SRA2System.onReady');\n    \n    // Apply theme from setting\n    this.applyTheme();\n    \n    // Run migrations\n    const migrations = new Migrations();\n    migrations.migrate();\n    \n    // Migrate old feat data to new array format (deprecated, keeping for older versions)\n    await this.migrateFeatsToArrayFormat();\n    \n    // Migrate anarchyNimbus to anarchySpent\n    await this.migrateAnarchyNimbusToSpent();\n  }\n  \n  /**\n   * Migrate old feat data (single rrType/rrValue/rrTarget) to new array format\n   */\n  async migrateFeatsToArrayFormat(): Promise<void> {\n    const featsToUpdate: any[] = [];\n    \n    // Check all feats in the world\n    for (const item of game.items! as any) {\n      if ((item as any).type === 'feat') {\n        const system = (item as any).system as any;\n        let needsUpdate = false;\n        const updates: any = { _id: (item as any).id };\n        \n        // Check if rrType is not an array (old format)\n        if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\n          needsUpdate = true;\n          // Convert single value to array (only if not \"none\")\n          if (system.rrType !== 'none') {\n            updates['system.rrType'] = [system.rrType];\n            updates['system.rrValue'] = [system.rrValue || 0];\n            updates['system.rrTarget'] = [system.rrTarget || ''];\n          } else {\n            updates['system.rrType'] = [];\n            updates['system.rrValue'] = [];\n            updates['system.rrTarget'] = [];\n          }\n        }\n        \n        if (needsUpdate) {\n          featsToUpdate.push(updates);\n        }\n      }\n    }\n    \n    // Check all feats on actors\n    for (const actor of game.actors! as any) {\n      const actorUpdates: any[] = [];\n      \n      for (const item of (actor as any).items) {\n        if ((item as any).type === 'feat') {\n          const system = (item as any).system as any;\n          let needsUpdate = false;\n          const updates: any = { _id: (item as any).id };\n          \n          // Check if rrType is not an array (old format)\n          if (system.rrType !== undefined && !Array.isArray(system.rrType)) {\n            needsUpdate = true;\n            // Convert single value to array (only if not \"none\")\n            if (system.rrType !== 'none') {\n              updates['system.rrType'] = [system.rrType];\n              updates['system.rrValue'] = [system.rrValue || 0];\n              updates['system.rrTarget'] = [system.rrTarget || ''];\n            } else {\n              updates['system.rrType'] = [];\n              updates['system.rrValue'] = [];\n              updates['system.rrTarget'] = [];\n            }\n          }\n          \n          if (needsUpdate) {\n            actorUpdates.push(updates);\n          }\n        }\n      }\n      \n      if (actorUpdates.length > 0) {\n        console.log(`${SYSTEM.LOG.HEAD} Migrating ${actorUpdates.length} feats on actor ${(actor as any).name}`);\n        await (actor as any).updateEmbeddedDocuments('Item', actorUpdates);\n      }\n    }\n    \n    if (featsToUpdate.length > 0) {\n      console.log(`${SYSTEM.LOG.HEAD} Migrating ${featsToUpdate.length} world feats`);\n      await Item.updateDocuments(featsToUpdate);\n    }\n    \n    if (featsToUpdate.length > 0 || (game.actors! as any).some((a: any) => a.items.some((i: any) => i.type === 'feat'))) {\n      console.log(`${SYSTEM.LOG.HEAD} Feat migration to array format complete`);\n    }\n  }\n  \n  /**\n   * Migrate anarchyNimbus to anarchySpent\n   */\n  async migrateAnarchyNimbusToSpent(): Promise<void> {\n    const actorsToUpdate: any[] = [];\n    \n    // Check all character actors in the world\n    for (const actor of game.actors! as any) {\n      if ((actor as any).type === 'character') {\n        const system = (actor as any).system as any;\n        \n        // Check if the old anarchyNimbus field exists\n        if (system.anarchyNimbus !== undefined && system.anarchySpent === undefined) {\n          actorsToUpdate.push({\n            _id: (actor as any).id,\n            'system.anarchySpent': system.anarchyNimbus\n          });\n        }\n      }\n    }\n    \n    if (actorsToUpdate.length > 0) {\n      console.log(`${SYSTEM.LOG.HEAD} Migrating anarchyNimbus to anarchySpent for ${actorsToUpdate.length} actors`);\n      await Actor.updateDocuments(actorsToUpdate);\n      console.log(`${SYSTEM.LOG.HEAD} anarchyNimbus to anarchySpent migration complete`);\n    }\n  }\n}\n\n","import { SRA2System } from \"./module/sra2-system.ts\";\n\nSRA2System.start();\n\nimport \"./styles/global.scss\";\nimport \"./less/index.less\";\n\n"],"names":["SYSTEM","documents","ItemSearch.normalizeSearchText","normalizeSearchText","WEAPON_TYPES","SheetHelpers.enrichFeats","SheetHelpers.calculateFinalDamageValue","SheetHelpers.organizeSpecializationsBySkill","SheetHelpers.handleSheetUpdate","SheetHelpers.handleEditItem","SheetHelpers.handleDeleteItem","SheetHelpers.getRRSources","SheetHelpers.calculateRR","DiceRoller.handleRollRequest","CombatHelpers.applyDamage","SheetHelpers.handleItemDrop","ItemSearch.itemExistsOnActor","ItemSearch.searchItemsEverywhere","activeFeats","getRRSources","CombatHelpers.prepareVehicleWeaponRollRequest","section","i","rrSources","executeRoll","message","update","documents.SRA2Actor","models.CharacterDataModel","models.VehicleDataModel","models.SkillDataModel","models.FeatDataModel","models.SpecializationDataModel","models.MetatypeDataModel","applications.CharacterSheet","applications.NpcSheet","applications.VehicleSheet","applications.FeatSheet","applications.SkillSheet","applications.SpecializationSheet","applications.MetatypeSheet","RollDialog","weaponStats"],"mappings":"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"}