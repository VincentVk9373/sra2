const e="sra2",t={id:e,LOG:{HEAD:`${e} | `},SOCKET:`system.${e}`,PATH:{ROOT:`systems/${e}`,STYLE:`systems/${e}/style`,TEMPLATES:`systems/${e}/templates`,ASSETS:`systems/${e}/assets`}};class CharacterDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields;return{attributes:new e.SchemaField({strength:new e.NumberField({required:!0,initial:1,min:1,integer:!0}),agility:new e.NumberField({required:!0,initial:1,min:1,integer:!0}),willpower:new e.NumberField({required:!0,initial:1,min:1,integer:!0}),logic:new e.NumberField({required:!0,initial:1,min:1,integer:!0}),charisma:new e.NumberField({required:!0,initial:1,min:1,integer:!0})}),resources:new e.SchemaField({yens:new e.NumberField({required:!0,initial:0,min:0,integer:!0}),anarchy:new e.NumberField({required:!0,initial:0,min:0,integer:!0})}),maxEssence:new e.NumberField({required:!0,initial:6,min:0}),armorLevel:new e.NumberField({required:!0,initial:0,min:0,max:5,integer:!0}),damage:new e.SchemaField({light:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1,!1]}),severe:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1]}),incapacitating:new e.BooleanField({required:!0,initial:!1})}),anarchySpent:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1,!1,!1]}),bio:new e.SchemaField({background:new e.HTMLField({required:!0,initial:""}),notes:new e.HTMLField({required:!0,initial:""})}),keywords:new e.SchemaField({keyword1:new e.StringField({required:!0,initial:""}),keyword2:new e.StringField({required:!0,initial:""}),keyword3:new e.StringField({required:!0,initial:""}),keyword4:new e.StringField({required:!0,initial:""}),keyword5:new e.StringField({required:!0,initial:""})}),behaviors:new e.SchemaField({behavior1:new e.StringField({required:!0,initial:""}),behavior2:new e.StringField({required:!0,initial:""}),behavior3:new e.StringField({required:!0,initial:""}),behavior4:new e.StringField({required:!0,initial:""})}),catchphrases:new e.SchemaField({catchphrase1:new e.StringField({required:!0,initial:""}),catchphrase2:new e.StringField({required:!0,initial:""}),catchphrase3:new e.StringField({required:!0,initial:""}),catchphrase4:new e.StringField({required:!0,initial:""})}),linkedVehicles:new e.ArrayField(new e.StringField({required:!0,initial:""}),{required:!0,initial:[],label:"SRA2.CHARACTER.LINKED_VEHICLES"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"})}}calculateAttributeCost(e,t){let a=0;for(let i=1;i<=e;i++)a+=i===t?2e4:1e4;return a}prepareDerivedData(){const e=this.parent;let t={strength:99,agility:99,willpower:99,logic:99,charisma:99},a=0;if(e&&e.items){const i=e.items.find(e=>"metatype"===e.type);i&&i.system&&(t={strength:i.system.maxStrength||99,agility:i.system.maxAgility||99,willpower:i.system.maxWillpower||99,logic:i.system.maxLogic||99,charisma:i.system.maxCharisma||99},a=i.system.anarchyBonus||0)}this.attributeMaxes=t;let i=0,n=0,s=0,l=0,o=0,r=0,c=0;const d=[];if(e&&e.items){e.items.filter(e=>"feat"===e.type&&!0===e.system.active).forEach(e=>{i+=e.system.bonusLightDamage||0,n+=e.system.bonusSevereDamage||0,s+=e.system.bonusPhysicalThreshold||0,l+=e.system.bonusMentalThreshold||0,o+=e.system.bonusAnarchy||0,r+=e.system.essenceCost||0,e.system.grantsNarration&&(c++,d.push({name:e.name,actions:e.system.narrationActions||1}))})}this.totalAnarchy=3+a+o,this.anarchyBonus=a,this.featsAnarchyBonus=o,this.totalNarrations=1+c,this.bonusNarrations=c,this.narrationsDetails=d;const u=2+i,m=1+n,p=e?._source?.system?.damage||this.damage||{},h={light:Array.isArray(p.light)?[...p.light]:[!1,!1],severe:Array.isArray(p.severe)?[...p.severe]:[!1],incapacitating:"boolean"==typeof p.incapacitating&&p.incapacitating};for(;h.light.length<u;)h.light.push(!1);for(;h.light.length>u;)h.light.pop();for(;h.severe.length<m;)h.severe.push(!1);for(;h.severe.length>m;)h.severe.pop();this.damage=h,this.totalLightBoxes=u,this.totalSevereBoxes=m;const g=3+a+o,f=this.anarchySpent||[];for(Array.isArray(f)||(this.anarchySpent=[]);this.anarchySpent.length<g;)this.anarchySpent.push(!1);for(;this.anarchySpent.length>g;)this.anarchySpent.pop();let S=0;if(e&&e.items){S=e.items.filter(e=>"feat"===e.type&&"armor"===e.system.featType&&!0===e.system.active&&(e.system.armorValue||0)>0).reduce((e,t)=>e+(t.system.armorValue||0),0),S=Math.min(S,5)}this.armorLevel=S,this.armorCost=2500*S;const A=this.attributes?.strength||1,y=this.attributes?.willpower||1;let k=0;if(e&&e.items){const t=e.items.find(e=>"feat"===e.type&&"cyberdeck"===e.system.featType&&!0===e.system.active);t&&t.system&&(k=t.system.firewall||1)}this.damageThresholds={withoutArmor:{light:A+s,severe:A+s+3,incapacitating:A+s+6},withArmor:{light:A+S+s,severe:A+S+s+3,incapacitating:A+S+s+6},mental:{light:y+l,severe:y+l+3,incapacitating:y+l+6},matrix:{light:k,severe:2*k,incapacitating:3*k}};const T=this.maxEssence||6;this.currentEssence=Math.max(0,T-r);const E=this.attributes;if(E){E.strength=Math.min(E.strength||1,t.strength),E.agility=Math.min(E.agility||1,t.agility),E.willpower=Math.min(E.willpower||1,t.willpower),E.logic=Math.min(E.logic||1,t.logic),E.charisma=Math.min(E.charisma||1,t.charisma),this.attributeCosts={strength:this.calculateAttributeCost(E.strength||1,t.strength),agility:this.calculateAttributeCost(E.agility||1,t.agility),willpower:this.calculateAttributeCost(E.willpower||1,t.willpower),logic:this.calculateAttributeCost(E.logic||1,t.logic),charisma:this.calculateAttributeCost(E.charisma||1,t.charisma)};const a=this.attributeCosts;let i=Object.values(a).reduce((e,t)=>e+t,0);i+=this.armorCost||0,e&&e.items&&e.items.forEach(e=>{if(e.system&&void 0!==e.system.calculatedCost){if("feat"===e.type&&!1===e.system.active)return;i+=e.system.calculatedCost}});const n=this.linkedVehicles||[];if(n.length>0){console.log(n);for(const e of n)try{let t=null;if(foundry.utils?.fromUuidSync)try{t=foundry.utils.fromUuidSync(e)}catch(R){}if(!t&&game.actors&&(t=game.actors.find(t=>t.uuid===e),!t)){const a=e.split(".");if(a.length>=3){const e=a[a.length-1];t=game.actors.get(e)}}if(t&&"vehicle"===t.type){const e=t.system?.calculatedCost||0;i+=e}}catch(D){console.warn(`Failed to load linked vehicle ${e} for cost calculation:`,D)}}this.totalCost=i}}}const a={"custom-weapon":{vd:"0",melee:"none",short:"none",medium:"none",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"bare-hands":{vd:"FOR",melee:"ok",short:"none",medium:"none",long:"none",linkedSkill:"Combat rapproché",linkedSpecialization:"Spé : Mains nues",linkedDefenseSkill:"Combat rapproché",linkedDefenseSpecialization:"Spé : Défense"},"short-weapons":{vd:"FOR+1",melee:"ok",short:"none",medium:"none",long:"none",linkedSkill:"Combat rapproché",linkedSpecialization:"Spé : Lames",linkedDefenseSkill:"Combat rapproché",linkedDefenseSpecialization:"Spé : Défense"},"long-weapons":{vd:"FOR+2",melee:"ok",short:"none",medium:"none",long:"none",linkedSkill:"Combat rapproché",linkedSpecialization:"Spé : Lames",linkedDefenseSkill:"Combat rapproché",linkedDefenseSpecialization:"Spé : Défense"},"advanced-melee":{vd:5,melee:"ok",short:"none",medium:"none",long:"none",linkedSkill:"Combat rapproché",linkedSpecialization:"Spé : Armes contondantes",linkedDefenseSkill:"Combat rapproché",linkedDefenseSpecialization:"Spé : Défense"},tasers:{vd:5,melee:"ok",short:"ok",medium:"none",long:"none",linkedSkill:"Combat rapproché",linkedSpecialization:"Spé : Armes contondantes",linkedDefenseSkill:"Combat rapproché",linkedDefenseSpecialization:"Spé : Défense"},throwing:{vd:"FOR+1",melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes de jet",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},grenades:{vd:7,melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes de jet",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"gas-grenades":{vd:"toxin",melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes de jet",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},bows:{vd:"FOR+1",melee:"ok",short:"ok",medium:"ok",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes de trait",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},crossbows:{vd:4,melee:"ok",short:"ok",medium:"ok",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes de trait",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"pocket-pistols":{vd:3,melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Pistolets",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"light-pistols":{vd:4,melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Pistolets",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"automatic-pistols":{vd:4,melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Pistolets",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"heavy-pistols":{vd:5,melee:"ok",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Pistolets",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},smgs:{vd:5,melee:"disadvantage",short:"ok",medium:"ok",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Mitraillettes",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"assault-rifles":{vd:7,melee:"disadvantage",short:"ok",medium:"ok",long:"disadvantage",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Fusils",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},shotguns:{vd:8,melee:"disadvantage",short:"ok",medium:"disadvantage",long:"none",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Fusils",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"sniper-rifles":{vd:10,melee:"none",short:"disadvantage",medium:"disadvantage",long:"ok",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Fusils",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"grenade-launchers":{vd:7,melee:"none",short:"disadvantage",medium:"ok",long:"disadvantage",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Lance-grenades",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"machine-guns":{vd:9,melee:"none",short:"ok",medium:"ok",long:"ok",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes lourdes",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"},"rocket-launchers":{vd:12,melee:"none",short:"none",medium:"disadvantage",long:"ok",linkedSkill:"Armes à distance",linkedSpecialization:"Spé : Armes lourdes",linkedDefenseSkill:"Athlétisme",linkedDefenseSpecialization:"Spé : Défense à distance"}},i={microdrone:{autopilot:6,structure:0,handling:10,speed:0,flyingSpeed:1,armor:0,weaponMount:"none"},minidrone:{autopilot:6,structure:1,handling:10,speed:0,flyingSpeed:1,armor:0,weaponMount:"none"},"small-drone":{autopilot:6,structure:1,handling:9,speed:2,flyingSpeed:4,armor:0,weaponMount:"smg"},"medium-drone":{autopilot:6,structure:2,handling:7,speed:3,flyingSpeed:6,armor:0,weaponMount:"rifle"},"large-drone":{autopilot:6,structure:4,handling:4,speed:4,flyingSpeed:8,armor:0,weaponMount:"rifle"},"racing-motorcycle":{autopilot:6,structure:4,handling:2,speed:6,flyingSpeed:0,armor:0,weaponMount:"rifle"},"offroad-motorcycle":{autopilot:6,structure:4,handling:3,speed:5,flyingSpeed:0,armor:0,weaponMount:"rifle"},chopper:{autopilot:6,structure:5,handling:2,speed:5,flyingSpeed:0,armor:0,weaponMount:"rifle"},"sports-car":{autopilot:6,structure:5,handling:2,speed:5,flyingSpeed:0,armor:0,weaponMount:"none"},sedan:{autopilot:6,structure:6,handling:2,speed:4,flyingSpeed:0,armor:0,weaponMount:"none"},"suv-pickup":{autopilot:6,structure:7,handling:1,speed:4,flyingSpeed:0,armor:0,weaponMount:"none"},van:{autopilot:6,structure:8,handling:1,speed:3,flyingSpeed:0,armor:0,weaponMount:"none"},"bus-truck":{autopilot:6,structure:10,handling:0,speed:2,flyingSpeed:0,armor:0,weaponMount:"none"},"rigid-inflatable-boat":{autopilot:6,structure:5,handling:4,speed:3,flyingSpeed:0,armor:0,weaponMount:"none"},"jet-ski":{autopilot:6,structure:5,handling:5,speed:2,flyingSpeed:0,armor:0,weaponMount:"none"},"civil-helicopter":{autopilot:6,structure:9,handling:4,speed:6,flyingSpeed:0,armor:0,weaponMount:"none"},vtol:{autopilot:6,structure:10,handling:3,speed:6,flyingSpeed:0,armor:0,weaponMount:"none"},t_bird:{autopilot:6,structure:10,handling:3,speed:6,flyingSpeed:0,armor:0,weaponMount:"none"}};class FeatDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields;return{description:new e.HTMLField({required:!0,initial:""}),bookmarked:new e.BooleanField({required:!0,initial:!1,label:"SRA2.BOOKMARKS.TOGGLE"}),rating:new e.NumberField({required:!0,initial:0,integer:!0,label:"SRA2.FEATS.RATING"}),cost:new e.StringField({required:!0,initial:"free-equipment",choices:{"free-equipment":"SRA2.FEATS.COST.FREE_EQUIPMENT",equipment:"SRA2.FEATS.COST.EQUIPMENT","advanced-equipment":"SRA2.FEATS.COST.ADVANCED_EQUIPMENT","specialized-equipment":"SRA2.FEATS.COST.ADVANCED_EQUIPMENT",feat:"SRA2.FEATS.COST.FREE_EQUIPMENT"},label:"SRA2.FEATS.COST.LABEL"}),active:new e.BooleanField({required:!0,initial:!0,label:"SRA2.FEATS.ACTIVE"}),rrList:new e.ArrayField(new e.SchemaField({rrType:new e.StringField({required:!0,initial:"skill",choices:{attribute:"SRA2.FEATS.RR_TYPE.ATTRIBUTE",skill:"SRA2.FEATS.RR_TYPE.SKILL",specialization:"SRA2.FEATS.RR_TYPE.SPECIALIZATION"},label:"SRA2.FEATS.RR_TYPE.LABEL"}),rrValue:new e.NumberField({required:!0,initial:1,min:0,max:3,integer:!0,label:"SRA2.FEATS.RR_VALUE"}),rrTarget:new e.StringField({required:!1,initial:"",nullable:!1,label:"SRA2.FEATS.RR_TARGET"})}),{initial:[],label:"SRA2.FEATS.RR_LIST"}),bonusLightDamage:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.BONUS_LIGHT_DAMAGE"}),bonusSevereDamage:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.BONUS_SEVERE_DAMAGE"}),bonusPhysicalThreshold:new e.NumberField({required:!0,initial:0,integer:!0,label:"SRA2.FEATS.BONUS_PHYSICAL_THRESHOLD"}),bonusMentalThreshold:new e.NumberField({required:!0,initial:0,integer:!0,label:"SRA2.FEATS.BONUS_MENTAL_THRESHOLD"}),characterArmorLevel:new e.NumberField({required:!0,initial:0,min:0,max:5,integer:!0,label:"SRA2.FEATS.CHARACTER_ARMOR_LEVEL"}),armorValue:new e.NumberField({required:!0,initial:0,min:0,max:5,integer:!0,label:"SRA2.FEATS.ARMOR_VALUE"}),bonusAnarchy:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.BONUS_ANARCHY"}),essenceCost:new e.NumberField({required:!0,initial:0,min:0,label:"SRA2.FEATS.ESSENCE_COST"}),isBioware:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.IS_BIOWARE"}),featType:new e.StringField({required:!0,initial:"equipment",choices:{trait:"SRA2.FEATS.FEAT_TYPE.TRAIT",contact:"SRA2.FEATS.FEAT_TYPE.CONTACT",awakened:"SRA2.FEATS.FEAT_TYPE.AWAKENED","adept-power":"SRA2.FEATS.FEAT_TYPE.ADEPT_POWER",equipment:"SRA2.FEATS.FEAT_TYPE.EQUIPMENT",armor:"SRA2.FEATS.FEAT_TYPE.ARMOR",cyberware:"SRA2.FEATS.FEAT_TYPE.CYBERWARE",cyberdeck:"SRA2.FEATS.FEAT_TYPE.CYBERDECK",vehicle:"SRA2.FEATS.FEAT_TYPE.VEHICLE","weapons-spells":"SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS",weapon:"SRA2.FEATS.FEAT_TYPE.WEAPON",spell:"SRA2.FEATS.FEAT_TYPE.SPELL",connaissance:"SRA2.FEATS.FEAT_TYPE.CONNAISSANCE",power:"SRA2.FEATS.FEAT_TYPE.POWER"},label:"SRA2.FEATS.FEAT_TYPE.LABEL"}),weaponType:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.WEAPON.WEAPON_TYPE"}),vehicleType:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.VEHICLE.VEHICLE_TYPE"}),damageValue:new e.StringField({required:!0,initial:"0",label:"SRA2.FEATS.WEAPON.DAMAGE_VALUE"}),damageValueBonus:new e.NumberField({required:!0,initial:0,min:0,max:2,integer:!0,label:"SRA2.FEATS.WEAPON.DAMAGE_VALUE_BONUS"}),meleeRange:new e.StringField({required:!0,initial:"none",choices:{none:"SRA2.FEATS.WEAPON.RANGE_NONE",ok:"SRA2.FEATS.WEAPON.RANGE_OK",dice:"SRA2.FEATS.WEAPON.RANGE_DICE",disadvantage:"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE"},label:"SRA2.FEATS.WEAPON.MELEE_RANGE"}),shortRange:new e.StringField({required:!0,initial:"none",choices:{none:"SRA2.FEATS.WEAPON.RANGE_NONE",ok:"SRA2.FEATS.WEAPON.RANGE_OK",dice:"SRA2.FEATS.WEAPON.RANGE_DICE",disadvantage:"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE"},label:"SRA2.FEATS.WEAPON.SHORT_RANGE"}),mediumRange:new e.StringField({required:!0,initial:"none",choices:{none:"SRA2.FEATS.WEAPON.RANGE_NONE",ok:"SRA2.FEATS.WEAPON.RANGE_OK",dice:"SRA2.FEATS.WEAPON.RANGE_DICE",disadvantage:"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE"},label:"SRA2.FEATS.WEAPON.MEDIUM_RANGE"}),longRange:new e.StringField({required:!0,initial:"none",choices:{none:"SRA2.FEATS.WEAPON.RANGE_NONE",ok:"SRA2.FEATS.WEAPON.RANGE_OK",dice:"SRA2.FEATS.WEAPON.RANGE_DICE",disadvantage:"SRA2.FEATS.WEAPON.RANGE_DISADVANTAGE"},label:"SRA2.FEATS.WEAPON.LONG_RANGE"}),rangeImprovements:new e.SchemaField({melee:new e.BooleanField({required:!0,initial:!1}),short:new e.BooleanField({required:!0,initial:!1}),medium:new e.BooleanField({required:!0,initial:!1}),long:new e.BooleanField({required:!0,initial:!1})},{required:!0,label:"SRA2.FEATS.WEAPON.RANGE_IMPROVEMENTS"}),autopilot:new e.NumberField({required:!0,initial:6,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.AUTOPILOT"}),structure:new e.NumberField({required:!0,initial:2,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.STRUCTURE"}),handling:new e.NumberField({required:!0,initial:5,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.HANDLING"}),speed:new e.NumberField({required:!0,initial:3,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.SPEED"}),flyingSpeed:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.FLYING_SPEED"}),armor:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.ARMOR"}),weaponMount:new e.StringField({required:!0,initial:"none",label:"SRA2.FEATS.VEHICLE.WEAPON_MOUNT"}),weaponInfo:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.VEHICLE.WEAPON_INFO"}),autopilotBonus:new e.NumberField({required:!0,initial:0,min:0,max:6,integer:!0,label:"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS"}),speedBonus:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.SPEED_BONUS"}),handlingBonus:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.HANDLING_BONUS"}),armorBonus:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.ARMOR_BONUS"}),isFixed:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.IS_FIXED"}),isFlying:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.IS_FLYING"}),weaponMountImprovement:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT"}),autopilotUnlocked:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED"}),additionalDroneCount:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT"}),vehicleActorUuid:new e.StringField({required:!1,initial:"",nullable:!0,label:"SRA2.FEATS.VEHICLE.ACTOR_UUID"}),firewall:new e.NumberField({required:!0,initial:1,min:0,integer:!0,label:"SRA2.FEATS.CYBERDECK.FIREWALL"}),attack:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.CYBERDECK.ATTACK"}),cyberdeckDamage:new e.SchemaField({light:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1,!1]}),severe:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1]}),incapacitating:new e.BooleanField({required:!0,initial:!1})},{required:!0,label:"SRA2.FEATS.CYBERDECK.DAMAGE"}),cyberdeckBonusLightDamage:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.CYBERDECK.BONUS_LIGHT_DAMAGE"}),contactName:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.CONTACT.NAME"}),astralPerception:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.ASTRAL_PERCEPTION"}),astralProjection:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.ASTRAL_PROJECTION"}),sorcery:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.SORCERY"}),conjuration:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.CONJURATION"}),adept:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.ADEPT"}),riggerConsoleCount:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.RIGGER_CONSOLE_COUNT"}),hasVehicleControlWiring:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.HAS_VEHICLE_CONTROL_WIRING"}),isWeaponFocus:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.IS_WEAPON_FOCUS"}),isAdeptPowerWeapon:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.IS_ADEPT_POWER_WEAPON"}),narrativeEffects:new e.ArrayField(new e.SchemaField({text:new e.StringField({required:!1,initial:""}),isNegative:new e.BooleanField({required:!0,initial:!1}),value:new e.NumberField({required:!0,initial:0,min:-5,max:5})}),{initial:[],label:"SRA2.FEATS.NARRATIVE_EFFECTS"}),grantsNarration:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.GRANTS_NARRATION"}),narrationActions:new e.NumberField({required:!0,initial:1,min:1,max:2,integer:!0,label:"SRA2.FEATS.NARRATION_ACTIONS"}),sustainedSpellCount:new e.NumberField({required:!0,initial:0,min:0,max:2,integer:!0,label:"SRA2.FEATS.SUSTAINED_SPELL_COUNT"}),summonedSpiritCount:new e.NumberField({required:!0,initial:0,min:0,max:1,integer:!0,label:"SRA2.FEATS.SUMMONED_SPIRIT_COUNT"}),isFirstFeat:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.IS_FIRST_FEAT"}),shamanicMask:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.AWAKENED.SHAMANIC_MASK"}),spellType:new e.StringField({required:!0,initial:"direct",choices:{direct:"SRA2.FEATS.SPELL.TYPE_DIRECT",indirect:"SRA2.FEATS.SPELL.TYPE_INDIRECT"},label:"SRA2.FEATS.SPELL.TYPE"}),weaponDamageBonus:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.WEAPON_DAMAGE_BONUS"}),weaponTypeBonus:new e.StringField({required:!0,initial:"custom-weapon",choices:(()=>{const e={};return Object.keys(a).forEach(t=>{e[t]=t}),e})(),label:"SRA2.FEATS.WEAPON_TYPE_BONUS"}),spellSpecializationType:new e.StringField({required:!0,initial:"combat",choices:{combat:"SRA2.FEATS.SPELL.SPECIALIZATION.COMBAT",detection:"SRA2.FEATS.SPELL.SPECIALIZATION.DETECTION",health:"SRA2.FEATS.SPELL.SPECIALIZATION.HEALTH",illusion:"SRA2.FEATS.SPELL.SPECIALIZATION.ILLUSION",manipulation:"SRA2.FEATS.SPELL.SPECIALIZATION.MANIPULATION",counterspell:"SRA2.FEATS.SPELL.SPECIALIZATION.COUNTERSPELL"},label:"SRA2.FEATS.SPELL.SPECIALIZATION.TYPE"}),linkedAttackSkill:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.WEAPON.LINKED_ATTACK_SKILL"}),linkedAttackSpecialization:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.WEAPON.LINKED_ATTACK_SPECIALIZATION"}),linkedDefenseSkill:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SKILL"}),linkedDefenseSpecialization:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.WEAPON.LINKED_DEFENSE_SPECIALIZATION"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"})}}prepareDerivedData(){const e=this.cost||"free-equipment",t=this.featType||"equipment",a=this.rating||0;if(this.astralProjection&&(this.astralPerception=!0),"spell"===t){this.linkedAttackSkill="Sorcellerie";const e=this.spellSpecializationType||"combat",t={combat:"Spé: Sorts de combat",detection:"Spé: Sorts de détection",health:"Spé: Sorts de santé",illusion:"Spé: Sorts d'illusion",manipulation:"Spé: Sorts de manipulation",counterspell:"Spé: Contresort"};this.linkedAttackSpecialization=t[e]||"Spé: Sorts de combat"}let i=0;if("connaissance"===t&&(i=2500),"equipment"===t||"weapon"===t||"weapons-spells"===t)switch(e){case"free-equipment":case"feat":default:i=0;break;case"equipment":i=2500;break;case"advanced-equipment":case"specialized-equipment":i=5e3}i+=5e3*a,this.calculatedCost=i;let n=0;const s=[],l=this.bonusLightDamage||0,o=this.bonusSevereDamage||0,r=this.bonusPhysicalThreshold||0,c=this.bonusMentalThreshold||0,d=this.firewall||0,u=this.attack||0,m=this.riggerConsoleCount||0,p=this.hasVehicleControlWiring||!1,h=this.isWeaponFocus||!1,g=this.isAdeptPowerWeapon||!1,f=this.isBioware||!1,S=this.bonusAnarchy||0,A=this.grantsNarration||!1,y=this.narrativeEffects||[],k=this.rrList||[],T=this.isFirstFeat||!1;if("trait"!==t||T||(n+=3,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.BASE_FEAT_COST",value:3})),"cyberware"===t&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.CYBERWARE",value:1}),f&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.BIOWARE",value:1}))),"adept-power"===t&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ADEPT_POWER",value:1})),"spell"===t&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SPELL",value:1})),"vehicle"===t&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.VEHICLE",value:1})),l>0){const e=3*l;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.LIGHT_WOUNDS",labelParams:`(${l})`,value:e})}if(o>0){const e=6*o;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SEVERE_WOUNDS",labelParams:`(${o})`,value:e})}if(0!==r){const e=Math.abs(r);n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.PHYSICAL_THRESHOLD",labelParams:`(${r>0?"+":""}${r})`,value:e})}if(0!==c){const e=Math.abs(c);n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.MENTAL_THRESHOLD",labelParams:`(${c>0?"+":""}${c})`,value:e})}"cyberdeck"===t&&d>0&&(n+=d,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.FIREWALL",labelParams:`(${d})`,value:d}));const E=this.cyberdeckBonusLightDamage||!1;"cyberdeck"===t&&E&&(n+=3,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.CYBERDECK_BONUS_LIGHT_DAMAGE",value:3})),u>0&&(n+=u,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ATTACK",labelParams:`(${u})`,value:u})),m>0&&(n+=m,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.RIGGER_CONSOLE",labelParams:`(${m})`,value:m})),p&&(n+=2,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.VEHICLE_WIRING",value:2})),h&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.WEAPON_FOCUS",value:1})),g&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ADEPT_POWER_WEAPON",value:1}));const R=this.damageValueBonus||0;R>0&&(n+=R,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.DAMAGE_VALUE_BONUS",labelParams:`(+${R})`,value:R}));const D=this.weaponDamageBonus||0;D>0&&(n+=D,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.WEAPON_DAMAGE_BONUS",labelParams:`(+${D})`,value:D}));const v=this.rangeImprovements||{};let b=0;if(v.melee&&b++,v.short&&b++,v.medium&&b++,v.long&&b++,b>0){const e=2*b;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.RANGE_IMPROVEMENTS",labelParams:`(${b})`,value:e})}for(const W of k){const e=W.rrType,t=W.rrValue||0;if(t>0)if("specialization"===e){const e=2*t;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.RR_SPECIALIZATION",labelParams:`(${t})`,value:e})}else if("skill"===e){const e=5*t;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.RR_SKILL",labelParams:`(${t})`,value:e})}else if("attribute"===e){const e=10*t;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.RR_ATTRIBUTE",labelParams:`(${t})`,value:e})}}if(S>0){const e=2*S;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ANARCHY_BONUS",labelParams:`(${S})`,value:e})}A&&(n+=3,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.GRANTS_NARRATION",value:3}));const I=y.filter(e=>e?.text&&""!==e.text.trim()&&!e.isNegative&&0!==e.value&&null!==e.value&&void 0!==e.value),w=y.filter(e=>e?.text&&""!==e.text.trim()&&e.isNegative&&0!==e.value&&null!==e.value&&void 0!==e.value);if(I.length>0){const e=I.reduce((e,t)=>e+(t.value||1),0);n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_POSITIVE",labelParams:`(${I.length})`,value:e})}if(w.length>0){const e=w.reduce((e,t)=>e+(t.value||-1),0);n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.NARRATIVE_EFFECTS_NEGATIVE",labelParams:`(${w.length})`,value:e})}const N=this.sustainedSpellCount||0;if(N>0){const e=2*N;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SUSTAINED_SPELLS",labelParams:`(${N})`,value:e})}const L=this.summonedSpiritCount||0;if(L>0){const e=3*L;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SUMMONED_SPIRITS",labelParams:`(${L})`,value:e})}const _=this.astralPerception||!1,O=this.astralProjection||!1,F=this.sorcery||!1,C=this.conjuration||!1,M=this.adept||!1;_&&!O&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION",value:1})),_&&O&&(n+=2,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ASTRAL_PERCEPTION_PROJECTION",value:2})),F&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SORCERY",value:1})),C&&(n+=2,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.CONJURATION",value:2})),M&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ADEPT",value:1}));const $=this.autopilotBonus||0,U=this.speedBonus||0,z=this.handlingBonus||0,G=this.armorBonus||0,P=this.isFixed||!1,V=this.isFlying||!1,B=this.weaponMountImprovement||!1,x=this.autopilotUnlocked||!1,H=this.additionalDroneCount||0;if($>0&&(n+=$,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.AUTOPILOT_BONUS",labelParams:`(+${$})`,value:$})),U>0&&(n+=U,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SPEED_BONUS",labelParams:`(+${U})`,value:U})),z>0&&(n+=z,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.HANDLING_BONUS",labelParams:`(+${z})`,value:z})),G>0&&(n+=G,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ARMOR_BONUS",labelParams:`(+${G})`,value:G})),P&&(n-=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.IS_FIXED",value:-1})),V&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.IS_FLYING",value:1})),B&&(n+=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.WEAPON_MOUNT_IMPROVEMENT",value:1})),x&&(n+=3,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.AUTOPILOT_UNLOCKED",value:3})),H>0){const e=2*H;n+=e,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.ADDITIONAL_DRONES",labelParams:`(${H})`,value:e})}(this.shamanicMask||!1)&&"awakened"===t&&(n-=1,s.push({labelKey:"SRA2.FEATS.BREAKDOWN.SHAMANIC_MASK",value:-1})),this.recommendedLevel=n,this.recommendedLevelBreakdown=s}}const n=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,FeatDataModel:FeatDataModel,VEHICLE_TYPES:i,WEAPON_TYPES:a},Symbol.toStringTag,{value:"Module"}));class VehicleDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields,t={};return Object.keys(i).forEach(e=>{t[e]=e}),{vehicleType:new e.StringField({required:!1,nullable:!0,choices:t,label:"SRA2.VEHICLE.VEHICLE_TYPE"}),autopilotBonus:new e.NumberField({required:!0,initial:0,min:0,max:6,integer:!0,label:"SRA2.FEATS.VEHICLE.AUTOPILOT_BONUS"}),speedBonus:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.SPEED_BONUS"}),handlingBonus:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.HANDLING_BONUS"}),armorBonus:new e.NumberField({required:!0,initial:0,min:0,integer:!0,label:"SRA2.FEATS.VEHICLE.ARMOR_BONUS"}),isFixed:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.IS_FIXED"}),isFlying:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.IS_FLYING"}),weaponMountImprovement:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.WEAPON_MOUNT_IMPROVEMENT"}),autopilotUnlocked:new e.BooleanField({required:!0,initial:!1,label:"SRA2.FEATS.VEHICLE.AUTOPILOT_UNLOCKED"}),additionalDroneCount:new e.NumberField({required:!0,initial:0,min:0,max:3,integer:!0,label:"SRA2.FEATS.VEHICLE.ADDITIONAL_DRONE_COUNT"}),weaponMount:new e.StringField({required:!0,initial:"none",label:"SRA2.FEATS.VEHICLE.WEAPON_MOUNT"}),weaponInfo:new e.StringField({required:!0,initial:"",label:"SRA2.FEATS.VEHICLE.WEAPON_INFO"}),narrativeEffects:new e.ArrayField(new e.SchemaField({text:new e.StringField({required:!1,initial:""}),isNegative:new e.BooleanField({required:!0,initial:!1}),value:new e.NumberField({required:!0,initial:0,min:-5,max:5})}),{initial:[],label:"SRA2.VEHICLE.NARRATIVE_EFFECTS"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"}),damage:new e.SchemaField({light:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1,!1]}),severe:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1]}),incapacitating:new e.BooleanField({required:!0,initial:!1})})}}prepareDerivedData(){const e=this.vehicleType||"",t=e&&i[e]?i[e]:null,a=t?.autopilot||0,n=t?.structure||0,s=t?.handling||0,l=t?.speed||0,o=t?.flyingSpeed||0,r=t?.armor||0,c=t?.weaponMount||"none",d=this.autopilotBonus||0,u=this.speedBonus||0,m=this.handlingBonus||0,p=this.armorBonus||0,h=this.isFlying||!1,g=this.isFixed||!1,f=this.weaponMountImprovement||!1,S=this.autopilotUnlocked||!1,A=this.additionalDroneCount||0,y=Math.min(12,a+d),k=s+m,T=g?0:l+u,E=h?o>0?o:1:0,R=Math.min(n,r+p);let D=c;f&&("none"===c?D="smg":"smg"===c&&(D="rifle")),this.attributes={autopilot:y,structure:n,handling:k,speed:T,flyingSpeed:E,armor:R},this.baseAttributes={autopilot:a,structure:n,handling:s,speed:l,flyingSpeed:o,armor:r},this.weaponMount=D,this.damageThresholds={light:n+R,severe:2*n+R,incapacitating:3*n+R};const v=this.parent,b=v?._source?.system?.damage||this.damage||{},I={light:Array.isArray(b.light)?[...b.light]:[!1,!1],severe:Array.isArray(b.severe)?[...b.severe]:[!1],incapacitating:"boolean"==typeof b.incapacitating&&b.incapacitating};for(;I.light.length<2;)I.light.push(!1);for(;I.light.length>2;)I.light.pop();for(;I.severe.length<1;)I.severe.push(!1);for(;I.severe.length>1;)I.severe.pop();this.damage=I,this.totalLightBoxes=2,this.totalSevereBoxes=1;let w=5e3;w+=5e3*d,w+=5e3*u,w+=5e3*m,w+=5e3*p,h&&(w+=5e3),f&&(w+=5e3),S&&(w+=15e3),A>0&&(w+=1e4*A),g&&(w-=5e3);const N=this.narrativeEffects||[];let L=0;N.forEach(e=>{if("string"==typeof e)e&&""!==e.trim()&&(L+=5e3);else if(e&&"object"==typeof e){const t=void 0!==e.value&&null!==e.value?e.value:0;0!==t&&(L+=5e3*t)}}),w+=L;const _=this.parent;if(_&&_.items){_.items.filter(e=>{const t=e.system?.featType;return"weapon"===t||"weapons-spells"===t}).forEach(e=>{const t=e.system?.calculatedCost||0;w+=t})}this.calculatedCost=w}}const s={patrol:"Patrouilleuse",acid:"Acide",blaster:"Blaster",blocker:"Bloqueuse",black:"Noire",glue:"Pot de colle",tracker:"Traqueuse",killer:"Tueuse"};class IceDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields,t={};return Object.entries(s).forEach(([e,a])=>{t[e]=a}),{iceType:new e.StringField({required:!1,nullable:!0,choices:t,label:"SRA2.ICE.ICE_TYPE"}),serverIndex:new e.NumberField({required:!0,initial:1,min:1,max:12,integer:!0,label:"SRA2.ICE.SERVER_INDEX"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"}),damage:new e.SchemaField({light:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1,!1]}),severe:new e.ArrayField(new e.BooleanField({required:!0,initial:!1}),{required:!0,initial:[!1]}),incapacitating:new e.BooleanField({required:!0,initial:!1})})}}prepareDerivedData(){const e=this.serverIndex||1;this.attributes={firewall:1},this.threshold=e,this.damageThresholds={light:1,severe:2,incapacitating:3};const t=this.iceType||"";let a=0;"blaster"===t||"black"===t?a=Math.ceil(e/2):"killer"===t&&(a=e),this.damageValue=a}}class SkillDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields;return{rating:new e.NumberField({required:!0,initial:1,min:0,max:8,integer:!0,label:"SRA2.SKILLS.RATING"}),linkedAttribute:new e.StringField({required:!0,initial:"strength",choices:{strength:"SRA2.ATTRIBUTES.STRENGTH",agility:"SRA2.ATTRIBUTES.AGILITY",willpower:"SRA2.ATTRIBUTES.WILLPOWER",logic:"SRA2.ATTRIBUTES.LOGIC",charisma:"SRA2.ATTRIBUTES.CHARISMA"},label:"SRA2.SKILLS.LINKED_ATTRIBUTE"}),description:new e.HTMLField({required:!0,initial:""}),bookmarked:new e.BooleanField({required:!0,initial:!1,label:"SRA2.SKILLS.BOOKMARKED"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"})}}prepareDerivedData(){const e=this.rating||0;let t=0;t=e<=5?2500*e:12500+5e3*(e-5),this.calculatedCost=t}}class SpecializationDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields;return{linkedSkill:new e.StringField({required:!0,initial:"",label:"SRA2.SPECIALIZATIONS.LINKED_SKILL"}),linkedAttribute:new e.StringField({required:!0,initial:"strength",choices:{strength:"SRA2.ATTRIBUTES.STRENGTH",agility:"SRA2.ATTRIBUTES.AGILITY",willpower:"SRA2.ATTRIBUTES.WILLPOWER",logic:"SRA2.ATTRIBUTES.LOGIC",charisma:"SRA2.ATTRIBUTES.CHARISMA"},label:"SRA2.SPECIALIZATIONS.LINKED_ATTRIBUTE"}),description:new e.HTMLField({required:!0,initial:""}),bookmarked:new e.BooleanField({required:!0,initial:!1,label:"SRA2.BOOKMARKS.TOGGLE"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"})}}prepareDerivedData(){this.calculatedCost=2500}}class MetatypeDataModel extends foundry.abstract.TypeDataModel{static defineSchema(){const e=foundry.data.fields;return{description:new e.HTMLField({required:!0,initial:""}),maxStrength:new e.NumberField({required:!0,initial:4,min:1,max:10,integer:!0,label:"SRA2.METATYPES.MAX_STRENGTH"}),maxAgility:new e.NumberField({required:!0,initial:4,min:1,max:10,integer:!0,label:"SRA2.METATYPES.MAX_AGILITY"}),maxWillpower:new e.NumberField({required:!0,initial:4,min:1,max:10,integer:!0,label:"SRA2.METATYPES.MAX_WILLPOWER"}),maxLogic:new e.NumberField({required:!0,initial:4,min:1,max:10,integer:!0,label:"SRA2.METATYPES.MAX_LOGIC"}),maxCharisma:new e.NumberField({required:!0,initial:4,min:1,max:10,integer:!0,label:"SRA2.METATYPES.MAX_CHARISMA"}),anarchyBonus:new e.NumberField({required:!0,initial:0,min:0,max:10,integer:!0,label:"SRA2.METATYPES.ANARCHY_BONUS"}),reference:new e.StringField({required:!1,initial:"",label:"SRA2.REFERENCE"})}}prepareDerivedData(){}}const l=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,CharacterDataModel:CharacterDataModel,FeatDataModel:FeatDataModel,IceDataModel:IceDataModel,MetatypeDataModel:MetatypeDataModel,SkillDataModel:SkillDataModel,SpecializationDataModel:SpecializationDataModel,VehicleDataModel:VehicleDataModel},Symbol.toStringTag,{value:"Module"}));class SRA2Actor extends Actor{get feats(){return this.items.filter(e=>"feat"===e.type)}}const o=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,SRA2Actor:SRA2Actor},Symbol.toStringTag,{value:"Module"}));function normalizeSearchText(e){return e?e.toLowerCase().normalize("NFD").replace(/ ?\(.*\)/g,"").replace(/[\u0300-\u036f]/g,""):""}function itemMatchesSearch(e,t,a,i=!1,n){if(e.type!==t)return!1;const s=normalizeSearchText(a);if(normalizeSearchText(e.name).includes(s))return!0;console.log(e.system?.weaponType);const l=e.system?.weaponType||"weapon"===e.system?.featType?e.system?.weaponType:null;if(l&&normalizeSearchText(l).includes(s))return!0;const o=e.system?.description||"";if(o&&normalizeSearchText(o).includes(s))return!0;const r=e.system?.linkedAttackSkill||"";if(r&&normalizeSearchText(r).includes(s))return!0;const c=e.system?.linkedAttackSpecialization||"";return!(!c||!normalizeSearchText(c).includes(s))||!!(i&&n&&normalizeSearchText(n).includes(s))}function searchItemsInWorld(e,t,a){const i=[];if(!game.items)return i;for(const n of game.items)if(itemMatchesSearch(n,e,t)){const t=!!a&&a(n.name);i.push({name:n.name,uuid:n.uuid,id:n.id,source:game.i18n.localize("SRA2.SKILLS.WORLD_ITEMS"),type:e,alreadyExists:t})}return i}function searchItemsOnActor(e,t,a){const i=[];if(!e)return i;for(const n of e.items)itemMatchesSearch(n,t,a)&&i.push({name:n.name,uuid:n.uuid,id:n.id,source:game.i18n.localize("SRA2.FEATS.FROM_ACTOR"),type:t});return i}async function searchItemsInCompendiums(e,t,a){const i=[],n=/* @__PURE__ */new Set;for(const s of game.packs){if("Item"!==s.documentName)continue;const l=await s.getDocuments();for(const o of l)if(itemMatchesSearch(o,e,t,!0,s.title)){if(n.has(o.name))continue;n.add(o.name);const t=!!a&&a(o.name);i.push({name:o.name,uuid:o.uuid,source:s.title,type:e,alreadyExists:t})}}return i}async function searchItemsEverywhere(e,t,a,i){const n=[],s=/* @__PURE__ */new Set;if(a){searchItemsOnActor(a,e,t).forEach(e=>{n.push(e),s.add(e.name)})}searchItemsInWorld(e,t,i).forEach(e=>{s.has(e.name)||(n.push(e),s.add(e.name))});return(await searchItemsInCompendiums(e,t,i)).forEach(e=>{s.has(e.name)||(n.push(e),s.add(e.name))}),n}function buildSingleResultHtml(e,t,a){let i=`\n    <div class="search-result-item ${e.alreadyExists?"already-exists":""} ${a?"exact-match":""}" \n         data-result-name="${e.name}" \n         data-result-uuid="${e.uuid}">\n      <div class="result-info">\n        <span class="result-name">${e.name}</span>\n        <span class="result-pack">${e.source} - ${t}</span>\n      </div>\n  `;return e.alreadyExists?i+=`\n      <span class="already-exists-label">\n        ${game.i18n.localize("SRA2.SKILLS.ALREADY_EXISTS")}\n      </span>\n    `:i+=`\n      <button class="add-item-btn" \n              data-item-name="${e.name}" \n              data-item-uuid="${e.uuid}">\n        ${game.i18n.localize("SRA2.SKILLS.ADD")}\n      </button>\n    `,i+="</div>",i}function itemExistsOnActor(e,t,a){return!!e&&e.items.some(e=>e.type===t&&e.name===a)}const r=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,addItemToActorFromUuid:async function(e,t){try{const a=await fromUuid(t);return a?itemExistsOnActor(e,a.type,a.name)?(ui.notifications?.warn(game.i18n.format("SRA2.ALREADY_EXISTS",{name:a.name})),!1):(await e.createEmbeddedDocuments("Item",[a.toObject()]),ui.notifications?.info(game.i18n.format("SRA2.SKILLS.ADDED",{name:a.name})),!0):(ui.notifications?.error(game.i18n.localize("SRA2.SKILLS.ITEM_NOT_FOUND")),!1)}catch(a){return console.error("SRA2 | Error adding item to actor:",a),ui.notifications?.error(game.i18n.localize("SRA2.SKILLS.ERROR_ADDING")),!1}},buildSearchResultsHtml:function(e){const{results:t,lastSearchTerm:a,noResultsMessage:i,typeLabel:n}=e,s=normalizeSearchText(a),l=t.find(e=>normalizeSearchText(e.name)===s);let o="";if(0===t.length)o=`\n      <div class="search-result-item no-results">\n        <div class="no-results-text">\n          ${i}\n        </div>\n      </div>\n    `;else{l&&(o+=buildSingleResultHtml(l,n,!0));const e=l?t.filter(e=>e.name!==l.name):t;for(const t of e)o+=buildSingleResultHtml(t,n,!1)}return o},createDebouncedSearch:function(e,t=300){let a=null;return i=>{a&&clearTimeout(a),a=setTimeout(async()=>{await e(i)},t)}},itemExistsOnActor:itemExistsOnActor,normalizeSearchText:normalizeSearchText,searchItemsEverywhere:searchItemsEverywhere,searchItemsInCompendiums:searchItemsInCompendiums,searchItemsInWorld:searchItemsInWorld,searchItemsOnActor:searchItemsOnActor,toggleSearchResults:function(e,t){e.style.display=t?"block":"none"}},Symbol.toStringTag,{value:"Module"})),c=[2,5,8,12];function getRiskDiceByRR(e){return c[Math.min(3,Math.max(0,e))]||2}function handleRollRequest(e){console.log("=== ROLL REQUEST ===",{itemType:e.itemType,weaponType:e.weaponType,linkedAttackSkill:e.linkedAttackSkill,linkedAttackSpecialization:e.linkedAttackSpecialization,linkedDefenseSkill:e.linkedDefenseSkill,linkedDefenseSpecialization:e.linkedDefenseSpecialization,linkedAttribute:e.linkedAttribute,isWeaponFocus:e.isWeaponFocus,damageValue:e.damageValue,damageValueBonus:e.damageValueBonus,meleeRange:e.meleeRange,shortRange:e.shortRange,mediumRange:e.mediumRange,longRange:e.longRange,skillName:e.skillName,specName:e.specName,itemName:e.itemName,itemId:e.itemId,threshold:e.threshold,actorId:e.actorId,actorUuid:e.actorUuid,actorName:e.actorName,specLevel:e.specLevel,skillLevel:e.skillLevel,itemRating:e.itemRating,itemActive:e.itemActive,rrList:e.rrList}),Promise.resolve().then(()=>h).then(t=>{new t.RollDialog(e).render(!0)})}const d=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,RISK_DICE_BY_RR:c,executeRoll:async function(e,t,a,i,n){if(!e)return void console.error("No attacker provided for roll");console.log("=== EXECUTE ROLL ==="),console.log("Attacker:",e?.name||"Unknown"),console.log("Attacker UUID:",e?.uuid||"Unknown"),console.log("Attacker Token:",a?"Found":"Not found"),console.log("Attacker Token UUID:",a?.uuid||a?.document?.uuid||n.attackerTokenUuid||"Unknown"),a?.actor&&console.log("Attacker Token Actor UUID:",a.actor.uuid||"Unknown"),console.log("Defender:",t?.name||"None"),console.log("Defender UUID:",t?.uuid||"Unknown"),console.log("Defender Token:",i?"Found":"Not found"),console.log("Defender Token UUID:",i?.uuid||i?.document?.uuid||n.defenderTokenUuid||"Unknown"),i?.actor&&console.log("Defender Token Actor UUID:",i.actor.uuid||"Unknown"),console.log("===================");const s=n.dicePool||0,l=n.riskDiceCount||0,o=Math.max(0,s-l),r=n.rollMode||"normal",c=Math.min(3,n.finalRR||0),d=n.threshold;let u;if(void 0!==d)u={normalDice:[],riskDice:[],normalSuccesses:d,riskSuccesses:0,totalSuccesses:d,criticalFailures:0,finalRR:c,remainingFailures:0,complication:"none"};else{let e=null,t=null;if(o>0&&(e=new Roll(`${o}d6`),await e.evaluate(),game.dice3d&&e&&game.dice3d.showForRoll(e,game.user,!0,null,!1)),l>0&&(t=new Roll(`${l}d6`),await t.evaluate(),game.dice3d&&t)){const e={colorset:"purple",theme:"default"};game.dice3d.showForRoll(t,game.user,!0,e,!1)}const a=e&&e.dice[0]?.results?.map(e=>e.result)||[],i=t&&t.dice[0]?.results?.map(e=>e.result)||[];let n=0;for(const l of a)("advantage"===r&&l>=4||"disadvantage"===r&&6===l||"normal"===r&&l>=5)&&n++;let s=0,d=0;for(const l of i)1===l?d++:("advantage"===r&&l>=4||"disadvantage"===r&&6===l||"normal"===r&&l>=5)&&s++;const m=n+2*s,p=Math.max(0,d-c);let h="none";1===p?h="minor":2===p?h="critical":p>=3&&(h="disaster"),u={normalDice:a,riskDice:i,normalSuccesses:n,riskSuccesses:s,totalSuccesses:m,criticalFailures:d,finalRR:c,remainingFailures:p,complication:h}}await async function(e,t,a,i,n,s){const l="weapon"===n.itemType||void 0!==n.weaponType||n.meleeRange||n.shortRange||n.mediumRange||n.longRange;console.log("=== CREATE ROLL CHAT MESSAGE ==="),console.log("Attacker:",e?.name||"Unknown"),console.log("Attacker UUID:",e?.uuid||"Unknown"),console.log("Attacker Token:",a?"Found":"Not found");let o;a?(o=a.uuid||a.document?.uuid||void 0,console.log("Attacker Token UUID:",o||"Unknown"),a.actor&&console.log("Attacker Token Actor UUID:",a.actor.uuid||"Unknown")):n.attackerTokenUuid&&(o=n.attackerTokenUuid,console.log("Attacker Token UUID (from rollData):",o));const r=a?.actor?.uuid||e?.uuid;console.log("Final Attacker UUID (token actor or actor):",r||"Unknown"),console.log("Defender:",t?.name||"None"),console.log("Defender UUID:",t?.uuid||"Unknown"),console.log("Defender Token:",i?"Found":"Not found");let c;i?(c=i.uuid||i.document?.uuid||void 0,console.log("Defender Token UUID:",c||"Unknown"),i.actor&&console.log("Defender Token Actor UUID:",i.actor.uuid||"Unknown")):n.defenderTokenUuid&&(c=n.defenderTokenUuid,console.log("Defender Token UUID (from rollData):",c));const d=i?.actor?.uuid||t?.uuid;console.log("Final Defender UUID (token actor or actor):",d||"Unknown"),console.log("--- UUIDs to be stored in flags ---"),console.log("attackerUuid (final):",r||"Unknown"),console.log("attackerTokenUuid (final):",o||"Unknown"),console.log("defenderUuid (final):",d||"Unknown"),console.log("defenderTokenUuid (final):",c||"Unknown"),console.log("================================");let u=null;if(t){let e=t.img;i&&(e=i.document?.texture?.src||i.document?.img||i.data?.img||i.texture?.src||t.img),u={...t,img:e}}let m=null,p=null,h=!1;if(n.isDefend&&n.attackRollResult&&n.attackRollData){const l=n.attackRollResult.totalSuccesses,o=s.totalSuccesses,c="ice-attack"===n.attackRollData.itemType||n.attackRollData.iceType,u=n.attackRollData.iceType,g=i?.name||t?.name||"Inconnu",f=a?.name||e?.name||"Inconnu";if(l>=o)if(c){let e=0;const t=n.attackRollData.iceDamageValue||0;"blaster"!==u&&"black"!==u&&"killer"!==u||(e=t+l-o),p=e,h=!1}else{let e=0;const a=n.attackRollData.damageValue||"0";if("FOR"===a||a.startsWith("FOR+")){const i=t?.system?.attributes?.strength||1;if("FOR"===a)e=i;else if(a.startsWith("FOR+")){e=i+(parseInt(a.substring(4))||0)}}else e=parseInt(a,10)||0;p=e+l-o,h=!1}else h=!0,p=0;const S=d,A=r;console.log("Defense: Attack succeeds - original attacker inflicts damage to defender"),console.log("  Original attacker (inflicter):",g,"(",S,")"),console.log("  Defender (receiver):",f,"(",A,")"),m={attackSuccesses:l,defenseSuccesses:o,calculatedDamage:p,attackFailed:h,originalAttackerName:g,defenderName:f,originalAttackerUuid:S,defenderUuid:A,isIceAttack:c,iceType:u}}else if(n.isCounterAttack&&n.attackRollResult&&n.attackRollData){const l=i?.document?.name||i?.name||i?.actor?.name||t?.name||"Inconnu",u=a?.document?.name||a?.name||a?.actor?.name||e?.name||"Inconnu",p=n.attackRollResult.totalSuccesses,h=s.totalSuccesses;let g=0;const f=n.attackRollData.damageValue||"0";if("FOR"===f||f.startsWith("FOR+")){const e=t?.system?.attributes?.strength||1;if("FOR"===f)g=e;else if(f.startsWith("FOR+")){g=e+(parseInt(f.substring(4))||0)}}else g=parseInt(f,10)||0;let S=0;const A=n.damageValue||"0";if("FOR"===A||A.startsWith("FOR+")){const t=e.system?.attributes?.strength||1;if("FOR"===A)S=t;else if(A.startsWith("FOR+")){S=t+(parseInt(A.substring(4))||0)}}else S=parseInt(A,10)||0;if(!S&&e){const t=n.selectedWeaponId;if(t){const a=e.items.find(e=>e.id===t);if(a){const t=a.system,i=t.damageValue||"0",n=t.damageValueBonus||0;let s=i;if(n>0&&"0"!==i)if("FOR"===i)s=`FOR+${n}`;else if(i.startsWith("FOR+")){s=`FOR+${(parseInt(i.substring(4))||0)+n}`}else if("toxin"!==i){s=((parseInt(i)||0)+n).toString()}if("FOR"===s||s.startsWith("FOR+")){const t=e.system?.attributes?.strength||1;if("FOR"===s)S=t;else if(s.startsWith("FOR+")){S=t+(parseInt(s.substring(4))||0)}}else S=parseInt(s,10)||0}}}let y=0,k=0,T=!1,E="tie";p>h?(E="attacker",y=g+p-h):h>p?(E="defender",k=S+h-p):(T=!0,E="tie"),console.log("=== COUNTER-ATTACK RESULTS ==="),console.log("Attack Successes:",p),console.log("Counter-Attack Successes:",h),console.log("Attack Damage Value:",g),console.log("Counter-Attack Damage Value:",S),console.log("Winner:",E),console.log("Attacker Damage:",y),console.log("Defender Damage:",k),console.log("Original Attacker Name:",l),console.log("Original Defender Name:",u),console.log("--- Context ---"),console.log("Attacker param:",e?.name),console.log("Defender param:",t?.name),console.log("AttackerToken object:",a?"Found":"Not found"),console.log("AttackerToken.name:",a?.name),console.log("AttackerToken.document?.name:",a?.document?.name),console.log("AttackerToken.actor?.name:",a?.actor?.name),console.log("DefenderToken object:",i?"Found":"Not found"),console.log("DefenderToken.name:",i?.name),console.log("DefenderToken.document?.name:",i?.document?.name),console.log("DefenderToken.actor?.name:",i?.actor?.name),console.log("--- UUIDs to be stored in flags ---"),console.log("attackerUuid (final):",r||"Unknown"),console.log("attackerTokenUuid (final):",o||"Unknown"),console.log("defenderUuid (final):",d||"Unknown"),console.log("defenderTokenUuid (final):",c||"Unknown"),console.log("==============================");const R=d,D=r;let v,b,I="",w="";"attacker"===E?(v=R,b=D,I=l,w=u,console.log("Counter-attack: Original attacker wins - inflicts damage to counter-attacker"),console.log("  Inflicter:",I,"(",v,")"),console.log("  Receiver:",w,"(",b,")")):"defender"===E&&(v=D,b=R,I=u,w=l,console.log("Counter-attack: Counter-attacker wins - inflicts damage to original attacker"),console.log("  Inflicter:",I,"(",v,")"),console.log("  Receiver:",w,"(",b,")")),m={attackSuccesses:p,counterAttackSuccesses:h,winner:E,attackerDamage:y,defenderDamage:k,isTie:T,originalAttackerName:l,originalDefenderName:u,originalAttackerUuid:R,originalDefenderUuid:D,damageInflicterUuid:v,damageReceiverUuid:b,damageInflicterName:I,damageReceiverName:w}}const g=e?{...e,uuid:r||e.uuid}:null,f=u?{...u,uuid:d||u.uuid}:null,S={attacker:g,defender:f,rollData:n,rollResult:s,isAttack:l,isDefend:n.isDefend||!1,isCounterAttack:n.isCounterAttack||!1,skillName:n.specName||n.skillName||n.linkedAttackSkill||"Unknown",itemName:n.itemName,damageValue:n.damageValue,defenseResult:m,attackerUuid:r,defenderUuid:d,attackerTokenUuid:o,defenderTokenUuid:c,isSpellDirect:n.isSpellDirect||!1},A=await renderTemplate("systems/sra2/templates/roll-result.hbs",S),y={user:game.user?.id,speaker:{actor:e?.id,alias:e?.name},content:A,type:CONST.CHAT_MESSAGE_TYPES.OTHER,flags:{sra2:{rollType:l?"attack":"skill",attackerId:e?.id,attackerUuid:r,attackerTokenUuid:o,defenderId:t?.id,defenderUuid:d,defenderTokenUuid:c,rollResult:s,rollData:n}}};await ChatMessage.create(y),await async function(e,t,a){if(!e||!t||!a)return;const i="spell"===t.itemType||"weapon-spell"===t.itemType;let n=t.linkedAttackSkill||t.skillName||t.specName||"",s=normalizeSearchText(n);if(i||"sorcellerie"===normalizeSearchText(t.linkedAttackSkill||""))s="sorcellerie";else if("specialization"===t.itemType&&(!s||"sorcellerie"!==s&&"conjuration"!==s)&&t.itemId&&e){const a=e.items.find(e=>e.id===t.itemId);if(a&&"specialization"===a.type){const e=a.system.linkedSkill||"";e&&(n=e,s=normalizeSearchText(e))}}const l="conjuration"===s;if("sorcellerie"!==s&&!l)return;if("none"===a.complication)return;const o=e.system;if(!o||"character"!==e.type)return;if("minor"===a.complication){const t=game.i18n.localize("SRA2.SKILLS.DRAIN_MINOR_COMPLICATION");await ChatMessage.create({user:game.user?.id,speaker:{actor:e.id,alias:e.name},content:`<div class="drain-message minor-complication" style="padding: 8px; margin: 4px 0; background-color: rgba(255, 193, 7, 0.1); border-left: 3px solid #ffc107; border-radius: 4px;">\n        <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> \n        <strong style="color: #ffc107;">Drain - ${game.i18n.localize("SRA2.SKILLS.MINOR_COMPLICATION")}</strong>\n        <br/>\n        <span style="margin-left: 20px; display: block; margin-top: 4px;">${t}</span>\n      </div>`,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}else if("critical"===a.complication){const t=o.damage||{},a=Array.isArray(t.light)?t.light:[!1,!1];let i=!1;for(let e=0;e<a.length;e++)if(!a[e]){a[e]=!0,i=!0;break}if(i){await e.update({"system.damage.light":a});const t=game.i18n.localize("SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION");await ChatMessage.create({user:game.user?.id,speaker:{actor:e.id,alias:e.name},content:`<div class="drain-message critical-complication" style="padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;">\n          <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> \n          <strong style="color: #dc3545;">Drain - ${game.i18n.localize("SRA2.SKILLS.CRITICAL_COMPLICATION")}</strong>\n          <br/>\n          <span style="margin-left: 20px; display: block; margin-top: 4px;">${t}</span>\n        </div>`,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}else{const a=Array.isArray(t.severe)?t.severe:[!1];let i=!1;for(let e=0;e<a.length;e++)if(!a[e]){a[e]=!0,i=!0;break}i?await e.update({"system.damage.severe":a}):await e.update({"system.damage.incapacitating":!0});const n=game.i18n.localize("SRA2.SKILLS.DRAIN_CRITICAL_COMPLICATION");await ChatMessage.create({user:game.user?.id,speaker:{actor:e.id,alias:e.name},content:`<div class="drain-message critical-complication" style="padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;">\n          <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> \n          <strong style="color: #dc3545;">Drain - ${game.i18n.localize("SRA2.SKILLS.CRITICAL_COMPLICATION")}</strong>\n          <br/>\n          <span style="margin-left: 20px; display: block; margin-top: 4px;">${n}</span>\n        </div>`,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}}else if("disaster"===a.complication){await e.update({"system.damage.incapacitating":!0});const t=game.i18n.localize("SRA2.SKILLS.DRAIN_DISASTER");await ChatMessage.create({user:game.user?.id,speaker:{actor:e.id,alias:e.name},content:`<div class="drain-message disaster" style="padding: 8px; margin: 4px 0; background-color: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px;">\n        <i class="fas fa-skull" style="color: #dc3545;"></i> \n        <strong style="color: #dc3545;">Drain - ${game.i18n.localize("SRA2.SKILLS.DISASTER")}</strong>\n        <br/>\n        <span style="margin-left: 20px; display: block; margin-top: 4px;">${t}</span>\n      </div>`,type:CONST.CHAT_MESSAGE_TYPES.OTHER})}}(e,n,s)}(e,t,a,i,n,u)},getRiskDiceByRR:getRiskDiceByRR,getSuccessThreshold:function(e){switch(e){case"advantage":return 4;case"disadvantage":return 6;default:return 5}},handleRollRequest:handleRollRequest},Symbol.toStringTag,{value:"Module"}));function handleSheetUpdate(e,t){console.log("handleSheetUpdate - DEBUG:",{"actor.id":e?.id,"actor.name":e?.name,"actor.type":e?.type,"actor.uuid":e?.uuid});const a=foundry.utils.expandObject(t);if(a.system&&void 0!==a.system.damage){const t=e.system.damage||{};a.system.damage&&"object"==typeof a.system.damage||(a.system.damage={});const convertToArray=(e,t)=>{if(Array.isArray(e)){const a=[];for(let i=0;i<t;i++)void 0!==e[i]?a[i]=!0===e[i]||"true"===e[i]||"on"===e[i]:a[i]=!1;return a}if(e&&"object"==typeof e){const a=[];for(let i=0;i<t;i++){const t=i.toString();a[i]=!0===e[t]||"true"===e[t]||"on"===e[t]}return a}return Array(t).fill(!1)},i=Array.isArray(t.light)?t.light.length:2,n=Array.isArray(t.severe)?t.severe.length:1;void 0!==a.system.damage.light&&(a.system.damage.light=convertToArray(a.system.damage.light,i)),void 0!==a.system.damage.severe&&(a.system.damage.severe=convertToArray(a.system.damage.severe,n)),void 0!==a.system.damage.incapacitating&&(a.system.damage.incapacitating=!0===a.system.damage.incapacitating||"true"===a.system.damage.incapacitating||"on"===a.system.damage.incapacitating)}return a}function calculateFinalDamageValue(e,t,a){if("FOR"===e){const e=a+t;return t>0?`${e} (FOR+${t})`:`${e} (FOR)`}if(e.startsWith("FOR+")){const i=parseInt(e.substring(4))||0,n=a+i+t;return t>0?`${n} (FOR+${i}+${t})`:`${n} (FOR+${i})`}if("toxin"===e)return"selon toxine";{const a=parseInt(e)||0,i=a+t;return t>0?`${i} (${a}+${t})`:i.toString()}}function organizeSpecializationsBySkill(e,t){const a=/* @__PURE__ */new Map,i=[];return e.forEach(e=>{const n=e.system.linkedSkill;if(n){const s=t.find(e=>"skill"===e.type&&e.name===n);if(s&&s.id){const t=s.id;a.has(t)||a.set(t,[]),a.get(t).push(e)}else i.push(e)}else i.push(e)}),{bySkill:a,unlinked:i}}async function handleItemDrop(e,t,a=["feat","skill","specialization","metatype"]){const i=TextEditor.getDragEventData(e);if(i&&"Item"===i.type){const e=await Item.implementation.fromDropData(i);if(!e)return!1;if(e.actor&&e.actor.id===t.id)return!1;if(!a.includes(e.type))return!1;if("metatype"===e.type){return t.items.find(e=>"metatype"===e.type)?(ui.notifications?.warn(game.i18n.localize("SRA2.METATYPES.ONLY_ONE_METATYPE")),!1):(await t.createEmbeddedDocuments("Item",[e.toObject()]),!0)}if("feat"===e.type){return t.items.find(t=>"feat"===t.type&&t.name===e.name)?(ui.notifications?.warn(game.i18n.format("SRA2.FEATS.ALREADY_EXISTS",{name:e.name})),!1):(await t.createEmbeddedDocuments("Item",[e.toObject()]),!0)}if("skill"===e.type){return t.items.find(t=>"skill"===t.type&&t.name===e.name)?(ui.notifications?.warn(game.i18n.format("SRA2.SKILLS.ALREADY_EXISTS",{name:e.name})),!1):(await t.createEmbeddedDocuments("Item",[e.toObject()]),!0)}if("specialization"===e.type){return t.items.find(t=>"specialization"===t.type&&t.name===e.name)?(ui.notifications?.warn(game.i18n.format("SRA2.SPECIALIZATIONS.ALREADY_EXISTS",{name:e.name})),!1):(await t.createEmbeddedDocuments("Item",[e.toObject()]),!0)}}return!1}async function handleVehicleActorDrop(e,t){const a=TextEditor.getDragEventData(e);if(a&&"Actor"===a.type)try{const e=await fromUuid(a.uuid);if(!e)return!1;if("vehicle"!==e.type)return!1;const i=t.system.linkedVehicles||[];if(i.includes(e.uuid))return ui.notifications?.warn(game.i18n.format("SRA2.FEATS.VEHICLE_ALREADY_EXISTS",{name:e.name})),!1;const n=[...i,e.uuid];await t.update({"system.linkedVehicles":n});e.prototypeToken;const s={"prototypeToken.actorLink":!0};return e.prototypeToken||(s.prototypeToken=foundry.utils.mergeObject(foundry.data.PrototypeToken.defaults,{actorLink:!0})),await e.update(s),ui.notifications?.info(game.i18n.format("SRA2.FEATS.VEHICLE_ADDED",{name:e.name})),!0}catch(i){return console.error("Error handling vehicle actor drop:",i),!1}return!1}function getRRSources(e,t,a){const i=[],n=e.items.filter(e=>"feat"===e.type&&!0===e.system.active),s=normalizeSearchText(a);for(const l of n){const e=l.system.rrList||[];for(const a of e){const e=a.rrType,n=a.rrValue||0,o=normalizeSearchText(a.rrTarget||"");e===t&&o===s&&n>0&&i.push({featName:l.name,rrValue:n})}}return i}function calculateRR(e,t,a){return getRRSources(e,t,a).reduce((e,t)=>e+t.rrValue,0)}async function handleEditItem(e,t){e.preventDefault();const a=e.currentTarget,i=a.dataset.itemId||a.closest(".metatype-item")?.getAttribute("data-item-id");if(!i)return;const n=t.items.get(i);n&&n.sheet?.render(!0)}async function handleDeleteItem(e,t,a){e.preventDefault();const i=e.currentTarget,n=i.dataset.itemId||i.closest(".metatype-item")?.getAttribute("data-item-id");if(!n)return;const s=t.items.get(n);s&&(await s.delete(),a&&a(!1))}function calculateRawDamageString(e,t){if(t<=0||"0"===e||"toxin"===e)return e;if("FOR"===e)return`FOR+${t}`;if(e.startsWith("FOR+")){return`FOR+${(parseInt(e.substring(4))||0)+t}`}return((parseInt(e)||0)+t).toString()}function parseDamageCheckboxChange(e,t,a){const i=e.match(/(?:damage|cyberdeckDamage)\.(light|severe|incapacitating)(?:\.(\d+))?$/);if(!i)return null;const n=i[1],s=i[2]?parseInt(i[2],10):null,l={light:Array.isArray(a?.light)?[...a.light]:[!1,!1],severe:Array.isArray(a?.severe)?[...a.severe]:[!1],incapacitating:"boolean"==typeof a?.incapacitating&&a.incapacitating};if("incapacitating"===n)l.incapacitating=t;else if(("light"===n||"severe"===n)&&null!==s){for(;l[n].length<=s;)l[n].push(!1);l[n][s]=t}return l}function handleSectionNavigation(e,t){e.preventDefault();const a=e.currentTarget,i=a.dataset.section;if(!i)return null;const n=t instanceof HTMLElement?t:t.get(0);if(!n)return null;n.querySelectorAll(".section-nav .nav-item").forEach(e=>{e.classList.remove("active")}),a.classList.add("active"),n.querySelectorAll(".content-section").forEach(e=>{e.classList.remove("active")});const s=n.querySelector(`[data-section-content="${i}"]`);return s&&s.classList.add("active"),i}function restoreActiveSection(e,t,a=10){t&&setTimeout(()=>{const a=e.querySelector(`[data-section="${t}"]`);if(a){e.querySelectorAll(".section-nav .nav-item").forEach(e=>{e.classList.remove("active")}),a.classList.add("active"),e.querySelectorAll(".content-section").forEach(e=>{e.classList.remove("active")});const i=e.querySelector(`[data-section-content="${t}"]`);i&&i.classList.add("active")}},a)}function getCurrentActiveSection(e){const t=e.find(".section-nav .nav-item.active");return t.length>0?t.data("section"):null}function enrichFeats(e,t,a,i){return e.map(e=>{e.rrEntries=[];let n=[...e.system.rrList||[]];if(i&&("weapon"===e.system.featType||"spell"===e.system.featType||"weapons-spells"===e.system.featType)){const{normalizeSearchText:t}=r,a=e.system.linkedAttackSkill||"",s=e.system.linkedAttackSpecialization||"";let l,o,c;if(s){const e=i.items.find(e=>"specialization"===e.type&&t(e.name)===t(s));if(e){const t=e.system;l=e.name,c=t.linkedAttribute||"strength";const a=t.linkedSkill;if(a){const e=i.items.find(e=>"skill"===e.type&&e.name===a);e&&(o=e.name)}}}if(!l&&a){const e=i.items.find(e=>"skill"===e.type&&t(e.name)===t(a));e&&(o=e.name,c=e.system.linkedAttribute||"strength")}if(l){const e=getRRSources(i,"specialization",l);n=[...n,...e.map(e=>({rrType:"specialization",rrValue:e.rrValue,rrTarget:l}))]}if(o){const e=getRRSources(i,"skill",o);n=[...n,...e.map(e=>({rrType:"skill",rrValue:e.rrValue,rrTarget:o}))]}if(c){const e=getRRSources(i,"attribute",c);n=[...n,...e.map(e=>({rrType:"attribute",rrValue:e.rrValue,rrTarget:c}))]}}for(let t=0;t<n.length;t++){const a=n[t],i=a.rrType,s=a.rrValue||0,l=a.rrTarget||"";if(s>0){const t={rrType:i,rrValue:s,rrTarget:l};"attribute"===i&&l&&(t.rrTargetLabel=game.i18n.localize(`SRA2.ATTRIBUTES.${l.toUpperCase()}`)),e.rrEntries.push(t)}}const s="weapon"===e.system.featType,l="spell"===e.system.featType,o=e.system.isAdeptPowerWeapon||!1;if(s||l||o){const n=e.system.damageValue||"0";let s=e.system.damageValueBonus||0;if(i){const t=e.system.weaponType||"";i.items.filter(e=>"feat"===e.type&&!0===e.system.active&&e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===t).forEach(e=>{s+=e.system.weaponDamageBonus||0})}s=Math.min(s,2),e.finalDamageValue=a(n,s,t)}return e})}function normalizeForComparison(e){return normalizeSearchText(e).replace(/\s+/g,"").replace(/:/g,"").replace(/'/g,"")}function findAttackSkillAndSpec(e,t,a,i={}){const n={skillName:void 0,skillLevel:void 0,specName:void 0,specLevel:void 0,linkedAttribute:void 0},{isSpell:s=!1,spellSpecType:l="combat",defaultAttribute:o="strength"}=i;if(t){const a=normalizeForComparison(t),i=e.items.find(e=>{if("specialization"!==e.type)return!1;return normalizeForComparison(e.name)===a});i?_extractSpecAndSkillInfo(e,i,n,o):s&&(function(e,t,a){const i={combat:["combat"],detection:["détection","detection"],health:["santé","sante","health"],illusion:["illusion"],manipulation:["manipulation"],counterspell:["contresort","contre-sort"]}[t]||["combat"],n=i.map(e=>normalizeSearchText(e)),s=e.items.find(e=>{if("specialization"!==e.type)return!1;const t=normalizeSearchText(e.name),a=e.system?.linkedSkill;return!(!a||"sorcellerie"!==normalizeSearchText(a))&&n.some(e=>t.includes(e))});s&&_extractSpecAndSkillInfo(e,s,a,"willpower")}(e,l,n),n.specName||n.skillLevel||!game.items||function(e,t,a,i){const n=normalizeForComparison(t),s=game.items.find(e=>{if("specialization"!==e.type)return!1;return normalizeForComparison(e.name)===n}),l={combat:["combat"],detection:["détection","detection"],health:["santé","sante","health"],illusion:["illusion"],manipulation:["manipulation"],counterspell:["contresort","contre-sort"]};let o=s;if(!o){const e=(l[a]||["combat"]).map(e=>normalizeSearchText(e));o=game.items.find(t=>{if("specialization"!==t.type)return!1;const a=normalizeSearchText(t.name),i=t.system?.linkedSkill;return!(!i||"sorcellerie"!==normalizeSearchText(i))&&e.some(e=>a.includes(e))})}if(o){const t=o.system.linkedSkill;if(t){const a=e.items.find(e=>"skill"===e.type&&e.name===t);if(a){const t=a.system,n=t.linkedAttribute||"willpower";i.skillName=a.name,i.linkedAttribute=n;const s=(t.rating||0)+(e.system.attributes?.[n]||0);i.skillLevel=s}}}}(e,t,l,n))}if(!n.specName&&!n.skillLevel&&a){const t=e.items.find(e=>"skill"===e.type&&normalizeSearchText(e.name)===normalizeSearchText(a));if(t){const a=t.system.linkedAttribute||o;n.skillName=t.name,n.linkedAttribute=n.linkedAttribute||a;const i=t.system.rating||0,s=e.system.attributes?.[a]||0;n.skillLevel=i+s}else if(s&&game.items)!function(e,t){if(game.items.find(e=>"skill"===e.type&&"sorcellerie"===normalizeSearchText(e.name))){t.skillName="Sorcellerie",t.linkedAttribute="willpower";const a=e.system.attributes?.willpower||1;t.skillLevel=a}}(e,n);else if(!s){n.skillName=a,n.linkedAttribute=n.linkedAttribute||o;const t=e.system.attributes?.[o]||0;n.skillLevel=0+t}}return n}function _extractSpecAndSkillInfo(e,t,a,i){const n=t.system;a.specName=t.name,a.linkedAttribute=n.linkedAttribute||i;const s=n.linkedSkill;if(s){const t=e.items.find(e=>"skill"===e.type&&e.name===s);if(t&&a.linkedAttribute){a.skillName=t.name;const i=(t.system.rating||0)+(e.system.attributes?.[a.linkedAttribute]||0);a.skillLevel=i,a.specLevel=i+2}}}function calculateAttackPool(e,t,a=[],i=""){const n=t.specLevel||t.skillLevel||0;let s=[],l=[],o=[];t.specName&&(l=getRRSources(e,"specialization",t.specName)),t.skillName&&(s=getRRSources(e,"skill",t.skillName)),t.linkedAttribute&&(o=getRRSources(e,"attribute",t.linkedAttribute));const r=[...a.map(e=>({featName:i,rrValue:e.rrValue||0})),...l,...s,...o];return{totalDicePool:n,totalRR:Math.min(3,r.reduce((e,t)=>e+(t.rrValue||0),0)),allRRSources:r}}function findSkillByName(e,t){if(!e||!t)return;const a=normalizeSearchText(t);return e.items.find(e=>"skill"===e.type&&normalizeSearchText(e.name)===a)}function findSpecByName(e,t){if(!e||!t)return;const a=normalizeForComparison(t);return e.items.find(e=>"specialization"===e.type&&normalizeForComparison(e.name)===a)}function findItemInGame(e,t){if(!game.items||!t)return;const a=normalizeForComparison(t);return game.items.find(t=>t.type===e&&normalizeForComparison(t.name)===a)}function calculateSkillDicePool(e,t){if(!e||!t)return 0;const a=t.system,i=a.linkedAttribute||"strength";return(e.system.attributes?.[i]||0)+(a.rating||0)}const u=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,calculateAttackPool:calculateAttackPool,calculateFinalDamageValue:calculateFinalDamageValue,calculateRR:calculateRR,calculateRawDamageString:calculateRawDamageString,calculateSkillDicePool:calculateSkillDicePool,calculateSpecDicePool:function(e,t,a){if(!e||!t)return 0;const i=t.system.linkedSkill,n=a||findSkillByName(e,i);return n?calculateSkillDicePool(e,n)+2:0},enrichFeats:enrichFeats,findAttackSkillAndSpec:findAttackSkillAndSpec,findDefenseSelection:function(e,t,a){const i={defaultSelection:"",linkedSpec:void 0,linkedSkill:void 0},n=e.items.filter(e=>"skill"===e.type);if(t&&(i.linkedSpec=findSpecByName(e,t),i.linkedSpec)){i.defaultSelection=`spec-${i.linkedSpec.id}`;const t=i.linkedSpec.system.linkedSkill;return i.linkedSkill=findSkillByName(e,t),i}if(a&&(i.linkedSkill=findSkillByName(e,a),i.linkedSkill))return i.defaultSelection=`skill-${i.linkedSkill.id}`,i;if(t&&game.items){const a=findItemInGame("specialization",t);if(a){const t=a.system.linkedSkill;if(t&&(i.linkedSkill=findSkillByName(e,t),i.linkedSkill))return i.defaultSelection=`skill-${i.linkedSkill.id}`,i}}return n.length>0&&(i.linkedSkill=n[0],i.defaultSelection=`skill-${i.linkedSkill.id}`),i},findItemInGame:findItemInGame,findSkillByName:findSkillByName,findSpecByName:findSpecByName,getCurrentActiveSection:getCurrentActiveSection,getDamagePathFromInputName:function(e){if(e.includes("cyberdeckDamage")){const t=e.match(/(items\.[^.]+\.system\.cyberdeckDamage)/);return t&&t[1]?t[1]:"system.cyberdeckDamage"}return"system.damage"},getLinkedAttribute:function(e,t){if(!e)return"strength";const a=e.system;if("skill"===e.type)return a.linkedAttribute||"strength";if("specialization"===e.type&&t){const e=findSkillByName(t,a.linkedSkill);if(e)return e.system.linkedAttribute||"strength"}return a.linkedAttribute||"strength"},getRRSources:getRRSources,getSpecializationsForSkill:function(e,t){if(!e||!t)return[];const a=normalizeSearchText(t);return e.items.filter(e=>{if("specialization"!==e.type)return!1;const t=e.system?.linkedSkill;return t&&normalizeSearchText(t)===a})},handleDeleteItem:handleDeleteItem,handleEditItem:handleEditItem,handleItemDrop:handleItemDrop,handleSectionNavigation:handleSectionNavigation,handleSheetUpdate:handleSheetUpdate,handleVehicleActorDrop:handleVehicleActorDrop,normalizeForComparison:normalizeForComparison,organizeSpecializationsBySkill:organizeSpecializationsBySkill,parseDamageCheckboxChange:parseDamageCheckboxChange,parseDamageValue:function(e,t,a=0){const i={numericValue:0,displayValue:e,rawDamageString:e,isStrengthBased:!1,isToxin:!1};if("toxin"===e)return i.isToxin=!0,i.displayValue="selon toxine",i;if("FOR"===e)return i.isStrengthBased=!0,i.numericValue=t+a,a>0?(i.displayValue=`${i.numericValue} (FOR+${a})`,i.rawDamageString=`FOR+${a}`):(i.displayValue=`${i.numericValue} (FOR)`,i.rawDamageString="FOR"),i;if(e.startsWith("FOR+")){i.isStrengthBased=!0;const n=parseInt(e.substring(4))||0;i.numericValue=t+n+a;const s=n+a;return a>0?(i.displayValue=`${i.numericValue} (FOR+${n}+${a})`,i.rawDamageString=`FOR+${s}`):(i.displayValue=`${i.numericValue} (FOR+${n})`,i.rawDamageString=e),i}const n=parseInt(e)||0;return i.numericValue=n+a,a>0?(i.displayValue=`${i.numericValue} (${n}+${a})`,i.rawDamageString=i.numericValue.toString()):(i.displayValue=i.numericValue.toString(),i.rawDamageString=e),i},restoreActiveSection:restoreActiveSection},Symbol.toStringTag,{value:"Module"}));function prepareVehicleWeaponRollRequest(e,t,a){const n=t.system,s=n.weaponType||"custom-weapon",l=function(e,t){const a=e.system,n=t.system;let s=a.attributes?.autopilot;const l=a.vehicleType||"",o=l&&i[l]?i[l]:null,r=o?.autopilot||6,c=a.autopilotBonus||0;s=Math.min(12,r+c);const d=s,u=e.items.filter(e=>"feat"===e.type&&!0===e.system.active),m=[];u.forEach(e=>{(e.system.rrList||[]).forEach(t=>{"attribute"===t.rrType&&"autopilot"===t.rrTarget&&m.push({featName:e.name,rrValue:t.rrValue||0})})}),(n.rrList||[]).forEach(e=>{"attribute"===e.rrType&&"autopilot"===e.rrTarget&&m.push({featName:t.name,rrValue:e.rrValue||0})});const p=parseInt(n.damageValue||"0")||0;let h=parseInt(n.damageValueBonus||"0")||0;const g=n.weaponType||"";return u.forEach(e=>{e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===g&&(h+=e.system.weaponDamageBonus||0)}),h=Math.min(h,2),{dicePool:d,rrList:m,damageValue:(p+h).toString()}}(e,t);let o="",r="";if("custom-weapon"!==s){const e=a[s];e&&(o=e.linkedDefenseSkill||"",r=e.linkedDefenseSpecialization||"")}const c=o||n.linkedDefenseSkill||"",d=r||n.linkedDefenseSpecialization||"";return{itemType:"weapon",weaponType:s,itemName:t.name,itemId:t.id,itemRating:n.rating||0,itemActive:n.active,linkedAttackSkill:"",linkedAttackSpecialization:"",linkedDefenseSkill:c,linkedDefenseSpecialization:d,linkedAttribute:"autopilot",isWeaponFocus:n.isWeaponFocus||!1,damageValue:l.damageValue,meleeRange:n.meleeRange,shortRange:n.shortRange,mediumRange:n.mediumRange,longRange:n.longRange,skillName:void 0,skillLevel:l.dicePool,specName:void 0,specLevel:void 0,actorId:e.id,actorUuid:e.uuid,actorName:e.name||"",rrList:l.rrList}}async function applyDamage(e,t,a,i="physical"){const n=await fromUuid(e);if(!n)return void ui.notifications?.error(`Cannot find defender: ${a}`);const s=n.actor||n,l=s.system,o="vehicle"===s.type,r="ice"===s.type,c=function(e,t="physical"){const a=e.system,i="vehicle"===e.type;return"ice"===e.type?a.damageThresholds||{light:1,severe:2,incapacitating:3}:i?a.damageThresholds||{light:1,severe:4,incapacitating:7}:"mental"===t?a.damageThresholds?.mental||{light:1,severe:4,incapacitating:7}:"matrix"===t?a.damageThresholds?.matrix||{light:0,severe:0,incapacitating:0}:a.damageThresholds?.withArmor||{light:1,severe:4,incapacitating:7}}(s,i);let d={light:[...l.damage?.light||[]],severe:[...l.damage?.severe||[]],incapacitating:l.damage?.incapacitating||!1},u="",m=!1;if(r)if(c.incapacitating&&t>c.incapacitating)u=game.i18n.localize("SRA2.COMBAT.DAMAGE_INCAPACITATING"),d.incapacitating=!0;else if(t>(c?.severe||0)){u=game.i18n.localize("SRA2.COMBAT.DAMAGE_SEVERE");let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0,m=!0)}else{if(!(t>c.light))return void ui.notifications?.info(game.i18n.format("SRA2.COMBAT.DAMAGE_APPLIED",{damage:`${t} (en dessous du seuil)`,target:a}));{u=game.i18n.localize("SRA2.COMBAT.DAMAGE_LIGHT");let e=!1;for(let t=0;t<d.light.length;t++)if(!d.light[t]){d.light[t]=!0,e=!0;break}if(!e){ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT"));let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0),m=!0}}}else if(o)if(c.incapacitating&&t>c.incapacitating)u=game.i18n.localize("SRA2.COMBAT.DAMAGE_INCAPACITATING"),d.incapacitating=!0;else if(t>(c.severe||0)){u=game.i18n.localize("SRA2.COMBAT.DAMAGE_SEVERE");let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0,m=!0)}else{if(!(t>c.light))return void ui.notifications?.info(game.i18n.format("SRA2.COMBAT.DAMAGE_APPLIED",{damage:`${t} (en dessous du seuil)`,target:a}));{u=game.i18n.localize("SRA2.COMBAT.DAMAGE_LIGHT");let e=!1;for(let t=0;t<d.light.length;t++)if(!d.light[t]){d.light[t]=!0,e=!0;break}if(!e){ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT"));let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0),m=!0}}}else if(t>(c?.incapacitating||0))u=game.i18n.localize("SRA2.COMBAT.DAMAGE_INCAPACITATING"),d.incapacitating=!0;else if(c.severe&&t>(c.severe||0)){u=game.i18n.localize("SRA2.COMBAT.DAMAGE_SEVERE");let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0,m=!0)}else{if(!(t>c.light))return void ui.notifications?.info(game.i18n.format("SRA2.COMBAT.DAMAGE_APPLIED",{damage:`${t} (en dessous du seuil)`,target:a}));{u=game.i18n.localize("SRA2.COMBAT.DAMAGE_LIGHT");let e=!1;for(let t=0;t<d.light.length;t++)if(!d.light[t]){d.light[t]=!0,e=!0;break}if(!e){ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_LIGHT"));let e=!1;for(let t=0;t<d.severe.length;t++)if(!d.severe[t]){d.severe[t]=!0,e=!0;break}e||(ui.notifications?.info(game.i18n.localize("SRA2.COMBAT.DAMAGE_OVERFLOW_SEVERE")),d.incapacitating=!0),m=!0}}}await s.update({"system.damage":d}),!0===d.incapacitating?ui.notifications?.error(game.i18n.format("SRA2.COMBAT.NOW_INCAPACITATED",{target:a})):ui.notifications?.info(game.i18n.format("SRA2.COMBAT.DAMAGE_APPLIED",{damage:m?`${u} (débordement)`:u,target:a}))}class CharacterSheet extends ActorSheet{_activeSection="identity";static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","actor","character"],template:"systems/sra2/templates/actor-character-sheet.hbs",width:900,height:700,tabs:[],dragDrop:[{dragSelector:".metatype-item",dropSelector:null},{dragSelector:".feat-item",dropSelector:null},{dragSelector:".skill-item",dropSelector:null},{dragSelector:".specialization-item",dropSelector:null}],submitOnChange:!0})}async getData(){const e=super.getData();console.log("CharacterSheet.getData - DEBUG:",{"this.actor.id":this.actor.id,"this.actor.name":this.actor.name,"this.actor.type":this.actor.type,stack:(new Error).stack?.split("\n").slice(1,5).join("\n")}),e.system=this.actor.system;const t=e.system;if(t.damage){if(Array.isArray(t.damage.light)){if(t.damage.light.length<2)for(;t.damage.light.length<2;)t.damage.light.push(!1)}else t.damage.light=[!1,!1];Array.isArray(t.damage.severe)||(t.damage.severe=[!1]),"boolean"!=typeof t.damage.incapacitating&&(t.damage.incapacitating=!1)}else t.damage={light:[!1,!1],severe:[!1],incapacitating:!1};if(Array.isArray(t.anarchySpent)){if(t.anarchySpent.length<3)for(;t.anarchySpent.length<3;)t.anarchySpent.push(!1)}else t.anarchySpent=[!1,!1,!1];const i=this.actor.items.filter(e=>"metatype"===e.type);e.metatype=i.length>0?i[0]:null;const n=e.metatype&&e.metatype.system.anarchyBonus||0;e.baseAnarchy=3+n;const s=this.actor.items.filter(e=>"feat"===e.type&&!0===e.system.active);let l=0;s.forEach(e=>{l+=e.system.bonusAnarchy||0}),e.bonusAnarchy=l;const o=t.anarchySpent||[];e.baseAnarchySpent=o.slice(0,e.baseAnarchy).map((e,t)=>({value:e,index:t})),e.bonusAnarchySpent=o.slice(e.baseAnarchy).map((t,a)=>({value:t,index:e.baseAnarchy+a}));const r=this.actor.system.attributes?.strength||0,c=enrichFeats(this.actor.items.filter(e=>"feat"===e.type),r,calculateFinalDamageValue,this.actor),d=this.actor.system.linkedVehicles||[],u=[];for(const a of d)try{const e=await fromUuid(a);if(e&&"vehicle"===e.type){const t=[],i=e.items||[];for(const u of i){const i=u.system;if("feat"===u.type&&("weapon"===i.featType||"weapons-spells"===i.featType)){const n=enrichFeats([u],r,calculateFinalDamageValue,this.actor)[0];t.push({_id:u.id,uuid:u.uuid,name:u.name,img:u.img,type:"vehicle-weapon",vehicleUuid:a,vehicleName:e.name,weaponId:u.id,system:{...i,finalDamageValue:n.finalDamageValue,rrEntries:n.rrEntries||[],crr:i.crr||0}})}}const n=e.system;let s=1;s+=n.autopilotBonus||0,s+=n.speedBonus||0,s+=n.handlingBonus||0,s+=n.armorBonus||0,n.isFlying&&(s+=1),n.weaponMountImprovement&&(s+=1),n.autopilotUnlocked&&(s+=3),n.additionalDroneCount&&(s+=2*n.additionalDroneCount),n.isFixed&&(s-=1);const l=n.narrativeEffects||[];s+=l.filter(e=>{if("string"==typeof e)return e&&""!==e.trim();if(e&&"object"==typeof e){const t=e.text&&""!==e.text.trim(),a=void 0!==e.value&&null!==e.value&&0!==e.value;return t&&a}return!1}).length;const o=e.system?.damage||{},c=(Array.isArray(o.severe)?o.severe:[!1]).some(e=>!0===e),d=!0===o.incapacitating;u.push({_id:e.id,uuid:e.uuid,name:e.name,img:e.img,type:"vehicle-actor",system:{featType:"vehicle",autopilot:e.system?.attributes?.autopilot||0,structure:e.system?.attributes?.structure||0,handling:e.system?.attributes?.handling||0,speed:e.system?.attributes?.speed||0,armor:e.system?.attributes?.armor||0,weaponInfo:e.system?.weaponInfo||"",calculatedCost:e.system?.calculatedCost||0,description:e.system?.description||"",level:s},weapons:t,hasSevereDamage:c,isIncapacitating:d})}}catch(E){console.warn(`Failed to load vehicle actor ${a}:`,E)}const m=c.filter(e=>"vehicle"===e.system.featType),p=c.filter(e=>"cyberdeck"===e.system.featType);p.forEach(e=>{const t=e.system.firewall||1;e.cyberdeckDamageThresholds={light:t,severe:2*t,incapacitating:3*t};const a=!0===e.system.cyberdeckBonusLightDamage?3:2;if(e.system.cyberdeckDamage){if(Array.isArray(e.system.cyberdeckDamage.light)){const t=e.system.cyberdeckDamage.light.length;if(t<a)for(;e.system.cyberdeckDamage.light.length<a;)e.system.cyberdeckDamage.light.push(!1);else if(t>a)for(;e.system.cyberdeckDamage.light.length>a;)e.system.cyberdeckDamage.light.pop()}else e.system.cyberdeckDamage.light=Array(a).fill(!1);Array.isArray(e.system.cyberdeckDamage.severe)||(e.system.cyberdeckDamage.severe=[!1]),"boolean"!=typeof e.system.cyberdeckDamage.incapacitating&&(e.system.cyberdeckDamage.incapacitating=!1)}else e.system.cyberdeckDamage={light:Array(a).fill(!1),severe:[!1],incapacitating:!1}}),e.featsByType={trait:c.filter(e=>"trait"===e.system.featType),contact:c.filter(e=>"contact"===e.system.featType),awakened:c.filter(e=>"awakened"===e.system.featType),adeptPower:c.filter(e=>"adept-power"===e.system.featType||("weapon"===e.system.featType||"weapons-spells"===e.system.featType)&&!0===e.system.isAdeptPowerWeapon),equipment:c.filter(e=>"equipment"===e.system.featType),armor:c.filter(e=>"armor"===e.system.featType),cyberware:c.filter(e=>"cyberware"===e.system.featType),cyberdeck:p,vehicle:[...m,...u],weaponsSpells:c.filter(e=>"weapons-spells"===e.system.featType),weapon:c.filter(e=>"weapon"===e.system.featType),spell:c.filter(e=>"spell"===e.system.featType),connaissance:c.filter(e=>"connaissance"===e.system.featType),power:c.filter(e=>"power"===e.system.featType)},e.featsByType.weapon=e.featsByType.weapon.map(e=>{const t=e.system,i=t.weaponType;let n="",s="";if(i&&"custom-weapon"!==i){const e=a[i];e&&(n=e.linkedSkill||"",s=e.linkedSpecialization||"")}const l=n||t.linkedAttackSkill||"",o=s||t.linkedAttackSpecialization||"";let r;if(!this.actor.items.some(e=>"skill"===e.type&&normalizeSearchText(e.name)===normalizeSearchText(l))&&l){r=normalizeSearchText(l)===normalizeSearchText("Combat rapproché")?"strength":"agility"}else r="strength";const c=findAttackSkillAndSpec(this.actor,o,l,{defaultAttribute:r}),d=calculateAttackPool(this.actor,c,t.rrList||[],e.name);return e.totalDicePool=d.totalDicePool,e.rr=d.totalRR,c.specName&&(e.attackSpecName=c.specName,e.attackSpecLevel=c.specLevel),e});for(const a of e.featsByType.vehicle)"vehicle-actor"===a.type&&a.weapons&&(a.weapons=a.weapons.map(e=>{const t=e.system,a=findAttackSkillAndSpec(this.actor,"Spé : Armes contrôlées à distance","Ingénierie",{defaultAttribute:"logic"}),i=calculateAttackPool(this.actor,a,t.rrList||[],e.name);return e.totalDicePool=i.totalDicePool,e.rr=i.totalRR,e.linkedAttackSkill="Ingénierie",e.linkedAttackSpecialization="Spé : Armes contrôlées à distance",e.linkedDefenseSkill="Athlétisme",e.linkedDefenseSpecialization="Spé : Défense à distance",e}));e.featsByType.spell=e.featsByType.spell.map(e=>{const t=e.system,a=t.spellSpecializationType||"combat",i={combat:"Spé: Sorts de combat",detection:"Spé: Sorts de détection",health:"Spé: Sorts de santé",illusion:"Spé: Sorts d'illusion",manipulation:"Spé: Sorts de manipulation",counterspell:"Spé: Contresort"}[a]||"Spé: Sorts de combat",n=findAttackSkillAndSpec(this.actor,i,"Sorcellerie",{isSpell:!0,spellSpecType:a,defaultAttribute:"willpower"}),s=calculateAttackPool(this.actor,n,t.rrList||[],e.name);return e.totalDicePool=s.totalDicePool,e.rr=s.totalRR,n.specName&&(e.attackSpecName=n.specName,e.attackSpecLevel=n.specLevel),e}),e.featsByType.power=e.featsByType.power.map(e=>{const t=e.system,a=t.linkedAttackSkill||"",i=t.linkedAttackSpecialization||"",n=findAttackSkillAndSpec(this.actor,i,a,{defaultAttribute:"strength"}),s=(t.rrList||[]).map(t=>({...t,featName:e.name})),l=calculateAttackPool(this.actor,n,s,e.name);return e.totalDicePool=l.totalDicePool,e.rr=l.totalRR,e.skillName=n.skillName,e.specName=n.specName,e}),e.feats=c;const h=this.actor.items.filter(e=>("skill"===e.type||"specialization"===e.type||"feat"===e.type)&&!0===e.system.bookmarked);e.bookmarkedItems=h;const g=this.actor.items.filter(e=>"skill"===e.type).sort((e,t)=>e.name.localeCompare(t.name)),f=this.actor.items.filter(e=>"specialization"===e.type).sort((e,t)=>e.name.localeCompare(t.name)),{bySkill:S,unlinked:A}=organizeSpecializationsBySkill(f,this.actor.items.contents),y={strength:Math.min(3,this.calculateRR("attribute","strength")),agility:Math.min(3,this.calculateRR("attribute","agility")),willpower:Math.min(3,this.calculateRR("attribute","willpower")),logic:Math.min(3,this.calculateRR("attribute","logic")),charisma:Math.min(3,this.calculateRR("attribute","charisma"))};e.skills=g.map(e=>{const t=e.system?.linkedAttribute||"strength";e.linkedAttributeLabel=game.i18n.localize(`SRA2.ATTRIBUTES.${t.toUpperCase()}`);const a=this.calculateRR("skill",e.name),i=y[t]||0;e.rr=Math.min(3,a+i);const n=this.actor.system.attributes[t]||0,s=e.system?.rating||0;e.totalDicePool=n+s;const l=(S.get(e.id)||[]).sort((e,t)=>e.name.localeCompare(t.name));return e.specializations=l.map(t=>{const i=e.system?.rating||0;t.parentRating=i,t.effectiveRating=i+2,t.parentSkillName=e.name;const n=t.system?.linkedAttribute||"strength";t.linkedAttributeLabel=game.i18n.localize(`SRA2.ATTRIBUTES.${n.toUpperCase()}`);const s=this.calculateRR("specialization",t.name),l=y[n]||0,o=a;t.rr=Math.min(3,l+o+s);const r=this.actor.system.attributes[n]||0;return t.totalDicePool=r+t.effectiveRating,t}),e}),e.unlinkedSpecializations=A.sort((e,t)=>e.name.localeCompare(t.name)).map(e=>{const t=e.system?.linkedAttribute||"strength";e.linkedAttributeLabel=game.i18n.localize(`SRA2.ATTRIBUTES.${t.toUpperCase()}`);const a=this.calculateRR("specialization",e.name),i=y[t]||0;e.rr=Math.min(3,a+i);const n=this.actor.system.attributes[t]||0;return e.totalDicePool=n,e}),e.attributesRR=y,e.activeSection=this._activeSection;const k=t.damage||{},T=Array.isArray(k.severe)?k.severe:[!1];return e.hasSevereDamage=T.some(e=>!0===e),e}async close(e){return $(document).off("click.skill-search"),$(document).off("click.feat-search"),super.close(e)}activateListeners(e){super.activateListeners(e),e.find('[data-action="switch-sheet"]').on("click",this._onSwitchSheet.bind(this)),e.find(".section-nav .nav-item").on("click",this._onSectionNavigation.bind(this)),e.find('[data-action="edit-metatype"]').on("click",this._onEditMetatype.bind(this)),e.find('[data-action="delete-metatype"]').on("click",this._onDeleteMetatype.bind(this)),e.find('[data-action="edit-feat"]').on("click",this._onEditFeat.bind(this)),e.find('[data-action="delete-feat"]').on("click",this._onDeleteFeat.bind(this)),e.find('[data-action="open-vehicle"]').on("click",this._onOpenVehicle.bind(this)),e.find('[data-action="unlink-vehicle"]').on("click",this._onUnlinkVehicle.bind(this)),e.find('[data-action="edit-skill"]').on("click",this._onEditSkill.bind(this)),e.find('[data-action="delete-skill"]').on("click",this._onDeleteSkill.bind(this)),e.find('[data-action="edit-specialization"]').on("click",this._onEditSpecialization.bind(this)),e.find('[data-action="delete-specialization"]').on("click",this._onDeleteSpecialization.bind(this)),e.find('[data-action="roll-attribute"]').on("click",this._onRollAttribute.bind(this)),e.find('[data-action="roll-skill"]').on("click",this._onRollSkill.bind(this)),e.find('[data-action="quick-roll-skill"]').on("click",this._onQuickRollSkill.bind(this)),e.find('[data-action="roll-specialization"]').on("click",this._onRollSpecialization.bind(this)),e.find('[data-action="quick-roll-specialization"]').on("click",this._onQuickRollSpecialization.bind(this)),e.find('[data-action="send-catchphrase"]').on("click",this._onSendCatchphrase.bind(this)),e.on("click",'[data-action="toggle-bookmark"]',this._onToggleBookmark.bind(this)),e.find(".bookmark-item").on("click",this._onBookmarkItemClick.bind(this)),e.find('input[name^="system.damage"]').on("change",this._onDamageChange.bind(this)),e.find('input[name^="system.anarchySpent"]').on("change",this._onAnarchyChange.bind(this)),e.find('input[name*=".cyberdeckDamage."]').on("change",this._onCyberdeckDamageChange.bind(this)),e.find('[data-action="roll-weapon"]').on("click",this._onRollWeapon.bind(this)),e.find('[data-action="roll-spell"]').on("click",this._onRollSpell.bind(this)),e.find('[data-action="roll-power"]').on("click",this._onRollPower.bind(this)),e.find('[data-action="roll-weapon-spell"]').on("click",this._onRollWeaponSpell.bind(this)),e.find('[data-action="roll-vehicle-weapon"]').on("click",this._onRollVehicleWeaponFromSheet.bind(this)),e.find('[data-action="roll-vehicle-weapon-autopilot"]').on("click",this._onRollVehicleWeaponAutopilot.bind(this)),e.find('[data-action="roll-vehicle-autopilot"]').on("click",this._onRollVehicleAutopilot.bind(this)),e.find(".rating-input").on("change",this._onRatingChange.bind(this)),e.find(".skill-search-input").on("input",this._onSkillSearch.bind(this)),e.find(".skill-search-input").on("focus",this._onSkillSearchFocus.bind(this)),e.find(".skill-search-input").on("blur",this._onSkillSearchBlur.bind(this)),$(document).on("click.skill-search",t=>{const a=t.target,i=e.find(".skill-search-container")[0];i&&!i.contains(a)&&e.find(".skill-search-results").hide()}),e.find(".feat-search-input").on("input",this._onFeatSearch.bind(this)),e.find(".feat-search-input").on("focus",this._onFeatSearchFocus.bind(this)),e.find(".feat-search-input").on("blur",this._onFeatSearchBlur.bind(this)),$(document).on("click.feat-search",t=>{const a=t.target,i=e.find(".feat-search-container")[0];i&&!i.contains(a)&&e.find(".feat-search-results").hide()}),e.find(".feat-item").each((e,t)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",this._onDragStart.bind(this))}),e.find(".skill-item").each((e,t)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",this._onDragStart.bind(this))}),e.find(".specialization-item").each((e,t)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",this._onDragStart.bind(this))}),e.find(".vehicle-actor-item").each((e,t)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",this._onDragStart.bind(this))})}async _updateObject(e,t){const a=foundry.utils.expandObject(t);return void 0!==a.system?.damage&&delete a.system.damage,this.actor.update(a)}_onSectionNavigation(e){const t=handleSectionNavigation(e,this.form);t&&(this._activeSection=t)}async _onEditMetatype(e){return handleEditItem(e,this.actor)}async _onDeleteMetatype(e){return handleDeleteItem(e,this.actor,this.render.bind(this))}async _onEditFeat(e){return handleEditItem(e,this.actor)}async _onDeleteFeat(e){return handleDeleteItem(e,this.actor)}async _onEditSkill(e){return handleEditItem(e,this.actor)}async _onDeleteSkill(e){return handleDeleteItem(e,this.actor)}async _onEditSpecialization(e){return handleEditItem(e,this.actor)}async _onDeleteSpecialization(e){return handleDeleteItem(e,this.actor)}async _onOpenVehicle(e){e.preventDefault();const t=e.currentTarget.dataset.vehicleUuid;if(t)try{const e=await fromUuid(t);e&&e.sheet&&e.sheet.render(!0)}catch(a){console.error("Error opening vehicle sheet:",a),ui.notifications?.error("Erreur lors de l'ouverture de la fiche du véhicule")}}async _onUnlinkVehicle(e){e.preventDefault();const t=e.currentTarget.dataset.vehicleUuid;if(!t)return;const a=(this.actor.system.linkedVehicles||[]).filter(e=>e!==t);await this.actor.update({"system.linkedVehicles":a});try{const e=await fromUuid(t);e&&await e.update({"prototypeToken.actorLink":!1})}catch(i){console.warn("Could not update vehicle token prototype:",i)}ui.notifications?.info(game.i18n.localize("SRA2.FEATS.VEHICLE_UNLINKED"))}getRRSources(e,t){return getRRSources(this.actor,e,t)}calculateRR(e,t){return calculateRR(this.actor,e,t)}async _onRatingChange(e){e.preventDefault();const t=e.currentTarget,a=t.dataset.itemId,i=parseInt(t.value);if(!a||isNaN(i))return;const n=this.actor.items.get(a);n&&await n.update({system:{rating:i}})}async _onRollSpecialization(e){e.preventDefault();const t=e.currentTarget,a=t.dataset.itemId,i=parseInt(t.dataset.effectiveRating||"0");if(!a)return;const n=this.actor.items.get(a);if(!n||"specialization"!==n.type)return;const s=n.system,l=s.linkedAttribute||"strength",o=s.linkedSkill,r=this.actor.system.attributes?.[l]||0,c=o?this.actor.items.find(e=>"skill"===e.type&&e.name===o):null,d=c&&c.system.rating||0,u=this.getRRSources("specialization",n.name),m=this.getRRSources("attribute",l),p=[...u,...o?this.getRRSources("skill",o):[],...m];handleRollRequest({itemType:"specialization",itemName:n.name,itemId:n.id,specName:n.name,specLevel:r+i,skillName:o,skillLevel:d,linkedAttribute:l,actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name,rrList:p})}async _onQuickRollSkill(e){return this._onRollSkill(e)}async _onQuickRollSpecialization(e){return this._onRollSpecialization(e)}async _onRollAttribute(e){e.preventDefault();const t=e.currentTarget.dataset.attribute;if(!t)return;const a=this.actor.system.attributes?.[t]||0,i=game.i18n.localize(`SRA2.ATTRIBUTES.${t.toUpperCase()}`),n=this.getRRSources("attribute",t);handleRollRequest({itemType:"attribute",itemName:i,skillName:i,skillLevel:a,linkedAttribute:t,actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name,rrList:n})}async _onRollSkill(e){e.preventDefault();const t=e.currentTarget.dataset.itemId;if(!t)return;const a=this.actor.items.get(t);if(!a||"skill"!==a.type)return;const i=a.system,n=i.rating||0,s=i.linkedAttribute||"strength",l=this.actor.system.attributes?.[s]||0,o=[...this.getRRSources("skill",a.name),...this.getRRSources("attribute",s)];handleRollRequest({itemType:"skill",itemName:a.name,itemId:a.id,itemRating:n,skillName:a.name,skillLevel:l+n,linkedAttribute:s,actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name,rrList:o})}static async applyDamage(e,t,a,i="physical"){return applyDamage(e,t,a,i)}_onDragStart(e){const t=e.currentTarget.dataset.itemId,a=e.currentTarget.dataset.vehicleUuid;if(a){const t={type:"Actor",uuid:a};return void e.dataTransfer?.setData("text/plain",JSON.stringify(t))}if(!t)return;const i=this.actor.items.get(t);if(!i)return;if("feat"===i.type&&"vehicle"===i.system.featType){const t=i.system.vehicleActorUuid;if(t){const a={type:"Actor",uuid:t};return void e.dataTransfer?.setData("text/plain",JSON.stringify(a))}}const n={type:"Item",uuid:i.uuid};e.dataTransfer?.setData("text/plain",JSON.stringify(n))}async _onDrop(e){if(await handleItemDrop(e,this.actor))return;return await handleVehicleActorDrop(e,this.actor)?void 0:super._onDrop(e)}searchTimeout=null;async _onSkillSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=$(t).siblings(".skill-search-results")[0];this.searchTimeout&&clearTimeout(this.searchTimeout),0!==a.length?this.searchTimeout=setTimeout(async()=>{await this._performSkillSearch(a,i)},300):i.style.display="none"}async _performSkillSearch(e,t){this.lastSearchTerm=e;const a=await searchItemsEverywhere("skill",e,void 0,e=>itemExistsOnActor(this.actor,"skill",e));this._displaySkillSearchResults(a,t)}lastSearchTerm="";_displaySkillSearchResults(e,t){const a=this.lastSearchTerm.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),i=this.actor.items.find(e=>"skill"===e.type&&normalizeSearchText(e.name)===normalizeSearchText(this.lastSearchTerm));let n="";if(0===e.length)n=`\n        <div class="search-result-item no-results-create">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.SKILLS.SEARCH_NO_RESULTS")}\n          </div>\n          <button class="create-skill-btn" data-skill-name="${this.lastSearchTerm}">\n            <i class="fas fa-plus"></i> ${game.i18n.localize("SRA2.SKILLS.CREATE_SKILL")}\n          </button>\n        </div>\n      `;else{for(const t of e){const e=t.alreadyExists?"disabled":"",a=t.alreadyExists?"✓":game.i18n.localize("SRA2.SKILLS.ADD_SKILL");n+=`\n          <div class="search-result-item ${e}">\n            <div class="result-info">\n              <span class="result-name">${t.name}</span>\n              <span class="result-pack">${t.source}</span>\n            </div>\n            <button class="add-skill-btn" data-uuid="${t.uuid}" ${t.alreadyExists?"disabled":""}>\n              ${a}\n            </button>\n          </div>\n        `}i||(n+=`\n          <div class="search-result-item create-new-item">\n            <div class="result-info">\n              <span class="result-name"><i class="fas fa-plus-circle"></i> ${a}</span>\n              <span class="result-pack">${game.i18n.localize("SRA2.SKILLS.CREATE_NEW")}</span>\n            </div>\n            <button class="create-skill-btn-inline" data-skill-name="${this.lastSearchTerm}">\n              ${game.i18n.localize("SRA2.SKILLS.CREATE")}\n            </button>\n          </div>\n        `)}t.innerHTML=n,t.style.display="block",$(t).find(".add-skill-btn").on("click",this._onAddSkillFromSearch.bind(this)),$(t).find(".create-skill-btn, .create-skill-btn-inline").on("click",this._onCreateNewSkill.bind(this)),$(t).find(".search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)").on("click",e=>{if($(e.target).closest(".add-skill-btn").length>0)return;const t=$(e.currentTarget).find(".add-skill-btn")[0];t&&!t.disabled&&$(t).trigger("click")}),$(t).find(".search-result-item.create-new-item").on("click",e=>{if($(e.target).closest(".create-skill-btn-inline").length>0)return;const t=$(e.currentTarget).find(".create-skill-btn-inline")[0];t&&$(t).trigger("click")})}async _onAddSkillFromSearch(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.uuid;if(!a)return;const i=await fromUuid(a);if(!i)return void ui.notifications?.error("Skill not found");this.actor.items.find(e=>"skill"===e.type&&e.name===i.name)?ui.notifications?.warn(game.i18n.format("SRA2.SKILLS.ALREADY_EXISTS",{name:i.name})):(await this.actor.createEmbeddedDocuments("Item",[i.toObject()]),t.textContent="✓",t.disabled=!0,t.closest(".search-result-item")?.classList.add("disabled"),ui.notifications?.info(`${i.name} ${game.i18n.localize("SRA2.SKILLS.ADD_SKILL")}`))}_onSkillSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".skill-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}return Promise.resolve()}_onSkillSearchBlur(e){const t=e.currentTarget,a=e;return setTimeout(()=>{const e=$(t).siblings(".skill-search-results")[0];if(e){const t=a.relatedTarget;if(t&&e.contains(t))return;const i=document.activeElement;if(i&&e.contains(i))return;e.style.display="none"}},200),Promise.resolve()}async _onCreateNewSkill(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.skillName;if(!t)return;const a=t.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),i={name:a,type:"skill",system:{rating:1,linkedAttribute:"strength",description:""}},n=await this.actor.createEmbeddedDocuments("Item",[i]);if(n&&n.length>0){const e=n[0],t=this.element.find(".skill-search-input")[0];t&&(t.value="");const i=this.element.find(".skill-search-results")[0];i&&(i.style.display="none"),e&&e.sheet&&setTimeout(()=>{e.sheet.render(!0)},100),ui.notifications?.info(game.i18n.format("SRA2.SKILLS.SKILL_CREATED",{name:a}))}}featSearchTimeout=null;lastFeatSearchTerm="";async _onFeatSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=$(t).siblings(".feat-search-results")[0];this.featSearchTimeout&&clearTimeout(this.featSearchTimeout),0!==a.length?this.featSearchTimeout=setTimeout(async()=>{await this._performFeatSearch(a,i)},300):i.style.display="none"}async _performFeatSearch(e,t){this.lastFeatSearchTerm=e;const a=await searchItemsEverywhere("feat",e,this.actor,e=>this.actor.items.some(t=>"feat"===t.type&&t.name===e)),i=[];for(const s of a){let e="";try{const t=await fromUuid(s.uuid);t&&t.system&&(e=t.system.featType||"")}catch(n){console.warn("Could not load item for featType:",n)}i.push({name:s.name,uuid:s.uuid,pack:s.source,featType:e,exists:s.alreadyExists||!1})}this._displayFeatSearchResults(i,t)}_displayFeatSearchResults(e,t){const a=this.lastFeatSearchTerm.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),i=this.actor.items.find(e=>"feat"===e.type&&normalizeSearchText(e.name)===normalizeSearchText(this.lastFeatSearchTerm));let n="";if(0===e.length)n=`\n        <div class="search-result-item no-results-create">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.FEATS.SEARCH_NO_RESULTS")}\n          </div>\n          <select class="feat-type-selector">\n            <option value="equipment">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.EQUIPMENT")}</option>\n            <option value="trait">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.TRAIT")}</option>\n            <option value="contact">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CONTACT")}</option>\n            <option value="awakened">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.AWAKENED")}</option>\n            <option value="adept-power">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.ADEPT_POWER")}</option>\n            <option value="cyberware">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CYBERWARE")}</option>\n            <option value="cyberdeck">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CYBERDECK")}</option>\n            <option value="vehicle">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.VEHICLE")}</option>\n            <option value="weapons-spells">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS")}</option>\n            <option value="weapon">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.WEAPON")}</option>\n            <option value="spell">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.SPELL")}</option>\n            <option value="connaissance">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CONNAISSANCE")}</option>\n          </select>\n          <button class="create-feat-btn" data-feat-name="${this.lastFeatSearchTerm}">\n            <i class="fas fa-plus"></i> ${game.i18n.localize("SRA2.FEATS.CREATE")}\n          </button>\n        </div>\n      `;else{for(const t of e){const e=t.exists?"disabled":"",a=t.exists?"✓":game.i18n.localize("SRA2.FEATS.ADD_FEAT"),i=game.i18n.localize(`SRA2.FEATS.FEAT_TYPE.${t.featType.toUpperCase().replace("-","_")}`);n+=`\n          <div class="search-result-item ${e}">\n            <div class="result-info">\n              <span class="result-name">${t.name}</span>\n              <span class="result-pack">${t.pack} - ${i}</span>\n            </div>\n            <button class="add-feat-btn" data-uuid="${t.uuid}" ${t.exists?"disabled":""}>\n              ${a}\n            </button>\n          </div>\n        `}i||(n+=`\n          <div class="search-result-item create-new-item">\n            <div class="result-info">\n              <span class="result-name"><i class="fas fa-plus-circle"></i> ${a}</span>\n              <span class="result-pack">${game.i18n.localize("SRA2.FEATS.CREATE_NEW")}</span>\n            </div>\n            <select class="feat-type-selector-inline">\n              <option value="equipment">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.EQUIPMENT")}</option>\n              <option value="trait">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.TRAIT")}</option>\n              <option value="contact">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CONTACT")}</option>\n              <option value="awakened">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.AWAKENED")}</option>\n              <option value="adept-power">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.ADEPT_POWER")}</option>\n              <option value="cyberware">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CYBERWARE")}</option>\n              <option value="cyberdeck">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.CYBERDECK")}</option>\n              <option value="vehicle">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.VEHICLE")}</option>\n              <option value="weapons-spells">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.WEAPONS_SPELLS")}</option>\n              <option value="weapon">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.WEAPON")}</option>\n              <option value="spell">${game.i18n.localize("SRA2.FEATS.FEAT_TYPE.SPELL")}</option>\n            </select>\n            <button class="create-feat-btn-inline" data-feat-name="${this.lastFeatSearchTerm}">\n              ${game.i18n.localize("SRA2.FEATS.CREATE")}\n            </button>\n          </div>\n        `)}return t.innerHTML=n,t.style.display="block",$(t).find(".add-feat-btn").on("click",this._onAddFeatFromSearch.bind(this)),$(t).find(".create-feat-btn, .create-feat-btn-inline").on("click",this._onCreateNewFeat.bind(this)),$(t).find(".search-result-item:not(.disabled):not(.no-results-create):not(.create-new-item)").on("click",e=>{if($(e.target).closest(".add-feat-btn").length>0)return;const t=$(e.currentTarget).find(".add-feat-btn")[0];t&&!t.disabled&&$(t).trigger("click")}),$(t).find(".search-result-item.create-new-item").on("click",e=>{if($(e.target).closest(".create-feat-btn-inline, .feat-type-selector-inline").length>0)return;const t=$(e.currentTarget).find(".create-feat-btn-inline")[0];t&&$(t).trigger("click")}),Promise.resolve()}async _onAddFeatFromSearch(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.uuid;if(!a)return;const i=await fromUuid(a);if(!i)return void ui.notifications?.error("Feat not found");this.actor.items.find(e=>"feat"===e.type&&e.name===i.name)?ui.notifications?.warn(game.i18n.format("SRA2.FEATS.ALREADY_EXISTS",{name:i.name})):(await this.actor.createEmbeddedDocuments("Item",[i.toObject()]),t.textContent="✓",t.disabled=!0,t.closest(".search-result-item")?.classList.add("disabled"),ui.notifications?.info(`${i.name} ${game.i18n.localize("SRA2.FEATS.ADD_FEAT")}`))}_onFeatSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".feat-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}return Promise.resolve()}_onFeatSearchBlur(e){const t=e.currentTarget,a=e;return setTimeout(()=>{const e=$(t).siblings(".feat-search-results")[0];if(e){const t=a.relatedTarget;if(t&&e.contains(t))return;const i=document.activeElement;if(i&&e.contains(i))return;e.style.display="none"}},200),Promise.resolve()}async _onSendCatchphrase(e){e.preventDefault();const t=e.currentTarget.dataset.catchphrase;if(!t)return;const a={speaker:ChatMessage.getSpeaker({actor:this.actor}),content:`<div class="sra2-catchphrase">${t}</div>`};await ChatMessage.create(a)}async _onDamageChange(e){e.stopPropagation();const t=e.currentTarget,a=t.name,i=t.checked,n=this.actor._source,s=parseDamageCheckboxChange(a,i,n?.system?.damage||this.actor.system.damage||{light:[!1,!1],severe:[!1],incapacitating:!1});s&&(await this.actor.update({"system.damage":s},{render:!1}),this.render(!1))}async _onCyberdeckDamageChange(e){e.stopPropagation();const t=e.currentTarget,a=t.name,i=t.checked,n=a.match(/^items\.([^.]+)\./);if(!n||!n[1])return;const s=n[1],l=this.actor.items.get(s);if(!l)return;const o=l._source,r=parseDamageCheckboxChange(a,i,o?.system?.cyberdeckDamage||l.system.cyberdeckDamage||{light:[!1,!1],severe:[!1],incapacitating:!1});r&&(await l.update({"system.cyberdeckDamage":r},{render:!1}),this.render(!1))}async _onAnarchyChange(e){e.stopPropagation();const t=e.currentTarget,a=t.name,i=t.checked,n=a.match(/^system\.anarchySpent\.(\d+)$/);if(!n||!n[1])return;const s=parseInt(n[1],10),l=[...this.actor.system.anarchySpent||[!1,!1,!1]];for(;l.length<3;)l.push(!1);s>=0&&s<l.length&&(l[s]=i,await this.actor.update({"system.anarchySpent":l},{render:!1}),this.render(!1))}async _onToggleBookmark(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.target;let a=t.closest('[data-action="toggle-bookmark"]');if(!a&&"I"===t.tagName&&t.parentElement&&(a=t.parentElement,a.hasAttribute("data-action")||(a=a.closest('[data-action="toggle-bookmark"]'))),!a)return;const i=a.dataset.itemId;if(!i)return;const n=this.actor.items.get(i);if(!n)return;const s=n.system.bookmarked||!1;try{await n.update({"system.bookmarked":!s}),this.render(!1)}catch(l){console.error("Error toggling bookmark:",l),ui.notifications?.error(game.i18n?.localize("SRA2.BOOKMARKS.ERROR")||"Erreur lors de la mise à jour du bookmark")}}async _onBookmarkItemClick(e){e.preventDefault();const t=e.currentTarget,a=t.dataset.itemId,i=t.dataset.itemType;if(!a)return;const n=this.actor.items.get(a);if(n)if("skill"===i){const e={preventDefault:()=>{},currentTarget:{dataset:{itemId:a}}};await this._onRollSkill(e)}else if("specialization"===i){const e=n.system.linkedSkill,t=this.actor.items.find(t=>"skill"===t.type&&t.name===e),i={preventDefault:()=>{},currentTarget:{dataset:{itemId:a,effectiveRating:(t&&t.system.rating||0).toString()}}};await this._onRollSpecialization(i)}else if("feat"===i){const e=n.system.featType;if("weapon"===e){const e={preventDefault:()=>{},currentTarget:{dataset:{itemId:a}}};await this._onRollWeapon(e)}else if("spell"===e){const e={preventDefault:()=>{},currentTarget:{dataset:{itemId:a}}};await this._onRollSpell(e)}else if("weapons-spells"===e){const e={preventDefault:()=>{},currentTarget:{dataset:{itemId:a}}};await this._onRollWeaponSpell(e)}}}async _onRollVehicleWeaponFromSheet(e){e.preventDefault();const t=e.currentTarget,a=t.dataset.vehicleUuid,i=t.dataset.weaponId;a&&i?await this._onRollVehicleWeapon(a,i):console.error("SRA2 | Missing vehicle UUID or weapon ID")}async _onRollVehicleWeaponAutopilot(e){e.preventDefault();const t=e.currentTarget,i=t.dataset.vehicleUuid,n=t.dataset.weaponId;if(i&&n)try{const e=await fromUuid(i);if(!e||"vehicle"!==e.type)return void ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.INVALID_VEHICLE"));const t=e.items.get(n);if(!t||"weapon"!==t.system.featType)return void ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.INVALID_WEAPON"));if((e.system?.attributes?.autopilot||0)<=0)return void ui.notifications?.warn(game.i18n.localize("SRA2.ATTRIBUTES.NO_DICE"));handleRollRequest(prepareVehicleWeaponRollRequest(e,t,a))}catch(s){console.error("SRA2 | Error rolling vehicle weapon with autopilot:",s),ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.ROLL_ERROR"))}else console.error("SRA2 | Missing vehicle UUID or weapon ID")}async _onRollVehicleAutopilot(e){e.preventDefault();const t=e.currentTarget.dataset.vehicleUuid;if(t)try{const e=await fromUuid(t);if(!e||"vehicle"!==e.type)return void ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.INVALID_VEHICLE"));const a=e.system?.attributes?.autopilot||0;if(a<=0)return void ui.notifications?.warn(game.i18n.localize("SRA2.ATTRIBUTES.NO_DICE"));const i=e.name||"Véhicule",n=game.i18n.localize("SRA2.FEATS.VEHICLE.AUTOPILOT_SHORT"),s=[];handleRollRequest({itemType:"attribute",itemName:`${n} (${i})`,skillName:n,skillLevel:a,linkedAttribute:"autopilot",actorId:e.id,actorUuid:e.uuid,actorName:i,rrList:s})}catch(a){console.error("SRA2 | Error rolling vehicle autopilot:",a),ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.ROLL_ERROR"))}else console.error("SRA2 | Missing vehicle UUID")}async _onRollVehicleWeapon(e,t){try{const a=await fromUuid(e);if(!a||"vehicle"!==a.type)return void ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.INVALID_VEHICLE"));const i=a.items.get(t);if(!i||"weapon"!==i.system.featType)return void ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.INVALID_WEAPON"));const n=i.system,s=n.weaponType,l=n.crr||0,o=(n.rrList||[]).map(e=>({...e,featName:i.name})),r="Ingénierie",c="Spé : Armes contrôlées à distance",d="Athlétisme",u="Spé : Défense à distance",m=findAttackSkillAndSpec(this.actor,c,r,{defaultAttribute:"logic"}),p=m.skillName,h=m.skillLevel,g=m.specName,f=m.specLevel,S=m.linkedAttribute,A=findAttackSkillAndSpec(this.actor,u,d,{defaultAttribute:"agility"}),y=A.skillName,k=A.skillLevel,T=A.specName,E=A.specLevel,R=A.linkedAttribute,D=n.damageValue||"0";let v=n.damageValueBonus||0;this.actor.items.filter(e=>"feat"===e.type&&!0===e.system.active&&e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===s).forEach(e=>{v+=e.system.weaponDamageBonus||0}),v=Math.min(v,2);const b=calculateRawDamageString(D,v),I=calculateAttackPool(this.actor,m,o,i.name).allRRSources;l>0&&I.push({rrType:"attribute",rrValue:l,rrTarget:"CRR",featName:i.name}),handleRollRequest({itemType:"weapon",weaponType:s,itemName:`${i.name} (${a.name})`,itemId:i.id,itemRating:n.rating||0,itemActive:n.active,linkedAttackSkill:r,linkedAttackSpecialization:c,linkedDefenseSkill:d,linkedDefenseSpecialization:u,linkedAttribute:S,isWeaponFocus:n.isWeaponFocus||!1,damageValue:b,meleeRange:n.meleeRange,shortRange:n.shortRange,mediumRange:n.mediumRange,longRange:n.longRange,skillName:p,skillLevel:h,specName:g,specLevel:f,defenseSkillName:y,defenseSkillLevel:k,defenseSpecName:T,defenseSpecLevel:E,defenseLinkedAttribute:R,actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name||"",rrList:I,isVehicleWeapon:!0,vehicleUuid:e,vehicleName:a.name})}catch(a){console.error("Error rolling vehicle weapon:",a),ui.notifications?.error(game.i18n.localize("SRA2.VEHICLE.ROLL_ERROR"))}}async _onRollWeapon(e){e.preventDefault();const t=e.currentTarget.dataset.itemId;if(!t)return void console.error("SRA2 | No weapon ID found");const a=this.actor.items.get(t);a&&"feat"===a.type&&await this._rollWeaponOrSpell(a,"weapon")}async _onRollSpell(e){e.preventDefault();const t=e.currentTarget.dataset.itemId;if(!t)return void console.error("SRA2 | No spell ID found");const a=this.actor.items.get(t);a&&"feat"===a.type&&await this._rollWeaponOrSpell(a,"spell")}async _onRollPower(e){e.preventDefault();const t=e.currentTarget.dataset.itemId;if(!t)return void console.error("SRA2 | No power ID found");const a=this.actor.items.get(t);a&&"feat"===a.type&&await this._rollPower(a)}async _onRollWeaponSpell(e){e.preventDefault();const t=e.currentTarget.dataset.itemId;if(!t)return void console.error("SRA2 | No weapon/spell ID found");const a=this.actor.items.get(t);a&&"feat"===a.type&&await this._rollWeaponOrSpell(a,"weapon-spell")}async _rollWeaponOrSpell(e,t){const i=e.system,n="spell"===t,s=n?i.spellType||"indirect":null,l=i.weaponType;let o="",r="",c="",d="";if(l&&"custom-weapon"!==l){const e=a[l];e&&(o=e.linkedSkill||"",r=e.linkedSpecialization||"",c=e.linkedDefenseSkill||"",d=e.linkedDefenseSpecialization||"")}const u=(i.rrList||[]).map(t=>({...t,featName:e.name}));let m=o||i.linkedAttackSkill||"",p=r||i.linkedAttackSpecialization||"",h=c||i.linkedDefenseSkill||"",g=d||i.linkedDefenseSpecialization||"";if(n){m="Sorcellerie";p={combat:"Spé: Sorts de combat",detection:"Spé: Sorts de détection",health:"Spé: Sorts de santé",illusion:"Spé: Sorts d'illusion",manipulation:"Spé: Sorts de manipulation",counterspell:"Spé: Contresort"}[i.spellSpecializationType||"combat"]||"Spé: Sorts de combat","direct"===s?(h="",g=""):(h="Athlétisme",g="Spé : Défense à distance")}const f=n?i.spellSpecializationType||"combat":void 0;let S;if(n)S="willpower";else{if(!this.actor.items.some(e=>"skill"===e.type&&normalizeSearchText(e.name)===normalizeSearchText(m))&&m){S=normalizeSearchText(m)===normalizeSearchText("Combat rapproché")?"strength":"agility"}else S="strength"}const A=findAttackSkillAndSpec(this.actor,p,m,{isSpell:n,spellSpecType:f,defaultAttribute:S}),y=A.skillName,k=A.skillLevel,T=A.specName,E=A.specLevel,R=A.linkedAttribute;let D;if(n)if("direct"===s)D="0";else{D=(this.actor.system.attributes?.willpower||1).toString()}else{const e=i.damageValue||"0";let t=i.damageValueBonus||0;const a=i.weaponType||"";this.actor.items.filter(e=>"feat"===e.type&&!0===e.system.active&&e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===a).forEach(e=>{t+=e.system.weaponDamageBonus||0}),t=Math.min(t,2),D=calculateRawDamageString(e,t)}const v=calculateAttackPool(this.actor,A,u,e.name).allRRSources;console.log("SRA2 | _rollWeaponOrSpell - Values passed to roll dialog:",{itemName:e.name,itemRating:i.rating||0,skillName:y,skillLevel:k,specName:T,specLevel:E,linkedAttackSkill:m,linkedAttackSpecialization:p}),handleRollRequest({itemType:t,weaponType:l,itemName:e.name,itemId:e.id,itemRating:i.rating||0,itemActive:i.active,linkedAttackSkill:m,linkedAttackSpecialization:p,linkedDefenseSkill:h,linkedDefenseSpecialization:g,linkedAttribute:R,isWeaponFocus:i.isWeaponFocus||!1,damageValue:D,meleeRange:n?"ok":i.meleeRange||"none",shortRange:n?"ok":i.shortRange||"none",mediumRange:n?"ok":i.mediumRange||"none",longRange:n?"ok":i.longRange||"none",skillName:y,skillLevel:k,specName:T,specLevel:E,actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name||"",rrList:v,spellType:n?s:void 0,isSpellDirect:n&&"direct"===s})}async _rollPower(e){const t=e.system,a=t.linkedAttackSkill||"",i=t.linkedAttackSpecialization||"",n=t.linkedDefenseSkill||"",s=t.linkedDefenseSpecialization||"",l=(t.rrList||[]).map(t=>({...t,featName:e.name})),o=findAttackSkillAndSpec(this.actor,i,a,{defaultAttribute:"strength"}),r=calculateAttackPool(this.actor,o,l,e.name).allRRSources,c=t.damageValue||"0";let d=t.damageValueBonus||0;d=Math.min(d,2);const u=calculateRawDamageString(c,d);handleRollRequest({itemType:"power",itemName:e.name,itemId:e.id,itemRating:t.rating||0,itemActive:t.active,skillName:o.skillName,skillLevel:o.skillLevel,specName:o.specName,specLevel:o.specLevel,linkedAttribute:o.linkedAttribute,linkedAttackSkill:a,linkedAttackSpecialization:i,linkedDefenseSkill:n,linkedDefenseSpecialization:s,damageValue:u,meleeRange:t.meleeRange||"none",shortRange:t.shortRange||"none",mediumRange:t.mediumRange||"none",longRange:t.longRange||"none",actorId:this.actor.id,actorUuid:this.actor.uuid,actorName:this.actor.name||"",rrList:r,isPower:!0})}async _rollSkillWithWeapon(e,t,a,i,n){console.log("Skill with weapon roll disabled",{skill:e.name,weaponName:t})}async _rollSpecializationWithWeapon(e,t,a,i,n){console.log("Specialization with weapon roll disabled",{specialization:e.name,weaponName:t})}async _onCreateNewFeat(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.featName;if(!a)return;const i=$(t).siblings(".feat-type-selector, .feat-type-selector-inline")[0],n=i?i.value:"equipment",s=a.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),l={name:s,type:"feat",system:{description:"",rating:0,cost:"free-equipment",active:!0,featType:n,rrType:[],rrValue:[],rrTarget:[],bonusLightDamage:0,bonusSevereDamage:0,bonusPhysicalThreshold:0,bonusMentalThreshold:0,bonusAnarchy:0,essenceCost:0}},o=await this.actor.createEmbeddedDocuments("Item",[l]);if(o&&o.length>0){const e=o[0],t=this.element.find(".feat-search-input")[0];t&&(t.value="");const a=this.element.find(".feat-search-results")[0];a&&(a.style.display="none"),e&&e.sheet&&setTimeout(()=>{e.sheet.render(!0)},100),ui.notifications?.info(game.i18n.format("SRA2.FEATS.FEAT_CREATED",{name:s}))}}async _onSwitchSheet(e){e.preventDefault();const{CharacterSheetV2:t}=await Promise.resolve().then(()=>m),a=this instanceof t,i=this.actor;await this.close();const n=new(a?CharacterSheet:t)(i);setTimeout(()=>{n.render(!0)},100)}}class CharacterSheetV2 extends CharacterSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","actor","character","character-v2"],template:"systems/sra2/templates/actor-character-sheet-v2.hbs"})}activateListeners(e){super.activateListeners(e),e.find('[data-action="show-context-menu"]').on("click",this._onShowContextMenu.bind(this));const t=`context-menu-v2-${this.id}`;$(document).on(`click.${t}`,e=>{const t=e.target;$(t).closest('.context-menu, [data-action="show-context-menu"]').length||this.element.find(".context-menu.active").removeClass("active")}),e.find(".context-menu-item").on("click",e=>{e.stopPropagation();$(e.currentTarget).closest(".context-menu").removeClass("active")}),e.find('[data-action="toggle-active"]').on("click",this._onToggleActive.bind(this))}close(e){return $(document).off(`click.context-menu-v2-${this.id}`),super.close(e)}_onShowContextMenu(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.itemId,i=t.dataset.vehicleUuid;let n;if(this.element.find(".context-menu.active").removeClass("active"),a){n=$(t).closest(".row").find(`.context-menu[data-item-id="${a}"]`),0===n.length&&(n=this.element.find(`.context-menu[data-item-id="${a}"]`).first())}else{if(!i)return;n=$(t).closest(".row").find(`.context-menu[data-vehicle-uuid="${i}"]`),0===n.length&&(n=this.element.find(`.context-menu[data-vehicle-uuid="${i}"]`).first())}n.length&&n.addClass("active")}async _onToggleActive(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.itemId;if(!t)return;const a=this.actor.items.get(t);if(!a||"feat"!==a.type)return;const i=a.system.active??!0;await a.update({"system.active":!i}),this.render(!1)}}const m=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,CharacterSheetV2:CharacterSheetV2},Symbol.toStringTag,{value:"Module"}));class VehicleSheet extends ActorSheet{_activeSection=null;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","actor","vehicle"],template:"systems/sra2/templates/actor-vehicle-sheet.hbs",width:800,height:700,tabs:[],dragDrop:[{dragSelector:".item",dropSelector:".sheet-body"}],submitOnChange:!1})}async _updateObject(e,t){console.log("VehicleSheet._updateObject - DEBUG:",{"this.actor.id":this.actor.id,"this.actor.name":this.actor.name,"this.actor.type":this.actor.type,"this.actor.uuid":this.actor.uuid,"formData keys":Object.keys(t),"formData sample":Object.fromEntries(Object.entries(t).slice(0,5))});const a=handleSheetUpdate(this.actor,t);return void 0!==a.system?.damage&&delete a.system.damage,console.log("VehicleSheet._updateObject - About to update:",{"actor.id":this.actor.id,"expandedData keys":Object.keys(a),"expandedData.system keys":a.system?Object.keys(a.system):"no system","damage excluded":!a.system?.damage}),this.actor.update(a)}getData(){const e=super.getData();console.log("VehicleSheet.getData - DEBUG:",{"this.actor.id":this.actor.id,"this.actor.name":this.actor.name,"this.actor.type":this.actor.type,"context.actor.id":e.actor?.id,"context.actor.name":e.actor?.name}),e.system=this.actor.system;const t=this.actor._source,a=t?.system?.damage,n=this.actor.system.damage;console.log("VehicleSheet.getData - Damage data at opening:",{"actor.id":this.actor.id,"actor.name":this.actor.name,"_source.system.damage":a,"this.actor.system.damage":n,"sourceDamage type":typeof a,"currentDamage type":typeof n,"sourceDamage.light":a?.light,"currentDamage.light":n?.light,"sourceDamage.light type":Array.isArray(a?.light)?"array":typeof a?.light,"currentDamage.light type":Array.isArray(n?.light)?"array":typeof n?.light});const s=e.system;if(s.damage){for(Array.isArray(s.damage.light)||(s.damage.light=[!1,!1]);s.damage.light.length<2;)s.damage.light.push(!1);for(;s.damage.light.length>2;)s.damage.light.pop();for(Array.isArray(s.damage.severe)||(s.damage.severe=[!1]);s.damage.severe.length<1;)s.damage.severe.push(!1);for(;s.damage.severe.length>1;)s.damage.severe.pop();"boolean"!=typeof s.damage.incapacitating&&(s.damage.incapacitating=!1)}else s.damage={light:[!1,!1],severe:[!1],incapacitating:!1};e.vehicleTypes=i;const l=this.actor.items.filter(e=>"feat"===e.type),o=l.filter(e=>!0===e.system.active),r=this.actor.system.attributes?.structure||0,calculateWeaponStats=e=>{const t={...e,_id:e.id||e._id,id:e.id||e._id};let a=this.actor.system.attributes?.autopilot||0,i=0;o.forEach(e=>{(e.system.rrList||[]).forEach(e=>{"attribute"===e.rrType&&"autopilot"===e.rrTarget&&(i+=e.rrValue||0)})}),t.totalDicePool=a,t.totalRR=i;const n=e.system.damageValue||"0",s=e.system.damageValueBonus||0;return t.finalDamageValue=calculateFinalDamageValue(n,s,r),t},c=l.filter(e=>"weapon"===e.system.featType||"weapons-spells"===e.system.featType).map(e=>calculateWeaponStats(e));return e.weapons=c,e}activateListeners(e){super.activateListeners(e),this._activeSection&&setTimeout(()=>{const t=e.closest("form")[0];if(t){const e=t.querySelector(`[data-section="${this._activeSection}"]`);if(e){t.querySelectorAll(".section-nav .nav-item").forEach(e=>e.classList.remove("active")),e.classList.add("active"),t.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const a=t.querySelector(`[data-section-content="${this._activeSection}"]`);a&&a.classList.add("active")}}},10),e.find(".section-nav .nav-item").on("click",this._onSectionNavigation.bind(this)),e.find(".feat-edit, .weapon-edit").on("click",e=>{e.preventDefault();const t=$(e.currentTarget).data("item-id"),a=this.actor.items.get(t);a&&a.sheet?.render(!0)}),e.find(".feat-delete, .weapon-delete").on("click",async t=>{t.preventDefault();const a=e.find(".section-nav .nav-item.active");this._activeSection=a.length>0?a.data("section"):null;const i=$(t.currentTarget).data("item-id"),n=this.actor.items.get(i);if(n){await Dialog.confirm({title:game.i18n.format("SRA2.CONFIRM_DELETE",{name:n.name}),content:"",yes:()=>!0,no:()=>!1,defaultYes:!1})&&await n.delete()}}),e.find(".add-world-weapon-button").on("click",async t=>{t.preventDefault();const a=e.find(".section-nav .nav-item.active");this._activeSection=a.length>0?a.data("section"):null,this._showItemBrowser("feat",!0)}),e.find(".weapon-dice-pool").on("click",async e=>{e.preventDefault();const t=$(e.currentTarget).data("item-id"),i=this.actor.items.get(t);if(!i)return;if((this.actor.system.attributes?.autopilot||0)<=0)return void ui.notifications?.warn(game.i18n.localize("SRA2.ATTRIBUTES.NO_DICE"));handleRollRequest(prepareVehicleWeaponRollRequest(this.actor,i,a))}),e.find(".vehicle-type-select").on("change",this._onVehicleTypeChange.bind(this)),e.find('input[name="system.autopilotBonus"], input[name="system.speedBonus"], input[name="system.handlingBonus"], input[name="system.armorBonus"]').on("change",this._onBonusChange.bind(this)),e.find('input[name="system.isFixed"], input[name="system.isFlying"], input[name="system.weaponMountImprovement"], input[name="system.autopilotUnlocked"], input[name="system.additionalDroneCount"]').on("change",this._onOptionChange.bind(this)),e.find('[data-action="add-narrative-effect"]').on("click",async t=>{t.preventDefault();const a=[];e.find('textarea[name^="system.narrativeEffects."]').each((t,i)=>{const n=i,s=n.name.match(/system\.narrativeEffects\.(\d+)\.text/);if(s){const t=parseInt(s[1]),i=n.value||"",l=e.find(`select[name="system.narrativeEffects.${t}.value"]`),o=l.length>0&&parseInt(l.val())||0,r=o<0;a[t]={text:i,isNegative:r,value:o}}});for(let e=0;e<a.length;e++)a[e]||(a[e]={text:"",isNegative:!1,value:0});a.push({text:"",isNegative:!1,value:0}),await this.actor.update({"system.narrativeEffects":a})}),e.find('[data-action="remove-narrative-effect"]').on("click",async t=>{t.preventDefault();const a=parseInt($(t.currentTarget).data("index")||"0"),i=[];e.find('textarea[name^="system.narrativeEffects."]').each((t,a)=>{const n=a,s=n.name.match(/system\.narrativeEffects\.(\d+)\.text/);if(s){const t=parseInt(s[1]),a=n.value||"",l=e.find(`select[name="system.narrativeEffects.${t}.value"]`),o=l.length>0&&parseInt(l.val())||0,r=o<0;i[t]={text:a,isNegative:r,value:o}}});for(let e=0;e<i.length;e++)i[e]||(i[e]={text:"",isNegative:!1,value:0});i.splice(a,1),await this.actor.update({"system.narrativeEffects":i})});let t=null;const saveNarrativeEffects=async()=>{const t=[];e.find('textarea[name^="system.narrativeEffects."]').each((a,i)=>{const n=i,s=n.name.match(/system\.narrativeEffects\.(\d+)\.text/);if(s){const a=parseInt(s[1]),i=n.value||"",l=e.find(`select[name="system.narrativeEffects.${a}.value"]`),o=l.length>0&&parseInt(l.val())||0,r=o<0;t[a]={text:i,isNegative:r,value:o}}});for(let e=0;e<t.length;e++)t[e]||(t[e]={text:"",isNegative:!1,value:0});await this.actor.update({"system.narrativeEffects":t})};e.find('select[name^="system.narrativeEffects."]').on("change",async e=>{e.preventDefault(),t&&(clearTimeout(t),t=null),await saveNarrativeEffects()}),e.find('textarea[name^="system.narrativeEffects."]').on("input",e=>{t&&clearTimeout(t),t=setTimeout(async()=>{await saveNarrativeEffects(),t=null},500)}),e.find('textarea[name^="system.narrativeEffects."]').on("change blur",async e=>{t&&(clearTimeout(t),t=null),await saveNarrativeEffects()}),e.find('input[name^="system.damage."]').on("change",async t=>{const a=t.currentTarget,i=a.name,n=a.checked;console.log("VehicleSheet damage change - DEBUG:",{"this.actor.id":this.actor.id,"this.actor.name":this.actor.name,"this.actor.type":this.actor.type,"input.name":i,checked:n});const s=getCurrentActiveSection(e),l=this.actor._source,o=l?.system?.damage||this.actor.system.damage||{light:[!1,!1],severe:[!1],incapacitating:!1},r=parseDamageCheckboxChange(i,n,o);if(!r)return;await this.actor.update({"system.damage":r},{render:!1}),e.find(`input[name="${i}"]`).each((e,t)=>{const a=$(t);a.prop("checked",n),a.closest("label.track-box").toggleClass("checked",n)});const c=$(this.element).closest("form")[0];c&&s&&restoreActiveSection(c,s)})}_onSectionNavigation(e){const t=e.currentTarget.closest("form");if(!t)return;const a=handleSectionNavigation(e,t);a&&(this._activeSection=a)}async _onVehicleTypeChange(e){e.preventDefault();const t=e.currentTarget.value;t&&i[t]&&(await this.actor.update({"system.vehicleType":t}),this.render(!1))}async _onBonusChange(e){const t=e.currentTarget,a=t.name,i=parseInt(t.value)||0,n=getCurrentActiveSection($(this.element))||"attributes";await this.actor.update({[a]:i}),await this.render(!1);const s=$(this.element).closest("form")[0];s&&restoreActiveSection(s,n)}async _onOptionChange(e){const t=e.currentTarget,a=t.name,i=getCurrentActiveSection($(this.element))||"attributes";let n;n="checkbox"===t.type?t.checked:"number"===t.type?parseInt(t.value)||0:t.value,await this.actor.update({[a]:n}),await this.render(!1);const s=$(this.element).closest("form")[0];s&&restoreActiveSection(s,i)}async _showItemBrowser(e,t=!1){let a=game.items.filter(t=>t.type===e);t&&(a=a.filter(e=>{const t=e.system?.featType;return"weapon"===t||"weapons-spells"===t}));const i=a.map(e=>`<option value="${e.id}">${e.name}</option>`).join(""),n=`\n      <div class="form-group">\n        <label>${game.i18n.localize(`SRA2.${e.toUpperCase()}S.WORLD_ITEMS`)}</label>\n        <select id="item-select" style="width: 100%;">\n          <option value="">${game.i18n.localize(`SRA2.${e.toUpperCase()}S.SEARCH_PLACEHOLDER`)}</option>\n          ${i}\n        </select>\n      </div>\n    `;new Dialog({title:game.i18n.localize(`SRA2.${e.toUpperCase()}S.ADD_${e.toUpperCase()}`),content:n,buttons:{add:{icon:'<i class="fas fa-plus"></i>',label:game.i18n.localize(`SRA2.${e.toUpperCase()}S.ADD_${e.toUpperCase()}`),callback:async e=>{const t=e.find("#item-select").val();if(t){const e=game.items.get(t);e&&await this.actor.createEmbeddedDocuments("Item",[e.toObject()])}}},cancel:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("Cancel")}},default:"add"}).render(!0)}async _onDrop(e){const t=$(this.element).find(".section-nav .nav-item.active");let a;this._activeSection=t.length>0?t.data("section"):"attributes";try{a=JSON.parse(e.dataTransfer?.getData("text/plain")||"{}")}catch(i){return super._onDrop(e)}if("Item"===a.type){const e=await Item.fromDropData(a);if(e&&"feat"===e.type){const t=e.system.featType;return"weapon"===t||"weapons-spells"===t?(await this.actor.createEmbeddedDocuments("Item",[e.toObject()]),!1):(ui.notifications?.warn(game.i18n.localize("SRA2.VEHICLE.ONLY_WEAPONS_ALLOWED")),!1)}}return super._onDrop(e)}}class IceSheet extends ActorSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","actor","ice"],template:"systems/sra2/templates/actor-ice-sheet.hbs",width:600,height:500,tabs:[],dragDrop:[],submitOnChange:!1})}async _updateObject(e,t){const a=handleSheetUpdate(this.actor,t);return this.actor.update(a)}getData(){const e=super.getData();e.system=this.actor.system,e.iceTypes=s;const t=this.actor.system.iceType||"";return e.iceTypeDescription=this._getIceTypeDescription(t),e}activateListeners(e){super.activateListeners(e),e.find(".ice-type-select").on("change",this._onIceTypeChange.bind(this)),e.find('input[name="system.serverIndex"]').on("change",this._onServerIndexChange.bind(this)),e.find(".ice-attack-button").on("click",this._onIceAttack.bind(this))}async _onIceTypeChange(e){e.preventDefault();const t=e.currentTarget.value;await this.actor.update({"system.iceType":t||null}),this.render(!1)}async _onServerIndexChange(e){const t=e.currentTarget,a=parseInt(t.value)||1;await this.actor.update({"system.serverIndex":Math.max(1,Math.min(12,a))}),await this.render(!1)}_getIceTypeDescription(e){return{patrol:"SRA2.ICE.DESCRIPTION.PATROL",acid:"SRA2.ICE.DESCRIPTION.ACID",blaster:"SRA2.ICE.DESCRIPTION.BLASTER",blocker:"SRA2.ICE.DESCRIPTION.BLOCKER",black:"SRA2.ICE.DESCRIPTION.BLACK",glue:"SRA2.ICE.DESCRIPTION.GLUE",tracker:"SRA2.ICE.DESCRIPTION.TRACKER",killer:"SRA2.ICE.DESCRIPTION.KILLER"}[e]||""}async _onIceAttack(e){e.preventDefault();const t=canvas?.tokens?.controlled||[];if(0===t.length)return void ui.notifications?.warn(game.i18n.localize("SRA2.ICE.ATTACK.NO_TARGET"));const a=t[0],i=a.actor;if(!i)return void ui.notifications?.warn(game.i18n.localize("SRA2.ICE.ATTACK.NO_TARGET"));let n=null;if(this.actor.isToken)n=this.actor.token;else{n=(canvas?.tokens?.placeables||[]).find(e=>e.actor?.id===this.actor.id)||null}await async function(e,t,a,i){const n=e.system,s=n.iceType,l=n.serverIndex||1,o=n.threshold||l,r=n.damageValue||0;if(!["blaster","black","killer"].includes(s))return void ui.notifications?.warn(game.i18n.localize("SRA2.ICE.CANNOT_ATTACK"));const c=t?.uuid||t?.document?.uuid,d=i?.uuid||i?.document?.uuid,u=t?.actor?.uuid||e.uuid,m=i?.actor?.uuid||a.uuid,p={normalDice:[],riskDice:[],normalSuccesses:0,riskSuccesses:0,totalSuccesses:o,criticalFailures:0,finalRR:0,remainingFailures:0,complication:"none"},h={itemType:"ice-attack",iceType:s,serverIndex:l,threshold:o,damageValue:r.toString(),iceDamageValue:r,skillName:"Cybercombat (GLACE)",itemName:e.name,isAttack:!0,isDefend:!1,isCounterAttack:!1,isSpellDirect:!1};let g=null;if(a){let e=a.img;i&&(e=i.document?.texture?.src||i.document?.img||i.data?.img||i.texture?.src||a.img),g={...a,img:e}}const f={attacker:{...e,uuid:u},defender:g,rollData:h,rollResult:p,isAttack:!0,isDefend:!1,isCounterAttack:!1,skillName:"Cybercombat (GLACE)",itemName:e.name,damageValue:r.toString(),attackerUuid:u,defenderUuid:m,attackerTokenUuid:c,defenderTokenUuid:d},S=await renderTemplate("systems/sra2/templates/roll-result.hbs",f),A={user:game.user?.id,speaker:{actor:e.id,alias:e.name},content:S,type:CONST.CHAT_MESSAGE_TYPES.OTHER,flags:{sra2:{rollType:"ice-attack",attackerId:e.id,attackerUuid:u,attackerTokenUuid:c,defenderId:a?.id,defenderUuid:m,defenderTokenUuid:d,rollResult:p,rollData:h,iceType:s,iceThreshold:o,iceDamageValue:r}}};await ChatMessage.create(A)}(this.actor,n,i,a)}}class FeatSheet extends ItemSheet{_activeSection="general";powerSearchTimeout=null;static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","item","feat"],template:"systems/sra2/templates/item-feat-sheet.hbs",width:720,height:680,tabs:[],dragDrop:[{dropSelector:".rr-target-drop-zone"}],submitOnChange:!0})}getData(){const e=super.getData();this.item.prepareData(),e.system=this.item.system,e.activeSection=this._activeSection,e.finalDamageValue=this._calculateFinalDamageValue(),e.cyberdeckDamageThresholds=this._calculateCyberdeckDamageThresholds(),e.rrEntries=[];const t=e.system.rrList||[];for(let a=0;a<t.length;a++){const i=t[a],n=i.rrType,s=i.rrValue||0,l=i.rrTarget||"",o={index:a,rrType:n,rrValue:s,rrTarget:l,rrTargetName:l};if(("skill"===n||"specialization"===n)&&(o.rrTargetType="skill"===n?game.i18n.localize("SRA2.FEATS.RR_TYPE.SKILL"):game.i18n.localize("SRA2.FEATS.RR_TYPE.SPECIALIZATION"),this.item.actor&&l)){this.item.actor.items.find(e=>e.type===n&&e.name===l)||(o.rrTargetNotFound=!0)}e.rrEntries.push(o)}return e}activateListeners(e){super.activateListeners(e),e.find('[data-action="add-rr-entry"]').on("click",this._onAddRREntry.bind(this)),e.find('[data-action="remove-rr-entry"]').on("click",this._onRemoveRREntry.bind(this)),e.find('[data-action="clear-rr-target"]').on("click",this._onClearRRTarget.bind(this)),e.find('[data-action="add-narrative-effect"]').on("click",this._onAddNarrativeEffect.bind(this)),e.find('[data-action="remove-narrative-effect"]').on("click",this._onRemoveNarrativeEffect.bind(this)),e.find('input[name^="system.narrativeEffects"][name$=".isNegative"]').on("change",this._onNarrativeEffectNegativeChange.bind(this)),e.find('[data-action="select-weapon-type"]').on("change",this._onWeaponTypeChange.bind(this)),e.find(".damage-bonus-checkbox").on("change",this._onDamageValueBonusChange.bind(this)),e.find(".sustained-spell-checkbox").on("change",this._onSustainedSpellChange.bind(this)),e.find(".summoned-spirit-checkbox").on("change",this._onSummonedSpiritChange.bind(this)),e.find('.range-improvement-checkbox input[type="checkbox"]').on("change",this._onRangeImprovementChange.bind(this)),e.find('input[name="system.astralProjection"]').on("change",this._onAstralProjectionChange.bind(this)),e.find(".section-nav .nav-item").on("click",this._onSectionNavigation.bind(this)),e.find(".rr-target-search-input").on("input",this._onRRTargetSearch.bind(this)),e.find(".rr-target-search-input").on("focus",this._onRRTargetSearchFocus.bind(this)),e.find(".rr-target-search-input").on("blur",this._onRRTargetSearchBlur.bind(this)),$(document).on("click.rr-target-search",t=>{const a=t.target;e.find(".rr-target-search-container").each((e,t)=>{t.contains(a)||$(t).find(".rr-target-search-results").hide()})}),e.find(".power-skill-search-input").on("input",this._onPowerSkillSearch.bind(this)),e.find(".power-skill-search-input").on("focus",this._onPowerSkillSearchFocus.bind(this)),e.find(".power-skill-search-input").on("blur",this._onPowerSkillSearchBlur.bind(this)),e.find(".power-spec-search-input").on("input",this._onPowerSpecSearch.bind(this)),e.find(".power-spec-search-input").on("focus",this._onPowerSpecSearchFocus.bind(this)),e.find(".power-spec-search-input").on("blur",this._onPowerSpecSearchBlur.bind(this)),$(document).on("click.power-search",t=>{const a=t.target;if($(a).closest(".select-power-skill-btn, .select-power-spec-btn").length>0)return;if($(a).closest(".search-result-item").length>0)return;e.find(".power-skill-search-container, .power-spec-search-container").each((e,t)=>{t.contains(a)||$(t).find(".power-skill-search-results, .power-spec-search-results").hide()})})}_onSectionNavigation(e){e.preventDefault();const t=e.currentTarget,a=t.dataset.section;if(!a)return;if(this._activeSection=a,!this.form)return;const i=$(this.form);i.find(".section-nav .nav-item").removeClass("active"),t.classList.add("active"),i.find(".content-section").removeClass("active"),i.find(`[data-section-content="${a}"]`).addClass("active")}async _onAddRREntry(e){e.preventDefault();const t=[...this.item.system.rrList||[]];t.push({rrType:"skill",rrValue:0,rrTarget:""}),await this.item.update({"system.rrList":t}),this.render(!1)}async _onRemoveRREntry(e){e.preventDefault();const t=parseInt(e.currentTarget.dataset.index||"0"),a=[...this.item.system.rrList||[]];a.splice(t,1),await this.item.update({"system.rrList":a}),this.render(!1)}async _onClearRRTarget(e){e.preventDefault();const t=parseInt(e.currentTarget.dataset.index||"0"),a=[...this.item.system.rrList||[]];a[t]&&(a[t]={...a[t],rrTarget:""}),await this.item.update({"system.rrList":a}),this.render(!1)}async _onDrop(e){const t=TextEditor.getDragEventData(e);if(t&&"Item"===t.type){const a=await Item.implementation.fromDropData(t);if(!a)return super._onDrop(e);const i=e.target.closest("[data-rr-index]");if(!i)return super._onDrop(e);const n=parseInt(i.dataset.rrIndex||"0"),s=[...this.item.system.rrList||[]],l=s[n]?.rrType;if("skill"===a.type&&"skill"===l)return s[n]={...s[n],rrTarget:a.name},await this.item.update({"system.rrList":s}),this.render(!1),void ui.notifications?.info(game.i18n.format("SRA2.FEATS.LINKED_TO_TARGET",{name:a.name}));if("specialization"===a.type&&"specialization"===l)return s[n]={...s[n],rrTarget:a.name},await this.item.update({"system.rrList":s}),this.render(!1),void ui.notifications?.info(game.i18n.format("SRA2.FEATS.LINKED_TO_TARGET",{name:a.name}));if("skill"===l||"specialization"===l)return void ui.notifications?.warn(game.i18n.localize("SRA2.FEATS.WRONG_TARGET_TYPE"))}return super._onDrop(e)}async _onAddNarrativeEffect(e){e.preventDefault();const t=[...this.item.system.narrativeEffects||[]];t.push({text:"",isNegative:!1,value:1}),await this.item.update({"system.narrativeEffects":t}),this.render(!1)}async _onRemoveNarrativeEffect(e){e.preventDefault();const t=parseInt(e.currentTarget.dataset.index||"0"),a=[...this.item.system.narrativeEffects||[]];a.splice(t,1),await this.item.update({"system.narrativeEffects":a}),this.render(!1)}async _onNarrativeEffectNegativeChange(e){const t=e.currentTarget,a=t.name.match(/system\.narrativeEffects\.(\d+)\.isNegative/);if(!a||!a[1])return;const i=parseInt(a[1]),n=t.checked,s=[...this.item.system.narrativeEffects||[]];s[i]&&(s[i]={...s[i],isNegative:n,value:n?-1:1}),await this.item.update({"system.narrativeEffects":s}),this.render(!1)}_calculateFinalDamageValue(){const e=this.item.system.damageValue||"0",t=this.item.system.damageValueBonus||0,a=this.item.actor&&this.item.actor.system?.attributes?.strength||0;if("FOR"===e){const e=a+t;return this.item.actor?`${e} (FOR${t>0?`+${t}`:""})`:t>0?`FOR+${t}`:"FOR"}if(e.startsWith("FOR+")){const i=parseInt(e.substring(4))||0,n=a+i+t;return this.item.actor?`${n} (FOR+${i}${t>0?`+${t}`:""})`:t>0?`FOR+${i}+${t}`:`FOR+${i}`}if("toxin"===e)return"selon toxine";{const a=parseInt(e)||0,i=a+t;return t>0?`${i} (${a}+${t})`:i.toString()}}async _onWeaponTypeChange(e){e.preventDefault();const t=e.currentTarget.value;if(!t||!a[t])return;const i=a[t],n={"system.weaponType":t,"system.damageValue":"number"==typeof i.vd?i.vd.toString():i.vd,"system.meleeRange":i.melee,"system.shortRange":i.short,"system.mediumRange":i.medium,"system.longRange":i.long};if("custom-weapon"===t){const e=this.item.system;e.linkedAttackSkill||(n["system.linkedAttackSkill"]=i.linkedSkill),e.linkedAttackSpecialization||(n["system.linkedAttackSpecialization"]=i.linkedSpecialization),e.linkedDefenseSkill||(n["system.linkedDefenseSkill"]=i.linkedDefenseSkill),e.linkedDefenseSpecialization||(n["system.linkedDefenseSpecialization"]=i.linkedDefenseSpecialization)}await this.item.update(n),this.render(!1)}_calculateCyberdeckDamageThresholds(){const e=this.item.system.firewall||1;return{light:e,severe:2*e,incapacitating:3*e}}_onDamageValueBonusChange(e){e.preventDefault();const t=e.currentTarget,a=parseInt(t.dataset.bonusValue||"0"),i=this.item.system.damageValueBonus||0;let n;n=t.checked?a:2===a&&2===i?1:1===a&&i>=1?0:i;const s=this.element.find('input[name="system.damageValueBonus"]')[0];s&&(s.value=n.toString());this.element.find(".damage-bonus-checkbox").each((e,t)=>{const a=t,i=parseInt(a.dataset.bonusValue||"0");1===i?a.checked=n>=1:2===i&&(a.checked=2===n)})}_onSustainedSpellChange(e){e.preventDefault();const t=e.currentTarget,a=parseInt(t.dataset.spellValue||"0"),i=this.item.system.sustainedSpellCount||0;let n;n=t.checked?a:2===a&&2===i?1:1===a&&i>=1?0:i;const s=this.element.find('input[name="system.sustainedSpellCount"]')[0];s&&(s.value=n.toString());this.element.find(".sustained-spell-checkbox").each((e,t)=>{const a=t,i=parseInt(a.dataset.spellValue||"0");1===i?a.checked=n>=1:2===i&&(a.checked=2===n)})}_onSummonedSpiritChange(e){e.preventDefault();const t=e.currentTarget.checked?1:0,a=this.element.find('input[name="system.summonedSpiritCount"]')[0];a&&(a.value=t.toString())}_onRangeImprovementChange(e){e.preventDefault();const t=e.currentTarget,a=t.checked,i=t.closest(".range-row");if(!i)return;const n=i.querySelector("select");if(!n)return;const s=i.querySelector(".range-label")?.textContent||"";let l="";s.includes("Contact")||s.includes("Melee")||s.includes("Mêlée")?l="system.meleeRange":s.includes("Courte")||s.includes("Short")?l="system.shortRange":s.includes("Moyenne")||s.includes("Medium")?l="system.mediumRange":(s.includes("Longue")||s.includes("Long"))&&(l="system.longRange");const o=n.value;let r=o;a?"none"===o?r="disadvantage":"disadvantage"===o&&(r="ok"):"ok"===o?r="disadvantage":"disadvantage"===o&&(r="none"),n.value=r;const c=this.element.find(`input[name="${l}"]`)[0];c&&(c.value=r)}async _onAstralProjectionChange(e){if(e.currentTarget.checked){const e=this.element.find('input[name="system.astralPerception"]')[0];e&&(e.checked=!0),await this.item.update({"system.astralPerception":!0}),this.render(!1)}}rrTargetSearchTimeout=null;async _onRRTargetSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=parseInt(t.dataset.rrIndex||"0"),n=$(t).siblings(".rr-target-search-results")[0];this.rrTargetSearchTimeout&&clearTimeout(this.rrTargetSearchTimeout),0!==a.length?this.rrTargetSearchTimeout=setTimeout(async()=>{await this._performRRTargetSearch(a,i,n)},300):n.style.display="none"}async _performRRTargetSearch(e,t,a){const i=[],n=this.item.system.rrList||[],s=n[t]?.rrType;if(s&&"attribute"!==s){if(this.item.actor)for(const t of this.item.actor.items)t.type===s&&normalizeSearchText(t.name).includes(e)&&i.push({name:t.name,uuid:t.uuid,source:game.i18n.localize("SRA2.FEATS.FROM_ACTOR"),type:s});if(game.items)for(const t of game.items)if(t.type===s&&normalizeSearchText(t.name).includes(e)){i.some(e=>e.name===t.name)||i.push({name:t.name,uuid:t.uuid,source:game.i18n.localize("SRA2.SKILLS.WORLD_ITEMS"),type:s})}for(const t of game.packs){if("Item"!==t.documentName)continue;const a=await t.getDocuments();for(const n of a)if(n.type===s&&normalizeSearchText(n.name).includes(e)){i.some(e=>e.name===n.name)||i.push({name:n.name,uuid:n.uuid,source:t.title,type:s})}}this._displayRRTargetSearchResults(i,t,a)}else a.style.display="none"}_displayRRTargetSearchResults(e,t,a){let i="";if(0===e.length)i=`\n        <div class="search-result-item no-results">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.SKILLS.SEARCH_NO_RESULTS")}\n          </div>\n        </div>\n      `;else for(const n of e){const e="skill"===n.type?game.i18n.localize("SRA2.FEATS.RR_TYPE.SKILL"):game.i18n.localize("SRA2.FEATS.RR_TYPE.SPECIALIZATION");i+=`\n          <div class="search-result-item" data-result-name="${n.name}" data-rr-index="${t}">\n            <div class="result-info">\n              <span class="result-name">${n.name}</span>\n              <span class="result-pack">${n.source} - ${e}</span>\n            </div>\n            <button class="add-rr-target-btn" data-target-name="${n.name}" data-rr-index="${t}">\n              ${game.i18n.localize("SRA2.FEATS.SELECT")}\n            </button>\n          </div>\n        `}a.innerHTML=i,a.style.display="block",$(a).find(".add-rr-target-btn").on("click",this._onSelectRRTarget.bind(this)),$(a).find(".search-result-item:not(.no-results)").on("click",e=>{if($(e.target).closest(".add-rr-target-btn").length>0)return;const t=$(e.currentTarget).find(".add-rr-target-btn")[0];t&&$(t).trigger("click")})}async _onSelectRRTarget(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,a=t.dataset.targetName,i=parseInt(t.dataset.rrIndex||"0");if(!a)return;const n=[...this.item.system.rrList||[]];n[i]&&(n[i]={...n[i],rrTarget:a}),await this.item.update({"system.rrList":n}),this.render(!1),ui.notifications?.info(game.i18n.format("SRA2.FEATS.LINKED_TO_TARGET",{name:a}))}_onRRTargetSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".rr-target-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}}_onRRTargetSearchBlur(e){const t=e.currentTarget,a=e;setTimeout(()=>{const e=$(t).siblings(".rr-target-search-results")[0];if(e){const t=a.relatedTarget;if(t&&e.contains(t))return;const i=document.activeElement;if(i&&e.contains(i))return;e.style.display="none"}},200)}async _onPowerSkillSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=t.dataset.field||"",n=$(t).siblings(".power-skill-search-results")[0];this.powerSearchTimeout&&clearTimeout(this.powerSearchTimeout),0!==a.length?this.powerSearchTimeout=setTimeout(async()=>{await this._performPowerSkillSearch(a,i,n)},300):n.style.display="none"}async _performPowerSkillSearch(e,t,a){const i=[];if(this.item.actor)for(const n of this.item.actor.items)"skill"===n.type&&normalizeSearchText(n.name).includes(e)&&i.push({name:n.name,uuid:n.uuid,source:game.i18n.localize("SRA2.FEATS.FROM_ACTOR"),type:"skill"});if(game.items)for(const n of game.items)if("skill"===n.type&&normalizeSearchText(n.name).includes(e)){i.some(e=>e.name===n.name)||i.push({name:n.name,uuid:n.uuid,source:game.i18n.localize("SRA2.SKILLS.WORLD_ITEMS"),type:"skill"})}for(const n of game.packs){if("Item"!==n.documentName)continue;const t=await n.getDocuments();for(const a of t)if("skill"===a.type&&normalizeSearchText(a.name).includes(e)){i.some(e=>e.name===a.name)||i.push({name:a.name,uuid:a.uuid,source:n.title,type:"skill"})}}this._displayPowerSkillSearchResults(i,t,a)}_displayPowerSkillSearchResults(e,t,a){let i="";if(0===e.length)i=`\n        <div class="search-result-item no-results">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.SKILLS.SEARCH_NO_RESULTS")}\n          </div>\n        </div>\n      `;else for(const n of e)i+=`\n          <div class="search-result-item" data-result-name="${n.name}" data-field="${t}">\n            <div class="result-info">\n              <span class="result-name">${n.name}</span>\n              <span class="result-pack">${n.source}</span>\n            </div>\n            <button class="select-power-skill-btn" data-target-name="${n.name}" data-field="${t}">\n              ${game.i18n.localize("SRA2.FEATS.SELECT")}\n            </button>\n          </div>\n        `;a.innerHTML=i,a.style.display="block",$(a).off("mousedown",".select-power-skill-btn"),$(a).off("mousedown",".search-result-item"),$(a).on("mousedown",".select-power-skill-btn",this._onSelectPowerSkill.bind(this)),$(a).on("mousedown",".search-result-item:not(.no-results)",e=>{if($(e.target).closest(".select-power-skill-btn").length>0)return;const t=$(e.currentTarget).find(".select-power-skill-btn")[0];t&&$(t).trigger("mousedown")})}async _onSelectPowerSkill(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.currentTarget,a=t.dataset.targetName,i=t.dataset.field;if(!a||!i)return;const n=$(t).closest(".power-skill-search-container"),s=n.find(`input[name="system.${i}"]`)[0];s&&(s.value=a,$(s).trigger("change"));const l=n.find(".power-skill-search-results")[0];l&&(l.style.display="none")}_onPowerSkillSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".power-skill-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}}_onPowerSkillSearchBlur(e){const t=e.currentTarget,a=e;setTimeout(()=>{const i=$(t).siblings(".power-skill-search-results")[0];if(i){const t=a.relatedTarget;if(t&&i.contains(t))return;const n=document.activeElement;if(n&&i.contains(n))return;const s=e.originalEvent;if(s&&s.relatedTarget&&i.contains(s.relatedTarget))return;i.style.display="none"}},300)}async _onPowerSpecSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=t.dataset.field||"",n=$(t).siblings(".power-spec-search-results")[0];this.powerSearchTimeout&&clearTimeout(this.powerSearchTimeout),0!==a.length?this.powerSearchTimeout=setTimeout(async()=>{await this._performPowerSpecSearch(a,i,n)},300):n.style.display="none"}async _performPowerSpecSearch(e,t,a){const i=[];if(this.item.actor)for(const n of this.item.actor.items)"specialization"===n.type&&normalizeSearchText(n.name).includes(e)&&i.push({name:n.name,uuid:n.uuid,source:game.i18n.localize("SRA2.FEATS.FROM_ACTOR"),type:"specialization"});if(game.items)for(const n of game.items)if("specialization"===n.type&&normalizeSearchText(n.name).includes(e)){i.some(e=>e.name===n.name)||i.push({name:n.name,uuid:n.uuid,source:game.i18n.localize("SRA2.SKILLS.WORLD_ITEMS"),type:"specialization"})}for(const n of game.packs){if("Item"!==n.documentName)continue;const t=await n.getDocuments();for(const a of t)if("specialization"===a.type&&normalizeSearchText(a.name).includes(e)){i.some(e=>e.name===a.name)||i.push({name:a.name,uuid:a.uuid,source:n.title,type:"specialization"})}}this._displayPowerSpecSearchResults(i,t,a)}_displayPowerSpecSearchResults(e,t,a){let i="";if(0===e.length)i=`\n        <div class="search-result-item no-results">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.SKILLS.SEARCH_NO_RESULTS")}\n          </div>\n        </div>\n      `;else for(const n of e)i+=`\n          <div class="search-result-item" data-result-name="${n.name}" data-field="${t}">\n            <div class="result-info">\n              <span class="result-name">${n.name}</span>\n              <span class="result-pack">${n.source}</span>\n            </div>\n            <button class="select-power-spec-btn" data-target-name="${n.name}" data-field="${t}">\n              ${game.i18n.localize("SRA2.FEATS.SELECT")}\n            </button>\n          </div>\n        `;a.innerHTML=i,a.style.display="block",$(a).off("mousedown",".select-power-spec-btn"),$(a).off("mousedown",".search-result-item"),$(a).on("mousedown",".select-power-spec-btn",this._onSelectPowerSpec.bind(this)),$(a).on("mousedown",".search-result-item:not(.no-results)",e=>{if($(e.target).closest(".select-power-spec-btn").length>0)return;const t=$(e.currentTarget).find(".select-power-spec-btn")[0];t&&$(t).trigger("mousedown")})}async _onSelectPowerSpec(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.currentTarget,a=t.dataset.targetName,i=t.dataset.field;if(!a||!i)return;const n=$(t).closest(".power-spec-search-container"),s=n.find(`input[name="system.${i}"]`)[0];s&&(s.value=a,$(s).trigger("change"));const l=n.find(".power-spec-search-results")[0];l&&(l.style.display="none")}_onPowerSpecSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".power-spec-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}}_onPowerSpecSearchBlur(e){const t=e.currentTarget,a=e;setTimeout(()=>{const i=$(t).siblings(".power-spec-search-results")[0];if(i){const t=a.relatedTarget;if(t&&i.contains(t))return;const n=document.activeElement;if(n&&i.contains(n))return;const s=e.originalEvent;if(s&&s.relatedTarget&&i.contains(s.relatedTarget))return;i.style.display="none"}},300)}async close(e){return $(document).off("click.rr-target-search"),$(document).off("click.power-search"),super.close(e)}async _updateObject(e,t){const a=foundry.utils.expandObject(t);if(!0===a.system?.astralProjection&&(a.system.astralPerception=!0),!0===a.system?.isFirstFeat&&"trait"===a.system?.featType&&this.item.actor){const e=this.item.actor.items.filter(e=>"feat"===e.type&&e.id!==this.item.id&&"trait"===e.system?.featType&&!0===e.system?.isFirstFeat);if(e.length>0){for(const t of e)await t.update({"system.isFirstFeat":!1});ui.notifications?.info(game.i18n.localize("SRA2.FEATS.FIRST_FEAT_TRANSFERRED")||'The "first trait" flag has been moved from the other trait(s) to this one.')}}await this.item.update(a),this.item.prepareData();const i=this.item.system.recommendedLevel||0;return(this.item.system.rating||0)!==i&&await this.item.update({"system.rating":i}),this.item}}class SkillSheet extends ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","item","skill"],template:"systems/sra2/templates/item-skill-sheet.hbs",width:520,height:480,tabs:[],submitOnChange:!0})}getData(){const e=super.getData();return e.system=this.item.system,e}async _updateObject(e,t){const a=foundry.utils.expandObject(t);return this.item.update(a)}}class SpecializationSheet extends ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","item","specialization"],template:"systems/sra2/templates/item-specialization-sheet.hbs",width:520,height:480,tabs:[],dragDrop:[{dropSelector:".linked-skill-drop-zone"}],submitOnChange:!0})}getData(){const e=super.getData();if(e.system=this.item.system,e.system.linkedSkill&&(e.linkedSkillName=e.system.linkedSkill,this.item.actor)){this.item.actor.items.find(t=>"skill"===t.type&&t.name===e.system.linkedSkill)||(e.linkedSkillNotFound=!0)}if(this.item.actor){const t=this.item.actor.items.filter(e=>"skill"===e.type);e.skills=t.map(e=>({name:e.name}))}else e.skills=[];return e}activateListeners(e){super.activateListeners(e),e.find('[data-action="clear-linked-skill"]').on("click",this._onClearLinkedSkill.bind(this)),e.find(".skill-search-input").on("input",this._onSkillSearch.bind(this)),e.find(".skill-search-input").on("focus",this._onSkillSearchFocus.bind(this)),e.find(".skill-search-input").on("blur",this._onSkillSearchBlur.bind(this)),$(document).on("click.skill-search-spec",t=>{const a=t.target,i=e.find(".skill-search-container")[0];i&&!i.contains(a)&&e.find(".skill-search-results").hide()})}async close(e){return $(document).off("click.skill-search-spec"),super.close(e)}async _onClearLinkedSkill(e){e.preventDefault(),await this.item.update({"system.linkedSkill":""}),this.render(!1)}async _onDrop(e){const t=TextEditor.getDragEventData(e);if(t&&"Item"===t.type){const a=await Item.implementation.fromDropData(t);return a?"skill"===a.type?(await this.item.update({"system.linkedSkill":a.name}),this.render(!1),void ui.notifications?.info(game.i18n.format("SRA2.SPECIALIZATIONS.LINKED_TO_SKILL",{name:a.name}))):void ui.notifications?.warn(game.i18n.localize("SRA2.SPECIALIZATIONS.ONLY_SKILLS_CAN_BE_LINKED")):super._onDrop(e)}return super._onDrop(e)}async _updateObject(e,t){const a=foundry.utils.expandObject(t);return this.item.update(a)}skillSearchTimeout=null;lastSkillSearchTerm="";async _onSkillSearch(e){const t=e.currentTarget,a=normalizeSearchText(t.value.trim()),i=$(t).siblings(".skill-search-results")[0];this.skillSearchTimeout&&clearTimeout(this.skillSearchTimeout),0!==a.length?this.skillSearchTimeout=setTimeout(async()=>{await this._performSkillSearch(a,i)},300):i.style.display="none"}async _performSkillSearch(e,t){const a=[];if(this.lastSkillSearchTerm=e,game.items)for(const i of game.items)"skill"===i.type&&normalizeSearchText(i.name).includes(e)&&a.push({name:i.name,uuid:i.uuid,pack:game.i18n.localize("SRA2.SPECIALIZATIONS.WORLD_ITEMS"),linkedAttribute:i.system.linkedAttribute,isWorldItem:!0});for(const i of game.packs){if("Item"!==i.documentName)continue;const t=await i.getDocuments();for(const n of t)"skill"===n.type&&normalizeSearchText(n.name).includes(e)&&a.push({name:n.name,uuid:n.uuid,pack:i.title,linkedAttribute:n.system.linkedAttribute,isWorldItem:!1})}this._displaySkillSearchResults(a,t)}_displaySkillSearchResults(e,t){const a=this.lastSkillSearchTerm.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),i=e.find(e=>normalizeSearchText(e.name)===normalizeSearchText(this.lastSkillSearchTerm));let n="";if(0===e.length)n=`\n        <div class="search-result-item no-results-create">\n          <div class="no-results-text">\n            ${game.i18n.localize("SRA2.SPECIALIZATIONS.SEARCH_NO_RESULTS")}\n          </div>\n          <button class="create-skill-btn" data-skill-name="${this.lastSkillSearchTerm}">\n            <i class="fas fa-plus"></i> ${game.i18n.localize("SRA2.SPECIALIZATIONS.CREATE_SKILL")}\n          </button>\n        </div>\n      `;else{for(const t of e){const e=game.i18n.localize(`SRA2.ATTRIBUTES.${t.linkedAttribute.toUpperCase()}`);n+=`\n          <div class="search-result-item">\n            <div class="result-info">\n              <span class="result-name">${t.name}</span>\n              <span class="result-pack">${t.pack} - ${e}</span>\n            </div>\n            <button class="link-skill-btn" data-skill-name="${t.name}">\n              ${game.i18n.localize("SRA2.SPECIALIZATIONS.LINK_SKILL")}\n            </button>\n          </div>\n        `}i||(n+=`\n          <div class="search-result-item create-new-item">\n            <div class="result-info">\n              <span class="result-name"><i class="fas fa-plus-circle"></i> ${a}</span>\n              <span class="result-pack">${game.i18n.localize("SRA2.SPECIALIZATIONS.CREATE_NEW_SKILL")}</span>\n            </div>\n            <button class="create-skill-btn-inline" data-skill-name="${this.lastSkillSearchTerm}">\n              ${game.i18n.localize("SRA2.SPECIALIZATIONS.CREATE_SKILL")}\n            </button>\n          </div>\n        `)}return t.innerHTML=n,t.style.display="block",$(t).find(".link-skill-btn").on("click",this._onLinkSkillFromSearch.bind(this)),$(t).find(".create-skill-btn, .create-skill-btn-inline").on("click",this._onCreateNewSkill.bind(this)),$(t).find(".search-result-item:not(.no-results-create):not(.create-new-item)").on("click",e=>{if($(e.target).closest(".link-skill-btn").length>0)return;const t=$(e.currentTarget).find(".link-skill-btn")[0];t&&$(t).trigger("click")}),$(t).find(".search-result-item.create-new-item").on("click",e=>{if($(e.target).closest(".create-skill-btn-inline").length>0)return;const t=$(e.currentTarget).find(".create-skill-btn-inline")[0];t&&$(t).trigger("click")}),Promise.resolve()}async _onLinkSkillFromSearch(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.skillName;if(!t)return;await this.item.update({"system.linkedSkill":t});const a=this.element.find(".skill-search-input")[0];a&&(a.value="");const i=this.element.find(".skill-search-results")[0];i&&(i.style.display="none"),this.render(!1),ui.notifications?.info(game.i18n.format("SRA2.SPECIALIZATIONS.SKILL_LINKED",{name:t}))}_onSkillSearchFocus(e){const t=e.currentTarget;if(t.value.trim().length>0){const e=$(t).siblings(".skill-search-results")[0];e&&e.innerHTML.trim().length>0&&(e.style.display="block")}return Promise.resolve()}_onSkillSearchBlur(e){const t=e.currentTarget,a=e;return setTimeout(()=>{const e=$(t).siblings(".skill-search-results")[0];if(e){const t=a.relatedTarget;if(t&&e.contains(t))return;const i=document.activeElement;if(i&&e.contains(i))return;e.style.display="none"}},200),Promise.resolve()}async _onCreateNewSkill(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget.dataset.skillName;if(!t)return;const a=t.split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(" "),i={name:a,type:"skill",system:{rating:1,linkedAttribute:"strength",description:""}},n=await Item.create(i);if(n){await this.item.update({"system.linkedSkill":a});const e=this.element.find(".skill-search-input")[0];e&&(e.value="");const t=this.element.find(".skill-search-results")[0];t&&(t.style.display="none"),this.render(!1),setTimeout(()=>{n.sheet&&n.sheet.render(!0)},100),ui.notifications?.info(game.i18n.format("SRA2.SPECIALIZATIONS.SKILL_CREATED_AND_LINKED",{name:a}))}}}class MetatypeSheet extends ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","sheet","item","metatype"],template:"systems/sra2/templates/item-metatype-sheet.hbs",width:520,height:580,tabs:[],submitOnChange:!0})}getData(){const e=super.getData();return e.system=this.item.system,e}async _updateObject(e,t){const a=foundry.utils.expandObject(t);return this.item.update(a)}}const p={shadowAmpProbabilities:{conditions:[{id:0,name:"No Shadow Amp",data:[{dice:1,allGood:83.3,glitch:16.7,criticalGlitch:0,disaster:0},{dice:2,allGood:69.4,glitch:27.8,criticalGlitch:2.8,disaster:0},{dice:3,allGood:57.9,glitch:34.7,criticalGlitch:6.5,disaster:.9},{dice:4,allGood:48.2,glitch:38.2,criticalGlitch:11.1,disaster:2.5},{dice:5,allGood:40.2,glitch:40.2,criticalGlitch:15.3,disaster:4.3},{dice:6,allGood:33.5,glitch:40.2,criticalGlitch:19,disaster:7.3},{dice:7,allGood:27.9,glitch:38.9,criticalGlitch:22.2,disaster:11},{dice:8,allGood:23.3,glitch:36.6,criticalGlitch:24.8,disaster:15.3},{dice:9,allGood:19.4,glitch:33.8,criticalGlitch:26.9,disaster:19.9},{dice:10,allGood:16.2,glitch:30.6,criticalGlitch:28.2,disaster:25},{dice:11,allGood:13.5,glitch:27.3,criticalGlitch:28.7,disaster:30.5},{dice:12,allGood:11.3,glitch:24.1,criticalGlitch:28.2,disaster:36.4},{dice:13,allGood:9.4,glitch:21.3,criticalGlitch:27.1,disaster:42.2},{dice:14,allGood:7.8,glitch:18.8,criticalGlitch:26,disaster:47.4},{dice:15,allGood:6.5,glitch:16.7,criticalGlitch:25.5,disaster:51.3},{dice:16,allGood:5.4,glitch:17.3,criticalGlitch:26,disaster:51.3}]},{id:1,name:"Shadow Amp: Risk Reduction 1",data:[{dice:1,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:2,allGood:97.2,glitch:2.8,criticalGlitch:0,disaster:0},{dice:3,allGood:91.7,glitch:7.4,criticalGlitch:.9,disaster:0},{dice:4,allGood:84.3,glitch:13,criticalGlitch:2.3,disaster:.4},{dice:5,allGood:75.7,glitch:19,criticalGlitch:4.2,disaster:1.1},{dice:6,allGood:66.7,glitch:24.1,criticalGlitch:6.5,disaster:2.7},{dice:7,allGood:57.9,glitch:27.8,criticalGlitch:9.3,disaster:5},{dice:8,allGood:49.8,glitch:30.1,criticalGlitch:12,disaster:8.1},{dice:9,allGood:42.6,glitch:31,criticalGlitch:14.4,disaster:12},{dice:10,allGood:36.4,glitch:30.6,criticalGlitch:16.2,disaster:16.8},{dice:11,allGood:31,glitch:29.2,criticalGlitch:17.4,disaster:22.4},{dice:12,allGood:26.4,glitch:27.3,criticalGlitch:18.1,disaster:28.2},{dice:13,allGood:22.5,glitch:25,criticalGlitch:18.3,disaster:34.2},{dice:14,allGood:19.2,glitch:22.7,criticalGlitch:18.2,disaster:39.9},{dice:15,allGood:16.4,glitch:20.4,criticalGlitch:17.8,disaster:45.4},{dice:16,allGood:22.7,glitch:26,criticalGlitch:24.2,disaster:27.1}]},{id:2,name:"Shadow Amp: Risk Reduction 2",data:[{dice:1,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:2,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:3,allGood:98.1,glitch:1.9,criticalGlitch:0,disaster:0},{dice:4,allGood:94.4,glitch:5.1,criticalGlitch:.5,disaster:0},{dice:5,allGood:89.4,glitch:9.3,criticalGlitch:1.2,disaster:.1},{dice:6,allGood:83.3,glitch:14.4,criticalGlitch:2.1,disaster:.2},{dice:7,allGood:76.4,glitch:19.4,criticalGlitch:3.5,disaster:.7},{dice:8,allGood:69,glitch:23.6,criticalGlitch:5.3,disaster:1.1},{dice:9,allGood:61.6,glitch:26.9,criticalGlitch:7.4,disaster:2.1},{dice:10,allGood:54.6,glitch:29.2,criticalGlitch:9.7,disaster:3.5},{dice:11,allGood:48.1,glitch:30.6,criticalGlitch:11.8,disaster:5.5},{dice:12,allGood:42.4,glitch:31,criticalGlitch:13.5,disaster:8.1},{dice:13,allGood:37.3,glitch:30.6,criticalGlitch:14.8,disaster:11.3},{dice:14,allGood:32.9,glitch:29.6,criticalGlitch:15.8,disaster:15.7},{dice:15,allGood:29,glitch:28.2,criticalGlitch:16.4,disaster:20.4},{dice:16,allGood:48.7,glitch:24.2,criticalGlitch:15.8,disaster:11.3}]},{id:3,name:"Shadow Amp: Risk Reduction 3",data:[{dice:1,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:2,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:3,allGood:100,glitch:0,criticalGlitch:0,disaster:0},{dice:4,allGood:99.1,glitch:.9,criticalGlitch:0,disaster:0},{dice:5,allGood:97.2,glitch:2.6,criticalGlitch:.2,disaster:0},{dice:6,allGood:94.4,glitch:5.1,criticalGlitch:.5,disaster:0},{dice:7,allGood:90.7,glitch:8.3,criticalGlitch:.9,disaster:.1},{dice:8,allGood:86.1,glitch:12,criticalGlitch:1.6,disaster:.3},{dice:9,allGood:80.6,glitch:16.2,criticalGlitch:2.6,disaster:.6},{dice:10,allGood:74.5,glitch:20.4,criticalGlitch:3.9,disaster:1.2},{dice:11,allGood:68.1,glitch:24.1,criticalGlitch:5.3,disaster:2.5},{dice:12,allGood:61.6,glitch:27.3,criticalGlitch:6.9,disaster:4.2},{dice:13,allGood:55.1,glitch:30.1,criticalGlitch:8.3,disaster:6.5},{dice:14,allGood:48.8,glitch:32.4,criticalGlitch:9.5,disaster:9.3},{dice:15,allGood:42.8,glitch:34.3,criticalGlitch:10.5,disaster:12.4},{dice:16,allGood:72.9,glitch:15.8,criticalGlitch:7.6,disaster:3.8}]}]}};class RollDialog extends Application{rollData;actor=null;attackerToken=null;targetToken=null;rrEnabled=/* @__PURE__ */new Map;riskDiceCount=0;riskDiceManuallySet=!1;lastAutoRR=-1;selectedRange=null;rollMode="normal";manualRRBonus="";constructor(e){if(super(),this.rollData=e,e.actorUuid?this.actor=fromUuidSync(e.actorUuid):e.actorId&&(this.actor=game.actors?.get(e.actorId)||null),e.attackerTokenUuid)try{this.attackerToken=foundry.utils?.fromUuidSync?.(e.attackerTokenUuid)||null,console.log("RollDialog: Attacker token loaded from UUID:",e.attackerTokenUuid)}catch(i){console.warn("RollDialog: Failed to load attacker token from UUID:",i)}!this.attackerToken&&this.actor&&(this.attackerToken=canvas?.tokens?.placeables?.find(e=>e.actor?.id===this.actor.id||e.actor?.uuid===this.actor.uuid)||null,this.attackerToken&&console.log("RollDialog: Attacker token found on canvas"));const t=Array.from(game.user?.targets||[]);t.length>0&&(this.targetToken=t[0]||null);const a=e.isVehicleWeapon;if(!this.targetToken&&e.defenderTokenUuid)try{const t=foundry.utils?.fromUuidSync?.(e.defenderTokenUuid)||null;if(t)if(a&&e.vehicleUuid){(t?.actor?.uuid||t?.document?.actorLink?t?.actor?.uuid:void 0)===e.vehicleUuid?console.log("RollDialog: Skipping vehicle token as defender for vehicle weapon - need target instead"):(this.targetToken=t,console.log("RollDialog: Defender token loaded from UUID:",e.defenderTokenUuid))}else this.targetToken=t,console.log("RollDialog: Defender token loaded from UUID:",e.defenderTokenUuid)}catch(i){console.warn("RollDialog: Failed to load defender token from UUID:",i)}if(!this.targetToken&&e.defenderTokenUuid){const t=canvas?.tokens?.placeables?.find(t=>t.uuid===e.defenderTokenUuid||t.document?.uuid===e.defenderTokenUuid)||null;if(t&&a&&e.vehicleUuid){(t?.actor?.uuid||void 0)!==e.vehicleUuid&&(this.targetToken=t)}else t&&(this.targetToken=t)}e.isCounterAttack&&e.availableWeapons&&e.availableWeapons.length>0&&this.actor&&this.autoSelectWeaponForCounterAttack()}autoSelectWeaponForCounterAttack(){if(!this.rollData.availableWeapons||!this.actor)return;let e=null,t=-1;for(const a of this.rollData.availableWeapons){const i=a.damageValue||"0";let n=0;if("FOR"===i)n=this.actor.system?.attributes?.strength||1;else if(i.startsWith("FOR+")){const e=parseInt(i.substring(4))||0;n=(this.actor.system?.attributes?.strength||1)+e}else n=parseInt(i,10)||0;n+=a.damageValueBonus||0,n>t&&(t=n,e=a)}e&&t>0?this.selectWeaponForCounterAttack(e.id):this.selectCombatRapprocheSkill()}selectWeaponForCounterAttack(e){if(!this.rollData.availableWeapons||!this.actor)return;const t=this.rollData.availableWeapons.find(t=>t.id===e);if(!t)return;const i=this.actor.items.find(t=>t.id===e),n=i?.system,s=n?.weaponType,l=s?a[s]:void 0;let o=n?.linkedAttackSkill||l?.linkedSkill||t.linkedAttackSkill;const r=n?.linkedAttackSpecialization||l?.linkedSpecialization,c=t.damageValue||n?.damageValue||"0";let d=t.damageValueBonus||n?.damageValueBonus||0;const u=s||"";if(u&&this.actor){this.actor.items.filter(e=>"feat"===e.type&&!0===e.system.active&&e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===u).forEach(e=>{d+=e.system.weaponDamageBonus||0})}d=Math.min(d,2);const m=calculateRawDamageString(c,d);o||(o="Combat rapproché");const p=this.actor.items.find(e=>"skill"===e.type&&e.name===o),h=this.actor.items.filter(e=>"specialization"===e.type&&e.system.linkedSkill===o);let g,f,S,A;if(r){h.find(e=>e.name===r)&&(g=r)}let y,k=o;if(p){const e=p.system,t=e.rating||0;A=e.linkedAttribute||"strength";f=(A&&this.actor.system?.attributes?.[A]||0)+t}let T=[];const E=(n?.rrList||[]).map(e=>({...e,featName:t.name}));let R=[];if(g){y=g;S=(A&&this.actor.system?.attributes?.[A]||0)+(p&&p.system.rating||0)+2;R=[...getRRSources(this.actor,"specialization",y),...p?getRRSources(this.actor,"skill",o):[],...A?getRRSources(this.actor,"attribute",A):[]]}else if(k){R=[...getRRSources(this.actor,"skill",k),...A?getRRSources(this.actor,"attribute",A):[]]}T=[...E,...R];const D=t.meleeRange||n?.meleeRange||l?.melee||"none",v=t.shortRange||n?.shortRange||l?.short||"none",b=t.mediumRange||n?.mediumRange||l?.medium||"none",I=t.longRange||n?.longRange||l?.long||"none";this.rollData.skillName=k,this.rollData.specName=y,this.rollData.linkedAttackSkill=o,this.rollData.linkedAttribute=A,this.rollData.skillLevel=f,this.rollData.specLevel=S,this.rollData.itemName=t.name,this.rollData.itemType="weapon",this.rollData.damageValue=m,this.rollData.damageValueBonus=d,this.rollData.rrList=T,this.rollData.selectedWeaponId=e,this.rollData.meleeRange=D,this.rollData.shortRange=v,this.rollData.mediumRange=b,this.rollData.longRange=I,this.rollData.weaponType=s}selectCombatRapprocheSkill(){if(!this.actor)return;const e=this.actor.items.find(e=>"skill"===e.type&&"Combat rapproché"===e.name);if(!e)return;const t=e.system,a=t.rating||0,i=t.linkedAttribute||"strength",n=(this.actor.system?.attributes?.[i]||0)+a,s=[...getRRSources(this.actor,"skill","Combat rapproché"),...getRRSources(this.actor,"attribute",i)];this.rollData.skillName="Combat rapproché",this.rollData.specName=void 0,this.rollData.linkedAttackSkill="Combat rapproché",this.rollData.linkedAttribute=i,this.rollData.skillLevel=n,this.rollData.specLevel=void 0,this.rollData.itemName=void 0,this.rollData.itemType=void 0,this.rollData.damageValue="FOR",this.rollData.damageValueBonus=0,this.rollData.rrList=s,this.rollData.selectedWeaponId=void 0}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["sra2","roll-dialog"],template:"systems/sra2/templates/roll-dialog.hbs",width:760,height:630,resizable:!0,minimizable:!1,title:"Jet de Dés"})}getData(){const e={rollData:this.rollData,actor:this.actor,targetToken:this.targetToken};let t=null,a="";if(this.actor&&this.targetToken&&canvas?.grid){const e=canvas?.tokens?.placeables?.find(e=>e.actor?.id===this.actor.id||e.actor?.uuid===this.actor.uuid);if(e&&this.targetToken)try{const i=canvas.grid.measureDistance({x:e.x,y:e.y},{x:this.targetToken.x,y:this.targetToken.y},{gridSpaces:!0});if("number"==typeof i&&!isNaN(i)){t=Math.round(10*i)/10;const e=canvas?.scene;a=`${t} ${e?.grid?.units||"m"}`}}catch(N){const i=this.targetToken.x-e.x,n=this.targetToken.y-e.y,s=Math.sqrt(i*i+n*n)/(canvas.grid?.size||1);t=Math.round(10*s)/10;const l=canvas?.scene;a=`${t} ${l?.grid?.units||"m"}`}}e.distance=t,e.distanceText=a;let i=null;null!==t&&(t<3?i="melee":t>=3&&t<=15?i="short":t>15&&t<=60?i="medium":t>60&&(i="long")),null===this.selectedRange&&(this.rollData.isCounterAttack?this.selectedRange="melee":null!==i&&(this.selectedRange=i));const n=this.rollData.meleeRange||"none",s=this.rollData.shortRange||"none",l=this.rollData.mediumRange||"none",o=this.rollData.longRange||"none",r="weapon"===this.rollData.itemType||void 0!==this.rollData.weaponType||"none"!==n||"none"!==s||"none"!==l||"none"!==o;let c=null;"melee"===this.selectedRange?c=n:"short"===this.selectedRange?c=s:"medium"===this.selectedRange?c=l:"long"===this.selectedRange&&(c=o),"disadvantage"===c?this.rollMode="disadvantage":"ok"===c&&(this.rollMode="normal");let d=!1;if(this.actor){const e=this.actor.system;e.damage&&e.damage.severe&&(d=Array.isArray(e.damage.severe)&&e.damage.severe.some(e=>!0===e))}d&&(this.rollMode="disadvantage"),e.isWeaponRoll=r,e.isSkillSpecAttributeRoll=!r&&!this.rollData.isDefend&&(this.rollData.skillName||this.rollData.specName||this.rollData.linkedAttribute),e.calculatedRange=i,e.selectedRange=this.selectedRange,e.selectedRangeValue=c,e.rollMode=this.rollMode,e.hasSevereWound=d,e.rangeOptions={melee:{label:"Mêlée (< 3m)",value:n},short:{label:"Portée courte (3-15m)",value:s},medium:{label:"Portée moyenne (15-60m)",value:l},long:{label:"Portée longue (> 60m)",value:o}};let m=0;if(void 0!==this.rollData.specLevel)m=this.rollData.specLevel;else if(void 0!==this.rollData.skillLevel)m=this.rollData.skillLevel;else if(this.rollData.linkedAttribute){m=this.actor?.system?.attributes?.[this.rollData.linkedAttribute]||0}console.log("SRA2 | RollDialog - Dice pool calculation:",{specLevel:this.rollData.specLevel,skillLevel:this.rollData.skillLevel,linkedAttribute:this.rollData.linkedAttribute,itemRating:this.rollData.itemRating,calculatedDicePool:m,skillName:this.rollData.skillName,specName:this.rollData.specName}),e.dicePool=m;let h=this.rollData.threshold;if(e.threshold=h,e.hasThreshold=void 0!==h,e.skillDisplayName=this.rollData.specName||this.rollData.skillName||this.rollData.linkedAttackSkill||"Aucune",this.rollData.isDefend&&this.actor){const{getRRSources:e}=u;let t=[];if(this.rollData.specName){t=e(this.actor,"specialization",this.rollData.specName).map(e=>({...e,featName:e.featName}))}else if(this.rollData.skillName){t=e(this.actor,"skill",this.rollData.skillName).map(e=>({...e,featName:e.featName}))}if(this.rollData.linkedAttribute){const a=e(this.actor,"attribute",this.rollData.linkedAttribute).map(e=>({...e,featName:e.featName}));t=[...t,...a]}this.rollData.rrList=t}let g=0;const f=[];if(this.rollData.rrList&&Array.isArray(this.rollData.rrList))for(const u of this.rollData.rrList)if(u&&"object"==typeof u){const e=u.rrValue||0;if(e>0){const t=u.featName||"Inconnu",a=`${t}-${e}`;this.rrEnabled.has(a)||this.rrEnabled.set(a,!0);const i=this.rrEnabled.get(a)||!1;f.push({id:a,featName:t,rrValue:e,enabled:i}),i&&(g+=e)}}g+=this.manualRRBonus,e.totalRR=Math.min(3,g),e.rrSources=f,e.manualRRBonus=this.manualRRBonus;const S=getRiskDiceByRR(e.totalRR),A=Math.min(S,m);e.totalRR!==this.lastAutoRR&&(this.riskDiceManuallySet=!1,this.lastAutoRR=e.totalRR),this.riskDiceManuallySet||(this.riskDiceCount=A),e.vd=this.rollData.damageValue||0;const y=((e,t)=>{if(e<=0)return{allGood:100,glitch:0,criticalGlitch:0,disaster:0};const a=Math.max(1,Math.min(16,e)),i=Math.max(0,Math.min(3,t)),n=p?.shadowAmpProbabilities||p,s=n?.conditions?.find(e=>e.id===i);if(!s)return{allGood:0,glitch:0,criticalGlitch:0,disaster:0};const l=s.data.find(e=>e.dice===a);return l?{allGood:l.allGood,glitch:l.glitch,criticalGlitch:l.criticalGlitch,disaster:l.disaster}:{allGood:0,glitch:0,criticalGlitch:0,disaster:0}})(this.riskDiceCount,e.totalRR),k=y.criticalGlitch,T=y.disaster;let E="probability-extreme",R="SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME";k<2&&T<.2?(E="probability-low",R="SRA2.ROLL_DIALOG.RISK_LEVEL.LOW_TO_NO"):k<7.5&&T<1?(E="probability-normal",R="SRA2.ROLL_DIALOG.RISK_LEVEL.NORMAL"):k<20&&T<5?(E="probability-high",R="SRA2.ROLL_DIALOG.RISK_LEVEL.HIGH"):(E="probability-extreme",R="SRA2.ROLL_DIALOG.RISK_LEVEL.EXTREME");const D=game.i18n?.localize(R)||R;e.riskProbabilities={allGood:y.allGood.toFixed(1).replace(".",","),allGoodColorClass:E,glitch:y.glitch.toFixed(1).replace(".",","),glitchColorClass:E,criticalGlitch:y.criticalGlitch.toFixed(1).replace(".",","),criticalGlitchColorClass:E,disaster:y.disaster.toFixed(1).replace(".",","),disasterColorClass:E};const v=(e=>{switch(e){case"probability-low":default:return"green";case"probability-normal":return"blue";case"probability-high":return"yellow";case"probability-extreme":return"red"}})(E);e.diceList=[],e.riskDiceCount=this.riskDiceCount,e.riskLevelText=D,e.riskColorClass=E;for(let u=0;u<m;u++)e.diceList.push({index:u,isRiskDice:u<this.riskDiceCount,riskColor:v});if(this.actor){const t=this.actor.items.filter(e=>"skill"===e.type).map(e=>{const t=e.system?.linkedAttribute||"strength",a=this.actor?.system?.attributes?.[t]||0,i=e.system?.rating||0;return{id:e.id,name:e.name,rating:i,linkedAttribute:t,dicePool:a+i,type:"skill",specializations:[]}}).sort((e,t)=>e.name.localeCompare(t.name)),a=this.actor.items.filter(e=>"specialization"===e.type).map(e=>{const t=e.system?.linkedAttribute||"strength",a=e.system?.linkedSkill,i=this.actor?.system?.attributes?.[t]||0,n=this.actor.items.find(e=>"skill"===e.type&&e.name===a),s=(n&&n.system.rating||0)+2;return{id:e.id,name:e.name,rating:s,linkedAttribute:t,dicePool:i+s,type:"specialization",linkedSkillName:a}});for(const e of a){const a=t.find(t=>t.name===e.linkedSkillName);a&&a.specializations.push(e)}for(const e of t)e.specializations.sort((e,t)=>e.name.localeCompare(t.name));const i=[];for(const e of t){const t=e.name===this.rollData.skillName||this.rollData.linkedAttackSkill&&normalizeSearchText(e.name)===normalizeSearchText(this.rollData.linkedAttackSkill);i.push({value:`skill:${e.id}`,label:`${e.name} (${e.dicePool} dés)`,type:"skill",id:e.id,name:e.name,dicePool:e.dicePool,linkedAttribute:e.linkedAttribute,rating:e.rating,isSelected:t&&!this.rollData.specName});for(const a of e.specializations){const e=a.name===this.rollData.specName||this.rollData.linkedAttackSpecialization&&normalizeSearchText(a.name)===normalizeSearchText(this.rollData.linkedAttackSpecialization);i.push({value:`spec:${a.id}`,label:`  └ ${a.name} (${a.dicePool} dés)`,type:"specialization",id:a.id,name:a.name,dicePool:a.dicePool,linkedAttribute:a.linkedAttribute,linkedSkillName:a.linkedSkillName,rating:a.rating,isSelected:e})}}if(e.skillsWithSpecs=t,e.dropdownOptions=i,this.rollData.specName){const t=i.find(e=>"specialization"===e.type&&e.name===this.rollData.specName);e.selectedValue=t?t.value:""}else if(this.rollData.skillName){const t=i.find(e=>"skill"===e.type&&e.name===this.rollData.skillName);e.selectedValue=t?t.value:""}else if(this.rollData.linkedAttackSpecialization){const t=normalizeSearchText(this.rollData.linkedAttackSpecialization),a=i.find(e=>"specialization"===e.type&&normalizeSearchText(e.name)===t);e.selectedValue=a?a.value:""}else if(this.rollData.linkedAttackSkill){const t=normalizeSearchText(this.rollData.linkedAttackSkill),a=i.find(e=>"skill"===e.type&&normalizeSearchText(e.name)===t);e.selectedValue=a?a.value:""}else e.selectedValue=""}const b=[];if(this.actor){const e=this.actor.system,t=e?.attributes||{},a=["strength","agility","willpower","logic","charisma"],i={strength:game.i18n?.localize("SRA2.ATTRIBUTES.STRENGTH")||"Force",agility:game.i18n?.localize("SRA2.ATTRIBUTES.AGILITY")||"Agilité",willpower:game.i18n?.localize("SRA2.ATTRIBUTES.WILLPOWER")||"Volonté",logic:game.i18n?.localize("SRA2.ATTRIBUTES.LOGIC")||"Logique",charisma:game.i18n?.localize("SRA2.ATTRIBUTES.CHARISMA")||"Charisme"};for(const n of a){const e=t[n]||0;b.push({value:n,label:i[n]||n,diceValue:e})}}e.attributeOptions=b;let I=this.rollData.linkedAttribute,w=!1;if(!I&&this.actor){if(this.rollData.specName){const e=this.actor.items.find(e=>"specialization"===e.type&&e.name===this.rollData.specName);if(e){I=e.system?.linkedAttribute;const t=e.system?.linkedSkill;if(t){const e=this.actor.items.find(e=>"skill"===e.type&&e.name===t);if(e){w=(e.system?.rating||0)>0}}}}if(!I&&this.rollData.skillName){const e=this.actor.items.find(e=>"skill"===e.type&&e.name===this.rollData.skillName);if(e){I=e.system?.linkedAttribute;w=(e.system?.rating||0)>0}else w=!1}else this.rollData.skillName||this.rollData.specName||(w=!1);if(I||w)!I&&b.length>0&&(I=b[0].value);else{const e=this.rollData.linkedAttackSkill||this.rollData.skillName;I=e&&normalizeSearchText(e)===normalizeSearchText("Combat rapproché")?"strength":"agility"}}return e.selectedAttribute=I||"",e}activateListeners(e){super.activateListeners(e),e.find(".close-button").on("click",()=>{this.close()}),e.find(".weapon-select").on("change",async e=>{const t=e.currentTarget.value;if(!t||!this.rollData.availableWeapons||!this.actor)return;const i=this.rollData.availableWeapons.find(e=>e.id===t);if(!i)return;const n=this.actor.items.find(e=>e.id===t),s=n?.system,l=s?.weaponType,o=l?a[l]:void 0;let r=s?.linkedAttackSkill||o?.linkedSkill||i.linkedAttackSkill;const c=s?.linkedAttackSpecialization||o?.linkedSpecialization,d=i.damageValue||s?.damageValue||"0";let m=i.damageValueBonus||s?.damageValueBonus||0;const p=l||"";if(p&&this.actor){this.actor.items.filter(e=>"feat"===e.type&&!0===e.system.active&&e.system.weaponDamageBonus>0&&e.system.weaponTypeBonus===p).forEach(e=>{m+=e.system.weaponDamageBonus||0})}m=Math.min(m,2);const h=calculateRawDamageString(d,m);r||(r="Combat rapproché");const g=this.actor.items.find(e=>"skill"===e.type&&e.name===r),f=this.actor.items.filter(e=>"specialization"===e.type&&e.system.linkedSkill===r);let S,A,y,k;if(c){f.find(e=>e.name===c)&&(S=c)}let T,E=r;if(g){const e=g.system,t=e.rating||0;k=e.linkedAttribute||"strength";A=(k&&this.actor.system?.attributes?.[k]||0)+t}const{getRRSources:R}=await Promise.resolve().then(()=>u),D=(s?.rrList||[]).map(e=>({...e,featName:i.name}));let v=[];if(S){T=S;y=(k&&this.actor.system?.attributes?.[k]||0)+(g&&g.system.rating||0)+2;v=[...R(this.actor,"specialization",T),...g?R(this.actor,"skill",r):[],...k?R(this.actor,"attribute",k):[]]}else if(E){v=[...R(this.actor,"skill",E),...k?R(this.actor,"attribute",k):[]]}const b=[...D,...v],I=i.meleeRange||s?.meleeRange||o?.melee||"none",w=i.shortRange||s?.shortRange||o?.short||"none",N=i.mediumRange||s?.mediumRange||o?.medium||"none",L=i.longRange||s?.longRange||o?.long||"none";this.rollData.skillName=E,this.rollData.specName=T,this.rollData.linkedAttackSkill=r,this.rollData.linkedAttribute=k,this.rollData.skillLevel=A,this.rollData.specLevel=y,this.rollData.itemName=i.name,this.rollData.itemType="weapon",this.rollData.damageValue=h,this.rollData.damageValueBonus=m,this.rollData.rrList=b,this.rollData.selectedWeaponId=t,this.rollData.meleeRange=I,this.rollData.shortRange=w,this.rollData.mediumRange=N,this.rollData.longRange=L,this.rollData.weaponType=l,this.render()}),e.find(".skill-dropdown").on("change",e=>{const t=e.currentTarget;if(void 0!==this.rollData.threshold)return;const a=t.value;if(!a||!this.actor)return;const[i,n]=a.split(":");if(!i||!n)return;const s=this.actor.items.get(n);if(s)if("skill"===i){const e=s.system,t=this.rollData.linkedAttribute||e.linkedAttribute||"strength",a=(this.actor.system.attributes?.[t]||0)+(e.rating||0);this.rollData.skillName=s.name,this.rollData.specName=void 0,this.rollData.skillLevel=a,this.rollData.specLevel=void 0,this.rollData.linkedAttribute=t,this.updateRRForSkill(s.name,t,a),this.render()}else if("spec"===i){const e=s.system,t=this.rollData.linkedAttribute||e.linkedAttribute||"strength",a=e.linkedSkill,i=this.actor.system.attributes?.[t]||0,n=this.actor.items.find(e=>"skill"===e.type&&e.name===a),l=n&&n.system.rating||0,o=i+(l+2);this.rollData.specName=s.name,this.rollData.skillName=a,this.rollData.skillLevel=l,this.rollData.specLevel=o,this.rollData.linkedAttribute=t,this.updateRRForSpec(s.name,a,t,o),this.render()}}),e.find(".attribute-dropdown").on("change",e=>{const t=e.currentTarget.value;if(t&&this.actor){if(this.rollData.linkedAttribute=t,this.rollData.specName&&this.rollData.skillName){const e=this.actor.system.attributes?.[t]||0,a=this.rollData.skillName,i=this.actor.items.find(e=>"skill"===e.type&&e.name===a),n=i&&i.system.rating||0,s=e+(n+2);this.rollData.specLevel=s,this.rollData.skillLevel=n,this.updateRRForSpec(this.rollData.specName,a,t,s)}else if(this.rollData.skillName){const e=this.actor.system.attributes?.[t]||0,a=this.actor.items.find(e=>"skill"===e.type&&e.name===this.rollData.skillName),i=e+(a&&a.system.rating||0);this.rollData.skillLevel=i,this.rollData.specLevel=void 0,this.updateRRForSkill(this.rollData.skillName,t,i)}else{this.rollData.skillLevel=void 0,this.rollData.specLevel=void 0;const e=getRRSources(this.actor,"attribute",t);this.rollData.rrList=e,this.rrEnabled.clear();for(const t of this.rollData.rrList)if(t&&"object"==typeof t){const e=t.rrValue||0,a=t.featName||"Inconnu";if(e>0){const t=`${a}-${e}`;this.rrEnabled.set(t,!0)}}}this.render()}}),e.find(".rr-checkbox").on("change",e=>{const t=e.currentTarget,a=t.dataset.rrId,i=t.checked;if(a){this.rrEnabled.set(a,i);let e=0;if(this.rollData.rrList&&Array.isArray(this.rollData.rrList))for(const t of this.rollData.rrList)if(t&&"object"==typeof t){const a=t.rrValue||0,i=`${t.featName||"Inconnu"}-${a}`;this.rrEnabled.get(i)&&(e+=a)}if(e+=this.manualRRBonus,e=Math.min(3,e),!this.riskDiceManuallySet){const t=getRiskDiceByRR(e);let a=0;if(void 0!==this.rollData.specLevel)a=this.rollData.specLevel;else if(void 0!==this.rollData.skillLevel)a=this.rollData.skillLevel;else if(this.rollData.linkedAttribute){a=this.actor?.system?.attributes?.[this.rollData.linkedAttribute]||0}this.riskDiceCount=Math.min(t,a),this.lastAutoRR=e}this.render()}}),e.find(".range-dropdown").on("change",e=>{const t=e.currentTarget.value;if(this.selectedRange=t||null,this.selectedRange){const e=this.rollData.meleeRange||"none",t=this.rollData.shortRange||"none",a=this.rollData.mediumRange||"none",i=this.rollData.longRange||"none";let n="none";"melee"===this.selectedRange?n=e:"short"===this.selectedRange?n=t:"medium"===this.selectedRange?n=a:"long"===this.selectedRange&&(n=i);let s=!1;if(this.actor){const e=this.actor.system;e.damage&&e.damage.severe&&(s=Array.isArray(e.damage.severe)&&e.damage.severe.some(e=>!0===e))}s||"disadvantage"===n?this.rollMode="disadvantage":"ok"===n&&(this.rollMode="normal")}this.render()}),e.find('input[name="roll-mode"]').on("change",e=>{let t=!1;if(this.actor){const e=this.actor.system;e.damage&&e.damage.severe&&(t=Array.isArray(e.damage.severe)&&e.damage.severe.some(e=>!0===e))}if(t)return this.rollMode="disadvantage",void this.render();const a=e.currentTarget.value;"normal"!==a&&"disadvantage"!==a&&"advantage"!==a||(this.rollMode=a)}),e.find(".manual-rr-bonus-input").on("input",e=>{const t=e.currentTarget.value;this.manualRRBonus=t;let a=0;""===t||isNaN(Number(t))||(a=parseInt(t));let i=0;if(this.rollData.rrList&&Array.isArray(this.rollData.rrList))for(const n of this.rollData.rrList)if(n&&"object"==typeof n){const e=n.rrValue||0,t=`${n.featName||"Inconnu"}-${e}`;this.rrEnabled.get(t)&&(i+=e)}if(i+=a,i=Math.min(3,i),!this.riskDiceManuallySet){const e=getRiskDiceByRR(i);let t=0;if(void 0!==this.rollData.specLevel)t=this.rollData.specLevel;else if(void 0!==this.rollData.skillLevel)t=this.rollData.skillLevel;else if(this.rollData.linkedAttribute){t=this.actor?.system?.attributes?.[this.rollData.linkedAttribute]||0}this.riskDiceCount=Math.min(e,t),this.lastAutoRR=i}0!==a&&this.render()}),e.find(".dice-icon").on("click",e=>{const t=$(e.currentTarget),a=parseInt(t.data("dice-index")||"0"),i=t.hasClass("risk-dice");this.riskDiceManuallySet=!0,i&&a===this.riskDiceCount-1?this.riskDiceCount=0:this.riskDiceCount=a+1,this.render()}),e.find(".roll-dice-button").on("click",async()=>{let e=0;if(this.rollData.rrList&&Array.isArray(this.rollData.rrList))for(const d of this.rollData.rrList)if(d&&"object"==typeof d){const t=d.rrValue||0,a=`${d.featName||"Inconnu"}-${t}`;this.rrEnabled.get(a)&&(e+=t)}e+=this.manualRRBonus;const t=this.rollData.rrList?.filter(e=>{const t=`${e.featName||"Inconnu"}-${e.rrValue||0}`;return this.rrEnabled.get(t)})||[];let a=0;if(void 0!==this.rollData.specLevel)a=this.rollData.specLevel;else if(void 0!==this.rollData.skillLevel)a=this.rollData.skillLevel;else if(this.rollData.linkedAttribute){a=this.actor?.system?.attributes?.[this.rollData.linkedAttribute]||0}if(this.rollData.isDefend&&!this.rollData.threshold&&!this.rollData.skillName&&!this.rollData.specName&&0===a)return void ui.notifications?.warn(game.i18n.localize("SRA2.ROLL_DIALOG.NO_SKILL_SELECTED")||"Veuillez sélectionner une compétence pour la défense");if(this.rollData.isCounterAttack&&!this.rollData.threshold){if(!this.rollData.selectedWeaponId&&!this.rollData.skillName&&!this.rollData.specName)return void ui.notifications?.warn(game.i18n.localize("SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPON_SELECTED")||"Veuillez sélectionner une arme pour la contre-attaque");if(0===a)return void ui.notifications?.warn(game.i18n.localize("SRA2.COMBAT.COUNTER_ATTACK.NO_DICE_POOL")||"La réserve de dés pour la contre-attaque est de 0. Veuillez sélectionner une arme valide.")}if(("weapon"===this.rollData.itemType||"spell"===this.rollData.itemType||"weapons-spells"===this.rollData.itemType)&&!this.rollData.isDefend&&this.selectedRange){let e=null;const t=this.rollData.meleeRange||"none",a=this.rollData.shortRange||"none",i=this.rollData.mediumRange||"none",n=this.rollData.longRange||"none";if("melee"===this.selectedRange?e=t:"short"===this.selectedRange?e=a:"medium"===this.selectedRange?e=i:"long"===this.selectedRange&&(e=n),"none"===e)return void ui.notifications?.warn(game.i18n.localize("SRA2.ROLL_DIALOG.INVALID_RANGE")||"La portée sélectionnée n'est pas disponible pour cette arme. Veuillez sélectionner une portée valide.")}const i=this.actor,n=this.attackerToken||null,s=this.targetToken?.actor||null,l=this.targetToken||null,o=n?.uuid||n?.document?.uuid||void 0,r=l?.uuid||l?.document?.uuid||void 0;console.log("=== ROLL DICE BUTTON ==="),console.log("Attacker:",i?.name||"Unknown"),console.log("Attacker Token:",n?"Found":"Not found"),console.log("Attacker Token UUID:",o||"Unknown"),n?.actor&&console.log("Attacker Token Actor UUID:",n.actor.uuid||"Unknown"),console.log("Defender:",s?.name||"None"),console.log("Defender Token:",l?"Found":"Not found"),console.log("Defender Token UUID:",r||"Unknown"),l?.actor&&console.log("Defender Token Actor UUID:",l.actor.uuid||"Unknown"),console.log("========================");const c={...this.rollData,rrList:t,riskDiceCount:this.riskDiceCount,selectedRange:this.selectedRange,rollMode:this.rollMode,finalRR:Math.min(3,e),dicePool:a,attackerTokenUuid:o,defenderTokenUuid:r},{executeRoll:u}=await Promise.resolve().then(()=>d);await u(i,s,n,l,c),this.close()})}updateRRForSkill(e,t,a){if(!this.actor)return;const i=getRRSources(this.actor,"skill",e),n=getRRSources(this.actor,"attribute",t);let s=[];if(this.rollData.itemId&&"weapon"===this.rollData.itemType){const e=this.actor.items.get(this.rollData.itemId);if(e){s=(e.system.rrList||[]).map(t=>({...t,featName:e.name}))}}this.rollData.rrList=[...s,...i,...n],this.rrEnabled.clear();for(const l of this.rollData.rrList)if(l&&"object"==typeof l){const e=l.rrValue||0,t=l.featName||"Inconnu";if(e>0){const a=`${t}-${e}`;this.rrEnabled.set(a,!0)}}if(void 0!==this.rollData.threshold){const e=Math.min(3,i.reduce((e,t)=>e+(t.rrValue||0),0)+n.reduce((e,t)=>e+(t.rrValue||0),0));this.rollData.threshold=Math.round(a/3)+e+1}}updateRRForSpec(e,t,a,i){if(!this.actor)return;const n=getRRSources(this.actor,"specialization",e),s=getRRSources(this.actor,"skill",t),l=getRRSources(this.actor,"attribute",a);let o=[];if(this.rollData.itemId&&"weapon"===this.rollData.itemType){const e=this.actor.items.get(this.rollData.itemId);if(e){o=(e.system.rrList||[]).map(t=>({...t,featName:e.name}))}}this.rollData.rrList=[...o,...n,...s,...l],this.rrEnabled.clear();for(const r of this.rollData.rrList)if(r&&"object"==typeof r){const e=r.rrValue||0,t=r.featName||"Inconnu";if(e>0){const a=`${t}-${e}`;this.rrEnabled.set(a,!0)}}if(void 0!==this.rollData.threshold){const e=Math.min(3,n.reduce((e,t)=>e+(t.rrValue||0),0)+s.reduce((e,t)=>e+(t.rrValue||0),0)+l.reduce((e,t)=>e+(t.rrValue||0),0));this.rollData.threshold=Math.round(i/3)+e+1}}}const h=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,RollDialog:RollDialog},Symbol.toStringTag,{value:"Module"})),g=/* @__PURE__ */Object.freeze(/* @__PURE__ */Object.defineProperty({__proto__:null,CharacterSheet:CharacterSheet,CharacterSheetV2:CharacterSheetV2,FeatSheet:FeatSheet,IceSheet:IceSheet,MetatypeSheet:MetatypeSheet,RollDialog:RollDialog,SkillSheet:SkillSheet,SpecializationSheet:SpecializationSheet,VehicleSheet:VehicleSheet},Symbol.toStringTag,{value:"Module"})),f="sra2-declareMigration",S="currentSystemVersion";class Migration{get code(){return"sample"}get version(){return"0.0.0"}async migrate(){return()=>{}}async applyItemsUpdates(e=e=>[]){await game.actors.forEach(async t=>{const a=e(t.items);if(a.length>0){const e=game.i18n.format("SRA2.MIGRATION.APPLYING_ACTOR_ITEMS",{name:t.name});console.log(SYSTEM.LOG.HEAD,this.code,e,a),await t.updateEmbeddedDocuments("Item",a)}});const t=e(game.items);if(t.length>0){const e=game.i18n.localize("SRA2.MIGRATION.APPLYING_ITEMS");console.log(SYSTEM.LOG.HEAD,this.code,e,t),await Item.updateDocuments(t)}}}class Migrations{constructor(){game.settings.register(SYSTEM.id,S,{name:"SRA2.MIGRATION.SETTING_NAME",scope:"world",config:!1,type:String,default:"0.0.0"})}migrate(){const e=game.settings.get(SYSTEM.id,S);if(foundry.utils.isNewerVersion(game.system.version,e)){let t=[];if(Hooks.callAll(f,(...a)=>t=t.concat(a.filter(t=>foundry.utils.isNewerVersion(t.version,e)))),Hooks.off(f,()=>{}),t.length>0){t.sort((e,t)=>foundry.utils.isNewerVersion(e.version,t.version)?1:foundry.utils.isNewerVersion(t.version,e.version)?-1:0),t.forEach(async t=>{const a=game.i18n.format("SRA2.MIGRATION.EXECUTING",{code:t.code,currentVersion:e,targetVersion:t.version});this.$notify(a),await t.migrate()});const a=game.i18n.format("SRA2.MIGRATION.DONE",{version:game.system.version});this.$notify(a)}else{const e=game.i18n.format("SRA2.MIGRATION.NOT_NEEDED",{version:game.system.version});console.log(SYSTEM.LOG.HEAD+e)}game.settings.set(SYSTEM.id,S,game.system.version)}else{const e=game.i18n.localize("SRA2.MIGRATION.VERSION_UNCHANGED");console.log(SYSTEM.LOG.HEAD+e)}}$notify(e){ui.notifications.info(e),console.log(SYSTEM.LOG.HEAD+e)}}class Migration_13_0_3 extends Migration{get code(){return"migration-13.0.3"}get version(){return"13.0.3"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.3: Converting rrType/rrValue/rrTarget to rrList");let e=0,t=0;await this.applyItemsUpdates(a=>{const i=[];for(const n of a){if("feat"!==n.type)continue;const a=n._source?.system||n.system;n.system;const s=void 0!==a.rrType&&Array.isArray(a.rrType)||void 0!==a.rrValue&&Array.isArray(a.rrValue)||void 0!==a.rrTarget&&Array.isArray(a.rrTarget);if(void 0!==a.rrList&&Array.isArray(a.rrList)&&!s){console.log(SYSTEM.LOG.HEAD+`Migration 13.0.3: Skipping "${n.name}" - already has rrList in source (${a.rrList.length} entries), no old data`),t++;continue}if(!s){console.log(SYSTEM.LOG.HEAD+`Migration 13.0.3: Skipping "${n.name}" - no old format fields found`),t++;continue}const l=Array.isArray(a.rrType)?a.rrType:[],o=Array.isArray(a.rrValue)?a.rrValue:[],r=Array.isArray(a.rrTarget)?a.rrTarget:[];console.log(SYSTEM.LOG.HEAD+`Migration 13.0.3: Found "${n.name}" with old format:`,{rrType:l,rrValue:o,rrTarget:r});const c=[],d=Math.max(l.length,o.length,r.length);for(let e=0;e<d;e++){const t=l[e];t&&"none"!==t&&c.push({rrType:t,rrValue:void 0!==o[e]?o[e]:0,rrTarget:void 0!==r[e]?r[e]:""})}const u={_id:n.id,"system.rrList":c,"system._rrTypeBackup":l,"system._rrValueBackup":o,"system._rrTargetBackup":r,"system.rrType":null,"system.rrValue":null,"system.rrTarget":null};i.push(u),e++,console.log(SYSTEM.LOG.HEAD+`Migration 13.0.3: Converting feat "${n.name}":`),console.log(SYSTEM.LOG.HEAD+"  Old data (will be deleted, backed up as _rrTypeBackup/_rrValueBackup/_rrTargetBackup):",{rrType:l,rrValue:o,rrTarget:r}),console.log(SYSTEM.LOG.HEAD+`  New rrList (${c.length} entries):`,c)}return i});const a=`Migration 13.0.3 completed - Migrated: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+a),e>0){const e=game.i18n?game.i18n.localize("SRA2.MIGRATION.13_0_3_INFO"):"Migration 13.0.3: Risk Reduction data converted. Check console for details.";ui.notifications?.info(e,{permanent:!1})}}}class Migration_13_0_4 extends Migration{get code(){return"migration-13.0.4"}get version(){return"13.0.4"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.4: Cleaning up old RR fields and backups");let e=0,t=0;await this.applyItemsUpdates(a=>{const i=[];for(const n of a){if("feat"!==n.type)continue;const a=n._source?.system||n.system,s=void 0!==a.rrType||void 0!==a.rrValue||void 0!==a.rrTarget,l=void 0!==a._rrTypeBackup||void 0!==a._rrValueBackup||void 0!==a._rrTargetBackup;if(!s&&!l){t++;continue}if(!(void 0!==a.rrList&&Array.isArray(a.rrList))){console.warn(SYSTEM.LOG.HEAD+`Migration 13.0.4: Skipping "${n.name}" - no rrList found! This item may need manual review.`),t++;continue}console.log(SYSTEM.LOG.HEAD+`Migration 13.0.4: Cleaning up feat "${n.name}":`),s&&console.log(SYSTEM.LOG.HEAD+"  Removing old fields: rrType, rrValue, rrTarget"),l&&console.log(SYSTEM.LOG.HEAD+"  Removing backups: _rrTypeBackup, _rrValueBackup, _rrTargetBackup"),console.log(SYSTEM.LOG.HEAD+`  Keeping rrList with ${a.rrList.length} entries`);const o={_id:n.id,"system.rrType":null,"system.rrValue":null,"system.rrTarget":null,"system._rrTypeBackup":null,"system._rrValueBackup":null,"system._rrTargetBackup":null};i.push(o),e++}return i});const a=`Migration 13.0.4 completed - Cleaned: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+a),e>0){const e=game.i18n?game.i18n.localize("SRA2.MIGRATION.13_0_4_INFO"):"Migration 13.0.4: Old RR fields cleaned up. Data migration complete.";ui.notifications?.info(e,{permanent:!1})}}}class Migration_13_0_5 extends Migration{get code(){return"migration-13.0.5"}get version(){return"13.0.5"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.5: Separating weapons and spells feat types");let e=0,t=0;await this.applyItemsUpdates(a=>{const i=[];for(const n of a){if("feat"!==n.type)continue;if("weapons-spells"!==(n._source?.system||n.system).featType){t++;continue}console.log(SYSTEM.LOG.HEAD+`Migration 13.0.5: Converting feat "${n.name}" from "weapons-spells" to "weapon"`);const a={_id:n.id,"system.featType":"weapon"};i.push(a),e++}return i});const a=`Migration 13.0.5 completed - Converted: ${e} weapons-spells to weapon, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+a),e>0){const t=game.i18n?game.i18n.localize("SRA2.MIGRATION.13_0_5_INFO"):`Migration 13.0.5: Converted ${e} "weapons-spells" feats to "weapon" type. You can manually change specific items to "spell" type if needed.`;ui.notifications?.info(t,{permanent:!1})}}}class Migration_13_0_6 extends Migration{get code(){return"migration-13.0.6"}get version(){return"13.0.6"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Migration 13.0.6: Rollback - keeping old weapons-spells type valid"),console.log(SYSTEM.LOG.HEAD+"No conversion needed. weapons-spells, weapon, and spell types are all valid.");const e="Migration 13.0.6: All feat types (weapons-spells, weapon, spell) are now valid. No data conversion performed.";console.log(SYSTEM.LOG.HEAD+e),ui.notifications&&ui.notifications.info(e,{permanent:!1})}}class Migration_13_0_7 extends Migration{get code(){return"migration-13.0.7"}get version(){return"13.0.7"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.7: Converting weapons-spells to weapon (with backup)");let e=0,t=0,a=[];await this.applyItemsUpdates(i=>{const n=[];for(const s of i){if("feat"!==s.type)continue;const i=s._source?.system||s.system;if("weapons-spells"!==i.featType){t++;continue}const l={name:s.name,id:s.id,oldType:"weapons-spells",newType:"weapon",hasWeaponFocus:i.isWeaponFocus||!1,hasDamageValue:(i.damageValue||0)>0,hasRanges:"none"!==i.meleeRange||"none"!==i.shortRange||"none"!==i.mediumRange||"none"!==i.longRange};console.log(SYSTEM.LOG.HEAD+`Migration 13.0.7: Converting "${s.name}" (ID: ${s.id})`),console.log(SYSTEM.LOG.HEAD+"  - Old type: weapons-spells"),console.log(SYSTEM.LOG.HEAD+"  - New type: weapon"),console.log(SYSTEM.LOG.HEAD+`  - Has weapon focus: ${l.hasWeaponFocus}`),console.log(SYSTEM.LOG.HEAD+`  - Has damage value: ${l.hasDamageValue}`),console.log(SYSTEM.LOG.HEAD+`  - Has ranges: ${l.hasRanges}`),a.push(l);const o={_id:s.id,"system.featType":"weapon","system._oldFeatTypeBackup":"weapons-spells","system._migratedAt":/* @__PURE__ */(new Date).toISOString(),"system._migrationVersion":"13.0.7"};n.push(o),e++}return n});const i=`Migration 13.0.7 completed - Converted: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+i),a.length>0){console.log(SYSTEM.LOG.HEAD+"=== CONVERSION DETAILS ==="),console.log(SYSTEM.LOG.HEAD+`Total items converted: ${a.length}`);const e=a.filter(e=>e.hasWeaponFocus).length,t=a.filter(e=>e.hasDamageValue).length,i=a.filter(e=>e.hasRanges).length;console.log(SYSTEM.LOG.HEAD+`  - Items with weapon focus: ${e}`),console.log(SYSTEM.LOG.HEAD+`  - Items with damage value: ${t}`),console.log(SYSTEM.LOG.HEAD+`  - Items with ranges: ${i}`),console.log(SYSTEM.LOG.HEAD+"========================="),console.log(SYSTEM.LOG.HEAD+"Converted items:"),a.forEach((e,t)=>{console.log(SYSTEM.LOG.HEAD+`  ${t+1}. "${e.name}" (ID: ${e.id})`)})}if(e>0){const t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_7_INFO",{count:e}):`Migration 13.0.7: Converted ${e} "weapons-spells" items to "weapon" type. All data preserved with backup.`;ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete. All items have been backed up."),console.log(SYSTEM.LOG.HEAD+"✓ Old type saved in system._oldFeatTypeBackup"),console.log(SYSTEM.LOG.HEAD+"✓ No data was lost in the conversion")}else console.log(SYSTEM.LOG.HEAD+"No items to convert - all items already migrated or are other types")}}class Migration_13_0_8 extends Migration{get code(){return"migration-13.0.8"}get version(){return"13.0.8"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.8: Converting narrativeEffects to new format and fixing damageValueBonus");let e=0,t=0,a=0,i=[];await this.applyItemsUpdates(n=>{const s=[];for(const l of n){if("feat"!==l.type)continue;const n=l._source?.system||l.system;let o=!1;const r={_id:l.id};if(n.narrativeEffects&&n.narrativeEffects.length>0){const t=n.narrativeEffects[0];if("object"!=typeof t||null===t||!("text"in t)){const t=n.narrativeEffects.map(e=>"string"==typeof e?{text:e,isNegative:!1}:{text:e?.text||e?.toString()||"",isNegative:e?.isNegative||!1});r["system.narrativeEffects"]=t,r["system._migratedNarrativeEffectsAt"]=/* @__PURE__ */(new Date).toISOString(),r["system._narrativeEffectsMigrationVersion"]="13.0.8",o=!0,console.log(SYSTEM.LOG.HEAD+`Migration 13.0.8: Converting narrativeEffects for "${l.name}" (ID: ${l.id})`),console.log(SYSTEM.LOG.HEAD+`  - Effect count: ${n.narrativeEffects.length}`),i.push({name:l.name,id:l.id,effectCount:n.narrativeEffects.length}),e++}}null!==n.damageValueBonus&&void 0!==n.damageValueBonus&&"number"==typeof n.damageValueBonus&&Number.isInteger(n.damageValueBonus)||(r["system.damageValueBonus"]=0,o=!0,a++,console.log(SYSTEM.LOG.HEAD+`Migration 13.0.8: Fixing damageValueBonus for "${l.name}" (ID: ${l.id})`)),o?s.push(r):t++}return s});const n=`Migration 13.0.8 completed - NarrativeEffects converted: ${e}, DamageValueBonus fixed: ${a}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+n),i.length>0){console.log(SYSTEM.LOG.HEAD+"=== CONVERSION DETAILS ==="),console.log(SYSTEM.LOG.HEAD+`Total items converted: ${i.length}`);const e=i.reduce((e,t)=>e+t.effectCount,0);console.log(SYSTEM.LOG.HEAD+`  - Total narrative effects migrated: ${e}`),console.log(SYSTEM.LOG.HEAD+"========================="),console.log(SYSTEM.LOG.HEAD+"Converted items:"),i.forEach((e,t)=>{console.log(SYSTEM.LOG.HEAD+`  ${t+1}. "${e.name}" (ID: ${e.id}) - ${e.effectCount} effect(s)`)})}if(a>0&&console.log(SYSTEM.LOG.HEAD+`Fixed damageValueBonus on ${a} item(s)`),e>0||a>0){let t="";e>0&&a>0?t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_8_INFO",{count:e,fixed:a}):`Migration 13.0.8: Converted narrative effects on ${e} feat(s) and fixed damageValueBonus on ${a} feat(s).`:e>0?t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_8_INFO",{count:e}):`Migration 13.0.8: Converted narrative effects on ${e} feat(s) to new format.`:a>0&&(t=`Migration 13.0.8: Fixed damageValueBonus on ${a} feat(s).`),ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete."),e>0&&(console.log(SYSTEM.LOG.HEAD+"✓ All narrative effects converted to new format."),console.log(SYSTEM.LOG.HEAD+"✓ All effects default to positive (isNegative: false)")),a>0&&console.log(SYSTEM.LOG.HEAD+"✓ All damageValueBonus fields set to valid integer values."),console.log(SYSTEM.LOG.HEAD+"✓ No data was lost in the conversion")}else console.log(SYSTEM.LOG.HEAD+"No items to migrate - all items already up to date")}}class Migration_13_0_9 extends Migration{get code(){return"migration-13.0.9"}get version(){return"13.0.9"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.9: Adding value field to narrativeEffects and isFirstFeat field");let e=0,t=0,a=0,i=[];await this.applyItemsUpdates(n=>{const s=[];for(const l of n){if("feat"!==l.type)continue;const n=l._source?.system||l.system;let o=!1;const r={_id:l.id};if(n.narrativeEffects&&n.narrativeEffects.length>0){const e=n.narrativeEffects.map(e=>"object"!=typeof e||null===e||"value"in e?e:(o=!0,{...e,value:-1}));o&&(r["system.narrativeEffects"]=e,r["system._migratedNarrativeEffectsValueAt"]=/* @__PURE__ */(new Date).toISOString(),console.log(SYSTEM.LOG.HEAD+`Migration 13.0.9: Adding value field to narrativeEffects for "${l.name}" (ID: ${l.id})`),console.log(SYSTEM.LOG.HEAD+`  - Effect count: ${e.length}`),i.push({name:l.name,id:l.id,effectCount:e.length,hasFirstFeat:!1}))}if(void 0===n.isFirstFeat||null===n.isFirstFeat){r["system.isFirstFeat"]=!1,o=!0,a++,console.log(SYSTEM.LOG.HEAD+`Migration 13.0.9: Adding isFirstFeat field to "${l.name}" (ID: ${l.id})`);const e=i.find(e=>e.id===l.id);e?e.hasFirstFeat=!0:i.push({name:l.name,id:l.id,effectCount:0,hasFirstFeat:!0})}o?(r["system._narrativeEffectsValueMigrationVersion"]="13.0.9",s.push(r),e++):t++}return s});const n=`Migration 13.0.9 completed - Items updated: ${e}, isFirstFeat added: ${a}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+n),i.length>0){console.log(SYSTEM.LOG.HEAD+"=== UPDATE DETAILS ==="),console.log(SYSTEM.LOG.HEAD+`Total items updated: ${i.length}`);const e=i.reduce((e,t)=>e+t.effectCount,0),t=i.filter(e=>e.hasFirstFeat).length;console.log(SYSTEM.LOG.HEAD+`  - Total narrative effects updated: ${e}`),console.log(SYSTEM.LOG.HEAD+`  - Total items with isFirstFeat added: ${t}`),console.log(SYSTEM.LOG.HEAD+"======================"),console.log(SYSTEM.LOG.HEAD+"Updated items:"),i.forEach((e,t)=>{const a=[];e.effectCount>0&&a.push(`${e.effectCount} effect(s)`),e.hasFirstFeat&&a.push("isFirstFeat added"),console.log(SYSTEM.LOG.HEAD+`  ${t+1}. "${e.name}" (ID: ${e.id}) - ${a.join(", ")}`)})}if(e>0){const t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_9_INFO",{count:e,firstFeatCount:a}):`Migration 13.0.9: Updated ${e} feat(s) - added value field to narrative effects and isFirstFeat field to ${a} feat(s).`;ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete."),console.log(SYSTEM.LOG.HEAD+"✓ All narrative effects now have a value field (default: -1)"),console.log(SYSTEM.LOG.HEAD+"✓ All feats now have isFirstFeat field (default: false)"),console.log(SYSTEM.LOG.HEAD+"✓ No data was lost in the migration")}else console.log(SYSTEM.LOG.HEAD+"No items to migrate - all items already up to date")}}class Migration_13_0_10 extends Migration{get code(){return"migration-13.0.10"}get version(){return"13.0.10"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.10: Updating cost field values");let e=0,t=0,a=[];await this.applyItemsUpdates(i=>{const n=[],s=i.filter(e=>"feat"===e.type);console.log(SYSTEM.LOG.HEAD+`Found ${s.length} feat items to check`);for(const l of i){if("feat"!==l.type)continue;const i=l._source?.system||l.system;if("13.0.10"===i._costMigrationVersion){t++;continue}let s=!1;const o={_id:l.id},r=i.cost||"free-equipment",c=i.featType||"equipment";let d=r,u="";console.log(SYSTEM.LOG.HEAD+`Checking "${l.name}" - cost: "${r}", type: "${c}"`),"specialized-equipment"===r?(d="advanced-equipment",s=!0,u="specialized-equipment → advanced-equipment"):"feat"===r?(d="free-equipment",s=!0,u="feat → free-equipment (cost = 0 for non-equipment types)"):["free-equipment","equipment","advanced-equipment"].includes(r)||(d="free-equipment",s=!0,u=`invalid or missing cost (${r}) → free-equipment`),s&&(o["system.cost"]=d,o["system._costMigrationVersion"]="13.0.10",console.log(SYSTEM.LOG.HEAD+`Migration 13.0.10: Updating cost for "${l.name}" (ID: ${l.id})`),console.log(SYSTEM.LOG.HEAD+`  - Type: ${c}`),console.log(SYSTEM.LOG.HEAD+`  - Old cost: ${r}`),console.log(SYSTEM.LOG.HEAD+`  - New cost: ${d}`),console.log(SYSTEM.LOG.HEAD+`  - Reason: ${u}`),a.push({name:l.name,id:l.id,featType:c,oldCost:r,newCost:d,reason:u}),n.push(o),e++)}return n});const i=`Migration 13.0.10 completed - Items updated: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+i),a.length>0){console.log(SYSTEM.LOG.HEAD+"=== UPDATE DETAILS ==="),console.log(SYSTEM.LOG.HEAD+`Total items updated: ${a.length}`);const e=a.filter(e=>"specialized-equipment"===e.oldCost).length,t=a.filter(e=>"feat"===e.oldCost).length;console.log(SYSTEM.LOG.HEAD+`  - specialized-equipment → advanced-equipment: ${e}`),console.log(SYSTEM.LOG.HEAD+`  - feat → free-equipment: ${t}`),console.log(SYSTEM.LOG.HEAD+"======================"),console.log(SYSTEM.LOG.HEAD+"Updated items:"),a.forEach((e,t)=>{console.log(SYSTEM.LOG.HEAD+`  ${t+1}. "${e.name}" (${e.featType}): ${e.oldCost} → ${e.newCost}`)})}if(e>0){const t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_10_INFO",{count:e,specializedCount:a.filter(e=>"specialized-equipment"===e.oldCost).length,featCount:a.filter(e=>"feat"===e.oldCost).length}):`Migration 13.0.10: Updated ${e} feat(s) cost values.`;ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete."),console.log(SYSTEM.LOG.HEAD+"✓ Cost system simplified: free (0¥), equipment (2500¥), advanced (5000¥)"),console.log(SYSTEM.LOG.HEAD+"✓ Cost now only applies to equipment and weapon types"),console.log(SYSTEM.LOG.HEAD+"✓ No data was lost in the migration")}else console.log(SYSTEM.LOG.HEAD+"No items to migrate - all items already up to date")}}class Migration_13_0_11 extends Migration{get code(){return"migration-13.0.11"}get version(){return"13.0.11"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.11: Adding linked specializations fields to weapons");let e=0,t=0;await this.applyItemsUpdates(a=>{const i=[];for(const n of a){if("feat"!==n.type)continue;const a=n._source?.system||n.system,s=a.featType||"equipment";if("weapon"!==s&&"weapons-spells"!==s)continue;if("13.0.11"===a._specializationLinkMigrationVersion){t++;continue}const l=a.hasOwnProperty("linkedAttackSpecialization"),o=a.hasOwnProperty("linkedDefenseSpecialization");if(l&&o){const e={_id:n.id,"system._specializationLinkMigrationVersion":"13.0.11"};i.push(e),t++;continue}const r={_id:n.id,"system.linkedAttackSpecialization":a.linkedAttackSpecialization||"","system.linkedDefenseSpecialization":a.linkedDefenseSpecialization||"","system._specializationLinkMigrationVersion":"13.0.11"};console.log(SYSTEM.LOG.HEAD+`Migration 13.0.11: Adding specialization link fields to weapon "${n.name}" (ID: ${n.id})`),i.push(r),e++}return i});const a=`Migration 13.0.11 completed - Weapons updated: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+a),e>0){const t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_11_INFO",{count:e}):`Migration 13.0.11: Added specialization link fields to ${e} weapon(s).`;ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete."),console.log(SYSTEM.LOG.HEAD+"✓ Weapons can now be linked to attack and defense specializations")}else console.log(SYSTEM.LOG.HEAD+"No items to migrate - all items already up to date")}}class Migration_13_0_12 extends Migration{get code(){return"migration-13.0.12"}get version(){return"13.0.12"}async migrate(){console.log(SYSTEM.LOG.HEAD+"Starting migration 13.0.12: Converting 'dice' to 'disadvantage' in weapon ranges");let e=0,t=0;await this.applyItemsUpdates(a=>{const i=[];for(const n of a){if("feat"!==n.type)continue;const a=n._source?.system||n.system;if("13.0.12"===a._rangeDiceToDisadvantageMigrationVersion){t++;continue}if(!("dice"===a.meleeRange||"dice"===a.shortRange||"dice"===a.mediumRange||"dice"===a.longRange)){t++;continue}const s={_id:n.id,"system._rangeDiceToDisadvantageMigrationVersion":"13.0.12"};"dice"===a.meleeRange&&(s["system.meleeRange"]="disadvantage"),"dice"===a.shortRange&&(s["system.shortRange"]="disadvantage"),"dice"===a.mediumRange&&(s["system.mediumRange"]="disadvantage"),"dice"===a.longRange&&(s["system.longRange"]="disadvantage"),console.log(SYSTEM.LOG.HEAD+`Migration 13.0.12: Converting ranges for "${n.name}" (ID: ${n.id})`),i.push(s),e++}return i});const a=`Migration 13.0.12 completed - Items updated: ${e}, Skipped: ${t}`;if(console.log(SYSTEM.LOG.HEAD+a),e>0){const t=game.i18n?game.i18n.format("SRA2.MIGRATION.13_0_12_INFO",{count:e}):`Migration 13.0.12: Converted weapon ranges from "dice" to "disadvantage" for ${e} item(s).`;ui.notifications?.info(t,{permanent:!1}),console.log(SYSTEM.LOG.HEAD+"✓ Migration complete."),console.log(SYSTEM.LOG.HEAD+"✓ All weapon ranges now use 'disadvantage' instead of 'dice'")}else console.log(SYSTEM.LOG.HEAD+"No items to migrate - all items already up to date")}}globalThis.SYSTEM=t;class SRA2System{static start(){new SRA2System}constructor(){game.system&&(game.system.sra2=this),Hooks.once("init",()=>this.onInit())}onInit(){console.log(t.LOG.HEAD+"SRA2System.onInit"),game.system&&(game.system.api={applications:g,models:l,documents:o}),this.registerThemeSetting(),CONFIG.Actor.sidebarIcon="fas fa-user",CONFIG.Adventure.sidebarIcon="fas fa-tree",CONFIG.Cards.sidebarIcon="fa-solid fa-cards",CONFIG.ChatMessage.sidebarIcon="fas fa-comments",CONFIG.Combat.sidebarIcon="fas fa-gun",CONFIG.Folder.sidebarIcon="fas fa-folder",CONFIG.Item.sidebarIcon="fas fa-suitcase",CONFIG.JournalEntry.sidebarIcon="fas fa-book-open",CONFIG.JournalEntryPage.sidebarIcon="fas fa-book-open",CONFIG.Macro.sidebarIcon="fas fa-code",CONFIG.Playlist.sidebarIcon="fas fa-music",CONFIG.PlaylistSound.sidebarIcon="fas fa-music",CONFIG.RollTable.sidebarIcon="fas fa-th-list",CONFIG.Scene.sidebarIcon="fas fa-map",console.log(t.LOG.HEAD+"Configured sidebar icons"),CONFIG.controlIcons={combat:"icons/svg/combat.svg",visibility:"icons/svg/cowled.svg",effects:"icons/svg/aura.svg",lock:"icons/svg/padlock.svg",up:"icons/svg/up.svg",down:"icons/svg/down.svg",defeated:"icons/svg/skull.svg",light:"icons/svg/light.svg",lightOff:"icons/svg/light-off.svg",template:"icons/svg/explosion.svg",sound:"icons/svg/sound-off.svg",soundOff:"icons/svg/combat.svg",doorClosed:"icons/svg/door-closed-outline.svg",doorOpen:"icons/svg/door-open-outline.svg",doorSecret:"icons/svg/door-secret-outline.svg",doorLocked:"icons/svg/door-locked-outline.svg"},console.log(t.LOG.HEAD+"Configured control icons"),console.log(t.LOG.HEAD+"Configured compendium banners"),new Migrations,Hooks.on(f,e=>{e(new Migration_13_0_3),e(new Migration_13_0_4),e(new Migration_13_0_5),e(new Migration_13_0_6),e(new Migration_13_0_7),e(new Migration_13_0_8),e(new Migration_13_0_9),e(new Migration_13_0_10),e(new Migration_13_0_11),e(new Migration_13_0_12)}),CONFIG.Actor.documentClass=SRA2Actor,CONFIG.Actor.dataModels={character:CharacterDataModel,vehicle:VehicleDataModel,ice:IceDataModel},CONFIG.Item.dataModels={skill:SkillDataModel,feat:FeatDataModel,specialization:SpecializationDataModel,metatype:MetatypeDataModel},DocumentSheetConfig.registerSheet(Actor,"sra2",CharacterSheet,{types:["character"],makeDefault:!1,label:"SRA2.SHEET.CHARACTER"}),DocumentSheetConfig.registerSheet(Actor,"sra2",CharacterSheetV2,{types:["character"],makeDefault:!0,label:"SRA2.SHEET.CHARACTER_V2"}),DocumentSheetConfig.registerSheet(Actor,"sra2",VehicleSheet,{types:["vehicle"],makeDefault:!0,label:"SRA2.SHEET.VEHICLE"}),DocumentSheetConfig.registerSheet(Actor,"sra2",IceSheet,{types:["ice"],makeDefault:!0,label:"SRA2.SHEET.ICE"}),Hooks.on("ready",()=>{if(!game.actors)return;const e=game.actors.filter(e=>"character"===e.type);for(const a of e){const e=a.system?.linkedVehicles||[];for(const a of e)try{let e=game.actors.find(e=>e.uuid===a);if(!e){const t=a.split(".");if(t.length>=3){const a=t[t.length-1];e=game.actors.get(a)}}e&&"vehicle"===e.type&&e.system&&e.system.prepareDerivedData&&e.system.prepareDerivedData()}catch(t){console.debug(`Vehicle ${a} not found in game.actors (may be in compendium)`)}try{a.system&&a.system.prepareDerivedData&&a.system.prepareDerivedData()}catch(t){console.debug(`Failed to recalculate cost for character ${a.name}:`,t)}}}),Hooks.on("updateActor",(e,t,a,i)=>{if(console.log("Hook updateActor - DEBUG:",{"actor.id":e?.id,"actor.name":e?.name,"actor.type":e?.type,"updateData keys":t?Object.keys(t):"no updateData","updateData.system keys":t?.system?Object.keys(t.system):"no system"}),"vehicle"===e.type&&(e.system&&e.system.prepareDerivedData(),game.actors)){const t=e.uuid,a=game.actors.filter(e=>{if("character"!==e.type)return!1;return(e.system?.linkedVehicles||[]).includes(t)});a.length>0&&console.log("Hook updateActor - Re-rendering character sheets:",{"vehicle.id":e.id,"vehicle.name":e.name,characterCount:a.length,characters:a.map(e=>({id:e.id,name:e.name}))}),setTimeout(()=>{a.forEach(e=>{e.system&&e.system.prepareDerivedData(),e.sheet&&e.sheet.rendered&&e.sheet.render(!1)})},100)}}),Hooks.on("createItem",(e,t,a)=>{const i=e.parent;if(!i||"vehicle"!==i.type)return;const n=e.system?.featType;if(("weapon"===n||"weapons-spells"===n)&&(i.system&&i.system.prepareDerivedData(),game.actors)){const e=i.uuid;game.actors.filter(t=>{if("character"!==t.type)return!1;return(t.system?.linkedVehicles||[]).includes(e)}).forEach(e=>{e.system&&e.system.prepareDerivedData(),e.sheet&&e.sheet.rendered&&setTimeout(()=>{e.sheet.render(!1)},100)})}}),Hooks.on("deleteItem",(e,t,a)=>{const i=e.parent;if(!i||"vehicle"!==i.type)return;const n=e.system?.featType;if(("weapon"===n||"weapons-spells"===n)&&(i.system&&i.system.prepareDerivedData(),game.actors)){const e=i.uuid;game.actors.filter(t=>{if("character"!==t.type)return!1;return(t.system?.linkedVehicles||[]).includes(e)}).forEach(e=>{e.system&&e.system.prepareDerivedData(),e.sheet&&e.sheet.rendered&&setTimeout(()=>{e.sheet.render(!1)},100)})}}),Hooks.on("createItem",async(e,a,i)=>{if("specialization"!==e.type)return;const n=e.parent;if(!n||"character"!==n.type)return;const s=e.system?.linkedSkill;if(!s)return;const l=`${n.id}:${s}`;if(SRA2System.skillsBeingCreated.has(l))return;if(!findSkillByName(n,s)){SRA2System.skillsBeingCreated.add(l);try{const a=findItemInGame("skill",s);if(a)try{await n.createEmbeddedDocuments("Item",[a.toObject()]),console.log(t.LOG.HEAD+`Auto-added linked skill "${s}" for specialization "${e.name}"`)}catch(o){console.error(t.LOG.HEAD+`Error auto-adding skill "${s}":`,o)}else{const a={name:s,type:"skill",system:{rating:0,linkedAttribute:e.system?.linkedAttribute||"strength",description:"",bookmarked:!1}};try{await n.createEmbeddedDocuments("Item",[a]),console.log(t.LOG.HEAD+`Auto-created linked skill "${s}" for specialization "${e.name}"`)}catch(o){console.error(t.LOG.HEAD+`Error auto-creating skill "${s}":`,o)}}}finally{SRA2System.skillsBeingCreated.delete(l)}}}),Hooks.on("deleteActor",(e,t,a)=>{if("vehicle"===e.type&&game.actors){const t=e.uuid;game.actors.filter(e=>{if("character"!==e.type)return!1;return(e.system?.linkedVehicles||[]).includes(t)}).forEach(async e=>{const a=(e.system?.linkedVehicles||[]).filter(e=>e!==t);await e.update({"system.linkedVehicles":a}),e.sheet&&e.sheet.rendered&&e.sheet.render(!1)})}}),DocumentSheetConfig.registerSheet(Item,"sra2",FeatSheet,{types:["feat"],makeDefault:!0,label:"SRA2.SHEET.FEAT"}),DocumentSheetConfig.registerSheet(Item,"sra2",SkillSheet,{types:["skill"],makeDefault:!0,label:"SRA2.SHEET.SKILL"}),DocumentSheetConfig.registerSheet(Item,"sra2",SpecializationSheet,{types:["specialization"],makeDefault:!0,label:"SRA2.SHEET.SPECIALIZATION"}),DocumentSheetConfig.registerSheet(Item,"sra2",MetatypeSheet,{types:["metatype"],makeDefault:!0,label:"SRA2.SHEET.METATYPE"}),Handlebars.registerHelper("add",function(e,t){return e+t}),Handlebars.registerHelper("eq",function(e,t){return e===t}),Handlebars.registerHelper("gt",function(e,t){return e>t}),Handlebars.registerHelper("gte",function(e,t){return e>=t}),Handlebars.registerHelper("concat",function(...e){return e.slice(0,-1).join("")}),Handlebars.registerHelper("uppercase",function(e){return e?e.toUpperCase():""}),Handlebars.registerHelper("isSuccess",function(e,t){return"advantage"===t?e>=4:"disadvantage"===t?6===e:e>=5}),Handlebars.registerHelper("multiply",function(e,t){return e*t}),Handlebars.registerHelper("ne",function(e,t){return e!==t}),Handlebars.registerHelper("json",function(e){return JSON.stringify(e)}),Hooks.on("renderChatMessage",(e,t)=>{t.find(".apply-damage-button").off("click"),t.find(".apply-damage-button").on("click",async e=>{e.preventDefault(),e.stopImmediatePropagation();const t=$(e.currentTarget);if(t.prop("disabled"))return;const a=t.data("target-uuid")||t.data("defender-uuid"),i=parseInt(t.data("damage"))||0,n=t.data("target-name")||t.data("defender-name"),s=t.data("damage-type")||"physical";if(!a)return console.error("Apply damage button: No target UUID found in button data attributes"),void ui.notifications?.error("Impossible de trouver la cible pour appliquer les dégâts");if(i<=0)ui.notifications?.info("Aucun dégât à appliquer");else{t.prop("disabled",!0),console.log("Apply damage button clicked:",{targetUuid:a,targetName:n,damage:i,damageType:s});try{await applyDamage(a,i,n,s)}catch(l){console.error("Error applying damage:",l),ui.notifications?.error("Erreur lors de l'application des dégâts")}finally{setTimeout(()=>t.prop("disabled",!1),1e3)}}}),t.find(".defend-button").off("click"),t.find(".defend-button").on("click",async t=>{t.preventDefault();const a=e.flags?.sra2;if(!a)return void console.error("Missing message flags");const i=a.rollResult,n=a.rollData;if(!i||!n)return void console.error("Missing roll data in message flags");let s=null,l=null,o=null,r=null;if(console.log("=== DEFENSE BUTTON - MESSAGE FLAGS ==="),console.log("attackerUuid flag:",a.attackerUuid||"Not set"),console.log("attackerTokenUuid flag:",a.attackerTokenUuid||"Not set"),console.log("attackerId flag:",a.attackerId||"Not set"),console.log("defenderUuid flag:",a.defenderUuid||"Not set"),console.log("defenderTokenUuid flag:",a.defenderTokenUuid||"Not set"),console.log("defenderId flag:",a.defenderId||"Not set"),console.log("======================================"),a.attackerUuid)try{o=foundry.utils?.fromUuidSync?.(a.attackerUuid)||null,o&&console.log("Defense button: Attacker loaded directly from attackerUuid flag:",a.attackerUuid)}catch(B){console.warn("Defense button: Failed to load attacker from attackerUuid flag:",B)}if(a.attackerTokenUuid)try{s=foundry.utils?.fromUuidSync?.(a.attackerTokenUuid)||null,s?.actor&&!o&&(o=s.actor,console.log("Defense button: Attacker loaded from attackerTokenUuid flag, using token actor"))}catch(B){console.warn("Defense button: Failed to load attacker token from attackerTokenUuid flag:",B)}o||(a.attackerId&&(o=game.actors?.get(a.attackerId)||null),o&&!s&&(s=canvas?.tokens?.placeables?.find(e=>e.actor?.id===o.id||e.actor?.uuid===o.uuid)||null));const c=n.isVehicleWeapon,d=n.vehicleUuid,m=Array.from(game.user?.targets||[]);if(c&&m.length>0&&(l=m[0],l?.actor&&(r=l.actor,console.log("Defense button: For vehicle weapon, using selected target as defender:",r?.name))),!r&&a.defenderUuid)try{const e=foundry.utils?.fromUuidSync?.(a.defenderUuid)||null;e&&(c&&d&&e.uuid===d?console.log("Defense button: Skipping vehicle as defender for vehicle weapon - need target instead"):(r=e,console.log("Defense button: Defender loaded directly from defenderUuid flag")))}catch(B){console.warn("Defense button: Failed to load defender from defenderUuid flag:",B)}if(!l&&a.defenderTokenUuid)try{const e=foundry.utils?.fromUuidSync?.(a.defenderTokenUuid)||null;if(e)if(c&&d){(e?.actor?.uuid||void 0)===d?console.log("Defense button: Skipping vehicle token as defender for vehicle weapon - need target instead"):(l=e,l?.actor&&!r&&(r=l.actor,console.log("Defense button: Defender loaded from defenderTokenUuid flag, using token actor")))}else l=e,l?.actor&&!r&&(r=l.actor,console.log("Defense button: Defender loaded from defenderTokenUuid flag, using token actor"))}catch(B){console.warn("Defense button: Failed to load defender token from defenderTokenUuid flag:",B)}if(!r){if(a.defenderId){const e=game.actors?.get(a.defenderId)||null;e&&(c&&d&&e.uuid===d?console.log("Defense button: Skipping vehicle as defender for vehicle weapon - need target instead"):r=e)}r&&!l&&(l=canvas?.tokens?.placeables?.find(e=>e.actor?.id===r.id||e.actor?.uuid===r.uuid)||null)}const p=i.totalSuccesses||0,g=n.damageValue||0,f=o?.name||"Unknown",S=o?.id||a.attackerId||"Unknown",A=a.attackerUuid||o?.uuid||"Unknown",y=r?.name||"Unknown",k=r?.id||a.defenderId||"Unknown";let T=r?.uuid||"Unknown";(!r||c&&d&&r.uuid===d)&&(T=a.defenderUuid||r?.uuid||"Unknown"),console.log("--- UUIDs being used from flags ---"),console.log("attackerUuid (from flag):",a.attackerUuid||"Not in flag, using:",o?.uuid||"Unknown"),console.log("defenderUuid (from flag):",a.defenderUuid||"Not in flag, using:",r?.uuid||"Unknown"),console.log("attackerTokenUuid (from flag):",a.attackerTokenUuid||"Not in flag"),console.log("defenderTokenUuid (from flag):",a.defenderTokenUuid||"Not in flag"),console.log("attacker loaded:",o?`${o.name} (${o.uuid})`:"Not loaded"),console.log("defender loaded:",r?`${r.name} (${r.uuid})`:"Not loaded"),console.log("attackerToken loaded:",s?`Found (${s.uuid||s.document?.uuid})`:"Not loaded"),console.log("defenderToken loaded:",l?`Found (${l.uuid||l.document?.uuid})`:"Not loaded");const E=n.linkedDefenseSkill||null,R=n.linkedDefenseSpecialization||null,D=n.linkedAttackSkill||n.skillName||null,v=n.linkedAttackSpecialization||n.specName||null;console.log("=== DEFENSE CLICK ==="),console.log("Success:",p),console.log("Damage:",g),console.log("Attacker:",f),console.log("Attacker ID:",S),console.log("Attacker UUID:",A),console.log("Attacker Token UUID:",s?.uuid||s?.document?.uuid||"Unknown"),console.log("Defender:",y),console.log("Defender ID:",k),console.log("Defender UUID:",T),console.log("Defender Token UUID:",l?.uuid||l?.document?.uuid||"Unknown"),console.log("Skill de defense:",E),console.log("Spe de defense:",R),console.log("Skill d'attaque:",D),console.log("Spe d'attaque:",v),console.log("===================");const b="vehicle"===r?.type;if(!r)return void console.error("Missing defender");let I=null,w=r;if(c&&l)I=l,l?.actor&&(w=l.actor);else{const e=a.defenderTokenUuid;if(e)try{const t=foundry.utils?.fromUuidSync?.(e)||null;if(t)if(c&&d){(t?.actor?.uuid||void 0)===d?(console.log("Defense: Skipping vehicle token as defender for vehicle weapon - using target instead"),I=l,l?.actor&&(w=l.actor)):(I=t,I?.actor&&(w=I.actor))}else I=t,I?.actor&&(w=I.actor)}catch(B){I=l,l?.actor&&(w=l.actor)}else I=l,l?.actor&&(w=l.actor)}const N="ice-attack"===a.rollType||"ice-attack"===n.itemType;let L,_,O,F=null,C=null;if(N){F="Piratage";w.items.find(e=>{if("specialization"!==e.type)return!1;const t=e.system;return"Cybercombat"===e.name&&"Piratage"===t.linkedSkill})&&(C="Cybercombat")}if(!N&&v){const e=w.items.find(e=>{if("specialization"!==e.type)return!1;const t=e.system;return e.name===v&&"Combat rapproché"===t.linkedSkill});if(e){C=e.name;const t=e.system;F=t.linkedSkill}}if(!C&&R){const e=w.items.find(e=>"specialization"===e.type&&e.name===R);if(e){C=R;const t=e.system.linkedSkill;F=t}}if(!C&&E){w.items.find(e=>"skill"===e.type&&e.name===E)&&(F=E)}if(b){const e=w.system?.attributes?.autopilot||0;F="Autopilot",L=e,O=void 0}else{if(!F){const e=n.meleeRange&&"none"!==n.meleeRange;F=e?"Combat rapproché":"Athlétisme"}if(C){const e=w.items.find(e=>"specialization"===e.type&&e.name===C);if(e){const t=e.system,a=t.linkedSkill,i=w.items.find(e=>"skill"===e.type&&e.name===a);if(i){const e=i.system.rating||0,a=t.rating||0;O=t.linkedAttribute||i.system.linkedAttribute||"strength";L=(O&&w.system?.attributes?.[O]||0)+e,_=L+a}}}else if(F){const e=w.items.find(e=>"skill"===e.type&&e.name===F);if(e){const t=e.system,a=t.rating||0;O=t.linkedAttribute||"strength";L=(O&&w.system?.attributes?.[O]||0)+a}}}if(!F&&!b)return void console.error("Could not determine defense skill for non-vehicle defender");const{getRRSources:M}=await Promise.resolve().then(()=>u);let $=[];if(!b)if(C){$=M(w,"specialization",C).map(e=>({...e,featName:e.featName}))}else if(F){$=M(w,"skill",F).map(e=>({...e,featName:e.featName}))}const U=s?.uuid||s?.document?.uuid||a.attackerTokenUuid||void 0,z=I?.uuid||I?.document?.uuid||l?.uuid||l?.document?.uuid||a.defenderTokenUuid||void 0,G={skillName:F,specName:C,linkedAttribute:O,skillLevel:L,specLevel:_,actorId:w.id,actorUuid:w.uuid,attackerTokenUuid:z,defenderTokenUuid:U,rrList:$,isDefend:!0,isCounterAttack:!1,attackRollResult:i,attackRollData:n},{RollDialog:P}=await Promise.resolve().then(()=>h),V=new P(G);if(s&&(V.targetToken=s),c&&d&&V.targetToken?.actor?.uuid===d){console.log("Defense: Target token is the vehicle, should be the character instead");const e=canvas?.tokens?.placeables?.find(e=>e.actor?.id===o?.id||e.actor?.uuid===o?.uuid)||null;e&&(V.targetToken=e)}V.render(!0)}),t.find(".counter-attack-button").off("click"),t.find(".counter-attack-button").on("click",async t=>{t.preventDefault();const a=e.flags?.sra2;if(!a)return void console.error("Missing message flags");const i=a.rollResult,s=a.rollData;if(!i||!s)return void console.error("Missing roll data in message flags");let l=null,o=null,r=null,c=null;if(console.log("=== COUNTER-ATTACK BUTTON - MESSAGE FLAGS ==="),console.log("attackerUuid flag:",a.attackerUuid||"Not set"),console.log("attackerTokenUuid flag:",a.attackerTokenUuid||"Not set"),console.log("attackerId flag:",a.attackerId||"Not set"),console.log("defenderUuid flag:",a.defenderUuid||"Not set"),console.log("defenderTokenUuid flag:",a.defenderTokenUuid||"Not set"),console.log("defenderId flag:",a.defenderId||"Not set"),console.log("=============================================="),a.attackerUuid)try{r=foundry.utils?.fromUuidSync?.(a.attackerUuid)||null,r&&console.log("Counter-attack button: Attacker loaded directly from attackerUuid flag")}catch(R){console.warn("Counter-attack button: Failed to load attacker from attackerUuid flag:",R)}if(a.attackerTokenUuid)try{l=foundry.utils?.fromUuidSync?.(a.attackerTokenUuid)||null,l?.actor&&!r&&(r=l.actor,console.log("Counter-attack button: Attacker loaded from attackerTokenUuid flag, using token actor"))}catch(R){console.warn("Counter-attack button: Failed to load attacker token from attackerTokenUuid flag:",R)}if(r||(a.attackerId&&(r=game.actors?.get(a.attackerId)||null),r&&!l&&(l=canvas?.tokens?.placeables?.find(e=>e.actor?.id===r.id||e.actor?.uuid===r.uuid)||null)),a.defenderUuid)try{c=foundry.utils?.fromUuidSync?.(a.defenderUuid)||null,c&&console.log("Counter-attack button: Defender loaded directly from defenderUuid flag")}catch(R){console.warn("Counter-attack button: Failed to load defender from defenderUuid flag:",R)}if(a.defenderTokenUuid)try{o=foundry.utils?.fromUuidSync?.(a.defenderTokenUuid)||null,o?.actor&&!c&&(c=o.actor,console.log("Counter-attack button: Defender loaded from defenderTokenUuid flag, using token actor"))}catch(R){console.warn("Counter-attack button: Failed to load defender token from defenderTokenUuid flag:",R)}if(c||(a.defenderId&&(c=game.actors?.get(a.defenderId)||null),c&&!o&&(o=canvas?.tokens?.placeables?.find(e=>e.actor?.id===c.id||e.actor?.uuid===c.uuid)||null)),console.log("--- UUIDs being used from flags (counter-attack) ---"),console.log("attackerUuid (from flag):",a.attackerUuid||"Not in flag, using:",r?.uuid||"Unknown"),console.log("defenderUuid (from flag):",a.defenderUuid||"Not in flag, using:",c?.uuid||"Unknown"),console.log("attackerTokenUuid (from flag):",a.attackerTokenUuid||"Not in flag"),console.log("defenderTokenUuid (from flag):",a.defenderTokenUuid||"Not in flag"),console.log("attacker loaded:",r?`${r.name} (${r.uuid})`:"Not loaded"),console.log("defender loaded:",c?`${c.name} (${c.uuid})`:"Not loaded"),console.log("attackerToken loaded:",l?`Found (${l.uuid||l.document?.uuid})`:"Not loaded"),console.log("defenderToken loaded:",o?`Found (${o.uuid||o.document?.uuid})`:"Not loaded"),!c)return void console.error("Missing defender");let d=null,u=c;const m=a.defenderTokenUuid||o?.uuid||o?.document?.uuid||void 0;if(m)try{d=foundry.utils?.fromUuidSync?.(m)||null,d?.actor&&(u=d.actor)}catch(R){d=o,o?.actor&&(u=o.actor)}else d=o,o?.actor&&(u=o.actor);const p=u.items.filter(e=>{const t="feat"===e.type,a="weapon"===e.system?.featType||"weapons-spells"===e.system?.featType;return t&&a}),{WEAPON_TYPES:g}=await Promise.resolve().then(()=>n),f=p.filter(e=>{const t=e.system,a=t.weaponType,i=t.meleeRange||"none",n="ok"===i||"disadvantage"===i;let s=!1;if(a&&"custom-weapon"!==a){const e=g[a];e&&e.melee&&(s="ok"===e.melee||"disadvantage"===e.melee)}if(!n&&!s)return!1;let l=t.linkedAttackSkill;if(!l&&a&&"custom-weapon"!==a){const e=g[a];e&&(l=e.linkedSkill)}if("Combat rapproché"===l)return!0;const o=u.items.filter(e=>"specialization"===e.type&&"Combat rapproché"===e.system.linkedSkill);if(l&&o.length>0){if(o.some(e=>e.name===l))return!0}const r=t.linkedAttackSpecialization;if(r){if(o.some(e=>e.name===r))return!0}return!1});if(console.log("Counter-attack: Filtered weapons with melee capability:",f.length,f.map(e=>({name:e.name,meleeRange:e.system?.meleeRange,weaponType:e.system?.weaponType,meleeInType:e.system?.weaponType?g[e.system.weaponType]?.melee:null}))),0===f.length)return console.error("Counter-attack: No weapons with melee capability. All items:",u.items.map(e=>({name:e.name,type:e.type,featType:e.system?.featType,meleeRange:e.system?.meleeRange,weaponType:e.system?.weaponType}))),void ui.notifications?.warn(game.i18n.localize("SRA2.COMBAT.COUNTER_ATTACK.NO_WEAPONS")||"Aucune arme disponible pour la contre-attaque");const S=f.map(e=>{const t=e.system,a=t.weaponType;let i=t.linkedAttackSkill;if(!i&&a&&"custom-weapon"!==a){const e=g[a];e&&(i=e.linkedSkill)}const n=u.items.filter(e=>"specialization"===e.type&&"Combat rapproché"===e.system.linkedSkill);if(i&&n.length>0){n.some(e=>e.name===i)||"Combat rapproché"!==i&&(i="Combat rapproché")}else i="Combat rapproché";const s=a&&"custom-weapon"!==a?g[a]:void 0;return{id:e.id,name:e.name,linkedAttackSkill:i,damageValue:t.damageValue||"0",damageValueBonus:t.damageValueBonus||0,weaponType:a,meleeRange:t.meleeRange||s?.melee||"none",shortRange:t.shortRange||s?.short||"none",mediumRange:t.mediumRange||s?.medium||"none",longRange:t.longRange||s?.long||"none"}}),A=d?.uuid||d?.document?.uuid||o?.uuid||o?.document?.uuid||void 0,y=l?.uuid||l?.document?.uuid||void 0,k={actorId:u.id,actorUuid:a.defenderUuid||u.uuid,attackerTokenUuid:a.defenderTokenUuid||A,defenderTokenUuid:a.attackerTokenUuid||y,availableWeapons:S,isDefend:!1,isCounterAttack:!0,attackRollResult:i,attackRollData:s},{RollDialog:T}=await Promise.resolve().then(()=>h),E=new T(k);l&&!E.targetToken&&(E.targetToken=l),E.render(!0)})}),Hooks.on("getTokenHUDOptions",(e,t,a)=>{const i=a.actor;if(!i)return;i.items.filter(e=>("skill"===e.type||"feat"===e.type)&&e.system.bookmarked).length>0&&t.unshift({name:"SRA2_BOOKMARKS",title:game.i18n.localize("SRA2.BOOKMARKS.TITLE"),icon:"fa-solid fa-star",button:!0,onclick:()=>{this.showBookmarksDialog(i)}})});const addRollDiceButton=()=>{const e=$(".chat-form");if(0===e.length)return!1;if(e.find(".sra2-roll-dice-container").length>0)return!0;const t=$(`\n        <div class="sra2-roll-dice-container">\n          <div class="sra2-roll-dice-inputs">\n            <input type="text" value="3" class="sra2-dice-count-input" placeholder="${game.i18n.localize("SRA2.CHAT.DICE_COUNT")}" title="${game.i18n.localize("SRA2.CHAT.DICE_COUNT")}">\n            <input type="text" value="0" class="sra2-risk-dice-input" placeholder="${game.i18n.localize("SRA2.CHAT.RISK_DICE")}" title="${game.i18n.localize("SRA2.CHAT.RISK_DICE")}">\n            <input type="text" value="" class="sra2-rr-input" placeholder="${game.i18n.localize("SRA2.CHAT.RR")} 0" title="${game.i18n.localize("SRA2.CHAT.RR")}">\n            <div class="sra2-roll-mode-radio">\n              <label class="sra2-radio-advantage" title="${game.i18n.localize("SRA2.CHAT.ADVANTAGE")}">\n                <input type="radio" name="sra2-roll-mode" value="advantage">\n                <span>A</span>\n              </label>\n              <label class="sra2-radio-normal" title="${game.i18n.localize("SRA2.CHAT.NORMAL")}">\n                <input type="radio" name="sra2-roll-mode" value="normal" checked>\n                <span>N</span>\n              </label>\n              <label class="sra2-radio-disadvantage" title="${game.i18n.localize("SRA2.CHAT.DISADVANTAGE")}">\n                <input type="radio" name="sra2-roll-mode" value="disadvantage">\n                <span>D</span>\n              </label>\n            </div>\n          </div>\n          <button type="button" class="sra2-roll-dice-button" title="${game.i18n.localize("SRA2.CHAT.ROLL_DICE")}">\n            <i class="fas fa-dice-d6"></i> ${game.i18n.localize("SRA2.CHAT.ROLL_DICE")}\n          </button>\n        </div>\n      `);e.prepend(t);return t.find(".sra2-roll-dice-button").on("click",async e=>{e.preventDefault(),e.stopPropagation();let a=null;const i=canvas?.tokens?.controlled||[];if(i.length>0)a=i[0].actor;else{const e=game.actors.filter(e=>e.isOwner);e.length>0&&(a=e[0])}if(!a)return void ui.notifications?.warn(game.i18n.localize("SRA2.CHAT.NO_ACTOR")||"Aucun personnage contrôlé");const n=parseInt(t.find(".sra2-dice-count-input").val())||0,s=parseInt(t.find(".sra2-risk-dice-input").val())||0,l=parseInt(t.find(".sra2-rr-input").val())||0,o=t.find('input[name="sra2-roll-mode"]:checked').val()||"normal";if(n<=0)return void ui.notifications?.warn("Veuillez entrer un nombre de dés valide");const r=await Promise.resolve().then(()=>d),{getSuccessThreshold:c}=r,u=Math.min(s,n),m=Math.max(0,n-u),p=Math.min(3,Math.max(0,l));let h=null,g=null;if(m>0&&(h=new Roll(`${m}d6`),await h.evaluate(),game.dice3d&&h&&game.dice3d.showForRoll(h,game.user,!0,null,!1)),u>0&&(g=new Roll(`${u}d6`),await g.evaluate(),game.dice3d&&g)){const e={colorset:"purple",theme:"default"};game.dice3d.showForRoll(g,game.user,!0,e,!1)}const f=h&&h.dice[0]?.results?.map(e=>e.result)||[],S=g&&g.dice[0]?.results?.map(e=>e.result)||[],A=c(o);let y=0;for(const t of f)t>=A&&y++;let k=0,T=0;for(const t of S)1===t?T++:t>=A&&k++;const E=y+2*k,R=Math.max(0,T-p);let D="none";1===R?D="minor":2===R?D="critical":R>=3&&(D="disaster");const v={normalDice:f,riskDice:S,normalSuccesses:y,riskSuccesses:k,totalSuccesses:E,criticalFailures:T,finalRR:p,remainingFailures:R,complication:D},b=canvas?.tokens?.controlled||[],I=b.length>0?b[0]:null,w={dicePool:n,riskDiceCount:u,rollMode:o,finalRR:p,actorId:a.id,actorUuid:a.uuid,actorName:a.name},N={attacker:a,defender:null,rollData:w,rollResult:v,isAttack:!1,isDefend:!1,isCounterAttack:!1,skillName:"Jet de dés",itemName:null,damageValue:null,defenseResult:null,attackerUuid:a.uuid,defenderUuid:null,attackerTokenUuid:I?.uuid||I?.document?.uuid,defenderTokenUuid:null},L=await renderTemplate("systems/sra2/templates/roll-result.hbs",N),_={user:game.user?.id,speaker:{actor:a.id,alias:a.name},content:L,type:CONST.CHAT_MESSAGE_TYPES.OTHER,flags:{sra2:{rollType:"skill",attackerId:a.id,attackerUuid:a.uuid,attackerTokenUuid:I?.uuid||I?.document?.uuid,rollResult:v,rollData:w}}};await ChatMessage.create(_)}),!0};Hooks.on("renderChatLog",(e,t,a)=>{setTimeout(()=>{addRollDiceButton()||setTimeout(addRollDiceButton,500)},100)}),Hooks.on("renderChatPopout",(e,t,a)=>{setTimeout(()=>{addRollDiceButton()||setTimeout(addRollDiceButton,500)},100)}),Hooks.once("ready",()=>{addRollDiceButton();const e=new MutationObserver(()=>{addRollDiceButton()});document.body&&e.observe(document.body,{childList:!0,subtree:!0})}),Hooks.once("ready",()=>this.onReady())}showBookmarksDialog(e){const t=e.items.filter(e=>"skill"===e.type&&e.system.bookmarked),a=e.items.filter(e=>"feat"===e.type&&e.system.bookmarked);let i='<div class="sra2-bookmark-menu">';t.length>0&&(i+="<h3>"+game.i18n.localize("SRA2.SKILLS.LABEL")+"</h3>",i+='<div class="bookmark-list">',t.forEach(e=>{i+=`<button class="bookmark-item" data-item-id="${e.id}" data-item-type="skill">\n          <i class="fas fa-dice-d6"></i> ${e.name}\n        </button>`}),i+="</div>"),a.length>0&&(i+="<h3>"+game.i18n.localize("SRA2.FEATS.LABEL")+"</h3>",i+='<div class="bookmark-list">',a.forEach(e=>{i+=`<button class="bookmark-item" data-item-id="${e.id}" data-item-type="feat">\n          <i class="fas fa-scroll"></i> ${e.name}\n        </button>`}),i+="</div>"),i+="</div>",new Dialog({title:game.i18n.localize("SRA2.BOOKMARKS.TITLE")+" - "+e.name,content:i,buttons:{close:{icon:'<i class="fas fa-times"></i>',label:game.i18n.localize("Close")}},render:t=>{t.find(".bookmark-item").on("click",async t=>{const a=$(t.currentTarget).data("item-id"),i=e.items.get(a);i&&i.sheet?.render(!0)})}},{width:350}).render(!0)}registerThemeSetting(){game.settings.register(t.id,"uiTheme",{name:"SRA2.SETTINGS.THEME.TITLE",hint:"SRA2.SETTINGS.THEME.DESC",scope:"client",config:!0,type:String,choices:()=>({sra2:game.i18n.localize("SRA2.SETTINGS.THEME.SRA2")}),default:"sra2",onChange:e=>{this.applyTheme(e)}})}applyTheme(e){if(!document.body)return void console.warn(t.LOG.HEAD+"Cannot apply theme: document.body is not available");e||(e=game.settings.get(t.id,"uiTheme")||"sra2");document.body.classList.remove("sr-theme-sra2","sr-theme-sr6","sr-theme-sr5");const a=`sr-theme-${e}`;document.body.classList.add(a),console.log(t.LOG.HEAD+`Applied theme: ${a}`)}async onReady(){console.log(t.LOG.HEAD+"SRA2System.onReady"),this.applyTheme();(new Migrations).migrate(),await this.migrateFeatsToArrayFormat(),await this.migrateAnarchyNimbusToSpent()}async migrateFeatsToArrayFormat(){const e=[];for(const t of game.items)if("feat"===t.type){const a=t.system;let i=!1;const n={_id:t.id};void 0===a.rrType||Array.isArray(a.rrType)||(i=!0,"none"!==a.rrType?(n["system.rrType"]=[a.rrType],n["system.rrValue"]=[a.rrValue||0],n["system.rrTarget"]=[a.rrTarget||""]):(n["system.rrType"]=[],n["system.rrValue"]=[],n["system.rrTarget"]=[])),i&&e.push(n)}for(const a of game.actors){const e=[];for(const t of a.items)if("feat"===t.type){const a=t.system;let i=!1;const n={_id:t.id};void 0===a.rrType||Array.isArray(a.rrType)||(i=!0,"none"!==a.rrType?(n["system.rrType"]=[a.rrType],n["system.rrValue"]=[a.rrValue||0],n["system.rrTarget"]=[a.rrTarget||""]):(n["system.rrType"]=[],n["system.rrValue"]=[],n["system.rrTarget"]=[])),i&&e.push(n)}e.length>0&&(console.log(`${t.LOG.HEAD} Migrating ${e.length} feats on actor ${a.name}`),await a.updateEmbeddedDocuments("Item",e))}e.length>0&&(console.log(`${t.LOG.HEAD} Migrating ${e.length} world feats`),await Item.updateDocuments(e)),(e.length>0||game.actors.some(e=>e.items.some(e=>"feat"===e.type)))&&console.log(`${t.LOG.HEAD} Feat migration to array format complete`)}async migrateAnarchyNimbusToSpent(){const e=[];for(const t of game.actors)if("character"===t.type){const a=t.system;void 0!==a.anarchyNimbus&&void 0===a.anarchySpent&&e.push({_id:t.id,"system.anarchySpent":a.anarchyNimbus})}e.length>0&&(console.log(`${t.LOG.HEAD} Migrating anarchyNimbus to anarchySpent for ${e.length} actors`),await Actor.updateDocuments(e),console.log(`${t.LOG.HEAD} anarchyNimbus to anarchySpent migration complete`))}}SRA2System.start();
//# sourceMappingURL=index.mjs.map
